/*! For license information please see main.50db24e7.js.LICENSE.txt */
(()=>{var e={635:function(e,t,n){e.exports=function(){"use strict";function e(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(n){if("default"!==n&&!(n in e)){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}}))})),Object.freeze(e)}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof n.g?n.g:"undefined"!=typeof self?self:{};function i(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var r=function(e){try{return!!e()}catch(e){return!0}},o=!r((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),s=o,a=Function.prototype,c=a.call,l=s&&a.bind.bind(c,c),d=s?l:function(e){return function(){return c.apply(e,arguments)}},u=d({}.isPrototypeOf),h=function(e){return e&&e.Math==Math&&e},p=h("object"==typeof globalThis&&globalThis)||h("object"==typeof window&&window)||h("object"==typeof self&&self)||h("object"==typeof t&&t)||function(){return this}()||t||Function("return this")(),f=o,m=Function.prototype,_=m.apply,E=m.call,g="object"==typeof Reflect&&Reflect.apply||(f?E.bind(_):function(){return E.apply(_,arguments)}),v=d,T=v({}.toString),S=v("".slice),y=function(e){return S(T(e),8,-1)},C=y,R=d,w=function(e){if("Function"===C(e))return R(e)},I="object"==typeof document&&document.all,b={all:I,IS_HTMLDDA:void 0===I&&void 0!==I},A=b.all,O=b.IS_HTMLDDA?function(e){return"function"==typeof e||e===A}:function(e){return"function"==typeof e},N={},D=!r((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),P=o,k=Function.prototype.call,L=P?k.bind(k):function(){return k.apply(k,arguments)},M={},U={}.propertyIsEnumerable,x=Object.getOwnPropertyDescriptor,V=x&&!U.call({1:2},1);M.f=V?function(e){var t=x(this,e);return!!t&&t.enumerable}:U;var F,j,B=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},G=r,W=y,H=Object,K=d("".split),z=G((function(){return!H("z").propertyIsEnumerable(0)}))?function(e){return"String"==W(e)?K(e,""):H(e)}:H,q=function(e){return null==e},Y=q,J=TypeError,X=function(e){if(Y(e))throw J("Can't call method on "+e);return e},Q=z,Z=X,$=function(e){return Q(Z(e))},ee=O,te=b.all,ne=b.IS_HTMLDDA?function(e){return"object"==typeof e?null!==e:ee(e)||e===te}:function(e){return"object"==typeof e?null!==e:ee(e)},ie={},re=ie,oe=p,se=O,ae=function(e){return se(e)?e:void 0},ce=function(e,t){return arguments.length<2?ae(re[e])||ae(oe[e]):re[e]&&re[e][t]||oe[e]&&oe[e][t]},le="undefined"!=typeof navigator&&String(navigator.userAgent)||"",de=p,ue=le,he=de.process,pe=de.Deno,fe=he&&he.versions||pe&&pe.version,me=fe&&fe.v8;me&&(j=(F=me.split("."))[0]>0&&F[0]<4?1:+(F[0]+F[1])),!j&&ue&&(!(F=ue.match(/Edge\/(\d+)/))||F[1]>=74)&&(F=ue.match(/Chrome\/(\d+)/))&&(j=+F[1]);var _e=j,Ee=_e,ge=r,ve=p.String,Te=!!Object.getOwnPropertySymbols&&!ge((function(){var e=Symbol();return!ve(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Ee&&Ee<41})),Se=Te&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,ye=ce,Ce=O,Re=u,we=Object,Ie=Se?function(e){return"symbol"==typeof e}:function(e){var t=ye("Symbol");return Ce(t)&&Re(t.prototype,we(e))},be=String,Ae=function(e){try{return be(e)}catch(e){return"Object"}},Oe=O,Ne=Ae,De=TypeError,Pe=function(e){if(Oe(e))return e;throw De(Ne(e)+" is not a function")},ke=Pe,Le=q,Me=function(e,t){var n=e[t];return Le(n)?void 0:ke(n)},Ue=L,xe=O,Ve=ne,Fe=TypeError,je={exports:{}},Be=p,Ge=Object.defineProperty,We=function(e,t){try{Ge(Be,e,{value:t,configurable:!0,writable:!0})}catch(i){Be[e]=t}return t},He="__core-js_shared__",Ke=p[He]||We(He,{}),ze=Ke;(je.exports=function(e,t){return ze[e]||(ze[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"\xa9 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var qe=je.exports,Ye=X,Je=Object,Xe=function(e){return Je(Ye(e))},Qe=Xe,Ze=d({}.hasOwnProperty),$e=Object.hasOwn||function(e,t){return Ze(Qe(e),t)},et=d,tt=0,nt=Math.random(),it=et(1..toString),rt=function(e){return"Symbol("+(void 0===e?"":e)+")_"+it(++tt+nt,36)},ot=qe,st=$e,at=rt,ct=Te,lt=Se,dt=p.Symbol,ut=ot("wks"),ht=lt?dt.for||dt:dt&&dt.withoutSetter||at,pt=function(e){return st(ut,e)||(ut[e]=ct&&st(dt,e)?dt[e]:ht("Symbol."+e)),ut[e]},ft=L,mt=ne,_t=Ie,Et=Me,gt=function(e,t){var n,i;if("string"===t&&xe(n=e.toString)&&!Ve(i=Ue(n,e)))return i;if(xe(n=e.valueOf)&&!Ve(i=Ue(n,e)))return i;if("string"!==t&&xe(n=e.toString)&&!Ve(i=Ue(n,e)))return i;throw Fe("Can't convert object to primitive value")},vt=TypeError,Tt=pt("toPrimitive"),St=function(e,t){if(!mt(e)||_t(e))return e;var n,i=Et(e,Tt);if(i){if(void 0===t&&(t="default"),n=ft(i,e,t),!mt(n)||_t(n))return n;throw vt("Can't convert object to primitive value")}return void 0===t&&(t="number"),gt(e,t)},yt=Ie,Ct=function(e){var t=St(e,"string");return yt(t)?t:t+""},Rt=ne,wt=p.document,It=Rt(wt)&&Rt(wt.createElement),bt=function(e){return It?wt.createElement(e):{}},At=bt,Ot=!D&&!r((function(){return 7!=Object.defineProperty(At("div"),"a",{get:function(){return 7}}).a})),Nt=D,Dt=L,Pt=M,kt=B,Lt=$,Mt=Ct,Ut=$e,xt=Ot,Vt=Object.getOwnPropertyDescriptor;N.f=Nt?Vt:function(e,t){if(e=Lt(e),t=Mt(t),xt)try{return Vt(e,t)}catch(e){}if(Ut(e,t))return kt(!Dt(Pt.f,e,t),e[t])};var Ft=r,jt=O,Bt=/#|\.prototype\./,Gt=function(e,t){var n=Ht[Wt(e)];return n==zt||n!=Kt&&(jt(t)?Ft(t):!!t)},Wt=Gt.normalize=function(e){return String(e).replace(Bt,".").toLowerCase()},Ht=Gt.data={},Kt=Gt.NATIVE="N",zt=Gt.POLYFILL="P",qt=Gt,Yt=Pe,Jt=o,Xt=w(w.bind),Qt=function(e,t){return Yt(e),void 0===t?e:Jt?Xt(e,t):function(){return e.apply(t,arguments)}},Zt={},$t=D&&r((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),en=ne,tn=String,nn=TypeError,rn=function(e){if(en(e))return e;throw nn(tn(e)+" is not an object")},on=D,sn=Ot,an=$t,cn=rn,ln=Ct,dn=TypeError,un=Object.defineProperty,hn=Object.getOwnPropertyDescriptor,pn="enumerable",fn="configurable",mn="writable";Zt.f=on?an?function(e,t,n){if(cn(e),t=ln(t),cn(n),"function"==typeof e&&"prototype"===t&&"value"in n&&mn in n&&!n[mn]){var i=hn(e,t);i&&i[mn]&&(e[t]=n.value,n={configurable:fn in n?n[fn]:i[fn],enumerable:pn in n?n[pn]:i[pn],writable:!1})}return un(e,t,n)}:un:function(e,t,n){if(cn(e),t=ln(t),cn(n),sn)try{return un(e,t,n)}catch(e){}if("get"in n||"set"in n)throw dn("Accessors not supported");return"value"in n&&(e[t]=n.value),e};var _n=Zt,En=B,gn=D?function(e,t,n){return _n.f(e,t,En(1,n))}:function(e,t,n){return e[t]=n,e},vn=p,Tn=g,Sn=w,yn=O,Cn=N.f,Rn=qt,wn=ie,In=Qt,bn=gn,An=$e,On=function(e){var t=function(n,i,r){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(n);case 2:return new e(n,i)}return new e(n,i,r)}return Tn(e,this,arguments)};return t.prototype=e.prototype,t},Nn=function(e,t){var n,i,r,o,s,a,c,l,d,u=e.target,h=e.global,p=e.stat,f=e.proto,m=h?vn:p?vn[u]:(vn[u]||{}).prototype,_=h?wn:wn[u]||bn(wn,u,{})[u],E=_.prototype;for(o in t)i=!(n=Rn(h?o:u+(p?".":"#")+o,e.forced))&&m&&An(m,o),a=_[o],i&&(c=e.dontCallGetSet?(d=Cn(m,o))&&d.value:m[o]),s=i&&c?c:t[o],i&&typeof a==typeof s||(l=e.bind&&i?In(s,vn):e.wrap&&i?On(s):f&&yn(s)?Sn(s):s,(e.sham||s&&s.sham||a&&a.sham)&&bn(l,"sham",!0),bn(_,o,l),f&&(An(wn,r=u+"Prototype")||bn(wn,r,{}),bn(wn[r],o,s),e.real&&E&&(n||!E[o])&&bn(E,o,s)))},Dn=Math.ceil,Pn=Math.floor,kn=Math.trunc||function(e){var t=+e;return(t>0?Pn:Dn)(t)},Ln=kn,Mn=function(e){var t=+e;return t!=t||0===t?0:Ln(t)},Un=Mn,xn=Math.max,Vn=Math.min,Fn=function(e,t){var n=Un(e);return n<0?xn(n+t,0):Vn(n,t)},jn=Mn,Bn=Math.min,Gn=function(e){return e>0?Bn(jn(e),9007199254740991):0},Wn=Gn,Hn=function(e){return Wn(e.length)},Kn=$,zn=Fn,qn=Hn,Yn=function(e){return function(t,n,i){var r,o=Kn(t),s=qn(o),a=zn(i,s);if(e&&n!=n){for(;s>a;)if((r=o[a++])!=r)return!0}else for(;s>a;a++)if((e||a in o)&&o[a]===n)return e||a||0;return!e&&-1}},Jn={includes:Yn(!0),indexOf:Yn(!1)},Xn=Jn.includes;Nn({target:"Array",proto:!0,forced:r((function(){return!Array(1).includes()}))},{includes:function(e){return Xn(this,e,arguments.length>1?arguments[1]:void 0)}});var Qn=ie,Zn=function(e){return Qn[e+"Prototype"]},$n=Zn("Array").includes,ei=ne,ti=y,ni=pt("match"),ii=function(e){var t;return ei(e)&&(void 0!==(t=e[ni])?!!t:"RegExp"==ti(e))},ri=ii,oi=TypeError,si={};si[pt("toStringTag")]="z";var ai="[object z]"===String(si),ci=ai,li=O,di=y,ui=pt("toStringTag"),hi=Object,pi="Arguments"==di(function(){return arguments}()),fi=ci?di:function(e){var t,n,i;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=hi(e),ui))?n:pi?di(t):"Object"==(i=di(t))&&li(t.callee)?"Arguments":i},mi=fi,_i=String,Ei=function(e){if("Symbol"===mi(e))throw TypeError("Cannot convert a Symbol value to a string");return _i(e)},gi=pt("match"),vi=Nn,Ti=function(e){if(ri(e))throw oi("The method doesn't accept regular expressions");return e},Si=X,yi=Ei,Ci=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[gi]=!1,"/./"[e](t)}catch(e){}}return!1},Ri=d("".indexOf);vi({target:"String",proto:!0,forced:!Ci("includes")},{includes:function(e){return!!~Ri(yi(Si(this)),yi(Ti(e)),arguments.length>1?arguments[1]:void 0)}});var wi=Zn("String").includes,Ii=u,bi=$n,Ai=wi,Oi=Array.prototype,Ni=String.prototype,Di=function(e){var t=e.includes;return e===Oi||Ii(Oi,e)&&t===Oi.includes?bi:"string"==typeof e||e===Ni||Ii(Ni,e)&&t===Ni.includes?Ai:t},Pi=i(Di),ki=Pe,Li=Xe,Mi=z,Ui=Hn,xi=TypeError,Vi=function(e){return function(t,n,i,r){ki(n);var o=Li(t),s=Mi(o),a=Ui(o),c=e?a-1:0,l=e?-1:1;if(i<2)for(;;){if(c in s){r=s[c],c+=l;break}if(c+=l,e?c<0:a<=c)throw xi("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=l)c in s&&(r=n(r,s[c],c,o));return r}},Fi={left:Vi(!1),right:Vi(!0)},ji=r,Bi=function(e,t){var n=[][e];return!!n&&ji((function(){n.call(null,t||function(){return 1},1)}))},Gi="undefined"!=typeof process&&"process"==y(process),Wi=Fi.left;Nn({target:"Array",proto:!0,forced:!Gi&&_e>79&&_e<83||!Bi("reduce")},{reduce:function(e){var t=arguments.length;return Wi(this,e,t,t>1?arguments[1]:void 0)}});var Hi=Zn("Array").reduce,Ki=u,zi=Hi,qi=Array.prototype,Yi=function(e){var t=e.reduce;return e===qi||Ki(qi,e)&&t===qi.reduce?zi:t},Ji=Yi,Xi=i(Ji);let Qi=!0,Zi=!0;function $i(e,t,n){const i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)}function er(e,t,n){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return r.apply(this,arguments);const o=e=>{const t=n(e);t&&(i.handleEvent?i.handleEvent(t):i(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(i,o),r.apply(this,[e,o])};const o=i.removeEventListener;i.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(n))return o.apply(this,arguments);const i=this._eventMap[t].get(n);return this._eventMap[t].delete(n),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function tr(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Qi=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function nr(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Zi=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function ir(){if("object"==typeof window){if(Qi)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function rr(e,t){Zi&&console.warn(e+" is deprecated, please use "+t+" instead.")}function or(e){return"[object Object]"===Object.prototype.toString.call(e)}function sr(e){var t;return or(e)?Xi(t=Object.keys(e)).call(t,(function(t,n){const i=or(e[n]),r=i?sr(e[n]):e[n],o=i&&!Object.keys(r).length;return void 0===r||o?t:Object.assign(t,{[n]:r})}),{}):e}function ar(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach((i=>{i.endsWith("Id")?ar(e,e.get(t[i]),n):i.endsWith("Ids")&&t[i].forEach((t=>{ar(e,e.get(t),n)}))})))}function cr(e,t,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(null===t)return r;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((t=>{e.forEach((n=>{n.type===i&&n.trackId===t.id&&ar(e,n,r)}))})),r}var lr=rt,dr=qe("keys"),ur=function(e){return dr[e]||(dr[e]=lr(e))},hr=!r((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),pr=$e,fr=O,mr=Xe,_r=hr,Er=ur("IE_PROTO"),gr=Object,vr=gr.prototype,Tr=_r?gr.getPrototypeOf:function(e){var t=mr(e);if(pr(t,Er))return t[Er];var n=t.constructor;return fr(n)&&t instanceof n?n.prototype:t instanceof gr?vr:null},Sr=d,yr=Pe,Cr=O,Rr=String,wr=TypeError,Ir=function(e,t,n){try{return Sr(yr(Object.getOwnPropertyDescriptor(e,t)[n]))}catch(e){}},br=rn,Ar=function(e){if("object"==typeof e||Cr(e))return e;throw wr("Can't set "+Rr(e)+" as a prototype")},Or=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,n={};try{(e=Ir(Object.prototype,"__proto__","set"))(n,[]),t=n instanceof Array}catch(e){}return function(n,i){return br(n),Ar(i),t?e(n,i):n.__proto__=i,n}}():void 0),Nr={},Dr={},Pr=$e,kr=$,Lr=Jn.indexOf,Mr=Dr,Ur=d([].push),xr=function(e,t){var n,i=kr(e),r=0,o=[];for(n in i)!Pr(Mr,n)&&Pr(i,n)&&Ur(o,n);for(;t.length>r;)Pr(i,n=t[r++])&&(~Lr(o,n)||Ur(o,n));return o},Vr=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Fr=xr,jr=Vr.concat("length","prototype");Nr.f=Object.getOwnPropertyNames||function(e){return Fr(e,jr)};var Br={};Br.f=Object.getOwnPropertySymbols;var Gr=ce,Wr=Nr,Hr=Br,Kr=rn,zr=d([].concat),qr=Gr("Reflect","ownKeys")||function(e){var t=Wr.f(Kr(e)),n=Hr.f;return n?zr(t,n(e)):t},Yr=$e,Jr=qr,Xr=N,Qr=Zt,Zr={},$r=xr,eo=Vr,to=Object.keys||function(e){return $r(e,eo)},no=D,io=$t,ro=Zt,oo=rn,so=$,ao=to;Zr.f=no&&!io?Object.defineProperties:function(e,t){oo(e);for(var n,i=so(t),r=ao(t),o=r.length,s=0;o>s;)ro.f(e,n=r[s++],i[n]);return e};var co,lo=ce("document","documentElement"),uo=rn,ho=Zr,po=Vr,fo=Dr,mo=lo,_o=bt,Eo="prototype",go="script",vo=ur("IE_PROTO"),To=function(){},So=function(e){return"<"+go+">"+e+"</"+go+">"},yo=function(e){e.write(So("")),e.close();var t=e.parentWindow.Object;return e=null,t},Co=function(){try{co=new ActiveXObject("htmlfile")}catch(e){}var e,t,n;Co="undefined"!=typeof document?document.domain&&co?yo(co):(t=_o("iframe"),n="java"+go+":",t.style.display="none",mo.appendChild(t),t.src=String(n),(e=t.contentWindow.document).open(),e.write(So("document.F=Object")),e.close(),e.F):yo(co);for(var i=po.length;i--;)delete Co[Eo][po[i]];return Co()};fo[vo]=!0;var Ro=Object.create||function(e,t){var n;return null!==e?(To[Eo]=uo(e),n=new To,To[Eo]=null,n[vo]=e):n=Co(),void 0===t?n:ho.f(n,t)},wo=ne,Io=gn,bo=Error,Ao=d("".replace),Oo=String(bo("zxcasd").stack),No=/\n\s*at [^:]*:[^\n]*/,Do=No.test(Oo),Po=B,ko=!r((function(){var e=Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",Po(1,7)),7!==e.stack)})),Lo=gn,Mo=function(e,t){if(Do&&"string"==typeof e&&!bo.prepareStackTrace)for(;t--;)e=Ao(e,No,"");return e},Uo=ko,xo=Error.captureStackTrace,Vo={},Fo=Vo,jo=pt("iterator"),Bo=Array.prototype,Go=function(e){return void 0!==e&&(Fo.Array===e||Bo[jo]===e)},Wo=fi,Ho=Me,Ko=q,zo=Vo,qo=pt("iterator"),Yo=function(e){if(!Ko(e))return Ho(e,qo)||Ho(e,"@@iterator")||zo[Wo(e)]},Jo=L,Xo=Pe,Qo=rn,Zo=Ae,$o=Yo,es=TypeError,ts=function(e,t){var n=arguments.length<2?$o(e):t;if(Xo(n))return Qo(Jo(n,e));throw es(Zo(e)+" is not iterable")},ns=L,is=rn,rs=Me,os=function(e,t,n){var i,r;is(e);try{if(!(i=rs(e,"return"))){if("throw"===t)throw n;return n}i=ns(i,e)}catch(e){r=!0,i=e}if("throw"===t)throw n;if(r)throw i;return is(i),n},ss=Qt,as=L,cs=rn,ls=Ae,ds=Go,us=Hn,hs=u,ps=ts,fs=Yo,ms=os,_s=TypeError,Es=function(e,t){this.stopped=e,this.result=t},gs=Es.prototype,vs=function(e,t,n){var i,r,o,s,a,c,l,d=n&&n.that,u=!(!n||!n.AS_ENTRIES),h=!(!n||!n.IS_RECORD),p=!(!n||!n.IS_ITERATOR),f=!(!n||!n.INTERRUPTED),m=ss(t,d),_=function(e){return i&&ms(i,"normal",e),new Es(!0,e)},E=function(e){return u?(cs(e),f?m(e[0],e[1],_):m(e[0],e[1])):f?m(e,_):m(e)};if(h)i=e.iterator;else if(p)i=e;else{if(!(r=fs(e)))throw _s(ls(e)+" is not iterable");if(ds(r)){for(o=0,s=us(e);s>o;o++)if((a=E(e[o]))&&hs(gs,a))return a;return new Es(!1)}i=ps(e,r)}for(c=h?e.next:i.next;!(l=as(c,i)).done;){try{a=E(l.value)}catch(e){ms(i,"throw",e)}if("object"==typeof a&&a&&hs(gs,a))return a}return new Es(!1)},Ts=Ei,Ss=Nn,ys=u,Cs=Tr,Rs=Or,ws=function(e,t,n){for(var i=Jr(t),r=Qr.f,o=Xr.f,s=0;s<i.length;s++){var a=i[s];Yr(e,a)||n&&Yr(n,a)||r(e,a,o(t,a))}},Is=Ro,bs=gn,As=B,Os=function(e,t){wo(t)&&"cause"in t&&Io(e,"cause",t.cause)},Ns=function(e,t,n,i){Uo&&(xo?xo(e,t):Lo(e,"stack",Mo(n,i)))},Ds=vs,Ps=function(e,t){return void 0===e?arguments.length<2?"":t:Ts(e)},ks=pt("toStringTag"),Ls=Error,Ms=[].push,Us=function(e,t){var n,i=ys(xs,this);Rs?n=Rs(Ls(),i?Cs(this):xs):(n=i?this:Is(xs),bs(n,ks,"Error")),void 0!==t&&bs(n,"message",Ps(t)),Ns(n,Us,n.stack,1),arguments.length>2&&Os(n,arguments[2]);var r=[];return Ds(e,Ms,{that:r}),bs(n,"errors",r),n};Rs?Rs(Us,Ls):ws(Us,Ls,{name:!0});var xs=Us.prototype=Is(Ls.prototype,{constructor:As(1,Us),message:As(1,""),name:As(1,"AggregateError")});Ss({global:!0,constructor:!0,arity:2},{AggregateError:Us});var Vs,Fs,js,Bs=O,Gs=p.WeakMap,Ws=Bs(Gs)&&/native code/.test(String(Gs)),Hs=p,Ks=ne,zs=gn,qs=$e,Ys=Ke,Js=ur,Xs=Dr,Qs="Object already initialized",Zs=Hs.TypeError,$s=Hs.WeakMap;if(Ws||Ys.state){var ea=Ys.state||(Ys.state=new $s);ea.get=ea.get,ea.has=ea.has,ea.set=ea.set,Vs=function(e,t){if(ea.has(e))throw Zs(Qs);return t.facade=e,ea.set(e,t),t},Fs=function(e){return ea.get(e)||{}},js=function(e){return ea.has(e)}}else{var ta=Js("state");Xs[ta]=!0,Vs=function(e,t){if(qs(e,ta))throw Zs(Qs);return t.facade=e,zs(e,ta,t),t},Fs=function(e){return qs(e,ta)?e[ta]:{}},js=function(e){return qs(e,ta)}}var na,ia,ra,oa={set:Vs,get:Fs,has:js,enforce:function(e){return js(e)?Fs(e):Vs(e,{})},getterFor:function(e){return function(t){var n;if(!Ks(t)||(n=Fs(t)).type!==e)throw Zs("Incompatible receiver, "+e+" required");return n}}},sa=D,aa=$e,ca=Function.prototype,la=sa&&Object.getOwnPropertyDescriptor,da=aa(ca,"name"),ua={EXISTS:da,PROPER:da&&"something"===function(){}.name,CONFIGURABLE:da&&(!sa||sa&&la(ca,"name").configurable)},ha=gn,pa=function(e,t,n,i){return i&&i.enumerable?e[t]=n:ha(e,t,n),e},fa=r,ma=O,_a=ne,Ea=Ro,ga=Tr,va=pa,Ta=pt("iterator"),Sa=!1;[].keys&&("next"in(ra=[].keys())?(ia=ga(ga(ra)))!==Object.prototype&&(na=ia):Sa=!0);var ya=!_a(na)||fa((function(){var e={};return na[Ta].call(e)!==e}));ma((na=ya?{}:Ea(na))[Ta])||va(na,Ta,(function(){return this}));var Ca={IteratorPrototype:na,BUGGY_SAFARI_ITERATORS:Sa},Ra=fi,wa=ai?{}.toString:function(){return"[object "+Ra(this)+"]"},Ia=ai,ba=Zt.f,Aa=gn,Oa=$e,Na=wa,Da=pt("toStringTag"),Pa=function(e,t,n,i){if(e){var r=n?e:e.prototype;Oa(r,Da)||ba(r,Da,{configurable:!0,value:t}),i&&!Ia&&Aa(r,"toString",Na)}},ka=Ca.IteratorPrototype,La=Ro,Ma=B,Ua=Pa,xa=Vo,Va=function(){return this},Fa=function(e,t,n,i){var r=t+" Iterator";return e.prototype=La(ka,{next:Ma(+!i,n)}),Ua(e,r,!1,!0),xa[r]=Va,e},ja=Nn,Ba=L,Ga=Fa,Wa=Tr,Ha=Pa,Ka=pa,za=Vo,qa=Ca,Ya=ua.PROPER,Ja=qa.BUGGY_SAFARI_ITERATORS,Xa=pt("iterator"),Qa="keys",Za="values",$a="entries",ec=function(){return this},tc=function(e,t,n,i,r,o,s){Ga(n,t,i);var a,c,l,d=function(e){if(e===r&&m)return m;if(!Ja&&e in p)return p[e];switch(e){case Qa:case Za:case $a:return function(){return new n(this,e)}}return function(){return new n(this)}},u=t+" Iterator",h=!1,p=e.prototype,f=p[Xa]||p["@@iterator"]||r&&p[r],m=!Ja&&f||d(r),_="Array"==t&&p.entries||f;if(_&&(a=Wa(_.call(new e)))!==Object.prototype&&a.next&&(Ha(a,u,!0,!0),za[u]=ec),Ya&&r==Za&&f&&f.name!==Za&&(h=!0,m=function(){return Ba(f,this)}),r)if(c={values:d(Za),keys:o?m:d(Qa),entries:d($a)},s)for(l in c)(Ja||h||!(l in p))&&Ka(p,l,c[l]);else ja({target:t,proto:!0,forced:Ja||h},c);return s&&p[Xa]!==m&&Ka(p,Xa,m,{name:r}),za[t]=m,c},nc=function(e,t){return{value:e,done:t}},ic=$,rc=Vo,oc=oa;Zt.f;var sc=tc,ac=nc,cc="Array Iterator",lc=oc.set,dc=oc.getterFor(cc);sc(Array,"Array",(function(e,t){lc(this,{type:cc,target:ic(e),index:0,kind:t})}),(function(){var e=dc(this),t=e.target,n=e.kind,i=e.index++;return!t||i>=t.length?(e.target=void 0,ac(void 0,!0)):ac("keys"==n?i:"values"==n?t[i]:[i,t[i]],!1)}),"values"),rc.Arguments=rc.Array;var uc=Zt,hc=function(e,t,n){return uc.f(e,t,n)},pc=ce,fc=hc,mc=D,_c=pt("species"),Ec=u,gc=TypeError,vc=function(e,t){if(Ec(t,e))return e;throw gc("Incorrect invocation")},Tc=O,Sc=Ke,yc=d(Function.toString);Tc(Sc.inspectSource)||(Sc.inspectSource=function(e){return yc(e)});var Cc=Sc.inspectSource,Rc=d,wc=r,Ic=O,bc=fi,Ac=Cc,Oc=function(){},Nc=[],Dc=ce("Reflect","construct"),Pc=/^\s*(?:class|function)\b/,kc=Rc(Pc.exec),Lc=!Pc.exec(Oc),Mc=function(e){if(!Ic(e))return!1;try{return Dc(Oc,Nc,e),!0}catch(e){return!1}},Uc=function(e){if(!Ic(e))return!1;switch(bc(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Lc||!!kc(Pc,Ac(e))}catch(e){return!0}};Uc.sham=!0;var xc,Vc,Fc,jc,Bc=!Dc||wc((function(){var e;return Mc(Mc.call)||!Mc(Object)||!Mc((function(){e=!0}))||e}))?Uc:Mc,Gc=Bc,Wc=Ae,Hc=TypeError,Kc=rn,zc=function(e){if(Gc(e))return e;throw Hc(Wc(e)+" is not a constructor")},qc=q,Yc=pt("species"),Jc=function(e,t){var n,i=Kc(e).constructor;return void 0===i||qc(n=Kc(i)[Yc])?t:zc(n)},Xc=d([].slice),Qc=TypeError,Zc=function(e,t){if(e<t)throw Qc("Not enough arguments");return e},$c=/(?:ipad|iphone|ipod).*applewebkit/i.test(le),el=p,tl=g,nl=Qt,il=O,rl=$e,ol=r,sl=lo,al=Xc,cl=bt,ll=Zc,dl=$c,ul=Gi,hl=el.setImmediate,pl=el.clearImmediate,fl=el.process,ml=el.Dispatch,_l=el.Function,El=el.MessageChannel,gl=el.String,vl=0,Tl={},Sl="onreadystatechange";ol((function(){xc=el.location}));var yl=function(e){if(rl(Tl,e)){var t=Tl[e];delete Tl[e],t()}},Cl=function(e){return function(){yl(e)}},Rl=function(e){yl(e.data)},wl=function(e){el.postMessage(gl(e),xc.protocol+"//"+xc.host)};hl&&pl||(hl=function(e){ll(arguments.length,1);var t=il(e)?e:_l(e),n=al(arguments,1);return Tl[++vl]=function(){tl(t,void 0,n)},Vc(vl),vl},pl=function(e){delete Tl[e]},ul?Vc=function(e){fl.nextTick(Cl(e))}:ml&&ml.now?Vc=function(e){ml.now(Cl(e))}:El&&!dl?(jc=(Fc=new El).port2,Fc.port1.onmessage=Rl,Vc=nl(jc.postMessage,jc)):el.addEventListener&&il(el.postMessage)&&!el.importScripts&&xc&&"file:"!==xc.protocol&&!ol(wl)?(Vc=wl,el.addEventListener("message",Rl,!1)):Vc=Sl in cl("script")?function(e){sl.appendChild(cl("script"))[Sl]=function(){sl.removeChild(this),yl(e)}}:function(e){setTimeout(Cl(e),0)});var Il={set:hl,clear:pl},bl=function(){this.head=null,this.tail=null};bl.prototype={add:function(e){var t={item:e,next:null},n=this.tail;n?n.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var Al,Ol,Nl,Dl,Pl,kl=bl,Ll=/ipad|iphone|ipod/i.test(le)&&"undefined"!=typeof Pebble,Ml=/web0s(?!.*chrome)/i.test(le),Ul=p,xl=Qt,Vl=N.f,Fl=Il.set,jl=kl,Bl=$c,Gl=Ll,Wl=Ml,Hl=Gi,Kl=Ul.MutationObserver||Ul.WebKitMutationObserver,zl=Ul.document,ql=Ul.process,Yl=Ul.Promise,Jl=Vl(Ul,"queueMicrotask"),Xl=Jl&&Jl.value;if(!Xl){var Ql=new jl,Zl=function(){var e,t;for(Hl&&(e=ql.domain)&&e.exit();t=Ql.get();)try{t()}catch(e){throw Ql.head&&Al(),e}e&&e.enter()};Bl||Hl||Wl||!Kl||!zl?!Gl&&Yl&&Yl.resolve?((Dl=Yl.resolve(void 0)).constructor=Yl,Pl=xl(Dl.then,Dl),Al=function(){Pl(Zl)}):Hl?Al=function(){ql.nextTick(Zl)}:(Fl=xl(Fl,Ul),Al=function(){Fl(Zl)}):(Ol=!0,Nl=zl.createTextNode(""),new Kl(Zl).observe(Nl,{characterData:!0}),Al=function(){Nl.data=Ol=!Ol}),Xl=function(e){Ql.head||Al(),Ql.add(e)}}var $l=Xl,ed=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},td=p.Promise,nd="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,id=!nd&&!Gi&&"object"==typeof window&&"object"==typeof document,rd=p,od=td,sd=O,ad=qt,cd=Cc,ld=pt,dd=id,ud=nd,hd=_e,pd=od&&od.prototype,fd=ld("species"),md=!1,_d=sd(rd.PromiseRejectionEvent),Ed=ad("Promise",(function(){var e=cd(od),t=e!==String(od);if(!t&&66===hd)return!0;if(!pd.catch||!pd.finally)return!0;if(!hd||hd<51||!/native code/.test(e)){var n=new od((function(e){e(1)})),i=function(e){e((function(){}),(function(){}))};if((n.constructor={})[fd]=i,!(md=n.then((function(){}))instanceof i))return!0}return!t&&(dd||ud)&&!_d})),gd={CONSTRUCTOR:Ed,REJECTION_EVENT:_d,SUBCLASSING:md},vd={},Td=Pe,Sd=TypeError,yd=function(e){var t,n;this.promise=new e((function(e,i){if(void 0!==t||void 0!==n)throw Sd("Bad Promise constructor");t=e,n=i})),this.resolve=Td(t),this.reject=Td(n)};vd.f=function(e){return new yd(e)};var Cd,Rd,wd=Nn,Id=Gi,bd=p,Ad=L,Od=pa,Nd=Pa,Dd=function(e){var t=pc(e);mc&&t&&!t[_c]&&fc(t,_c,{configurable:!0,get:function(){return this}})},Pd=Pe,kd=O,Ld=ne,Md=vc,Ud=Jc,xd=Il.set,Vd=$l,Fd=function(e,t){try{1==arguments.length?console.error(e):console.error(e,t)}catch(e){}},jd=ed,Bd=kl,Gd=oa,Wd=td,Hd=gd,Kd=vd,zd="Promise",qd=Hd.CONSTRUCTOR,Yd=Hd.REJECTION_EVENT,Jd=Gd.getterFor(zd),Xd=Gd.set,Qd=Wd&&Wd.prototype,Zd=Wd,$d=Qd,eu=bd.TypeError,tu=bd.document,nu=bd.process,iu=Kd.f,ru=iu,ou=!!(tu&&tu.createEvent&&bd.dispatchEvent),su="unhandledrejection",au=function(e){var t;return!(!Ld(e)||!kd(t=e.then))&&t},cu=function(e,t){var n,i,r,o=t.value,s=1==t.state,a=s?e.ok:e.fail,c=e.resolve,l=e.reject,d=e.domain;try{a?(s||(2===t.rejection&&pu(t),t.rejection=1),!0===a?n=o:(d&&d.enter(),n=a(o),d&&(d.exit(),r=!0)),n===e.promise?l(eu("Promise-chain cycle")):(i=au(n))?Ad(i,n,c,l):c(n)):l(o)}catch(e){d&&!r&&d.exit(),l(e)}},lu=function(e,t){e.notified||(e.notified=!0,Vd((function(){for(var n,i=e.reactions;n=i.get();)cu(n,e);e.notified=!1,t&&!e.rejection&&uu(e)})))},du=function(e,t,n){var i,r;ou?((i=tu.createEvent("Event")).promise=t,i.reason=n,i.initEvent(e,!1,!0),bd.dispatchEvent(i)):i={promise:t,reason:n},!Yd&&(r=bd["on"+e])?r(i):e===su&&Fd("Unhandled promise rejection",n)},uu=function(e){Ad(xd,bd,(function(){var t,n=e.facade,i=e.value;if(hu(e)&&(t=jd((function(){Id?nu.emit("unhandledRejection",i,n):du(su,n,i)})),e.rejection=Id||hu(e)?2:1,t.error))throw t.value}))},hu=function(e){return 1!==e.rejection&&!e.parent},pu=function(e){Ad(xd,bd,(function(){var t=e.facade;Id?nu.emit("rejectionHandled",t):du("rejectionhandled",t,e.value)}))},fu=function(e,t,n){return function(i){e(t,i,n)}},mu=function(e,t,n){e.done||(e.done=!0,n&&(e=n),e.value=t,e.state=2,lu(e,!0))},_u=function(e,t,n){if(!e.done){e.done=!0,n&&(e=n);try{if(e.facade===t)throw eu("Promise can't be resolved itself");var i=au(t);i?Vd((function(){var n={done:!1};try{Ad(i,t,fu(_u,n,e),fu(mu,n,e))}catch(t){mu(n,t,e)}})):(e.value=t,e.state=1,lu(e,!1))}catch(t){mu({done:!1},t,e)}}};qd&&($d=(Zd=function(e){Md(this,$d),Pd(e),Ad(Cd,this);var t=Jd(this);try{e(fu(_u,t),fu(mu,t))}catch(e){mu(t,e)}}).prototype,(Cd=function(e){Xd(this,{type:zd,done:!1,notified:!1,parent:!1,reactions:new Bd,rejection:!1,state:0,value:void 0})}).prototype=Od($d,"then",(function(e,t){var n=Jd(this),i=iu(Ud(this,Zd));return n.parent=!0,i.ok=!kd(e)||e,i.fail=kd(t)&&t,i.domain=Id?nu.domain:void 0,0==n.state?n.reactions.add(i):Vd((function(){cu(i,n)})),i.promise})),Rd=function(){var e=new Cd,t=Jd(e);this.promise=e,this.resolve=fu(_u,t),this.reject=fu(mu,t)},Kd.f=iu=function(e){return e===Zd||void 0===e?new Rd(e):ru(e)}),wd({global:!0,constructor:!0,wrap:!0,forced:qd},{Promise:Zd}),Nd(Zd,zd,!1,!0),Dd(zd);var Eu=pt("iterator"),gu=!1;try{var vu=0,Tu={next:function(){return{done:!!vu++}},return:function(){gu=!0}};Tu[Eu]=function(){return this},Array.from(Tu,(function(){throw 2}))}catch(e){}var Su=td,yu=function(e,t){if(!t&&!gu)return!1;var n=!1;try{var i={};i[Eu]=function(){return{next:function(){return{done:n=!0}}}},e(i)}catch(e){}return n},Cu=gd.CONSTRUCTOR||!yu((function(e){Su.all(e).then(void 0,(function(){}))})),Ru=L,wu=Pe,Iu=vd,bu=ed,Au=vs;Nn({target:"Promise",stat:!0,forced:Cu},{all:function(e){var t=this,n=Iu.f(t),i=n.resolve,r=n.reject,o=bu((function(){var n=wu(t.resolve),o=[],s=0,a=1;Au(e,(function(e){var c=s++,l=!1;a++,Ru(n,t,e).then((function(e){l||(l=!0,o[c]=e,--a||i(o))}),r)})),--a||i(o)}));return o.error&&r(o.value),n.promise}});var Ou=Nn,Nu=gd.CONSTRUCTOR;td&&td.prototype,Ou({target:"Promise",proto:!0,forced:Nu,real:!0},{catch:function(e){return this.then(void 0,e)}});var Du=L,Pu=Pe,ku=vd,Lu=ed,Mu=vs;Nn({target:"Promise",stat:!0,forced:Cu},{race:function(e){var t=this,n=ku.f(t),i=n.reject,r=Lu((function(){var r=Pu(t.resolve);Mu(e,(function(e){Du(r,t,e).then(n.resolve,i)}))}));return r.error&&i(r.value),n.promise}});var Uu=L,xu=vd;Nn({target:"Promise",stat:!0,forced:gd.CONSTRUCTOR},{reject:function(e){var t=xu.f(this);return Uu(t.reject,void 0,e),t.promise}});var Vu=rn,Fu=ne,ju=vd,Bu=function(e,t){if(Vu(e),Fu(t)&&t.constructor===e)return t;var n=ju.f(e);return(0,n.resolve)(t),n.promise},Gu=Nn,Wu=td,Hu=gd.CONSTRUCTOR,Ku=Bu,zu=ce("Promise"),qu=!Hu;Gu({target:"Promise",stat:!0,forced:!0},{resolve:function(e){return Ku(qu&&this===zu?Wu:this,e)}});var Yu=L,Ju=Pe,Xu=vd,Qu=ed,Zu=vs;Nn({target:"Promise",stat:!0,forced:Cu},{allSettled:function(e){var t=this,n=Xu.f(t),i=n.resolve,r=n.reject,o=Qu((function(){var n=Ju(t.resolve),r=[],o=0,s=1;Zu(e,(function(e){var a=o++,c=!1;s++,Yu(n,t,e).then((function(e){c||(c=!0,r[a]={status:"fulfilled",value:e},--s||i(r))}),(function(e){c||(c=!0,r[a]={status:"rejected",reason:e},--s||i(r))}))})),--s||i(r)}));return o.error&&r(o.value),n.promise}});var $u=L,eh=Pe,th=ce,nh=vd,ih=ed,rh=vs,oh="No one promise resolved";Nn({target:"Promise",stat:!0,forced:Cu},{any:function(e){var t=this,n=th("AggregateError"),i=nh.f(t),r=i.resolve,o=i.reject,s=ih((function(){var i=eh(t.resolve),s=[],a=0,c=1,l=!1;rh(e,(function(e){var d=a++,u=!1;c++,$u(i,t,e).then((function(e){u||l||(l=!0,r(e))}),(function(e){u||l||(u=!0,s[d]=e,--c||o(new n(s,oh)))}))})),--c||o(new n(s,oh))}));return s.error&&o(s.value),i.promise}});var sh=Nn,ah=td,ch=r,lh=ce,dh=O,uh=Jc,hh=Bu,ph=ah&&ah.prototype;sh({target:"Promise",proto:!0,real:!0,forced:!!ah&&ch((function(){ph.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=uh(this,lh("Promise")),n=dh(e);return this.then(n?function(n){return hh(t,e()).then((function(){return n}))}:e,n?function(n){return hh(t,e()).then((function(){throw n}))}:e)}});var fh=d,mh=Mn,_h=Ei,Eh=X,gh=fh("".charAt),vh=fh("".charCodeAt),Th=fh("".slice),Sh=function(e){return function(t,n){var i,r,o=_h(Eh(t)),s=mh(n),a=o.length;return s<0||s>=a?e?"":void 0:(i=vh(o,s))<55296||i>56319||s+1===a||(r=vh(o,s+1))<56320||r>57343?e?gh(o,s):i:e?Th(o,s,s+2):r-56320+(i-55296<<10)+65536}},yh={codeAt:Sh(!1),charAt:Sh(!0)},Ch=yh.charAt,Rh=Ei,wh=oa,Ih=tc,bh=nc,Ah="String Iterator",Oh=wh.set,Nh=wh.getterFor(Ah);Ih(String,"String",(function(e){Oh(this,{type:Ah,string:Rh(e),index:0})}),(function(){var e,t=Nh(this),n=t.string,i=t.index;return i>=n.length?bh(void 0,!0):(e=Ch(n,i),t.index+=e.length,bh(e,!1))}));var Dh=ie.Promise,Ph={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},kh=p,Lh=fi,Mh=gn,Uh=Vo,xh=pt("toStringTag");for(var Vh in Ph){var Fh=kh[Vh],jh=Fh&&Fh.prototype;jh&&Lh(jh)!==xh&&Mh(jh,xh,Vh),Uh[Vh]=Uh.Array}var Bh=Dh,Gh=i(Bh);const Wh=ir;function Hh(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const i=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((n=>{if("require"===n||"advanced"===n||"mediaSource"===n)return;const i="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);const r=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];let e={};"number"==typeof i.ideal?(e[r("min",n)]=i.ideal,t.optional.push(e),e={},e[r("max",n)]=i.ideal,t.optional.push(e)):(e[r("",n)]=i.ideal,t.optional.push(e))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[r("",n)]=i.exact):["min","max"].forEach((e=>{void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[r(e,n)]=i[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},r=function(e,r){if(t.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const s=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||s)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return n.mediaDevices.enumerateDevices().then((n=>{let s=(n=n.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>{var n;return Pi(n=e.label.toLowerCase()).call(n,t)}))));return!s&&n.length&&Pi(t).call(t,"back")&&(s=n[n.length-1]),s&&(e.video.deviceId=o.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=i(e.video),Wh("chrome: "+JSON.stringify(e)),r(e)}))}e.video=i(e.video)}return Wh("chrome: "+JSON.stringify(e)),r(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=function(e,t,i){r(e,(e=>{n.webkitGetUserMedia(e,t,(e=>{i&&i(o(e))}))}))}.bind(n),n.mediaDevices.getUserMedia){const e=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(t){return r(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Gh.reject(o(e))))))}}}function Kh(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function zh(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.track.id)):{track:n.track};const r=new Event("track");r.track=n.track,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)})),t.stream.getTracks().forEach((n=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===n.id)):{track:n};const r=new Event("track");r.track=n,r.receiver=i,r.transceiver={receiver:i},r.streams=[t.stream],this.dispatchEvent(r)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else er(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function qh(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){let r=n.apply(this,arguments);return r||(r=t(this,e),this._senders.push(r)),r};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Yh(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,i]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const r=function(e){const t={};return e.result().forEach((e=>{const n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{n[t]=e.stat(t)})),t[n.id]=n})),t},o=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const i=function(e){n(o(r(e)))};return t.apply(this,[i,e])}return new Gh(((e,n)=>{t.apply(this,[function(t){e(o(r(t)))},n])})).then(n,i)}}function Jh(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>cr(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),er(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>cr(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,n,i;return this.getSenders().forEach((n=>{n.track===e&&(t?i=!0:t=n)})),this.getReceivers().forEach((t=>(t.track===e&&(n?i=!0:n=t),t.track===e))),i||t&&n?Gh.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():n?n.getStats():Gh.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function Xh(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const i=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(i)&&this._shimmedLocalStreams[n.id].push(i):this._shimmedLocalStreams[n.id]=[n,i],i};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();n.apply(this,arguments);const i=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(i)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const n=this._shimmedLocalStreams[t].indexOf(e);-1!==n&&this._shimmedLocalStreams[t].splice(n,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),r.apply(this,arguments)}}function Qh(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return Xh(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=n.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const n=new e.MediaStream(t.getTracks());this._streams[t.id]=n,this._reverseStreams[n.id]=t,t=n}i.apply(this,[t])};const r=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(r.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:n})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,n){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const r=this.getSenders().find((e=>e.track===t));if(r)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[n.id];if(o)o.addTrack(t),Gh.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const i=new e.MediaStream([t]);this._streams[n.id]=i,this._reverseStreams[i.id]=n,this.addStream(i)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?n.apply(this,[t=>{const n=o(this,t);e[0].apply(null,[n])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):n.apply(this,arguments).then((e=>o(this,e)))}};e.RTCPeerConnection.prototype[t]=i[t]}));const s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const i=e._reverseStreams[t],r=e._streams[i.id];n=n.replace(new RegExp(i.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:n})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((n=>{this._streams[n].getTracks().find((t=>e.track===t))&&(t=this._streams[n])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Zh(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}))}function $h(e,t){er(e,"negotiationneeded",(e=>{const n=e.target;if(!(t.version<72||n.getConfiguration&&"plan-b"===n.getConfiguration().sdpSemantics)||"stable"===n.signalingState)return e}))}var ep=Object.freeze({__proto__:null,fixNegotiationNeeded:$h,shimAddTrackRemoveTrack:Qh,shimAddTrackRemoveTrackWithNative:Xh,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then((t=>{const i=n.video&&n.video.width,r=n.video&&n.video.height,o=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},i&&(n.video.mandatory.maxWidth=i),r&&(n.video.mandatory.maxHeight=r),e.navigator.mediaDevices.getUserMedia(n)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:qh,shimGetStats:Yh,shimGetUserMedia:Hh,shimMediaStream:Kh,shimOnTrack:zh,shimPeerConnection:Zh,shimSenderReceiverGetStats:Jh});function tp(e,t){const n=e&&e.navigator,i=e&&e.MediaStreamTrack;if(n.getUserMedia=function(e,t,i){rr("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const e=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t])},t=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(n){return"object"==typeof n&&"object"==typeof n.audio&&(n=JSON.parse(JSON.stringify(n)),e(n.audio,"autoGainControl","mozAutoGainControl"),e(n.audio,"noiseSuppression","mozNoiseSuppression")),t(n)},i&&i.prototype.getSettings){const t=i.prototype.getSettings;i.prototype.getSettings=function(){const n=t.apply(this,arguments);return e(n,"mozAutoGainControl","autoGainControl"),e(n,"mozNoiseSuppression","noiseSuppression"),n}}if(i&&i.prototype.applyConstraints){const t=i.prototype.applyConstraints;i.prototype.applyConstraints=function(n){return"audio"===this.kind&&"object"==typeof n&&(n=JSON.parse(JSON.stringify(n)),e(n,"autoGainControl","mozAutoGainControl"),e(n,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[n])}}}}function np(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ip(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const n=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]}));const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,o]=arguments;return i.apply(this,[e||null]).then((e=>{if(t.version<53&&!r)try{e.forEach((e=>{e.type=n[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,i)=>{e.set(i,Object.assign({},t,{type:n[t.type]||t.type}))}))}return e})).then(r,o)}}function rp(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Gh.resolve(new Map)}}function op(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),er(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function sp(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){rr("removeStream","removeTrack"),this.getSenders().forEach((t=>{var n;t.track&&Pi(n=e.getTracks()).call(n,t.track)&&this.removeTrack(t)}))})}function ap(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function cp(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const n=e.length>0;n&&e.forEach((e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const i=t.apply(this,arguments);if(n){const{sender:t}=i,n=t.getParameters();(!("encodings"in n)||1===n.encodings.length&&0===Object.keys(n.encodings[0]).length)&&(n.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(n).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return i})}function lp(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function dp(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Gh.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function up(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Gh.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var hp=Object.freeze({__proto__:null,shimAddTransceiver:cp,shimCreateAnswer:up,shimCreateOffer:dp,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Gh.reject(e)}return!0===n.video?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:lp,shimGetUserMedia:tp,shimOnTrack:np,shimPeerConnection:ip,shimRTCDataChannel:ap,shimReceiverGetStats:op,shimRemoveStream:sp,shimSenderGetStats:rp});function pp(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){var n;this._localStreams||(this._localStreams=[]),Pi(n=this._localStreams).call(n,e)||this._localStreams.push(e),e.getAudioTracks().forEach((n=>t.call(this,n,e))),e.getVideoTracks().forEach((n=>t.call(this,n,e)))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return i&&i.forEach((e=>{var t;this._localStreams?Pi(t=this._localStreams).call(t,e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const n=e.getTracks();this.getSenders().forEach((e=>{Pi(n).call(n,e.track)&&this.removeTrack(e)}))})}}function fp(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{var t;if(this._remoteStreams||(this._remoteStreams=[]),Pi(t=this._remoteStreams).call(t,e))return;this._remoteStreams.push(e);const n=new Event("addstream");n.stream=e,this.dispatchEvent(n)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const n=new Event("addstream");n.stream=t,e.dispatchEvent(n)}))}),t.apply(e,arguments)}}}function mp(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],r=n.apply(this,[i]);return t?(r.then(e,t),Gh.resolve()):r},t.createAnswer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],r=i.apply(this,[n]);return t?(r.then(e,t),Gh.resolve()):r};let a=function(e,t,n){const i=r.apply(this,[e]);return n?(i.then(t,n),Gh.resolve()):i};t.setLocalDescription=a,a=function(e,t,n){const i=o.apply(this,[e]);return n?(i.then(t,n),Gh.resolve()):i},t.setRemoteDescription=a,a=function(e,t,n){const i=s.apply(this,[e]);return n?(i.then(t,n),Gh.resolve()):i},t.addIceCandidate=a}function _p(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,n=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>n(Ep(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,i){t.mediaDevices.getUserMedia(e).then(n,i)}.bind(t))}function Ep(e){return e&&void 0!==e.video?Object.assign({},e,{video:sr(e.video)}):e}function gp(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){const t=[];for(let n=0;n<e.iceServers.length;n++){let i=e.iceServers[n];!i.hasOwnProperty("urls")&&i.hasOwnProperty("url")?(rr("RTCIceServer.url","RTCIceServer.urls"),i=JSON.parse(JSON.stringify(i)),i.urls=i.url,delete i.url,t.push(i)):t.push(e.iceServers[n])}e.iceServers=t}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function vp(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Tp(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const n=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function Sp(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var yp=Object.freeze({__proto__:null,shimAudioContext:Sp,shimCallbacksAPI:mp,shimConstraints:Ep,shimCreateOfferLegacy:Tp,shimGetUserMedia:_p,shimLocalStreamsAPI:pp,shimRTCIceServerUrls:gp,shimRemoteStreamsAPI:fp,shimTrackEventTransceiver:vp}),Cp="\t\n\v\f\r \xa0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028\u2029\ufeff",Rp=X,wp=Ei,Ip=Cp,bp=d("".replace),Ap=RegExp("^["+Ip+"]+"),Op=RegExp("(^|[^"+Ip+"])["+Ip+"]+$"),Np=function(e){return function(t){var n=wp(Rp(t));return 1&e&&(n=bp(n,Ap,"")),2&e&&(n=bp(n,Op,"$1")),n}},Dp={start:Np(1),end:Np(2),trim:Np(3)},Pp=ua.PROPER,kp=r,Lp=Cp,Mp=Dp.trim;Nn({target:"String",proto:!0,forced:function(e){return kp((function(){return!!Lp[e]()||"\u200b\x85\u180e"!=="\u200b\x85\u180e"[e]()||Pp&&Lp[e].name!==e}))}("trim")},{trim:function(){return Mp(this)}});var Up=Zn("String").trim,xp=u,Vp=Up,Fp=String.prototype,jp=function(e){var t=e.trim;return"string"==typeof e||e===Fp||xp(Fp,e)&&t===Fp.trim?Vp:t},Bp=i(jp),Gp={exports:{}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const n=t.splitSections(e);return n&&n[0]},t.getMediaSections=function(e){const n=t.splitSections(e);return n.shift(),n},t.matchPrefix=function(e,n){return t.splitLines(e).filter((e=>0===e.indexOf(n)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const n={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let i=8;i<t.length;i+=2)switch(t[i]){case"raddr":n.relatedAddress=t[i+1];break;case"rport":n.relatedPort=parseInt(t[i+1],10);break;case"tcptype":n.tcpType=t[i+1];break;case"ufrag":n.ufrag=t[i+1],n.usernameFragment=t[i+1];break;default:void 0===n[t[i]]&&(n[t[i]]=t[i+1])}return n},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const n=e.component;"rtp"===n?t.push(1):"rtcp"===n?t.push(2):t.push(n),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const n=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let n;const i=e.substring(e.indexOf(" ")+1).split(";");for(let r=0;r<i.length;r++)n=i[r].trim().split("="),t[n[0].trim()]=n[1];return t},t.writeFmtp=function(e){let t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const i=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)})),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),n={ssrc:parseInt(e.substring(7,t),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substring(t+1,i),n.value=e.substring(i+1)):n.attribute=e.substring(t+1),n},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const n=t.matchPrefix(e,"a=mid:")[0];if(n)return n.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,n){return{role:"auto",fingerprints:t.matchPrefix(e+n,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let n="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),n},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,n){return t.matchPrefix(e+n,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,n){const i=t.matchPrefix(e+n,"a=ice-ufrag:")[0],r=t.matchPrefix(e+n,"a=ice-pwd:")[0];return i&&r?{usernameFragment:i.substring(12),password:r.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" ");n.profile=i[2];for(let o=3;o<i.length;o++){const r=i[o],s=t.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(s){const i=t.parseRtpMap(s),o=t.matchPrefix(e,"a=fmtp:"+r+" ");switch(i.parameters=o.length?t.parseFmtp(o[0]):{},i.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(t.parseRtcpFb),n.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(i.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{n.headerExtensions.push(t.parseExtmap(e))}));const r=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return n.codecs.forEach((e=>{r.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),n},t.writeRtpDescription=function(e,n){let i="";i+="m="+e+" ",i+=n.codecs.length>0?"9":"0",i+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=n.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",n.codecs.forEach((e=>{i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)}));let r=0;return n.codecs.forEach((e=>{e.maxptime>r&&(r=e.maxptime)})),r>0&&(i+="a=maxptime:"+r+"\r\n"),n.headerExtensions&&n.headerExtensions.forEach((e=>{i+=t.writeExtmap(e)})),i},t.parseRtpEncodingParameters=function(e){const n=[],i=t.parseRtpParameters(e),r=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=s.length>0&&s[0].ssrc;let c;const l=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));l.length>0&&l[0].length>1&&l[0][0]===a&&(c=l[0][1]),i.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),n.push(t),r&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:o?"red+ulpfec":"red"},n.push(t))}})),0===n.length&&a&&n.push({ssrc:a});let d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substring(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substring(5),10)*.95-16e3:void 0,n.forEach((e=>{e.maxBitrate=d}))),n},t.parseRtcpParameters=function(e){const n={},i=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];i&&(n.cname=i.value,n.ssrc=i.ssrc);const r=t.matchPrefix(e,"a=rtcp-rsize");n.reducedSize=r.length>0,n.compound=0===r.length;const o=t.matchPrefix(e,"a=rtcp-mux");return n.mux=o.length>0,n},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let n;const i=t.matchPrefix(e,"a=msid:");if(1===i.length)return n=i[0].substring(7).split(" "),{stream:n[0],track:n[1]};const r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return r.length>0?(n=r[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},t.parseSctpDescription=function(e){const n=t.parseMLine(e),i=t.matchPrefix(e,"a=max-message-size:");let r;i.length>0&&(r=parseInt(i[0].substring(19),10)),isNaN(r)&&(r=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:n.fmt,maxMessageSize:r};const s=t.matchPrefix(e,"a=sctpmap:");if(s.length>0){const e=s[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){let n=[];return n="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&n.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,n,i){let r;const o=void 0!==n?n:2;return r=e||t.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+r+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,n){const i=t.splitLines(e);for(let t=0;t<i.length;t++)switch(i[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[t].substring(2)}return n?t.getDirection(n):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const n=t.splitLines(e)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},t.parseOLine=function(e){const n=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const n=t.splitLines(e);for(let t=0;t<n.length;t++)if(n[t].length<2||"="!==n[t].charAt(1))return!1;return!0},e.exports=t}(Gp);var Wp=Gp.exports,Hp=i(Wp),Kp=e({__proto__:null,default:Hp},[Wp]);function zp(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const n=new t(e),i=Hp.parseCandidate(e.candidate),r=Object.assign(n,i);return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,er(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function qp(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||er(e,"icecandidate",(e=>{if(e.candidate){const t=Hp.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function Yp(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const n=function(e){if(!e||!e.sdp)return!1;const t=Hp.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=Hp.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},i=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const n=parseInt(t[1],10);return n!=n?-1:n},r=function(e){let n=65536;return"firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),n},o=function(e,n){let i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);const r=Hp.matchPrefix(e.sdp,"a=max-message-size:");return r.length>0?i=parseInt(r[0].substr(19),10):"firefox"===t.browser&&-1!==n&&(i=2147483637),i},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const e=i(arguments[0]),t=r(e),n=o(arguments[0],e);let s;s=0===t&&0===n?Number.POSITIVE_INFINITY:0===t||0===n?Math.max(t,n):Math.min(t,n);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>s}),this._sctp=a}return s.apply(this,arguments)}}function Jp(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const n=e.send;e.send=function(){const i=arguments[0],r=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&r>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=n.apply(this,arguments);return t(e,this),e},er(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function Xp(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const n=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const n=new Event("connectionstatechange",e);t.dispatchEvent(n)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}}))}function Qp(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const n=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==Bp(e).call(e))).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:n}):t.sdp=n}return n.apply(this,arguments)}}function Zp(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.addIceCandidate;n&&0!==n.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Gh.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Gh.resolve())})}function $p(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.setLocalDescription;n&&0!==n.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return n.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}return e.sdp||"offer"!==e.type&&"answer"!==e.type?n.apply(this,[e]):("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>n.apply(this,[e])))})}var ef=Object.freeze({__proto__:null,removeExtmapAllowMixed:Qp,shimAddIceCandidateNullOrEmpty:Zp,shimConnectionState:Xp,shimMaxMessageSize:Yp,shimParameterlessSetLocalDescription:$p,shimRTCIceCandidate:zp,shimRTCIceCandidateRelayProtocol:qp,shimSendThrowTypeError:Jp});!function(){let{window:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=ir,i=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:n}=e;if(n.mozGetUserMedia)t.browser="firefox",t.version=$i(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=$i(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!n.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=$i(n.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),r={browserDetails:i,commonShim:ef,extractVersion:$i,disableLog:tr,disableWarnings:nr,sdp:Kp};switch(i.browser){case"chrome":if(!ep||!Zh||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(null===i.version)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=ep,Zp(e,i),$p(e),Hh(e,i),Kh(e),Zh(e,i),zh(e),Qh(e,i),qh(e),Yh(e),Jh(e),$h(e,i),zp(e),qp(e),Xp(e),Yp(e,i),Jp(e),Qp(e,i);break;case"firefox":if(!hp||!ip||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=hp,Zp(e,i),$p(e),tp(e,i),ip(e,i),np(e),sp(e),rp(e),op(e),ap(e),cp(e),lp(e),dp(e),up(e),zp(e),Xp(e),Yp(e,i),Jp(e);break;case"safari":if(!yp||!t.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=yp,Zp(e,i),$p(e),gp(e),Tp(e),mp(e),pp(e),fp(e),vp(e),_p(e),Sp(e),zp(e),qp(e),Yp(e,i),Jp(e),Qp(e,i);break;default:n("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});var tf=Zn("Array").keys,nf=fi,rf=$e,of=u,sf=tf,af=Array.prototype,cf={DOMTokenList:!0,NodeList:!0},lf=function(e){var t=e.keys;return e===af||of(af,e)&&t===af.keys||rf(cf,nf(e))?sf:t},df=i(lf),uf=Ae,hf=TypeError,pf=Ct,ff=Zt,mf=B,_f=function(e,t,n){var i=pf(t);i in e?ff.f(e,i,mf(0,n)):e[i]=n},Ef=Fn,gf=Hn,vf=_f,Tf=Array,Sf=Math.max,yf=function(e,t,n){for(var i=gf(e),r=Ef(t,i),o=Ef(void 0===n?i:n,i),s=Tf(Sf(o-r,0)),a=0;r<o;r++,a++)vf(s,a,e[r]);return s.length=a,s},Cf=yf,Rf=Math.floor,wf=function(e,t){var n=e.length,i=Rf(n/2);return n<8?If(e,t):bf(e,wf(Cf(e,0,i),t),wf(Cf(e,i),t),t)},If=function(e,t){for(var n,i,r=e.length,o=1;o<r;){for(i=o,n=e[o];i&&t(e[i-1],n)>0;)e[i]=e[--i];i!==o++&&(e[i]=n)}return e},bf=function(e,t,n,i){for(var r=t.length,o=n.length,s=0,a=0;s<r||a<o;)e[s+a]=s<r&&a<o?i(t[s],n[a])<=0?t[s++]:n[a++]:s<r?t[s++]:n[a++];return e},Af=wf,Of=le.match(/firefox\/(\d+)/i),Nf=!!Of&&+Of[1],Df=/MSIE|Trident/.test(le),Pf=le.match(/AppleWebKit\/(\d+)\./),kf=!!Pf&&+Pf[1],Lf=Nn,Mf=d,Uf=Pe,xf=Xe,Vf=Hn,Ff=function(e,t){if(!delete e[t])throw hf("Cannot delete property "+uf(t)+" of "+uf(e))},jf=Ei,Bf=r,Gf=Af,Wf=Bi,Hf=Nf,Kf=Df,zf=_e,qf=kf,Yf=[],Jf=Mf(Yf.sort),Xf=Mf(Yf.push),Qf=Bf((function(){Yf.sort(void 0)})),Zf=Bf((function(){Yf.sort(null)})),$f=Wf("sort"),em=!Bf((function(){if(zf)return zf<70;if(!(Hf&&Hf>3)){if(Kf)return!0;if(qf)return qf<603;var e,t,n,i,r="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(i=0;i<47;i++)Yf.push({k:t+i,v:n})}for(Yf.sort((function(e,t){return t.v-e.v})),i=0;i<Yf.length;i++)t=Yf[i].k.charAt(0),r.charAt(r.length-1)!==t&&(r+=t);return"DGBEFHACIJK"!==r}}));Lf({target:"Array",proto:!0,forced:Qf||!Zf||!$f||!em},{sort:function(e){void 0!==e&&Uf(e);var t=xf(this);if(em)return void 0===e?Jf(t):Jf(t,e);var n,i,r=[],o=Vf(t);for(i=0;i<o;i++)i in t&&Xf(r,t[i]);for(Gf(r,function(e){return function(t,n){return void 0===n?-1:void 0===t?1:void 0!==e?+e(t,n)||0:jf(t)>jf(n)?1:-1}}(e)),n=Vf(r),i=0;i<n;)t[i]=r[i++];for(;i<o;)Ff(t,i++);return t}});var tm=Zn("Array").sort,nm=u,im=tm,rm=Array.prototype,om=function(e){var t=e.sort;return e===rm||nm(rm,e)&&t===rm.sort?im:t},sm=i(om),am={exports:{}};!function(e,n){!function(t,i){var r="function",o="undefined",s="object",a="string",c="major",l="model",d="name",u="type",h="vendor",p="version",f="architecture",m="console",_="mobile",E="tablet",g="smarttv",v="wearable",T="embedded",S="Amazon",y="Apple",C="ASUS",R="BlackBerry",w="Browser",I="Chrome",b="Firefox",A="Google",O="Huawei",N="LG",D="Microsoft",P="Motorola",k="Opera",L="Samsung",M="Sharp",U="Sony",x="Xiaomi",V="Zebra",F="Facebook",j="Chromium OS",B="Mac OS",G=function(e){for(var t={},n=0;n<e.length;n++)t[e[n].toUpperCase()]=e[n];return t},W=function(e,t){return typeof e===a&&-1!==H(t).indexOf(H(e))},H=function(e){return e.toLowerCase()},K=function(e,t){if(typeof e===a)return e=e.replace(/^\s\s*/,""),typeof t===o?e:e.substring(0,350)},z=function(e,t){for(var n,o,a,c,l,d,u=0;u<t.length&&!l;){var h=t[u],p=t[u+1];for(n=o=0;n<h.length&&!l&&h[n];)if(l=h[n++].exec(e))for(a=0;a<p.length;a++)d=l[++o],typeof(c=p[a])===s&&c.length>0?2===c.length?typeof c[1]==r?this[c[0]]=c[1].call(this,d):this[c[0]]=c[1]:3===c.length?typeof c[1]!==r||c[1].exec&&c[1].test?this[c[0]]=d?d.replace(c[1],c[2]):i:this[c[0]]=d?c[1].call(this,d,c[2]):i:4===c.length&&(this[c[0]]=d?c[3].call(this,d.replace(c[1],c[2])):i):this[c]=d||i;u+=2}},q=function(e,t){for(var n in t)if(typeof t[n]===s&&t[n].length>0){for(var r=0;r<t[n].length;r++)if(W(t[n][r],e))return"?"===n?i:n}else if(W(t[n],e))return"?"===n?i:n;return e},Y={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},J={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[d,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[d,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[d,p],[/opios[\/ ]+([\w\.]+)/i],[p,[d,k+" Mini"]],[/\bopr\/([\w\.]+)/i],[p,[d,k]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[d,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[d,"UC"+w]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[p,[d,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[d,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[d,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[d,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[d,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[d,/(.+)/,"$1 Secure "+w],p],[/\bfocus\/([\w\.]+)/i],[p,[d,b+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[d,k+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[d,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[d,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[d,k+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[d,"MIUI "+w]],[/fxios\/([-\w\.]+)/i],[p,[d,b]],[/\bqihu|(qi?ho?o?|360)browser/i],[[d,"360 "+w]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[d,/(.+)/,"$1 "+w],p],[/(comodo_dragon)\/([\w\.]+)/i],[[d,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[d,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[d],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[d,F],p],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[d,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[d,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[d,I+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[d,I+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[d,"Android "+w]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[d,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[d,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,d],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[d,[p,q,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[d,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[d,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[d,b+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[d,p],[/(cobalt)\/([\w\.]+)/i],[d,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[f,"amd64"]],[/(ia32(?=;))/i],[[f,H]],[/((?:i[346]|x)86)[;\)]/i],[[f,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[f,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[f,"armhf"]],[/windows (ce|mobile); ppc;/i],[[f,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[f,/ower/,"",H]],[/(sun4\w)[;\)]/i],[[f,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[f,H]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[h,L],[u,E]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[l,[h,L],[u,_]],[/\((ip(?:hone|od)[\w ]*);/i],[l,[h,y],[u,_]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[h,y],[u,E]],[/(macintosh);/i],[l,[h,y]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[h,M],[u,_]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[l,[h,O],[u,E]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[l,[h,O],[u,_]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[l,/_/g," "],[h,x],[u,_]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[l,/_/g," "],[h,x],[u,E]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[l,[h,"OPPO"],[u,_]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[h,"Vivo"],[u,_]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[l,[h,"Realme"],[u,_]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[h,P],[u,_]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[h,P],[u,E]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[h,N],[u,E]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[h,N],[u,_]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[l,[h,"Lenovo"],[u,E]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[l,/_/g," "],[h,"Nokia"],[u,_]],[/(pixel c)\b/i],[l,[h,A],[u,E]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[h,A],[u,_]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[h,U],[u,_]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[h,U],[u,E]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[h,"OnePlus"],[u,_]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[h,S],[u,E]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[h,S],[u,_]],[/(playbook);[-\w\),; ]+(rim)/i],[l,h,[u,E]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[h,R],[u,_]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[h,C],[u,E]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[h,C],[u,_]],[/(nexus 9)/i],[l,[h,"HTC"],[u,E]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[h,[l,/_/g," "],[u,_]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[h,"Acer"],[u,E]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[h,"Meizu"],[u,_]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[h,l,[u,_]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[h,l,[u,E]],[/(surface duo)/i],[l,[h,D],[u,E]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[h,"Fairphone"],[u,_]],[/(u304aa)/i],[l,[h,"AT&T"],[u,_]],[/\bsie-(\w*)/i],[l,[h,"Siemens"],[u,_]],[/\b(rct\w+) b/i],[l,[h,"RCA"],[u,E]],[/\b(venue[\d ]{2,7}) b/i],[l,[h,"Dell"],[u,E]],[/\b(q(?:mv|ta)\w+) b/i],[l,[h,"Verizon"],[u,E]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[l,[h,"Barnes & Noble"],[u,E]],[/\b(tm\d{3}\w+) b/i],[l,[h,"NuVision"],[u,E]],[/\b(k88) b/i],[l,[h,"ZTE"],[u,E]],[/\b(nx\d{3}j) b/i],[l,[h,"ZTE"],[u,_]],[/\b(gen\d{3}) b.+49h/i],[l,[h,"Swiss"],[u,_]],[/\b(zur\d{3}) b/i],[l,[h,"Swiss"],[u,E]],[/\b((zeki)?tb.*\b) b/i],[l,[h,"Zeki"],[u,E]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[h,"Dragon Touch"],l,[u,E]],[/\b(ns-?\w{0,9}) b/i],[l,[h,"Insignia"],[u,E]],[/\b((nxa|next)-?\w{0,9}) b/i],[l,[h,"NextBook"],[u,E]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[h,"Voice"],l,[u,_]],[/\b(lvtel\-)?(v1[12]) b/i],[[h,"LvTel"],l,[u,_]],[/\b(ph-1) /i],[l,[h,"Essential"],[u,_]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[l,[h,"Envizen"],[u,E]],[/\b(trio[-\w\. ]+) b/i],[l,[h,"MachSpeed"],[u,E]],[/\btu_(1491) b/i],[l,[h,"Rotor"],[u,E]],[/(shield[\w ]+) b/i],[l,[h,"Nvidia"],[u,E]],[/(sprint) (\w+)/i],[h,l,[u,_]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[h,D],[u,_]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[h,V],[u,E]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[h,V],[u,_]],[/smart-tv.+(samsung)/i],[h,[u,g]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[h,L],[u,g]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[h,N],[u,g]],[/(apple) ?tv/i],[h,[l,y+" TV"],[u,g]],[/crkey/i],[[l,I+"cast"],[h,A],[u,g]],[/droid.+aft(\w)( bui|\))/i],[l,[h,S],[u,g]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[l,[h,M],[u,g]],[/(bravia[\w ]+)( bui|\))/i],[l,[h,U],[u,g]],[/(mitv-\w{5}) bui/i],[l,[h,x],[u,g]],[/Hbbtv.*(technisat) (.*);/i],[h,l,[u,g]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[h,K],[l,K],[u,g]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,g]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[h,l,[u,m]],[/droid.+; (shield) bui/i],[l,[h,"Nvidia"],[u,m]],[/(playstation [345portablevi]+)/i],[l,[h,U],[u,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[h,D],[u,m]],[/((pebble))app/i],[h,l,[u,v]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[l,[h,y],[u,v]],[/droid.+; (glass) \d/i],[l,[h,A],[u,v]],[/droid.+; (wt63?0{2,3})\)/i],[l,[h,V],[u,v]],[/(quest( 2| pro)?)/i],[l,[h,F],[u,v]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[h,[u,T]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[l,[u,_]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[u,E]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,E]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,_]],[/(android[-\w\. ]{0,9});.+buil/i],[l,[h,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[d,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[d,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[d,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,d]],os:[[/microsoft (windows) (vista|xp)/i],[d,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[d,[p,q,Y]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[d,"Windows"],[p,q,Y]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[d,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[d,B],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,d],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[d,p],[/\(bb(10);/i],[p,[d,R]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[d,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[d,b+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[d,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[d,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[d,I+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[d,j],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[d,p],[/(sunos) ?([\w\.\d]*)/i],[[d,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[d,p]]},X=function(e,n){if(typeof e===s&&(n=e,e=i),!(this instanceof X))return new X(e,n).getResult();var m=typeof t!==o&&t.navigator?t.navigator:i,g=e||(m&&m.userAgent?m.userAgent:""),v=m&&m.userAgentData?m.userAgentData:i,T=n?function(e,t){var n={};for(var i in e)t[i]&&t[i].length%2==0?n[i]=t[i].concat(e[i]):n[i]=e[i];return n}(J,n):J;return this.getBrowser=function(){var e={};return e[d]=i,e[p]=i,z.call(e,g,T.browser),e[c]=function(e){return typeof e===a?e.replace(/[^\d\.]/g,"").split(".")[0]:i}(e[p]),m&&m.brave&&typeof m.brave.isBrave==r&&(e[d]="Brave"),e},this.getCPU=function(){var e={};return e[f]=i,z.call(e,g,T.cpu),e},this.getDevice=function(){var e={};return e[h]=i,e[l]=i,e[u]=i,z.call(e,g,T.device),!e[u]&&v&&v.mobile&&(e[u]=_),"Macintosh"==e[l]&&m&&typeof m.standalone!==o&&m.maxTouchPoints&&m.maxTouchPoints>2&&(e[l]="iPad",e[u]=E),e},this.getEngine=function(){var e={};return e[d]=i,e[p]=i,z.call(e,g,T.engine),e},this.getOS=function(){var e={};return e[d]=i,e[p]=i,z.call(e,g,T.os),!e[d]&&v&&"Unknown"!=v.platform&&(e[d]=v.platform.replace(/chrome os/i,j).replace(/macos/i,B)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return g},this.setUA=function(e){return g=typeof e===a&&e.length>350?K(e,350):e,this},this.setUA(g),this};X.VERSION="0.7.34",X.BROWSER=G([d,p,c]),X.CPU=G([f]),X.DEVICE=G([l,h,u,m,_,g,E,v,T]),X.ENGINE=X.OS=G([d,p]),e.exports&&(n=e.exports=X),n.UAParser=X;var Q=typeof t!==o&&(t.jQuery||t.Zepto);if(Q&&!Q.ua){var Z=new X;Q.ua=Z.getResult(),Q.ua.get=function(){return Z.getUA()},Q.ua.set=function(e){Z.setUA(e);var t=Z.getResult();for(var n in t)Q.ua[n]=t[n]}}}("object"==typeof window?window:t)}(am,am.exports);var cm=i(am.exports),lm=fi,dm=$e,um=q,hm=Vo,pm=pt("iterator"),fm=Object,mm=function(e){if(um(e))return!1;var t=fm(e);return void 0!==t[pm]||"@@iterator"in t||dm(hm,lm(t))},_m=i(mm),Em=p;Nn({global:!0,forced:Em.globalThis!==Em},{globalThis:Em});var gm=i(p);function vm(e,t){return function(){return e.apply(t,arguments)}}const{toString:Tm}=Object.prototype,{getPrototypeOf:Sm}=Object,ym=(Cm=Object.create(null),e=>{const t=Tm.call(e);return Cm[t]||(Cm[t]=t.slice(8,-1).toLowerCase())});var Cm;const Rm=e=>(e=e.toLowerCase(),t=>ym(t)===e),wm=e=>t=>typeof t===e,{isArray:Im}=Array,bm=wm("undefined"),Am=Rm("ArrayBuffer"),Om=wm("string"),Nm=wm("function"),Dm=wm("number"),Pm=e=>null!==e&&"object"==typeof e,km=e=>{if("object"!==ym(e))return!1;const t=Sm(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||_m(e))},Lm=Rm("Date"),Mm=Rm("File"),Um=Rm("Blob"),xm=Rm("FileList"),Vm=Rm("URLSearchParams");function Fm(e,t){let n,i,{allOwnKeys:r=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null!=e)if("object"!=typeof e&&(e=[e]),Im(e))for(n=0,i=e.length;n<i;n++)t.call(null,e[n],n,e);else{const i=r?Object.getOwnPropertyNames(e):Object.keys(e),o=i.length;let s;for(n=0;n<o;n++)s=i[n],t.call(null,e[s],s,e)}}function jm(e,t){t=t.toLowerCase();const n=Object.keys(e);let i,r=n.length;for(;r-- >0;)if(i=n[r],t===i.toLowerCase())return i;return null}const Bm=void 0!==gm?gm:"undefined"!=typeof self?self:"undefined"!=typeof window?window:n.g,Gm=e=>!bm(e)&&e!==Bm,Wm=(Hm="undefined"!=typeof Uint8Array&&Sm(Uint8Array),e=>Hm&&e instanceof Hm);var Hm;const Km=Rm("HTMLFormElement"),zm=(e=>{let{hasOwnProperty:t}=e;return(e,n)=>t.call(e,n)})(Object.prototype),qm=Rm("RegExp"),Ym=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),i={};Fm(n,((n,r)=>{let o;!1!==(o=t(n,r,e))&&(i[r]=o||n)})),Object.defineProperties(e,i)},Jm="abcdefghijklmnopqrstuvwxyz",Xm="0123456789",Qm={DIGIT:Xm,ALPHA:Jm,ALPHA_DIGIT:Jm+Jm.toUpperCase()+Xm},Zm=Rm("AsyncFunction");var $m={isArray:Im,isArrayBuffer:Am,isBuffer:function(e){return null!==e&&!bm(e)&&null!==e.constructor&&!bm(e.constructor)&&Nm(e.constructor.isBuffer)&&e.constructor.isBuffer(e)},isFormData:e=>{let t;return e&&("function"==typeof FormData&&e instanceof FormData||Nm(e.append)&&("formdata"===(t=ym(e))||"object"===t&&Nm(e.toString)&&"[object FormData]"===e.toString()))},isArrayBufferView:function(e){let t;return t="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&Am(e.buffer),t},isString:Om,isNumber:Dm,isBoolean:e=>!0===e||!1===e,isObject:Pm,isPlainObject:km,isUndefined:bm,isDate:Lm,isFile:Mm,isBlob:Um,isRegExp:qm,isFunction:Nm,isStream:e=>Pm(e)&&Nm(e.pipe),isURLSearchParams:Vm,isTypedArray:Wm,isFileList:xm,forEach:Fm,merge:function e(){const{caseless:t}=Gm(this)&&this||{},n={},i=(i,r)=>{const o=t&&jm(n,r)||r;km(n[o])&&km(i)?n[o]=e(n[o],i):km(i)?n[o]=e({},i):Im(i)?n[o]=i.slice():n[o]=i};for(let r=0,o=arguments.length;r<o;r++)arguments[r]&&Fm(arguments[r],i);return n},extend:function(e,t,n){let{allOwnKeys:i}=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return Fm(t,((t,i)=>{n&&Nm(t)?e[i]=vm(t,n):e[i]=t}),{allOwnKeys:i}),e},trim:e=>Bp(e)?Bp(e).call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),inherits:(e,t,n,i)=>{e.prototype=Object.create(t.prototype,i),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),n&&Object.assign(e.prototype,n)},toFlatObject:(e,t,n,i)=>{let r,o,s;const a={};if(t=t||{},null==e)return t;do{for(r=Object.getOwnPropertyNames(e),o=r.length;o-- >0;)s=r[o],i&&!i(s,e,t)||a[s]||(t[s]=e[s],a[s]=!0);e=!1!==n&&Sm(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},kindOf:ym,kindOfTest:Rm,endsWith:(e,t,n)=>{e=String(e),(void 0===n||n>e.length)&&(n=e.length),n-=t.length;const i=e.indexOf(t,n);return-1!==i&&i===n},toArray:e=>{if(!e)return null;if(Im(e))return e;let t=e.length;if(!Dm(t))return null;const n=new Array(t);for(;t-- >0;)n[t]=e[t];return n},forEachEntry:(e,t)=>{const n=(e&&e[Symbol.iterator]).call(e);let i;for(;(i=n.next())&&!i.done;){const n=i.value;t.call(e,n[0],n[1])}},matchAll:(e,t)=>{let n;const i=[];for(;null!==(n=e.exec(t));)i.push(n);return i},isHTMLForm:Km,hasOwnProperty:zm,hasOwnProp:zm,reduceDescriptors:Ym,freezeMethods:e=>{Ym(e,((t,n)=>{if(Nm(e)&&-1!==["arguments","caller","callee"].indexOf(n))return!1;const i=e[n];Nm(i)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))}))},toObjectSet:(e,t)=>{const n={},i=e=>{e.forEach((e=>{n[e]=!0}))};return Im(e)?i(e):i(String(e).split(t)),n},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(e,t,n){return t.toUpperCase()+n})),noop:()=>{},toFiniteNumber:(e,t)=>(e=+e,Number.isFinite(e)?e:t),findKey:jm,global:Bm,isContextDefined:Gm,ALPHABET:Qm,generateString:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Qm.ALPHA_DIGIT,n="";const{length:i}=t;for(;e--;)n+=t[Math.random()*i|0];return n},isSpecCompliantForm:function(e){return!!(e&&Nm(e.append)&&"FormData"===e[Symbol.toStringTag]&&e[Symbol.iterator])},toJSONObject:e=>{const t=new Array(10),n=(e,i)=>{if(Pm(e)){if(t.indexOf(e)>=0)return;if(!("toJSON"in e)){t[i]=e;const r=Im(e)?[]:{};return Fm(e,((e,t)=>{const o=n(e,i+1);!bm(o)&&(r[t]=o)})),t[i]=void 0,r}}return e};return n(e,0)},isAsyncFn:Zm,isThenable:e=>e&&(Pm(e)||Nm(e))&&Nm(e.then)&&Nm(e.catch)};function e_(e,t,n,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r)}$m.inherits(e_,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:$m.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const t_=e_.prototype,n_={};function i_(e){return $m.isPlainObject(e)||$m.isArray(e)}function r_(e){return $m.endsWith(e,"[]")?e.slice(0,-2):e}function o_(e,t,n){return e?e.concat(t).map((function(e,t){return e=r_(e),!n&&t?"["+e+"]":e})).join(n?".":""):t}["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{n_[e]={value:e}})),Object.defineProperties(e_,n_),Object.defineProperty(t_,"isAxiosError",{value:!0}),e_.from=(e,t,n,i,r,o)=>{const s=Object.create(t_);return $m.toFlatObject(e,s,(function(e){return e!==Error.prototype}),(e=>"isAxiosError"!==e)),e_.call(s,e.message,t,n,i,r),s.cause=e,s.name=e.name,o&&Object.assign(s,o),s};const s_=$m.toFlatObject($m,{},null,(function(e){return/^is[A-Z]/.test(e)}));function a_(e,t,n){if(!$m.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const i=(n=$m.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(e,t){return!$m.isUndefined(t[e])}))).metaTokens,r=n.visitor||l,o=n.dots,s=n.indexes,a=(n.Blob||"undefined"!=typeof Blob&&Blob)&&$m.isSpecCompliantForm(t);if(!$m.isFunction(r))throw new TypeError("visitor must be a function");function c(e){if(null===e)return"";if($m.isDate(e))return e.toISOString();if(!a&&$m.isBlob(e))throw new e_("Blob is not supported. Use a Buffer instead.");return $m.isArrayBuffer(e)||$m.isTypedArray(e)?a&&"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}function l(e,n,r){let a=e;if(e&&!r&&"object"==typeof e)if($m.endsWith(n,"{}"))n=i?n:n.slice(0,-2),e=JSON.stringify(e);else if($m.isArray(e)&&function(e){return $m.isArray(e)&&!e.some(i_)}(e)||($m.isFileList(e)||$m.endsWith(n,"[]"))&&(a=$m.toArray(e)))return n=r_(n),a.forEach((function(e,i){!$m.isUndefined(e)&&null!==e&&t.append(!0===s?o_([n],i,o):null===s?n:n+"[]",c(e))})),!1;return!!i_(e)||(t.append(o_(r,n,o),c(e)),!1)}const d=[],u=Object.assign(s_,{defaultVisitor:l,convertValue:c,isVisitable:i_});if(!$m.isObject(e))throw new TypeError("data must be an object");return function e(n,i){if(!$m.isUndefined(n)){if(-1!==d.indexOf(n))throw Error("Circular reference detected in "+i.join("."));d.push(n),$m.forEach(n,(function(n,o){!0===(!($m.isUndefined(n)||null===n)&&r.call(t,n,$m.isString(o)?Bp(o).call(o):o,i,u))&&e(n,i?i.concat(o):[o])})),d.pop()}}(e),t}function c_(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(e){return t[e]}))}function l_(e,t){this._pairs=[],e&&a_(e,this,t)}const d_=l_.prototype;function u_(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function h_(e,t,n){if(!t)return e;const i=n&&n.encode||u_,r=n&&n.serialize;let o;if(o=r?r(t,n):$m.isURLSearchParams(t)?t.toString():new l_(t,n).toString(i),o){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+o}return e}d_.append=function(e,t){this._pairs.push([e,t])},d_.toString=function(e){const t=e?function(t){return e.call(this,t,c_)}:c_;return this._pairs.map((function(e){return t(e[0])+"="+t(e[1])}),"").join("&")};var p_=class{constructor(){this.handlers=[]}use(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){$m.forEach(this.handlers,(function(t){null!==t&&e(t)}))}},f_={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},m_={exports:{}},__=Nn,E_=D,g_=Zt.f;__({target:"Object",stat:!0,forced:Object.defineProperty!==g_,sham:!E_},{defineProperty:g_});var v_=ie.Object,T_=m_.exports=function(e,t,n){return v_.defineProperty(e,t,n)};v_.defineProperty.sham&&(T_.sham=!0);var S_=i(m_.exports),y_=y,C_=Array.isArray||function(e){return"Array"==y_(e)},R_=TypeError,w_=C_,I_=Bc,b_=ne,A_=pt("species"),O_=Array,N_=function(e){var t;return w_(e)&&(t=e.constructor,(I_(t)&&(t===O_||w_(t.prototype))||b_(t)&&null===(t=t[A_]))&&(t=void 0)),void 0===t?O_:t},D_=function(e,t){return new(N_(e))(0===t?0:t)},P_=r,k_=_e,L_=pt("species"),M_=function(e){return k_>=51||!P_((function(){var t=[];return(t.constructor={})[L_]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},U_=Nn,x_=r,V_=C_,F_=ne,j_=Xe,B_=Hn,G_=function(e){if(e>9007199254740991)throw R_("Maximum allowed index exceeded");return e},W_=_f,H_=D_,K_=M_,z_=_e,q_=pt("isConcatSpreadable"),Y_=z_>=51||!x_((function(){var e=[];return e[q_]=!1,e.concat()[0]!==e})),J_=function(e){if(!F_(e))return!1;var t=e[q_];return void 0!==t?!!t:V_(e)};U_({target:"Array",proto:!0,arity:1,forced:!Y_||!K_("concat")},{concat:function(e){var t,n,i,r,o,s=j_(this),a=H_(s,0),c=0;for(t=-1,i=arguments.length;t<i;t++)if(J_(o=-1===t?s:arguments[t]))for(r=B_(o),G_(c+r),n=0;n<r;n++,c++)n in o&&W_(a,c,o[n]);else G_(c+1),W_(a,c++,o);return a.length=c,a}});var X_={},Q_=y,Z_=$,$_=Nr.f,eE=yf,tE="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];X_.f=function(e){return tE&&"Window"==Q_(e)?function(e){try{return $_(e)}catch(e){return eE(tE)}}(e):$_(Z_(e))};var nE={},iE=pt;nE.f=iE;var rE=ie,oE=$e,sE=nE,aE=Zt.f,cE=function(e){var t=rE.Symbol||(rE.Symbol={});oE(t,e)||aE(t,e,{value:sE.f(e)})},lE=L,dE=ce,uE=pt,hE=pa,pE=function(){var e=dE("Symbol"),t=e&&e.prototype,n=t&&t.valueOf,i=uE("toPrimitive");t&&!t[i]&&hE(t,i,(function(e){return lE(n,this)}),{arity:1})},fE=Qt,mE=z,_E=Xe,EE=Hn,gE=D_,vE=d([].push),TE=function(e){var t=1==e,n=2==e,i=3==e,r=4==e,o=6==e,s=7==e,a=5==e||o;return function(c,l,d,u){for(var h,p,f=_E(c),m=mE(f),_=fE(l,d),E=EE(m),g=0,v=u||gE,T=t?v(c,E):n||s?v(c,0):void 0;E>g;g++)if((a||g in m)&&(p=_(h=m[g],g,f),e))if(t)T[g]=p;else if(p)switch(e){case 3:return!0;case 5:return h;case 6:return g;case 2:vE(T,h)}else switch(e){case 4:return!1;case 7:vE(T,h)}return o?-1:i||r?r:T}},SE={forEach:TE(0),map:TE(1),filter:TE(2),some:TE(3),every:TE(4),find:TE(5),findIndex:TE(6),filterReject:TE(7)},yE=Nn,CE=p,RE=L,wE=d,IE=D,bE=Te,AE=r,OE=$e,NE=u,DE=rn,PE=$,kE=Ct,LE=Ei,ME=B,UE=Ro,xE=to,VE=Nr,FE=X_,jE=Br,BE=N,GE=Zt,WE=Zr,HE=M,KE=pa,zE=hc,qE=qe,YE=Dr,JE=rt,XE=pt,QE=nE,ZE=cE,$E=pE,eg=Pa,tg=oa,ng=SE.forEach,ig=ur("hidden"),rg="Symbol",og="prototype",sg=tg.set,ag=tg.getterFor(rg),cg=Object[og],lg=CE.Symbol,dg=lg&&lg[og],ug=CE.TypeError,hg=CE.QObject,pg=BE.f,fg=GE.f,mg=FE.f,_g=HE.f,Eg=wE([].push),gg=qE("symbols"),vg=qE("op-symbols"),Tg=qE("wks"),Sg=!hg||!hg[og]||!hg[og].findChild,yg=IE&&AE((function(){return 7!=UE(fg({},"a",{get:function(){return fg(this,"a",{value:7}).a}})).a}))?function(e,t,n){var i=pg(cg,t);i&&delete cg[t],fg(e,t,n),i&&e!==cg&&fg(cg,t,i)}:fg,Cg=function(e,t){var n=gg[e]=UE(dg);return sg(n,{type:rg,tag:e,description:t}),IE||(n.description=t),n},Rg=function(e,t,n){e===cg&&Rg(vg,t,n),DE(e);var i=kE(t);return DE(n),OE(gg,i)?(n.enumerable?(OE(e,ig)&&e[ig][i]&&(e[ig][i]=!1),n=UE(n,{enumerable:ME(0,!1)})):(OE(e,ig)||fg(e,ig,ME(1,{})),e[ig][i]=!0),yg(e,i,n)):fg(e,i,n)},wg=function(e,t){DE(e);var n=PE(t),i=xE(n).concat(Og(n));return ng(i,(function(t){IE&&!RE(Ig,n,t)||Rg(e,t,n[t])})),e},Ig=function(e){var t=kE(e),n=RE(_g,this,t);return!(this===cg&&OE(gg,t)&&!OE(vg,t))&&(!(n||!OE(this,t)||!OE(gg,t)||OE(this,ig)&&this[ig][t])||n)},bg=function(e,t){var n=PE(e),i=kE(t);if(n!==cg||!OE(gg,i)||OE(vg,i)){var r=pg(n,i);return!r||!OE(gg,i)||OE(n,ig)&&n[ig][i]||(r.enumerable=!0),r}},Ag=function(e){var t=mg(PE(e)),n=[];return ng(t,(function(e){OE(gg,e)||OE(YE,e)||Eg(n,e)})),n},Og=function(e){var t=e===cg,n=mg(t?vg:PE(e)),i=[];return ng(n,(function(e){!OE(gg,e)||t&&!OE(cg,e)||Eg(i,gg[e])})),i};bE||(lg=function(){if(NE(dg,this))throw ug("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?LE(arguments[0]):void 0,t=JE(e),n=function(e){this===cg&&RE(n,vg,e),OE(this,ig)&&OE(this[ig],t)&&(this[ig][t]=!1),yg(this,t,ME(1,e))};return IE&&Sg&&yg(cg,t,{configurable:!0,set:n}),Cg(t,e)},KE(dg=lg[og],"toString",(function(){return ag(this).tag})),KE(lg,"withoutSetter",(function(e){return Cg(JE(e),e)})),HE.f=Ig,GE.f=Rg,WE.f=wg,BE.f=bg,VE.f=FE.f=Ag,jE.f=Og,QE.f=function(e){return Cg(XE(e),e)},IE&&zE(dg,"description",{configurable:!0,get:function(){return ag(this).description}})),yE({global:!0,constructor:!0,wrap:!0,forced:!bE,sham:!bE},{Symbol:lg}),ng(xE(Tg),(function(e){ZE(e)})),yE({target:rg,stat:!0,forced:!bE},{useSetter:function(){Sg=!0},useSimple:function(){Sg=!1}}),yE({target:"Object",stat:!0,forced:!bE,sham:!IE},{create:function(e,t){return void 0===t?UE(e):wg(UE(e),t)},defineProperty:Rg,defineProperties:wg,getOwnPropertyDescriptor:bg}),yE({target:"Object",stat:!0,forced:!bE},{getOwnPropertyNames:Ag}),$E(),eg(lg,rg),YE[ig]=!0;var Ng=Te&&!!Symbol.for&&!!Symbol.keyFor,Dg=Nn,Pg=ce,kg=$e,Lg=Ei,Mg=qe,Ug=Ng,xg=Mg("string-to-symbol-registry"),Vg=Mg("symbol-to-string-registry");Dg({target:"Symbol",stat:!0,forced:!Ug},{for:function(e){var t=Lg(e);if(kg(xg,t))return xg[t];var n=Pg("Symbol")(t);return xg[t]=n,Vg[n]=t,n}});var Fg=Nn,jg=$e,Bg=Ie,Gg=Ae,Wg=Ng,Hg=qe("symbol-to-string-registry");Fg({target:"Symbol",stat:!0,forced:!Wg},{keyFor:function(e){if(!Bg(e))throw TypeError(Gg(e)+" is not a symbol");if(jg(Hg,e))return Hg[e]}});var Kg=C_,zg=O,qg=y,Yg=Ei,Jg=d([].push),Xg=Nn,Qg=ce,Zg=g,$g=L,ev=d,tv=r,nv=O,iv=Ie,rv=Xc,ov=function(e){if(zg(e))return e;if(Kg(e)){for(var t=e.length,n=[],i=0;i<t;i++){var r=e[i];"string"==typeof r?Jg(n,r):"number"!=typeof r&&"Number"!=qg(r)&&"String"!=qg(r)||Jg(n,Yg(r))}var o=n.length,s=!0;return function(e,t){if(s)return s=!1,t;if(Kg(this))return t;for(var i=0;i<o;i++)if(n[i]===e)return t}}},sv=Te,av=String,cv=Qg("JSON","stringify"),lv=ev(/./.exec),dv=ev("".charAt),uv=ev("".charCodeAt),hv=ev("".replace),pv=ev(1..toString),fv=/[\uD800-\uDFFF]/g,mv=/^[\uD800-\uDBFF]$/,_v=/^[\uDC00-\uDFFF]$/,Ev=!sv||tv((function(){var e=Qg("Symbol")();return"[null]"!=cv([e])||"{}"!=cv({a:e})||"{}"!=cv(Object(e))})),gv=tv((function(){return'"\\udf06\\ud834"'!==cv("\udf06\ud834")||'"\\udead"'!==cv("\udead")})),vv=function(e,t){var n=rv(arguments),i=ov(t);if(nv(i)||void 0!==e&&!iv(e))return n[1]=function(e,t){if(nv(i)&&(t=$g(i,this,av(e),t)),!iv(t))return t},Zg(cv,null,n)},Tv=function(e,t,n){var i=dv(n,t-1),r=dv(n,t+1);return lv(mv,e)&&!lv(_v,r)||lv(_v,e)&&!lv(mv,i)?"\\u"+pv(uv(e,0),16):e};cv&&Xg({target:"JSON",stat:!0,arity:3,forced:Ev||gv},{stringify:function(e,t,n){var i=rv(arguments),r=Zg(Ev?vv:cv,null,i);return gv&&"string"==typeof r?hv(r,fv,Tv):r}});var Sv=Br,yv=Xe;Nn({target:"Object",stat:!0,forced:!Te||r((function(){Sv.f(1)}))},{getOwnPropertySymbols:function(e){var t=Sv.f;return t?t(yv(e)):[]}}),cE("asyncIterator"),cE("hasInstance"),cE("isConcatSpreadable"),cE("iterator"),cE("match"),cE("matchAll"),cE("replace"),cE("search"),cE("species"),cE("split");var Cv=pE;cE("toPrimitive"),Cv();var Rv=ce,wv=Pa;cE("toStringTag"),wv(Rv("Symbol"),"Symbol"),cE("unscopables"),Pa(p.JSON,"JSON",!0);var Iv=ie.Symbol,bv=pt,Av=Zt.f,Ov=bv("metadata"),Nv=Function.prototype;void 0===Nv[Ov]&&Av(Nv,Ov,{value:null}),cE("dispose"),cE("metadata");var Dv=Iv;cE("asyncDispose");var Pv=d,kv=ce("Symbol"),Lv=kv.keyFor,Mv=Pv(kv.prototype.valueOf),Uv=kv.isRegisteredSymbol||function(e){try{return void 0!==Lv(Mv(e))}catch(e){return!1}};Nn({target:"Symbol",stat:!0},{isRegisteredSymbol:Uv});for(var xv=qe,Vv=ce,Fv=d,jv=Ie,Bv=pt,Gv=Vv("Symbol"),Wv=Gv.isWellKnownSymbol,Hv=Vv("Object","getOwnPropertyNames"),Kv=Fv(Gv.prototype.valueOf),zv=xv("wks"),qv=0,Yv=Hv(Gv),Jv=Yv.length;qv<Jv;qv++)try{var Xv=Yv[qv];jv(Gv[Xv])&&Bv(Xv)}catch(e){}var Qv=function(e){if(Wv&&Wv(e))return!0;try{for(var t=Kv(e),n=0,i=Hv(zv),r=i.length;n<r;n++)if(zv[i[n]]==t)return!0}catch(e){}return!1};Nn({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Qv}),cE("matcher"),cE("observable"),Nn({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:Uv}),Nn({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Qv}),cE("metadataKey"),cE("patternMatch"),cE("replaceAll");var Zv=i(Dv),$v=i(nE.f("iterator"));function eT(e){return eT="function"==typeof Zv&&"symbol"==typeof $v?function(e){return typeof e}:function(e){return e&&"function"==typeof Zv&&e.constructor===Zv&&e!==Zv.prototype?"symbol":typeof e},eT(e)}var tT=i(nE.f("toPrimitive"));function nT(e){var t=function(e,t){if("object"!==eT(e)||null===e)return e;var n=e[tT];if(void 0!==n){var i=n.call(e,t||"default");if("object"!==eT(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===eT(t)?t:String(t)}function iT(e,t,n){return(t=nT(t))in e?S_(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var rT=r,oT=pt("iterator"),sT=!rT((function(){var e=new URL("b?a=1&b=2&c=3","http://a"),t=e.searchParams,n=new URLSearchParams("a=1&a=2"),i="";return e.pathname="c%20d",t.forEach((function(e,n){t.delete("b"),i+=n+e})),n.delete("a",2),!e.toJSON||!n.has("a",1)||n.has("a",2)||!t.size&&!0||!t.sort||"http://a/c%20d?a=1&c=3"!==e.href||"3"!==t.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!t[oT]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://\u0442\u0435\u0441\u0442").host||"#%D0%B1"!==new URL("http://a#\u0431").hash||"a1c3"!==i||"x"!==new URL("http://x",void 0).host})),aT=pa,cT=Nn,lT=p,dT=L,uT=d,hT=D,pT=sT,fT=pa,mT=hc,_T=function(e,t,n){for(var i in t)n&&n.unsafe&&e[i]?e[i]=t[i]:aT(e,i,t[i],n);return e},ET=Pa,gT=Fa,vT=oa,TT=vc,ST=O,yT=$e,CT=Qt,RT=fi,wT=rn,IT=ne,bT=Ei,AT=Ro,OT=B,NT=ts,DT=Yo,PT=Zc,kT=Af,LT=pt("iterator"),MT="URLSearchParams",UT=MT+"Iterator",xT=vT.set,VT=vT.getterFor(MT),FT=vT.getterFor(UT),jT=Object.getOwnPropertyDescriptor,BT=function(e){if(!hT)return lT[e];var t=jT(lT,e);return t&&t.value},GT=BT("fetch"),WT=BT("Request"),HT=BT("Headers"),KT=WT&&WT.prototype,zT=HT&&HT.prototype,qT=lT.RegExp,YT=lT.TypeError,JT=lT.decodeURIComponent,XT=lT.encodeURIComponent,QT=uT("".charAt),ZT=uT([].join),$T=uT([].push),eS=uT("".replace),tS=uT([].shift),nS=uT([].splice),iS=uT("".split),rS=uT("".slice),oS=/\+/g,sS=Array(4),aS=function(e){return sS[e-1]||(sS[e-1]=qT("((?:%[\\da-f]{2}){"+e+"})","gi"))},cS=function(e){try{return JT(e)}catch(t){return e}},lS=function(e){var t=eS(e,oS," "),n=4;try{return JT(t)}catch(e){for(;n;)t=eS(t,aS(n--),cS);return t}},dS=/[!'()~]|%20/g,uS={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},hS=function(e){return uS[e]},pS=function(e){return eS(XT(e),dS,hS)},fS=gT((function(e,t){xT(this,{type:UT,iterator:NT(VT(e).entries),kind:t})}),"Iterator",(function(){var e=FT(this),t=e.kind,n=e.iterator.next(),i=n.value;return n.done||(n.value="keys"===t?i.key:"values"===t?i.value:[i.key,i.value]),n}),!0),mS=function(e){this.entries=[],this.url=null,void 0!==e&&(IT(e)?this.parseObject(e):this.parseQuery("string"==typeof e?"?"===QT(e,0)?rS(e,1):e:bT(e)))};mS.prototype={type:MT,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,n,i,r,o,s,a,c=DT(e);if(c)for(n=(t=NT(e,c)).next;!(i=dT(n,t)).done;){if(o=(r=NT(wT(i.value))).next,(s=dT(o,r)).done||(a=dT(o,r)).done||!dT(o,r).done)throw YT("Expected sequence with length 2");$T(this.entries,{key:bT(s.value),value:bT(a.value)})}else for(var l in e)yT(e,l)&&$T(this.entries,{key:l,value:bT(e[l])})},parseQuery:function(e){if(e)for(var t,n,i=iS(e,"&"),r=0;r<i.length;)(t=i[r++]).length&&(n=iS(t,"="),$T(this.entries,{key:lS(tS(n)),value:lS(ZT(n,"="))}))},serialize:function(){for(var e,t=this.entries,n=[],i=0;i<t.length;)e=t[i++],$T(n,pS(e.key)+"="+pS(e.value));return ZT(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var _S=function(){TT(this,ES);var e=xT(this,new mS(arguments.length>0?arguments[0]:void 0));hT||(this.size=e.entries.length)},ES=_S.prototype;if(_T(ES,{append:function(e,t){var n=VT(this);PT(arguments.length,2),$T(n.entries,{key:bT(e),value:bT(t)}),hT||this.length++,n.updateURL()},delete:function(e){for(var t=VT(this),n=PT(arguments.length,1),i=t.entries,r=bT(e),o=n<2?void 0:arguments[1],s=void 0===o?o:bT(o),a=0;a<i.length;){var c=i[a];if(c.key!==r||void 0!==s&&c.value!==s)a++;else if(nS(i,a,1),void 0!==s)break}hT||(this.size=i.length),t.updateURL()},get:function(e){var t=VT(this).entries;PT(arguments.length,1);for(var n=bT(e),i=0;i<t.length;i++)if(t[i].key===n)return t[i].value;return null},getAll:function(e){var t=VT(this).entries;PT(arguments.length,1);for(var n=bT(e),i=[],r=0;r<t.length;r++)t[r].key===n&&$T(i,t[r].value);return i},has:function(e){for(var t=VT(this).entries,n=PT(arguments.length,1),i=bT(e),r=n<2?void 0:arguments[1],o=void 0===r?r:bT(r),s=0;s<t.length;){var a=t[s++];if(a.key===i&&(void 0===o||a.value===o))return!0}return!1},set:function(e,t){var n=VT(this);PT(arguments.length,1);for(var i,r=n.entries,o=!1,s=bT(e),a=bT(t),c=0;c<r.length;c++)(i=r[c]).key===s&&(o?nS(r,c--,1):(o=!0,i.value=a));o||$T(r,{key:s,value:a}),hT||(this.size=r.length),n.updateURL()},sort:function(){var e=VT(this);kT(e.entries,(function(e,t){return e.key>t.key?1:-1})),e.updateURL()},forEach:function(e){for(var t,n=VT(this).entries,i=CT(e,arguments.length>1?arguments[1]:void 0),r=0;r<n.length;)i((t=n[r++]).value,t.key,this)},keys:function(){return new fS(this,"keys")},values:function(){return new fS(this,"values")},entries:function(){return new fS(this,"entries")}},{enumerable:!0}),fT(ES,LT,ES.entries,{name:"entries"}),fT(ES,"toString",(function(){return VT(this).serialize()}),{enumerable:!0}),hT&&mT(ES,"size",{get:function(){return VT(this).entries.length},configurable:!0,enumerable:!0}),ET(_S,MT),cT({global:!0,constructor:!0,forced:!pT},{URLSearchParams:_S}),!pT&&ST(HT)){var gS=uT(zT.has),vS=uT(zT.set),TS=function(e){if(IT(e)){var t,n=e.body;if(RT(n)===MT)return t=e.headers?new HT(e.headers):new HT,gS(t,"content-type")||vS(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),AT(e,{body:OT(0,bT(n)),headers:OT(0,t)})}return e};if(ST(GT)&&cT({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return GT(e,arguments.length>1?TS(arguments[1]):{})}}),ST(WT)){var SS=function(e){return TT(this,KT),new WT(e,arguments.length>1?TS(arguments[1]):{})};KT.constructor=SS,SS.prototype=KT,cT({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:SS})}}var yS={URLSearchParams:_S,getState:VT},CS=i(ie.URLSearchParams),RS={isBrowser:!0,classes:{URLSearchParams:void 0!==CS?CS:l_,FormData:"undefined"!=typeof FormData?FormData:null,Blob:"undefined"!=typeof Blob?Blob:null},protocols:["http","https","file","blob","url","data"]};const wS="undefined"!=typeof window&&"undefined"!=typeof document,IS=(bS="undefined"!=typeof navigator&&navigator.product,wS&&["ReactNative","NativeScript","NS"].indexOf(bS)<0);var bS;const AS="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts;function OS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function NS(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?OS(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):OS(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var DS=NS(NS({},Object.freeze({__proto__:null,hasBrowserEnv:wS,hasStandardBrowserEnv:IS,hasStandardBrowserWebWorkerEnv:AS})),RS),PS=rn,kS=L,LS=$e,MS=u,US=function(){var e=PS(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},xS=RegExp.prototype,VS=function(e){var t=e.flags;return void 0!==t||"flags"in xS||LS(e,"flags")||!MS(xS,e)?t:kS(US,e)},FS=yh.charAt,jS=L,BS=rn,GS=O,WS=y,HS=/./.exec,KS=TypeError,zS=Nn,qS=L,YS=w,JS=Fa,XS=nc,QS=X,ZS=Gn,$S=Ei,ey=rn,ty=q,ny=y,iy=ii,ry=VS,oy=Me,sy=r,ay=Jc,cy=function(e,t,n){return t+(n?FS(e,t).length:1)},ly=function(e,t){var n=e.exec;if(GS(n)){var i=jS(n,e,t);return null!==i&&BS(i),i}if("RegExp"===WS(e))return jS(HS,e,t);throw KS("RegExp#exec called on incompatible receiver")},dy=oa,uy=pt("matchAll"),hy="RegExp String",py=hy+" Iterator",fy=dy.set,my=dy.getterFor(py),_y=TypeError,Ey=YS("".indexOf),gy=YS("".matchAll),vy=!!gy&&!sy((function(){gy("a",/./)})),Ty=JS((function(e,t,n,i){fy(this,{type:py,regexp:e,string:t,global:n,unicode:i,done:!1})}),hy,(function(){var e=my(this);if(e.done)return XS(void 0,!0);var t=e.regexp,n=e.string,i=ly(t,n);return null===i?(e.done=!0,XS(void 0,!0)):e.global?(""===$S(i[0])&&(t.lastIndex=cy(n,ZS(t.lastIndex),e.unicode)),XS(i,!1)):(e.done=!0,XS(i,!1))})),Sy=function(e){var t,n,i,r=ey(this),o=$S(e),s=ay(r,RegExp),a=$S(ry(r));return t=new s(s===RegExp?r.source:r,a),n=!!~Ey(a,"g"),i=!!~Ey(a,"u"),t.lastIndex=ZS(r.lastIndex),new Ty(t,o,n,i)};zS({target:"String",proto:!0,forced:vy},{matchAll:function(e){var t,n,i,r,o=QS(this);if(ty(e)){if(vy)return gy(o,e)}else{if(iy(e)&&(t=$S(QS(ry(e))),!~Ey(t,"g")))throw _y("`.matchAll` does not allow non-global regexes");if(vy)return gy(o,e);if(void 0===(i=oy(e,uy))&&"RegExp"==ny(e)&&(i=Sy),i)return qS(i,e,o)}return n=$S(o),r=new RegExp(e,"g"),qS(Sy,r,n)}});var yy=Zn("String").matchAll,Cy=u,Ry=yy,wy=String.prototype,Iy=function(e){var t=e.matchAll;return"string"==typeof e||e===wy||Cy(wy,e)&&t===wy.matchAll?Ry:t},by=i(Iy);function Ay(e){function t(e,n,i,r){let o=e[r++];if("__proto__"===o)return!0;const s=Number.isFinite(+o),a=r>=e.length;return o=!o&&$m.isArray(i)?i.length:o,a?($m.hasOwnProp(i,o)?i[o]=[i[o],n]:i[o]=n,!s):(i[o]&&$m.isObject(i[o])||(i[o]=[]),t(e,n,i[o],r)&&$m.isArray(i[o])&&(i[o]=function(e){const t={},n=Object.keys(e);let i;const r=n.length;let o;for(i=0;i<r;i++)o=n[i],t[o]=e[o];return t}(i[o])),!s)}if($m.isFormData(e)&&$m.isFunction(e.entries)){const n={};return $m.forEachEntry(e,((e,i)=>{t(function(e){return by($m).call($m,/\w+|\[(\w*)]/g,e).map((e=>"[]"===e[0]?"":e[1]||e[0]))}(e),i,n,0)})),n}return null}const Oy={transitional:f_,adapter:["xhr","http"],transformRequest:[function(e,t){const n=t.getContentType()||"",i=n.indexOf("application/json")>-1,r=$m.isObject(e);if(r&&$m.isHTMLForm(e)&&(e=new FormData(e)),$m.isFormData(e))return i?JSON.stringify(Ay(e)):e;if($m.isArrayBuffer(e)||$m.isBuffer(e)||$m.isStream(e)||$m.isFile(e)||$m.isBlob(e))return e;if($m.isArrayBufferView(e))return e.buffer;if($m.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(r){if(n.indexOf("application/x-www-form-urlencoded")>-1)return function(e,t){return a_(e,new DS.classes.URLSearchParams,Object.assign({visitor:function(e,t,n,i){return DS.isNode&&$m.isBuffer(e)?(this.append(t,e.toString("base64")),!1):i.defaultVisitor.apply(this,arguments)}},t))}(e,this.formSerializer).toString();if((o=$m.isFileList(e))||n.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return a_(o?{"files[]":e}:e,t&&new t,this.formSerializer)}}return r||i?(t.setContentType("application/json",!1),function(e,t,n){if($m.isString(e))try{return(t||JSON.parse)(e),Bp($m).call($m,e)}catch(e){if("SyntaxError"!==e.name)throw e}return(n||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){const t=this.transitional||Oy.transitional,n=t&&t.forcedJSONParsing,i="json"===this.responseType;if(e&&$m.isString(e)&&(n&&!this.responseType||i)){const n=!(t&&t.silentJSONParsing)&&i;try{return JSON.parse(e)}catch(e){if(n){if("SyntaxError"===e.name)throw e_.from(e,e_.ERR_BAD_RESPONSE,this,null,this.response);throw e}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:DS.classes.FormData,Blob:DS.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};$m.forEach(["delete","get","head","post","put","patch"],(e=>{Oy.headers[e]={}}));var Ny=Oy;const Dy=$m.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),Py=Symbol("internals");function ky(e){var t;return e&&Bp(t=String(e)).call(t).toLowerCase()}function Ly(e){return!1===e||null==e?e:$m.isArray(e)?e.map(Ly):String(e)}function My(e,t,n,i,r){return $m.isFunction(i)?i.call(this,t,n):(r&&(t=n),$m.isString(t)?$m.isString(i)?-1!==t.indexOf(i):$m.isRegExp(i)?i.test(t):void 0:void 0)}class Uy{constructor(e){e&&this.set(e)}set(e,t,n){const i=this;function r(e,t,n){const r=ky(t);if(!r)throw new Error("header name must be a non-empty string");const o=$m.findKey(i,r);(!o||void 0===i[o]||!0===n||void 0===n&&!1!==i[o])&&(i[o||t]=Ly(e))}const o=(e,t)=>$m.forEach(e,((e,n)=>r(e,n,t)));var s;return $m.isPlainObject(e)||e instanceof this.constructor?o(e,t):$m.isString(e)&&(e=Bp(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(Bp(s=e).call(s))?o((e=>{const t={};let n,i,r;return e&&e.split("\n").forEach((function(e){var o,s;r=e.indexOf(":"),n=Bp(o=e.substring(0,r)).call(o).toLowerCase(),i=Bp(s=e.substring(r+1)).call(s),!n||t[n]&&Dy[n]||("set-cookie"===n?t[n]?t[n].push(i):t[n]=[i]:t[n]=t[n]?t[n]+", "+i:i)})),t})(e),t):null!=e&&r(t,e,n),this}get(e,t){if(e=ky(e)){const n=$m.findKey(this,e);if(n){const e=this[n];if(!t)return e;if(!0===t)return function(e){const t=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let i;for(;i=n.exec(e);)t[i[1]]=i[2];return t}(e);if($m.isFunction(t))return t.call(this,e,n);if($m.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=ky(e)){const n=$m.findKey(this,e);return!(!n||void 0===this[n]||t&&!My(0,this[n],n,t))}return!1}delete(e,t){const n=this;let i=!1;function r(e){if(e=ky(e)){const r=$m.findKey(n,e);!r||t&&!My(0,n[r],r,t)||(delete n[r],i=!0)}}return $m.isArray(e)?e.forEach(r):r(e),i}clear(e){const t=Object.keys(this);let n=t.length,i=!1;for(;n--;){const r=t[n];e&&!My(0,this[r],r,e,!0)||(delete this[r],i=!0)}return i}normalize(e){const t=this,n={};return $m.forEach(this,((i,r)=>{var o;const s=$m.findKey(n,r);if(s)return t[s]=Ly(i),void delete t[r];const a=e?function(e){return Bp(e).call(e).toLowerCase().replace(/([a-z\d])(\w*)/g,((e,t,n)=>t.toUpperCase()+n))}(r):Bp(o=String(r)).call(o);a!==r&&delete t[r],t[a]=Ly(i),n[a]=!0})),this}concat(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return this.constructor.concat(this,...t)}toJSON(e){const t=Object.create(null);return $m.forEach(this,((n,i)=>{null!=n&&!1!==n&&(t[i]=e&&$m.isArray(n)?n.join(", "):n)})),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((e=>{let[t,n]=e;return t+": "+n})).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){const t=new this(e);for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return i.forEach((e=>t.set(e))),t}static accessor(e){const t=(this[Py]=this[Py]={accessors:{}}).accessors,n=this.prototype;function i(e){const i=ky(e);t[i]||(function(e,t){const n=$m.toCamelCase(" "+t);["get","set","has"].forEach((i=>{Object.defineProperty(e,i+n,{value:function(e,n,r){return this[i].call(this,t,e,n,r)},configurable:!0})}))}(n,e),t[i]=!0)}return $m.isArray(e)?e.forEach(i):i(e),this}}Uy.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),$m.reduceDescriptors(Uy.prototype,((e,t)=>{let{value:n}=e,i=t[0].toUpperCase()+t.slice(1);return{get:()=>n,set(e){this[i]=e}}})),$m.freezeMethods(Uy);var xy=Uy;function Vy(e,t){const n=this||Ny,i=t||n,r=xy.from(i.headers);let o=i.data;return $m.forEach(e,(function(e){o=e.call(n,o,r.normalize(),t?t.status:void 0)})),r.normalize(),o}function Fy(e){return!(!e||!e.__CANCEL__)}function jy(e,t,n){e_.call(this,null==e?"canceled":e,e_.ERR_CANCELED,t,n),this.name="CanceledError"}$m.inherits(jy,e_,{__CANCEL__:!0});var By=DS.hasStandardBrowserEnv?{write(e,t,n,i,r,o){const s=[e+"="+encodeURIComponent(t)];$m.isNumber(n)&&s.push("expires="+new Date(n).toGMTString()),$m.isString(i)&&s.push("path="+i),$m.isString(r)&&s.push("domain="+r),!0===o&&s.push("secure"),document.cookie=s.join("; ")},read(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function Gy(e,t){return e&&!function(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}(t)?function(e,t){return t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e}(e,t):t}var Wy=DS.hasStandardBrowserEnv?function(){const e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a");let n;function i(n){let i=n;return e&&(t.setAttribute("href",i),i=t.href),t.setAttribute("href",i),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:"/"===t.pathname.charAt(0)?t.pathname:"/"+t.pathname}}return n=i(window.location.href),function(e){const t=$m.isString(e)?i(e):e;return t.protocol===n.protocol&&t.host===n.host}}():function(){return!0};function Hy(e,t){let n=0;const i=function(e,t){e=e||10;const n=new Array(e),i=new Array(e);let r,o=0,s=0;return t=void 0!==t?t:1e3,function(a){const c=Date.now(),l=i[s];r||(r=c),n[o]=a,i[o]=c;let d=s,u=0;for(;d!==o;)u+=n[d++],d%=e;if(o=(o+1)%e,o===s&&(s=(s+1)%e),c-r<t)return;const h=l&&c-l;return h?Math.round(1e3*u/h):void 0}}(50,250);return r=>{const o=r.loaded,s=r.lengthComputable?r.total:void 0,a=o-n,c=i(a);n=o;const l={loaded:o,total:s,progress:s?o/s:void 0,bytes:a,rate:c||void 0,estimated:c&&s&&o<=s?(s-o)/c:void 0,event:r};l[t?"download":"upload"]=!0,e(l)}}var Ky="undefined"!=typeof XMLHttpRequest&&function(e){return new Gh((function(t,n){let i=e.data;const r=xy.from(e.headers).normalize();let o,s,{responseType:a,withXSRFToken:c}=e;function l(){e.cancelToken&&e.cancelToken.unsubscribe(o),e.signal&&e.signal.removeEventListener("abort",o)}if($m.isFormData(i))if(DS.hasStandardBrowserEnv||DS.hasStandardBrowserWebWorkerEnv)r.setContentType(!1);else if(!1!==(s=r.getContentType())){const[e,...t]=s?s.split(";").map((e=>Bp(e).call(e))).filter(Boolean):[];r.setContentType([e||"multipart/form-data",...t].join("; "))}let d=new XMLHttpRequest;if(e.auth){const t=e.auth.username||"",n=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";r.set("Authorization","Basic "+btoa(t+":"+n))}const u=Gy(e.baseURL,e.url);function h(){if(!d)return;const i=xy.from("getAllResponseHeaders"in d&&d.getAllResponseHeaders());!function(e,t,n){const i=n.config.validateStatus;n.status&&i&&!i(n.status)?t(new e_("Request failed with status code "+n.status,[e_.ERR_BAD_REQUEST,e_.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):e(n)}((function(e){t(e),l()}),(function(e){n(e),l()}),{data:a&&"text"!==a&&"json"!==a?d.response:d.responseText,status:d.status,statusText:d.statusText,headers:i,config:e,request:d}),d=null}if(d.open(e.method.toUpperCase(),h_(u,e.params,e.paramsSerializer),!0),d.timeout=e.timeout,"onloadend"in d?d.onloadend=h:d.onreadystatechange=function(){d&&4===d.readyState&&(0!==d.status||d.responseURL&&0===d.responseURL.indexOf("file:"))&&setTimeout(h)},d.onabort=function(){d&&(n(new e_("Request aborted",e_.ECONNABORTED,e,d)),d=null)},d.onerror=function(){n(new e_("Network Error",e_.ERR_NETWORK,e,d)),d=null},d.ontimeout=function(){let t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded";const i=e.transitional||f_;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),n(new e_(t,i.clarifyTimeoutError?e_.ETIMEDOUT:e_.ECONNABORTED,e,d)),d=null},DS.hasStandardBrowserEnv&&(c&&$m.isFunction(c)&&(c=c(e)),c||!1!==c&&Wy(u))){const t=e.xsrfHeaderName&&e.xsrfCookieName&&By.read(e.xsrfCookieName);t&&r.set(e.xsrfHeaderName,t)}void 0===i&&r.setContentType(null),"setRequestHeader"in d&&$m.forEach(r.toJSON(),(function(e,t){d.setRequestHeader(t,e)})),$m.isUndefined(e.withCredentials)||(d.withCredentials=!!e.withCredentials),a&&"json"!==a&&(d.responseType=e.responseType),"function"==typeof e.onDownloadProgress&&d.addEventListener("progress",Hy(e.onDownloadProgress,!0)),"function"==typeof e.onUploadProgress&&d.upload&&d.upload.addEventListener("progress",Hy(e.onUploadProgress)),(e.cancelToken||e.signal)&&(o=t=>{d&&(n(!t||t.type?new jy(null,e,d):t),d.abort(),d=null)},e.cancelToken&&e.cancelToken.subscribe(o),e.signal&&(e.signal.aborted?o():e.signal.addEventListener("abort",o)));const p=function(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}(u);p&&-1===DS.protocols.indexOf(p)?n(new e_("Unsupported protocol "+p+":",e_.ERR_BAD_REQUEST,e)):d.send(i||null)}))};const zy={http:null,xhr:Ky};$m.forEach(zy,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(e){}Object.defineProperty(e,"adapterName",{value:t})}}));const qy=e=>"- ".concat(e),Yy=e=>$m.isFunction(e)||null===e||!1===e;var Jy={getAdapter:e=>{e=$m.isArray(e)?e:[e];const{length:t}=e;let n,i;const r={};for(let o=0;o<t;o++){let t;if(n=e[o],i=n,!Yy(n)&&(i=zy[(t=String(n)).toLowerCase()],void 0===i))throw new e_("Unknown adapter '".concat(t,"'"));if(i)break;r[t||"#"+o]=i}if(!i){const e=Object.entries(r).map((e=>{let[t,n]=e;return"adapter ".concat(t," ")+(!1===n?"is not supported by the environment":"is not available in the build")}));throw new e_("There is no suitable adapter to dispatch the request "+(t?e.length>1?"since :\n"+e.map(qy).join("\n"):" "+qy(e[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return i},adapters:zy};function Xy(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new jy(null,e)}function Qy(e){return Xy(e),e.headers=xy.from(e.headers),e.data=Vy.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1),Jy.getAdapter(e.adapter||Ny.adapter)(e).then((function(t){return Xy(e),t.data=Vy.call(e,e.transformResponse,t),t.headers=xy.from(t.headers),t}),(function(t){return Fy(t)||(Xy(e),t&&t.response&&(t.response.data=Vy.call(e,e.transformResponse,t.response),t.response.headers=xy.from(t.response.headers))),Gh.reject(t)}))}function Zy(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const $y=e=>e instanceof xy?function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Zy(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Zy(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},e):e;function eC(e,t){t=t||{};const n={};function i(e,t,n){return $m.isPlainObject(e)&&$m.isPlainObject(t)?$m.merge.call({caseless:n},e,t):$m.isPlainObject(t)?$m.merge({},t):$m.isArray(t)?t.slice():t}function r(e,t,n){return $m.isUndefined(t)?$m.isUndefined(e)?void 0:i(void 0,e,n):i(e,t,n)}function o(e,t){if(!$m.isUndefined(t))return i(void 0,t)}function s(e,t){return $m.isUndefined(t)?$m.isUndefined(e)?void 0:i(void 0,e):i(void 0,t)}function a(n,r,o){return o in t?i(n,r):o in e?i(void 0,n):void 0}const c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(e,t)=>r($y(e),$y(t),!0)};return $m.forEach(Object.keys(Object.assign({},e,t)),(function(i){const o=c[i]||r,s=o(e[i],t[i],i);$m.isUndefined(s)&&o!==a||(n[i]=s)})),n}const tC="1.6.8",nC={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{nC[e]=function(n){return typeof n===e||"a"+(t<1?"n ":" ")+e}}));const iC={};nC.transitional=function(e,t,n){function i(e,t){return"[Axios v"+tC+"] Transitional option '"+e+"'"+t+(n?". "+n:"")}return(n,r,o)=>{if(!1===e)throw new e_(i(r," has been removed"+(t?" in "+t:"")),e_.ERR_DEPRECATED);return t&&!iC[r]&&(iC[r]=!0,console.warn(i(r," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(n,r,o)}};var rC={assertOptions:function(e,t,n){if("object"!=typeof e)throw new e_("options must be an object",e_.ERR_BAD_OPTION_VALUE);const i=Object.keys(e);let r=i.length;for(;r-- >0;){const o=i[r],s=t[o];if(s){const t=e[o],n=void 0===t||s(t,o,e);if(!0!==n)throw new e_("option "+o+" must be "+n,e_.ERR_BAD_OPTION_VALUE)}else if(!0!==n)throw new e_("Unknown option "+o,e_.ERR_BAD_OPTION)}},validators:nC};const oC=rC.validators;let sC=class{constructor(e){this.defaults=e,this.interceptors={request:new p_,response:new p_}}async request(e,t){try{return await this._request(e,t)}catch(e){if(e instanceof Error){let t;Error.captureStackTrace?Error.captureStackTrace(t={}):t=new Error;const n=t.stack?t.stack.replace(/^.+\n/,""):"";e.stack?n&&!String(e.stack).endsWith(n.replace(/^.+\n.+\n/,""))&&(e.stack+="\n"+n):e.stack=n}throw e}}_request(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},t=eC(this.defaults,t);const{transitional:n,paramsSerializer:i,headers:r}=t;void 0!==n&&rC.assertOptions(n,{silentJSONParsing:oC.transitional(oC.boolean),forcedJSONParsing:oC.transitional(oC.boolean),clarifyTimeoutError:oC.transitional(oC.boolean)},!1),null!=i&&($m.isFunction(i)?t.paramsSerializer={serialize:i}:rC.assertOptions(i,{encode:oC.function,serialize:oC.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let o=r&&$m.merge(r.common,r[t.method]);r&&$m.forEach(["delete","get","head","post","put","patch","common"],(e=>{delete r[e]})),t.headers=xy.concat(o,r);const s=[];let a=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(a=a&&e.synchronous,s.unshift(e.fulfilled,e.rejected))}));const c=[];let l;this.interceptors.response.forEach((function(e){c.push(e.fulfilled,e.rejected)}));let d,u=0;if(!a){const e=[Qy.bind(this),void 0];for(e.unshift.apply(e,s),e.push.apply(e,c),d=e.length,l=Gh.resolve(t);u<d;)l=l.then(e[u++],e[u++]);return l}d=s.length;let h=t;for(u=0;u<d;){const t=s[u++],n=s[u++];try{h=t(h)}catch(e){n.call(this,e);break}}try{l=Qy.call(this,h)}catch(e){return Gh.reject(e)}for(u=0,d=c.length;u<d;)l=l.then(c[u++],c[u++]);return l}getUri(e){return h_(Gy((e=eC(this.defaults,e)).baseURL,e.url),e.params,e.paramsSerializer)}};$m.forEach(["delete","get","head","options"],(function(e){sC.prototype[e]=function(t,n){return this.request(eC(n||{},{method:e,url:t,data:(n||{}).data}))}})),$m.forEach(["post","put","patch"],(function(e){function t(t){return function(n,i,r){return this.request(eC(r||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:n,data:i}))}}sC.prototype[e]=t(),sC.prototype[e+"Form"]=t(!0)}));var aC=sC;class cC{constructor(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Gh((function(e){t=e}));const n=this;this.promise.then((e=>{if(!n._listeners)return;let t=n._listeners.length;for(;t-- >0;)n._listeners[t](e);n._listeners=null})),this.promise.then=e=>{let t;const i=new Gh((e=>{n.subscribe(e),t=e})).then(e);return i.cancel=function(){n.unsubscribe(t)},i},e((function(e,i,r){n.reason||(n.reason=new jy(e,i,r),t(n.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}static source(){let e;return{token:new cC((function(t){e=t})),cancel:e}}}var lC=cC;const dC={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(dC).forEach((e=>{let[t,n]=e;dC[n]=t}));var uC=dC;const hC=function e(t){const n=new aC(t),i=vm(aC.prototype.request,n);return $m.extend(i,aC.prototype,n,{allOwnKeys:!0}),$m.extend(i,n,null,{allOwnKeys:!0}),i.create=function(n){return e(eC(t,n))},i}(Ny);hC.Axios=aC,hC.CanceledError=jy,hC.CancelToken=lC,hC.isCancel=Fy,hC.VERSION=tC,hC.toFormData=a_,hC.AxiosError=e_,hC.Cancel=hC.CanceledError,hC.all=function(e){return Gh.all(e)},hC.spread=function(e){return function(t){return e.apply(null,t)}},hC.isAxiosError=function(e){return $m.isObject(e)&&!0===e.isAxiosError},hC.mergeConfig=eC,hC.AxiosHeaders=xy,hC.formToJSON=e=>Ay($m.isHTMLForm(e)?new FormData(e):e),hC.getAdapter=Jy.getAdapter,hC.HttpStatusCode=uC,hC.default=hC;var pC=hC;const fC=()=>{};function mC(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:fC};return e.promise=new Gh(((t,n)=>{e.resolve=n=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(n),e.value=n)},e.reject=t=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,n(t))}})),e}const _C=new Map,EC=new Map,gC=new Map;let vC=function(e){return e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot",e}({}),TC=function(e){return e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger",e}({});const SC=new cm;let yC=SC.getResult(),CC=null;function RC(e){if(!CC){e&&SC.setUA(e),yC=SC.getResult();const t=function(e){if("Blink"===e.engine.name&&"WeChat"!==e.browser.name)return TC.CHROME;switch(e.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return TC.CHROME;case"Safari":case"Mobile Safari":return TC.SAFARI;case"Edge":return TC.EDGE;case"Firefox":return TC.FIREFOX;case"QQ":case"QQBrowser":return TC.QQ;case"Opera":return TC.OPERA;case"WeChat":return TC.WECHAT;default:return e.browser.name||""}}(yC),n=wC(yC),i=function(e){return"Windows"===e.os.name?e.os.version?e.os.name+" "+e.os.version:e.os.name:e.os.name||""}(yC),r=yC.os.version,o=wC(yC,!1),s=yC.device.type;if(!(t&&n&&i&&r))return{name:t,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s};CC={name:t,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s}}return CC}function wC(e){let t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return t="Blink"===e.engine.name?e.engine.version||"":e.browser.version||"",n?t.split(".")[0]:t}function IC(){return RC().os}function bC(){const e=RC();return"".concat(e.os," ").concat(e.osVersion)}function AC(){const e=RC();return!!("WebKit"===yC.engine.name&&e.os===vC.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==TC.SAFARI||kC()&&e.name!==TC.SAFARI)}function OC(){return RC().name===TC.CHROME}function NC(){return RC().name===TC.SAFARI}function DC(){return RC().name===TC.EDGE}function PC(){return RC().name===TC.FIREFOX}function kC(){return RC().os===vC.IOS}function LC(e){const t=RC();return!(t.name!==TC.CHROME||!t.osVersion)&&Number(t.version)>=e}function MC(e){const t=RC();return!(t.name!==TC.EDGE||!t.osVersion)&&Number(t.version)>=e}function UC(e){const t=RC();return!(t.name!==TC.SAFARI||!t.osVersion)&&Number(t.version)>=e}function xC(e,t,n){const i=RC();if(i.os!==vC.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function VC(e,t,n){const i=RC();if(i.name!==TC.SAFARI||!i.osVersion||!i.browserVersion)return!1;const r=i.browserVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function FC(e){const t=RC();return!(t.name!==TC.OPERA||!t.osVersion)&&Number(t.version)>=e}function jC(){const e=RC();return!(e.name!==TC.CHROME||!e.osVersion)&&Number(e.version)<=90}function BC(){const e=RC();if(e.os!==vC.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||14===Number(t[0])&&Number(t[1])<=6}function GC(){const e=RC();if(e.os!==vC.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])}function WC(){const e=RC();if(e.os!==vC.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 16===Number(t[0])}function HC(){const e=RC();if(e.os!==vC.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])&&Number(t[1])>=1}function KC(){return NC()&&navigator.maxTouchPoints>0}function zC(){return RC().name===TC.WECHAT}function qC(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function YC(){const e=IC();return function(){const{deviceType:e}=RC();return"mobile"===e||"tablet"===e}()||e===vC.ANDROID||e===vC.IOS||e===vC.HARMONY_OS}function JC(){const e=RC();return e.name!==TC.EDGE&&e.name!==TC.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function XC(){return IC()===vC.ANDROID}function QC(){const e=RC();return XC()&&(e.name===TC.CHROME||e.name===TC.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function ZC(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function $C(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ZC(Object(n),!0).forEach((function(t){eR(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ZC(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function eR(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let tR=function(e){return e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",e}({});class nR extends Error{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(t),eR(this,"code",void 0),eR(this,"message",void 0),eR(this,"data",void 0),eR(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=n}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),"\n").concat(this.stack):"".concat(this.stack)}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return"error"===e&&(t||console).error(this.toString()),"warning"===e&&(t||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}}function iR(e,t){if("boolean"!=typeof e)throw new nR(tR.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function rR(e,t,n){if(!Pi(n).call(n,e))throw new nR(tR.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(n)))}function oR(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4;if(e<n||e>i||(!(arguments.length>4&&void 0!==arguments[4])||arguments[4])&&!function(e){return"number"==typeof e&&e%1==0}(e))throw new nR(tR.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(n,", ").concat(i,"]. integer only"))}function sR(e,t){if("number"!=typeof e){if(!(e.min||e.max||e.ideal||e.exact))throw new nR(tR.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));void 0!==e.min&&oR(e.min,"".concat(t,".min"),0,1/0),void 0!==e.max&&oR(e.max,"".concat(t,".max"),1,1/0),void 0!==e.exact&&oR(e.exact,"".concat(t,".exact"),1,1/0),void 0!==e.ideal&&oR(e.ideal,"".concat(t,".ideal"),1,1/0)}else oR(e,t,1,1/0)}function aR(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(null==e)throw new nR(tR.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!dR(e,n,i,r))throw new nR(tR.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(n,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function cR(e,t){if(!Array.isArray(e))throw new nR(tR.INVALID_PARAMS,"".concat(t," should be an array"))}function lR(e){return null==e}function dR(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:255,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return"string"==typeof e&&e.length<=n&&e.length>=t&&(!i||function(e){if("string"!=typeof e)return!1;for(let t=0;t<e.length;t+=1){const n=e.charCodeAt(t);if(n<0||n>255)return!1}return!0}(e))}function uR(e,t,n){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,n);const i=e.getUint32(t,n),r=e.getUint32(t+4,n),o=Number(!!n),s=Number(!n);return BigInt(i*s+r*o)<<BigInt(32)|BigInt(i*o+r*s)}function hR(e,t,n,i){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,n,i);const r=Number(n>>BigInt(32)),o=Number(n&BigInt(4294967295));i?(e.setUint32(t+4,r,i),e.setUint32(t,o,i)):(e.setUint32(t,r,i),e.setUint32(t+4,o,i))}var pR=function(e){return e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE",e}(pR||{}),fR=function(e){return e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",e}(fR||{});const mR=new class{constructor(){eR(this,"_clientSize",null),eR(this,"getClientWidth",(()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth)),eR(this,"getClientHeight",(()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight)),eR(this,"getStyle",(e=>window.getComputedStyle(e,null))),eR(this,"checkCssVisibleProperty",(e=>{var t;let n=!0;const i=this.getStyle(e),{display:r,visibility:o,opacity:s,filter:a}=i;return("none"===r||Pi(t=["hidden","collapse"]).call(t,o)||Number(s)<.1)&&(n=!1),!!n&&(a&&a.split(" ").filter((e=>{var t;const n=e.split("(")[0];return Pi(t=["brightness","blur","opacity"]).call(t,n)})).map((e=>{const[t,n]=e.split(/\(|\)/);return[t,Number(n.match(/^[0-9\.]+/))]})).forEach((e=>{const[t,i]=e;switch(t){case"brightness":(i<.1||i>3)&&(n=!1);break;case"blur":i>3&&(n=!1);break;case"opacity":i<.1&&(n=!1)}})),n)})),eR(this,"checkPropertyUpToAllParentNodes",((e,t)=>{let n=!0,i=!0;const r=e=>t(e);let o=e;for(;o&&i;)r(o)||(n=!1,i=!1),o=o.parentElement,o||(i=!1);return n})),eR(this,"checkActualCssVisibleIncludeInherit",(e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty))),eR(this,"getSizeAboutClient",(e=>{const{width:t,height:n,left:i,right:r,top:o,bottom:s}=e.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:t,height:n,left:i,right:r,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}})),eR(this,"checkActualSize",(()=>{const{width:e,height:t,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(e,t,n)})),eR(this,"elementFromPoint",((e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null)),eR(this,"checkCoverForAPoint",((e,t,n)=>{const i=this.elementFromPoint(e,t);return null!==i&&i!==n})),eR(this,"getPointPositionList",(()=>{const{width:e,height:t,left:n,top:i}=this._clientSize,r=e/6,o=t/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let e=0;e<5;e++){const t=(n*a+(0===c?.1:4===c?(r*c*a-1e5)/a:r*c)*a)/a,l=(i*a+(0===e?.1:4===e?(o*e*a-1e5)/a:o*e)*a)/a;s.push({x:t,y:l})}return[...s]})),eR(this,"checkElementCover",(e=>this.getPointPositionList().map((t=>this.checkCoverForAPoint(t.x,t.y,e))).filter((e=>!!e)).length>6)),eR(this,"checkSizeIsVisible",((e,t,n)=>(e>50||n/e<=10)&&(t>50||n/t<=10))),eR(this,"checkSizeOfPartInClient",(()=>{const{left:e,right:t,top:n,bottom:i,clientHeight:r,clientWidth:o,clientMin:s}=this._clientSize;let a,c,l,d;if(e<0)a=0;else{if(!(e<o))return!1;a=e}if(t<0)return!1;if(c=t<o?t:o,n<0)l=0;else{if(!(n<r))return!1;l=n}if(i<0)return!1;d=i<r?i:r;const u=c-a,h=d-l;return this.checkSizeIsVisible(u,h,s)})),eR(this,"returnHiddenResult",(e=>(this._clientSize=null,{visible:!1,reason:e}))),eR(this,"checkOneElementVisible",(e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(pR.COVERED);{const e=this.checkActualSize(),t=this.checkSizeOfPartInClient();return e&&!t?this.returnHiddenResult(pR.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(pR.SIZE)}}return this.returnHiddenResult(pR.STYLE)}return this.returnHiddenResult(fR.UNMOUNTED)}return this.returnHiddenResult(fR.INVALID_HTML_ELEMENT)})),eR(this,"checkElementIsMountedOnDom",(e=>this.checkPropertyUpToAllParentNodes(e,(e=>"HTML"!==e.nodeName.toUpperCase()?null!==e.parentElement:!!document.documentElement))))}};function _R(e){return(new TextEncoder).encode(e)}const ER=function(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n},gR=async e=>function(e,t){let n="";return new Uint8Array(e).forEach((e=>{n+=e.toString(t).padStart(2,"0")})),n}(await crypto.subtle.digest("SHA-256",_R(e)),16);let vR=class{constructor(){eR(this,"_events",{}),eR(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map((e=>e.listener)):[]}on(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];-1===this._indexOfListener(n,t)&&n.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];-1===this._indexOfListener(n,t)&&n.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;const n=this._events[e],i=this._indexOfListener(n,t);-1!==i&&n.splice(i,1),0===this._events[e].length&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const t=this._events[e].map((e=>e));for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(let o=0;o<t.length;o+=1){const n=t[o];n.once&&this.off(e,n.listener),n.listener.apply(this,i||[])}}safeEmit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];[...this._events[e]||[]].forEach((t=>{t.once&&this.off(e,t.listener);try{t.listener.apply(this,n)}catch(t){console.error("safeEmit event:".concat(e," error ").concat(null==t?void 0:t.toString()))}}))}_indexOfListener(e,t){let n=e.length;for(;n--;)if(e[n].listener===t)return n;return-1}},TR=null;function SR(){if(TR)return TR;if(window.electron)return TR=window.electron;if(!window.require)return null;try{return TR=window.require("electron"),TR}catch(e){return null}}let yR=function(e){return e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.PRELOAD="PRELOAD",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.DATACHANNEL_FAILBACK="Client._datachannelFailback",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload",e}({}),CR=function(e){return e.TRACER="tracer",e}({});function RR(e){return oR(e.timeout,"config.timeout",0,1e5),oR(e.timeoutFactor,"config.timeoutFactor",0,100,!1),oR(e.maxRetryCount,"config.maxRetryConfig",0,1/0),oR(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let wR=function(e){return e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",e}({}),IR=function(e){return e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.FALLBACK="FALLBACK",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e}({});function bR(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach((e=>{if(!e.urls)throw Error()}))}catch(e){return!1}return!0}function AR(e){return aR(e.turnServerURL,"turnServerURL"),aR(e.username,"username"),aR(e.password,"password"),e.udpport&&oR(e.udpport,"udpport",1,99999,!0),e.forceturn&&iR(e.forceturn,"forceturn"),e.security&&iR(e.security,"security"),e.tcpport&&oR(e.tcpport,"tcpport",1,99999,!0),!0}function OR(e){return void 0!==e.level&&rR(e.level,"level",[1,2,3]),void 0!==e.delay&&oR(e.delay,"delay",0,3e3,!0),!0}let NR=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.INJECT_STREAM_STATUS="stream-inject-status",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",e}({}),DR=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),PR=function(e){return e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({}),kR=function(e){return e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({});function LR(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return 0===e.getListeners(t).length?Gh.reject(new nR(tR.UNEXPECTED_ERROR,"can not emit promise")):new Gh(((n,r)=>{e.emit(t,...i,n,r)}))}function MR(e,t){if(0===e.getListeners(t).length)return Gh.resolve();for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return LR(e,t,...i)}function UR(e,t){if(0===e.getListeners(t).length)return null;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return xR(e,t,...i)}function xR(e,t){let n=null,i=null;for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];if(e.emit(t,...o,(e=>{n=e}),(e=>{i=e})),null!==i)throw i;if(null===n)throw new nR(tR.UNEXPECTED_ERROR,"handler is not sync");return n}const VR=new class extends vR{set networkState(e){this.emit(kR.NETWORK_STATE_CHANGE,e,this._networkState),e===PR.ONLINE?this.emit(kR.ONLINE):e===PR.OFFLINE&&(this.onlineWaiter=new Gh((e=>{this.once(kR.ONLINE,(()=>{this.onlineWaiter=void 0,e(PR.ONLINE)}))})),this.emit(kR.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===PR.ONLINE}constructor(){super(),eR(this,"_moduleName","network-indicator"),eR(this,"_networkState",PR.ONLINE),eR(this,"onlineWaiter",void 0),window.addEventListener("online",(()=>{this.networkState=PR.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=PR.OFFLINE}))}};function FR(e,t){const n=e.indexOf(t);-1!==n&&e.splice(n,1)}function jR(e){const t=[];return e.forEach((e=>{-1===t.indexOf(e)&&t.push(e)})),t}function BR(e){void 0!==Gh?Gh.resolve().then(e):setTimeout(e,0)}function GR(e){return JSON.parse(JSON.stringify(e))}function WR(e){try{return GR(e)}catch(t){return e}}const HR={};function KR(e,t){HR[t]||(HR[t]=!0,e())}function zR(e){const t=window.atob(e),n=new Uint8Array(new ArrayBuffer(t.length));for(let i=0;i<t.length;i+=1)n[i]=t.charCodeAt(i);return n}function qR(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return window.btoa(t)}function YR(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,n=(new TextEncoder).encode(e);if(n.length>t)n=n.slice(0,t);else if(n.length<t){const e=new Uint8Array(t);e.set(n),n=e}return n}function JR(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=Xi(t).call(t,((e,t)=>e+t.length),0),r=new Uint8Array(new ArrayBuffer(i));let o=0;return t.forEach((e=>{r.set(e,o),o+=e.length})),r}function XR(e){return window.TextEncoder?(new TextEncoder).encode(e).length:e.length}function QR(e){let t=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&e.realFormData&&(e=e.realFormData),e.forEach((e=>{t+="string"==typeof e?XR(e):e.size})),t+138}function ZR(e){const t=new nR(tR.TIMEOUT,"timeout");return new Gh(((n,i)=>{window.setTimeout((()=>i(t)),e)}))}function $R(e){return new Gh((t=>{window.setTimeout(t,e)}))}function ew(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,e).toLowerCase();return n.length===e?"".concat(t).concat(n):"".concat(t).concat(n)+ew(e-n.length,"")}function tw(){return ew(32,"").toUpperCase()}const nw=()=>{},iw=new class{constructor(){eR(this,"fnMap",new Map)}throttleByKey(e,t,n,i){for(var r=arguments.length,o=new Array(r>4?r-4:0),s=4;s<r;s++)o[s-4]=arguments[s];if(this.fnMap.has(t)){const r=this.fnMap.get(t);if(r.threshold!==n){r.fn(...r.args),clearTimeout(r.timer);const s=window.setTimeout((()=>{const e=this.fnMap.get(t);e&&e.fn(...e.args),this.fnMap.delete(t)}),n);this.fnMap.set(t,{fn:e,threshold:n,timer:s,args:o,skipFn:i})}else r.skipFn&&r.skipFn(...r.args),this.fnMap.set(t,$C($C({},r),{},{fn:e,args:o,skipFn:i}))}else{const r=window.setTimeout((()=>{const e=this.fnMap.get(t);e&&e.fn(...e.args),this.fnMap.delete(t)}),n);this.fnMap.set(t,{fn:e,threshold:n,timer:r,args:o,skipFn:i})}}},rw=iw.throttleByKey.bind(iw);function ow(e){return"object"==typeof e&&null!==e&&!(e instanceof RegExp)}function sw(e,t){if(!ow(e)||!ow(t))return t;if(Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){const n=[...e];for(let i=0;i<t.length;i++)n[i]=sw(e[i],t[i]);return n}{const n=$C({},e);for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(Object.prototype.hasOwnProperty.call(e,i)?n[i]=sw(e[i],t[i]):n[i]=t[i]);return n}}function aw(e,t){let n=[0];if(t&&(n=new Array(t).fill(0)),0===e)return n;let i=0;for(;e>0&&(n[i]=255&e,e>>=8,i++,!t||i!==t););return n}function cw(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function lw(e){const t="0123456789abcdef";function n(e){let n,i="";for(n=0;n<=3;n++)i+=t.charAt(e>>8*n+4&15)+t.charAt(e>>8*n&15);return i}function i(e,t){const n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function r(e,t,n,r,o,s){return i(function(e,t){return e<<t|e>>>32-t}(i(i(t,e),i(r,s)),o),n)}function o(e,t,n,i,o,s,a){return r(t&n|~t&i,e,t,o,s,a)}function s(e,t,n,i,o,s,a){return r(t&i|n&~i,e,t,o,s,a)}function a(e,t,n,i,o,s,a){return r(t^n^i,e,t,o,s,a)}function c(e,t,n,i,o,s,a){return r(n^(t|~i),e,t,o,s,a)}const l=function(e){let t;const n=1+(e.length+8>>6),i=new Array(16*n);for(t=0;t<16*n;t++)i[t]=0;for(t=0;t<e.length;t++)i[t>>2]|=e.charCodeAt(t)<<t%4*8;return i[t>>2]|=128<<t%4*8,i[16*n-2]=8*e.length,i}(e);let d,u,h,p,f,m=1732584193,_=-271733879,E=-1732584194,g=271733878;for(d=0;d<l.length;d+=16)u=m,h=_,p=E,f=g,m=o(m,_,E,g,l[d+0],7,-680876936),g=o(g,m,_,E,l[d+1],12,-389564586),E=o(E,g,m,_,l[d+2],17,606105819),_=o(_,E,g,m,l[d+3],22,-1044525330),m=o(m,_,E,g,l[d+4],7,-176418897),g=o(g,m,_,E,l[d+5],12,1200080426),E=o(E,g,m,_,l[d+6],17,-1473231341),_=o(_,E,g,m,l[d+7],22,-45705983),m=o(m,_,E,g,l[d+8],7,1770035416),g=o(g,m,_,E,l[d+9],12,-1958414417),E=o(E,g,m,_,l[d+10],17,-42063),_=o(_,E,g,m,l[d+11],22,-1990404162),m=o(m,_,E,g,l[d+12],7,1804603682),g=o(g,m,_,E,l[d+13],12,-40341101),E=o(E,g,m,_,l[d+14],17,-1502002290),_=o(_,E,g,m,l[d+15],22,1236535329),m=s(m,_,E,g,l[d+1],5,-165796510),g=s(g,m,_,E,l[d+6],9,-1069501632),E=s(E,g,m,_,l[d+11],14,643717713),_=s(_,E,g,m,l[d+0],20,-373897302),m=s(m,_,E,g,l[d+5],5,-701558691),g=s(g,m,_,E,l[d+10],9,38016083),E=s(E,g,m,_,l[d+15],14,-660478335),_=s(_,E,g,m,l[d+4],20,-405537848),m=s(m,_,E,g,l[d+9],5,568446438),g=s(g,m,_,E,l[d+14],9,-1019803690),E=s(E,g,m,_,l[d+3],14,-187363961),_=s(_,E,g,m,l[d+8],20,1163531501),m=s(m,_,E,g,l[d+13],5,-1444681467),g=s(g,m,_,E,l[d+2],9,-51403784),E=s(E,g,m,_,l[d+7],14,1735328473),_=s(_,E,g,m,l[d+12],20,-1926607734),m=a(m,_,E,g,l[d+5],4,-378558),g=a(g,m,_,E,l[d+8],11,-2022574463),E=a(E,g,m,_,l[d+11],16,1839030562),_=a(_,E,g,m,l[d+14],23,-35309556),m=a(m,_,E,g,l[d+1],4,-1530992060),g=a(g,m,_,E,l[d+4],11,1272893353),E=a(E,g,m,_,l[d+7],16,-155497632),_=a(_,E,g,m,l[d+10],23,-1094730640),m=a(m,_,E,g,l[d+13],4,681279174),g=a(g,m,_,E,l[d+0],11,-358537222),E=a(E,g,m,_,l[d+3],16,-722521979),_=a(_,E,g,m,l[d+6],23,76029189),m=a(m,_,E,g,l[d+9],4,-640364487),g=a(g,m,_,E,l[d+12],11,-421815835),E=a(E,g,m,_,l[d+15],16,530742520),_=a(_,E,g,m,l[d+2],23,-995338651),m=c(m,_,E,g,l[d+0],6,-198630844),g=c(g,m,_,E,l[d+7],10,1126891415),E=c(E,g,m,_,l[d+14],15,-1416354905),_=c(_,E,g,m,l[d+5],21,-57434055),m=c(m,_,E,g,l[d+12],6,1700485571),g=c(g,m,_,E,l[d+3],10,-1894986606),E=c(E,g,m,_,l[d+10],15,-1051523),_=c(_,E,g,m,l[d+1],21,-2054922799),m=c(m,_,E,g,l[d+8],6,1873313359),g=c(g,m,_,E,l[d+15],10,-30611744),E=c(E,g,m,_,l[d+6],15,-1560198380),_=c(_,E,g,m,l[d+13],21,1309151649),m=c(m,_,E,g,l[d+4],6,-145523070),g=c(g,m,_,E,l[d+11],10,-1120210379),E=c(E,g,m,_,l[d+2],15,718787259),_=c(_,E,g,m,l[d+9],21,-343485551),m=i(m,u),_=i(_,h),E=i(E,p),g=i(g,f);return n(m)+n(_)+n(E)+n(g)}let dw=1,uw=console,hw=class{static setLogger(e){uw=e}constructor(e){eR(this,"lockingPromise",Gh.resolve()),eR(this,"locks",0),eR(this,"name",""),eR(this,"lockId",void 0),this.lockId=dw++,e&&(this.name=e),uw.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,uw.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat("string"==typeof e?e:""));const n=new Gh((n=>{t=()=>{this.locks-=1,uw.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat("string"==typeof e?e:"")),n()}})),i=this.lockingPromise.then((()=>t));return this.lockingPromise=this.lockingPromise.then((()=>n)),i}};function pw(e,t){return function(n,i,r){const o=r.value;if("function"!=typeof o)throw new Error("Cannot use mutex on object property.");return r.value=async function(){const n=this[t];if(!n)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const r=await n.lock("From ".concat(e,".").concat(i));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await o.apply(this,a)}finally{r()}},r}}const fw={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function mw(e,t){const n=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,n)}function _w(e,t,n,i){const r=Object.assign({},fw,i);let o=r.timeout;const s=async()=>{await function(e){return new Gh((t=>{window.setTimeout(t,e)}))}(o),o*=r.timeoutFactor,o=Math.min(r.maxRetryTimeout,o)};let a=!1;const c=new Gh((async(i,o)=>{t=t||(()=>!1),n=n||(()=>!0);for(let c=0;c<r.maxRetryCount;c+=1){if(a)return o(new nR(tR.OPERATION_ABORTED));try{const n=await e();if(!t(n,c))return i(n);if(c+1===r.maxRetryCount)return i(n);await s()}catch(e){if(!n(e,c))return o(e);if(c+1===r.maxRetryCount)return o(e);await s()}}}));return c.cancel=()=>a=!0,c}class Ew{constructor(e){eR(this,"input",[]),eR(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return 0===this.input.length?0:Xi(e=this.input).call(e,((e,t)=>e+t))/this.input.length}}let gw,vw=0,Tw=0;function Sw(e,t,n,i){return new Gh(((r,o)=>{t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),vw+=XR(t.data)):n&&(t.data.size?vw+=t.data.size:t.data instanceof FormData?vw+=QR(t.data):vw+=XR(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,pC.request(t).then((e=>{"string"==typeof e.data?Tw+=XR(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?Tw+=e.data.byteLength:Tw+=XR(JSON.stringify(e.data)),i&&r({data:e.data,headers:e.headers}),r(e.data)})).catch((e=>{pC.isCancel(e)?o(new nR(tR.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?o(new nR(tR.NETWORK_TIMEOUT,e.message)):e.response?o(new nR(tR.NETWORK_RESPONSE_ERROR,e.response.status)):o(new nR(tR.NETWORK_ERROR,e.message))}))}))}async function yw(e,t){const n=new Blob([t.data],{type:"buffer"});return await Sw(e,$C($C({},t),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}const Cw=()=>void 0!==window.isSecureContext,Rw=function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(t&&t[1]&&t[2]){const e=t[1],n=t[2];return"".concat(e,".").concat(n)}const n=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(n&&n[1]&&n[2]){const e=n[1],t=n[2];return"".concat(e,".").concat(100*(Number(t)+1))}return"4.0.0.999"}("4.21.0"),ww=function(){try{return!0===JSON.parse("true")}catch(e){return!0}}();let Iw=function(e){return e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn",e}({});const bw={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},Aw="v4.21.0-0-g16fdae2c-dirty(6/3/2024, 2:55:18 PM)",Ow={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!0,USE_SUB_RTX:!0,USE_XR:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:void 0,ENABLE_CC_FALLBACK:void 0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:bw,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,CUSTOM_ADAPTATION_DEFAULT_MODE:"",ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,ENABLE_PRELOAD:!0};function Nw(e,t,n){var i,r,o;Pi(i=Object.keys(Ow)).call(i,e)&&(!n&&Pi(r=Object.keys(Pw)).call(r,e)||(Ow[e]=t,"ENABLE_VIDEO_SEI"===e&&!0===t&&(Ow.ENABLE_ENCODED_TRANSFORM=!0),"USE_NEW_NETWORK_CONFIG"===e&&t&&(o=!!t,Ow.USE_NEW_NETWORK_CONFIG=o,o&&(Ow.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],Ow.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],Ow.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],Ow.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],Ow.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",Ow.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",Ow.GATEWAY_DOMAINS=["edge.sd-rtn.com"]))))}function Dw(e){return Ow[e]}const Pw={};var kw=function(e){return e.SET_SESSION_ID="SET_SESSION_ID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.AVOID_JOIN_START="AVOID_JOIN_START",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",e}(kw||{});class Lw{constructor(e,t,n,i){eR(this,"state",void 0),this.state={codec:e,audioCodec:t,mode:n,clientId:i,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:Iw.Default}}dispatch(e){this.state=function(e,t){switch(t.type){case kw.SET_SESSION_ID:return $C($C({},e),{},{sessionId:t.sessionId});case kw.SET_P2P_ID:return $C($C({},e),{},{p2pId:t.p2pId});case kw.SET_UID:return $C($C({},e),{},{uid:t.uid});case kw.SET_INT_UID:return $C($C({},e),{},{intUid:t.intUid});case kw.SET_PUB_ID:return $C($C({},e),{},{pubId:t.pubId});case kw.KEY_METRIC_CLIENT_CREATED:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{clientCreated:t.metric})});case kw.KEY_METRIC_JOIN_START:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{joinStart:t.metric})});case kw.AVOID_JOIN_START:return $C($C({},e),{},{avoidJoinStart:t.avoidJoinStart});case kw.KEY_METRIC_JOIN_END:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{joinEnd:t.metric})});case kw.KEY_METRIC_REQUEST_AP_START:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{requestAPStart:t.metric})});case kw.KEY_METRIC_REQUEST_AP_END:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{requestAPEnd:t.metric})});case kw.KEY_METRIC_JOIN_GATEWAY_START:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{joinGatewayStart:t.metric})});case kw.KEY_METRIC_JOIN_GATEWAY_END:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{joinGatewayEnd:t.metric})});case kw.KEY_METRIC_PEER_CONNECTION_START:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{peerConnectionStart:t.metric})});case kw.KEY_METRIC_PEER_CONNECTION_END:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{peerConnectionEnd:t.metric})});case kw.KEY_METRIC_DESCRIPTION_START:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{descriptionStart:t.metric})});case kw.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{signalChannelOpen:t.metric})});case kw.KEY_METRIC_ICE_CONNECTION_END:return $C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{iceConnectionEnd:t.metric})});case kw.KEY_METRIC_PUBLISH:{const n=e.keyMetrics.publish,i=n.findIndex((e=>e.trackId===t.metric.trackId));return-1!==i?(n[i]=$C($C({},n[i]),t.metric),$C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{publish:[...n]})})):$C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{publish:[...e.keyMetrics.publish,t.metric]})})}case kw.KEY_METRIC_SUBSCRIBE:{const n=e.keyMetrics.subscribe,i=n.findIndex((e=>e.userId===t.metric.userId&&e.type===t.metric.type));return-1!==i?(n[i]=$C($C({},n[i]),t.metric),$C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{subscribe:[...n]})})):$C($C({},e),{},{keyMetrics:$C($C({},e.keyMetrics),{},{subscribe:[...e.keyMetrics.subscribe,t.metric]})})}case kw.SET_CLOUD_PROXY_SERVER_MODE:return e.cloudProxyServerMode=t.mode,e;case kw.RECORD_JOIN_CHANNEL_SERVICE:return"number"!=typeof t.index?e.joinChannelServiceRecords=[...e.joinChannelServiceRecords,t.record]:(e.joinChannelServiceRecords[t.index]=$C($C({},e.joinChannelServiceRecords[t.index]),t.record),e.joinChannelServiceRecords=[...e.joinChannelServiceRecords]),e;case kw.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return e.joinChannelServiceRecords=[],e;case kw.RESET_KEY_METRICS:return e.keyMetrics={publish:[],subscribe:[]},e;case kw.SET_USE_DATACHANNEL:return $C($C({},e),{},{useDataChannel:t.val});case kw.SET_USE_P2P:return $C($C({},e),{},{useP2P:t.val});case kw.SET_TRANSPORT_TYPE:return $C($C({},e),{},{p2pTransport:t.val});default:return e}}(this.state,e)}set sessionId(e){this.dispatch({type:kw.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}set codec(e){this.state.codec=e}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:kw.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:kw.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:kw.SET_UID,uid:e})}get uid(){return this.state.uid}set intUid(e){this.dispatch({type:kw.SET_INT_UID,intUid:e})}get intUid(){return this.state.intUid}set pubId(e){this.dispatch({type:kw.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:kw.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:kw.SET_USE_DATACHANNEL,val:e})}get useDataChannel(){return this.state.useDataChannel}set useP2P(e){this.dispatch({type:kw.SET_USE_P2P,val:e})}get useP2P(){return this.state.useP2P}set p2pTransport(e){this.dispatch({type:kw.SET_TRANSPORT_TYPE,val:e})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:kw.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:kw.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:kw.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:kw.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:kw.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:kw.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:kw.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:kw.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:kw.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:kw.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:kw.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:kw.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,t,n,i){this.dispatch({type:kw.KEY_METRIC_PUBLISH,metric:$C($C({trackId:e,type:t},n&&{publishStart:n}),i&&{publishEnd:i})})}subscribe(e,t,n,i,r,o,s){this.dispatch({type:kw.KEY_METRIC_SUBSCRIBE,metric:$C($C($C($C($C({userId:e,type:t},n&&{subscribeStart:n}),i&&{subscribeEnd:i}),r&&{firstFrame:r}),o&&{streamAdded:o}),s&&{firstDecoded:s})})}massSubscribe(e,t,n,i){e.forEach((e=>{this.dispatch({type:kw.KEY_METRIC_SUBSCRIBE,metric:$C($C($C({userId:e.userId,type:e.type},t&&{subscribeStart:t}),n&&{subscribeEnd:n}),i&&{firstFrame:i})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,t){"gateway"===e.service&&Array.isArray(e.urls)&&(e.urls=e.urls.map((e=>e.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return"number"!=typeof t?(this.dispatch({type:kw.RECORD_JOIN_CHANNEL_SERVICE,record:$C($C({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(t<0||t>=this.state.joinChannelServiceRecords.length||this.dispatch({type:kw.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:t}),t)}catch(e){return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:kw.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:kw.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch(e){return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:kw.AVOID_JOIN_START,avoidJoinStart:e})}}let Mw=function(e){return e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1",e}({});!function(e){e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722"}({});const Uw=128,xw=96,Vw=1e3,Fw=10;let jw=0;function Bw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Gw(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Bw(Object(n),!0).forEach((function(t){Ww(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Bw(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ww(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Hw=new class extends vR{constructor(){super(...arguments),Ww(this,"currentUploadLogID",0)}reportLogUploadError(e){const{errorRange:t}=e;t[t.length-1]&&t[t.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=t[t.length-1],this.emit("REPORT_LOG_UPLOAD",e))}};class Kw{constructor(e){Ww(this,"logger",void 0),Ww(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.logger.debug(...this.prefixLists,...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.logger.info(...this.prefixLists,...t)}warning(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.logger.warning(...this.prefixLists,...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.logger.error(...this.prefixLists,...t)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function zw(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function qw(){const e=new Date,t=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return t?(null==t?void 0:t[0])+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const Yw={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Jw=Date.now(),Xw=e=>{for(const t in Yw)if(Object.prototype.hasOwnProperty.call(Yw,t)&&Yw[t]===e)return t;return"DEFAULT"},Qw=new class{constructor(){Ww(this,"proxyServerURL",void 0),Ww(this,"logLevel",Yw.DEBUG),Ww(this,"uploadState","collecting"),Ww(this,"uploadLogWaitingList",[]),Ww(this,"uploadLogUploadingList",[]),Ww(this,"uploadErrorCount",0),Ww(this,"currentLogID",0),Ww(this,"url",void 0),Ww(this,"extLog",((e,t)=>{this.appendLogToWaitingList(e,...t)}))}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Yw.DEBUG].concat(t);this.log.apply(this,i)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Yw.INFO].concat(t);this.log.apply(this,i)}warning(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Yw.WARNING].concat(t);this.log.apply(this,i)}warn(){this.warning(...arguments)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Yw.ERROR].concat(t);this.log.apply(this,i)}upload(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Yw.DEBUG].concat(t);this.uploadLog.apply(this,i)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){Nw("UPLOAD_LOG",!0)}disableLogUpload(){Nw("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new Kw(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-Jw<100)return void setTimeout((()=>{this.log(...t)}),Date.now()-Jw);const i=Math.max(0,Math.min(4,t[0]));if(t[0]=zw()+" Agora-SDK [".concat(Xw(i),"]:"),this.appendLogToWaitingList(i,...t),i<this.logLevel)return;const r=zw()+" %cAgora-SDK [".concat(Xw(i),"]:");let o=[];if(!Dw("USE_NEW_LOG"))switch(i){case Yw.DEBUG:o=[r,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,o);break;case Yw.INFO:o=[r,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,o);break;case Yw.WARNING:o=[r,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,o);break;case Yw.ERROR:o=[r,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-Jw<100)return void setTimeout((()=>{this.uploadLog(...t)}),Date.now()-Jw);const i=Math.max(0,Math.min(4,t[0]));t[0]=zw()+" Agora-SDK [".concat(Xw(i),"]:"),this.appendLogToWaitingList(i,...t)}appendLogToWaitingList(e){if(!Dw("UPLOAD_LOG"))return;for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];Array.isArray(n[0])?n[0][0]=qw()+" Agora-SDK [".concat(Xw(e),"]:"):n[0]=qw()+" Agora-SDK [".concat(Xw(e),"]:");let r="";n.forEach((e=>{"object"==typeof e&&(e=JSON.stringify(e)),r+="".concat(e," ")})),this.uploadLogWaitingList.push({payload_str:r,log_level:e,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){const e=this.uploadLogUploadingList,t={sdk_version:Rw,process_id:Dw("PROCESS_ID"),payload:JSON.stringify(e)};return _w((async()=>{const e=await pC.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(Dw("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(Dw("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if("OK"!==e.data){const t=new Error("unexpected upload log response");throw t.response=e,t}}),(()=>(this.uploadLogUploadingList=[],!1)),(t=>{const n={status:-1,message:t.message,errorRange:e.map((e=>e.log_item_id))};return t.response?(n.status=t.response.status,n.data=t.response.data,n.headers=t.response.headers):t.request&&(n.status=t.request.status),Hw.reportLogUploadError(n),!0}),{timeout:Dw("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:Dw("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,Dw("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),Dw("UPLOAD_LOG_INTERVAL"))})).catch((e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),Dw("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),Dw("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}};var Zw;function $w(e){return aR(e.reportId,"params.reportId",0,100,!1),aR(e.category,"params.category",0,100,!1),aR(e.event,"params.event",0,100,!1),aR(e.label,"params.label",0,100,!1),oR(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(Zw={}).FREE="free",Zw.UPLOADING="uploading",function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"}({});const eI={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let tI=function(e){return e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",e}({}),nI=function(e){return e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",e}({});!function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}({}),function(e){e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}({});class iI{constructor(){Ww(this,"baseInfoMap",new Map),Ww(this,"proxyServer",void 0),Ww(this,"eventUploadTimer",void 0),Ww(this,"setSessionIdTimer",void 0),Ww(this,"url",void 0),Ww(this,"backupUrl",void 0),Ww(this,"_appId",void 0),Ww(this,"keyEventUploadPendingItems",[]),Ww(this,"normalEventUploadPendingItems",[]),Ww(this,"apiInvokeUploadPendingItems",[]),Ww(this,"apiInvokeCount",0),Ww(this,"ltsList",[]),Ww(this,"lastSendNormalEventTime",Date.now()),Ww(this,"customReportCounterTimer",void 0),Ww(this,"customReportCount",0),Ww(this,"extApiInvoke",(async e=>{for(const t of e){const e=Gw(Gw({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:CR.TRACER});this.sendApiInvoke(e)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),Dw("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),Dw("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}adjustSessionStartTime(e){if(!this.baseInfoMap.has(e)&&!this.baseInfoMap.get(e))return void Qw.error("adjust session ".concat(e," start time, sid is not exist or info is undefined"));const t=this.baseInfoMap.get(e),n=Date.now(),i=t.startTime;t.startTime=n,Qw.debug("rewrite session ".concat(e," startTime: ").concat(n," , ").concat(n-i,"ms")),this.baseInfoMap.set(e,t)}setAppId(e){this._appId=e}reportApiInvoke(e,t,n){t.timeout=t.timeout||6e4,t.reportResult=void 0===t.reportResult||t.reportResult;const i=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,o=()=>({tag:t.tag,invokeId:r,sid:e,name:t.name,apiInvokeTime:i,options:t.options,states:t.states||null}),s=!!Dw("SHOW_REPORT_INVOKER_LOG");s&&Qw.info("".concat(t.name," start"),t.options);let a=!1;$R(t.timeout).then((()=>{a||(this.sendApiInvoke(Gw(Gw({},o()),{},{error:tR.API_INVOKE_TIMEOUT,success:!1})),Qw.debug("".concat(t.name," timeout")))}));const c=new nR(tR.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:e=>{const i=()=>{if(a)throw c;return a=!0,this.sendApiInvoke(Gw(Gw({},o()),{},{success:!0},t.reportResult&&{result:e})),s&&Qw.info("".concat(t.name," onSuccess")),e};return n?rw(i,t.name+"Success",n,(()=>a=!0)):i()},onError:e=>{const i=()=>{if(a)throw e;a=!0,this.sendApiInvoke(Gw(Gw({},o()),{},{success:!1,error:e})),s&&Qw.info("".concat(t.name," onFailure"),e.toString())};return n?rw(i,t.name+"Error",n,(()=>a=!0)):i()}}}sessionInit(e,t){if(this.baseInfoMap.has(e))return;const n=Date.now(),i=this.createBaseInfo(e,n);i.cname=t.cname;const r=Object.assign({},{willUploadConsoleLog:Dw("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:ww?"global":"oversea",areas:Dw("AREAS")&&Dw("AREAS").join(",")},t.extend),{stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:l,clientRole:d}=t,u=Date.now(),h=Gw(Gw({},i),{},{eventType:tI.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,buildFormat:t.buildFormat,build:Aw,lts:u,elapse:u-n,extend:JSON.stringify(r),mode:t.mode,process:Dw("PROCESS_ID"),appType:Dw("APP_TYPE"),success:!0,version:Rw,stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:l,clientType:20,clientRole:d,serviceId:Dw("PROCESS_ID"),extensionID:Dw("PLUGIN_INFO").join(",")||"",preload:t.preload?1:0});this.send({type:nI.SESSION,data:h},!0)}joinChooseServer(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw({},i),{},{eventType:tI.JOIN_CHOOSE_SERVER,lts:r,eventElapse:t.elapse||r-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:r-n.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3});this.send({type:nI.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw({},i),{},{eventType:tI.REQ_USER_ACCOUNT,lts:r,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:t.elapse||r-n.startTime,eventElapse:r-t.lts,extend:JSON.stringify(t.extend)});this.send({type:nI.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info;t.vid&&(i.vid=t.vid),i.uid=t.uid,i.cid=t.cid;const r=Date.now(),{firstSuccess:o,avoidJoinStartTime:s,isProxy:a,addr:c}=t,l=r-(o&&s?s:n.startTime),d=Gw(Gw({},i),{},{eventType:tI.JOIN_GATEWAY,lts:r,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,elapse:l,eventElapse:r-t.lts,firstSuccess:o,signalChannel:t.signalChannel}),u=d.success?1:0;if(t.succ&&(n.lastJoinSuccessTime=r),o)this.send({type:nI.JOIN_GATEWAY,data:d},!0);else{let e;if(c)if(a){const t=c.match(/h=(\d{1,3}-){3}\d{1,3}/g),n=c.match(/p=[0-9]{1,6}/g);e={isSuccess:u,gatewayIp:t&&t.length?t[0].split("=")[1].replace(/-/g,"."):"",port:n&&n.length?n[0].split("=")[1]:"",isProxy:a?1:0}}else{const t=c.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),n=c.match(/(:|p=)[0-9]{1,6}/g);e={isSuccess:u,gatewayIp:t&&t.length?t[0].split("//")[1].replace(/-/g,"."):"",port:n&&n.length?n[0].split(/:|p=/g)[1]:"",isProxy:a?1:0}}else e={isSuccess:u,gatewayIp:"",port:"",isProxy:a?1:0};delete d.success,delete d.eventType,delete d.firstSuccess,d.vid=Number(d.vid);const t=Object.assign({},d,e,{eventType:tI.REJOIN_GATEWAY});this.send({type:nI.RE_JOIN_GATEWAY,data:t},!0)}}joinChannelTimeout(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=Date.now(),r=Gw(Gw({},n.info),{},{lts:i,timeout:t,elapse:i-n.startTime});this.send({type:nI.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw({},i),{},{eventType:tI.PUBLISH,lts:r,eventElapse:t.eventElapse,elapse:r-n.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:nI.PUBLISH,data:o},!0)}subscribe(e,t,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,o=Date.now(),s=Gw(Gw({},r),{},{eventType:tI.SUBSCRIBE,lts:o,eventElapse:t.eventElapse,elapse:o-i.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid},n&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof t.peerid?s.peerSuid=t.peerid:s.peer=t.peerid,this.send({type:nI.SUBSCRIBE,data:s},!0)}wsCompressorInit(e){var t;const n=[...df(t=this.baseInfoMap).call(t)],i=n.length?n[0]:"UnableToGetSid",r=this.baseInfoMap.get(i);if(!r)return;const o=r.info,s=Date.now(),a=Gw(Gw({},o),{},{eventType:tI.WS_COMPRESSOR_INIT,lts:s,eventElapse:e.eventElapse,elapse:s-r.startTime,status:e.status?1:2});this.send({type:nI.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const o=r.info,s=Date.now(),a=Gw(Gw(Gw({},o),i),{},{elapse:s-r.startTime,eventType:t,lts:s,firstDecodeFrame:Math.max(s-r.startTime,0),apEnd:Math.max(i.apEnd-r.startTime,0),apStart:Math.max(i.apStart-r.startTime,0),joinGwEnd:Math.max(i.joinGwEnd-r.startTime,0),joinGwStart:Math.max(i.joinGwStart-r.startTime,0),pcEnd:Math.max(i.pcEnd-r.startTime,0),pcStart:Math.max(i.pcStart-r.startTime,0),subscriberEnd:Math.max(i.subscriberEnd-r.startTime,0),subscriberStart:Math.max(i.subscriberStart-r.startTime,0),videoAddNotify:Math.max(i.videoAddNotify-r.startTime,0)});this.send({type:n,data:a},!0)}firstRemoteFrame(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const o=r.info,s=Date.now(),a=Gw(Gw(Gw({},o),i),{},{elapse:s-r.startTime,eventType:t,lts:s});this.send({type:n,data:a},!0)}pcStats(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw(Gw({},i),t),{},{vid:void 0===i.vid?0:Number(i.vid),elapse:r-n.startTime,eventType:tI.PC_STATS,lts:r});this.send({type:nI.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(e,t){if(e){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw(Gw({},i),t),{},{vid:void 0===i.vid?0:Number(i.vid),eventType:tI.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:nI.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const o=r.info,s=Date.now(),a=Gw(Gw(Gw({},o),i),{},{eventType:t,lts:s});this.send({type:n,data:a},!0)}streamSwitch(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw({},i),{},{eventType:tI.STREAM_SWITCH,lts:r,isDual:t.isdual,elapse:r-n.startTime,success:t.succ});this.send({type:nI.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw({},i),{},{eventType:tI.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-t.lts,elapse:r-n.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:nI.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw({},i),{},{eventType:tI.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-t.lts,elapse:r-n.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:nI.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(e){this.proxyServer=e,e?Qw.debug("reportProxyServerurl: ".concat(e)):Qw.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw({},i),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:r,elapse:r-n.startTime,joinChannelSuccessElapse:r-(n.lastJoinSuccessTime||r),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:nI.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now();(function(e,t,n){const i=e[t];if(!i||"string"!=typeof i)return[e];e[t]="";const r=XR(JSON.stringify(e));let o=0;const s=[];let a=0;for(let c=0;c<i.length;c++)a+=i.charCodeAt(c)<=127?1:3,a<=n-r||(s[s.length]=$C($C({},e),{},{[t]:i.substring(o,c)}),o=c,a=i.charCodeAt(c)<=127?1:3);return o!==i.length-1&&(s[s.length]=$C($C({},e),{},{[t]:i.substring(o)})),s})(Gw(Gw(Gw({},i),t),{},{elapse:r-n.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach((e=>this.send({type:nI.WORKER_EVENT,data:e},!0)))}apworkerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw(Gw({},i),t),{},{elapse:r-n.startTime,lts:r});this.send({type:nI.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw(Gw({},i),t),{},{elapse:r-n.startTime,lts:r,extend:t.extend||void 0});this.send({type:nI.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),o=Gw(Gw(Gw({},i),t),{},{elapse:r-n.startTime,lts:r});this.send({type:nI.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>Dw("CUSTOM_REPORT_LIMIT"))throw new nR(tR.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const n=Date.now(),i=t.map((t=>({type:nI.USER_ANALYTICS,data:Gw(Gw({sid:e},t),{},{lts:n})})));try{Dw("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(i):await this.postDataToStatsCollector(i)}catch(e){throw Qw.error("send custom report message failed",e.toString()),new nR(tR.CUSTOM_REPORT_SEND_FAILED,e.message)}}sendApiInvoke(e){const t=Dw("NOT_REPORT_EVENT");if(e.tag&&Pi(t)&&Pi(t).call(t,e.tag))return!1;if(null===e.sid)return this.apiInvokeUploadPendingItems.push(e),!1;const n=this.baseInfoMap.get(e.sid);if(!n)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:i,uid:r,cid:o}=n.info;let s;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof nR){const{code:t,message:n}=e.error;s=t||n||e.error.toString()}else s=e.error.toString();const a={invokeId:e.invokeId,sid:e.sid,cname:i,cid:o,uid:r,lts:e.lts,success:e.success,elapse:e.lts-n.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?s:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:nI.API_INVOKE,data:a},!1),!0}appendSessionId(){iI.__CLIENT_LIST__.forEach((e=>{if(e._sessionId){const t=this.apiInvokeUploadPendingItems.length;for(let n=0;n<t;n++){const t=this.apiInvokeUploadPendingItems.shift();t&&(t.sid=e._sessionId,this.sendApiInvoke(Object.assign({},t)))}}}))}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>Dw("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){const n=[],i=[];for(;e.length;){const t=e.shift();n.length<20?n.push(t):i.push(t)}e.push(...i);for(const o of[...n]){var r;-1!==this.ltsList.indexOf(o.data.lts)?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),sm(r=this.ltsList).call(r,((e,t)=>e-t)))}return t||(this.lastSendNormalEventTime=Date.now()),Dw("ENABLE_EVENT_REPORT")?(n.length&&(Dw("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((e=>n=>{Dw("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(e):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(e),this.normalEventUploadPendingItems.length>Dw("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-Dw("NORMAL_EVENT_QUEUE_CAPACITY")),Qw.warning("report: drop normal events"))))})(n)),e):e}async postDataToStatsCollector2(e){VR.networkState===PR.OFFLINE&&await Gh.race([VR.onlineWaiter,$R(2*fw.maxRetryTimeout)]);const t=e=>{let t=new Uint8Array;return e.forEach((e=>{const n=_R(JSON.stringify(e.data)),i=new ArrayBuffer(5),r=(e=>{let t=0;return Object.entries(nI).forEach((n=>{let[i,r]=n;r===e.type&&(t=EventNameToID[i])})),t})(e),o=new DataView(i);o.setUint16(0,n.byteLength,!0),o.setUint8(2,255&r),o.setUint8(3,r>>>8&255),o.setUint8(4,r>>>16&255),t=ER(t,new Uint8Array(i)),t=ER(t,n)})),t},n="event";let i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Dw("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(n):"https://".concat(Dw("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(n);for(let r=0;r<2;r+=1){1===r&&(i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Dw("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(n):"https://".concat(Dw("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(n));try{await Sw(i,{timeout:1e4,data:t(e),headers:Gw(Gw({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(e){if(1===r)throw e;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map((e=>JSON.stringify(e))),vid:(e=>{const t=e&&e.data.sid&&this.baseInfoMap.get(e.data.sid);return t&&t.info.vid&&+t.info.vid||0})(e[0])};VR.networkState===PR.OFFLINE&&await Gh.race([VR.onlineWaiter,$R(2*fw.maxRetryTimeout)]);const i=t?"/events/proto-raws":"/events/messages";let r=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Dw("EVENT_REPORT_DOMAIN"),"&p=").concat(Dw("STATS_COLLECTOR_PORT"),"&d=").concat(i):"https://".concat(Dw("EVENT_REPORT_DOMAIN"),":").concat(Dw("STATS_COLLECTOR_PORT")).concat(i));for(let o=0;o<2;o+=1){1===o&&(r=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(Dw("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(Dw("STATS_COLLECTOR_PORT"),"&d=").concat(i):"https://".concat(Dw("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(Dw("STATS_COLLECTOR_PORT")).concat(i)));try{t?await yw(r,{timeout:1e4,data:n}):await Sw(r,{timeout:1e4,data:n})}catch(t){if(1===o)throw t;continue}return}}createBaseInfo(e,t){const n=Object.assign({},eI);return n.sid=e,this.baseInfoMap.set(e,{info:n,startTime:t}),n}reportResourceTiming(e,t){const n=performance.getEntriesByName(e),i=n[n.length-1];i&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:i,tag:CR.TRACER}).onSuccess()}}function rI(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,n,i){const r=i.value;if("function"==typeof r){const o=e.className||t.__className__||("AgoraRTCClient"===t.constructor.name?"Client":t.constructor.name);i.value=function(){for(var t=arguments.length,i=new Array(t),s=0;s<t;s++)i[s]=arguments[s];let a=i;if(e.argsMap)try{a=e.argsMap(this,...i)}catch(e){Qw.warning(e),a=[]}try{JSON.stringify(a)}catch(e){Qw.warning("arguments for method ".concat(o,".").concat(String(n)," not serializable for apiInvoke.")),a=[]}const c=(e.report||oI).reportApiInvoke(this._sessionId||null,{name:"".concat(o,".").concat(String(n)),options:a,tag:CR.TRACER,reportResult:e.reportResult},e.throttleTime);try{const t=r.apply(this,i);return t instanceof Gh?t.then((t=>(c.onSuccess(e.reportResult&&t),t))).catch((e=>{throw c.onError(e),e})):(c.onSuccess(e.reportResult&&t),t)}catch(e){throw c.onError(e),e}}}return i}}Ww(iI,"__CLIENT_LIST__",[]);const oI=new iI;Hw.on("REPORT_LOG_UPLOAD",(e=>{e.networkState=VR.networkState,oI.reportApiInvoke(null,{name:"logUploadError",options:e,tag:CR.TRACER}).onSuccess("logUploadError")}));const sI=["CHINA","GLOBAL"],aI=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const i=n.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const o=r.join(""),s={};return s[e]=i,s[t]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=aI,ww||(Ow.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Ow.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Ow.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Ow.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Ow.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Ow.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Ow.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Ow.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Ow.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Ow.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Ow.AREAS=["NORTH_AMERICA","OVERSEA"]);const cI=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],lI=[];function dI(e,t){return!!t&&lI.some((n=>n.uid===e&&n.channelName===t))}iI.__CLIENT_LIST__=lI;var uI=SE.forEach,hI=Bi("forEach")?[].forEach:function(e){return uI(this,e,arguments.length>1?arguments[1]:void 0)};Nn({target:"Array",proto:!0,forced:[].forEach!=hI},{forEach:hI});var pI=Zn("Array").forEach,fI=fi,mI=$e,_I=u,EI=pI,gI=Array.prototype,vI={DOMTokenList:!0,NodeList:!0},TI=function(e){var t=e.forEach;return e===gI||_I(gI,e)&&t===gI.forEach||mI(vI,fI(e))?EI:t},SI=i(TI),yI=Xe,CI=to;Nn({target:"Object",stat:!0,forced:r((function(){CI(1)}))},{keys:function(e){return CI(yI(e))}});var RI=i(ie.Object.keys),wI=i(Ji),II=Nn,bI=C_,AI=d([].reverse),OI=[1,2];II({target:"Array",proto:!0,forced:String(OI)===String(OI.reverse())},{reverse:function(){return bI(this)&&(this.length=this.length),AI(this)}});var NI=Zn("Array").reverse,DI=u,PI=NI,kI=Array.prototype,LI=function(e){var t=e.reverse;return e===kI||DI(kI,e)&&t===kI.reverse?PI:t},MI=LI,UI=i(MI),xI=Nn,VI=C_,FI=Bc,jI=ne,BI=Fn,GI=Hn,WI=$,HI=_f,KI=pt,zI=Xc,qI=M_("slice"),YI=KI("species"),JI=Array,XI=Math.max;xI({target:"Array",proto:!0,forced:!qI},{slice:function(e,t){var n,i,r,o=WI(this),s=GI(o),a=BI(e,s),c=BI(void 0===t?s:t,s);if(VI(o)&&(n=o.constructor,(FI(n)&&(n===JI||VI(n.prototype))||jI(n)&&null===(n=n[YI]))&&(n=void 0),n===JI||void 0===n))return zI(o,a,c);for(i=new(void 0===n?JI:n)(XI(c-a,0)),r=0;a<c;a++,r++)a in o&&HI(i,r,o[a]);return i.length=r,i}});var QI=Zn("Array").slice,ZI=u,$I=QI,eb=Array.prototype,tb=function(e){var t=e.slice;return e===eb||ZI(eb,e)&&t===eb.slice?$I:t},nb=i(tb);function ib(e,t,n,i,r){var o,s,a,c={};return SI(o=RI(i)).call(o,(function(e){c[e]=i[e]})),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=wI(s=UI(a=nb(n).call(n)).call(a)).call(s,(function(n,i){return i(e,t,n)||n}),c),r&&void 0!==c.initializer&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),void 0===c.initializer&&(S_(e,t,c),c=null),c}var rb=Zn("Array").values,ob=fi,sb=$e,ab=u,cb=rb,lb=Array.prototype,db={DOMTokenList:!0,NodeList:!0},ub=function(e){var t=e.values;return e===lb||ab(lb,e)&&t===lb.values||sb(db,ob(e))?cb:t},hb=i(ub);let pb=function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e}({}),fb=function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e}({}),mb=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),_b=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),Eb=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e}({}),gb=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),vb=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),Tb=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),Sb=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e}({}),yb=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e}({}),Cb=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),Rb=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e}({}),wb=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),Ib=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e}({});class bb extends nR{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),iT(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(e,Qw)}throw(){super.throw(Qw)}}function Ab(e){if("string"!=typeof e||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw Qw.error("Invalid Channel Name ".concat(e)),new bb(tR.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Ob(e){if(!function(e){return"number"==typeof e&&Math.floor(e)===e&&0<=e&&e<=4294967295}(e)&&!dR(e,1,255))throw new bb(tR.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");"string"==typeof e&&Qw.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Nb=function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming",e}({}),Db=function(e){return e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN",e}({});const Pb={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},kb={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Lb(e,t){aR(e.url,"".concat(t,".url"),1,1e3,!1),lR(e.x)||oR(e.x,"".concat(t,".x"),0,1e4),lR(e.y)||oR(e.y,"".concat(t,".y"),0,1e4),lR(e.width)||oR(e.width,"".concat(t,".width"),0,1e4),lR(e.height)||oR(e.height,"".concat(t,".height"),0,1e4),lR(e.zOrder)||oR(e.zOrder,"".concat(t,".zOrder"),0,255),lR(e.alpha)||oR(e.alpha,"".concat(t,".alpha"),0,1,!1)}const Mb={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Ub={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};let xb=function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e}({}),Vb=function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e}({}),Fb=function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e}({});function jb(e){if(!e.channelName)throw new bb(tR.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof e.uid)throw new bb(tR.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&aR(e.token,"info.token",1,2047),Ob(e.uid),Ab(e.channelName),!0}let Bb=function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e}({}),Gb=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),Wb=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),Hb=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),Kb=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),zb=function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal",e}({}),qb=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({}),Yb=function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e}({}),Jb=function(e){return e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel",e}({}),Xb=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});const Qb=[Xb.AFRICA,Xb.ASIA,Xb.CHINA,Xb.EUROPE,Xb.GLOBAL,Xb.INDIA,Xb.JAPAN,Xb.NORTH_AMERICA,Xb.OCEANIA,Xb.OVERSEA,Xb.SOUTH_AMERICA];let Zb=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});const $b={CHINA:{},ASIA:{CODE:Zb.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Zb.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Zb.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Zb.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Zb.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Zb.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Zb.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Zb.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Zb.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Zb.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Zb.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Zb.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Zb.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};ww&&($b.CHINA={CODE:Zb.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let eA=function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e}({});class tA extends vR{constructor(e,t){super(),iT(this,"onICEConnectionStateChange",void 0),iT(this,"onConnectionStateChange",void 0),iT(this,"onDTLSTransportStateChange",void 0),iT(this,"onDTLSTransportError",void 0),iT(this,"onICETransportStateChange",void 0),iT(this,"onFirstAudioReceived",void 0),iT(this,"onFirstVideoReceived",void 0),iT(this,"onFirstAudioDecoded",void 0),iT(this,"onFirstVideoDecoded",void 0),iT(this,"onFirstVideoDecodedTimeout",void 0),iT(this,"onSelectedLocalCandidateChanged",void 0),iT(this,"onSelectedRemoteCandidateChanged",void 0),iT(this,"getLocalVideoStats",void 0)}}class nA extends tA{constructor(e,t){super(e,t),iT(this,"establishPromise",void 0)}}let iA=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),rA=function(e){return e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY",e}({}),oA=function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e}({}),sA=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),aA=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),cA=function(e){return e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e}({}),lA=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),dA=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),uA=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),hA=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),pA=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e}({}),fA=function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e}({}),mA=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),_A=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),EA=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),gA=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),vA=function(e){return e.ABORT="abort",e}({}),TA=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),SA=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({});const yA={[mb.ACCESS_POINT]:{[gb.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[gb.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[gb.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[gb.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[gb.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[gb.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[gb.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[mb.UNILBS]:{[Eb.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Eb.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Eb.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Eb.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Eb.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Eb.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Eb.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Eb.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Eb.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Eb.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Eb.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Eb.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[mb.STRING_UID_ALLOCATOR]:{[_b.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[_b.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[_b.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function CA(e){const t=yA[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};const n=t[e%1e4];if(!n){if(Math.floor(e/1e4)===mb.ACCESS_POINT){const t=e%1e4;if("1"===t.toString()[0])return{desc:e.toString(),retry:!1};if("2"===t.toString()[0])return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}const RA={[vb.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[vb.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[vb.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[vb.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[vb.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[vb.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[vb.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[vb.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[vb.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[vb.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[vb.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[vb.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[vb.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[vb.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[vb.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[vb.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[vb.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[vb.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[vb.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[vb.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[vb.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[vb.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[vb.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[vb.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[vb.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[vb.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[vb.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[vb.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[vb.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[vb.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[vb.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[vb.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[vb.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[vb.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[vb.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[vb.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[vb.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[vb.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[vb.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[vb.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[vb.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[vb.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[vb.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[vb.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[vb.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[vb.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[vb.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[vb.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[vb.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[vb.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[vb.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[vb.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[vb.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[vb.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[vb.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[vb.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[vb.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[vb.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[vb.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[vb.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[vb.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[vb.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[vb.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function wA(e){return RA[e]||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function IA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function bA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?IA(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):IA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function AA(e){return e.every((e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING))}function OA(e,t){if("string"==typeof e)return e;const{proxy:n,host:i,port:r}=e;if(t){const e=Dw("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===e?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(e,"/ws/?p=").concat(Number(r)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}const NA=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,DA=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,PA=/wss:\/\/(.+):([0-9]+)\/?/,kA=/wss:\/\/(.[^\/]+)\/?/;let LA=0;class MA{constructor(e,t){iT(this,"id",0),iT(this,"store",void 0),iT(this,"recordIndex",void 0),iT(this,"websockets",[]),iT(this,"try443PortDuration",2e3),iT(this,"forceCloseWSDuration",5e3),iT(this,"try443PortTimeout",null),iT(this,"forceCloseTimeout",null),iT(this,"isTry443PortFailed",!1),iT(this,"isNormalPortFailed",!1),iT(this,"useDoubleDomain",!1),iT(this,"useProxy",!1),iT(this,"startTime",Date.now()),this.id=++LA,this.try443PortDuration=Dw("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const t=Date.now()-this.startTime;for(var n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];Qw.debug("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(t,"ms:"),...i)}createWebSocket(e,t,n){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:n});const i=Dw("GATEWAY_DOMAINS"),r=Date.now(),o=[],s=i.find((t=>{var n;return Pi(n=e.host).call(n,t)}));s||(this.useDoubleDomain=!1);const a=[];if(this.useDoubleDomain)i.forEach((n=>{a.push(OA(bA(bA({},e),{},{host:e.host.replace(s,n)}),t))}));else{const n=bA({},e);if(t&&s){const e=i.find((e=>e!==s));e&&(n.host=n.host.replace(s,e))}a.push(OA(n,t))}try{a.forEach((e=>{const t=new WebSocket(e);t.binaryType="arraybuffer",o.push(t),this.logger("ws is connecting:",t.url)}))}catch(i){if(this.logger("ws create failed"),o.forEach((e=>e.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,n);if(!t&&443!==Number(e.port))return this.createWebSocket(e,!0,n);throw new bb(tR.WS_ERR,"init websocket failed! Error: ".concat(i.toString()))}const c=mC();return this.store&&this.store.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},this.recordIndex),o.forEach((e=>{e.onopen=()=>{this.logger("onopen: ws ".concat(e.url," open cost ").concat(Date.now()-r,"ms")),this.websockets.forEach((t=>{t!==e&&(t.onopen=null,t.onclose=null,t.onmessage=null,t.close(),this.logger("close backup websocket: ".concat(t.url)))})),this.websockets.length=0,c.resolve(e)},e.onclose=n=>{this.logger("onclose: ws ".concat(e.url," closed cost ").concat(Date.now()-r,"ms state: ").concat(e.readyState)),t?this.isTry443PortFailed=AA(o):this.isNormalPortFailed=AA(o),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(t&&this.isTry443PortFailed||!t&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(n.reason)),c.reject({code:n.code,reason:qb.A_ROUND_WS_FAILED}))},e.onmessage=t=>this.logger("".concat(e.url," onmessage: ").concat(t.data))})),this.websockets.push(...o),n||(()=>{const n=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",c.isResolved),this.websockets.forEach((e=>e.readyState!==WebSocket.OPEN&&e.close()))};if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(n,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket created: ",c.isResolved),c.isResolved)return n();RC().os===vC.MAC_OS&&PC()&&n(),this.createWebSocket(e,!0,!0).then((e=>c.resolve(e))).catch((e=>{this.isNormalPortFailed&&c.reject(e),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(n,this.forceCloseWSDuration)}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(e,t,n,i){return this.useDoubleDomain=!!t,"string"==typeof e&&(e=function(e){let t,n,i;return[,t,n,i]=e.match(NA)||[],t||([,n,i]=e.match(DA)||[]),n&&i||([,n,i]=e.match(PA)||[]),n&&i||([,n]=e.match(kA)||[]),n||Qw.warning("un-destructible url: ",e),{proxy:t,host:n,port:i||"443"}}(e)),this.recordIndex=i,this.useProxy=!!e.proxy,n&&this.useProxy&&(Qw.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(e,!!n,!1).finally((()=>this.clearTimeout()))}}function UA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class xA extends vR{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;Pi(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(Ib.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(Ib.CONNECTED):"closed"===this._state?this.emit(Ib.CLOSED):"failed"===this._state&&this.emit(Ib.FAILED))}resetReconnectCount(e){Qw.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),iT(this,"connectionID",0),iT(this,"currentURLIndex",0),iT(this,"urls",[]),iT(this,"_reconnectMode","tryNext"),iT(this,"reconnectReason",void 0),iT(this,"_initMutex",new hw("websocket")),iT(this,"name",void 0),iT(this,"_state","closed"),iT(this,"reconnectInterrupter",void 0),iT(this,"websocket",void 0),iT(this,"retryConfig",void 0),iT(this,"reconnectCount",0),iT(this,"forceCloseTimeout",5e3),iT(this,"onlineReconnectListener",void 0),iT(this,"useCompress",void 0),iT(this,"tryDoubleDomain",!1),iT(this,"use443PortOnly",!1),iT(this,"wsInflateLength",0),iT(this,"wsDeflateLength",0),iT(this,"closeEstablishingWs",(()=>{})),iT(this,"store",void 0),iT(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=e,this.retryConfig=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?UA(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):UA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t),this.useCompress=n,this.tryDoubleDomain=i,this.use443PortOnly=r;const{timeout:s,timeoutFactor:a}=t,c=Math.max(300,Math.floor(3*s/5)),l=Math.max(1.2,Math.floor(8*a)/10);PR.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=l),VR.on(kR.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===PR.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=s,this.retryConfig.timeoutFactor=a))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const n=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=mC(),t=this.urls[this.currentURLIndex];this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(Ib.CLOSED,(()=>{e.reject(new nR(tR.WS_DISCONNECT))})),this.once(Ib.CONNECTED,e.resolve),await e.promise}catch(e){}finally{n()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,t){if(!this.websocket)return void Qw.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),Qw.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(t)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:t})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new nR(tR.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new nR(tR.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var t;const n=mC();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const i=e=>{var t;null===(t=this.store)||void 0===t||t.signalChannelOpen(),Qw.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},r=async e=>{var t;if(Qw.debug("[".concat(this.name,"] websocket close ").concat(null===(t=this.websocket)||void 0===t?void 0:t.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new nR(tR.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const t=UR(this,Ib.WILL_RECONNECT,this.reconnectMode,e.reason)||this.reconnectMode,i=await this.reconnectWithAction(t);if("closed"===this.state)return void Qw.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!i)return n.reject(new nR(tR.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),this.close(!0);n.resolve()}},o=e=>{this.emit(Ib.ON_MESSAGE,e)},s=e=>{Qw.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),Dw("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=Dw("GATEWAY_WSS_ADDRESS")),Qw.debug("[".concat(this.name,"] start connect, url:"),e);const a=null===(t=this.store)||void 0===t?void 0:t.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var c;const t=await this.chooseBestWebsocketConnection(e);this.websocket=t,i&&i(this.websocket.url),this.websocket.onclose=r,this.websocket.onmessage=o,this.websocket.onerror=s,null===(c=this.store)||void 0===c||c.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this.joinGatewayRecordIndex=a}catch(e){const t="closed"===this.state,i=e instanceof nR,o=i&&e.code===tR.WS_ABORT,s=i&&e.code===tR.WS_ERR,c=i?e.message:e&&(e.reason||e.toString());Qw.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(c)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:o?"aborted":"error",errors:[e]},a),t||s?(n.reject(t?new nR(tR.WS_DISCONNECT,"websocket is closed: ".concat(c)):new nR(tR.WS_ERR,"init websocket failed: ".concat(c))),s&&Qw.error("[".concat(this.name,"] init websocket failed: ").concat(c))):r&&r(e)}return n.promise}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;Qw.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||VR.isOnline||!VR.onlineWaiter||(this.onlineReconnectListener=VR.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let n=!0;if(this.reconnectInterrupter=()=>n=!1,t){const t=mw(this.reconnectCount,this.retryConfig);Qw.debug("[".concat(this.name,"] wait ").concat(t,"ms to reconnect websocket, mode: ").concat(e)),await Gh.race([$R(t),this.onlineReconnectListener||new Gh((()=>{}))])}if("closed"===this._state||!n)return!1;this.reconnectCount+=1;const i=async(e,t)=>{this.emit(Ib.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)this.emit(Ib.RECONNECT_WAITTING_FINISH,e),await i(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);Qw.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(Ib.RECONNECT_WAITTING_FINISH,e),await i(this.urls[this.currentURLIndex],e)}else"recover"===e&&(Qw.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(Ib.RECONNECT_WAITTING_FINISH,e),this.urls=await LR(this,Ib.REQUEST_NEW_URLS),this.currentURLIndex=0,await i(this.urls[this.currentURLIndex],e))}catch(n){var r;Qw.error("[".concat(this.name,"] reconnect failed ").concat(n&&n.toString()));const i=null==n||null===(r=n.data)||void 0===r?void 0:r.desc;return Array.isArray(i)&&Pi(i).call(i,"dynamic key expired")?(this.emit(Ib.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,t)}return!0}}class VA extends xA{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){const n=mC(),i=function(e,t){return new MA(e,t)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{Qw.debug("[choose-best-ws] close establishing websockets"),i.closeAllWebsockets(),n.reject(new nR(tR.WS_ABORT,"choose best websocket aborted"))};const r=Dw("GATEWAY_DOMAINS");return Qw.debug("[choose-best-ws] currentDomain: ",e,", domains: ",r,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),i.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,t).then(n.resolve).catch(n.reject),n.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class FA extends xA{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){return new Gh(((n,i)=>{let r=!1;const o=[];this.closeEstablishingWs=()=>{Qw.debug("[choose-best-ws] close establishing websockets"),o.forEach((e=>{e.onclose=null,e.onopen=null,e.onmessage=null,e.close()})),i(new nR(tR.WS_ABORT,"choose best websocket aborted"))};const s=Dw("GATEWAY_DOMAINS");let a;const c=e.indexOf("?h="),l=s.find((t=>-1!==c?Pi(e).call(e,t,c):Pi(e).call(e,t)));Qw.debug("[choose-best-ws] currentDomain: ",l,", domains: ",s);let d=!this.tryDoubleDomain||!l;if(!d&&l){var u;const h=Date.now();try{s.forEach((t=>{const n=-1===c?e.replace(l,t):e.substr(0,c)+e.substr(c).replace(l,t),i=new WebSocket(n);i.binaryType="arraybuffer",o.push(i),Qw.debug("[choose-best-ws] ws is connecting:",i.url)}))}catch(e){for(Qw.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach((e=>e.close()));o.length;)o.pop();d=!0}null===(u=this.store)||void 0===u||u.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},t),o.forEach((e=>{e.onopen=()=>{if(r)return;const t=Date.now()-h;Qw.debug("[choose-best-ws] ws open cost ".concat(t,"ms")),o.filter((t=>t!==e)).forEach((e=>{Qw.debug("[choose-best-ws]close backup websocket: ".concat(e.url)),e.close()})),r=!0,n(e)},e.onclose=e=>{a=e,r||o.find((e=>!(e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)))||(Qw.debug("[choose-best-ws] all websocket is closed"),r=!0,i(a))},e.onmessage=t=>{Qw.debug("[choose-best-ws]".concat(e.url," onmessage: ").concat(t.data))}})),$R(this.forceCloseTimeout).then((()=>{o.forEach((e=>{e.readyState!==WebSocket.OPEN&&e.close()}))}))}if(d){var h;let r;Qw.debug("[choose-best-ws] use single url: ",e),null===(h=this.store)||void 0===h||h.recordJoinChannelService({urls:[e],service:"gateway"},t);try{r=new WebSocket(e),o.push(r),r.binaryType="arraybuffer"}catch(e){const n=new nR(tR.WS_ERR,"init websocket failed! Error: ".concat(e.toString()));return Qw.error("[".concat(this.name,"]").concat(n)),void i(n)}r.onopen=()=>{n(r)},r.onclose=e=>{i(e)},r.onmessage=e=>{Qw.debug("[choose-best-ws]".concat(r.url," onmessage: ").concat(e.data))},$R(this.forceCloseTimeout).then((()=>{r&&r.readyState!==WebSocket.OPEN&&r.close()}))}})).then((e=>(this.closeEstablishingWs=void 0,e))).catch((e=>{throw this.closeEstablishingWs=void 0,e}))}}class jA extends vR{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Tb.CONNECTED?this.emit(Sb.WS_CONNECTED):e===Tb.RECONNECTING?this.emit(Sb.WS_RECONNECTING,this._websocketReconnectReason):e===Tb.CLOSED&&this.emit(Sb.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),iT(this,"_disconnectedReason",void 0),iT(this,"_websocketReconnectReason",void 0),iT(this,"_connectionState",Tb.CLOSED),iT(this,"reconnectToken",void 0),iT(this,"websocket",void 0),iT(this,"openConnectionTime",void 0),iT(this,"clientId",void 0),iT(this,"lastMsgTime",Date.now()),iT(this,"uploadCache",[]),iT(this,"uploadCacheInterval",void 0),iT(this,"rttRolling",new Ew(5)),iT(this,"pingpongTimer",void 0),iT(this,"wsInflateDataTimer",void 0),iT(this,"pingpongTimeoutCount",0),iT(this,"joinResponse",void 0),iT(this,"multiIpOption",void 0),iT(this,"initError",void 0),iT(this,"spec",void 0),iT(this,"store",void 0),iT(this,"onWebsocketMessage",(e=>{if(e.data instanceof ArrayBuffer)return void this.emit(Sb.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){if(this.emit(t._type,t._message),t._type===Rb.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===Rb.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(IR.UID_BANNED);break;case 15:this.close(IR.IP_BANNED);break;case 16:this.close(IR.CHANNEL_BANNED)}if(t._type===Rb.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case vb.ERR_LICENSE_MISSING:this.close(IR.LICENSE_MISSING);break;case vb.ERR_LICENSE_EXPIRED:this.close(IR.LICENSE_EXPIRED);break;case vb.ERR_LICENSE_MINUTES_EXCEEDED:this.close(IR.LICENSE_MINUTES_EXCEEDED);break;case vb.ERR_LICENSE_PERIOD_INVALID:this.close(IR.LICENSE_PERIOD_INVALID);break;case vb.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(IR.LICENSE_MULTIPLE_SDK_SERVICE);break;case vb.ERR_LICENSE_ILLEGAL:this.close(IR.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new VA("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Dw("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Dw("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===Tb.CONNECTED&&this.reconnect("retry",DR.OFFLINE)}))}async request(e,t,n,i){const r=ew(6,""),o={_id:r,_type:e,_message:t},s=this.websocket.connectionID,a=()=>new Gh(((t,n)=>{if(this.connectionState===Tb.CONNECTED)return t();const i=()=>{this.off(Sb.WS_CLOSED,r),t()},r=()=>{this.off(Sb.WS_CONNECTED,i),n(new bb(tR.WS_ABORT))};this.once(Sb.WS_CONNECTED,i),this.once(Sb.WS_CLOSED,r),e!==yb.PUBLISH&&e!==yb.PUBLISH_DATASTREAM&&e!==yb.SUBSCRIBE&&e!==yb.SUBSCRIBE_DATASTREAM&&e!==yb.UNSUBSCRIBE&&e!==yb.UNSUBSCRIBE_DATASTREAM&&e!==yb.UNPUBLISH&&e!==yb.UNPUBLISH_DATASTREAM&&e!==yb.CONTROL&&e!==yb.RESTART_ICE||this.once(Sb.DISCONNECT_P2P,(()=>{n(new bb(tR.DISCONNECT_P2P))})),e!==yb.PUBLISH&&e!==yb.RESTART_ICE||this.once(Sb.ABORT_P2P_EXECUTION,(()=>{n(new bb(tR.DISCONNECT_P2P))}))}));if(this.connectionState!==Tb.CONNECTING&&this.connectionState!==Tb.RECONNECTING||e===yb.JOIN||e===yb.REJOIN||await a(),this.websocket.sendMessage(o,!0),i)return;const c=new Gh(((n,i)=>{let o=!1;const a=(i,r)=>{o=!0,n({isSuccess:"success"===i,message:r||{}}),this.off(Sb.WS_CLOSED,c),this.off(Sb.WS_RECONNECTING,c),this.emit(Sb.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(r),a);const c=()=>{i(new bb(tR.WS_ABORT,"type: ".concat(e))),this.off(Sb.WS_CLOSED,c),this.off(Sb.WS_RECONNECTING,c),this.off("res-@".concat(r),a)};this.once(Sb.WS_CLOSED,c),this.once(Sb.WS_RECONNECTING,c),$R(Dw("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==s||o||(Qw.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Sb.REQUEST_TIMEOUT,e,t))}))}));let l=null;try{l=await c}catch(i){if(this.connectionState===Tb.CLOSED||e===yb.LEAVE)throw new bb(tR.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?i.throw():e===yb.JOIN||e===yb.REJOIN?null:(await a(),await this.request(e,t))}if(l.isSuccess)return l.message;const d=Number(l.message.error_code||l.message.code),u=wA(d),h=new bb(tR.UNEXPECTED_RESPONSE,"".concat(u.desc,": ").concat(l.message.error_str),{code:d,data:l.message});return"success"===u.action?l.message:(Qw.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(d,", message: ").concat(u.desc,", action: ").concat(u.action)),d===vb.ERR_TOO_MANY_BROADCASTERS?e===yb.JOIN||e===yb.REJOIN?(this.initError=h,this.close(),h.throw()):h.throw():"failed"===u.action?h.throw():"quit"===u.action?(this.initError=h,this.close(),h.throw()):(d===vb.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,Qw.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",DR.MULTI_IP)):this.reconnect(u.action,DR.SERVER_ERROR),e===yb.JOIN||e===yb.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Gh((n=>{const i=r=>{(!t||t(r))&&(this.off(e,i),n(r))};this.on(e,i)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void Qw.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Cb.WRTC_STATS,t)}upload(e,t){const n={_type:e,_message:t};try{this.websocket.sendMessage(n)}catch(e){const t=Dw("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==Tb.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),Dw("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const n={_type:e,_message:t};this.websocket.sendMessage(n)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Gh(((t,n)=>{this.once(Sb.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(Sb.WS_CLOSED,(()=>n(this.initError||new bb(tR.WS_ABORT)))),this.connectionState=Tb.CONNECTING,this.websocket.init(e).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||IR.LEAVE,this.connectionState=Tb.CLOSED,Qw.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===IR.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new VA("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Dw("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Dw("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(Sb.ABORT_P2P_EXECUTION);const e=await LR(this,Sb.REQUEST_JOIN_INFO),t=await this.request(yb.JOIN,e);if(!t)return this.emit(Sb.REPORT_JOIN_GATEWAY,qb.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(Sb.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Tb.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new bb(tR.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=xR(this,Sb.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(yb.REJOIN,e);return!!t&&(this.connectionState=Tb.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(Rb.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(Rb.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(Rb.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(Rb.MUTE_AUDIO,{uid:e.uid}):this.emit(Rb.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(Rb.MUTE_VIDEO,{uid:e.uid}):this.emit(Rb.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(Rb.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(Rb.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(Rb.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(Rb.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(Rb.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){Qw.debug("[".concat(this.clientId,"] receive notification: "),e);const t=wA(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(IR.UID_BANNED),void this.close()):void this.reconnect(t.action,DR.SERVER_ERROR);Qw.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Dw("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(Qw.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>Dw("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",DR.TIMEOUT):this.request(yb.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),Dw("REPORT_STATS")&&this.send(yb.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(Cb.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Ib.RECONNECT_WAITTING_FINISH,(e=>{this.emit(Sb.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(Ib.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(Sb.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(Ib.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ib.CLOSED,(()=>{this.connectionState=Tb.CLOSED})),this.websocket.on(Ib.FAILED,(()=>{this._disconnectedReason=IR.NETWORK_ERROR,this.connectionState=Tb.CLOSED})),this.websocket.on(Ib.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Tb.CONNECTED?this.connectionState=Tb.RECONNECTING:this.connectionState=Tb.CONNECTING})),this.websocket.on(Ib.WILL_RECONNECT,((e,t,n)=>{const i=xR(this,Sb.IS_P2P_DISCONNECTED),r=i||"retry"!==e;i&&"retry"===e&&(Qw.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",t=qb.P2P_DISCONNECTED),r&&(Qw.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(Sb.REPORT_JOIN_GATEWAY,t||qb.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(Sb.NEED_RENEW_SESSION,this.websocket.currentURLIndex>=this.websocket.urls.length-1?"recover":e),this.emit(Sb.DISCONNECT_P2P)),n(e)})),this.websocket.on(Ib.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{Qw.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",DR.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(Sb.REPORT_JOIN_GATEWAY,e.message||e.code||qb.UNKNOWN_REASON,this.url||""),e instanceof bb){if(e.code===tR.UNEXPECTED_RESPONSE&&e.data.code===vb.ERR_NO_AUTHORIZED)return this.initError=new bb(tR.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),Qw.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",DR.SERVER_ERROR);Qw.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",DR.SERVER_ERROR):(this.initError=e,this.close())}}))})),this.websocket.on(Ib.REQUEST_NEW_URLS,((e,t)=>{LR(this,Sb.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(Ib.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Rb.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}let BA=function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e}({});function GA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function WA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?GA(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):GA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function HA(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(Dw("TURN_DOMAIN")):(Qw.info("Unidentified as ip: ".concat(e,", use as host")),e)}function KA(e,t){e.addresses||(e.addresses=[]);const n=function(e,t){if(Dw("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return e.map((e=>{let{ip:t,port:n}=e;return{address:"".concat(t,":").concat(n)}}));const n=Dw("GATEWAY_DOMAINS");let i=n[1]&&Pi(t).call(t,n[1])?1:0;return e.map((e=>{let{domain_prefix:t,port:r,ip:o}=e;if(t)return{address:"".concat(t,".").concat(n[i++%n.length],":").concat(r)};const s=/^[\.\:\d]+$/.test(o),a=s?"".concat(o.replace(/[^\d]/g,"-"),".").concat(n[i++%n.length],":").concat(r):"".concat(o,":").concat(r);return s||Qw.info("Unidentified as ip: ".concat(o,", use as host")),{ip:o,port:r,address:a}}))}(e.addresses,t),i=Array.isArray(e.detail)&&e.detail[18];if(i&&"string"==typeof i){const e=i.split(";");for(let t=0;t<e.length;t++){var r;const i=Bp(r=e[t]).call(r);n[t]&&i&&(n[t].ip6=i)}}return{gatewayAddrs:n,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function zA(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function qA(e){const t=e._encoderConfig;if(!t)return{};const n={resolution:t.width&&t.height?"".concat(zA(t.width),"x").concat(zA(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return"number"==typeof t.frameRate?(n.maxFrameRate=t.frameRate,n.minFrameRate=t.frameRate):t.frameRate&&(n.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,n.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),n}function YA(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function JA(e,t){let n,i,r;switch(t){case BA.CHOOSE_SERVER:i=4096,r="choose server";break;case BA.CLOUD_PROXY:i=1048576,r="proxy";break;case BA.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case BA.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new bb(tR.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((t=>{t.buffer&&t.buffer.flag===i&&(n={code:t.buffer.code,addresses:(t.buffer.edges_services||[]).map((e=>WA(WA({},e),{},{ticket:t.buffer.cert}))),server_ts:e.enter_ts,uid:t.buffer.uid,cid:t.buffer.cid,cname:t.buffer.cname,detail:WA(WA({},t.buffer.detail),e.detail),flag:t.buffer.flag,opid:e.opid,cert:t.buffer.cert})})),!n)throw new bb(tR.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return n}async function XA(e,t){return await Gh.all(e.addresses.map((async e=>({address:HA(e.ip),tcpport:e.port,udpport:e.port,username:t&&Dw("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():aI.username,password:t&&Dw("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await gR(t.toString()):aI.password}))))}function QA(e,t){const n=t.getMediaStreamTrack(!0).getSettings(),i=t.videoHeight||n.height,r=t.videoWidth||n.width;return i&&r?Math.max(Math.min(i,r)/Math.min(zA(e.height),zA(e.width)),1):(Qw.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function ZA(e){let{candidateType:t,relayProtocol:n,type:i,address:r,port:o,protocol:s}=e;return"local-candidate"===i?{candidateType:t,relayProtocol:n,protocol:s}:{candidateType:t,relayProtocol:n,address:r,port:o,protocol:s}}function $A(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class eO extends vR{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;Pi(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(pA.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(pA.CONNECTED):"closed"===this._state?this.emit(pA.CLOSED):"failed"===this._state&&this.emit(pA.FAILED))}constructor(e,t,n,i){super(),iT(this,"connectionID",0),iT(this,"currentURLIndex",0),iT(this,"reconnectReason",void 0),iT(this,"_reconnectMode","tryNext"),iT(this,"_initMutex",void 0),iT(this,"_name",void 0),iT(this,"_state","closed"),iT(this,"_reconnectInterrupter",void 0),iT(this,"_url",void 0),iT(this,"_retryConfig",void 0),iT(this,"_reconnectCount",0),iT(this,"_forceCloseTimeout",5e3),iT(this,"_onlineReconnectListener",void 0),iT(this,"_closeEstablishingTransmitter",(()=>{})),iT(this,"_store",void 0),iT(this,"_joinChannelServiceRecordIndex",void 0),iT(this,"_transmitter",void 0),iT(this,"_useCompress",void 0),iT(this,"_inflateLength",0),iT(this,"_deflateLength",0),this._store=i,this._name=e,this._retryConfig=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$A(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$A(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},t),this._useCompress=n}resetReconnectCount(e){Qw.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const e=this._transmitter;t?setTimeout((()=>e.close()),500):e.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,t){if(!this._transmitter)return void Qw.warning("[".concat(this._name,"] can not reconnect, no websocket"));var n;void 0!==e&&(this.reconnectMode=e),Qw.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex&&(null===(n=this._store)||void 0===n||n.recordJoinChannelService({status:"error",errors:[new Error(t)]},this._joinChannelServiceRecordIndex));const i=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),i&&i.bind(this._transmitter)({code:9999,reason:t})}getInflateData(){const e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let tO=function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e}({});class nO{constructor(e,t,n){iT(this,"version",1),iT(this,"initialRTO",void 0),iT(this,"maxBatchAckCount",void 0),iT(this,"maxRTO",void 0),iT(this,"initialRTT",void 0),iT(this,"ID",void 0),iT(this,"rtt",void 0),iT(this,"packetNumber",1),iT(this,"rtoRatioMap",new Map),iT(this,"timeoutMap",new Map),iT(this,"unorderedPacketQueue",[]),iT(this,"batchAckPacketQueue",[]),iT(this,"lastOrderedPacketNumber",0),iT(this,"batchAckTimer",void 0),iT(this,"sendImpl",void 0),iT(this,"receiveImpl",void 0),this.sendImpl=e,this.receiveImpl=t,this.ID=ew(7,"transmitter-"),this.initialRTO=void 0!==(null==n?void 0:n.initialRTO)?n.initialRTO:Dw("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==n?void 0:n.initialRTT)?n.initialRTT:Dw("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==n?void 0:n.initialRTT)?n.initialRTT:Dw("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==n?void 0:n.maxBatchAckCount)?n.maxBatchAckCount:Dw("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==n?void 0:n.maxRTO)?n.maxRTO:Dw("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:tO.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case tO.Default:{let t;t="string"==typeof e.payload?(new TextEncoder).encode(e.payload):e.payload;const n=new ArrayBuffer(t.length+15),i=new DataView(n);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.packetNumber),hR(i,7,BigInt(e.sendTs)),new Uint8Array(i.buffer).set(t,15),n}case tO.Ack:{const t=new ArrayBuffer(16),n=new DataView(t);return n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.maxAckPacketNumber),n.setUint8(7,e.shift),hR(n,8,BigInt(e.ackSendTs)),t}}}deserialize(e){const t=new DataView(e),n=t.getUint16(0),i=t.getUint8(2);switch(i){case tO.Default:{const r=t.getUint32(3),o=uR(t,7),s=e.slice(15),a=(new TextDecoder).decode(s);return{version:n,type:i,packetNumber:r,sendTs:Number(o),payload:a}}case tO.Ack:{const e=t.getUint32(3),r=t.getUint8(7),o=uR(t,8);return{version:n,type:i,maxAckPacketNumber:e,shift:r,ackSendTs:Number(o)}}default:throw Qw.error("[".concat(this.ID,"] Unrecognized packet type ").concat(i)),new Error("Unrecognized packet type ".concat(i))}}sendMessage(e){const t=this.packetize(e,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const n=this.calculateRTO(t),i=window.setTimeout((()=>{this.resendMessage(t)}),n);this.timeoutMap.set(t.packetNumber,i),this.sendPacket(t)}onData(e){const t=this.deserialize(e);t.type===tO.Default?this.ack(t):t.type===tO.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[t,n]=e;window.clearTimeout(n)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const t=this.calculateRTO(e),n=window.setTimeout((()=>{this.resendMessage(e)}),t);this.timeoutMap.set(e.packetNumber,n),this.sendPacket(e)}calculateRTO(e){const t=this.rtoRatioMap.get(e.packetNumber);if(void 0===t)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const n=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),n>this.maxRTO?this.maxRTO:n}}updateRTT(e,t){const n=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-n-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:tO.Ack,version:this.version};this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:tO.Ack,version:this.version};this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:tO.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===tO.Default&&(e.sendTs=Math.round(performance.now()));const t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){const e=this.timeoutMap.get(t);void 0!==e&&window.clearTimeout(e),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class iO extends eO{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),iT(this,"_initMutex",void 0),iT(this,"_reconnectInterrupter",void 0),iT(this,"_url",void 0),iT(this,"_transmitter",void 0),iT(this,"_addresses",void 0),iT(this,"_reliableTransmission",void 0),this._initMutex=new hw("datachannel");const{timeout:n,timeoutFactor:i}=t,r=Math.max(300,Math.floor(3*n/5)),o=Math.max(1.2,Math.floor(8*i)/10);PR.ONLINE&&(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=o),VR.on(kR.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===PR.ONLINE?(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=n,this._retryConfig.timeoutFactor=i))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=t;const n=(t,n)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((e=>e.fingerprint||Dw("FINGERPRINT")));const i=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(i).then(t).catch(n),this.once(pA.CLOSED,(()=>n(new bb(tR.WS_DISCONNECT)))),this.once(pA.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new Gh(((e,t)=>{n(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new bb(tR.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(e){throw new bb(tR.WS_ERR,"send datachannel signal message error"+e.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new Gh(((t,n)=>{var i;const r=()=>{Qw.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),t()},o=async e=>{var i;if(null===(i=this._closeEstablishingTransmitter)||void 0===i||i.call(this),Qw.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const i=UR(this,pA.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,r=await this.reconnectWithAction(i);if("closed"===this.state)return void Qw.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!r)return n(new bb(tR.WS_DISCONNECT,"datachannel reconnect failed: ".concat(e.code))),void this.close(!0);t()}else n(new bb(tR.WS_DISCONNECT,"datachannel close: ".concat(e.code))),this.close()},s=e=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.onData(e.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),Qw.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const a=null===(i=this._store)||void 0===i?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),c=Date.now();LR(this,pA.TO_CONNECT_DATACHANNEL,e).then((e=>{var t,n;if(!e)throw new Error("transmissonInfo not exist yet");const{transmitter:i,close:l}=e;this._transmitter=i,null===(t=this._store)||void 0===t||t.signalChannelOpen();const d=Date.now()-c;Qw.debug("[choose dc] dc open cost ".concat(d,"ms")),this._reliableTransmission=new nO((e=>{var t;this._transmitter&&"open"===this._transmitter.readyState&&(null===(t=this._transmitter)||void 0===t||t.send(e))}),(e=>{"string"==typeof e&&this.emit(pA.ON_MESSAGE,e)})),this._closeEstablishingTransmitter=()=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.close(),this._reliableTransmission=void 0,l()},r&&r(),i.onclose=o,i.onmessage=s,null===(n=this._store)||void 0===n||n.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this._joinChannelServiceRecordIndex=a})).catch((e=>{var t;if(null===(t=this._store)||void 0===t||t.recordJoinChannelService({endTs:Date.now(),status:e instanceof bb&&e.code===tR.WS_ABORT?"aborted":"error",errors:[e]},a),"closed"!==this.state){if(e instanceof bb&&e.code===tR.WS_ERR){const t=new bb(tR.WS_ERR,"init datachannel failed! Error: ".concat(e.toString()));return Qw.error("[".concat(this._name,"]").concat(t)),void n(t)}o&&o(e)}else n(new bb(tR.WS_DISCONNECT,"datachannel is closed: ".concat(e.toString())))}))}))}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||VR.networkState!==PR.OFFLINE||(this._onlineReconnectListener=VR.onlineWaiter&&VR.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let n=!0;if(this._reconnectInterrupter=()=>{n=!1},t){const t=mw(this._reconnectCount,this._retryConfig);Qw.debug("[".concat(this._name,"] wait ").concat(t,"ms to reconnect datachannel, mode: ").concat(e)),await Gh.race([$R(t),this._onlineReconnectListener||new Gh((()=>{}))])}if("closed"===this.state||!n)return!1;this._reconnectCount+=1;const i=async(e,t)=>{this.emit(pA.RECONNECT_CREATE_CONNECTION,t),await this.createTransmitterConnection(e)};try{if("retry"===e){const t=this._addresses[this.currentURLIndex];this.emit(pA.RECONNECT_WAITTING_FINISH,e),await i(t,e)}else if("tryNext"===e){this.currentURLIndex+=1;for(let e=this.currentURLIndex;e<this._addresses.length;e++){if(this._addresses[e].fingerprint||Dw("FINGERPRINT")){this.currentURLIndex=e;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return Qw.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);Qw.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const t=this._addresses[this.currentURLIndex];this.emit(pA.RECONNECT_WAITTING_FINISH,e),await i(t,e)}else"recover"===e&&(Qw.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(pA.RECONNECT_WAITTING_FINISH,e),this.emit(pA.FAILBACK));return!0}catch(n){var r,o;return Qw.error("[".concat(this._name,"] reconnect failed"),n.toString()),null!=n&&null!==(r=n.data)&&void 0!==r&&r.desc&&Array.isArray(n.data.desc)&&n.data.desc.length&&Pi(o=n.data.desc).call(o,"dynamic key expired")?(this.emit(pA.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,t)}}}class rO extends vR{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Tb.CONNECTED?this.emit(Sb.WS_CONNECTED):e===Tb.RECONNECTING?this.emit(Sb.WS_RECONNECTING,this._websocketReconnectReason):e===Tb.CLOSED&&this.emit(Sb.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),iT(this,"_disconnectedReason",void 0),iT(this,"_websocketReconnectReason",void 0),iT(this,"_connectionState",Tb.CLOSED),iT(this,"reconnectToken",void 0),iT(this,"websocket",void 0),iT(this,"openConnectionTime",void 0),iT(this,"clientId",void 0),iT(this,"lastMsgTime",Date.now()),iT(this,"uploadCache",[]),iT(this,"uploadCacheInterval",void 0),iT(this,"rttRolling",new Ew(5)),iT(this,"pingpongTimer",void 0),iT(this,"inflateDataTimer",void 0),iT(this,"pingpongTimeoutCount",0),iT(this,"joinResponse",void 0),iT(this,"multiIpOption",void 0),iT(this,"initError",void 0),iT(this,"spec",void 0),iT(this,"store",void 0),iT(this,"onWebsocketMessage",(e=>{if(e instanceof ArrayBuffer)return void this.emit(Sb.ON_BINARY_DATA,e);const t=JSON.parse(e);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")&&(this.emit(t._type,t._message),t._type===Rb.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===Rb.ON_USER_BANNED))switch(t._message.error_code){case 14:this.close(IR.UID_BANNED);break;case 15:this.close(IR.IP_BANNED);break;case 16:this.close(IR.CHANNEL_BANNED)}})),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new iO("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===Tb.CONNECTED&&this.reconnect("retry",hA.OFFLINE)}))}async request(e,t,n,i){const r=ew(6,""),o={_id:r,_type:e,_message:t},s=this.websocket.connectionID,a=()=>new Gh(((t,n)=>{if(this.connectionState===Tb.CONNECTED)return t();const i=()=>{this.off(Sb.WS_CLOSED,r),t()},r=()=>{this.off(Sb.WS_CONNECTED,i),n(new bb(tR.WS_ABORT))};this.once(Sb.WS_CONNECTED,i),this.once(Sb.WS_CLOSED,r),e!==yb.PUBLISH&&e!==yb.SUBSCRIBE&&e!==yb.UNSUBSCRIBE&&e!==yb.UNPUBLISH&&e!==yb.CONTROL&&e!==yb.RESTART_ICE||this.once(Sb.DISCONNECT_P2P,(()=>{n(new bb(tR.DISCONNECT_P2P))})),e!==yb.PUBLISH&&e!==yb.RESTART_ICE||this.once(Sb.ABORT_P2P_EXECUTION,(()=>{n(new bb(tR.DISCONNECT_P2P))}))}));if(this.connectionState!==Tb.CONNECTING&&this.connectionState!==Tb.RECONNECTING||e===yb.JOIN||e===yb.REJOIN||await a(),e===yb.LEAVE&&(this.websocket.unbindDcCloseEventListener(),i=!0),this.websocket.sendMessage(o,!0,!1),i)return;const c=new Gh(((n,i)=>{let o=!1;const a=(i,r)=>{o=!0,n({isSuccess:"success"===i,message:r||{}}),this.off(Sb.WS_CLOSED,c),this.off(Sb.WS_RECONNECTING,c),this.emit(Sb.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(r),a);const c=()=>{i(new bb(tR.WS_ABORT,"type: ".concat(e))),this.off(Sb.WS_CLOSED,c),this.off(Sb.WS_RECONNECTING,c),this.off("res-@".concat(r),a)};this.once(Sb.WS_CLOSED,c),this.once(Sb.WS_RECONNECTING,c),$R(Dw("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==s||o||(Qw.warning("dc request timeout, type: ".concat(e)),this.emit(Sb.REQUEST_TIMEOUT,e,t))}))}));let l=null;try{l=await c}catch(i){if(this.connectionState===Tb.CLOSED||e===yb.LEAVE)throw new bb(tR.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?i.throw():e===yb.JOIN||e===yb.REJOIN?null:(await a(),await this.request(e,t))}if(l.isSuccess)return l.message;const d=Number(l.message.error_code||l.message.code),u=wA(d),h=new bb(tR.UNEXPECTED_RESPONSE,"".concat(u.desc,": ").concat(l.message.error_str),{code:d,data:l.message});return"success"===u.action?l.message:(Qw.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(d,", message: ").concat(u.desc,", action: ").concat(u.action)),d===vb.ERR_TOO_MANY_BROADCASTERS?e===yb.JOIN||e===yb.REJOIN?(this.initError=h,this.close(),h.throw()):h.throw():"failed"===u.action?h.throw():"quit"===u.action?(this.initError=h,this.close(),h.throw()):(d===vb.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,Qw.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",hA.MULTI_IP)):this.reconnect(u.action,hA.SERVER_ERROR),e===yb.JOIN||e===yb.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Gh((n=>{const i=r=>{(!t||t(r))&&(this.off(e,i),n(r))};this.on(e,i)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void Qw.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Cb.WRTC_STATS,t)}upload(e,t){const n={_type:e,_message:t};try{this.websocket.sendMessage(n)}catch(e){const t=Dw("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==Tb.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),Dw("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const n={_type:e,_message:t};this.websocket.sendMessage(n)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Gh(((n,i)=>{this.once(Sb.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(Sb.WS_CLOSED,(()=>i(this.initError||new bb(tR.WS_ABORT)))),this.connectionState=Tb.CONNECTING,this.websocket.init(e).catch(i),this.websocket.once(pA.FAILBACK,(()=>{void 0===this.openConnectionTime&&i(new bb(tR.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{t&&void 0===this.openConnectionTime&&(Qw.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),i(new bb(tR.INIT_DATACHANNEL_TIMEOUT)))}),Dw("DC_JOIN_WITH_FAILBACK"))}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||IR.LEAVE,this.connectionState=Tb.CLOSED,Qw.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===IR.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new iO("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(Sb.ABORT_P2P_EXECUTION);const e=await LR(this,Sb.DATACHANNEL_CONNECTING),t=await this.request(yb.JOIN,e);if(!t)return this.emit(Sb.REPORT_JOIN_GATEWAY,tR.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(Sb.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Tb.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new bb(tR.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=xR(this,Sb.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(yb.REJOIN,e);return!!t&&(this.connectionState=Tb.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(Rb.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(Rb.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(Rb.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(Rb.MUTE_AUDIO,{uid:e.uid}):this.emit(Rb.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(Rb.MUTE_VIDEO,{uid:e.uid}):this.emit(Rb.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(Rb.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(Rb.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(Rb.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(Rb.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(Rb.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){Qw.debug("[".concat(this.clientId,"] receive notification: "),e);const t=wA(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(IR.UID_BANNED),void this.close()):void this.reconnect(t.action,hA.SERVER_ERROR);Qw.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Dw("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(Qw.warning("PINGPONG Timeout. Last Socket Message: ".concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>Dw("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",hA.TIMEOUT):this.request(yb.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),Dw("REPORT_STATS")&&this.send(yb.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();0!==e&&0!==t&&this.upload(Cb.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(pA.RECONNECT_WAITTING_FINISH,(e=>{this.emit(Sb.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(pA.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(Sb.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(pA.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(pA.CLOSED,(()=>{this.connectionState=Tb.CLOSED})),this.websocket.on(pA.FAILED,(()=>{this._disconnectedReason=IR.NETWORK_ERROR,this.connectionState=Tb.CLOSED})),this.websocket.on(pA.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Tb.CONNECTED?this.connectionState=Tb.RECONNECTING:this.connectionState=Tb.CONNECTING})),this.websocket.on(pA.WILL_RECONNECT,((e,t)=>{if(xR(this,Sb.IS_P2P_DISCONNECTED)&&"retry"===e)return Qw.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Sb.NEED_RENEW_SESSION),this.emit(Sb.DISCONNECT_P2P),t("tryNext");"retry"!==e&&(Qw.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(Sb.NEED_RENEW_SESSION),this.emit(Sb.DISCONNECT_P2P)),t(e)})),this.websocket.on(pA.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{Qw.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",hA.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(Sb.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof bb&&e.code===tR.UNEXPECTED_RESPONSE&&e.data.code===vb.ERR_NO_AUTHORIZED)return Qw.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",hA.SERVER_ERROR);Qw.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",hA.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(pA.REQUEST_NEW_URLS,((e,t)=>{LR(this,Sb.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(pA.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Rb.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(pA.TO_CONNECT_DATACHANNEL,(async(e,t,n)=>LR(this,Sb.DATACHANNEL_PRECONNECT,e).then(t).catch(n))),this.websocket.on(pA.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(Sb.DATACHANNEL_FAILBACK)}))}}class oO extends vR{constructor(e,t){super(),iT(this,"signal",void 0),iT(this,"token",void 0),iT(this,"tokenTimeout",void 0),iT(this,"tokenInterval",void 0),iT(this,"_sequence",0),iT(this,"userMap",new Map),iT(this,"encoder",new TextEncoder),this.signal=e,this.token=t;const n=()=>{this.signal.connectionState===Tb.CONNECTED&&this.check(),0===this.userMap.size?this.tokenInterval=window.setTimeout(n,1e3):this.tokenInterval=window.setTimeout(n,3*Dw("P2P_TOKEN_INTERVAL"))};n()}async send(e,t,n,i,r){var o,s,a;if(0===this.userMap.size)return;const c=Array.from(hb(o=this.userMap).call(o))[0].token;"string"!=typeof t&&(t=JSON.stringify(t)),i=null!==(s=i)&&void 0!==s?s:ew(6,""),r=null!==(a=r)&&void 0!==a?a:this._sequence++;const l={_id:i,_type:e,_seq:r,_message:t,token:"".concat(this.token,"_").concat(c)};Dw("SHOW_P2P_LOG")&&Qw.debug("send message",l,"noNeedResponse : ".concat(n)),this.splitMessage(JSON.stringify(l)).forEach((e=>{this.signal.request(yb.DATA_STREAM,{payload:qR(this.encoder.encode(e))})}));const d=new Gh(((t,r)=>{const o=window.setTimeout((()=>{this.off("res-@".concat(i,"_ack"),s),this.off("res-@".concat(i),c),this.off(vA.ABORT,a),Qw.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(i)),0===this.userMap.size?r(new nR(tR.INVALID_REMOTE_USER)):r(new nR(tR.TIMEOUT))}),Dw("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),s=()=>{o&&window.clearTimeout(o),this.off(vA.ABORT,a),n&&t()},a=()=>{o&&window.clearTimeout(o),this.off("res-@".concat(i,"_ack"),s),this.off("res-@".concat(i),c),r(new nR(tR.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(i)))};this.once(vA.ABORT,a),this.once("res-@".concat(i,"_ack"),s);const c=(n,c)=>{d=!0,o&&window.clearTimeout(o),this.off("res-@".concat(i,"_ack"),s),this.off(vA.ABORT,a),"success"===n?t(c):r(new nR(tR.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(i)))};let d=!1;n||(this.once("res-@".concat(i),c),$R(Dw("SIGNAL_REQUEST_TIMEOUT")).then((()=>{d||Qw.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(i,", ").concat(l))})))}));try{return await d}catch(o){if(o.code===tR.TIMEOUT)return await this.send(e,t,n,i,r);throw o}}onMessage(e){var t;const{_uid:n}=e;let i,r=this.userMap.get(n);if(r)i=r.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==gA.CHECK)return;const{token:t}=e;i=new Map,r={uid:n,isStart:!0,token:t,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(n,r),this.signal.emit(Rb.ON_USER_ONLINE,{uid:n}),this.handleUserOnline()}if("id"in e&&"total"in e){var o;const{id:t,total:r}=e,s=null!==(o=i.get(t))&&void 0!==o?o:[];if(s.push(e),i.has(t)||i.set(t,s),s.length!==r)return;{const r=sm(s).call(s,((e,t)=>e.index-t.index)).map((e=>e.payload)).join("");i.delete(t),(e=JSON.parse(r))._uid=n}}const{_type:s,token:a}=e;if(Pi(t=[gA.ACK,gA.CHECK]).call(t,s))return s===gA.CHECK&&this.handleCheckToken(r,a),void this.receiveMessage(e);a==="".concat(r.token,"_").concat(this.token)?this.handleReceivedMessage(e):Qw.debug('Receive unexpected message", '.concat(a,", cur_token: ").concat(r.token,"_").concat(this.token),e)}check(){const e={_id:ew(6,""),token:this.token,_type:gA.CHECK};Dw("SHOW_P2P_LOG")&&Qw.debug("send message",e),this.signal.request(yb.DATA_STREAM,{payload:qR(this.encoder.encode(JSON.stringify(e)))})}ack(e){const t={_id:e,_type:gA.ACK,token:this.token};Dw("SHOW_P2P_LOG")&&Qw.debug("send message",t),this.signal.request(yb.DATA_STREAM,{payload:qR(this.encoder.encode(JSON.stringify(t)))})}response(e,t,n){this.send(gA.RESPONSE,JSON.stringify({success:!n,message:t}),!0,e)}handleReceivedMessage(e){const t=()=>{this.userMap.forEach((e=>{const{receivedMessagesMap:t,nextExpectedSequenceNumber:n}=e;for(;t.has(n);){const i=t.get(n);t.delete(n),this.receiveMessage(i),e.nextExpectedSequenceNumber++}}))};if(!e)return void t();const{_uid:n,_seq:i}=e,r=this.userMap.get(n),{receivedMessagesMap:o,isStart:s,nextExpectedSequenceNumber:a}=r;if(i<a)return this.ack(e._id),void Qw.debug("[external-signal] receive old message, seq: ".concat(i,", ").concat(e._message));o.set(i,e),s&&i===a&&(this.receiveMessage(e),o.delete(a),r.nextExpectedSequenceNumber++,t())}receiveMessage(e){const{_id:t,_type:n,_message:i,_uid:r}=e;if(Dw("SHOW_P2P_LOG")&&Qw.debug("receive message",e),t){let o;switch(e._type!==gA.ACK&&(i&&(o=JSON.parse(i)),this.ack(e._id)),e._type){case gA.CANDIDATE:case gA.CONTROL:this.signal.emit(n,o,r);break;case gA.PUBLISH:case gA.UNPUBLISH:case gA.RESTART_ICE:case gA.CALL:o.uid=r,LR(this.signal,n,o).then((t=>{this.response(e._id,t)})).catch((()=>{this.response(e._id,void 0,!0)}));break;case gA.ACK:this.getListeners("res-@".concat(t,"_ack")).length>0&&this.emit("res-@".concat(t,"_ack"));break;case gA.RESPONSE:{const{success:e,message:n}=o;this.emit("res-@".concat(t),e?"success":"failed",n);break}}}}splitMessage(e){if(e.length<oO.MAX_MESSAGE_SIZE)return[e];const t=[],{remoteToken:n}=JSON.parse(e),i=ew(6,"");let r=0,o=800;const s=Math.ceil(e.length/o);for(;e.length>0;){r++;const a={id:i,index:r,total:s,payload:e.slice(0,o),token:"".concat(this.token,"_").concat(n)};JSON.stringify(a).length>oO.MAX_MESSAGE_SIZE?o-=50:(t.push(a),e=e.slice(o))}return t.map((e=>JSON.stringify(e)))}handleCheckToken(e,t){return e.token!==t?(Qw.debug("token changed, from ".concat(e.token," to ").concat(t)),this.reset(e.uid,t),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{Qw.debug("token timeout, ".concat(t)),this.reset(e.uid)}),Dw("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await LR(this.signal,gA.CALL,void 0),t=await this.send(gA.CALL,e);this.signal.emit(Sb.P2P_CONNECTION,t,!0)}async reset(e,t){const n=this.userMap.get(e);n&&(this.emit(vA.ABORT),this.signal.emit(Rb.ON_USER_OFFLINE,{uid:n.uid,reason:SA.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),t||(Qw.debug("change local token from ".concat(t," to ").concat(t)),this.token=ew(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(vA.ABORT)}}iT(oO,"MAX_SIZE",1),iT(oO,"MAX_MESSAGE_SIZE",1024);class sO extends vR{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===Tb.CONNECTED?this.emit(Sb.WS_CONNECTED):e===Tb.RECONNECTING?this.emit(Sb.WS_RECONNECTING,this._websocketReconnectReason):e===Tb.CLOSED&&this.emit(Sb.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),iT(this,"_disconnectedReason",void 0),iT(this,"_websocketReconnectReason",void 0),iT(this,"_connectionState",Tb.CLOSED),iT(this,"reconnectToken",void 0),iT(this,"p2pToken",void 0),iT(this,"websocket",void 0),iT(this,"openConnectionTime",void 0),iT(this,"clientId",void 0),iT(this,"lastMsgTime",Date.now()),iT(this,"uploadCache",[]),iT(this,"uploadCacheInterval",void 0),iT(this,"rttRolling",new Ew(5)),iT(this,"pingpongTimer",void 0),iT(this,"pingpongTimeoutCount",0),iT(this,"joinResponse",void 0),iT(this,"multiIpOption",void 0),iT(this,"initError",void 0),iT(this,"spec",void 0),iT(this,"store",void 0),iT(this,"_external_signal",void 0),iT(this,"onWebsocketMessage",(e=>{if(e.data instanceof ArrayBuffer)return void this.emit(Sb.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){switch(t._type){case Rb.ON_DATA_STREAM:return void this.handleDataStream(t._message);case Rb.MUTE_AUDIO:case Rb.MUTE_VIDEO:case Rb.ON_P2P_LOST:case Rb.ON_USER_ONLINE:return;case Rb.ON_USER_OFFLINE:const{uid:e}=t._message;return Qw.debug("[".concat(this.clientId,"] user-offline uid: ").concat(e)),void this._external_signal.reset(e)}if(this.emit(t._type,t._message),t._type===Rb.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===Rb.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(IR.UID_BANNED);break;case 15:this.close(IR.IP_BANNED);break;case 16:this.close(IR.CHANNEL_BANNED)}if(t._type===Rb.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case vb.ERR_LICENSE_MISSING:this.close(IR.LICENSE_MISSING);break;case vb.ERR_LICENSE_EXPIRED:this.close(IR.LICENSE_EXPIRED);break;case vb.ERR_LICENSE_MINUTES_EXCEEDED:this.close(IR.LICENSE_MINUTES_EXCEEDED);break;case vb.ERR_LICENSE_PERIOD_INVALID:this.close(IR.LICENSE_PERIOD_INVALID);break;case vb.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(IR.LICENSE_MULTIPLE_SDK_SERVICE);break;case vb.ERR_LICENSE_ILLEGAL:this.close(IR.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new VA("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Dw("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Dw("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===Tb.CONNECTED&&this.reconnect("retry",DR.OFFLINE)})),this.p2pToken=ew(6,""),this._external_signal=new oO(this,this.p2pToken)}async request(e,t,n,i){const r=ew(6,""),o={_id:r,_type:e,_message:t},s=this.websocket.connectionID,a=()=>new Gh(((e,t)=>{if(this.connectionState===Tb.CONNECTED)return e();const n=()=>{this.off(Sb.WS_CLOSED,i),e()},i=()=>{this.off(Sb.WS_CONNECTED,n),t(new nR(tR.WS_ABORT))};this.once(Sb.WS_CONNECTED,n),this.once(Sb.WS_CLOSED,i)}));if(this.connectionState!==Tb.CONNECTING&&this.connectionState!==Tb.RECONNECTING||e===yb.JOIN||e===yb.REJOIN||await a(),this.websocket.sendMessage(o,!0),i)return;const c=new Gh(((n,i)=>{let o=!1;const a=(i,r)=>{o=!0,n({isSuccess:"success"===i,message:r||{}}),this.off(Sb.WS_CLOSED,c),this.off(Sb.WS_RECONNECTING,c),this.emit(Sb.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(r),a);const c=()=>{i(new nR(tR.WS_ABORT,"type: ".concat(e))),this.off(Sb.WS_CLOSED,c),this.off(Sb.WS_RECONNECTING,c),this.off("res-@".concat(r),a)};this.once(Sb.WS_CLOSED,c),this.once(Sb.WS_RECONNECTING,c),$R(Dw("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==s||o||(Qw.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Sb.REQUEST_TIMEOUT,e,t))}))}));let l=null;try{l=await c}catch(i){if(this.connectionState===Tb.CLOSED||e===yb.LEAVE)throw new nR(tR.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?i.throw():e===yb.JOIN||e===yb.REJOIN?null:(await a(),await this.request(e,t))}if(l.isSuccess)return l.message;const d=Number(l.message.error_code||l.message.code),u=wA(d),h=new nR(tR.UNEXPECTED_RESPONSE,"".concat(u.desc,": ").concat(l.message.error_str),{code:d,data:l.message});return"success"===u.action?l.message:(Qw.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(d,", message: ").concat(u.desc,", action: ").concat(u.action)),d===vb.ERR_TOO_MANY_BROADCASTERS?e===yb.JOIN||e===yb.REJOIN?(this.initError=h,this.close(),h.throw()):h.throw():"failed"===u.action?h.throw():"quit"===u.action?(this.initError=h,this.close(),h.throw()):(d===vb.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,Qw.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",DR.MULTI_IP)):this.reconnect(u.action,DR.SERVER_ERROR),e===yb.JOIN||e===yb.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Gh((n=>{const i=r=>{(!t||t(r))&&(this.off(e,i),n(r))};this.on(e,i)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void Qw.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Cb.WRTC_STATS,t)}upload(e,t){const n={_type:e,_message:t};try{this.websocket.sendMessage(n)}catch(e){const t=Dw("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==Tb.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),Dw("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const n={_type:e,_message:t};this.websocket.sendMessage(n)}async sendExtensionMessage(e,t,n){return await this._external_signal.send(e,t,n)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Gh(((t,n)=>{this.once(Sb.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(Sb.WS_CLOSED,(()=>n(this.initError||new nR(tR.WS_ABORT)))),this.connectionState=Tb.CONNECTING,this.websocket.init(e).catch(n)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||IR.LEAVE,this.connectionState=Tb.CLOSED,Qw.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===IR.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new VA("gateway-".concat(this.clientId),this.spec.retryConfig,!0,Dw("JOIN_GATEWAY_USE_DUAL_DOMAIN"),Dw("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=ew(6,""),this._external_signal.clear(),this._external_signal=new oO(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(Sb.ABORT_P2P_EXECUTION);const e=await LR(this,Sb.REQUEST_JOIN_INFO),t=await this.request(yb.JOIN,e);if(!t)return this.emit(Sb.REPORT_JOIN_GATEWAY,tR.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(Sb.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Tb.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleDataStream(e){try{var t;const n=zR(e.payload),i=(new TextDecoder).decode(n),r=JSON.parse(i);"total"in r&&"id"in r||Pi(t=Object.values(gA)).call(t,r._type)?(r._uid=e.uid,this._external_signal.onMessage(r)):this.emit(Rb.ON_DATA_STREAM,e)}catch(t){this.emit(Rb.ON_DATA_STREAM,e)}}handleNotification(e){Qw.debug("[".concat(this.clientId,"] receive notification: "),e);const t=wA(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(IR.UID_BANNED),void this.close()):void this.reconnect(t.action,DR.SERVER_ERROR);Qw.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=Dw("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(Qw.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>Dw("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",DR.TIMEOUT):this.request(yb.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),Dw("REPORT_STATS")&&this.send(yb.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWebsocketEvents(){this.websocket.on(Ib.RECONNECT_WAITTING_FINISH,(e=>{this.emit(Sb.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(Ib.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(Sb.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(Ib.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ib.CLOSED,(()=>{this.connectionState=Tb.CLOSED})),this.websocket.on(Ib.FAILED,(()=>{this._disconnectedReason=IR.NETWORK_ERROR,this.connectionState=Tb.CLOSED})),this.websocket.on(Ib.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===Tb.CONNECTED?this.connectionState=Tb.RECONNECTING:this.connectionState=Tb.CONNECTING})),this.websocket.on(Ib.WILL_RECONNECT,((e,t,n)=>{"retry"!==e?(Qw.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(Sb.NEED_RENEW_SESSION)):Qw.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),n(e)})),this.websocket.on(Ib.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((e=>{if(this.emit(Sb.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof nR&&e.code===tR.UNEXPECTED_RESPONSE&&e.data.code===vb.ERR_NO_AUTHORIZED)return Qw.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",DR.SERVER_ERROR);Qw.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",DR.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(Ib.REQUEST_NEW_URLS,((e,t)=>{LR(this,Sb.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(Ib.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Rb.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}function aO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function cO(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?aO(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):aO(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const lO=new Map;class dO extends vR{get state(){return this._state}set state(e){if(e===this._state)return;const t=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(zb.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(zb.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){Qw.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){super(),iT(this,"store",void 0),iT(this,"joinInfo",void 0),iT(this,"key",void 0),iT(this,"ntpOffset",0),iT(this,"signal",void 0),iT(this,"role",void 0),iT(this,"inChannelInfo",{joinAt:null,duration:0}),iT(this,"spec",void 0),iT(this,"_state","DISCONNECTED"),iT(this,"_statsCollector",void 0),iT(this,"_disconnectedReason",void 0),iT(this,"isSignalRecover",!1),iT(this,"hasChangeBGPAddress",!1),iT(this,"trafficStatsInterval",void 0),iT(this,"networkQualityInterval",void 0),iT(this,"_joinGatewayStartTime",0),iT(this,"_signalTimeout",!1),iT(this,"_clientRoleOptions",void 0),iT(this,"_isProactiveJoin",!1),this.store=e,this.spec=t,this.signal=this.store.useP2P?new sO(cO(cO({},t),{},{retryConfig:t.websocketRetryConfig}),e):this.store.useDataChannel?new rO(cO(cO({},t),{},{retryConfig:t.websocketRetryConfig}),e):new jA(cO(cO({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(e,t,n){if(this.signal instanceof rO){let t=!1;"disabled"!==e.cloudProxyServer?(Qw.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),t=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(Qw.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),t=!0):e.apResponse.addresses.some((e=>e.fingerprint))||Dw("FINGERPRINT")||(Qw.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),t=!0),t&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==e.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const i=Date.now();let r=lO.get(e.cname);if(r||(r=new Map,lO.set(e.cname,r)),this._isProactiveJoin=!0,r.has(e.uid)){const t=new bb(tR.UID_CONFLICT);throw oI.joinGateway(e.sid,{lts:i,succ:!1,ec:t.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof rO?"1":"0"}),this._isProactiveJoin=!1,t}r.set(e.uid,!0),this.joinInfo=e,this.key=t;let o=0;this.joinGatewayStartTime=i;const s=e.proxyServer;try{let t;if(Qw.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof rO?"datachannel":"websocket"," join uid ").concat(o)),this.signal instanceof rO)t=await this.signal.init(e.apResponse.addresses,n);else{const i=e.gatewayAddrs.map((t=>{let{address:n}=t;const[i,r]=n.split(":"),o={host:i,port:r};return e.proxyServer&&(o.proxy=e.proxyServer),o}));t=await this.signal.init(i,n)}o=t.uid,Qw.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof rO?"datachannel":"websocket"," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(t){if(t&&t.code===tR.INIT_WEBSOCKET_TIMEOUT)throw Qw.warning("[".concat(this.store.clientId,"] User join failed"),t.toString()),t;if(t&&t.code===tR.INIT_DATACHANNEL_TIMEOUT)throw Qw.warning("[".concat(this.store.clientId,"] User join datachannel failed"),t.toString()),this.resetSignal(),t;throw Qw.error("[".concat(this.store.clientId,"] User join failed"),t.toString()),oI.joinGateway(e.sid,{lts:i,succ:!1,ec:t.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!s,signalChannel:this.signal instanceof rO?"1":"0"}),this._isProactiveJoin=!1,r.delete(e.uid),this.signal.close(),t}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),Qw.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((e=>{Qw.warning("[".concat(this.store.clientId,"] get traffic stats error"),e.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(zb.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(zb.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(zb.NETWORK_QUALITY,{uplinkNetworkQuality:YA(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:YA(this._statsCollector.trafficStats.B_dnq)}):this.emit(zb.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),o}async leave(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){t!==IR.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==Tb.CONNECTED||await function(e,t){return t===1/0?e:Gh.race([e,ZR(t)])}(this.signal.request(yb.LEAVE,void 0,!0),3e3)}catch(e){Qw.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),e)}this.signal.close(t),t!==IR.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,t,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new bb(tR.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const i={state:"offer",p2p_id:this.store.p2pId,ortc:t,mode:this.spec.mode,extend:Dw("PUB_EXTEND"),twcc:!!Dw("PUBLISH_TWCC"),rtx:!!Dw("USE_PUB_RTX")};try{return(await this.signal.request(yb.PUBLISH,i,!0))._message}catch(i){if(n&&i.data&&i.data.code===vb.ERR_PUBLISH_REQUEST_INVALID)return Qw.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),i.toString()),await this.tryUnpubBeforeRepub(e,t),this.publish(e,t,!1);throw i}}async publishDataChannel(e,t,n){var i;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new bb(tR.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={stream_id:t.streamId,ordered:t.ordered?1:0,max_retrans_times:null!==(i=t.maxRetransmits)&&void 0!==i?i:10,channel_id:t.channelId,metadata:t.metadata};try{await this.signal.request(yb.PUBLISH_DATASTREAM,r,!0)}catch(i){if(n&&i.data&&i.data.code===vb.ERR_PUBLISH_REQUEST_INVALID)return Qw.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),i.toString()),await this.tryUnpubDataChannelBeforeRepub(e,t),this.publishDataChannel(e,t,!1);throw i}}async unpublish(e,t){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new bb(tR.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(yb.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(e){Qw.warning("[".concat(this.store.clientId,"] unpublish warning: "),e)}}async unpublishDataChannel(e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new bb(tR.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Gh.all(e.map((e=>this.signal.request(yb.UNPUBLISH_DATASTREAM,{channel_id:e},!0))))}catch(e){Qw.warning("unpublish datachannels warning: ",e)}}async presubscribe(e,t,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new bb(tR.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const i={stream_id:e,stream_type:t,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!Dw("SUBSCRIBE_TWCC"),rtx:!!Dw("USE_SUB_RTX")||void 0,extend:Dw("SUB_EXTEND"),svc:Array.isArray(Dw("SVC"))&&0!==Dw("SVC").length?Dw("SVC"):void 0};try{return await this.signal.request(yb.PRE_SUBSCRIBE,i,!0)}catch(i){if(n&&i.data&&i.data.code===vb.ERR_SUBSCRIBE_REQUEST_INVALID)return Qw.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),i.toString()),this.presubscribe(e,t,!1);throw i}}async subscribe(e,t,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new bb(tR.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const i={stream_id:e,stream_type:t.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!Dw("SUBSCRIBE_TWCC"),rtx:!!Dw("USE_SUB_RTX"),extend:Dw("SUB_EXTEND"),ssrcId:t.ssrcId,svc:Array.isArray(Dw("SVC"))&&0!==Dw("SVC").length?Dw("SVC"):void 0};try{return(await this.signal.request(yb.SUBSCRIBE,i,!0))._message}catch(i){if(n&&i.data&&i.data.code===vb.ERR_SUBSCRIBE_REQUEST_INVALID)return Qw.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),i.toString()),await this.tryUnsubBeforeResub(e,t),await this.subscribe(e,t,!1);throw i}}async subscribeDataChannel(e,t,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new bb(tR.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const i={uid:e,stream_id:t.id,channel_id:t.datachannelId};try{return void await this.signal.request(yb.SUBSCRIBE_DATASTREAM,i,!0)}catch(i){if(n&&i.data&&i.data.code===vb.ERR_SUBSCRIBE_REQUEST_INVALID)return Qw.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),i.toString()),await this.tryUnsubDataChannelBeforeResub(e,t),await this.subscribeDataChannel(e,t,!1);throw i}}async subscribeAll(e,t){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new bb(tR.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!Dw("USE_SUB_RTX"),twcc:!!Dw("SUBSCRIBE_TWCC"),svc:Array.isArray(Dw("SVC"))&&0!==Dw("SVC").length?Dw("SVC"):void 0};try{return await this.signal.request(yb.SUBSCRIBE_STREAMS,n,!0)}catch(n){if(t&&n.data&&n.data.code===vb.ERR_SUBSCRIBE_REQUEST_INVALID)return Qw.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),n.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw n}}async setVideoProfile(e){const t=function(e){if(!(e.bitrateMax&&e.bitrateMin&&e.frameRate&&e.height&&e.width))return;let t=e.frameRate,n=e.width,i=e.height,r=!0;return"number"!=typeof t&&(t=t.exact||t.ideal||t.max||t.min||0,t||(r=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,n||(r=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,t||(r=!1)),r?{stream_type:0,width:n,height:i,fps:t,start_bps:1e3*e.bitrateMax,min_bps:1e3*e.bitrateMin,target_bps:1e3*e.bitrateMax}:void 0}(e);if(t)return this.signal.request(yb.SET_VIDEO_PROFILE,t);Qw.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,t){try{await this.signal.request(yb.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:t},!0)}catch(e){Qw.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),e)}}async unsubscribeDataChannel(e,t){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new bb(tR.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Gh.all(e.map((e=>this.signal.request(yb.UNSUBSCRIBE_DATASTREAM,{stream_id:e,uid:t},!0))))}catch(e){Qw.warning("unsubscribeDataChannel warning: ",e)}}async massUnsubscribe(e){try{await this.signal.request(yb.UNSUBSCRIBE_STREAMS,e,!0)}catch(e){Qw.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),e)}}async reconnectPC(e){const{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}=e;return{gatewayEstablishParams:await this.signal.request(yb.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(yb.GATEWAY_INFO)}async renewToken(e){await this.signal.request(yb.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),"CONNECTED"!==this.state)return void(this.role=e);let n,i=0;"audience"===e?this._clientRoleOptions&&this._clientRoleOptions.delay?(n=this._clientRoleOptions.delay,i=1):i=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:i=0,await this.signal.request(yb.SET_CLIENT_ROLE,{role:e,level:i,delay:n,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(yb.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(yb.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(yb.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(yb.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(yb.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,t,n){if(this.signal instanceof sO)return this.signal.sendExtensionMessage(e,t,n)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),cO({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(yb.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=lO.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(e){let t;return t=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),t?{username:aI.username,password:aI.password,turnServerURL:t[2],tcpport:parseInt(t[3])+30,udpport:parseInt(t[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(cO(cO({},aI),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const e=await this.signal.request(yb.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),null!=e.ntp_offset&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach((e=>{const t=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((t=>t.peer_uid===e.peer_uid));t&&t.B_st!==e.B_st&&BR((()=>{this.emit(zb.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new bb(tR.UNEXPECTED_ERROR,"can not generate join message, no join info");const t=Object.assign({},this.joinInfo.apResponse);let n=Dw("REPORT_APP_SCENARIO");if("string"!=typeof n)try{n=JSON.stringify(n)}catch(e){n=void 0}n&&n.length>128&&(n=void 0);const i=cO({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Rw,browser:navigator.userAgent,process_id:Dw("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:Dw("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:n,attributes:{userAttributes:{enablePublishedUserList:Dw("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:Dw("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof Dw("SUBSCRIBE_AUDIO_FILTER_TOPN")?Dw("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof Dw("ENABLE_PUBLISH_AUDIO_FILTER")?Dw("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof Dw("ENABLE_USER_LICENSE_CHECK")?Dw("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===Dw("USE_PUB_RTX")||!0===Dw("USE_SUB_RTX")||void 0,disableFEC:Dw("DISABLE_FEC"),enableNTPReport:!!Dw("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!Dw("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:"boolean"==typeof Dw("ENABLE_DATASTREAM_2")?Dw("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:"number"==typeof this.joinInfo.rtmFlag?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!Dw("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:"boolean"==typeof Dw("USE_XR")?Dw("USE_XR"):void 0,enableLossbasedBwe:"boolean"==typeof Dw("ENABLE_LOSSBASED_BWE")?Dw("ENABLE_LOSSBASED_BWE"):void 0,enableAutCC:"boolean"==typeof Dw("ENABLE_AUT_CC")?Dw("ENABLE_AUT_CC"):void 0,enableCCFallback:"boolean"==typeof Dw("ENABLE_CC_FALLBACK")?Dw("ENABLE_CC_FALLBACK"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(i.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(i.aes_mode=this.joinInfo.aesmode,Dw("ENCRYPT_AES")?(i.aes_secret=this.joinInfo.aespassword,i.aes_encrypt=!0):i.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(i.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(i.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),void 0!==this.joinInfo.defaultVideoStream&&(i.default_video_stream=this.joinInfo.defaultVideoStream),i}getRejoinMessage(){if(!this.joinInfo)throw new bb(tR.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(Sb.WS_RECONNECT_WAITTING_FINISH,(e=>{var t;Pi(t=["tryNext","recover"]).call(t,e)&&this.joinInfo&&oI.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(Sb.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(Sb.WS_RECONNECTING,(e=>{this.joinInfo&&oI.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||DR.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",oI.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:"live"===this.spec.mode?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:"audience"===this.role?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(Sb.WS_CLOSED,(e=>{let t;switch(e){case IR.LEAVE:t=DR.LEAVE;break;case IR.UID_BANNED:case IR.IP_BANNED:case IR.CHANNEL_BANNED:case IR.SERVER_ERROR:t=DR.SERVER_ERROR;break;case IR.FALLBACK:t=DR.FALLBACK;break;case IR.LICENSE_MISSING:case IR.LICENSE_EXPIRED:case IR.LICENSE_MINUTES_EXCEEDED:case IR.LICENSE_PERIOD_INVALID:case IR.LICENSE_MULTIPLE_SDK_SERVICE:case IR.LICENSE_ILLEGAL:case IR.TOKEN_EXPIRE:t=e;break;default:t=DR.NETWORK_ERROR}Qw.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(t||"undefined -> "+DR.NETWORK_ERROR)),this.joinInfo&&oI.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===IR.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t}),this._disconnectedReason=e,e!==IR.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(Sb.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(Qw.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),oI.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof rO?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void Qw.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));Nw("EVENT_REPORT_DOMAIN",e[1]),Nw("EVENT_REPORT_BACKUP_DOMAIN",e[1]),Nw("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}})),this.signal.on(Rb.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on(Sb.REQUEST_RECOVER,((e,t,n)=>{if(!this.joinInfo)return n(new bb(tR.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,LR(this,zb.REQUEST_NEW_GATEWAY_LIST).then(t).catch(n)})),this.signal.on(Sb.REQUEST_JOIN_INFO,(async e=>{var t;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=await LR(this,zb.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(t=this.joinInfo)||void 0===t?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r,version:"2"}}))})),this.signal.on(Sb.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on(Sb.REPORT_JOIN_GATEWAY,((e,t)=>{this.joinInfo&&(oI.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof rO?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on(Sb.IS_P2P_DISCONNECTED,(e=>{e(xR(this,zb.IS_P2P_DISCONNECTED))})),this.signal.on(Sb.DISCONNECT_P2P,(()=>{this.emit(zb.DISCONNECT_P2P)})),this.signal.on(Sb.NEED_RENEW_SESSION,(e=>{this.emit(zb.NEED_RENEW_SESSION,e)})),this.signal.on(Sb.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(Sb.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(Sb.JOIN_RESPONSE,(e=>{const t=this.getCurrentGatewayAddress();this.emit(zb.JOIN_RESPONSE,e,t)})),this.signal.on(Sb.DATACHANNEL_PRECONNECT,(async(e,t,n)=>{this.updateTurnConfigFromSignal();const i=this.getCurrentGatewayAddress();return LR(this,zb.DATACHANNEL_PRECONNECT,e,i).then(t).catch(n)})),this.signal.on(Sb.DATACHANNEL_CONNECTING,(async e=>{const{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}=await LR(this,zb.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:t,dtlsParameters:n,rtpCapabilities:i,version:"2"}}))})),this.signal.on(Sb.DATACHANNEL_FAILBACK,(()=>{Qw.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(zb.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(e,t){try{await this.signal.request(yb.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[t]},!0)}catch(e){throw Qw.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),e),e}}async tryUnsubDataChannelBeforeResub(e,t){try{await this.signal.request(yb.UNSUBSCRIBE,{stream_id:t.id},!0)}catch(e){throw Qw.warning("unsubscribe datachannel warning",e),e}}async tryUnpubBeforeRepub(e,t){try{await this.signal.request(yb.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(e){throw Qw.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),e),e}}async tryUnpubDataChannelBeforeRepub(e,t){try{await this.signal.request(yb.UNPUBLISH_DATASTREAM,{channnel_id:t.channelId},!0)}catch(e){throw Qw.warning("unpublish datastream warning: ",e),e}}async tryMassUnsubBeforeResub(e){const t={users:e.map((e=>({stream_id:e.stream_id,stream_type:e.stream_type})))};try{await this.signal.request(yb.UNSUBSCRIBE_STREAMS,t,!0)}catch(e){throw Qw.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),e),e}}async muteLocal(e,t){const n={action:e.find((e=>e.stream_type===Kb.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(yb.CONTROL,n,!0,!0)}catch(e){throw Qw.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),e),e}}async unmuteLocal(e,t){const n={action:e.find((e=>e.stream_type===Kb.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(yb.CONTROL,n,!0,!0)}catch(e){throw Qw.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),e),e}}async muteRemote(e,t){const n={action:e===iA.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(yb.CONTROL,n,!0,!0)}catch(e){throw Qw.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),e),e}}async unmuteRemote(e,t){const n={action:e===iA.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(yb.CONTROL,n,!0,!0)}catch(e){throw Qw.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),e),e}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const t={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(yb.RESTART_ICE,t,!0)}catch(e){throw Qw.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),e),e}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,DR.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!Dw("GATEWAY_WSS_ADDRESS"))return null!==(e=this.joinInfo)&&void 0!==e&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(yb.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(IR.FALLBACK)),this.store.useDataChannel=!1,this.signal=new jA(cO(cO({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(zb.RESET_SIGNAL,Jb.websocket)}}let uO=0,hO=0;function pO(e,t,n,i){return new Gh(((r,o)=>{t.timeout=t.timeout||Dw("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),uO+=XR(t.data)):n&&(t.data.size?uO+=t.data.size:t.data instanceof FormData?uO+=QR(t.data):uO+=XR(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,pC.request(t).then((e=>{"string"==typeof e.data?hO+=XR(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?hO+=e.data.byteLength:hO+=XR(JSON.stringify(e.data)),i&&r({data:e.data,headers:e.headers}),r(e.data)})).catch((e=>{pC.isCancel(e)?o(new bb(tR.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?o(new bb(tR.NETWORK_TIMEOUT,e.message)):e.response?o(new bb(tR.NETWORK_RESPONSE_ERROR,e.response.status)):o(new bb(tR.NETWORK_ERROR,e.message))}))}))}!function(){var e;function n(e){var t=0;return function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}}}var i,r="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,n){return e==Array.prototype||e==Object.prototype||(e[t]=n.value),e},o=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof t&&t];for(var n=0;n<e.length;++n){var i=e[n];if(i&&i.Math==Math)return i}throw Error("Cannot find global object")}(this);function s(e,t){if(t)e:{var n=o;e=e.split(".");for(var i=0;i<e.length-1;i++){var s=e[i];if(!(s in n))break e;n=n[s]}(t=t(i=n[e=e[e.length-1]]))!=i&&null!=t&&r(n,e,{configurable:!0,writable:!0,value:t})}}function a(e){return(e={next:e})[Symbol.iterator]=function(){return this},e}function c(e){var t="undefined"!=typeof Symbol&&Symbol.iterator&&e[Symbol.iterator];return t?t.call(e):{next:n(e)}}if(s("Symbol",(function(e){function t(e,t){this.A=e,r(this,"description",{configurable:!0,writable:!0,value:t})}if(e)return e;t.prototype.toString=function(){return this.A};var n="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",i=0;return function e(r){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new t(n+(r||"")+"_"+i++,r)}})),s("Symbol.iterator",(function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var t="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),i=0;i<t.length;i++){var s=o[t[i]];"function"==typeof s&&"function"!=typeof s.prototype[e]&&r(s.prototype,e,{configurable:!0,writable:!0,value:function(){return a(n(this))}})}return e})),"function"==typeof Object.setPrototypeOf)i=Object.setPrototypeOf;else{var l;e:{var d={};try{d.__proto__={a:!0},l=d.a;break e}catch(e){}l=!1}i=l?function(e,t){if(e.__proto__=t,e.__proto__!==t)throw new TypeError(e+" is not extensible");return e}:null}var u=i;function h(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(e){if(e.m)throw new TypeError("Generator is already running");e.m=!0}function f(e,t){return e.h=3,{value:t}}function m(e){this.g=new h,this.G=e}function _(e,t,n,i){try{var r=t.call(e.g.j,n);if(!(r instanceof Object))throw new TypeError("Iterator result "+r+" is not an object");if(!r.done)return e.g.m=!1,r;var o=r.value}catch(t){return e.g.j=null,e.g.s(t),E(e)}return e.g.j=null,i.call(e.g,o),E(e)}function E(e){for(;e.g.h;)try{var t=e.G(e.g);if(t)return e.g.m=!1,{value:t.value,done:!1}}catch(t){e.g.v=void 0,e.g.s(t)}if(e.g.m=!1,e.g.l){if(t=e.g.l,e.g.l=null,t.F)throw t.D;return{value:t.return,done:!0}}return{value:void 0,done:!0}}function g(e){this.next=function(t){return e.o(t)},this.throw=function(t){return e.s(t)},this.return=function(t){return function(e,t){p(e.g);var n=e.g.j;return n?_(e,"return"in n?n.return:function(e){return{value:e,done:!0}},t,e.g.return):(e.g.return(t),E(e))}(e,t)},this[Symbol.iterator]=function(){return this}}function v(e,t){return t=new g(new m(t)),u&&e.prototype&&u(t,e.prototype),t}if(h.prototype.o=function(e){this.v=e},h.prototype.s=function(e){this.l={D:e,F:!0},this.h=this.C||this.u},h.prototype.return=function(e){this.l={return:e},this.h=this.u},m.prototype.o=function(e){return p(this.g),this.g.j?_(this,this.g.j.next,e,this.g.o):(this.g.o(e),E(this))},m.prototype.s=function(e){return p(this.g),this.g.j?_(this,this.g.j.throw,e,this.g.o):(this.g.s(e),E(this))},s("Array.prototype.entries",(function(e){return e||function(){return function(e,t){e instanceof String&&(e+="");var n=0,i=!1,r={next:function(){if(!i&&n<e.length){var r=n++;return{value:t(r,e[r]),done:!1}}return i=!0,{done:!0,value:void 0}}};return r[Symbol.iterator]=function(){return r},r}(this,(function(e,t){return[e,t]}))}})),"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var T=function(e,t){for(var n=0;n<e.length;n++)t(e[n])},S=function(e){return e.replace(/\r?\n|\r/g,"\r\n")},y=function(e,t,n){return t instanceof Blob?(n=void 0!==n?String(n+""):"string"==typeof t.name?t.name:"blob",t.name===n&&"[object Blob]"!==Object.prototype.toString.call(t)||(t=new File([t],n)),[String(e),t]):[String(e),String(t)]},C=function(e,t){if(e.length<t)throw new TypeError(t+" argument required, but only "+e.length+" present.")},R="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,w=R.FormData,I=R.XMLHttpRequest&&R.XMLHttpRequest.prototype.send,b=R.Request&&R.fetch,A=R.navigator&&R.navigator.sendBeacon,O=R.Element&&R.Element.prototype,N=R.Symbol&&Symbol.toStringTag;N&&(Blob.prototype[N]||(Blob.prototype[N]="Blob"),"File"in R&&!File.prototype[N]&&(File.prototype[N]="File"));try{new File([],"")}catch(e){R.File=function(e,t,n){return e=new Blob(e,n||{}),Object.defineProperties(e,{name:{value:t},lastModified:{value:+(n&&void 0!==n.lastModified?new Date(n.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),N&&Object.defineProperty(e,N,{value:"File"}),e}}var D=function(e){return e.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},P=function(e){this.i=[];var t=this;e&&T(e.elements,(function(e){if(e.name&&!e.disabled&&"submit"!==e.type&&"button"!==e.type&&!e.matches("form fieldset[disabled] *"))if("file"===e.type){var n=e.files&&e.files.length?e.files:[new File([],"",{type:"application/octet-stream"})];T(n,(function(n){t.append(e.name,n)}))}else"select-multiple"===e.type||"select-one"===e.type?T(e.options,(function(n){!n.disabled&&n.selected&&t.append(e.name,n.value)})):"checkbox"===e.type||"radio"===e.type?e.checked&&t.append(e.name,e.value):(n="textarea"===e.type?S(e.value):e.value,t.append(e.name,n))}))};if((e=P.prototype).append=function(e,t,n){C(arguments,2),this.i.push(y(e,t,n))},e.delete=function(e){C(arguments,1);var t=[];e=String(e),T(this.i,(function(n){n[0]!==e&&t.push(n)})),this.i=t},e.entries=function e(){var t,n=this;return v(e,(function(e){if(1==e.h&&(t=0),3!=e.h)return t<n.i.length?e=f(e,n.i[t]):(e.h=0,e=void 0),e;t++,e.h=2}))},e.forEach=function(e,t){C(arguments,1);for(var n=c(this),i=n.next();!i.done;i=n.next()){var r=c(i.value);i=r.next().value,r=r.next().value,e.call(t,r,i,this)}},e.get=function(e){C(arguments,1);var t=this.i;e=String(e);for(var n=0;n<t.length;n++)if(t[n][0]===e)return t[n][1];return null},e.getAll=function(e){C(arguments,1);var t=[];return e=String(e),T(this.i,(function(n){n[0]===e&&t.push(n[1])})),t},e.has=function(e){C(arguments,1),e=String(e);for(var t=0;t<this.i.length;t++)if(this.i[t][0]===e)return!0;return!1},e.keys=function e(){var t,n,i,r=this;return v(e,(function(e){if(1==e.h&&(t=c(r),n=t.next()),3!=e.h)return n.done?void(e.h=0):(i=n.value,f(e,c(i).next().value));n=t.next(),e.h=2}))},e.set=function(e,t,n){C(arguments,2),e=String(e);var i=[],r=y(e,t,n),o=!0;T(this.i,(function(t){t[0]===e?o&&(o=!i.push(r)):i.push(t)})),o&&i.push(r),this.i=i},e.values=function e(){var t,n,i,r,o=this;return v(e,(function(e){if(1==e.h&&(t=c(o),n=t.next()),3!=e.h)return n.done?void(e.h=0):(i=n.value,(r=c(i)).next(),f(e,r.next().value));n=t.next(),e.h=2}))},P.prototype._asNative=function(){for(var e=new w,t=c(this),n=t.next();!n.done;n=t.next()){var i=c(n.value);n=i.next().value,i=i.next().value,e.append(n,i)}return e},P.prototype._blob=function(){var e="----formdata-polyfill-"+Math.random(),t=[],n="--"+e+'\r\nContent-Disposition: form-data; name="';return this.forEach((function(e,i){return"string"==typeof e?t.push(n+D(S(i))+'"\r\n\r\n'+S(e)+"\r\n"):t.push(n+D(S(i))+'"; filename="'+D(e.name)+'"\r\nContent-Type: '+(e.type||"application/octet-stream")+"\r\n\r\n",e,"\r\n")})),t.push("--"+e+"--"),new Blob(t,{type:"multipart/form-data; boundary="+e})},P.prototype[Symbol.iterator]=function(){return this.entries()},P.prototype.toString=function(){return"[object FormData]"},O&&!O.matches&&(O.matches=O.matchesSelector||O.mozMatchesSelector||O.msMatchesSelector||O.oMatchesSelector||O.webkitMatchesSelector||function(e){for(var t=(e=(this.document||this.ownerDocument).querySelectorAll(e)).length;0<=--t&&e.item(t)!==this;);return-1<t}),N&&(P.prototype[N]="FormData"),I){var k=R.XMLHttpRequest.prototype.setRequestHeader;R.XMLHttpRequest.prototype.setRequestHeader=function(e,t){k.call(this,e,t),"content-type"===e.toLowerCase()&&(this.B=!0)},R.XMLHttpRequest.prototype.send=function(e){e instanceof P?(e=e._blob(),this.B||this.setRequestHeader("Content-Type",e.type),I.call(this,e)):I.call(this,e)}}b&&(R.fetch=function(e,t){return t&&t.body&&t.body instanceof P&&(t.body=t.body._blob()),b.call(this,e,t)}),A&&(R.navigator.sendBeacon=function(e,t){return t instanceof P&&(t=t._asNative()),A.call(this,e,t)}),R.FormData=P}}();const fO=()=>{const e=Dw("AREAS");return 0===e.length&&e.push(Xb.GLOBAL),Xi(e).call(e,((e,t,n)=>{const i=mO(t);return i?0===n?i:"".concat(e,",").concat(i):e}),"")},mO=e=>e===Xb.OVERSEA?"".concat(Zb.ASIA,",").concat(Zb.EUROPE,",").concat(Zb.AFRICA,",").concat(Zb.NORTH_AMERICA,",").concat(Zb.SOUTH_AMERICA,",").concat(Zb.OCEANIA):Zb[e],_O=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((e=>{const n=$b[e],i=Object.keys(n);i&&i.map((e=>{"CODE"!==e&&(t[e]=t[e].concat(n[e]))}))})),t},EO={GLOBAL:{ASIA:[Xb.CHINA,Xb.JAPAN,Xb.INDIA,Xb.KOREA,Xb.HKMC],EUROPE:[],NORTH_AMERICA:[Xb.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},gO=Object.keys(EO[Xb.GLOBAL]),vO=[Xb.CHINA,Xb.NORTH_AMERICA,Xb.EUROPE,Xb.ASIA,Xb.JAPAN,Xb.INDIA,Xb.OCEANIA,Xb.SOUTH_AMERICA,Xb.AFRICA,Xb.KOREA,Xb.HKMC,Xb.US],TO=function(e,t){let n=[];if(Pi(e).call(e,Xb.GLOBAL)){const o=[Xb.GLOBAL,Xb.OVERSEA],s=Object.keys($b);if(t===Xb.GLOBAL)throw new bb(tR.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===Xb.CHINA)n=[Xb.OVERSEA];else if(r=t,Pi(gO).call(gO,r)){const e=(i=t,EO[Xb.GLOBAL][i]||[]),r=[...o,t,...e];n=s.filter((e=>!Pi(r).call(r,e)))}else if(function(e){let t=!1;return gO.forEach((n=>{var i;Pi(i=EO[Xb.GLOBAL][n]).call(i,e)&&(t=!0)})),t}(t)){const e=function(e){let t;return gO.forEach((n=>{var i;Pi(i=EO[Xb.GLOBAL][n]).call(i,e)&&(t=n)})),t}(t),i=[...o,e,t];n=s.filter((e=>!Pi(i).call(i,e)))}else n=e;n=function(e){const t=[];return vO.forEach((n=>{Pi(e).call(e,n)&&t.push(n)})),t.concat(e.filter((e=>!Pi(vO).call(vO,e))))}(n)}else n=e;var i,r;return n};function SO(e){var t,n;if(!e&&Pi(t=Dw("AREAS")).call(t,Xb.EXTENSIONS))return Qw.debug("update area from ap : reset"),void yO(sI,!0);if(!Pi(n=Dw("AREAS")).call(n,Xb.GLOBAL)||!e)return;let i=$b.EXTENSIONS;i&&(i={CODE:mO(Xb.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},Qw.debug("update area from ap success: ".concat(e,",config is "),i),Nw("AREAS",[Xb.EXTENSIONS],!0),Object.keys(i).map((e=>{Nw(e,"LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e?i[e][0]:i[e])})))}function yO(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=oI.reportApiInvoke(null,{name:yR.SET_AREA,options:e,tag:CR.TRACER});try{let i=[];if("string"==typeof e&&(i=[e]),Array.isArray(e)&&(e.forEach((e=>{if(!Pi(Qb).call(Qb,e))throw new bb(tR.INVALID_PARAMS,"invalid area code")})),i=e),"[object Object]"===Object.prototype.toString.call(e)){const{areaCode:t,excludedArea:n}=e;if(!t)throw new bb(tR.INVALID_PARAMS,"area code is needed");let r=t;"string"==typeof t&&(r=[t]),i=n?TO(r,n):r}if(!t){if(Pw.AREAS){const e=new bb(tR.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(e),void Qw.warning("setArea is prohibited because of config-distribute")}if(Pi(i).call(i,Xb.GLOBAL)&&Dw("AREAS")===Xb.EXTENSIONS){const e=new bb(tR.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(e),void Qw.warning("setArea is prohibited because of ap extensions")}}Nw("AREAS",i,t);const r=_O(i);Object.keys(r).map((e=>{Nw(e,"LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e?r[e][0]:r[e])})),Qw.debug("set area success:",i.join(","))}catch(e){throw n.onError(e),e}n.onSuccess()}function CO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function RO(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?CO(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):CO(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let wO=1;function IO(e,t,n,i,r){wO+=1;const o={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:wO,requestId:wO,version:Rw,cname:n.cname},s={service_name:t,json_body:JSON.stringify(o)};let a,c,l=e[0];return _w((async()=>{a=Date.now();const e=await pO(l,{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,0!==e.code){const t=new bb(tR.UNEXPECTED_RESPONSE,"live streaming ap error, code"+e.code,{retry:!0,responseTime:c});throw Qw.error(t.toString()),t}const n=JSON.parse(e.json_body);if(200!==n.code){const e=new bb(tR.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(n.code,", reason: ").concat(n.reason),{code:n.code,responseTime:c});throw Qw.error(e.toString()),e}if(!n.servers||0===n.servers.length){const e=new bb(tR.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:n.code,responseTime:c});throw Qw.error(e.toString()),e}const r=function(e,t){return{addressList:e.servers.map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(Dw("WORKER_DOMAIN"),":").concat(e.wss,"?serviceName=").concat(encodeURIComponent(t)))),workerToken:e.workerToken,vid:e.vid}}(n,t);return Dw("LIVE_STREAMING_ADDRESS")&&(r.addressList=Dw("LIVE_STREAMING_ADDRESS")instanceof Array?Dw("LIVE_STREAMING_ADDRESS"):[Dw("LIVE_STREAMING_ADDRESS")]),RO(RO({},r),{},{responseTime:c})}),((i,r)=>(oI.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(i.addressList),firstSuccess:0===r,responseTime:c,serverIp:e[r%e.length]}),!1)),((i,r)=>(oI.apworkerEvent(n.sid,{success:!1,sc:i.data&&i.data.code||200,serviceName:t,responseTime:c,serverIp:e[r%e.length]}),!!(i.code!==tR.OPERATION_ABORTED&&i.code!==tR.UNEXPECTED_RESPONSE||i.data&&i.data.retry)&&(l=e[(r+1)%e.length],!0))),r)}let bO=1;function AO(e,t,n,i){let{url:r,areaCode:o}=e;const{clientId:s,sid:a}=t,c=Date.now();let l;const[d,u]=kO(t,o,[BA.CHOOSE_SERVER]);let h=VR.networkState;return _w((async()=>{h&&VR.networkState===PR.OFFLINE&&VR.onlineWaiter&&await Gh.race([VR.onlineWaiter,$R(i&&i.maxRetryTimeout||fw.maxRetryTimeout)]),h=VR.networkState;const{data:e,headers:o}=await pO(r,{data:d,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);l="1"===o.http3?1:-1,oI.reportResourceTiming(r,a),NO(e,r,t,c,[BA.CHOOSE_SERVER],l);const s=JA(e,BA.CHOOSE_SERVER);return DO(s),KA(s,r)}),(e=>(e&&oI.joinChooseServer(a,{lts:c,succ:!0,csAddr:r,opid:u,serverList:e.gatewayAddrs.map((e=>e.address)),ec:null,cid:e.cid.toString(),uid:e.uid.toString(),csIp:e.csIp,unilbsServerIds:[BA.CHOOSE_SERVER].toString(),isHttp3:l}),!1)),(e=>e.code!==tR.OPERATION_ABORTED&&(e.code===tR.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(oI.joinChooseServer(a,{lts:c,succ:!1,csAddr:r,serverList:null,opid:u,ec:e.code,csIp:e.data&&e.data.csIp,unilbsServerIds:[BA.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:h}),isHttp3:l}),Qw.warning("[".concat(s||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),e),!0))),i)}function OO(e,t,n,i){let r,{url:o,areaCode:s,serviceIds:a}=e;const c=Date.now(),[l,d]=kO(t,s,a);let u;return _w((async()=>{u&&VR.networkState===PR.OFFLINE&&VR.onlineWaiter&&await Gh.race([VR.onlineWaiter,$R(i&&i.maxRetryTimeout||fw.maxRetryTimeout)]),u=VR.networkState;const{data:e,headers:s}=await pO(o,{data:l,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r="1"===s.http3?1:-1,oI.reportResourceTiming(o,t.sid),NO(e,o,t,c,a,r);const d=JA(e,BA.CHOOSE_SERVER),h=JA(e,"proxy5"===t.cloudProxyServer?BA.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?BA.CLOUD_PROXY:BA.CLOUD_PROXY_FALLBACK);return DO(d),{gatewayInfo:KA(d,o),proxyInfo:h,url:o}}),(e=>(e.gatewayInfo&&oI.joinChooseServer(t.sid,{lts:c,succ:!0,csAddr:o,serverList:e.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,opid:d,cid:e.gatewayInfo.cid.toString(),uid:e.gatewayInfo.uid.toString(),csIp:e.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r}),e.proxyInfo&&oI.joinWebProxyAP(t.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:e.proxyInfo.addresses.map((e=>e.ip)).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:a.toString()}),!1)),(e=>e.code!==tR.OPERATION_ABORTED&&(e.code===tR.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(oI.joinWebProxyAP(t.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:e.code,eventType:t.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:u})}),Qw.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),e),!0))),i)}const NO=(e,t,n,i,r,o)=>{const{sid:s,clientId:a,cloudProxyServer:c}=n,l=[],d=n=>{4096===n.flag?oI.joinChooseServer(s,{lts:i,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:n.error.message,csIp:n.error.data&&n.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:o}):1048576!==n.flag&&4194304!==n.flag&&4194310!==n.flag||oI.joinWebProxyAP(s,{lts:i,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:n.error.code,eventType:c,unilbsServerIds:r.toString()})};if(e.response_body.forEach((t=>{const n=t.buffer.code;if(23===t.uri&&0===n&&!t.buffer.edges_services)if(4194310===t.buffer.flag)Qw.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),t.buffer.edges_services=[];else{const n={error:new bb(tR.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:t.buffer.flag};l.push(n),d(n)}if(0!==n){const i=CA(n),r={error:new bb(tR.CAN_NOT_GET_GATEWAY_SERVER,i.desc,{desc:i.desc,retry:i.retry,csIp:e.detail[502]}),flag:t.buffer.flag};4194310===t.buffer.flag?Qw.warning(r.error.toString()):l.push(r),d(r)}})),l.length)throw Qw.warning("[".concat(a||"sid-".concat(s.slice(0,6)),"] multi unilbs ").concat(t," failed, ").concat(l.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message,", retry: ").concat(e.error.data.retry))).join(" | "))),new bb(tR.CAN_NOT_GET_GATEWAY_SERVER,l.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!l.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(l.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})},DO=e=>{var t,n,i,r;if(e.addresses&&0===e.addresses.length&&0===e.code)throw new bb(tR.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(Dw("AP_AREA")&&(null!==(i=e.detail)&&void 0!==i&&i[23]&&"string"==typeof(null===(r=e.detail)||void 0===r?void 0:r[23])?SO(e.detail[23].toLowerCase()):SO()),null!==(t=e.detail)&&void 0!==t&&t[19]&&"string"==typeof(null===(n=e.detail)||void 0===n?void 0:n[19])){const t=e.detail[19],n=null==t?void 0:t.split(";");for(let i=0;i<n.length;i++){var o;const t=Bp(o=n[i]).call(o);e.addresses[i]&&n&&(e.addresses[i].fingerprint=t)}}if(Dw("GATEWAY_ADDRESS")&&Dw("GATEWAY_ADDRESS").length>0){Qw.debug("assign gateway address to",Dw("GATEWAY_ADDRESS"));const t=Dw("GATEWAY_ADDRESS").map((t=>{var n,i;const r=null!==(n=null===(i=e.addresses.find((e=>e.ip===t.ip&&e.port===t.port)))||void 0===i?void 0:i.fingerprint)&&void 0!==n?n:"";return{ip:t.ip,port:t.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:r}}));e.addresses=t}},PO=(e,t)=>{if(e.response_body&&e.response_body.length){const t=e.response_body[0];if(0!==t.buffer.code){const e=CA(t.buffer.code);throw new bb(tR.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(e.desc),{retry:e.retry})}return t.buffer.ticket}throw Qw.debug("update ticket request received ap response without response body:",t),new bb(tR.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},kO=(e,t,n)=>{const i=Math.floor(Math.random()*10**12),r={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:RO({6:e.stringUid,11:t,12:Dw("USE_NEW_TOKEN")?"1":void 0,22:t},e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:n,uid:e.uid||0}}]};r.request_bodies.forEach((t=>{e.multiIP&&e.multiIP.gateway_ip&&(t.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(r)),[o,i]},LO=(e,t)=>{const n=Math.floor(Math.random()*10**12),i={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((e=>({ip:e.ip,port:e.port})))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,n]};let MO=0;function UO(e){return Gh.all(e.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e))}const xO=async e=>{let{fragementLength:t,referenceList:n,asyncMapHandler:i,allFailedhandler:r,promisesCollector:o}=e,s=0;const a=t;let c,l=0;const d=async()=>{const e=(()=>{const e=s*a,t=e+a;return n.slice(e,t).map(i)})();o&&o.push(...e);try{c=await UO(e)}catch(e){if(l+=a,s++,!(l>=n.length))return void await d();r(e)}e.forEach((e=>e.cancel()))};return await d(),c},VO=async e=>{let{referenceList:t,asyncMapHandler:n,closeFn:i}=e;const r=t.length;let o=0;const s=async()=>{const e=n(t.shift());try{return await e}catch(e){if(o++,o>=r||null!=i&&i(e))throw e;return s()}};return s()};async function FO(e,t,n,i){const r=async function(e,t,n,i){let r=null;const o=[],s=async()=>{const r=Dw("WEBCS_DOMAIN").slice(0,Dw("AJAX_REQUEST_CONCURRENT")).map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:fO()}))),s=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),a=await xO({fragementLength:Dw("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:i=>(Qw.debug("[".concat(e.clientId,"] Connect to choose_server:"),i.url),AO(i,e,t,n)),allFailedhandler:e=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},s),e[0]},promisesCollector:o});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},s),a},a=async()=>{if(await $R(1e3),null!==r)return r;const s=Dw("WEBCS_DOMAIN_BACKUP_LIST").map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:fO()}))),a=i.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((e=>e.url))}),c=await xO({fragementLength:Dw("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:i=>(Qw.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),i.url),AO(i,e,t,n)),allFailedhandler:e=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:o});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c};try{return r=await UO([s(),a()]),o.length&&o.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),r}catch(e){throw e[0]}}(e,t,n,i);return{gatewayInfo:await r}}async function jO(e,t,n,i,r){const o=e.cloudProxyServer;if("disabled"===o){if(!i)return;if(e.useLocalAccessPoint)return await FO(e,t,n,r);if(Dw("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:i,proxyInfo:o}=await KO(e,t,n,r);if(e.turnServer&&"auto"!==e.turnServer.mode)return{gatewayInfo:i};const a=o.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||aI.tcpport,udpport:e.udpport||aI.udpport,username:e.username||aI.username,password:e.password||aI.password,forceturn:!1,security:!0})));if(r.useP2P){var s;const t=null!==(s=e.uid)&&void 0!==s?s:i.uid,n="glb:".concat(t.toString()),r=await gR(n),c=o.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||aI.tcpport,udpport:e.udpport||aI.udpport,username:n,password:r,forceturn:!1,security:!0})));a.push(...c)}return e.turnServer={mode:"manual",servers:a},{gatewayInfo:i}}return await FO(e,t,n,r)}const{proxyInfo:a,gatewayInfo:c}=await KO(e,t,n,r),l={gatewayInfo:c},d=a.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===o?void 0:e.tcpport?e.tcpport:aI.tcpport,udpport:"proxy4"===o?void 0:e.udpport?e.udpport:aI.udpport,username:e.username||aI.username,password:e.password||aI.password,forceturn:"proxy4"!==o,security:"proxy5"===o})));if(r.useP2P){var u;const t=null!==(u=e.uid)&&void 0!==u?u:c.uid,n="glb:".concat(t.toString()),i=await gR(n),r=a.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===o?void 0:e.tcpport||aI.tcpport,udpport:"proxy4"===o?void 0:e.udpport||aI.udpport,username:n,password:i,forceturn:"proxy4"!==o,security:"proxy5"===o})));d.push(...r)}return e.turnServer={mode:"manual",servers:d},Qw.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(o)),l}async function BO(e,t,n,i,r){const o=Dw("ACCOUNT_REGISTER").slice(0,Dw("AJAX_REQUEST_CONCURRENT"));let s=[];s=t.proxyServer?o.map((e=>"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):o.map((e=>"https://".concat(e,"/api/v1")));const a=null==r?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{const o=await async function(e,t,n,i,r){const o=Date.now(),s={sid:n.sid,opid:10,appid:n.appId,string_uid:t};let a=e[0];const c=await _w((()=>pO(a+"".concat(-1===a.indexOf("?")?"?":"&","action=stringuid"),{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((n,i)=>{if(0===n.code){if(n.uid<=0||n.uid>=Math.pow(2,32))throw Qw.error("Invalid Uint Uid ".concat(t," => ").concat(n.uid),n),oI.reqUserAccount(s.sid,{lts:o,success:!1,serverAddr:a,stringUid:s.string_uid,uid:n.uid,errorCode:tR.INVALID_UINT_UID_FROM_STRING_UID,extend:s}),new bb(tR.INVALID_UINT_UID_FROM_STRING_UID);return oI.reqUserAccount(s.sid,{lts:o,success:!0,serverAddr:a,stringUid:s.string_uid,uid:n.uid,errorCode:null,extend:s}),!1}const r=CA(n.code);return r.retry&&(a=e[(i+1)%e.length]),oI.reqUserAccount(s.sid,{lts:o,success:!1,serverAddr:a,stringUid:s.string_uid,uid:n.uid,errorCode:r.desc,extend:s}),r.retry}),((t,n)=>t.code!==tR.OPERATION_ABORTED&&(oI.reqUserAccount(s.sid,{lts:o,success:!1,serverAddr:a,stringUid:s.string_uid,uid:null,errorCode:t.code,extend:s}),a=e[(n+1)%e.length],!0)),r);if(0!==c.code){const e=CA(c.code);throw new bb(tR.UNEXPECTED_RESPONSE,e.desc)}return c}(s,e,t,n,i);return null==r||r.recordJoinChannelService({status:"success",endTs:Date.now()},a),o.uid}catch(e){throw null==r||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[e]},a),e}}async function GO(e,t,n){const i=Dw("ACCOUNT_REGISTER");let r=[];r=t.proxyServer?i.map((e=>"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):i.map((e=>"https://".concat(e,"/api/v1")));try{const i=await VO({referenceList:r,asyncMapHandler:i=>async function(e,t,n,i){const r=Date.now(),o={sid:n.sid,opid:10,appid:n.appId,string_uid:t};try{const t=await pO(e+"".concat(-1===e.indexOf("?")?"?":"&","action=stringuid"),{data:o,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(0!==t.code){const e=CA(t.code);throw new bb(tR.UNEXPECTED_RESPONSE,"preload sua error:".concat(e.desc),e)}if(t.uid<=0||t.uid>=Math.pow(2,32))throw new bb(tR.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:r,url:e,req:o,uid:t.uid,elapse:Date.now()-r}}catch(e){throw e}}(i,e,t,n),closeFn:e=>e.code===tR.OPERATION_ABORTED||e.code===tR.UNEXPECTED_RESPONSE&&!e.data.retry});return i}catch(e){throw e}}async function WO(e,t,n){const i=Dw("CDS_AP").slice(0,Dw("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"):"https://".concat(t,"/api/v1?action=config"))),r=i.map((i=>function(e,t,n,i){const r=RC(),o={flag:64,cipher_method:0,features:{device:r.name,system:r.os,system_general:navigator.userAgent,vendor:t.appId,version:Rw,cname:t.cname,sid:t.sid,session_id:t.sid,detail:"",proxyServer:t.proxyServer}};return _w((()=>pO(e,{data:o,timeout:1e3,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(e=>e.code!==tR.OPERATION_ABORTED),i)}(i,e,t,n)));let o=null,s=null,a={};try{o=await UO(r)}catch(e){if(e.code===tR.OPERATION_ABORTED)throw e;s=e}if(r.forEach((e=>e.cancel())),oI.reportApiInvoke(e.sid,{name:yR.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:o}}).onSuccess(),o&&o.test_tags)try{a=function(e){if(!e.test_tags)return{};const t=e.test_tags,n=Object.keys(t),i={};return n.forEach((e=>{var n;const r=Bp(n=e.slice(4)).call(n),o=JSON.parse(t[e])[1];i[r]=o})),i}(o)}catch(e){}return a}async function HO(e,t){const n=Dw("WEBCS_DOMAIN").concat(Dw("WEBCS_DOMAIN_BACKUP_LIST")).map((e=>({url:"https://".concat(e,"/api/v2/transpond/webrtc?v=2"),areaCode:fO(),serviceIds:[BA.CHOOSE_SERVER,BA.CLOUD_PROXY_FALLBACK]})));try{const i=await VO({referenceList:n,asyncMapHandler:n=>async function(e,t,n){let i,{url:r,areaCode:o,serviceIds:s}=e;const a=Date.now(),[c,l]=kO(t,o,s);let d=VR.networkState;try{d&&VR.networkState===PR.OFFLINE&&VR.onlineWaiter&&await Gh.race([VR.onlineWaiter,$R(fw.maxRetryTimeout)]),d=VR.networkState;const{data:e,headers:t}=await pO(r,{data:c,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);i="1"===t.http3?1:-1;const o=e=>{const t=[];if(e.response_body.forEach((n=>{const i=n.buffer.code;if(23===n.uri&&0===i&&!n.buffer.edges_services)if(4194310===n.buffer.flag)n.buffer.edges_services=[];else{const i={error:new bb(tR.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:n.buffer.flag};t.push(i)}if(0!==i){const r=CA(i),o={error:new bb(tR.CAN_NOT_GET_GATEWAY_SERVER,r.desc,{desc:r.desc,retry:r.retry,csIp:e.detail[502]}),flag:n.buffer.flag};4194310===n.buffer.flag?Qw.warning(o.error.toString()):t.push(o)}})),t.length)throw new bb(tR.CAN_NOT_GET_GATEWAY_SERVER,t.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!t.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(t.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})};o(e);const s=JA(e,BA.CHOOSE_SERVER),u=JA(e,BA.CLOUD_PROXY_FALLBACK);return DO(s),{gatewayInfo:KA(s,r),proxyInfo:u,opid:l,requestTime:a,url:r,isHttp3:i,elapse:Date.now()-a}}catch(e){throw e}}(n,e,t),closeFn:e=>e.code===tR.OPERATION_ABORTED||e.code===tR.CAN_NOT_GET_GATEWAY_SERVER&&!e.data.retry});return i}catch(e){throw e}}async function KO(e,t,n,i){const r=Dw("PROXY_SERVER_TYPE3"),o=(e,t,n)=>{let i=n||r;return Array.isArray(i)&&(i=t%2==0?r[1]:r[0]),"https://".concat(i,"/ap/?url=").concat(e)};let s=null;const a=[],c=async()=>{const r=Dw("WEBCS_DOMAIN").slice(0,Dw("AJAX_REQUEST_CONCURRENT")).map(((t,n)=>{let i;return i="disabled"===e.cloudProxyServer&&e.proxyServer?o("".concat(t,"/api/v2/transpond/webrtc?v=2"),n,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):o("".concat(t,"/api/v2/transpond/webrtc?v=2"),n),{url:i,areaCode:fO(),serviceIds:[BA.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?BA.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?BA.CLOUD_PROXY:BA.CLOUD_PROXY_FALLBACK]}})),s=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),c=await xO({fragementLength:Dw("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:i=>(Qw.debug("[".concat(e.clientId,"] Connect to choose_server:"),i.url),OO(i,e,t,n)),allFailedhandler:e=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},s),e[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},s),c},l=async()=>{if(await $R(1e3),null!==s)return s;const r=Dw("WEBCS_DOMAIN_BACKUP_LIST").map(((t,n)=>{let i;return i="disabled"===e.cloudProxyServer&&e.proxyServer?o("".concat(t,"/api/v2/transpond/webrtc?v=2"),n,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):o("".concat(t,"/api/v2/transpond/webrtc?v=2"),n),{url:i,areaCode:fO(),serviceIds:[BA.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?BA.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?BA.CLOUD_PROXY:BA.CLOUD_PROXY_FALLBACK]}})),c=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),l=await xO({fragementLength:Dw("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:i=>(Qw.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),i.url),OO(i,e,t,n)),allFailedhandler:e=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},c),e[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},c),l};let d,u,h;try{({gatewayInfo:d,proxyInfo:u,url:h}=await UO([c(),l()]))}catch(e){throw e[0]}if(a.length&&a.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),!d||!u)throw new bb(tR.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=h,"disabled"!==e.cloudProxyServer&&Array.isArray(r)&&h){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(h)[1];Pi(r).call(r,t)&&(e.proxyServer=t,Qw.setProxyServer(t),oI.setProxyServer(t))}return s={gatewayInfo:d,proxyInfo:await XA(u,d.uid)},s}async function zO(e,t,n,i){const r=Dw("UAP_AP").slice(0,Dw("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap")));return await IO(r,e,t,n,i)}async function qO(e,t,n){const i=Dw("UAP_AP").slice(0,Dw("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap"))),r=i.map((i=>function(e,t,n,i){const r={command:"convergeAllocateEdge",sid:t.sid,appId:t.appId,token:t.token,ts:Date.now(),version:Rw,cname:t.cname,uid:t.uid.toString(),requestId:bO,seq:bO};bO+=1;const o={service_name:"tele_channel",json_body:JSON.stringify(r)};return _w((async()=>{const t=await pO(e,{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==t.code){const e=new bb(tR.UNEXPECTED_RESPONSE,"cross channel ap error, code"+t.code,{retry:!0});throw Qw.error(e.toString()),e}const i=JSON.parse(t.json_body);if(200!==i.code){const e=new bb(tR.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(i.code,", reason: ").concat(i.reason));throw Qw.error(e.toString()),e}if(!i.servers||0===i.servers.length){const e=new bb(tR.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw Qw.error(e.toString()),e}return{vid:i.vid,workerToken:i.workerToken,addressList:(Dw("CHANNEL_MEDIA_RELAY_SERVERS")||i.servers).map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(Dw("WORKER_DOMAIN"),":").concat(e.wss)))}}),void 0,(e=>!!(e.code!==tR.OPERATION_ABORTED&&e.code!==tR.UNEXPECTED_RESPONSE||e.data&&e.data.retry)),i)}(i,e,t,n)));try{const e=await UO(r);return r.forEach((e=>e.cancel())),e}catch(e){throw e[0]}}async function YO(e,t,n){let i=null;const r=[],o=async o=>{const s=Dw(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2")));return o&&(await $R(1e3),null!==i)?i:await xO({fragementLength:Dw("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:i=>(Qw.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),i),function(e,t,n,i){const[r]=LO(t,[BA.CHOOSE_SERVER]);let o=VR.networkState;return _w((async()=>{o&&VR.networkState===PR.OFFLINE&&VR.onlineWaiter&&await Gh.race([VR.onlineWaiter,$R(i&&i.maxRetryTimeout||fw.maxRetryTimeout)]),o=VR.networkState;const t=await pO(e,{data:r,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0);return PO(t,e)}),(()=>!1),(e=>e.code!==tR.OPERATION_ABORTED&&(e.code===tR.UPDATE_TICKET_FAILED?e.data.retry:(Qw.warning("[".concat(t.clientId,"] update ticket network error, retry"),e),!0))),i)}(i,e,t,n)),allFailedhandler:e=>{throw e[0]},promisesCollector:r})};try{return i=await UO([o(!1),o(!0)]),r.length&&r.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),i}catch(e){throw e[0]}}function JO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function XO(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?JO(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):JO(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class QO extends vR{get isSuccess(){return!!this.configs}constructor(){super(),iT(this,"configs",void 0),iT(this,"joinInfo",void 0),iT(this,"cancelToken",void 0),iT(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),iT(this,"interval",void 0),iT(this,"mutex",new hw("config-distribute")),iT(this,"mutableParamsRead",!1)}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),Dw("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),Dw("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,oI.reportApiInvoke(null,{options:void 0,name:yR.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:CR.TRACER}).onSuccess(JSON.stringify(Pw))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void Qw.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const t=await this.mutex.lock();try{e=await WO(this.joinInfo,this.cancelToken,this.retryConfig),Qw.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(e){const t=new bb(tR.NETWORK_RESPONSE_ERROR,e);Qw.warning("[config-distribute] ".concat(t.toString()))}finally{t()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&void 0!==t.uplink.max_bitrate&&void 0!==t.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(eA.UPDATE_BITRATE_LIMIT,e):this.emit(eA.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&XO({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var t;const n=sm(t=Object.keys(e).filter((e=>/^webrtc_ng_global_parameter/.test(e)))).call(t);for(let r=0;r<n.length;r++)for(let t=n.length-1;t>r;t--){const i=n[t];if("number"==typeof e[i].__priority){const r=e[i].__priority,o=n[t-1];if("number"==typeof e[o].__priority){if(!(r>e[o].__priority))continue;{const e=i;n[t]=n[t-1],n[t-1]=e}}else{const e=i;n[t]=n[t-1],n[t-1]=e}}}const i={};n.forEach((t=>{const n=e[t],r=n.__expires;Object.keys(n).forEach((e=>{"__priority"===e||"__expires"===e||Object.prototype.hasOwnProperty.call(i,e)||(i[e]=XO({value:n[e]},r&&{expires:r}))}))}));try{!function(e){try{const t=Date.now();Object.keys(e).forEach((n=>{switch(n){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(Ow,n)){const{value:i,expires:r}=e[n];if(r&&r<=t)return;Pw[n]=i,Ow[n]=i,Qw.debug("Update global parameters from config distribute",n,i)}}}))}catch(t){Qw.error("Error update config immediately: ".concat(e),t.message)}}(i);const e=JSON.stringify(i),t=window.btoa(e);window.localStorage.setItem("websdk_ng_global_parameter",t),Qw.debug("Caching global parameters ".concat(e))}catch(e){Qw.error("Error caching global parameters:",e.message)}}}var ZO,$O=i(MI),eN=D,tN=d,nN=L,iN=r,rN=to,oN=Br,sN=M,aN=Xe,cN=z,lN=Object.assign,dN=Object.defineProperty,uN=tN([].concat),hN=!lN||iN((function(){if(eN&&1!==lN({b:1},lN(dN({},"a",{enumerable:!0,get:function(){dN(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var e={},t={},n=Symbol(),i="abcdefghijklmnopqrst";return e[n]=7,i.split("").forEach((function(e){t[e]=e})),7!=lN({},e)[n]||rN(lN({},t)).join("")!=i}))?function(e,t){for(var n=aN(e),i=arguments.length,r=1,o=oN.f,s=sN.f;i>r;)for(var a,c=cN(arguments[r++]),l=o?uN(rN(c),o(c)):rN(c),d=l.length,u=0;d>u;)a=l[u++],eN&&!nN(s,c,a)||(n[a]=c[a]);return n}:lN,pN=rn,fN=os,mN=Qt,_N=L,EN=Xe,gN=function(e,t,n,i){try{return i?t(pN(n)[0],n[1]):t(n)}catch(t){fN(e,"throw",t)}},vN=Go,TN=Bc,SN=Hn,yN=_f,CN=ts,RN=Yo,wN=Array,IN=d,bN=2147483647,AN=/[^\0-\u007E]/,ON=/[.\u3002\uFF0E\uFF61]/g,NN="Overflow: input needs wider integers to process",DN=RangeError,PN=IN(ON.exec),kN=Math.floor,LN=String.fromCharCode,MN=IN("".charCodeAt),UN=IN([].join),xN=IN([].push),VN=IN("".replace),FN=IN("".split),jN=IN("".toLowerCase),BN=function(e){return e+22+75*(e<26)},GN=function(e,t,n){var i=0;for(e=n?kN(e/700):e>>1,e+=kN(e/t);e>455;)e=kN(e/35),i+=36;return kN(i+36*e/(e+38))},WN=function(e){var t=[];e=function(e){for(var t=[],n=0,i=e.length;n<i;){var r=MN(e,n++);if(r>=55296&&r<=56319&&n<i){var o=MN(e,n++);56320==(64512&o)?xN(t,((1023&r)<<10)+(1023&o)+65536):(xN(t,r),n--)}else xN(t,r)}return t}(e);var n,i,r=e.length,o=128,s=0,a=72;for(n=0;n<e.length;n++)(i=e[n])<128&&xN(t,LN(i));var c=t.length,l=c;for(c&&xN(t,"-");l<r;){var d=bN;for(n=0;n<e.length;n++)(i=e[n])>=o&&i<d&&(d=i);var u=l+1;if(d-o>kN((bN-s)/u))throw DN(NN);for(s+=(d-o)*u,o=d,n=0;n<e.length;n++){if((i=e[n])<o&&++s>bN)throw DN(NN);if(i==o){for(var h=s,p=36;;){var f=p<=a?1:p>=a+26?26:p-a;if(h<f)break;var m=h-f,_=36-f;xN(t,LN(BN(f+m%_))),h=kN(m/_),p+=36}xN(t,LN(BN(h))),a=GN(s,u,l==c),s=0,l++}}s++,o++}return UN(t,"")},HN=Nn,KN=D,zN=sT,qN=p,YN=Qt,JN=d,XN=pa,QN=hc,ZN=vc,$N=$e,eD=hN,tD=function(e){var t=EN(e),n=TN(this),i=arguments.length,r=i>1?arguments[1]:void 0,o=void 0!==r;o&&(r=mN(r,i>2?arguments[2]:void 0));var s,a,c,l,d,u,h=RN(t),p=0;if(!h||this===wN&&vN(h))for(s=SN(t),a=n?new this(s):wN(s);s>p;p++)u=o?r(t[p],p):t[p],yN(a,p,u);else for(d=(l=CN(t,h)).next,a=n?new this:[];!(c=_N(d,l)).done;p++)u=o?gN(l,r,[c.value,p],!0):c.value,yN(a,p,u);return a.length=p,a},nD=yf,iD=yh.codeAt,rD=function(e){var t,n,i=[],r=FN(VN(jN(e),ON,"."),".");for(t=0;t<r.length;t++)n=r[t],xN(i,PN(AN,n)?"xn--"+WN(n):n);return UN(i,".")},oD=Ei,sD=Pa,aD=Zc,cD=yS,lD=oa,dD=lD.set,uD=lD.getterFor("URL"),hD=cD.URLSearchParams,pD=cD.getState,fD=qN.URL,mD=qN.TypeError,_D=qN.parseInt,ED=Math.floor,gD=Math.pow,vD=JN("".charAt),TD=JN(/./.exec),SD=JN([].join),yD=JN(1..toString),CD=JN([].pop),RD=JN([].push),wD=JN("".replace),ID=JN([].shift),bD=JN("".split),AD=JN("".slice),OD=JN("".toLowerCase),ND=JN([].unshift),DD="Invalid scheme",PD="Invalid host",kD="Invalid port",LD=/[a-z]/i,MD=/[\d+-.a-z]/i,UD=/\d/,xD=/^0x/i,VD=/^[0-7]+$/,FD=/^\d+$/,jD=/^[\da-f]+$/i,BD=/[\0\t\n\r #%/:<>?@[\\\]^|]/,GD=/[\0\t\n\r #/:<>?@[\\\]^|]/,WD=/^[\u0000-\u0020]+/,HD=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,KD=/[\t\n\r]/g,zD=function(e){var t,n,i,r;if("number"==typeof e){for(t=[],n=0;n<4;n++)ND(t,e%256),e=ED(e/256);return SD(t,".")}if("object"==typeof e){for(t="",i=function(e){for(var t=null,n=1,i=null,r=0,o=0;o<8;o++)0!==e[o]?(r>n&&(t=i,n=r),i=null,r=0):(null===i&&(i=o),++r);return r>n&&(t=i,n=r),t}(e),n=0;n<8;n++)r&&0===e[n]||(r&&(r=!1),i===n?(t+=n?":":"::",r=!0):(t+=yD(e[n],16),n<7&&(t+=":")));return"["+t+"]"}return e},qD={},YD=eD({},qD,{" ":1,'"':1,"<":1,">":1,"`":1}),JD=eD({},YD,{"#":1,"?":1,"{":1,"}":1}),XD=eD({},JD,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),QD=function(e,t){var n=iD(e,0);return n>32&&n<127&&!$N(t,e)?e:encodeURIComponent(e)},ZD={ftp:21,file:null,http:80,https:443,ws:80,wss:443},$D=function(e,t){var n;return 2==e.length&&TD(LD,vD(e,0))&&(":"==(n=vD(e,1))||!t&&"|"==n)},eP=function(e){var t;return e.length>1&&$D(AD(e,0,2))&&(2==e.length||"/"===(t=vD(e,2))||"\\"===t||"?"===t||"#"===t)},tP=function(e){return"."===e||"%2e"===OD(e)},nP={},iP={},rP={},oP={},sP={},aP={},cP={},lP={},dP={},uP={},hP={},pP={},fP={},mP={},_P={},EP={},gP={},vP={},TP={},SP={},yP={},CP=function(e,t,n){var i,r,o,s=oD(e);if(t){if(r=this.parse(s))throw mD(r);this.searchParams=null}else{if(void 0!==n&&(i=new CP(n,!0)),r=this.parse(s,null,i))throw mD(r);(o=pD(new hD)).bindURL(this),this.searchParams=o}};CP.prototype={type:"URL",parse:function(e,t,n){var i,r,o,s,a,c=this,l=t||nP,d=0,u="",h=!1,p=!1,f=!1;for(e=oD(e),t||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,e=wD(e,WD,""),e=wD(e,HD,"$1")),e=wD(e,KD,""),i=tD(e);d<=i.length;){switch(r=i[d],l){case nP:if(!r||!TD(LD,r)){if(t)return DD;l=rP;continue}u+=OD(r),l=iP;break;case iP:if(r&&(TD(MD,r)||"+"==r||"-"==r||"."==r))u+=OD(r);else{if(":"!=r){if(t)return DD;u="",l=rP,d=0;continue}if(t&&(c.isSpecial()!=$N(ZD,u)||"file"==u&&(c.includesCredentials()||null!==c.port)||"file"==c.scheme&&!c.host))return;if(c.scheme=u,t)return void(c.isSpecial()&&ZD[c.scheme]==c.port&&(c.port=null));u="","file"==c.scheme?l=mP:c.isSpecial()&&n&&n.scheme==c.scheme?l=oP:c.isSpecial()?l=lP:"/"==i[d+1]?(l=sP,d++):(c.cannotBeABaseURL=!0,RD(c.path,""),l=TP)}break;case rP:if(!n||n.cannotBeABaseURL&&"#"!=r)return DD;if(n.cannotBeABaseURL&&"#"==r){c.scheme=n.scheme,c.path=nD(n.path),c.query=n.query,c.fragment="",c.cannotBeABaseURL=!0,l=yP;break}l="file"==n.scheme?mP:aP;continue;case oP:if("/"!=r||"/"!=i[d+1]){l=aP;continue}l=dP,d++;break;case sP:if("/"==r){l=uP;break}l=vP;continue;case aP:if(c.scheme=n.scheme,r==ZO)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=nD(n.path),c.query=n.query;else if("/"==r||"\\"==r&&c.isSpecial())l=cP;else if("?"==r)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=nD(n.path),c.query="",l=SP;else{if("#"!=r){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=nD(n.path),c.path.length--,l=vP;continue}c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=nD(n.path),c.query=n.query,c.fragment="",l=yP}break;case cP:if(!c.isSpecial()||"/"!=r&&"\\"!=r){if("/"!=r){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,l=vP;continue}l=uP}else l=dP;break;case lP:if(l=dP,"/"!=r||"/"!=vD(u,d+1))continue;d++;break;case dP:if("/"!=r&&"\\"!=r){l=uP;continue}break;case uP:if("@"==r){h&&(u="%40"+u),h=!0,o=tD(u);for(var m=0;m<o.length;m++){var _=o[m];if(":"!=_||f){var E=QD(_,XD);f?c.password+=E:c.username+=E}else f=!0}u=""}else if(r==ZO||"/"==r||"?"==r||"#"==r||"\\"==r&&c.isSpecial()){if(h&&""==u)return"Invalid authority";d-=tD(u).length+1,u="",l=hP}else u+=r;break;case hP:case pP:if(t&&"file"==c.scheme){l=EP;continue}if(":"!=r||p){if(r==ZO||"/"==r||"?"==r||"#"==r||"\\"==r&&c.isSpecial()){if(c.isSpecial()&&""==u)return PD;if(t&&""==u&&(c.includesCredentials()||null!==c.port))return;if(s=c.parseHost(u))return s;if(u="",l=gP,t)return;continue}"["==r?p=!0:"]"==r&&(p=!1),u+=r}else{if(""==u)return PD;if(s=c.parseHost(u))return s;if(u="",l=fP,t==pP)return}break;case fP:if(!TD(UD,r)){if(r==ZO||"/"==r||"?"==r||"#"==r||"\\"==r&&c.isSpecial()||t){if(""!=u){var g=_D(u,10);if(g>65535)return kD;c.port=c.isSpecial()&&g===ZD[c.scheme]?null:g,u=""}if(t)return;l=gP;continue}return kD}u+=r;break;case mP:if(c.scheme="file","/"==r||"\\"==r)l=_P;else{if(!n||"file"!=n.scheme){l=vP;continue}if(r==ZO)c.host=n.host,c.path=nD(n.path),c.query=n.query;else if("?"==r)c.host=n.host,c.path=nD(n.path),c.query="",l=SP;else{if("#"!=r){eP(SD(nD(i,d),""))||(c.host=n.host,c.path=nD(n.path),c.shortenPath()),l=vP;continue}c.host=n.host,c.path=nD(n.path),c.query=n.query,c.fragment="",l=yP}}break;case _P:if("/"==r||"\\"==r){l=EP;break}n&&"file"==n.scheme&&!eP(SD(nD(i,d),""))&&($D(n.path[0],!0)?RD(c.path,n.path[0]):c.host=n.host),l=vP;continue;case EP:if(r==ZO||"/"==r||"\\"==r||"?"==r||"#"==r){if(!t&&$D(u))l=vP;else if(""==u){if(c.host="",t)return;l=gP}else{if(s=c.parseHost(u))return s;if("localhost"==c.host&&(c.host=""),t)return;u="",l=gP}continue}u+=r;break;case gP:if(c.isSpecial()){if(l=vP,"/"!=r&&"\\"!=r)continue}else if(t||"?"!=r)if(t||"#"!=r){if(r!=ZO&&(l=vP,"/"!=r))continue}else c.fragment="",l=yP;else c.query="",l=SP;break;case vP:if(r==ZO||"/"==r||"\\"==r&&c.isSpecial()||!t&&("?"==r||"#"==r)){if(".."===(a=OD(a=u))||"%2e."===a||".%2e"===a||"%2e%2e"===a?(c.shortenPath(),"/"==r||"\\"==r&&c.isSpecial()||RD(c.path,"")):tP(u)?"/"==r||"\\"==r&&c.isSpecial()||RD(c.path,""):("file"==c.scheme&&!c.path.length&&$D(u)&&(c.host&&(c.host=""),u=vD(u,0)+":"),RD(c.path,u)),u="","file"==c.scheme&&(r==ZO||"?"==r||"#"==r))for(;c.path.length>1&&""===c.path[0];)ID(c.path);"?"==r?(c.query="",l=SP):"#"==r&&(c.fragment="",l=yP)}else u+=QD(r,JD);break;case TP:"?"==r?(c.query="",l=SP):"#"==r?(c.fragment="",l=yP):r!=ZO&&(c.path[0]+=QD(r,qD));break;case SP:t||"#"!=r?r!=ZO&&("'"==r&&c.isSpecial()?c.query+="%27":c.query+="#"==r?"%23":QD(r,qD)):(c.fragment="",l=yP);break;case yP:r!=ZO&&(c.fragment+=QD(r,YD))}d++}},parseHost:function(e){var t,n,i;if("["==vD(e,0)){if("]"!=vD(e,e.length-1))return PD;if(t=function(e){var t,n,i,r,o,s,a,c=[0,0,0,0,0,0,0,0],l=0,d=null,u=0,h=function(){return vD(e,u)};if(":"==h()){if(":"!=vD(e,1))return;u+=2,d=++l}for(;h();){if(8==l)return;if(":"!=h()){for(t=n=0;n<4&&TD(jD,h());)t=16*t+_D(h(),16),u++,n++;if("."==h()){if(0==n)return;if(u-=n,l>6)return;for(i=0;h();){if(r=null,i>0){if(!("."==h()&&i<4))return;u++}if(!TD(UD,h()))return;for(;TD(UD,h());){if(o=_D(h(),10),null===r)r=o;else{if(0==r)return;r=10*r+o}if(r>255)return;u++}c[l]=256*c[l]+r,2!=++i&&4!=i||l++}if(4!=i)return;break}if(":"==h()){if(u++,!h())return}else if(h())return;c[l++]=t}else{if(null!==d)return;u++,d=++l}}if(null!==d)for(s=l-d,l=7;0!=l&&s>0;)a=c[l],c[l--]=c[d+s-1],c[d+--s]=a;else if(8!=l)return;return c}(AD(e,1,-1)),!t)return PD;this.host=t}else if(this.isSpecial()){if(e=rD(e),TD(BD,e))return PD;if(t=function(e){var t,n,i,r,o,s,a,c=bD(e,".");if(c.length&&""==c[c.length-1]&&c.length--,(t=c.length)>4)return e;for(n=[],i=0;i<t;i++){if(""==(r=c[i]))return e;if(o=10,r.length>1&&"0"==vD(r,0)&&(o=TD(xD,r)?16:8,r=AD(r,8==o?1:2)),""===r)s=0;else{if(!TD(10==o?FD:8==o?VD:jD,r))return e;s=_D(r,o)}RD(n,s)}for(i=0;i<t;i++)if(s=n[i],i==t-1){if(s>=gD(256,5-t))return null}else if(s>255)return null;for(a=CD(n),i=0;i<n.length;i++)a+=n[i]*gD(256,3-i);return a}(e),null===t)return PD;this.host=t}else{if(TD(GD,e))return PD;for(t="",n=tD(e),i=0;i<n.length;i++)t+=QD(n[i],qD);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||"file"==this.scheme},includesCredentials:function(){return""!=this.username||""!=this.password},isSpecial:function(){return $N(ZD,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||"file"==this.scheme&&1==t&&$D(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,n=e.username,i=e.password,r=e.host,o=e.port,s=e.path,a=e.query,c=e.fragment,l=t+":";return null!==r?(l+="//",e.includesCredentials()&&(l+=n+(i?":"+i:"")+"@"),l+=zD(r),null!==o&&(l+=":"+o)):"file"==t&&(l+="//"),l+=e.cannotBeABaseURL?s[0]:s.length?"/"+SD(s,"/"):"",null!==a&&(l+="?"+a),null!==c&&(l+="#"+c),l},setHref:function(e){var t=this.parse(e);if(t)throw mD(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if("blob"==e)try{return new RP(e.path[0]).origin}catch(e){return"null"}return"file"!=e&&this.isSpecial()?e+"://"+zD(this.host)+(null!==t?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(oD(e)+":",nP)},getUsername:function(){return this.username},setUsername:function(e){var t=tD(oD(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<t.length;n++)this.username+=QD(t[n],XD)}},getPassword:function(){return this.password},setPassword:function(e){var t=tD(oD(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<t.length;n++)this.password+=QD(t[n],XD)}},getHost:function(){var e=this.host,t=this.port;return null===e?"":null===t?zD(e):zD(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,hP)},getHostname:function(){var e=this.host;return null===e?"":zD(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,pP)},getPort:function(){var e=this.port;return null===e?"":oD(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||(""==(e=oD(e))?this.port=null:this.parse(e,fP))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+SD(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,gP))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){""==(e=oD(e))?this.query=null:("?"==vD(e,0)&&(e=AD(e,1)),this.query="",this.parse(e,SP)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){""!=(e=oD(e))?("#"==vD(e,0)&&(e=AD(e,1)),this.fragment="",this.parse(e,yP)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var RP=function(e){var t=ZN(this,wP),n=aD(arguments.length,1)>1?arguments[1]:void 0,i=dD(t,new CP(e,!1,n));KN||(t.href=i.serialize(),t.origin=i.getOrigin(),t.protocol=i.getProtocol(),t.username=i.getUsername(),t.password=i.getPassword(),t.host=i.getHost(),t.hostname=i.getHostname(),t.port=i.getPort(),t.pathname=i.getPathname(),t.search=i.getSearch(),t.searchParams=i.getSearchParams(),t.hash=i.getHash())},wP=RP.prototype,IP=function(e,t){return{get:function(){return uD(this)[e]()},set:t&&function(e){return uD(this)[t](e)},configurable:!0,enumerable:!0}};if(KN&&(QN(wP,"href",IP("serialize","setHref")),QN(wP,"origin",IP("getOrigin")),QN(wP,"protocol",IP("getProtocol","setProtocol")),QN(wP,"username",IP("getUsername","setUsername")),QN(wP,"password",IP("getPassword","setPassword")),QN(wP,"host",IP("getHost","setHost")),QN(wP,"hostname",IP("getHostname","setHostname")),QN(wP,"port",IP("getPort","setPort")),QN(wP,"pathname",IP("getPathname","setPathname")),QN(wP,"search",IP("getSearch","setSearch")),QN(wP,"searchParams",IP("getSearchParams")),QN(wP,"hash",IP("getHash","setHash"))),XN(wP,"toJSON",(function(){return uD(this).serialize()}),{enumerable:!0}),XN(wP,"toString",(function(){return uD(this).serialize()}),{enumerable:!0}),fD){var bP=fD.createObjectURL,AP=fD.revokeObjectURL;bP&&XN(RP,"createObjectURL",YN(bP,fD)),AP&&XN(RP,"revokeObjectURL",YN(AP,fD))}sD(RP,"URL"),HN({global:!0,constructor:!0,forced:!zN,sham:!KN},{URL:RP});var OP=Nn,NP=r,DP=Zc,PP=Ei,kP=sT,LP=ce("URL");OP({target:"URL",stat:!0,forced:!(kP&&NP((function(){LP.canParse()})))},{canParse:function(e){var t=DP(arguments.length,1),n=PP(e),i=t<2||void 0===arguments[1]?void 0:PP(arguments[1]);try{return!!new LP(n,i)}catch(e){return!1}}});var MP=i(ie.URL),UP=u,xP=VS,VP=RegExp.prototype,FP=function(e){return e===VP||UP(VP,e)?xP(e):e.flags},jP=i(FP);function BP(e){let t=e.length;for(;--t>=0;)e[t]=0}const GP=256,WP=286,HP=30,KP=15,zP=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),qP=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),YP=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),JP=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),XP=new Array(576);BP(XP);const QP=new Array(60);BP(QP);const ZP=new Array(512);BP(ZP);const $P=new Array(256);BP($P);const ek=new Array(29);BP(ek);const tk=new Array(HP);function nk(e,t,n,i,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=e&&e.length}let ik,rk,ok;function sk(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}BP(tk);const ak=e=>e<256?ZP[e]:ZP[256+(e>>>7)],ck=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},lk=(e,t,n)=>{e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,ck(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)},dk=(e,t,n)=>{lk(e,n[2*t],n[2*t+1])},uk=(e,t)=>{let n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1},hk=(e,t,n)=>{const i=new Array(16);let r,o,s=0;for(r=1;r<=KP;r++)s=s+n[r-1]<<1,i[r]=s;for(o=0;o<=t;o++){let t=e[2*o+1];0!==t&&(e[2*o]=uk(i[t]++,t))}},pk=e=>{let t;for(t=0;t<WP;t++)e.dyn_ltree[2*t]=0;for(t=0;t<HP;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},fk=e=>{e.bi_valid>8?ck(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},mk=(e,t,n,i)=>{const r=2*t,o=2*n;return e[r]<e[o]||e[r]===e[o]&&i[t]<=i[n]},_k=(e,t,n)=>{const i=e.heap[n];let r=n<<1;for(;r<=e.heap_len&&(r<e.heap_len&&mk(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!mk(t,i,e.heap[r],e.depth));)e.heap[n]=e.heap[r],n=r,r<<=1;e.heap[n]=i},Ek=(e,t,n)=>{let i,r,o,s,a=0;if(0!==e.sym_next)do{i=255&e.pending_buf[e.sym_buf+a++],i+=(255&e.pending_buf[e.sym_buf+a++])<<8,r=e.pending_buf[e.sym_buf+a++],0===i?dk(e,r,t):(o=$P[r],dk(e,o+GP+1,t),s=zP[o],0!==s&&(r-=ek[o],lk(e,r,s)),i--,o=ak(i),dk(e,o,n),s=qP[o],0!==s&&(i-=tk[o],lk(e,i,s)))}while(a<e.sym_next);dk(e,256,t)},gk=(e,t)=>{const n=t.dyn_tree,i=t.stat_desc.static_tree,r=t.stat_desc.has_stree,o=t.stat_desc.elems;let s,a,c,l=-1;for(e.heap_len=0,e.heap_max=573,s=0;s<o;s++)0!==n[2*s]?(e.heap[++e.heap_len]=l=s,e.depth[s]=0):n[2*s+1]=0;for(;e.heap_len<2;)c=e.heap[++e.heap_len]=l<2?++l:0,n[2*c]=1,e.depth[c]=0,e.opt_len--,r&&(e.static_len-=i[2*c+1]);for(t.max_code=l,s=e.heap_len>>1;s>=1;s--)_k(e,n,s);c=o;do{s=e.heap[1],e.heap[1]=e.heap[e.heap_len--],_k(e,n,1),a=e.heap[1],e.heap[--e.heap_max]=s,e.heap[--e.heap_max]=a,n[2*c]=n[2*s]+n[2*a],e.depth[c]=(e.depth[s]>=e.depth[a]?e.depth[s]:e.depth[a])+1,n[2*s+1]=n[2*a+1]=c,e.heap[1]=c++,_k(e,n,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const n=t.dyn_tree,i=t.max_code,r=t.stat_desc.static_tree,o=t.stat_desc.has_stree,s=t.stat_desc.extra_bits,a=t.stat_desc.extra_base,c=t.stat_desc.max_length;let l,d,u,h,p,f,m=0;for(h=0;h<=KP;h++)e.bl_count[h]=0;for(n[2*e.heap[e.heap_max]+1]=0,l=e.heap_max+1;l<573;l++)d=e.heap[l],h=n[2*n[2*d+1]+1]+1,h>c&&(h=c,m++),n[2*d+1]=h,d>i||(e.bl_count[h]++,p=0,d>=a&&(p=s[d-a]),f=n[2*d],e.opt_len+=f*(h+p),o&&(e.static_len+=f*(r[2*d+1]+p)));if(0!==m){do{for(h=c-1;0===e.bl_count[h];)h--;e.bl_count[h]--,e.bl_count[h+1]+=2,e.bl_count[c]--,m-=2}while(m>0);for(h=c;0!==h;h--)for(d=e.bl_count[h];0!==d;)u=e.heap[--l],u>i||(n[2*u+1]!==h&&(e.opt_len+=(h-n[2*u+1])*n[2*u],n[2*u+1]=h),d--)}})(e,t),hk(n,l,e.bl_count)},vk=(e,t,n)=>{let i,r,o=-1,s=t[1],a=0,c=7,l=4;for(0===s&&(c=138,l=3),t[2*(n+1)+1]=65535,i=0;i<=n;i++)r=s,s=t[2*(i+1)+1],++a<c&&r===s||(a<l?e.bl_tree[2*r]+=a:0!==r?(r!==o&&e.bl_tree[2*r]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,o=r,0===s?(c=138,l=3):r===s?(c=6,l=3):(c=7,l=4))},Tk=(e,t,n)=>{let i,r,o=-1,s=t[1],a=0,c=7,l=4;for(0===s&&(c=138,l=3),i=0;i<=n;i++)if(r=s,s=t[2*(i+1)+1],!(++a<c&&r===s)){if(a<l)do{dk(e,r,e.bl_tree)}while(0!=--a);else 0!==r?(r!==o&&(dk(e,r,e.bl_tree),a--),dk(e,16,e.bl_tree),lk(e,a-3,2)):a<=10?(dk(e,17,e.bl_tree),lk(e,a-3,3)):(dk(e,18,e.bl_tree),lk(e,a-11,7));a=0,o=r,0===s?(c=138,l=3):r===s?(c=6,l=3):(c=7,l=4)}};let Sk=!1;const yk=(e,t,n,i)=>{lk(e,0+(i?1:0),3),fk(e),ck(e,n),ck(e,~n),n&&e.pending_buf.set(e.window.subarray(t,t+n),e.pending),e.pending+=n};var Ck=e=>{Sk||((()=>{let e,t,n,i,r;const o=new Array(16);for(n=0,i=0;i<28;i++)for(ek[i]=n,e=0;e<1<<zP[i];e++)$P[n++]=i;for($P[n-1]=i,r=0,i=0;i<16;i++)for(tk[i]=r,e=0;e<1<<qP[i];e++)ZP[r++]=i;for(r>>=7;i<HP;i++)for(tk[i]=r<<7,e=0;e<1<<qP[i]-7;e++)ZP[256+r++]=i;for(t=0;t<=KP;t++)o[t]=0;for(e=0;e<=143;)XP[2*e+1]=8,e++,o[8]++;for(;e<=255;)XP[2*e+1]=9,e++,o[9]++;for(;e<=279;)XP[2*e+1]=7,e++,o[7]++;for(;e<=287;)XP[2*e+1]=8,e++,o[8]++;for(hk(XP,287,o),e=0;e<HP;e++)QP[2*e+1]=5,QP[2*e]=uk(e,5);ik=new nk(XP,zP,257,WP,KP),rk=new nk(QP,qP,0,HP,KP),ok=new nk(new Array(0),YP,0,19,7)})(),Sk=!0),e.l_desc=new sk(e.dyn_ltree,ik),e.d_desc=new sk(e.dyn_dtree,rk),e.bl_desc=new sk(e.bl_tree,ok),e.bi_buf=0,e.bi_valid=0,pk(e)},Rk=(e,t,n,i)=>{let r,o,s=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,n=4093624447;for(t=0;t<=31;t++,n>>>=1)if(1&n&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<GP;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),gk(e,e.l_desc),gk(e,e.d_desc),s=(e=>{let t;for(vk(e,e.dyn_ltree,e.l_desc.max_code),vk(e,e.dyn_dtree,e.d_desc.max_code),gk(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*JP[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),r=e.opt_len+3+7>>>3,o=e.static_len+3+7>>>3,o<=r&&(r=o)):r=o=n+5,n+4<=r&&-1!==t?yk(e,t,n,i):4===e.strategy||o===r?(lk(e,2+(i?1:0),3),Ek(e,XP,QP)):(lk(e,4+(i?1:0),3),((e,t,n,i)=>{let r;for(lk(e,t-257,5),lk(e,n-1,5),lk(e,i-4,4),r=0;r<i;r++)lk(e,e.bl_tree[2*JP[r]+1],3);Tk(e,e.dyn_ltree,t-1),Tk(e,e.dyn_dtree,n-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),Ek(e,e.dyn_ltree,e.dyn_dtree)),pk(e),i&&fk(e)},wk=(e,t,n)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=n,0===t?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*($P[n]+GP+1)]++,e.dyn_dtree[2*ak(t)]++),e.sym_next===e.sym_end),Ik=e=>{lk(e,2,3),dk(e,256,XP),(e=>{16===e.bi_valid?(ck(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)},bk={_tr_init:Ck,_tr_stored_block:yk,_tr_flush_block:Rk,_tr_tally:wk,_tr_align:Ik},Ak=(e,t,n,i)=>{let r=65535&e,o=e>>>16&65535,s=0;for(;0!==n;){s=n>2e3?2e3:n,n-=s;do{r=r+t[i++]|0,o=o+r|0}while(--s);r%=65521,o%=65521}return r|o<<16};const Ok=new Uint32Array((()=>{let e,t=[];for(var n=0;n<256;n++){e=n;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t})());var Nk=(e,t,n,i)=>{const r=Ok,o=i+n;e^=-1;for(let s=i;s<o;s++)e=e>>>8^r[255&(e^t[s])];return~e},Dk={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Pk={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:kk,_tr_stored_block:Lk,_tr_flush_block:Mk,_tr_tally:Uk,_tr_align:xk}=bk,{Z_NO_FLUSH:Vk,Z_PARTIAL_FLUSH:Fk,Z_FULL_FLUSH:jk,Z_FINISH:Bk,Z_BLOCK:Gk,Z_OK:Wk,Z_STREAM_END:Hk,Z_STREAM_ERROR:Kk,Z_DATA_ERROR:zk,Z_BUF_ERROR:qk,Z_DEFAULT_COMPRESSION:Yk,Z_FILTERED:Jk,Z_HUFFMAN_ONLY:Xk,Z_RLE:Qk,Z_FIXED:Zk,Z_DEFAULT_STRATEGY:$k,Z_UNKNOWN:eL,Z_DEFLATED:tL}=Pk,nL=286,iL=30,rL=19,oL=2*nL+1,sL=15,aL=258,cL=262,lL=42,dL=113,uL=666,hL=(e,t)=>(e.msg=Dk[t],t),pL=e=>2*e-(e>4?9:0),fL=e=>{let t=e.length;for(;--t>=0;)e[t]=0},mL=e=>{let t,n,i,r=e.w_size;t=e.hash_size,i=t;do{n=e.head[--i],e.head[i]=n>=r?n-r:0}while(--t);t=r,i=t;do{n=e.prev[--i],e.prev[i]=n>=r?n-r:0}while(--t)};let _L=(e,t,n)=>(t<<e.hash_shift^n)&e.hash_mask;const EL=e=>{const t=e.state;let n=t.pending;n>e.avail_out&&(n=e.avail_out),0!==n&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+n),e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,0===t.pending&&(t.pending_out=0))},gL=(e,t)=>{Mk(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,EL(e.strm)},vL=(e,t)=>{e.pending_buf[e.pending++]=t},TL=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},SL=(e,t,n,i)=>{let r=e.avail_in;return r>i&&(r=i),0===r?0:(e.avail_in-=r,t.set(e.input.subarray(e.next_in,e.next_in+r),n),1===e.state.wrap?e.adler=Ak(e.adler,t,r,n):2===e.state.wrap&&(e.adler=Nk(e.adler,t,r,n)),e.next_in+=r,e.total_in+=r,r)},yL=(e,t)=>{let n,i,r=e.max_chain_length,o=e.strstart,s=e.prev_length,a=e.nice_match;const c=e.strstart>e.w_size-cL?e.strstart-(e.w_size-cL):0,l=e.window,d=e.w_mask,u=e.prev,h=e.strstart+aL;let p=l[o+s-1],f=l[o+s];e.prev_length>=e.good_match&&(r>>=2),a>e.lookahead&&(a=e.lookahead);do{if(n=t,l[n+s]===f&&l[n+s-1]===p&&l[n]===l[o]&&l[++n]===l[o+1]){o+=2,n++;do{}while(l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&l[++o]===l[++n]&&o<h);if(i=aL-(h-o),o=h-aL,i>s){if(e.match_start=t,s=i,i>=a)break;p=l[o+s-1],f=l[o+s]}}}while((t=u[t&d])>c&&0!=--r);return s<=e.lookahead?s:e.lookahead},CL=e=>{const t=e.w_size;let n,i,r;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-cL)&&(e.window.set(e.window.subarray(t,t+t-i),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),mL(e),i+=t),0===e.strm.avail_in)break;if(n=SL(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=n,e.lookahead+e.insert>=3)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=_L(e,e.ins_h,e.window[r+1]);e.insert&&(e.ins_h=_L(e,e.ins_h,e.window[r+3-1]),e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<cL&&0!==e.strm.avail_in)},RL=(e,t)=>{let n,i,r,o=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,s=0,a=e.strm.avail_in;do{if(n=65535,r=e.bi_valid+42>>3,e.strm.avail_out<r)break;if(r=e.strm.avail_out-r,i=e.strstart-e.block_start,n>i+e.strm.avail_in&&(n=i+e.strm.avail_in),n>r&&(n=r),n<o&&(0===n&&t!==Bk||t===Vk||n!==i+e.strm.avail_in))break;s=t===Bk&&n===i+e.strm.avail_in?1:0,Lk(e,0,0,s),e.pending_buf[e.pending-4]=n,e.pending_buf[e.pending-3]=n>>8,e.pending_buf[e.pending-2]=~n,e.pending_buf[e.pending-1]=~n>>8,EL(e.strm),i&&(i>n&&(i=n),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+i),e.strm.next_out),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i,e.block_start+=i,n-=i),n&&(SL(e.strm,e.strm.output,e.strm.next_out,n),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n)}while(0===s);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),s?4:t!==Vk&&t!==Bk&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(r=e.window_size-e.strstart,e.strm.avail_in>r&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,r+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),r>e.strm.avail_in&&(r=e.strm.avail_in),r&&(SL(e.strm,e.window,e.strstart,r),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.high_water<e.strstart&&(e.high_water=e.strstart),r=e.bi_valid+42>>3,r=e.pending_buf_size-r>65535?65535:e.pending_buf_size-r,o=r>e.w_size?e.w_size:r,i=e.strstart-e.block_start,(i>=o||(i||t===Bk)&&t!==Vk&&0===e.strm.avail_in&&i<=r)&&(n=i>r?r:i,s=t===Bk&&0===e.strm.avail_in&&n===i?1:0,Lk(e,e.block_start,n,s),e.block_start+=n,EL(e.strm)),s?3:1)},wL=(e,t)=>{let n,i;for(;;){if(e.lookahead<cL){if(CL(e),e.lookahead<cL&&t===Vk)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=_L(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==n&&e.strstart-n<=e.w_size-cL&&(e.match_length=yL(e,n)),e.match_length>=3)if(i=Uk(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=_L(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=_L(e,e.ins_h,e.window[e.strstart+1]);else i=Uk(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(gL(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===Bk?(gL(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(gL(e,!1),0===e.strm.avail_out)?1:2},IL=(e,t)=>{let n,i,r;for(;;){if(e.lookahead<cL){if(CL(e),e.lookahead<cL&&t===Vk)return 1;if(0===e.lookahead)break}if(n=0,e.lookahead>=3&&(e.ins_h=_L(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==n&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-cL&&(e.match_length=yL(e,n),e.match_length<=5&&(e.strategy===Jk||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,i=Uk(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=_L(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(gL(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(i=Uk(e,0,e.window[e.strstart-1]),i&&gL(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=Uk(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===Bk?(gL(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(gL(e,!1),0===e.strm.avail_out)?1:2};function bL(e,t,n,i,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=r}const AL=[new bL(0,0,0,0,RL),new bL(4,4,8,4,wL),new bL(4,5,16,8,wL),new bL(4,6,32,32,wL),new bL(4,4,16,16,IL),new bL(8,16,32,32,IL),new bL(8,16,128,128,IL),new bL(8,32,128,256,IL),new bL(32,128,258,1024,IL),new bL(32,258,258,4096,IL)];function OL(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=tL,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*oL),this.dyn_dtree=new Uint16Array(2*(2*iL+1)),this.bl_tree=new Uint16Array(2*(2*rL+1)),fL(this.dyn_ltree),fL(this.dyn_dtree),fL(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(sL+1),this.heap=new Uint16Array(2*nL+1),fL(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*nL+1),fL(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const NL=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==lL&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&t.status!==dL&&t.status!==uL?1:0},DL=e=>{if(NL(e))return hL(e,Kk);e.total_in=e.total_out=0,e.data_type=eL;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?lL:dL,e.adler=2===t.wrap?0:1,t.last_flush=-2,kk(t),Wk},PL=e=>{const t=DL(e);return t===Wk&&(e=>{e.window_size=2*e.w_size,fL(e.head),e.max_lazy_match=AL[e.level].max_lazy,e.good_match=AL[e.level].good_length,e.nice_match=AL[e.level].nice_length,e.max_chain_length=AL[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0})(e.state),t},kL=(e,t,n,i,r,o)=>{if(!e)return Kk;let s=1;if(t===Yk&&(t=6),i<0?(s=0,i=-i):i>15&&(s=2,i-=16),r<1||r>9||n!==tL||i<8||i>15||t<0||t>9||o<0||o>Zk||8===i&&1!==s)return hL(e,Kk);8===i&&(i=9);const a=new OL;return e.state=a,a.strm=e,a.status=lL,a.wrap=s,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=o,a.method=n,PL(e)};var LL=(e,t)=>{if(NL(e)||t>Gk||t<0)return e?hL(e,Kk):Kk;const n=e.state;if(!e.output||0!==e.avail_in&&!e.input||n.status===uL&&t!==Bk)return hL(e,0===e.avail_out?qk:Kk);const i=n.last_flush;if(n.last_flush=t,0!==n.pending){if(EL(e),0===e.avail_out)return n.last_flush=-1,Wk}else if(0===e.avail_in&&pL(t)<=pL(i)&&t!==Bk)return hL(e,qk);if(n.status===uL&&0!==e.avail_in)return hL(e,qk);if(n.status===lL&&0===n.wrap&&(n.status=dL),n.status===lL){let t=tL+(n.w_bits-8<<4)<<8,i=-1;if(i=n.strategy>=Xk||n.level<2?0:n.level<6?1:6===n.level?2:3,t|=i<<6,0!==n.strstart&&(t|=32),t+=31-t%31,TL(n,t),0!==n.strstart&&(TL(n,e.adler>>>16),TL(n,65535&e.adler)),e.adler=1,n.status=dL,EL(e),0!==n.pending)return n.last_flush=-1,Wk}if(57===n.status)if(e.adler=0,vL(n,31),vL(n,139),vL(n,8),n.gzhead)vL(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),vL(n,255&n.gzhead.time),vL(n,n.gzhead.time>>8&255),vL(n,n.gzhead.time>>16&255),vL(n,n.gzhead.time>>24&255),vL(n,9===n.level?2:n.strategy>=Xk||n.level<2?4:0),vL(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(vL(n,255&n.gzhead.extra.length),vL(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=Nk(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(vL(n,0),vL(n,0),vL(n,0),vL(n,0),vL(n,0),vL(n,9===n.level?2:n.strategy>=Xk||n.level<2?4:0),vL(n,3),n.status=dL,EL(e),0!==n.pending)return n.last_flush=-1,Wk;if(69===n.status){if(n.gzhead.extra){let t=n.pending,i=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+i>n.pending_buf_size;){let r=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+r),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>t&&(e.adler=Nk(e.adler,n.pending_buf,n.pending-t,t)),n.gzindex+=r,EL(e),0!==n.pending)return n.last_flush=-1,Wk;t=0,i-=r}let r=new Uint8Array(n.gzhead.extra);n.pending_buf.set(r.subarray(n.gzindex,n.gzindex+i),n.pending),n.pending+=i,n.gzhead.hcrc&&n.pending>t&&(e.adler=Nk(e.adler,n.pending_buf,n.pending-t,t)),n.gzindex=0}n.status=73}if(73===n.status){if(n.gzhead.name){let t,i=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(e.adler=Nk(e.adler,n.pending_buf,n.pending-i,i)),EL(e),0!==n.pending)return n.last_flush=-1,Wk;i=0}t=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,vL(n,t)}while(0!==t);n.gzhead.hcrc&&n.pending>i&&(e.adler=Nk(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex=0}n.status=91}if(91===n.status){if(n.gzhead.comment){let t,i=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(e.adler=Nk(e.adler,n.pending_buf,n.pending-i,i)),EL(e),0!==n.pending)return n.last_flush=-1,Wk;i=0}t=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,vL(n,t)}while(0!==t);n.gzhead.hcrc&&n.pending>i&&(e.adler=Nk(e.adler,n.pending_buf,n.pending-i,i))}n.status=103}if(103===n.status){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(EL(e),0!==n.pending))return n.last_flush=-1,Wk;vL(n,255&e.adler),vL(n,e.adler>>8&255),e.adler=0}if(n.status=dL,EL(e),0!==n.pending)return n.last_flush=-1,Wk}if(0!==e.avail_in||0!==n.lookahead||t!==Vk&&n.status!==uL){let i=0===n.level?RL(n,t):n.strategy===Xk?((e,t)=>{let n;for(;;){if(0===e.lookahead&&(CL(e),0===e.lookahead)){if(t===Vk)return 1;break}if(e.match_length=0,n=Uk(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(gL(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===Bk?(gL(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(gL(e,!1),0===e.strm.avail_out)?1:2})(n,t):n.strategy===Qk?((e,t)=>{let n,i,r,o;const s=e.window;for(;;){if(e.lookahead<=aL){if(CL(e),e.lookahead<=aL&&t===Vk)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(r=e.strstart-1,i=s[r],i===s[++r]&&i===s[++r]&&i===s[++r])){o=e.strstart+aL;do{}while(i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&r<o);e.match_length=aL-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(n=Uk(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=Uk(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(gL(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===Bk?(gL(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(gL(e,!1),0===e.strm.avail_out)?1:2})(n,t):AL[n.level].func(n,t);if(3!==i&&4!==i||(n.status=uL),1===i||3===i)return 0===e.avail_out&&(n.last_flush=-1),Wk;if(2===i&&(t===Fk?xk(n):t!==Gk&&(Lk(n,0,0,!1),t===jk&&(fL(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),EL(e),0===e.avail_out))return n.last_flush=-1,Wk}return t!==Bk?Wk:n.wrap<=0?Hk:(2===n.wrap?(vL(n,255&e.adler),vL(n,e.adler>>8&255),vL(n,e.adler>>16&255),vL(n,e.adler>>24&255),vL(n,255&e.total_in),vL(n,e.total_in>>8&255),vL(n,e.total_in>>16&255),vL(n,e.total_in>>24&255)):(TL(n,e.adler>>>16),TL(n,65535&e.adler)),EL(e),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?Wk:Hk)},ML=(e,t)=>{let n=t.length;if(NL(e))return Kk;const i=e.state,r=i.wrap;if(2===r||1===r&&i.status!==lL||i.lookahead)return Kk;if(1===r&&(e.adler=Ak(e.adler,t,n,0)),i.wrap=0,n>=i.w_size){0===r&&(fL(i.head),i.strstart=0,i.block_start=0,i.insert=0);let e=new Uint8Array(i.w_size);e.set(t.subarray(n-i.w_size,n),0),t=e,n=i.w_size}const o=e.avail_in,s=e.next_in,a=e.input;for(e.avail_in=n,e.next_in=0,e.input=t,CL(i);i.lookahead>=3;){let e=i.strstart,t=i.lookahead-2;do{i.ins_h=_L(i,i.ins_h,i.window[e+3-1]),i.prev[e&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=e,e++}while(--t);i.strstart=e,i.lookahead=2,CL(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=s,e.input=a,e.avail_in=o,i.wrap=r,Wk},UL={deflateInit:(e,t)=>kL(e,t,tL,15,8,$k),deflateInit2:kL,deflateReset:PL,deflateResetKeep:DL,deflateSetHeader:(e,t)=>NL(e)||2!==e.state.wrap?Kk:(e.state.gzhead=t,Wk),deflate:LL,deflateEnd:e=>{if(NL(e))return Kk;const t=e.state.status;return e.state=null,t===dL?hL(e,zk):Wk},deflateSetDictionary:ML,deflateInfo:"pako deflate (from Nodeca project)"};const xL=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var VL={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const n=t.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(const t in n)xL(n,t)&&(e[t]=n[t])}}return e},flattenChunks:e=>{let t=0;for(let i=0,r=e.length;i<r;i++)t+=e[i].length;const n=new Uint8Array(t);for(let i=0,r=0,o=e.length;i<o;i++){let t=e[i];n.set(t,r),r+=t.length}return n}};let FL=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){FL=!1}const jL=new Uint8Array(256);for(let n=0;n<256;n++)jL[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;jL[254]=jL[254]=1;var BL={string2buf:e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,n,i,r,o,s=e.length,a=0;for(r=0;r<s;r++)n=e.charCodeAt(r),55296==(64512&n)&&r+1<s&&(i=e.charCodeAt(r+1),56320==(64512&i)&&(n=65536+(n-55296<<10)+(i-56320),r++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Uint8Array(a),o=0,r=0;o<a;r++)n=e.charCodeAt(r),55296==(64512&n)&&r+1<s&&(i=e.charCodeAt(r+1),56320==(64512&i)&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?t[o++]=n:n<2048?(t[o++]=192|n>>>6,t[o++]=128|63&n):n<65536?(t[o++]=224|n>>>12,t[o++]=128|n>>>6&63,t[o++]=128|63&n):(t[o++]=240|n>>>18,t[o++]=128|n>>>12&63,t[o++]=128|n>>>6&63,t[o++]=128|63&n);return t},buf2string:(e,t)=>{const n=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let i,r;const o=new Array(2*n);for(r=0,i=0;i<n;){let t=e[i++];if(t<128){o[r++]=t;continue}let s=jL[t];if(s>4)o[r++]=65533,i+=s-1;else{for(t&=2===s?31:3===s?15:7;s>1&&i<n;)t=t<<6|63&e[i++],s--;s>1?o[r++]=65533:t<65536?o[r++]=t:(t-=65536,o[r++]=55296|t>>10&1023,o[r++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&FL)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let n="";for(let i=0;i<t;i++)n+=String.fromCharCode(e[i]);return n})(o,r)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let n=t-1;for(;n>=0&&128==(192&e[n]);)n--;return n<0||0===n?t:n+jL[e[n]]>t?n:t}},GL=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const WL=Object.prototype.toString,{Z_NO_FLUSH:HL,Z_SYNC_FLUSH:KL,Z_FULL_FLUSH:zL,Z_FINISH:qL,Z_OK:YL,Z_STREAM_END:JL,Z_DEFAULT_COMPRESSION:XL,Z_DEFAULT_STRATEGY:QL,Z_DEFLATED:ZL}=Pk;function $L(e){this.options=VL.assign({level:XL,method:ZL,chunkSize:16384,windowBits:15,memLevel:8,strategy:QL},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new GL,this.strm.avail_out=0;let n=UL.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==YL)throw new Error(Dk[n]);if(t.header&&UL.deflateSetHeader(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?BL.string2buf(t.dictionary):"[object ArrayBuffer]"===WL.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,n=UL.deflateSetDictionary(this.strm,e),n!==YL)throw new Error(Dk[n]);this._dict_set=!0}}function eM(e,t){const n=new $L(t);if(n.push(e,!0),n.err)throw n.msg||Dk[n.err];return n.result}$L.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize;let r,o;if(this.ended)return!1;for(o=t===~~t?t:!0===t?qL:HL,"string"==typeof e?n.input=BL.string2buf(e):"[object ArrayBuffer]"===WL.call(e)?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;)if(0===n.avail_out&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(o===KL||o===zL)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(r=UL.deflate(n,o),r===JL)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=UL.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===YL;if(0!==n.avail_out){if(o>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(0===n.avail_in)break}else this.onData(n.output)}return!0},$L.prototype.onData=function(e){this.chunks.push(e)},$L.prototype.onEnd=function(e){e===YL&&(this.result=VL.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var tM={Deflate:$L,deflate:eM,deflateRaw:function(e,t){return(t=t||{}).raw=!0,eM(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,eM(e,t)},constants:Pk};const nM=16209;var iM=function(e,t){let n,i,r,o,s,a,c,l,d,u,h,p,f,m,_,E,g,v,T,S,y,C,R,w;const I=e.state;n=e.next_in,R=e.input,i=n+(e.avail_in-5),r=e.next_out,w=e.output,o=r-(t-e.avail_out),s=r+(e.avail_out-257),a=I.dmax,c=I.wsize,l=I.whave,d=I.wnext,u=I.window,h=I.hold,p=I.bits,f=I.lencode,m=I.distcode,_=(1<<I.lenbits)-1,E=(1<<I.distbits)-1;e:do{p<15&&(h+=R[n++]<<p,p+=8,h+=R[n++]<<p,p+=8),g=f[h&_];t:for(;;){if(v=g>>>24,h>>>=v,p-=v,v=g>>>16&255,0===v)w[r++]=65535&g;else{if(!(16&v)){if(0==(64&v)){g=f[(65535&g)+(h&(1<<v)-1)];continue t}if(32&v){I.mode=16191;break e}e.msg="invalid literal/length code",I.mode=nM;break e}T=65535&g,v&=15,v&&(p<v&&(h+=R[n++]<<p,p+=8),T+=h&(1<<v)-1,h>>>=v,p-=v),p<15&&(h+=R[n++]<<p,p+=8,h+=R[n++]<<p,p+=8),g=m[h&E];n:for(;;){if(v=g>>>24,h>>>=v,p-=v,v=g>>>16&255,!(16&v)){if(0==(64&v)){g=m[(65535&g)+(h&(1<<v)-1)];continue n}e.msg="invalid distance code",I.mode=nM;break e}if(S=65535&g,v&=15,p<v&&(h+=R[n++]<<p,p+=8,p<v&&(h+=R[n++]<<p,p+=8)),S+=h&(1<<v)-1,S>a){e.msg="invalid distance too far back",I.mode=nM;break e}if(h>>>=v,p-=v,v=r-o,S>v){if(v=S-v,v>l&&I.sane){e.msg="invalid distance too far back",I.mode=nM;break e}if(y=0,C=u,0===d){if(y+=c-v,v<T){T-=v;do{w[r++]=u[y++]}while(--v);y=r-S,C=w}}else if(d<v){if(y+=c+d-v,v-=d,v<T){T-=v;do{w[r++]=u[y++]}while(--v);if(y=0,d<T){v=d,T-=v;do{w[r++]=u[y++]}while(--v);y=r-S,C=w}}}else if(y+=d-v,v<T){T-=v;do{w[r++]=u[y++]}while(--v);y=r-S,C=w}for(;T>2;)w[r++]=C[y++],w[r++]=C[y++],w[r++]=C[y++],T-=3;T&&(w[r++]=C[y++],T>1&&(w[r++]=C[y++]))}else{y=r-S;do{w[r++]=w[y++],w[r++]=w[y++],w[r++]=w[y++],T-=3}while(T>2);T&&(w[r++]=w[y++],T>1&&(w[r++]=w[y++]))}break}}break}}while(n<i&&r<s);T=p>>3,n-=T,p-=T<<3,h&=(1<<p)-1,e.next_in=n,e.next_out=r,e.avail_in=n<i?i-n+5:5-(n-i),e.avail_out=r<s?s-r+257:257-(r-s),I.hold=h,I.bits=p};const rM=15,oM=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),sM=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),aM=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),cM=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var lM=(e,t,n,i,r,o,s,a)=>{const c=a.bits;let l,d,u,h,p,f,m=0,_=0,E=0,g=0,v=0,T=0,S=0,y=0,C=0,R=0,w=null;const I=new Uint16Array(16),b=new Uint16Array(16);let A,O,N,D=null;for(m=0;m<=rM;m++)I[m]=0;for(_=0;_<i;_++)I[t[n+_]]++;for(v=c,g=rM;g>=1&&0===I[g];g--);if(v>g&&(v=g),0===g)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(E=1;E<g&&0===I[E];E++);for(v<E&&(v=E),y=1,m=1;m<=rM;m++)if(y<<=1,y-=I[m],y<0)return-1;if(y>0&&(0===e||1!==g))return-1;for(b[1]=0,m=1;m<rM;m++)b[m+1]=b[m]+I[m];for(_=0;_<i;_++)0!==t[n+_]&&(s[b[t[n+_]]++]=_);if(0===e?(w=D=s,f=20):1===e?(w=oM,D=sM,f=257):(w=aM,D=cM,f=0),R=0,_=0,m=E,p=o,T=v,S=0,u=-1,C=1<<v,h=C-1,1===e&&C>852||2===e&&C>592)return 1;for(;;){A=m-S,s[_]+1<f?(O=0,N=s[_]):s[_]>=f?(O=D[s[_]-f],N=w[s[_]-f]):(O=96,N=0),l=1<<m-S,d=1<<T,E=d;do{d-=l,r[p+(R>>S)+d]=A<<24|O<<16|N}while(0!==d);for(l=1<<m-1;R&l;)l>>=1;if(0!==l?(R&=l-1,R+=l):R=0,_++,0==--I[m]){if(m===g)break;m=t[n+s[_]]}if(m>v&&(R&h)!==u){for(0===S&&(S=v),p+=E,T=m-S,y=1<<T;T+S<g&&(y-=I[T+S],!(y<=0));)T++,y<<=1;if(C+=1<<T,1===e&&C>852||2===e&&C>592)return 1;u=R&h,r[u]=v<<24|T<<16|p-o}}return 0!==R&&(r[p+R]=m-S<<24|64<<16),a.bits=v,0};const{Z_FINISH:dM,Z_BLOCK:uM,Z_TREES:hM,Z_OK:pM,Z_STREAM_END:fM,Z_NEED_DICT:mM,Z_STREAM_ERROR:_M,Z_DATA_ERROR:EM,Z_MEM_ERROR:gM,Z_BUF_ERROR:vM,Z_DEFLATED:TM}=Pk,SM=16180,yM=16190,CM=16191,RM=16192,wM=16194,IM=16199,bM=16200,AM=16206,OM=16209,NM=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function DM(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const PM=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<SM||t.mode>16211?1:0},kM=e=>{if(PM(e))return _M;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=SM,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,pM},LM=e=>{if(PM(e))return _M;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,kM(e)},MM=(e,t)=>{let n;if(PM(e))return _M;const i=e.state;return t<0?(n=0,t=-t):(n=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?_M:(null!==i.window&&i.wbits!==t&&(i.window=null),i.wrap=n,i.wbits=t,LM(e))},UM=(e,t)=>{if(!e)return _M;const n=new DM;e.state=n,n.strm=e,n.window=null,n.mode=SM;const i=MM(e,t);return i!==pM&&(e.state=null),i};let xM,VM,FM=!0;const jM=e=>{if(FM){xM=new Int32Array(512),VM=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(lM(1,e.lens,0,288,xM,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;lM(2,e.lens,0,32,VM,0,e.work,{bits:5}),FM=!1}e.lencode=xM,e.lenbits=9,e.distcode=VM,e.distbits=5},BM=(e,t,n,i)=>{let r;const o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(t.subarray(n-o.wsize,n),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>i&&(r=i),o.window.set(t.subarray(n-i,n-i+r),o.wnext),(i-=r)?(o.window.set(t.subarray(n-i,n),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var GM=(e,t)=>{let n,i,r,o,s,a,c,l,d,u,h,p,f,m,_,E,g,v,T,S,y,C,R=0;const w=new Uint8Array(4);let I,b;const A=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(PM(e)||!e.output||!e.input&&0!==e.avail_in)return _M;n=e.state,n.mode===CM&&(n.mode=RM),s=e.next_out,r=e.output,c=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,l=n.hold,d=n.bits,u=a,h=c,C=pM;e:for(;;)switch(n.mode){case SM:if(0===n.wrap){n.mode=RM;break}for(;d<16;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if(2&n.wrap&&35615===l){0===n.wbits&&(n.wbits=15),n.check=0,w[0]=255&l,w[1]=l>>>8&255,n.check=Nk(n.check,w,2,0),l=0,d=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&l)<<8)+(l>>8))%31){e.msg="incorrect header check",n.mode=OM;break}if((15&l)!==TM){e.msg="unknown compression method",n.mode=OM;break}if(l>>>=4,d-=4,y=8+(15&l),0===n.wbits&&(n.wbits=y),y>15||y>n.wbits){e.msg="invalid window size",n.mode=OM;break}n.dmax=1<<n.wbits,n.flags=0,e.adler=n.check=1,n.mode=512&l?16189:CM,l=0,d=0;break;case 16181:for(;d<16;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if(n.flags=l,(255&jP(n))!==TM){e.msg="unknown compression method",n.mode=OM;break}if(57344&jP(n)){e.msg="unknown header flags set",n.mode=OM;break}n.head&&(n.head.text=l>>8&1),512&jP(n)&&4&n.wrap&&(w[0]=255&l,w[1]=l>>>8&255,n.check=Nk(n.check,w,2,0)),l=0,d=0,n.mode=16182;case 16182:for(;d<32;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}n.head&&(n.head.time=l),512&jP(n)&&4&n.wrap&&(w[0]=255&l,w[1]=l>>>8&255,w[2]=l>>>16&255,w[3]=l>>>24&255,n.check=Nk(n.check,w,4,0)),l=0,d=0,n.mode=16183;case 16183:for(;d<16;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}n.head&&(n.head.xflags=255&l,n.head.os=l>>8),512&jP(n)&&4&n.wrap&&(w[0]=255&l,w[1]=l>>>8&255,n.check=Nk(n.check,w,2,0)),l=0,d=0,n.mode=16184;case 16184:if(1024&jP(n)){for(;d<16;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}n.length=l,n.head&&(n.head.extra_len=l),512&jP(n)&&4&n.wrap&&(w[0]=255&l,w[1]=l>>>8&255,n.check=Nk(n.check,w,2,0)),l=0,d=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&jP(n)&&(p=n.length,p>a&&(p=a),p&&(n.head&&(y=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(o,o+p),y)),512&jP(n)&&4&n.wrap&&(n.check=Nk(n.check,i,p,o)),a-=p,o+=p,n.length-=p),n.length))break e;n.length=0,n.mode=16186;case 16186:if(2048&jP(n)){if(0===a)break e;p=0;do{y=i[o+p++],n.head&&y&&n.length<65536&&(n.head.name+=String.fromCharCode(y))}while(y&&p<a);if(512&jP(n)&&4&n.wrap&&(n.check=Nk(n.check,i,p,o)),a-=p,o+=p,y)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&jP(n)){if(0===a)break e;p=0;do{y=i[o+p++],n.head&&y&&n.length<65536&&(n.head.comment+=String.fromCharCode(y))}while(y&&p<a);if(512&jP(n)&&4&n.wrap&&(n.check=Nk(n.check,i,p,o)),a-=p,o+=p,y)break e}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&jP(n)){for(;d<16;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if(4&n.wrap&&l!==(65535&n.check)){e.msg="header crc mismatch",n.mode=OM;break}l=0,d=0}n.head&&(n.head.hcrc=jP(n)>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=CM;break;case 16189:for(;d<32;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}e.adler=n.check=NM(l),l=0,d=0,n.mode=yM;case yM:if(0===n.havedict)return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=l,n.bits=d,mM;e.adler=n.check=1,n.mode=CM;case CM:if(t===uM||t===hM)break e;case RM:if(n.last){l>>>=7&d,d-=7&d,n.mode=AM;break}for(;d<3;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}switch(n.last=1&l,l>>>=1,d-=1,3&l){case 0:n.mode=16193;break;case 1:if(jM(n),n.mode=IM,t===hM){l>>>=2,d-=2;break e}break;case 2:n.mode=16196;break;case 3:e.msg="invalid block type",n.mode=OM}l>>>=2,d-=2;break;case 16193:for(l>>>=7&d,d-=7&d;d<32;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if((65535&l)!=(l>>>16^65535)){e.msg="invalid stored block lengths",n.mode=OM;break}if(n.length=65535&l,l=0,d=0,n.mode=wM,t===hM)break e;case wM:n.mode=16195;case 16195:if(p=n.length,p){if(p>a&&(p=a),p>c&&(p=c),0===p)break e;r.set(i.subarray(o,o+p),s),a-=p,o+=p,c-=p,s+=p,n.length-=p;break}n.mode=CM;break;case 16196:for(;d<14;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if(n.nlen=257+(31&l),l>>>=5,d-=5,n.ndist=1+(31&l),l>>>=5,d-=5,n.ncode=4+(15&l),l>>>=4,d-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=OM;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;d<3;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}n.lens[A[n.have++]]=7&l,l>>>=3,d-=3}for(;n.have<19;)n.lens[A[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,I={bits:n.lenbits},C=lM(0,n.lens,0,19,n.lencode,0,n.work,I),n.lenbits=I.bits,C){e.msg="invalid code lengths set",n.mode=OM;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;R=n.lencode[l&(1<<n.lenbits)-1],_=R>>>24,E=R>>>16&255,g=65535&R,!(_<=d);){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if(g<16)l>>>=_,d-=_,n.lens[n.have++]=g;else{if(16===g){for(b=_+2;d<b;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if(l>>>=_,d-=_,0===n.have){e.msg="invalid bit length repeat",n.mode=OM;break}y=n.lens[n.have-1],p=3+(3&l),l>>>=2,d-=2}else if(17===g){for(b=_+3;d<b;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}l>>>=_,d-=_,y=0,p=3+(7&l),l>>>=3,d-=3}else{for(b=_+7;d<b;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}l>>>=_,d-=_,y=0,p=11+(127&l),l>>>=7,d-=7}if(n.have+p>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=OM;break}for(;p--;)n.lens[n.have++]=y}}if(n.mode===OM)break;if(0===n.lens[256]){e.msg="invalid code -- missing end-of-block",n.mode=OM;break}if(n.lenbits=9,I={bits:n.lenbits},C=lM(1,n.lens,0,n.nlen,n.lencode,0,n.work,I),n.lenbits=I.bits,C){e.msg="invalid literal/lengths set",n.mode=OM;break}if(n.distbits=6,n.distcode=n.distdyn,I={bits:n.distbits},C=lM(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,I),n.distbits=I.bits,C){e.msg="invalid distances set",n.mode=OM;break}if(n.mode=IM,t===hM)break e;case IM:n.mode=bM;case bM:if(a>=6&&c>=258){e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=l,n.bits=d,iM(e,h),s=e.next_out,r=e.output,c=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,l=n.hold,d=n.bits,n.mode===CM&&(n.back=-1);break}for(n.back=0;R=n.lencode[l&(1<<n.lenbits)-1],_=R>>>24,E=R>>>16&255,g=65535&R,!(_<=d);){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if(E&&0==(240&E)){for(v=_,T=E,S=g;R=n.lencode[S+((l&(1<<v+T)-1)>>v)],_=R>>>24,E=R>>>16&255,g=65535&R,!(v+_<=d);){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}l>>>=v,d-=v,n.back+=v}if(l>>>=_,d-=_,n.back+=_,n.length=g,0===E){n.mode=16205;break}if(32&E){n.back=-1,n.mode=CM;break}if(64&E){e.msg="invalid literal/length code",n.mode=OM;break}n.extra=15&E,n.mode=16201;case 16201:if(n.extra){for(b=n.extra;d<b;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}n.length+=l&(1<<n.extra)-1,l>>>=n.extra,d-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;R=n.distcode[l&(1<<n.distbits)-1],_=R>>>24,E=R>>>16&255,g=65535&R,!(_<=d);){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if(0==(240&E)){for(v=_,T=E,S=g;R=n.distcode[S+((l&(1<<v+T)-1)>>v)],_=R>>>24,E=R>>>16&255,g=65535&R,!(v+_<=d);){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}l>>>=v,d-=v,n.back+=v}if(l>>>=_,d-=_,n.back+=_,64&E){e.msg="invalid distance code",n.mode=OM;break}n.offset=g,n.extra=15&E,n.mode=16203;case 16203:if(n.extra){for(b=n.extra;d<b;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}n.offset+=l&(1<<n.extra)-1,l>>>=n.extra,d-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=OM;break}n.mode=16204;case 16204:if(0===c)break e;if(p=h-c,n.offset>p){if(p=n.offset-p,p>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=OM;break}p>n.wnext?(p-=n.wnext,f=n.wsize-p):f=n.wnext-p,p>n.length&&(p=n.length),m=n.window}else m=r,f=s-n.offset,p=n.length;p>c&&(p=c),c-=p,n.length-=p;do{r[s++]=m[f++]}while(--p);0===n.length&&(n.mode=bM);break;case 16205:if(0===c)break e;r[s++]=n.length,c--,n.mode=bM;break;case AM:if(n.wrap){for(;d<32;){if(0===a)break e;a--,l|=i[o++]<<d,d+=8}if(h-=c,e.total_out+=h,n.total+=h,4&n.wrap&&h&&(e.adler=n.check=jP(n)?Nk(n.check,r,h,s-h):Ak(n.check,r,h,s-h)),h=c,4&n.wrap&&(jP(n)?l:NM(l))!==n.check){e.msg="incorrect data check",n.mode=OM;break}l=0,d=0}n.mode=16207;case 16207:if(n.wrap&&jP(n)){for(;d<32;){if(0===a)break e;a--,l+=i[o++]<<d,d+=8}if(4&n.wrap&&l!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=OM;break}l=0,d=0}n.mode=16208;case 16208:C=fM;break e;case OM:C=EM;break e;case 16210:return gM;default:return _M}return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=l,n.bits=d,(n.wsize||h!==e.avail_out&&n.mode<OM&&(n.mode<AM||t!==dM))&&BM(e,e.output,e.next_out,h-e.avail_out),u-=e.avail_in,h-=e.avail_out,e.total_in+=u,e.total_out+=h,n.total+=h,4&n.wrap&&h&&(e.adler=n.check=jP(n)?Nk(n.check,r,h,e.next_out-h):Ak(n.check,r,h,e.next_out-h)),e.data_type=n.bits+(n.last?64:0)+(n.mode===CM?128:0)+(n.mode===IM||n.mode===wM?256:0),(0===u&&0===h||t===dM)&&C===pM&&(C=vM),C},WM={inflateReset:LM,inflateReset2:MM,inflateResetKeep:kM,inflateInit:e=>UM(e,15),inflateInit2:UM,inflate:GM,inflateEnd:e=>{if(PM(e))return _M;let t=e.state;return t.window&&(t.window=null),e.state=null,pM},inflateGetHeader:(e,t)=>{if(PM(e))return _M;const n=e.state;return 0==(2&n.wrap)?_M:(n.head=t,t.done=!1,pM)},inflateSetDictionary:(e,t)=>{const n=t.length;let i,r,o;return PM(e)?_M:(i=e.state,0!==i.wrap&&i.mode!==yM?_M:i.mode===yM&&(r=1,r=Ak(r,t,n,0),r!==i.check)?EM:(o=BM(e,t,n,n),o?(i.mode=16210,gM):(i.havedict=1,pM)))},inflateInfo:"pako inflate (from Nodeca project)"},HM=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const KM=Object.prototype.toString,{Z_NO_FLUSH:zM,Z_FINISH:qM,Z_OK:YM,Z_STREAM_END:JM,Z_NEED_DICT:XM,Z_STREAM_ERROR:QM,Z_DATA_ERROR:ZM,Z_MEM_ERROR:$M}=Pk;function eU(e){this.options=VL.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new GL,this.strm.avail_out=0;let n=WM.inflateInit2(this.strm,t.windowBits);if(n!==YM)throw new Error(Dk[n]);if(this.header=new HM,WM.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=BL.string2buf(t.dictionary):"[object ArrayBuffer]"===KM.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(n=WM.inflateSetDictionary(this.strm,t.dictionary),n!==YM)))throw new Error(Dk[n])}function tU(e,t){const n=new eU(t);if(n.push(e),n.err)throw n.msg||Dk[n.err];return n.result}eU.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let o,s,a;if(this.ended)return!1;for(s=t===~~t?t:!0===t?qM:zM,"[object ArrayBuffer]"===KM.call(e)?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){for(0===n.avail_out&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),o=WM.inflate(n,s),o===XM&&r&&(o=WM.inflateSetDictionary(n,r),o===YM?o=WM.inflate(n,s):o===ZM&&(o=XM));n.avail_in>0&&o===JM&&n.state.wrap>0&&0!==e[n.next_in];)WM.inflateReset(n),o=WM.inflate(n,s);switch(o){case QM:case ZM:case XM:case $M:return this.onEnd(o),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(0===n.avail_out||o===JM))if("string"===this.options.to){let e=BL.utf8border(n.output,n.next_out),t=n.next_out-e,r=BL.buf2string(n.output,e);n.next_out=t,n.avail_out=i-t,t&&n.output.set(n.output.subarray(e,e+t),0),this.onData(r)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(o!==YM||0!==a){if(o===JM)return o=WM.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(0===n.avail_in)break}}return!0},eU.prototype.onData=function(e){this.chunks.push(e)},eU.prototype.onEnd=function(e){e===YM&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=VL.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var nU={Inflate:eU,inflate:tU,inflateRaw:function(e,t){return(t=t||{}).raw=!0,tU(e,t)},ungzip:tU,constants:Pk};const{Deflate:iU,deflate:rU,deflateRaw:oU,gzip:sU}=tM,{Inflate:aU,inflate:cU,inflateRaw:lU,ungzip:dU}=nU;var uU=rU,hU=cU;const pU={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function fU(){return pU}function mU(){return"setSinkId"in HTMLAudioElement.prototype&&(!Dw("RESTRICTION_SET_PLAYBACK_DEVICE")||(OC()||DC())&&!YC())}let _U=function(e){return e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change",e}({});function EU(e,t,n){return{sampleRate:e,stereo:t,bitrate:n}}function gU(e,t,n,i,r){return{width:e,height:t,frameRate:n,bitrateMin:i,bitrateMax:r}}function vU(e,t,n,i,r){return{width:{max:e},height:{max:t},frameRate:n,bitrateMin:i,bitrateMax:r}}function TU(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}const SU={"90p":gU(160,90),"90p_1":gU(160,90),"120p":gU(160,120,15,30,65),"120p_1":gU(160,120,15,30,65),"120p_3":gU(120,120,15,30,50),"120p_4":gU(212,120),"180p":gU(320,180,15,30,140),"180p_1":gU(320,180,15,30,140),"180p_3":gU(180,180,15,30,100),"180p_4":gU(240,180,15,30,120),"240p":gU(320,240,15,40,200),"240p_1":gU(320,240,15,40,200),"240p_3":gU(240,240,15,40,140),"240p_4":gU(424,240,15,40,220),"360p":gU(640,360,15,80,400),"360p_1":gU(640,360,15,80,400),"360p_3":gU(360,360,15,80,260),"360p_4":gU(640,360,30,80,600),"360p_6":gU(360,360,30,80,400),"360p_7":gU(480,360,15,80,320),"360p_8":gU(480,360,30,80,490),"360p_9":gU(640,360,15,80,800),"360p_10":gU(640,360,24,80,800),"360p_11":gU(640,360,24,80,1e3),"480p":gU(640,480,15,100,500),"480p_1":gU(640,480,15,100,500),"480p_2":gU(640,480,30,100,1e3),"480p_3":gU(480,480,15,100,400),"480p_4":gU(640,480,30,100,750),"480p_6":gU(480,480,30,100,600),"480p_8":gU(848,480,15,100,610),"480p_9":gU(848,480,30,100,930),"480p_10":gU(640,480,10,100,400),"720p":gU(1280,720,15,120,1130),"720p_auto":gU(1280,720,30,900,3e3),"720p_1":gU(1280,720,15,120,1130),"720p_2":gU(1280,720,30,120,2e3),"720p_3":gU(1280,720,30,120,1710),"720p_5":gU(960,720,15,120,910),"720p_6":gU(960,720,30,120,1380),"1080p":gU(1920,1080,15,120,2080),"1080p_1":gU(1920,1080,15,120,2080),"1080p_2":gU(1920,1080,30,120,3e3),"1080p_3":gU(1920,1080,30,120,3150),"1080p_5":gU(1920,1080,60,120,4780),"1440p":gU(2560,1440,30,120,4850),"1440p_1":gU(2560,1440,30,120,4850),"1440p_2":gU(2560,1440,60,120,7350),"4k":gU(3840,2160,30,120,8910),"4k_1":gU(3840,2160,30,120,8910),"4k_3":gU(3840,2160,60,120,13500)},yU=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],CU={"480p":vU(640,480,5),"480p_1":vU(640,480,5),"480p_2":vU(640,480,30),"480p_3":vU(640,480,15),"720p":vU(1280,720,5),"720p_auto":gU(1280,720,30,900,3e3),"720p_1":vU(1280,720,5),"720p_2":vU(1280,720,30),"720p_3":vU(1280,720,15),"1080p":vU(1920,1080,5),"1080p_1":vU(1920,1080,5),"1080p_2":vU(1920,1080,30),"1080p_3":vU(1920,1080,15)},RU={"1SL1TL":TU(1,1),"3SL3TL":TU(3,3),"2SL3TL":TU(2,3)};function wU(e){return e||(e="480p_1"),"string"==typeof e?Object.assign({},SU[e]):e}function IU(e){return"string"==typeof e?Object.assign({},CU[e]):e}function bU(e){return"string"==typeof e?Object.assign({},RU[e]):e}const AU={speech_low_quality:EU(16e3,!1),speech_standard:EU(32e3,!1,18),music_standard:EU(48e3,!1),standard_stereo:EU(48e3,!0,56),high_quality:EU(48e3,!1,128),high_quality_stereo:EU(48e3,!0,192)};function OU(e){return"string"==typeof e?Object.assign({},AU[e]):e}const NU=[];function DU(e){return rR(e,"mediaSource",["screen","window","application"]),!0}let PU=function(e){return e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track",e}({}),kU=function(e){return e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream",e}({}),LU=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e}({}),MU=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e}({}),UU=function(e){return e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e}({}),xU=function(e){return e.TRANSCEIVER_UPDATED="transceiver-updated",e.SEI_TO_SEND="sei-to-send",e.SEI_RECEIVED="sei-received",e.TRACK_UPDATED="track-updated",e}({}),VU=function(e){return e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed",e}({}),FU=function(e){return e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.VIDEO_STATE_CHANGED="video-state-changed",e}({}),jU=function(e){return e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source",e}({});const BU={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},GU={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},WU={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},HU={uplinkNetworkQuality:0,downlinkNetworkQuality:0},KU={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let zU=function(e){return e.ON_TRACK="on_track",e.ON_NODE="on_node",e}({}),qU=function(e){return e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints",e}({}),YU=function(e){return e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND",e}({}),JU=function(e){return e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e}({}),XU=function(e){return e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata",e}({}),QU=function(e){return e[e.VideoStateStopped=0]="VideoStateStopped",e[e.VideoStateStarting=1]="VideoStateStarting",e[e.VideoStateDecoding=2]="VideoStateDecoding",e[e.VideoStateFrozen=3]="VideoStateFrozen",e}({});const ZU={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let $U=function(e){return e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error",e}({});function ex(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function tx(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ex(Object(n),!0).forEach((function(t){nx(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ex(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function nx(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,"string");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ix(e,t,n,i,r){var o,s,a={};return Object.keys(i).forEach((function(e){a[e]=i[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=Xi(o=$O(s=n.slice()).call(s)).call(o,(function(n,i){return i(e,t,n)||n}),a),r&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}class rx extends vR{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit(xU.TRACK_UPDATED,e),this.mediaStreamTrack=e)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,t){super(),nx(this,"trackMediaType",void 0),nx(this,"_ID",void 0),nx(this,"_rtpTransceiver",void 0),nx(this,"_lowRtpTransceiver",void 0),nx(this,"_hints",[]),nx(this,"_isClosed",!1),nx(this,"_originMediaStreamTrack",void 0),nx(this,"mediaStreamTrack",void 0),nx(this,"_external",{}),this._ID=t||ew(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,function(e){Pi(NU).call(NU,e)||NU.push(e)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||KR((()=>{var e;oI.reportApiInvoke(null,{name:yR.GET_MEDIA_STREAM_TRACK,options:[],tag:CR.TRACER}).onSuccess((null===(e=this._mediaStreamTrack)||void 0===e?void 0:e.label)||"")}),this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===LU.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){const t=NU.indexOf(e);-1!==t&&NU.splice(t,1)}(this),this.emit(VU.CLOSED),this.removeAllListeners(xU.SEI_RECEIVED)}_updateRtpTransceiver(e,t){if(t===LU.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(xU.TRANSCEIVER_UPDATED,e,t)}}class ox extends rx{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,t){super(e,t),nx(this,"_enabled",!0),nx(this,"_muted",!1),nx(this,"_isExternalTrack",!1),nx(this,"_isClosed",!1),nx(this,"_enabledMutex",void 0),nx(this,"processor",void 0),nx(this,"_processorContext",void 0),nx(this,"_handleTrackEnded",(()=>{this.onTrackEnded()})),this._enabledMutex=new hw("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,t;return null!==(e=null===(t=this._originMediaStreamTrack)||void 0===t?void 0:t.label)&&void 0!==e?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,Qw.debug("[".concat(this.getTrackId(),"] close")),this.emit(PU.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._isExternalTrack=n,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await MR(this,PU.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){Qw.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(VU.TRACK_ENDED)}stateCheck(e,t){if(Qw.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(t,"]")),iR(t,e),this._enabled&&this._muted&&"enabled"===e&&!1===t)throw new nR(tR.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",Qw);if(!this._enabled&&!this._muted&&"muted"===e&&!0===t)throw new nR(tR.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",Qw)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Gh.resolve([])}}const sx=window.AudioContext||window.webkitAudioContext;let ax=null;const cx=new class extends vR{constructor(){super(...arguments),nx(this,"prevState",void 0),nx(this,"curState",void 0),nx(this,"currentTime",void 0),nx(this,"currentTimeStuckAt",void 0),nx(this,"interruptDetectorTrack",void 0),nx(this,"onLocalAudioTrackMute",(()=>{Qw.info("ios15-interruption-start"),this.emit(_U.IOS_15_16_INTERRUPTION_START)})),nx(this,"onLocalAudioTrackUnmute",(async()=>{Qw.info("ios15-interruption-end"),"running"!==this.curState||this.duringInterruption?Qw.info("ios15-interruption-end-canceled"):(ax&&await ax.suspend(),this.emit(_U.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return"running"===this.prevState&&"interrupted"===this.curState}bindInterruptDetectorTrack(e){Qw.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){Qw.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function lx(){if(!ax){if(function(){if(!sx)return void Qw.error("your browser is not support web audio");Qw.info("create audio context");const e=tx({},Dw("WEBAUDIO_INIT_OPTIONS"));Qw.debug("audio context init option:",JSON.stringify(e)),ax=new sx(e),cx.curState=ax.state,ax.onstatechange=()=>{cx.prevState=cx.curState,cx.curState=ax?ax.state:void 0;const{prevState:e,curState:t}=cx,n="running"===t,i="interrupted"===t,r="running"===e,o="suspended"===e,s="interrupted"===e,a=RC().osVersion;(kC()||KC())&&r&&i&&(Qw.info("ios".concat(a,"-interruption-start")),cx.emit(_U.IOS_INTERRUPTION_START)),(kC()||KC())&&(o||s)&&n&&(Qw.info("ios".concat(a,"-interruption-end")),cx.emit(_U.IOS_INTERRUPTION_END)),e!==t&&cx.emit(_U.STATE_CHANGE,t,e)},setInterval((()=>{var e;const t=null===(e=ax)||void 0===e?void 0:e.currentTime;cx.currentTime!==t?(cx.currentTimeStuckAt&&(Qw.debug("AudioContext current time resume at ".concat(t)),cx.currentTimeStuckAt=void 0),cx.currentTime=t):(t!==cx.currentTimeStuckAt&&(oI.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:t},tag:CR.TRACER}).onSuccess(),Qw.warning("AudioContext current time stuck at ".concat(t))),cx.currentTimeStuckAt=t)}),5e3),async function(e){const t=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let n,i=!1,r=!1,o=!1;function s(t){"running"===e.state?a(!1):kC()||KC()?"suspended"===e.state&&(a(!0),t&&e.resume().then(c,c)):"closed"!==e.state&&(a(!0),t&&e.resume().then(c,c))}function a(e){if(i!==e){i=e;for(let n=0,i=t;n<i.length;n+=1){const t=i[n];e?window.addEventListener(t,l,{capture:!0,passive:!0}):window.removeEventListener(t,l,{capture:!0,passive:!0})}}}function c(){s(!1)}function l(){s(!0)}function d(e){if(!o)if(n.paused)if(e){let t;u(!1),o=!0;try{t=n.play(),t?t.then(h,h):(n.addEventListener("playing",h),n.addEventListener("abort",h),n.addEventListener("error",h))}catch(e){h()}}else u(!0);else u(!1)}function u(e){if(r!==e){r=e;for(let n=0,i=t;n<i.length;n++){const t=i[n];e?window.addEventListener(t,p,{capture:!0,passive:!0}):window.removeEventListener(t,p,{capture:!0,passive:!0})}}}function h(){n.removeEventListener("playing",h),n.removeEventListener("abort",h),n.removeEventListener("error",h),o=!1,d(!1)}function p(){d(!0)}if(kC()){const t=e.createMediaStreamDestination(),i=document.createElement("div");i.innerHTML="<audio x-webkit-airplay='deny'></audio>",n=i.children.item(0),n.controls=!1,n.disableRemotePlayback=!0,n.preload="auto",n.srcObject=t.stream,d(!0)}cx.on(_U.STATE_CHANGE,(function(){s(!0)})),s(!1)}(ax)}(),!ax)throw new nR(tR.NOT_SUPPORTED,"can not create audio context");return ax}return ax}function dx(e){if(function(){if(null!==ux)return ux;const e=lx(),t=e.createBufferSource(),n=e.createGain(),i=e.createGain();t.connect(n),t.connect(i),t.disconnect(n);let r=!1;try{t.disconnect(n)}catch(e){r=!0}return t.disconnect(),ux=r,r}())return;const t=e.connect,n=e.disconnect;e.connect=(n,i,r)=>{var o;return e._inputNodes||(e._inputNodes=[]),Pi(o=e._inputNodes).call(o,n)||(n instanceof AudioNode?(e._inputNodes.push(n),t.call(e,n,i,r)):t.call(e,n,i)),e},e.disconnect=(i,r,o)=>{n.call(e),i?FR(e._inputNodes,i):e._inputNodes=[];for(const n of e._inputNodes)t.call(e,n)}}let ux=null;function hx(e,t){let n=!1;const i=1/t;if(Dw("DISABLE_WEBAUDIO")){const t=window.setInterval((()=>{n?window.clearInterval(t):e(performance.now()/1e3)}),1e3*i)}else{const t=lx();let r=t.createGain();r.gain.value=0,r.connect(t.destination);const o=()=>{if(n)return void(r=null);const s=t.createOscillator();s.onended=o,s.connect(r),s.start(0),s.stop(t.currentTime+i),e(t.currentTime)};o()}return()=>{n=!0}}class px{constructor(){nx(this,"context",void 0),nx(this,"analyserNode",void 0),nx(this,"sourceNode",void 0),this.context=lx(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch(e){}this.sourceNode=e,null==e||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode)return 0;if(!this.context||kC()||KC()||"running"!==this.context.state&&this.context.resume(),!this.analyserNode)return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const t=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(t);for(let n=0;n<e.length;++n)e[n]=t[n]/128-1}const t=Xi(e).call(e,((e,t)=>e+t*t),0)/e.length;return Math.max(10*Math.log10(t)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,t;null===(e=this.sourceNode)||void 0===e||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,null===(t=this.sourceNode)||void 0===t||t.connect(this.analyserNode)}catch(e){Qw.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class fx extends vR{get processSourceNode(){return this.sourceNode}set processedNode(e){var t;if(!this.isDestroyed&&this._processedNode!==e){try{var n;null===(n=this.sourceNode)||void 0===n||n.disconnect(this.outputNode)}catch(e){}null===(t=this._processedNode)||void 0===t||t.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),nx(this,"outputNode",void 0),nx(this,"outputTrack",void 0),nx(this,"isPlayed",!1),nx(this,"sourceNode",void 0),nx(this,"context",void 0),nx(this,"audioBufferNode",void 0),nx(this,"destNode",void 0),nx(this,"audioOutputLevel",0),nx(this,"volumeLevelAnalyser",void 0),nx(this,"_processedNode",void 0),nx(this,"playNode",void 0),nx(this,"isDestroyed",!1),nx(this,"onNoAudioInput",void 0),nx(this,"isNoAudioInput",!1),nx(this,"_noAudioInputCount",0),this.context=lx(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),dx(this.outputNode),this.volumeLevelAnalyser=new px}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=e=>{this.emit(jU.ON_AUDIO_BUFFER,function(e){for(let t=0;t<e.outputBuffer.numberOfChannels;t+=1){const n=e.outputBuffer.getChannelData(t);for(let e=0;e<n.length;e+=1)n[e]=0}return e.inputBuffer}(e))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!fU().webAudioMediaStreamDest)throw new nR(tR.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){"running"!==this.context.state&&BR((()=>{cx.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch(e){}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;kC()||KC()?"suspended"===this.context.state&&this.context.resume():"running"!==this.context.state&&this.context.resume();const t=this.volumeLevelAnalyser.getAnalyserNode();let n;t.getFloatTimeDomainData?(n=new Float32Array(t.fftSize),t.getFloatTimeDomainData(n)):(n=new Uint8Array(t.fftSize),t.getByteTimeDomainData(n));let i=!1;for(let r=0;r<n.length;r++)0!==n[r]&&(i=!0);return i?(this.isNoAudioInput=!1,!0):(await $R(200),await this.checkHasAudioInput(e?e+1:1)&&i)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,t;null===(e=this.processedNode)||void 0===e||e.disconnect(),null===(t=this.sourceNode)||void 0===t||t.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?null===(e=this.processedNode)||void 0===e||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class mx extends fx{get isFreeze(){return!1}constructor(e,t,n){var i;if(super(),nx(this,"sourceNode",void 0),nx(this,"track",void 0),nx(this,"clonedTrack",void 0),nx(this,"audioElement",void 0),nx(this,"isCurrentTrackCloned",!1),nx(this,"isRemoteTrack",!1),nx(this,"originVolumeLevelAnalyser",void 0),nx(this,"rebuildWebAudio",(async()=>{if(Qw.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void Qw.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>Qw.info("resume success"))),Qw.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const e=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?e.stop():this.isCurrentTrackCloned=!0;const t=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(t),dx(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const n=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(n,this.context.currentTime),dx(this.outputNode),this.emit(jU.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=t,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),"audio"!==e.kind)throw new nR(tR.UNEXPECTED_ERROR);this.track=e;const r=new MediaStream([this.track]);if(this.isRemoteTrack=!!t,this.sourceNode=this.context.createMediaStreamSource(r),dx(this.sourceNode),n){const e=n.clone();e.enabled=!0,this.clonedTrack=e,Qw.debug("create an unmuted track ".concat(e.id," from the original track ").concat(n.id," to get the volume"));const t=this.context.createMediaStreamSource(new MediaStream([e]));dx(t),this.originVolumeLevelAnalyser=new px,this.originVolumeLevelAnalyser.updateSource(t)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=r;const o=RC();t&&o.os===vC.IOS&&Number(null===(i=o.osVersion)||void 0===i?void 0:i.split(".")[0])<15&&(cx.on(_U.STATE_CHANGE,(()=>{"suspended"===this.context.state?document.body.addEventListener("click",this.rebuildWebAudio,!0):"running"===this.context.state&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((e=>{e||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const t=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(t),dx(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(jU.UPDATE_SOURCE),this.audioElement.srcObject=t}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),cx.off("state-change",this.rebuildWebAudio),null===(e=this.originVolumeLevelAnalyser)||void 0===e||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const t=e.clone();t.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=t),Qw.debug("create an unmuted track ".concat(t.id," from the original track ").concat(e.id," to get the volume"));const n=this.context.createMediaStreamSource(new MediaStream([t]));dx(n),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(n)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function _x(e,t,n){const i=(e,t)=>e?"number"!=typeof e?e.max||e.exact||e.ideal||e.min||t:e:t,r={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:i(t.height,1080),maxWidth:i(t.width,1920)}}};return t.frameRate&&"number"!=typeof t.frameRate?(r.video.mandatory.maxFrameRate=t.frameRate.max,r.video.mandatory.minFrameRate=t.frameRate.min):"number"==typeof t.frameRate&&(r.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function Ex(e,t){const n=await gx(e.mediaSource),{sourceId:i,audio:r}=await function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Gh(((n,i)=>{const r=document.createElement("div");r.innerText="share screen",r.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const o=document.createElement("div");o.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const s=document.createElement("div");s.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",s.setAttribute("style","height: 12%;");const a=document.createElement("div");a.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const c=document.createElement("div");c.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const l=document.createElement("button");l.innerHTML="cancel",l.setAttribute("style","width: 85px;"),l.onclick=()=>{document.body.removeChild(h);const e=new Error("NotAllowedError");e.name="NotAllowedError",i(e)};let d=t;const u=document.createElement("div");if(t){const e=document.createElement("input");e.setAttribute("type","checkbox");const t=document.createElement("span");e.setAttribute("style","margin-right: 6px;"),t.innerText="Share audio",e.checked=d,e.onchange=()=>{d=e.checked},u.appendChild(e),u.appendChild(t)}c.appendChild(u),c.appendChild(l),o.appendChild(s),o.appendChild(a),o.appendChild(c);const h=document.createElement("div");h.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),h.appendChild(r),h.appendChild(o),document.body.appendChild(h),e.map((e=>{if(e.id){const t=document.createElement("div");t.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let i=e.thumbnail;try{const{width:e}=i.getSize();e>1920&&(i=i.resize({width:1920}))}catch(e){throw e&&e.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),e}t.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+i.toDataURL()+' /></div><span style="\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+e.name.replace(/[\u00A0-\u9999<>\&]/g,(function(e){return"&#"+e.charCodeAt(0)+";"}))+"</span>",t.onclick=()=>{document.body.removeChild(h),n({sourceId:e.id,audio:d})},a.appendChild(t)}}))}))}(n,t);return await _x(i,e,r)}async function gx(e){let t=["window","screen"];"application"!==e&&"window"!==e||(t=["window"]),"screen"===e&&(t=["screen"]);const n=SR();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new nR(tR.ELECTRON_IS_NULL);let i=null;try{var r;i=(null===(r=n.desktopCapturer)||void 0===r?void 0:r.getSources({types:t}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch(e){i=null}i&&i.then||(i=new Gh(((e,i)=>{n.desktopCapturer.getSources({types:t},((t,n)=>{t?i(t):e(n)}))})));try{return await i}catch(e){throw new nR(tR.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,e.toString())}}const vx=new hw("safari");let Tx=!1,Sx=!1;async function yx(e,t){let n=0,i=null;for(;n<2;)try{i=await Cx(e,t,n>0);break}catch(e){if(e instanceof nR)throw Qw.error("[".concat(t,"] ").concat(e.toString())),e;const i=Rx(e.name||e.code||e,e.message);if(i.code===tR.MEDIA_OPTION_INVALID){Qw.debug("[".concat(t,"] detect media option invalid, retry")),n+=1,await $R(500);continue}throw Qw.error("[".concat(t,"] ").concat(i.toString())),i}if(!i)throw new nR(tR.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function Cx(e,t,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new nR(tR.NOT_SUPPORTED,"can not find getUserMedia");n&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const i=fU(),r=new MediaStream;if(e.audioSource&&r.addTrack(e.audioSource),e.videoSource&&r.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return Qw.debug("Using Video Source/ Audio Source"),r;if(e.screen)if(SR())e.screen.sourceId?wx(r,await _x(e.screen.sourceId,e.screen,e.screenAudio)):wx(r,await Ex(e.screen,e.screenAudio));else if(OC()&&e.screen.extensionId&&e.screen.mandatory){if(!i.getStreamFromExtension)throw new nR(tR.NOT_SUPPORTED,"This browser does not support screen sharing");Qw.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const n=await(s=e.screen.extensionId,a=t,new Gh(((e,t)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},(n=>{if(!n||!n.streamId)return Qw.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),n),void t(new nR(tR.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));e(n.streamId)}))}catch(e){Qw.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),e.toString()),t(new nR(tR.CHROME_PLUGIN_NOT_INSTALL))}})));e.screen.mandatory.chromeMediaSourceId=n,wx(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(i.getDisplayMedia){var o;e.screen.mediaSource&&DU(e.screen.mediaSource);const n={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:null!==(o=e.screen.displaySurface)&&void 0!==o?o:"screen"===e.screen.mediaSource?"monitor":e.screen.mediaSource},{selfBrowserSurface:i,surfaceSwitching:s,systemAudio:a}=e.screen,c={selfBrowserSurface:i,surfaceSwitching:s,systemAudio:a};!i&&delete c.selfBrowserSurface,!s&&delete c.surfaceSwitching,!a&&delete c.systemAudio,Qw.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:n,audio:!!e.screenAudio,controls:c})),wx(r,await navigator.mediaDevices.getDisplayMedia(tx({video:n,audio:!!e.screenAudio},c)))}else{if(!PC())throw Qw.error("[".concat(t,"] This browser does not support screenSharing")),new nR(tR.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&DU(e.screen.mediaSource);const n={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};Qw.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(n))),wx(r,await navigator.mediaDevices.getUserMedia(n))}}var s,a;if(!e.video&&!e.audio)return r;let c={video:e.video,audio:e.audio},l=Dw("MEDIA_DEVICE_CONSTRAINTS");if(l)try{"string"==typeof l&&(l=JSON.parse(l)),c=sw(c,l)}catch(e){}Qw.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(c)),RC();let d,u=null;(NC()||kC()||AC())&&(u=await vx.lock());try{d=await navigator.mediaDevices.getUserMedia(c)}catch(e){throw u&&u(),e}return c.audio&&(Tx=!0),c.video&&(Sx=!0),wx(r,d),u&&u(),r}function Rx(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new nR(tR.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new nR(tR.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new nR(tR.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new nR(tR.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new nR(tR.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new nR(tR.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return Qw.error("getUserMedia unexpected error",e),new nR(tR.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function wx(e,t){const n=e.getVideoTracks()[0],i=e.getAudioTracks()[0],r=t.getVideoTracks()[0],o=t.getAudioTracks()[0];o&&(i&&e.removeTrack(i),e.addTrack(o)),r&&(n&&e.removeTrack(n),e.addTrack(r))}const Ix=new class extends vR{get state(){return this._state}set state(e){e!==this._state&&(this.emit(JU.STATE_CHANGE,e),this._state=e)}constructor(){super(),nx(this,"_state",YU.IDLE),nx(this,"isAccessMicrophonePermission",!1),nx(this,"isAccessCameraPermission",!1),nx(this,"lastAccessMicrophonePermission",!1),nx(this,"lastAccessCameraPermission",!1),nx(this,"checkdeviceMatched",!1),nx(this,"deviceInfoMap",new Map),this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(Dw("ENUMERATE_DEVICES_INTERVAL")||(XC()||IC()===vC.HARMONY_OS)&&JC())&&this.updateDevicesInfo()}),Dw("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((e=>Qw.error(e.toString())))}async enumerateDevices(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new nR(tR.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i);let o=!this.isAccessMicrophonePermission&&e,s=!this.isAccessCameraPermission&&t;r.audio&&(o=!1),r.video&&(s=!1);let a=null,c=null,l=null;if(!n&&(o||s)){if(vx.isLocked&&(Qw.debug("[device manager] wait GUM lock"),(await vx.lock())(),Qw.debug("[device manager] GUM unlock")),Tx&&(o=!1,this.isAccessMicrophonePermission=!0),Sx&&(s=!1,this.isAccessCameraPermission=!0),Qw.debug("[device manager] check media device permissions",e,t,o,s),o&&s){try{l=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(e){const t=Rx(e.name||e.code||e,e.message);if(t.code===tR.PERMISSION_DENIED)throw t;Qw.warning("getUserMedia failed in getDevices",t)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{a=await navigator.mediaDevices.getUserMedia({audio:e})}catch(e){const t=Rx(e.name||e.code||e,e.message);if(t.code===tR.PERMISSION_DENIED)throw t;Qw.warning("getUserMedia failed in getDevices",t)}this.isAccessMicrophonePermission=!0}else if(s){try{c=await navigator.mediaDevices.getUserMedia({video:t})}catch(e){const t=Rx(e.name||e.code||e,e.message);if(t.code===tR.PERMISSION_DENIED)throw t;Qw.warning("getUserMedia failed in getDevices",t)}this.isAccessCameraPermission=!0}Qw.debug("[device manager] mic permission",e,"cam permission",t)}try{const e=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach((e=>e.stop())),c&&c.getTracks().forEach((e=>e.stop())),l&&l.getTracks().forEach((e=>e.stop())),a=null,c=null,l=null,e}catch(e){return a&&a.getTracks().forEach((e=>e.stop())),c&&c.getTracks().forEach((e=>e.stop())),l&&l.getTracks().forEach((e=>e.stop())),a=null,c=null,l=null,new nR(tR.ENUMERATE_DEVICES_FAILED,e.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((e=>"audioinput"===e.kind))}async getCamerasDevices(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter((e=>"videoinput"===e.kind))}async getSpeakers(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((e=>"audiooutput"===e.kind))}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach((n=>{n.device.label===e&&(t=n.device.deviceId)})),t}async getDeviceById(e){const t=(await this.enumerateDevices(!0,!0,!0)).find((t=>t.deviceId===e));if(!t)throw new nR(tR.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=YU.INITING;try{await this.updateDevicesInfo(),this.state=YU.INITEND}catch(e){throw Qw.warning("Device Detection functionality cannot start properly.",e.toString()),this.state=YU.IDLE,("boolean"==typeof isSecureContext?isSecureContext:"https:"===location.protocol||"file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname||"::1"===location.hostname)||new nR(tR.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),e}}async updateDevicesInfo(){const e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),n=[];if(e[0]&&e[0].label&&!1===this.checkdeviceMatched){this.checkdeviceMatched=!0;const t=e.find((e=>"audioinput"===e.kind&&"default"===e.deviceId)),n=e.find((e=>"audiooutput"===e.kind&&"default"===e.deviceId));t&&n?n.groupId===t.groupId?Qw.debug("[device-check] default input ".concat(t.label," and output ").concat(n.label," is the same group")):Qw.warning("[device-check] default input ".concat(t.label," and output ").concat(n.label," is not the same group")):Qw.debug("[device-check] default input or output not found")}const i=this.checkMediaDeviceInfoIsOk(e);if(e.forEach((e=>{if(!e.deviceId)return;const i=this.deviceInfoMap.get("".concat(e.kind,"_").concat(e.deviceId));if("ACTIVE"!==(i?i.state:"INACTIVE")){const i={initAt:t,updateAt:t,device:e,state:"ACTIVE"};this.deviceInfoMap.set("".concat(e.kind,"_").concat(e.deviceId),i),n.push(i)}i&&(i.updateAt=t)})),this.deviceInfoMap.forEach(((e,i)=>{"ACTIVE"===e.state&&e.updateAt!==t&&(e.state="INACTIVE",n.push(e))})),this.state!==YU.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach((e=>{switch(e.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(JU.RECORDING_DEVICE_CHANGED,e);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(JU.CAMERA_DEVICE_CHANGED,e);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(JU.PLAYOUT_DEVICE_CHANGED,e)}})),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){const t=e.filter((e=>"audioinput"===e.kind)),n=e.filter((e=>"videoinput"===e.kind)),i={audio:!1,video:!1};for(const r of t)if(r.label&&r.deviceId){i.audio=!0;break}for(const r of n)if(r.label&&r.deviceId){i.video=!0;break}return i}};let bx=!1;const Ax=new class extends vR{constructor(){super(...arguments),nx(this,"onAutoplayFailed",void 0),nx(this,"onAudioAutoplayFailed",void 0)}};function Ox(){if(RC(),!bx){const e=t=>{t.preventDefault(),bx=!1,QC()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};bx=!0,QC()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Qw.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Ax.onAutoplayFailed?Ax.onAutoplayFailed():Ax.onAudioAutoplayFailed?Qw.warning("AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.\n\n  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."):Qw.warning("We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.\n\n  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.\n\n  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."),Ax.emit("autoplay-failed")}}function Nx(e,t,n,i){if(!e)return;const r=oI.getBaseInfoBySessionId(e);if(!r)return;const o=r.info,s=Date.now(),a=tx(tx({},o),{},{vid:void 0===o.vid?0:Number(o.vid),lts:s,elapse:s-r.startTime,cbRegistered:Ax.onAutoplayFailed||Ax.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:t,trackId:i,extend:void 0});oI.send({type:nI.AUTOPLAY_FAILED,data:a},!0)}const Dx=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Px=new class{constructor(){nx(this,"onAutoplayFailed",void 0),nx(this,"elementMap",new Map),nx(this,"elementStateMap",new Map),nx(this,"elementsNeedToResume",[]),nx(this,"sinkIdMap",new Map),nx(this,"autoResumeAfterInterruption",(e=>{Array.from(this.elementMap.entries()).forEach((t=>{let[n,i]=t;const r=this.elementStateMap.get(n),o=i.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(Qw.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(s," ").concat(e)),"live"===s){if(e)return i.pause(),void i.play();if("running"===cx.curState)return GC()?(i.pause(),void i.play()):void(r&&"paused"===r&&i.play())}}))})),nx(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{Array.from(this.elementMap.entries()).forEach((e=>{let[t,n]=e;const i=n.srcObject.getAudioTracks()[0];i&&"live"===i.readyState&&(Qw.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())}))})),this.autoResumeAudioElement(),cx.on(_U.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),cx.on(_U.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),cx.on(_U.STATE_CHANGE,(()=>{kC()&&"suspended"===cx.prevState&&"running"===cx.curState&&this.autoResumeAfterInterruption()}))}async setSinkID(e,t){const n=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),n)try{await n.setSinkId(t)}catch(e){throw new nR(tR.PERMISSION_DENIED,"can not set sink id: "+e.toString())}}play(e,t,n,i){if(this.elementMap.has(t))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,r),this.elementMap.set(t,r),this.elementStateMap.set(t,XU.INIT),this.setVolume(t,n);const o=this.sinkIdMap.get(t);if(o)try{r.setSinkId(o).catch((e=>{Qw.warning("[".concat(t,"] set sink id failed"),e.toString())}))}catch(e){Qw.warning("[".concat(t,"] set sink id failed"),e.toString())}const s=r.play();s&&s.then&&s.catch((e=>{i&&Nx(i,"audio",e.message,t),Qw.warning("audio element play warning",e.toString()),this.elementMap.has(t)&&"NotAllowedError"===e.name&&(Qw.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),BR((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),Ox()})))}))}updateTrack(e,t){const n=this.elementMap.get(e);n&&(n.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&"playing"===this.elementStateMap.get(e)}setVolume(e,t){const n=this.elementMap.get(e);n&&(t=Math.max(0,Math.min(100,t)),n.volume=t/100)}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const n=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(n,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){Dx.forEach((n=>{t.addEventListener(n,(n=>{const i=this.elementStateMap.get(e),r="pause"===n.type?"paused":n.type;if(Qw.debug("[".concat(e,"] audio-element-status change ").concat(i," => ").concat(r)),"error"===n.type){const n=null==t?void 0:t.error;n&&Qw.error("[".concat(e,"] media error, code: ").concat(n.code,", message: ").concat(n.message))}this.elementStateMap.set(e,r)}))}))}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach((e=>{e.play().then((e=>{Qw.debug("Auto resume audio element success")})).catch((e=>{Qw.warning("Auto resume audio element failed!",e)}))})),this.elementsNeedToResume=[]};new Gh((e=>{document.body?e():window.addEventListener("load",(()=>e()))})).then((()=>{QC()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))}))}};function kx(){return function(e,t,n){const i=n.value;return"function"==typeof i&&(n.value=function(){this._isClosed&&new nR(tR.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",Qw);for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=i.apply(this,t);return r instanceof Gh?new Gh(((e,t)=>{r.then(e).catch(t)})):r}),n}}class Lx extends vR{constructor(e){super(),nx(this,"name","VideoProcessorDestination"),nx(this,"ID","0"),nx(this,"_source",void 0),nx(this,"videoContext",void 0),nx(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new nR(tR.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new nR(tR.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error("ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.\nProbably you are making pipeline like this:\nvideoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).");e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(zU.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(zU.ON_TRACK,void 0)}}class Mx extends vR{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t){super(),nx(this,"constraintsMap",new Map),nx(this,"statsRegistry",[]),nx(this,"usageRegistry",[]),nx(this,"trackId",void 0),nx(this,"direction",void 0),nx(this,"_chained",!1),this.trackId=e,this.direction=t}async getConstraints(){return await LR(this,qU.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,t){var n;return Qw.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),MR(this,qU.REQUEST_UPDATE_CONSTRAINTS,Array.from(hb(n=this.constraintsMap).call(n)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return Qw.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),MR(this,qU.REQUEST_UPDATE_CONSTRAINTS,Array.from(hb(t=this.constraintsMap).call(t)))}registerStats(e,t,n){this.statsRegistry.find((n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:n})}unregisterStats(e,t){const n=this.statsRegistry.findIndex((n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t));-1!==n&&this.statsRegistry.splice(n,1)}gatherStats(){const e=[];for(const{processorID:t,processorName:n,type:i,cb:r}of this.statsRegistry)try{const o=r();e.push({processorID:t,processorName:n,type:i,stats:o})}catch(e){Qw.error(new nR(tR.UNEXPECTED_ERROR,e.message))}return e}registerUsage(e,t){this.usageRegistry.find((t=>t.processorID===e.ID&&t.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){const t=this.usageRegistry.findIndex((t=>t.processorID===e.ID&&t.processorName===e.name));-1!==t&&this.usageRegistry.splice(t,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:t}of this.usageRegistry)try{let n=t();n instanceof Gh&&(n=await n),e.push(tx(tx({},n),{},{direction:this.direction}))}catch(e){Qw.error("gather extension usage error",e)}return e}getDirection(){return this.direction}}class Ux extends vR{constructor(e){super(),nx(this,"name","AudioProcessorDestination"),nx(this,"ID","0"),nx(this,"inputTrack",void 0),nx(this,"inputNode",void 0),nx(this,"audioProcessorContext",void 0),nx(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new nR(tR.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new nR(tR.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(zU.ON_TRACK,void 0),this.emit(zU.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error("ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.\n        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).");e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(zU.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(zU.ON_NODE,this.inputNode))}}class xx extends vR{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t,n){super(),nx(this,"constraintsMap",new Map),nx(this,"statsRegistry",[]),nx(this,"audioContext",void 0),nx(this,"trackId",void 0),nx(this,"direction",void 0),nx(this,"usageRegistry",[]),nx(this,"_chained",!1),this.audioContext=e,this.trackId=t,this.direction=n}async getConstraints(){return LR(this,qU.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,t){var n;return Qw.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),MR(this,qU.REQUEST_UPDATE_CONSTRAINTS,Array.from(hb(n=this.constraintsMap).call(n)))}async requestRevertConstraints(e){var t;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),MR(this,qU.REQUEST_UPDATE_CONSTRAINTS,Array.from(hb(t=this.constraintsMap).call(t)))}registerStats(e,t,n){this.statsRegistry.find((n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:n})}unregisterStats(e,t){const n=this.statsRegistry.findIndex((n=>n.processorID===e.ID&&n.processorName===e.name&&n.type===t));-1!==n&&this.statsRegistry.splice(n,1)}gatherStats(){const e=[];for(const{processorID:t,processorName:n,type:i,cb:r}of this.statsRegistry)try{const o=r();e.push({processorID:t,processorName:n,type:i,stats:o})}catch(e){Qw.error(new nR(tR.UNEXPECTED_ERROR,e.message))}return e}registerUsage(e,t){this.usageRegistry.find((t=>t.processorID===e.ID&&t.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){const t=this.usageRegistry.findIndex((t=>t.processorID===e.ID&&t.processorName===e.name));-1!==t&&this.usageRegistry.splice(t,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:t}of this.usageRegistry)try{let n=t();n instanceof Gh&&(n=await n),e.push(tx(tx({},n),{},{direction:this.direction}))}catch(e){Qw.error("gather extension usage error",e)}return e}getDirection(){return this.direction}}class Vx extends vR{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),nx(this,"context",void 0),nx(this,"processSourceNode",void 0),nx(this,"outputTrack",void 0),nx(this,"processedNode",void 0),nx(this,"clonedTrack",void 0),nx(this,"outputNode",void 0),this.outputNode=new Fx}setVolume(){}createOutputTrack(){throw new nR(tR.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class Fx{disconnect(){}connect(){}}function jx(e){return new Gh(((t,n)=>{let i=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const o=kC()?"canplay":"playing";r.addEventListener(o,(()=>{const e=r.videoWidth,n=r.videoHeight;!e&&PC()||(i=!0,r.srcObject=null,r.remove(),t([e,n]))})),r.srcObject=new MediaStream([e]),r.play().catch(nw),setTimeout((()=>{i||(r.srcObject=null,r.remove(),t([r.videoWidth,r.videoHeight]))}),4e3)}))}function Bx(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const n=wU(e.encoderConfig);return null!=n.width&&(t.width=n.width),null!=n.height&&(t.height=n.height),!qC()&&n.frameRate&&(t.frameRate=n.frameRate),DC()&&"object"==typeof t.frameRate&&(t.frameRate.max=60),PC()&&(t.frameRate={ideal:30,max:30}),t}function Gx(e){const t={};if(qC()||(void 0!==e.AGC&&(t.autoGainControl=e.AGC),void 0!==e.AEC&&(t.echoCancellation=e.AEC),void 0!==e.ANS&&(t.noiseSuppression=e.ANS,OC()&&e.ANS&&(t.googHighpassFilter=e.ANS))),e.encoderConfig){const n=OU(e.encoderConfig);t.channelCount=n.stereo?2:1,t.sampleRate=n.sampleRate,t.sampleSize=n.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),XC()&&(t.sampleRate=void 0),t}const Wx=e=>{const t=e._encoderConfig;if(!t)return;const{frameRate:n,width:i,height:r}=e.getMediaStreamTrackSettings();let{frameRate:o=n,width:s=i,height:a=r}=t;if(!o||!s||!a)return;s=cw(s),a=cw(a),o=cw(o);const{max:c,min:l}=function(e,t,n){const i=200*Math.pow(n/15,.6)*Math.pow(e*t/640/360,.75);return{min:Math.floor(i),max:Math.floor(4*i)}}(s,a,o),{bitrateMax:d,bitrateMin:u}=t||{};d||Qw.debug("calculate bitrate: [w: ".concat(s,", h: ").concat(a,", fps: ").concat(o,"] => [brMax: ").concat(d,", brMin: ").concat(u,"]"));const{maxFramerate:h}=Dw("ENCODER_CONFIG_LIMIT");return h&&"number"==typeof h&&(o=Math.min(o,h)),{frameRate:o,bitrateMax:d||c,bitrateMin:u||l,scaleResolutionDownBy:1,scale:0}},Hx=async(e,t,n)=>await(async(e,t,n)=>{const i=function(e){const t=[];for(let n=0;n<e.length;n+=2)t.push(parseInt(e.slice(n,n+2),16));return Uint8Array.from(t)}(lw(""+t+n)).slice(0,16),r=i.slice(0,12),o=await window.crypto.subtle.importKey("raw",i,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r},o,e))})(e.buffer,t,n),Kx=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new Gh(((n,i)=>{t.toBlob((async e=>{if(t.remove(),e){const i=await zx(e);n({buffer:i,width:t.width,height:t.height})}else i(new nR(tR.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,1)}))},zx=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)};var qx,Yx,Jx,Xx,Qx,Zx,$x,eV,tV,nV,iV,rV,oV,sV,aV,cV,lV,dV,uV,hV,pV,fV,mV,_V,EV,gV,vV,TV,SV,yV,CV,RV,wV,IV,bV,AV,OV,NV,DV,PV;let kV=(qx=rI({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),Yx=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),Jx=kx(),Xx=pw("LocalAudioTrack","_enabledMutex"),Qx=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),Zx=kx(),$x=pw("LocalAudioTrack","_enabledMutex"),eV=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),tV=kx(),nV=kx(),iV=kx(),rV=rI({argsMap:e=>[e.getTrackId()]}),oV=kx(),sV=rI({argsMap:e=>[e.getTrackId()]}),aV=kx(),cV=rI({argsMap:e=>[e.getTrackId()]}),lV=rI({argsMap:(e,t)=>[e.getTrackId(),t.name]}),dV=rI({argsMap:e=>[e.getTrackId()]}),ix((uV=class extends ox{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?Px.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,n,i){super(e,n),nx(this,"trackMediaType","audio"),nx(this,"_encoderConfig",void 0),nx(this,"_trackSource",void 0),nx(this,"_enabled",!0),nx(this,"_volume",100),nx(this,"_useAudioElement",!0),nx(this,"_bypassWebAudio",!1),nx(this,"processor",void 0),nx(this,"_processorContext",void 0),nx(this,"_processorDestination",void 0),nx(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!i,this._trackSource=new Vx,Dw("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),Dw("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),NC()&&!ax?setTimeout((()=>this.initWebAudio())):this.initWebAudio()}setVolume(e){oR(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&Px.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void Qw.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,MR(this,PU.NEED_REPLACE_TRACK,this).then((()=>{Qw.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((e=>{Qw.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),e)})))}catch(e){}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!mU())throw new nR(tR.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Px.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,n){return this._setEnabled(e,t,n)}async _setEnabled(e,t,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(Qw.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await MR(this,PU.NEED_ENABLE_TRACK,this),Qw.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(e){throw n||(this._enabled=!1),Qw.error("[".concat(this.getTrackId(),"] setEnabled to true error"),e.toString()),e}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await MR(this,PU.NEED_DISABLE_TRACK,this)}catch(e){throw n||(this._enabled=!0),Qw.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,Qw.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await MR(this,PU.NEED_MUTE_TRACK,this):await MR(this,PU.NEED_UNMUTE_TRACK,this))}getStats(){return KR((()=>{Qw.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning"),UR(this,PU.GET_STATS)||tx({},BU)}setAudioFrameCallback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!e)return this._source.removeAllListeners(jU.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(jU.ON_AUDIO_BUFFER),this._source.on(jU.ON_AUDIO_BUFFER,(t=>e(t)))}play(){Qw.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(Qw.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Px.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){Qw.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Px.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Qw.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Px.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await MR(this,PU.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return Gh.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new nR(tR.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new nR(tR.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;null===(e=this._source.processSourceNode)||void 0===e||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(e){e.on(zU.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await MR(this,PU.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await MR(this,PU.NEED_REPLACE_TRACK,this))})),e.on(zU.ON_NODE,(e=>{this._source.processedNode=e}))}unbindProcessorDestinationEvents(e){e.removeAllListeners(zU.ON_TRACK),e.removeAllListeners(zU.ON_NODE)}bindProcessorContextEvents(e){e.on(qU.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}unbindProcessorContextEvents(e){e.removeAllListeners(qU.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof Vx&&(this._trackSource=new mx(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new xx(this._source.context,this.getTrackId(),"local"),t=new Ux(e);return this._processorContext=e,this._processorDestination=t,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(t),this._source.on(jU.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})})),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(Px.stop(this.getTrackId()),this._source.play()),MR(this,PU.NEED_REPLACE_MIXING_TRACK,this).then((()=>{Qw.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))})).catch((e=>{Qw.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),e)}))),{processorContext:e,processorDestination:t}}}).prototype,"setVolume",[qx],Object.getOwnPropertyDescriptor(uV.prototype,"setVolume"),uV.prototype),ix(uV.prototype,"setPlaybackDevice",[Yx,Jx],Object.getOwnPropertyDescriptor(uV.prototype,"setPlaybackDevice"),uV.prototype),ix(uV.prototype,"setEnabled",[Xx,Qx,Zx],Object.getOwnPropertyDescriptor(uV.prototype,"setEnabled"),uV.prototype),ix(uV.prototype,"setMuted",[$x,eV,tV],Object.getOwnPropertyDescriptor(uV.prototype,"setMuted"),uV.prototype),ix(uV.prototype,"getStats",[nV],Object.getOwnPropertyDescriptor(uV.prototype,"getStats"),uV.prototype),ix(uV.prototype,"setAudioFrameCallback",[iV],Object.getOwnPropertyDescriptor(uV.prototype,"setAudioFrameCallback"),uV.prototype),ix(uV.prototype,"play",[rV,oV],Object.getOwnPropertyDescriptor(uV.prototype,"play"),uV.prototype),ix(uV.prototype,"stop",[sV,aV],Object.getOwnPropertyDescriptor(uV.prototype,"stop"),uV.prototype),ix(uV.prototype,"close",[cV],Object.getOwnPropertyDescriptor(uV.prototype,"close"),uV.prototype),ix(uV.prototype,"pipe",[lV],Object.getOwnPropertyDescriptor(uV.prototype,"pipe"),uV.prototype),ix(uV.prototype,"unpipe",[dV],Object.getOwnPropertyDescriptor(uV.prototype,"unpipe"),uV.prototype),uV),LV=(hV=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),pV=kx(),fV=pw("MicrophoneAudioTrack","_enabledMutex"),mV=rI({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),_V=kx(),EV=rI({argsMap:e=>[e.getTrackId()]}),ix((gV=class extends kV{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,n,i){super(e,t.encoderConfig?OU(t.encoderConfig):{},i,Dw("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),nx(this,"_config",void 0),nx(this,"_deviceName","default"),nx(this,"_constraints",void 0),nx(this,"_originalConstraints",void 0),nx(this,"_enabled",!0),this._config=t,this._constraints=n,this._originalConstraints=n,this._deviceName=e.label,"boolean"==typeof t.bypassWebAudio&&(this._bypassWebAudio=t.bypassWebAudio),(GC()||WC())&&cx.bindInterruptDetectorTrack(this)}async setDevice(e){if(Qw.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await Ix.getDeviceById(e),n={};n.audio=tx({},this._constraints),n.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let i=null;try{i=await yx(n,this.getTrackId())}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setDevice failed"),e.toString()),i=await yx({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),e}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const t=await Ix.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}Qw.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,n){if(t)return Qw.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(Qw.info("[".concat(this.getTrackId(),"] start setEnabled"),e),Dw("AUTO_RESET_AUDIO_ROUTE")&&(kC()||KC())){const t=navigator.audioSession;t&&(e||(t.type="playback"),t.type="auto")}if(!e){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),null===(i=this._source.clonedTrack)||void 0===i||i.stop(),n||(this._enabled=!1);try{await MR(this,PU.NEED_DISABLE_TRACK,this)}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setEnabled false failed"),e.toString()),e}return}const r=tx({},this._constraints),o=Ix.searchDeviceIdByName(this._deviceName);o&&!r.deviceId&&(r.deviceId=o);try{n||(this._enabled=!0);const e=await yx({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getAudioTracks()[0],!1),await MR(this,PU.NEED_ENABLE_TRACK,this)}catch(e){throw n||(this._enabled=!1),Qw.error("[".concat(this.getTrackId(),"] setEnabled true failed"),e.toString()),e}Qw.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(GC()||WC())&&cx.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((kC()||KC())&&this._enabled&&!this._isClosed&&cx.duringInterruption){const e=async()=>{cx.off(_U.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(Qw.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};cx.on(_U.IOS_INTERRUPTION_END,e)}else Qw.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(VU.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,n=Ix.searchDeviceIdByName(this._deviceName);if(n&&!t.deviceId&&(t.deviceId=n),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const e=await yx({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(qU.REQUEST_UPDATE_CONSTRAINTS,(async(e,t,n)=>{try{const n=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(n),t()}catch(e){n(e)}}))}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(qU.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[hV,pV],Object.getOwnPropertyDescriptor(gV.prototype,"setDevice"),gV.prototype),ix(gV.prototype,"setEnabled",[fV,mV,_V],Object.getOwnPropertyDescriptor(gV.prototype,"setEnabled"),gV.prototype),ix(gV.prototype,"close",[EV],Object.getOwnPropertyDescriptor(gV.prototype,"close"),gV.prototype),gV),MV=(vV=rI({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),TV=kx(),SV=rI({argsMap:e=>[e.getTrackId()]}),yV=kx(),CV=rI({argsMap:e=>[e.getTrackId()]}),RV=kx(),wV=rI({argsMap:e=>[e.getTrackId()]}),IV=kx(),bV=rI({argsMap:e=>[e.getTrackId()]}),AV=kx(),OV=rI({argsMap:e=>[e.getTrackId()]}),NV=rI({argsMap:e=>[e.getTrackId()]}),DV=kx(),ix((PV=class extends kV{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,n,i){super(t.createOutputTrack(),n,i),nx(this,"source",void 0),nx(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=t,this._bufferSource.on(jU.AUDIO_SOURCE_STATE_CHANGE,(e=>{this.safeEmit(VU.SOURCE_STATE_CHANGE,e)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(e){}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){oR(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}).prototype,"startProcessAudioBuffer",[vV,TV],Object.getOwnPropertyDescriptor(PV.prototype,"startProcessAudioBuffer"),PV.prototype),ix(PV.prototype,"pauseProcessAudioBuffer",[SV,yV],Object.getOwnPropertyDescriptor(PV.prototype,"pauseProcessAudioBuffer"),PV.prototype),ix(PV.prototype,"seekAudioBuffer",[CV,RV],Object.getOwnPropertyDescriptor(PV.prototype,"seekAudioBuffer"),PV.prototype),ix(PV.prototype,"resumeProcessAudioBuffer",[wV,IV],Object.getOwnPropertyDescriptor(PV.prototype,"resumeProcessAudioBuffer"),PV.prototype),ix(PV.prototype,"stopProcessAudioBuffer",[bV,AV],Object.getOwnPropertyDescriptor(PV.prototype,"stopProcessAudioBuffer"),PV.prototype),ix(PV.prototype,"close",[OV],Object.getOwnPropertyDescriptor(PV.prototype,"close"),PV.prototype),ix(PV.prototype,"setAudioBufferPlaybackSpeed",[NV,DV],Object.getOwnPropertyDescriptor(PV.prototype,"setAudioBufferPlaybackSpeed"),PV.prototype),PV);class UV extends kV{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=lx().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,ew(8,"track-mix-")),nx(this,"trackList",void 0),nx(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(e){}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return-1!==this.trackList.indexOf(e)}addAudioTrack(e){-1===this.trackList.indexOf(e)?(Qw.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):Qw.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(-1!==this.trackList.indexOf(e)){Qw.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch(e){}FR(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach((t=>{t._encoderConfig&&((t._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=t._encoderConfig.bitrate),(t._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=t._encoderConfig.sampleRate),(t._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=t._encoderConfig.sampleSize),t._encoderConfig.stereo&&(e.stereo=!0))})),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach((t=>{t instanceof UV?t.emit(xU.TRANSCEIVER_UPDATED,e):t._updateRtpTransceiver(e)})))}}class xV extends fx{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit(jU.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),nx(this,"audioBuffer",void 0),nx(this,"sourceNode",void 0),nx(this,"startPlayTime",0),nx(this,"startPlayOffset",0),nx(this,"pausePlayTime",0),nx(this,"options",void 0),nx(this,"currentLoopCount",0),nx(this,"currentPlaybackSpeed",100),nx(this,"_currentState","stopped"),this.audioBuffer=e,this.options=t,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?"stopped"===this.currentState?0:"paused"===this.currentState?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){"stopped"===this.currentState?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):Qw.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&"playing"===this.currentState&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,"playing"===this.currentState&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),"playing"===this.currentState?(this.startPlayOffset=e,this.startSourceNode()):"paused"===this.currentState&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){"paused"===this.currentState&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch(e){}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&("playing"===this.currentState&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const VV=new Map;class FV{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){const e=this.renderStats.curTs-this.renderStats.lastTs,t=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/e;return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,t}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(Qw.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var t;e!==this._videoState&&(this._videoState=e,null===(t=this.onVideoStateChanged)||void 0===t||t.call(this,this.videoState))}constructor(e){nx(this,"trackId",void 0),nx(this,"config",void 0),nx(this,"onFirstVideoFrameDecoded",void 0),nx(this,"onVideoStateChanged",void 0),nx(this,"freezeTimeCounterList",[]),nx(this,"renderFreezeAccTime",0),nx(this,"isKeepLastFrame",!1),nx(this,"timeUpdatedCount",0),nx(this,"freezeTime",0),nx(this,"playbackTime",0),nx(this,"lastTimeUpdatedTime",0),nx(this,"autoplayFailed",!1),nx(this,"videoTrack",void 0),nx(this,"videoElement",void 0),nx(this,"cacheVideoElement",void 0),nx(this,"renderStats",void 0),nx(this,"_videoState",QU.VideoStateStopped),nx(this,"videoElementCheckInterval",void 0),nx(this,"videoElementFreezeTimeout",void 0),nx(this,"_videoElementStatus",XU.NONE),nx(this,"isGettingVideoDimensions",!1),nx(this,"startGetVideoDimensions",(()=>{const e=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return Qw.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(e,500)};!this.isGettingVideoDimensions&&e()})),nx(this,"autoResumeAfterInterruption",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&"running"===cx.curState&&(Qw.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(bC())),HC()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),nx(this,"handleVideoEvents",(e=>{switch(e.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=XU.PLAYING;break;case"loadeddata":if(this.videoState=QU.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch(e){}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=XU.CANPLAY;break;case"stalled":this.videoElementStatus=XU.STALLED;break;case"suspend":this.videoElementStatus=XU.SUSPEND;break;case"pause":this.videoElementStatus=XU.PAUSED,kC()||KC()||NC()&&this.autoplayFailed||!this.videoTrack||"live"!==this.videoTrack.readyState||(Qw.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=XU.WAITING;break;case"abort":this.videoElementStatus=XU.ABORT;break;case"ended":this.videoElementStatus=XU.ENDED;break;case"emptied":this.videoElementStatus=XU.EMPTIED;break;case"error":{const e=this.videoElement.error;e?(this.videoElementStatus=XU.ERROR,Qw.error("[".concat(this.trackId,"] media error: ").concat(e.message," (").concat(e.code,")"))):Qw.debug("[".concat(this.trackId,"] media not been an error."));break}case"timeupdate":{const e=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=e);const t=e-this.lastTimeUpdatedTime,n=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=e,BF.lastVisibleTime<BF.lastHiddenTime||n<BF.lastHiddenTime||n<BF.lastVisibleTime)return;for(t>Dw("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=t),this.playbackTime+=t;this.playbackTime>=6e3;){this.playbackTime-=6e3;const e=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(e),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}})),nx(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&(Qw.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(bC())),HC()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),cx.on(_U.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),cx.on(_U.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return null!==(e=this.videoElement.parentElement)&&void 0!==e?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const t=this.videoElement.play();t&&t.catch&&t.catch((t=>{e&&Nx(e,"video",t.message,this.trackId),"NotAllowedError"===t.name?(Qw.warning("detected video element autoplay failed",t),this.autoplayFailed=!0,this.handleAutoPlayFailed()):Qw.warning("[".concat(this.trackId,"] play warning: "),t)}));const n=RC();if(("Safari"===n.name&&15===Number(n.version)||GC())&&t&&t.then){const e=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};t.then(e).catch(e)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const t=e.getContext("2d");if(!t)return Qw.error("create canvas context failed!"),new ImageData(2,2);t.drawImage(this.videoElement,0,0,e.width,e.height);const n=t.getImageData(0,0,e.width,e.height);return e.remove(),n}async getCurrentFrameToUint8Array(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const n=document.createElement("canvas");n.width=this.videoElement.videoWidth,n.height=this.videoElement.videoHeight;const i=n.getContext("2d");return i?(i.drawImage(this.videoElement,0,0,n.width,n.height),new Gh(((i,r)=>{n.toBlob((async e=>{if(n.remove(),e){const t=await zx(e);i({buffer:t,width:n.width,height:n.height})}else r(new nR(tR.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,t<0?.1:t>1?1:t)}))):await Kx(e)}destroy(){this.renderStats=void 0,cx.off(_U.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),cx.off(_U.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=QU.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=XU.INIT,!this.videoElementCheckInterval&&(jV.forEach((e=>{this.videoElement.addEventListener(e,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{(function(e){return e!==document.body&&document.body.contains(e)})(this.videoElement)||(this.videoElementStatus=XU.DESTROYED)}),1e3),Dw("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,t;let n;const i=()=>{"visible"===document.visibilityState&&(document.removeEventListener("visibilitychange",i),this.videoElementFreezeTimeout=window.setTimeout(r,Dw("VIDEO_FREEZE_DURATION")))},r=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===QU.VideoStateDecoding&&("visible"===document.visibilityState?this.videoState=QU.VideoStateFrozen:document.addEventListener("visibilitychange",i))},o=(e,t)=>{if(this.videoElementStatus===XU.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=t.mediaTime):this.renderStats={lastTs:t.mediaTime,curTs:t.mediaTime,lastRenderNum:0,renderNum:0},n){const e=t.presentationTime-n.presentationTime;this.videoState===QU.VideoStateStarting&&(this.videoState=QU.VideoStateDecoding),this.videoState===QU.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(r,Dw("VIDEO_FREEZE_DURATION"))),e<Dw("VIDEO_FREEZE_DURATION")&&this.videoState===QU.VideoStateFrozen&&(this.videoState=QU.VideoStateDecoding),e>Dw("VIDEO_FREEZE_DURATION")&&BF.lastVisibleTime>=BF.lastHiddenTime&&n.timestamp>BF.lastVisibleTime&&n.timestamp>BF.lastHiddenTime&&(this.renderFreezeAccTime+=e)}n=tx(tx({},t),{},{timestamp:e})}var i,s;Dw("ENABLE_VIDEO_FRAME_CALLBACK")&&(null===(i=(s=this.videoElement).requestVideoFrameCallback)||void 0===i||i.call(s,o))};null===(e=(t=this.videoElement).requestVideoFrameCallback)||void 0===e||e.call(t,o)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),XC()&&!Dw("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const n=RC();"Safari"===n.name&&15===Number(n.version)||GC()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,PC()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,PC()&&this.videoElement.load());const i=this.videoElement.play();void 0!==i&&i.catch((e=>{Qw.debug("[".concat(this.trackId,"] playback interrupted"),e.toString())}))}resetVideoElement(){jV.forEach((e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=XU.NONE}handleAutoPlayFailed(){const e=t=>{t.preventDefault(),this.videoElement.play().then((()=>{Qw.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((e=>{Qw.error(e)})),this.autoplayFailed=!1,QC()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};QC()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),Ox()}}const jV=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class BV extends FV{constructor(e){super(e),nx(this,"container",void 0),nx(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const t=e.element;t!==this.slot&&(this.destroy(),this.slot=t),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var t;null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,n):await Kx(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch(e){}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",Dw("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if(null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch(e){}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var GV,WV,HV,KV,zV,qV,YV,JV,XV,QV,ZV,$V,eF,tF,nF,iF,rF,oF,sF,aF,cF,lF,dF,uF,hF,pF,fF,mF,_F,EF,gF,vF,TF,SF,yF;let CF=(GV=rI({argsMap:(e,t,n)=>[e.getTrackId(),"string"==typeof t?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),WV=kx(),HV=rI({argsMap:e=>[e.getTrackId()]}),KV=pw("LocalVideoTrack","_enabledMutex"),zV=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),qV=kx(),YV=pw("LocalVideoTrack","_enabledMutex"),JV=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),XV=kx(),QV=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),ZV=kx(),$V=kx(),eF=rI({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),tF=kx(),nF=kx(),iF=kx(),rF=kx(),oF=kx(),sF=kx(),aF=kx(),cF=rI({argsMap:(e,t)=>[e.getTrackId(),t.name]}),lF=rI({argsMap:e=>[e.getTrackId()]}),dF=rI({argsMap:e=>[e.getTrackId()]}),uF=rI({argsMap:(e,t,n)=>[e.getTrackId(),t.label,n]}),hF=rI(),pF=class e extends ox{get videoHeight(){if(NC()){const{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if(NC()){const{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==XU.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,t,n,i,r,o){if(super(e,r),nx(this,"trackMediaType","video"),nx(this,"_player",void 0),nx(this,"isUseScaleResolutionDownBy",!1),nx(this,"_videoVisibleTimer",null),nx(this,"_statsTimer",null),nx(this,"_previousVideoVisibleStatus",void 0),nx(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),nx(this,"_encoderConfig",void 0),nx(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),nx(this,"_optimizationMode",void 0),nx(this,"_videoHeight",void 0),nx(this,"_videoWidth",void 0),nx(this,"_forceBitrateLimit",void 0),nx(this,"_enabled",!0),nx(this,"_processorDestination",void 0),nx(this,"_processorContext",void 0),NC()){const{width:t,height:n}=e.getSettings();this._videoWidth=t,this._videoHeight=n}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=t,this._scalabilityMode=n,this._optimizationMode=i,this._hints=o||[],-1===this._hints.indexOf(kU.SCREEN_TRACK))this.updateBitrateFromProfile();else if(function(e,t,n){const i=RC();return!(i.name!==e||!i.osVersion)&&(n?Number(i.version)>=t&&Number(i.version)<=n:Number(i.version)===t)}(TC.CHROME,115)&&-1!==IC().indexOf("Windows")){const t=function(e,t){if("VideoFrame"in window&&"TransformStream"in window&&fU().supportWebRTCInsertableStream){const n=new MediaStreamTrackProcessor(e),i=new MediaStreamTrackGenerator({kind:"video"});let r,o,s=Date.now();const a=()=>{c&&(clearInterval(c),c=void 0),r&&(r.close(),r=void 0),e.stop(),o=void 0,i.removeEventListener("ended",a)};let c=window.setInterval((()=>{if(o&&r&&Date.now()-s>(null!=t?t:1e3))try{"live"===i.readyState?o.enqueue(r.clone()):a()}catch(e){a()}}),null!=t?t:1e3);const l=new TransformStream({transform:(e,t)=>{"live"===i.readyState?(o=t,s=Date.now(),void 0===r?(r=e,t.enqueue(e.clone())):(t.enqueue(r),r=e)):e.close()}});return i.addEventListener("ended",a),n.readable.pipeThrough(l).pipeTo(i.writable),i}}(e);t&&(Qw.info("local screen video track begin to inject frame"),this._mediaStreamTrack=t)}t&&-1!==this._hints.indexOf(kU.CUSTOM_TRACK)&&this.setEncoderConfiguration(t),this._processorContext=new Mx(this.getTrackId(),"local"),this._processorDestination=new Lx(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e){const t=document.getElementById(e);t?e=t:(Qw.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}Qw.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const n=tx(tx(tx({},this._getDefaultPlayerConfig()),t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(n):(e instanceof HTMLVideoElement?this._player=new FV(n):this._player=new BV(n),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const e=this.getVideoElementVisibleStatus();this.safeEmit(VU.VIDEO_ELEMENT_VISIBLE_STATUS,e)}catch(e){}}),Dw("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,Qw.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(Qw.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await MR(this,PU.NEED_DISABLE_TRACK,this)}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}return t||(this._enabled=!1),void Qw.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await MR(this,PU.NEED_ENABLE_TRACK,this)}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setEnabled to true error"),e.toString()),e}Qw.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,Qw.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await MR(this,PU.NEED_MUTE_TRACK,this):await MR(this,PU.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,t){if(!this._enabled)throw new nR(tR.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if("720p_auto"===e?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=wU(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const t=Bx({encoderConfig:e});(NC()||kC()||KC())&&(t.deviceId=void 0),Qw.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(t));try{await this._originMediaStreamTrack.applyConstraints(t),this.updateMediaStreamTrackResolution()}catch(e){const t=new nR(tR.UNEXPECTED_ERROR,e.toString());throw Qw.error("[".concat(this.getTrackId(),"] applyConstraints error"),t.toString()),t}}this._encoderConfig=e,-1===this._hints.indexOf(kU.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await MR(this,PU.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(Qw)}}getStats(){return KR((()=>{Qw.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning"),UR(this,PU.GET_STATS)||tx({},GU)}async setBeautyEffect(e){Qw.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,t):await Kx(e)}async setBitrateLimit(e){if(Qw.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate);try{await MR(this,PU.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(Qw)}}}async setOptimizationMode(e){if("motion"!==e&&"detail"!==e&&"balanced"!==e)return void Qw.error(tR.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const t=this._optimizationMode;try{this._optimizationMode=e,await MR(this,PU.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(e){throw this._optimizationMode=t,Qw.error("[".concat(this.getTrackId(),"] set optimization mode failed"),e.toString()),e}Qw.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(1===e.numSpatialLayers&&1!==e.numTemporalLayers)return Qw.error(tR.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,Qw.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){jx(this._originMediaStreamTrack).then((e=>{let[t,n]=e;this._videoHeight=n,this._videoWidth=t})).catch(nw)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new nR(tR.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");Qw.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=wU(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,-1===this._hints.indexOf(kU.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await MR(this,PU.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(Qw)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:t,frameRate:n}=this.getMediaStreamTrackSettings();if(!e||!t||!n)return;const{bitrateMax:i,bitrateMin:r}=this._encoderConfig;if(null==r||null==i){const{max:o,min:s}=function(e,t,n,i,r){const o=Dw("BITRATE_ADAPTER_TYPE");if("DEFAULT_BITRATE"===o)return{min:i,max:r};if(void 0===r){var s;const a=Math.floor(200*Math.pow(n/15,.6)*Math.pow(e*t/640/360,.75));r="STANDARD_BITRATE"===o?4*a:2*a,i=null!==(s=i)&&void 0!==s?s:a}else{var a;i=null!==(a=i)&&void 0!==a?a:Math.floor(r/10)}return{min:i,max:r}}(e,t,n,r,i);this._encoderConfig.bitrateMin=s,this._encoderConfig.bitrateMax=o,Qw.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(t,", fps: ").concat(n,"] => [brMax: ").concat(o,", brMin: ").concat(s,"]"))}}getVideoElementVisibleStatus(){try{var e,t;const n=null==this||null===(e=this._player)||void 0===e?void 0:e.getContainerElement(),i={track:this,element:null==this||null===(t=this._player)||void 0===t?void 0:t.getVideoElement(),slot:null==n?void 0:n.parentElement},{element:r,slot:o}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){const e=mR.checkOneElementVisible(r),t=Object.assign({},e);if(t.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=t.visible;const e=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});t.visible?e.onSuccess("Video is visible"):e.onSuccess("Invisible because of ".concat(t.reason))}return t}return}catch(e){throw new nR(tR.GET_VIDEO_ELEMENT_VISIBLE_ERROR,e.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new nR(tR.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._encoderConfig;t&&(i=tx(tx({},i),wU(t))),i=WR(i);const r=ew(8,"track-video-cloned-"),o=new e(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,WR(this._scalabilityMode),this._optimizationMode,r,WR(this._hints));return t&&i&&o.setEncoderConfiguration(i),Qw.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}async replaceTrack(e,t){if(!(e instanceof MediaStreamTrack))throw new nR(tR.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if("video"!==e.kind)throw new nR(tR.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,t,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!NC()&&!kC())return;this._statsTimer&&window.clearInterval(this._statsTimer);let e=2,t=yU[e],n=-1,i=Date.now();const r=e=>{e>2||e<0||(i=Date.now(),t=yU[e],this.setSenderConfiguration(t))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval((()=>{const o=this.getStats(),s=UR(this,PU.GET_RTC_STATS);if(o.sendPackets>0&&s){-1===n&&(n=Date.now());const a=Date.now();if(a-n<1e3||a-i<Dw("PROFILE_SWITCH_INTERVAL"))return;const c=o.sendFrameRate,l=.6*t.frameRate,d=.9*t.frameRate;"number"==typeof c&&c>0&&c<l?e>0&&(e--,r(e),Qw.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(c,", switchProfile to ").concat(e))):s.OutgoingAvailableBandwidth<t.bitrateMin?e>0&&(e--,r(e),Qw.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(s.OutgoingAvailableBandwidth,", bitrateMin ").concat(t.bitrateMin,", switchProfile to ").concat(e))):"number"==typeof c&&c>d&&e<yU.length-1&&s.OutgoingAvailableBandwidth>1.2*yU[e+1].bitrateMin&&(e++,r(e),Qw.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(c,", OutgoingAvailableBandwidth ").concat(s.OutgoingAvailableBandwidth,", switchProfile to ").concat(e)))}}),Dw("CHECK_LOCAL_STATS_INTERVAL"))}sendSeiData(e){if(KR((()=>{oI.reportApiInvoke(null,{name:yR.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:CR.TRACER}).onSuccess("")}),this._mediaStreamTrack.id||this.getTrackId()),!Dw("ENABLE_VIDEO_SEI")||!Dw("ENABLE_ENCODED_TRANSFORM"))return void Qw.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new nR(tR.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const t=this.getRTCRtpTransceiver();if(!t)return void Qw.warning("Video track is not published, SEI can not be send");const n=t.sender.getParameters();if(0===n.codecs.length)return;const i=n.codecs[0].mimeType.toLocaleLowerCase();"video/h264"===i?this.safeEmit("sei-to-send",e):Qw.warning("SEI is not supported by ".concat(i))}bindProcessorDestinationEvents(){this.processorDestination.on(zU.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await MR(this,PU.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await MR(this,PU.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(zU.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(qU.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(qU.REQUEST_CONSTRAINTS)}},ix(pF.prototype,"play",[GV,WV],Object.getOwnPropertyDescriptor(pF.prototype,"play"),pF.prototype),ix(pF.prototype,"stop",[HV],Object.getOwnPropertyDescriptor(pF.prototype,"stop"),pF.prototype),ix(pF.prototype,"setEnabled",[KV,zV,qV],Object.getOwnPropertyDescriptor(pF.prototype,"setEnabled"),pF.prototype),ix(pF.prototype,"setMuted",[YV,JV,XV],Object.getOwnPropertyDescriptor(pF.prototype,"setMuted"),pF.prototype),ix(pF.prototype,"setEncoderConfiguration",[QV,ZV],Object.getOwnPropertyDescriptor(pF.prototype,"setEncoderConfiguration"),pF.prototype),ix(pF.prototype,"getStats",[$V],Object.getOwnPropertyDescriptor(pF.prototype,"getStats"),pF.prototype),ix(pF.prototype,"setBeautyEffect",[eF,tF],Object.getOwnPropertyDescriptor(pF.prototype,"setBeautyEffect"),pF.prototype),ix(pF.prototype,"getCurrentFrameData",[nF],Object.getOwnPropertyDescriptor(pF.prototype,"getCurrentFrameData"),pF.prototype),ix(pF.prototype,"getCurrentFrameImage",[iF],Object.getOwnPropertyDescriptor(pF.prototype,"getCurrentFrameImage"),pF.prototype),ix(pF.prototype,"setBitrateLimit",[rF],Object.getOwnPropertyDescriptor(pF.prototype,"setBitrateLimit"),pF.prototype),ix(pF.prototype,"setOptimizationMode",[oF],Object.getOwnPropertyDescriptor(pF.prototype,"setOptimizationMode"),pF.prototype),ix(pF.prototype,"setScalabiltyMode",[sF],Object.getOwnPropertyDescriptor(pF.prototype,"setScalabiltyMode"),pF.prototype),ix(pF.prototype,"updateMediaStreamTrackResolution",[aF],Object.getOwnPropertyDescriptor(pF.prototype,"updateMediaStreamTrackResolution"),pF.prototype),ix(pF.prototype,"pipe",[cF],Object.getOwnPropertyDescriptor(pF.prototype,"pipe"),pF.prototype),ix(pF.prototype,"unpipe",[lF],Object.getOwnPropertyDescriptor(pF.prototype,"unpipe"),pF.prototype),ix(pF.prototype,"close",[dF],Object.getOwnPropertyDescriptor(pF.prototype,"close"),pF.prototype),ix(pF.prototype,"replaceTrack",[uF],Object.getOwnPropertyDescriptor(pF.prototype,"replaceTrack"),pF.prototype),ix(pF.prototype,"startMonitorStats",[hF],Object.getOwnPropertyDescriptor(pF.prototype,"startMonitorStats"),pF.prototype),pF),RF=(fF=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),mF=kx(),_F=pw("CameraVideoTrack","_enabledMutex"),EF=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),gF=kx(),vF=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),TF=kx(),SF=rI({argsMap:e=>[e.getTrackId()]}),yF=class e extends CF{get __className__(){return"CameraVideoTrack"}constructor(e,t,n,i,r,o){super(e,wU(t.encoderConfig),i,r,o),nx(this,"_config",void 0),nx(this,"_originalConstraints",void 0),nx(this,"_constraints",void 0),nx(this,"_enabled",!0),nx(this,"_deviceName","default"),nx(this,"tryResumeVideoForIOS15_16WeChat",(async()=>{(GC()||WC())&&!function(){const e=RC();if(e.os!==vC.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])&&Number(t[1])>=2}()&&zC()&&this._enabled&&!this._isClosed&&(Qw.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())})),this._config=t,this._originalConstraints=n,this._constraints=n,this._deviceName=e.label,this._encoderConfig=wU(this._config.encoderConfig),cx.on(_U.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),cx.on(_U.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return"string"==typeof e?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(Qw.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const t=await Ix.getDeviceById(e),n={};n.video=tx({},this._constraints),n.video.deviceId={exact:e},n.video.facingMode=void 0,this._originMediaStreamTrack.stop();let i=null;try{i=await yx(n,this.getTrackId())}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setDevice failed"),e.toString()),i=await yx({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),e}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const t=await Ix.getDeviceById(e);this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}Qw.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){Qw.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));const t={video:tx(tx({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let e=null;try{e=await yx(t,this.getTrackId())}catch(t){throw Qw.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),t.toString()),e=await yx({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1),t}await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=tx({},t.video),Qw.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(Qw.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const e=await yx({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1)}await MR(this,PU.NEED_ENABLE_TRACK,this)}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setEnabled true error"),e.toString()),e}this.updateMediaStreamTrackResolution(),Qw.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),t||(this._enabled=!1);try{await MR(this,PU.NEED_DISABLE_TRACK,this)}catch(e){throw Qw.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}Qw.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,t){if(!this._enabled)throw new nR(tR.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");"720p_auto"===e?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=wU(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate||e.bitrateMin);const n=GR(this._config);n.encoderConfig=e;const i=Bx(n);(NC()||kC()||KC())&&(i.deviceId=void 0),Qw.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(e){const t=new nR(tR.UNEXPECTED_ERROR,e.toString());throw Qw.error("[".concat(this.getTrackId(),"] applyConstraints error"),t.toString()),t}this._config=n,this._constraints=i,this._originalConstraints=i,this._encoderConfig=e,-1===this._hints.indexOf(kU.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await MR(this,PU.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(Qw)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((kC()||KC())&&this._enabled&&!this._isClosed&&cx.duringInterruption){const e=async()=>{cx.off(_U.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(Qw.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};cx.on(_U.IOS_INTERRUPTION_END,e)}else Qw.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(VU.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,n=Ix.searchDeviceIdByName(this._deviceName);if(n&&!t.deviceId&&(t.deviceId={exact:n}),this._enabled){const e=await yx({video:t},this.getTrackId());this._constraints=t,await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),cx.off(_U.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),cx.off(_U.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this._encoderConfig;t&&(i=tx(tx({},i),wU(t))),i=WR(i);const r=ew(8,"track-cam-cloned-"),o=new e(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,WR(tx(tx({},this._config),{},{encoderConfig:i})),WR(this._constraints),WR(this._scalabilityMode),this._optimizationMode,r);return t&&i&&o.setEncoderConfiguration(i),Qw.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}bindProcessorContextEvents(){this.processorContext.on(qU.REQUEST_UPDATE_CONSTRAINTS,(async(e,t,n)=>{try{const n=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(n),t()}catch(e){n(e)}})),this.processorContext.on(qU.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}},ix(yF.prototype,"setDevice",[fF,mF],Object.getOwnPropertyDescriptor(yF.prototype,"setDevice"),yF.prototype),ix(yF.prototype,"setEnabled",[_F,EF,gF],Object.getOwnPropertyDescriptor(yF.prototype,"setEnabled"),yF.prototype),ix(yF.prototype,"setEncoderConfiguration",[vF,TF],Object.getOwnPropertyDescriptor(yF.prototype,"setEncoderConfiguration"),yF.prototype),ix(yF.prototype,"close",[SF],Object.getOwnPropertyDescriptor(yF.prototype,"close"),yF.prototype),yF);function wF(e,t,n,i){n.optimizationMode&&(i&&i.width&&i.height?(n.encoderConfig=tx(tx({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),"motion"!==n.optimizationMode&&"detail"!==n.optimizationMode||(t.contentHint=n.optimizationMode,t.contentHint===n.optimizationMode?Qw.debug("[".concat(e,"] set content hint to"),n.optimizationMode):Qw.debug("[".concat(e,"] set content hint failed")))):Qw.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}var IF,bF,AF,OF,NF,DF,PF,kF,LF,MF,UF,xF;class VF extends rx{getUserId(){return this._userId}constructor(e,t,n,i){super(e,"track-".concat(e.kind,"-").concat(t,"-").concat(i.clientId,"_").concat(ew(5,""))),nx(this,"_userId",void 0),nx(this,"_uintId",void 0),nx(this,"_isDestroyed",!1),nx(this,"store",void 0),nx(this,"processor",void 0),nx(this,"processorContext",void 0),this._userId=t,this._uintId=n,this.store=i}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,Qw.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let FF=(IF=rI({argsMap:(e,t,n)=>[e.getTrackId(),"string"==typeof t?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),bF=rI({argsMap:e=>[e.getTrackId()]}),AF=rI({argsMap:(e,t)=>[e.getTrackId(),t.name]}),OF=rI({argsMap:e=>[e.getTrackId()]}),ix((NF=class extends VF{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==XU.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,n,i){super(e,t,n,i),nx(this,"_videoVisibleTimer",null),nx(this,"_previousVideoVisibleStatus",void 0),nx(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),nx(this,"trackMediaType","video"),nx(this,"_videoWidth",void 0),nx(this,"_videoHeight",void 0),nx(this,"_player",void 0),nx(this,"processorDestination",void 0),nx(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new Mx(this.getTrackId(),"remote"),this.processorDestination=new Lx(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return KR((()=>{Qw.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),UR(this,PU.GET_STATS)||tx({},KU)}play(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e){const t=document.getElementById(e);t?e=t:(Qw.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}Qw.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const n=tx(tx({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(n):(e instanceof HTMLVideoElement?this._player=new FV(n):this._player=new BV(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(FU.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=e=>{this.safeEmit(FU.VIDEO_STATE_CHANGED,e)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const e=this.getVideoElementVisibleStatus();this.safeEmit(FU.VIDEO_ELEMENT_VISIBLE_STATUS,e)}catch(e){}}),Dw("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,Qw.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){jx(this._originMediaStreamTrack).then((e=>{let[t,n]=e;this._videoHeight=n,this._videoWidth=t})).catch(nw)}_updatePlayerSource(){Qw.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const n=null==this||null===(e=this._player)||void 0===e?void 0:e.getContainerElement(),i={track:this,element:null==this||null===(t=this._player)||void 0===t?void 0:t.getVideoElement(),slot:null==n?void 0:n.parentElement},{element:r,slot:o}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){const e=mR.checkOneElementVisible(r),t=Object.assign({},e);if(t.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=t.visible;const e=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});t.visible?e.onSuccess("Video is visible"):e.onSuccess("Invisible because of ".concat(t.reason))}return t}return}catch(e){throw new nR(tR.GET_VIDEO_ELEMENT_VISIBLE_ERROR,e.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new nR(tR.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(zU.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(zU.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(xU.SEI_RECEIVED,e)}}).prototype,"play",[IF],Object.getOwnPropertyDescriptor(NF.prototype,"play"),NF.prototype),ix(NF.prototype,"stop",[bF],Object.getOwnPropertyDescriptor(NF.prototype,"stop"),NF.prototype),ix(NF.prototype,"pipe",[AF],Object.getOwnPropertyDescriptor(NF.prototype,"pipe"),NF.prototype),ix(NF.prototype,"unpipe",[OF],Object.getOwnPropertyDescriptor(NF.prototype,"unpipe"),NF.prototype),NF),jF=(DF=rI({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),PF=rI({argsMap:(e,t)=>[e.getTrackId(),t]}),kF=rI({argsMap:e=>[e.getTrackId()]}),LF=rI({argsMap:e=>[e.getTrackId()]}),MF=rI({argsMap:(e,t)=>[e.getTrackId(),t.name]}),UF=rI({argsMap:e=>[e.getTrackId()]}),ix((xF=class extends VF{get isPlaying(){return this._useAudioElement?Px.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,n,i){super(e,t,n,i),nx(this,"trackMediaType","audio"),nx(this,"_source",void 0),nx(this,"_useAudioElement",!0),nx(this,"_volume",100),nx(this,"processorContext",void 0),nx(this,"processorDestination",void 0),nx(this,"_played",!1),nx(this,"_bypassWebAudio",!1),Dw("DISABLE_WEBAUDIO")?(this._source=new Vx,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new mx(e,!0),Dw("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(jU.RECEIVE_TRACK_BUFFER,(()=>{this.safeEmit(FU.FIRST_FRAME_DECODED)})),this.processorContext=new xx(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new Ux(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(jU.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!e)return this._source.removeAllListeners(jU.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(jU.ON_AUDIO_BUFFER),this._source.on(jU.ON_AUDIO_BUFFER,(t=>e(t)))}setVolume(e){this._volume=e,this._useAudioElement?Px.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!mU())throw new nR(tR.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Px.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return KR((()=>{Qw.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),UR(this,PU.GET_STATS)||tx({},WU)}play(){Qw.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(Qw.debug("[".concat(this.getTrackId(),"] use audio element to play")),Px.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){Qw.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Px.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];Qw.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Px.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new nR(tR.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new nR(tR.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new nR(tR.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;null===(e=this._source.processSourceNode)||void 0===e||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(zU.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(zU.ON_NODE,(e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(zU.ON_TRACK),this.processorDestination.removeAllListeners(zU.ON_NODE)}}).prototype,"setVolume",[DF],Object.getOwnPropertyDescriptor(xF.prototype,"setVolume"),xF.prototype),ix(xF.prototype,"setPlaybackDevice",[PF],Object.getOwnPropertyDescriptor(xF.prototype,"setPlaybackDevice"),xF.prototype),ix(xF.prototype,"play",[kF],Object.getOwnPropertyDescriptor(xF.prototype,"play"),xF.prototype),ix(xF.prototype,"stop",[LF],Object.getOwnPropertyDescriptor(xF.prototype,"stop"),xF.prototype),ix(xF.prototype,"pipe",[MF],Object.getOwnPropertyDescriptor(xF.prototype,"pipe"),xF.prototype),ix(xF.prototype,"unpipe",[UF],Object.getOwnPropertyDescriptor(xF.prototype,"unpipe"),xF.prototype),xF);const BF=new class extends vR{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),nx(this,"_lastHiddenTime",0),nx(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),Qw.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}};var GF=function(e){return e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE",e}(GF||{});class WF{constructor(){nx(this,"_sequence",0),nx(this,"_startTime",Date.now()),nx(this,"isUseOneByte",!0)}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const t={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const n=new Uint8Array(4);n.set([1,0,0,0]);const i={id:0,length:4,data:n.buffer},r={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[i]};t.commonPacketHeader.extension=1,t.extension=r,t.payload=this.compress(e),t.commonPacketHeader.length=8+(t.extension.length+2)+t.payload.byteLength}else t.commonPacketHeader.length=8+t.payload.byteLength;Dw("SHOW_DATASTREAM2_LOG")&&Qw.debug("send data header: ".concat(JSON.stringify(t.commonPacketHeader)));const n=new ArrayBuffer(t.commonPacketHeader.length),i=new Uint8Array(n),r=new DataView(n);let o=0;if(r.setUint16(o,t.commonPacketHeader.extension<<15|t.commonPacketHeader.reserved<<14|t.commonPacketHeader.length,!0),o+=2,r.setUint32(o,t.commonPacketHeader.sequence,!0),o+=4,r.setUint16(o,t.commonStreamHeader,!0),o+=2,t.extension){const e=this.serializeExtension(t.extension);i.set(new Uint8Array(e),o),o+=e.byteLength}if(i.set(new Uint8Array(t.payload),o),o+=t.payload.byteLength,o!==t.commonPacketHeader.length)throw Error("serialize error!");return n}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const t=new DataView(e);let n=0;const i=t.getUint16(n,!0);n+=2;const r={length:16383&i,reserved:(16384&i)>>14,extension:(32768&i)>>15,sequence:t.getUint16(n+2,!0)<<16|t.getUint16(n,!0)};let o,s;if(n+=4,Dw("SHOW_DATASTREAM2_LOG")&&Qw.debug("receive data header: ".concat(JSON.stringify(r))),t.getUint16(n,!0),n+=2,r.extension){s=this.deserializeExtension(e.slice(n)),n+=2+s.length,o=e.slice(n);let t=!1;if(s.datas.length>0){const e=s.datas.find((e=>0===e.id));e&&(t=1==(1&new DataView(e.data).getUint32(0,!0)))}o=t?this.decompress(o):o}else o=e.slice(8);return o}serializeExtension(e){const{profile:t,length:n,datas:i}=e,r=new ArrayBuffer(n+2),o=new Uint8Array(r),s=new DataView(r);let a=0;if(s.setUint8(a++,t),s.setUint8(a++,n),i.forEach((e=>{t?(s.setUint8(a++,e.id),s.setUint8(a++,e.length),o.set(new Uint8Array(e.data),a),a+=e.data.byteLength):(s.setUint8(a++,e.id|e.length<<4),o.set(new Uint8Array(e.data),a),a+=e.data.byteLength)})),a!==n+2)throw Error("serialize extension error, is ".concat(a,"!==").concat(n+2));return r}deserializeExtension(e){const t=new DataView(e);let n=0;const i=t.getUint8(n);n++;const r=t.getUint8(n);n++;const o=i===GF.TWO_BYTE,s=[],a=new DataView(e,2);let c=0;for(;c<r;){let e=0,t=0,n=new ArrayBuffer(0);o?(e=a.getUint8(c),c++,t=a.getUint8(c),c++):(e=15&a.getUint8(c),t=a.getUint8(c)>>4,c++),t>0&&(n=a.buffer.slice(c+2,c+2+t),c+=n.byteLength),s.push({id:e,length:t,data:n})}if(c!==r)throw Error("parse error");return{profile:i,length:r,datas:s}}decompress(e){return hU(new Uint8Array(e))}compress(e){return uU(new Uint8Array(e))}}class HF extends vR{constructor(e,t){super(),nx(this,"_version",1),nx(this,"_type",3),nx(this,"_config",void 0),nx(this,"_originDataChannel",void 0),nx(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),nx(this,"_dataStreamPacketHandler",void 0),nx(this,"_datachannelEventMap",new Map),this._config=e,t&&(this._originDataChannel=t,this._bandDataChannelEvents(t)),this._initPacketHeader(),this._dataStreamPacketHandler=new WF}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return Dw("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,t;return null!==(e=null===(t=this._originDataChannel)||void 0===t?void 0:t.readyState)&&void 0!==e?e:"connecting"}get _originDataChannelId(){var e,t;return null!==(e=null===(t=this._originDataChannel)||void 0===t?void 0:t.id)&&void 0!==e?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Gh(((e,t)=>{if(this._originDataChannel){"open"===this._originDataChannel.readyState&&e();const n=setTimeout((()=>{var e;t(new nR(tR.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat(null===(e=this._originDataChannel)||void 0===e?void 0:e.id)))}),1e4);this._originDataChannel.onopen=()=>{clearTimeout(n),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(n),new nR(tR.DATACHANNEL_CONNECTION_TIMEOUT)}}else t(new nR(tR.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))}))}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[$U.OPEN,$U.CLOSE,$U.ERROR].forEach((t=>{const n=()=>{this.emit(t)};this._datachannelEventMap.set(t,n),e.addEventListener(t,n)}))}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach((t=>{let[n,i]=t;e.removeEventListener(n,i)})),this._datachannelEventMap.clear()}}class KF extends HF{constructor(e){super(e),nx(this,"_messageListener",void 0),this._messageListener=e=>{if(e.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const t=e.data.slice(0,this._dataStreamPacketHeader.byteLength),n=new DataView(t).getUint8(3);if(n!==this.id)return void(Dw("SHOW_DATASTREAM2_LOG")&&Qw.debug("invalid datachannel id: ".concat(n," !== ").concat(this.id)));let i=e.data.slice(this._dataStreamPacketHeader.byteLength);i=this._dataStreamPacketHandler.deserialize(i),this.emit($U.MESSAGE,i)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class zF extends HF{send(e){if(this._originDataChannel){let t=e;t=this._dataStreamPacketHandler.serialize(e);const n=new Uint8Array(this._dataStreamPacketHeader.byteLength+t.byteLength);n.set(new Uint8Array(this._dataStreamPacketHeader),0),n.set(new Uint8Array(t),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(n.buffer)}}}function qF(){const e=new Blob([atob("ZnVuY3Rpb24gZShlKXtjb25zdCB0PW5ldyBEYXRhVmlldyhlLmRhdGEpO2lmKDA9PT10LmdldFVpbnQ4KDApJiYwPT09dC5nZXRVaW50OCgxKSYmMD09PXQuZ2V0VWludDgoMikmJjE9PT10LmdldFVpbnQ4KDMpJiY2PT09dC5nZXRVaW50OCg0KSl7bGV0IG49NixyPTAsbz0wO2Zvcig7MjU1PT09KG89dC5nZXRVaW50OChuKyspKTspcis9MjU1O3IrPW87Y29uc3QgYT1mdW5jdGlvbihlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLG89W10sYT0wO2Zvcig7YTxuOylhKzM8biYmMD09PXJbYV0mJjA9PT1yW2ErMV0mJjM9PT1yW2ErMl0mJigwPT09clthKzNdfHwxPT09clthKzNdfHwyPT09clthKzNdfHwzPT09clthKzNdKT8oby5wdXNoKHJbYV0sclthKzFdLHJbYSszXSksYSs9NCk6KG8ucHVzaChyW2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShvKX0oZS5kYXRhLG4scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGEpfXJldHVybiBudWxsfWZ1bmN0aW9uIHQoZSx0KXtjb25zdCBuPWZ1bmN0aW9uKGUpe2NvbnN0IHQ9ZS5sZW5ndGg7bGV0IG49W10scj0wO2Zvcig7cjx0OylyKzI8dCYmMD09PWVbcl0mJjA9PT1lW3IrMV0mJigwPT09ZVtyKzJdfHwxPT09ZVtyKzJdfHwyPT09ZVtyKzJdfHwzPT09ZVtyKzJdKT8obi5wdXNoKGVbcl0sZVtyKzFdLDMsZVtyKzJdKSxyKz0zKToobi5wdXNoKGVbcl0pLHIrKyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KG4pfSh0KSxyPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihyLzI1NSksYT1yJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK3IrZS5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBpPTA7Zm9yKDtpPG87KXNbNitpXT0yNTUsaSsrO3JldHVybiBzWzYraV09YSxpKysscy5zZXQobiw2K2kpLHMuc2V0KG5ldyBVaW50OEFycmF5KGUpLDYraStyKSxzLmJ1ZmZlcn1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIlNhZmFyaSIpPi0xJiYtMT09PW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikmJihzZWxmLm9ucnRjdHJhbnNmb3JtPW49Pntjb25zdCByPW4udHJhbnNmb3JtZXI7bGV0IG89W107ci5vcHRpb25zLnBvcnQub25tZXNzYWdlPWU9PntlLmRhdGEuc2VpJiZvLnB1c2goZS5kYXRhLnNlaSl9LHNlbGYucG9zdE1lc3NhZ2UoInN0YXJ0ZWQiKTtjb25zdCBhPXIucmVhZGFibGUuZ2V0UmVhZGVyKCkscz1yLndyaXRhYmxlLmdldFdyaXRlcigpOyJyeCI9PT1yLm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2EucmVhZCgpLnRoZW4oKHI9PntpZighci5kb25lKXtpZihyLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7YS5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1vLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout((()=>MP.revokeObjectURL(e)),0),new Worker(MP.createObjectURL(e))}const YF=new Map,JF=new Map,XF=new Map;async function QF(e,t){if(!fU().supportWebRTCEncodedTransform)return void Qw.warning("browser not support video encoded transform");if(XF.has(e))return;if(!e.track)return;const n={track:e.track};if(OC()){if(!e.createEncodedStreams)return void Qw.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(e){return void Qw.error("create video-encoded-streams error",e&&e.message)}let o=[];t.on("sei-to-send",(e=>{o.push(e)}));const s=new TransformStream({transform(t,r){n.controller||(n.controller=r),e.track&&e.track.id!==n.track.id&&(Qw.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const s=o.shift();s&&(t.data=function(e,t){const n=function(e){const t=e.length;let n=[],i=0;for(;i<t;)i+2<t&&0===e[i]&&0===e[i+1]&&(0===e[i+2]||1===e[i+2]||2===e[i+2]||3===e[i+2])?(n.push(e[i],e[i+1],3,e[i+2]),i+=3):(n.push(e[i]),i++);return new Uint8Array(n)}(t),i=n.length,r=Math.floor(i/255),o=i%255,s=new Uint8Array(6+r+1+i+e.byteLength);s[0]=0,s[1]=0,s[2]=0,s[3]=1,s[4]=6,s[5]=101;let a=0;for(;a<r;)s[6+a]=255,a++;return s[6+a]=o,a++,s.set(n,6+a),s.set(new Uint8Array(e),6+a+i),s.buffer}(t.data,s)),r.enqueue(t)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else{if(!NC())return;{if("undefined"==typeof RTCRtpScriptTransform)return void Qw.warning("browser not support RTCRtpScriptTransform");const r=qF(),o=new MessageChannel;await new Gh((e=>r.onmessage=t=>{"registered"===t.data&&e(void 0)}));const s=new RTCRtpScriptTransform(r,{name:"tx",port:o.port2},[o.port2]);e.transform=s,await new Gh((e=>r.onmessage=t=>{"started"===t.data&&e(void 0)})),t.on("sei-to-send",(e=>{o.port1.postMessage({sei:e})})),o.port1.onmessage=t=>{var r;t.data.transformed&&e.track&&(null===(r=e.track)||void 0===r?void 0:r.id)!==n.track.id&&(Qw.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i))},n.worker=r}}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}const t=XF.get(e);if(t){XF.delete(e);try{var n,r;null===(n=t.controller)||void 0===n||n.terminate(),null===(r=t.worker)||void 0===r||r.terminate()}catch(e){Qw.warning(e&&e.message)}}}XF.set(e,n),e.track.addEventListener("ended",i)}const ZF=new Map;async function $F(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!fU().supportWebRTCEncodedTransform)return void Qw.warning("browser not support video encoded transform");if(!e.track)return;if(ZF.has(e)){const n=ZF.get(e);return void(n&&(n.onSei=t.onSei))}const n={track:e.track,onSei:t.onSei};if(OC()){if(!e.createEncodedStreams)return void Qw.warning("browser not support createEncodedStreams() API");let t=null;try{t=e.createEncodedStreams()}catch(e){return void Qw.error("create video-encoded-streams error",e&&e.message)}const r=new TransformStream({transform(t,r){n.controller||(n.controller=r),e.track&&e.track.id!==n.track.id&&(Qw.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const o=function(e){const t=new DataView(e.data);if(0===t.getUint8(0)&&0===t.getUint8(1)&&0===t.getUint8(2)&&1===t.getUint8(3)&&6===t.getUint8(4)){let n=6,i=0,r=0;for(;255===(r=t.getUint8(n++));)i+=255;i+=r;const o=function(e,t,n){let i=new Uint8Array(e,t,n),r=[],o=0;for(;o<n;)o+3<n&&0===i[o]&&0===i[o+1]&&3===i[o+2]&&(0===i[o+3]||1===i[o+3]||2===i[o+3]||3===i[o+3])?(r.push(i[o],i[o+1],i[o+3]),o+=4):(r.push(i[o]),o++);return new Uint8Array(r)}(e.data,n,i);return new Uint8Array(o)}return null}(t);o&&n.onSei&&n.onSei(o),r.enqueue(t)}});t.readable.pipeThrough(r).pipeTo(t.writable)}else if(NC()){if("undefined"==typeof RTCRtpScriptTransform)return void Qw.warning("browser not support RTCRtpScriptTransform");const t=qF(),r=new MessageChannel;await new Gh((e=>t.onmessage=t=>{"registered"===t.data&&e(void 0)}));const o=new RTCRtpScriptTransform(t,{name:"rx",port:r.port2},[r.port2]);e.transform=o,await new Gh((e=>t.onmessage=t=>{"started"===t.data&&e(void 0)})),r.port1.onmessage=t=>{var r;t.data.transformed&&e.track&&(null===(r=e.track)||void 0===r?void 0:r.id)!==n.track.id?(Qw.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i)):t.data.sei&&n.onSei&&n.onSei(t.data.sei)},n.worker=t}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}!function(e){const t=ZF.get(e);if(t){ZF.delete(e);try{var n,i;null===(n=t.controller)||void 0===n||n.terminate(),null===(i=t.worker)||void 0===i||i.terminate()}catch(e){Qw.warning(e&&e.message)}}}(e)}ZF.set(e,n),e.track.addEventListener("ended",i)}!function(){const e=RC();pU.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),pU.getStreamFromExtension=e.name===TC.CHROME&&Number(e.version)>34,pU.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver)return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let t=!1;try{e.addTransceiver("audio"),t=!0}catch(e){}return e.close(),t}(),pU.supportMinBitrate=e.name===TC.CHROME||e.name===TC.EDGE,pU.supportSetRtpSenderParameters=function(){const e=RC();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!JC()||!(!NC()&&!AC())||e.name===TC.FIREFOX&&Number(e.version)>=64)}(),e.name===TC.SAFARI&&(Number(e.version)>=14?pU.supportDualStream=!0:pU.supportDualStream=!1),pU.webAudioMediaStreamDest=function(){const e=RC();return!(e.name===TC.SAFARI&&Number(e.version)<12)}(),pU.supportReplaceTrack=!!window.RTCRtpSender&&"function"==typeof RTCRtpSender.prototype.replaceTrack,pU.supportWebGL="undefined"!=typeof WebGLRenderingContext,pU.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,JC()||(pU.webAudioWithAEC=!0),pU.supportShareAudio=function(){const e=RC();return(e.os===vC.WIN_10||e.os===vC.WIN_81||e.os===vC.WIN_7||e.os===vC.LINUX||e.os===vC.MAC_OS||e.os===vC.CHROMIUM_OS)&&e.name===TC.CHROME&&Number(e.version)>=74}(),pU.supportDataChannel=!!(LC(76)||function(e){const t=RC();return!(t.name!==TC.FIREFOX||!t.osVersion)&&Number(t.version)>=e}(68)||UC(14)),pU.supportPCSetConfiguration=function(){const e=window.RTCPeerConnection;return!PC()&&!!e&&e.prototype.setConfiguration instanceof Function}(),pU.supportWebRTCEncodedTransform=function(){const e=RC();return"Chrome"===e.name&&Number(e.version)>=86||"Safari"===e.name&&Number(e.version)>=15}(),pU.supportWebRTCInsertableStream=function(){const e=RC();return(e.name===TC.CHROME||e.name===TC.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),pU.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,pU.supportWebCrypto="undefined"!=typeof window&&void 0!==window.crypto&&void 0!==window.crypto.subtle,BR((()=>{pU.supportDualStreamEncoding=function(){const e=RC();return!!Dw("DISABLE_WEBAUDIO")||"Safari"===e.name&&Number(e.version)>=14||!!("Chrome"===e.name&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&Dw("CHROME_DUAL_STREAM_USE_ENCODING"))}(),Qw.info("browser compatibility",JSON.stringify(pU),JSON.stringify(e))}))}();class ej extends vR{constructor(){super(...arguments),iT(this,"resultStorage",new Map)}setLocalAudioStats(e,t,n){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(n,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(n,t))}setLocalVideoStats(e,t,n){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(n,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(n,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(n))}setRemoteAudioStats(e,t){const n=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",n,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const n=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",n,this.checkVideoDecode(t))}record(e,t,n){if(Dw("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const i=this.resultStorage.get(e);if(i&&(i.result.push(n),i.result.length>=5)){var r;const n=Pi(r=i.result).call(r,!0);i.isPrevNormal&&!n&&this.emit("exception",tj[e],e,t),!i.isPrevNormal&&n&&this.emit("exception",tj[e]+2e3,e+"_RECOVER",t),i.isPrevNormal=n,i.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof UV&&!t.isActive||!!t.muted||0!==e.sendVolumeLevel}checkFramerateInput(e,t){let n=null;t._encoderConfig&&t._encoderConfig.frameRate&&(n=zA(t._encoderConfig.frameRate));const i=e.captureFrameRate;return!n||!i||!(n>10&&i<5||n<10&&n>=5&&i<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof UV&&!t.isActive||!!t.muted||0!==e.sendBitrate}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const tj={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},nj=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(n.length>0){const e=n[n.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(n.length>0){const e=n[n.length-1];return Math.round(performance.now()-e.startTime)}return 0}};function ij(e,t){this.v=e,this.k=t}function rj(e){return new ij(e,0)}var oj=Bh,sj=vd;Nn({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var e=sj.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var aj=vd,cj=ed;Nn({target:"Promise",stat:!0,forced:!0},{try:function(e){var t=aj.f(this),n=cj(e);return(n.error?t.reject:t.resolve)(n.value),t.promise}});var lj=i(oj),dj=nE.f("asyncIterator"),uj=i(dj);function hj(e){var t,n;function i(t,n){try{var o=e[t](n),s=o.value,a=s instanceof ij;lj.resolve(a?s.v:s).then((function(n){if(a){var c="return"===t?"return":"next";if(!s.k||n.done)return i(c,n);n=e[c](n).value}r(o.done?"return":"normal",n)}),(function(e){i("throw",e)}))}catch(e){r("throw",e)}}function r(e,r){switch(e){case"return":t.resolve({value:r,done:!0});break;case"throw":t.reject(r);break;default:t.resolve({value:r,done:!1})}(t=t.next)?i(t.key,t.arg):n=null}this._invoke=function(e,r){return new lj((function(o,s){var a={key:e,arg:r,resolve:o,reject:s,next:null};n?n=n.next=a:(t=n=a,i(e,r))}))},"function"!=typeof e.return&&(this.return=void 0)}function pj(e){return function(){return new hj(e.apply(this,arguments))}}hj.prototype["function"==typeof Zv&&uj||"@@asyncIterator"]=function(){return this},hj.prototype.next=function(e){return this._invoke("next",e)},hj.prototype.throw=function(e){return this._invoke("throw",e)},hj.prototype.return=function(e){return this._invoke("return",e)};var fj=i(ie.Object.getOwnPropertySymbols),mj=Nn,_j=Jn.indexOf,Ej=Bi,gj=w([].indexOf),vj=!!gj&&1/gj([1],1,-0)<0;mj({target:"Array",proto:!0,forced:vj||!Ej("indexOf")},{indexOf:function(e){var t=arguments.length>1?arguments[1]:void 0;return vj?gj(this,e,t)||0:_j(this,e,t)}});var Tj=Zn("Array").indexOf,Sj=u,yj=Tj,Cj=Array.prototype,Rj=function(e){var t=e.indexOf;return e===Cj||Sj(Cj,e)&&t===Cj.indexOf?yj:t},wj=i(Rj);function Ij(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},o=RI(e);for(i=0;i<o.length;i++)n=o[i],wj(t).call(t,n)>=0||(r[n]=e[n]);return r}(e,t);if(fj){var o=fj(e);for(i=0;i<o.length;i++)n=o[i],wj(t).call(t,n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var bj={exports:{}};!function(e,t){e.exports=(()=>{var e={8:(e,t,n)=>{n.r(t),n.d(t,{Parser:()=>y,Printer:()=>b,parse:()=>D,print:()=>P});const i="\n",r="".concat("\r").concat(i),o=" ";let s;function a(e){return e>="0"&&e<="9"}function c(e){return e>="!"&&e<="~"}function l(e){return c(e)||e>="\x80"&&e<="\xff"}function d(e){return"!"===e||e>="#"&&e<="'"||e>="*"&&e<="+"||e>="-"&&e<="."||e>="0"&&e<="9"||e>="A"&&e<="Z"||e>="^"&&e<="~"}function u(e){return e>="1"&&e<="9"}function h(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"}function p(e){return"d"===e||"h"===e||"m"===e||"s"===e}function f(e){return e>"\x01"&&e<"\t"||e>"\v"&&e<"\f"||e>"\x0e"&&e<"\xff"}function m(e){return h(e)||a(e)||"+"===e||"/"===e}function _(e){return a(e)||h(e)||"+"===e||"/"===e||"-"===e||"_"===e}function E(e){return h(e)||a(e)||"+"===e||"/"===e}function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function v(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){T(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.VERSION="v",e.ORIGIN="o",e.SESSION_NAME="s",e.INFORMATION="i",e.URI="u",e.EMAIL="e",e.PHONE="p",e.CONNECTION="c",e.BANDWIDTH="b",e.TIME="t",e.REPEAT="r",e.ZONE_ADJUSTMENTS="z",e.KEY="k",e.ATTRIBUTE="a",e.MEDIA="m"}(s||(s={}));class S{consumeText(e,t){let n=t;for(;n<e.length;){const t=e[n];if("\0"===t||"\r"===t||t===i)break;n+=1}if(n-t==0)throw new Error("Invalid text, at ".concat(e));return n}consumeUnicastAddress(e,t,n){return this.consumeTill(e,t,o)}consumeOneOrMore(e,t,n){let i=t;for(;n(e[i]);)i++;if(i-t==0)throw new Error("Invalid rule at ".concat(t,"."));return i}consumeSpace(e,t){if(e[t]===o)return t+1;throw new Error("Invalid space at ".concat(t,"."))}consumeIP4Address(e,t){let n=t;for(let i=0;i<4;i++)if(n=this.consumeDecimalUChar(e,n),3!==i){if("."!==e[n])throw new Error("Invalid IP4 address.");n++}return n}consumeDecimalUChar(e,t){let n=t;for(let r=0;r<3&&a(e[n]);r++,n++);if(n-t==0)throw new Error("Invalid decimal uchar.");const i=parseInt(e.slice(t,n));if(i>=0&&i<=255)return n;throw new Error("Invalid decimal uchar")}consumeIP6Address(e,t){let n=this.consumeHexpart(e,t);return":"===e[n]?(n+=1,n=this.consumeIP4Address(e,n),n):n}consumeHexpart(e,t){let n=t;if(":"===e[n]&&":"===e[n+1]){n+=2;try{n=this.consumeHexseq(e,n)}catch(e){}return n}if(n=this.consumeHexseq(e,n),":"===e[n]&&":"===e[n+1]){n+=2;try{n=this.consumeHexseq(e,n)}catch(e){}return n}return n}consumeHexseq(e,t){let n=t;for(;n=this.consumeHex4(e,n),":"===e[n]&&":"!==e[n+1];)n+=1;return n}consumeHex4(e,t){let n=0;for(;n<4;n++)if(!((i=e[t+n])>="0"&&i<="9"||i>="a"&&i<="f"||i>="A"&&i<="F")){if(0===n)throw new Error("Invalid hex 4");break}var i;return t+n}consumeFQDN(e,t){let n=t;for(;a(e[n])||h(e[n])||"-"===e[n]||"."===e[n];)n+=1;if(n-t<4)throw new Error("Invalid FQDN");return n}consumeExtnAddr(e,t){return this.consumeOneOrMore(e,t,l)}consumeMulticastAddress(e,t,n){switch(n){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(e,t);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(e,t);default:try{return this.consumeFQDN(e,t)}catch(n){return this.consumeExtnAddr(e,t)}}}consumeIP6MulticastAddress(e,t){const n=this.consumeHexpart(e,t);return"/"===e[n]?this.consumeInteger(e,n+1):n}consumeIP4MulticastAddress(e,t){let n=t+3;const i=e.slice(t,n),r=parseInt(i);if(r<224||r>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let o=0;o<3;o++){if("."!==e[n])throw new Error("Invalid IP4 multicast address.");n+=1,n=this.consumeDecimalUChar(e,n)}return"/"===e[n]&&(n+=1),n=this.consumeTTL(e,n),"/"===e[n]&&(n=this.consumeInteger(e,n)),n}consumeInteger(e,t){if(!u(e[t]))throw new Error("Invalid integer.");for(t+=1;a(e[t]);)t+=1;return t}consumeTTL(e,t){if("0"===e[t])return t+1;if(!u(e[t]))throw new Error("Invalid TTL.");t+=1;for(let n=0;n<2&&a(e[t]);n++)t+=1;return t}consumeToken(e,t){return this.consumeOneOrMore(e,t,d)}consumeTime(e,t){let n=t;if("0"===e[n])return n+1;for(u(e[n])&&(n+=1);a(e[n]);)n++;if(n-t<10)throw new Error("Invalid time");return n}consumeAddress(e,t){return this.consumeTill(e,t,o)}consumeTypedTime(e,t){let n=t;return n=this.consumeOneOrMore(e,n,a),p(e[n])?n+1:n}consumeRepeatInterval(e,t){if(!u(e[t]))throw new Error("Invalid repeat interval");for(t+=1;a(e[t]);)t+=1;return p(e[t])&&(t+=1),t}consumePort(e,t){return this.consumeOneOrMore(e,t,a)}consume(e,t,n){for(let i=0;i<n.length;i++){if(t+i>=e.length)throw new Error("consume exceeding value length");if(e[t+i]!==n[i])throw new Error("consume ".concat(n," failed at ").concat(i))}return t+n.length}consumeTill(e,t,n){let i=t;for(;i<e.length&&("string"!=typeof n||e[i]!==n)&&("function"!=typeof n||!n(e[i]));)i++;return i}}class y extends S{constructor(){super(),T(this,"records",[]),T(this,"currentLine",0)}parse(e){const t=this.probeEOL(e);this.records=e.split(t).filter((e=>!!Bp(e).call(e))).map(this.parseLine),this.currentLine=0;const n=this.parseVersion(),i=this.parseOrigin(),r=this.parseSessionName(),o=this.parseInformation(),s=this.parseUri(),a=this.parseEmail(),c=this.parsePhone(),l=this.parseConnection(),d=this.parseBandWidth(),u=this.parseTimeFields(),h=this.parseKey(),p=this.parseSessionAttribute(),f=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:n,origin:i,sessionName:r,information:o,uri:s,emails:a,phones:c,connection:l,bandwidths:d,timeFields:u,key:h,attributes:p,mediaDescriptions:f}}getCurrentRecord(){const e=this.records[this.currentLine];if(!e)throw new Error("Record doesn't exit.");return e}probeEOL(e){for(let t=0;t<e.length;t++)if(e[t]===i)return"\r"===e[t-1]?r:i;throw new Error("Invalid newline character.")}parseLine(e,t){if(e.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const n=e[0];if("="!==e[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:n,value:e.slice(2),line:t,cur:0}}parseSessionAttribute(){const e=new R;for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==s.ATTRIBUTE)break;const n={attField:this.extractOneOrMore(t,(e=>d(e)&&":"!==e)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,n.attValue=this.extractOneOrMore(t,f)),e.parse(n),this.currentLine++}return e.digest()}parseMediaAttributes(e){const t=new w(e);for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==s.ATTRIBUTE)break;const n={attField:this.extractOneOrMore(e,(e=>d(e)&&":"!==e)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,n.attValue=this.extractOneOrMore(e,f)),t.parse(n),this.currentLine++}return t.digest()}parseKey(){const e=this.getCurrentRecord();if(e.type===s.KEY){if("prompt"===e.value||"clear:"===e.value||"base64:"===e.value||"uri:"===e.value)return e.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const e=this.getCurrentRecord();if(e.type===s.ZONE_ADJUSTMENTS){const t=[];for(;;)try{const n=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);let i=!1;"-"===e.value[e.cur]&&(i=!0,e.cur+=1);const r=this.extract(e,this.consumeTypedTime);t.push({time:n,typedTime:r,back:i})}catch(e){break}if(0===t.length)throw new Error("Invalid zone adjustments");return this.currentLine++,t}return[]}parseRepeat(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==s.REPEAT)break;{const n=this.extract(t,this.consumeRepeatInterval),i=this.parseTypedTime(t);e.push({repeatInterval:n,typedTimes:i}),this.currentLine++}}return e}parseTypedTime(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeTypedTime))}catch(e){break}if(0===t.length)throw new Error("Invalid typed time.");return t}parseTime(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);const n=this.extract(e,this.consumeTime);return this.currentLine++,{startTime:t,stopTime:n}}parseBandWidth(){const e=[];for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==s.BANDWIDTH)break;{const n=this.extractOneOrMore(t,d);if(":"!==t.value[t.cur])throw new Error("Invalid bandwidth field.");t.cur++;const i=this.extractOneOrMore(t,a);e.push({bwtype:n,bandwidth:i}),this.currentLine++}}return e}parseVersion(){const e=this.getCurrentRecord();if(e.type!==s.VERSION)throw new Error("first sdp record must be version");const t=e.value.slice(0,this.consumeOneOrMore(e.value,0,a));if(t.length!==e.value.length)throw new Error('invalid proto version, "v='.concat(e.value,'"'));return this.currentLine++,t}parseOrigin(){const e=this.getCurrentRecord();if(e.type!==s.ORIGIN)throw new Error("second line of sdp must be origin");const t=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const r=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const o=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const c=this.extract(e,this.consumeUnicastAddress);return this.currentLine++,{username:t,sessId:n,sessVersion:i,nettype:r,addrtype:o,unicastAddress:c}}parseSessionName(){const e=this.getCurrentRecord();if(e.type===s.SESSION_NAME){const t=this.extract(e,this.consumeText);return this.currentLine++,t}}parseInformation(){const e=this.getCurrentRecord();if(e.type!==s.INFORMATION)return;const t=this.extract(e,this.consumeText);return this.currentLine++,t}parseUri(){const e=this.getCurrentRecord();if(e.type===s.URI)return this.currentLine++,e.value}parseEmail(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==s.EMAIL)break;e.push(t.value),this.currentLine++}return e}parsePhone(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==s.PHONE)break;e.push(t.value),this.currentLine++}return e}parseConnection(){const e=this.getCurrentRecord();if(e.type===s.CONNECTION){const t=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const i=this.extract(e,this.consumeAddress);return this.currentLine++,{nettype:t,addrtype:n,address:i}}}parseMedia(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeToken);this.consumeSpaceForRecord(e);let n=this.extract(e,this.consumePort);"/"===e.value[e.cur]&&(e.cur+=1,n+=this.extract(e,this.consumeInteger)),this.consumeSpaceForRecord(e);const i=[];for(i.push(this.extract(e,this.consumeToken));"/"===e.value[e.cur];)e.cur+=1,i.push(this.extract(e,this.consumeToken));if(0===i.length)throw new Error("Invalid proto");const r=this.parseFmt(e);return this.currentLine++,{mediaType:t,port:n,protos:i,fmts:r}}parseTimeFields(){const e=[];for(;this.getCurrentRecord().type===s.TIME;){const t=this.parseTime(),n=this.parseRepeat(),i=this.parseZone();e.push({time:t,repeats:n,zones:i})}return e}parseMediaDescription(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===s.MEDIA;){const t=this.parseMedia(),n=this.parseInformation(),i=this.parseConnections(),r=this.parseBandWidth(),o=this.parseKey(),s=this.parseMediaAttributes(t);e.push({media:t,information:n,connections:i,bandwidths:r,key:o,attributes:s})}return e}parseConnections(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===s.CONNECTION;)e.push(this.parseConnection());return e}parseFmt(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeToken))}catch(e){break}if(0===t.length)throw new Error("Invalid fmts");return t}extract(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];const o=t.call(this,e.value,e.cur,...i),s=e.value.slice(e.cur,o);return e.cur=o,s}extractOneOrMore(e,t){const n=this.consumeOneOrMore(e.value,e.cur,t),i=e.value.slice(e.cur,n);return e.cur=n,i}consumeSpaceForRecord(e){if(e.value[e.cur]!==o)throw new Error("Invalid space at ".concat(e.cur,"."));e.cur+=1}}class C extends S{constructor(){super(...arguments),T(this,"attributes",void 0),T(this,"digested",!1)}extractOneOrMore(e,t,n){const i=this.consumeOneOrMore(e.attValue,e._cur,t),r=e.attValue.slice(e._cur,i),[o,s]=n||[];if("number"==typeof o&&r.length<o)throw new Error("error in length, should be more or equal than ".concat(o," characters."));if("number"==typeof s&&r.length>s)throw new Error("error in length, should be less or equal than ".concat(s," characters."));return e._cur=i,r}consumeAttributeSpace(e){if(e.attValue[e._cur]!==o)throw new Error("Invalid space at ".concat(e._cur,"."));e._cur+=1}extract(e,t){if(!e.attValue)throw new Error("Nothing to extract from attValue.");for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];const o=t.call(this,e.attValue,e._cur,...i),s=e.attValue.slice(e._cur,o);return e._cur=o,s}atEnd(e){if(!e.attValue)throw new Error;return e._cur>=e.attValue.length}peekChar(e){if(!e.attValue)throw new Error;return e.attValue[e._cur]}peek(e,t){if(!e.attValue)throw new Error;for(let n=0;n<t.length;n++)if(t[n]!==e.attValue[e._cur+n])return!1;return!0}parseIceUfrag(e){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(e,m,[4,256])}parseIcePwd(e){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(e,m,[22,256])}parseIceOptions(e){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const t=[];for(;!this.atEnd(e);){t.push(this.extractOneOrMore(e,m));try{this.consumeAttributeSpace(e)}catch(t){if(this.atEnd(e))break;throw t}}this.attributes.iceOptions=t}parseFingerprint(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill);this.attributes.fingerprints.push({hashFunction:t,fingerprint:n})}parseExtmap(e){const t=this.extractOneOrMore(e,a);let n;"/"===this.peekChar(e)&&(this.extract(e,this.consume,"/"),n=this.extract(e,this.consumeToken)),this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,o),r=v(v({entry:parseInt(t,10)},n&&{direction:n}),{},{extensionName:i});this.peekChar(e)===o&&(this.consumeAttributeSpace(e),r.extensionAttributes=this.extract(e,this.consumeTill)),this.attributes.extmaps.push(r)}parseSetup(e){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const t=this.extract(e,this.consumeTill);if("active"!==t&&"passive"!==t&&"actpass"!==t&&"holdconn"!==t)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=t}}class R extends C{constructor(){super(...arguments),T(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"group":this.parseGroup(e);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"fingerprint":this.parseFingerprint(e);break;case"setup":this.parseSetup(e);break;case"tls-id":this.parseTlsId(e);break;case"identity":this.parseIdentity(e);break;case"extmap":this.parseExtmap(e);break;case"msid-semantic":this.parseMsidSemantic(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing session attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(e){const t=this.extract(e,this.consumeToken),n=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;)this.consumeAttributeSpace(e),n.push(this.extract(e,this.consumeToken));this.attributes.groups.push({semantic:t,identificationTag:n})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(e){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(e,_)}parseIdentity(e){const t=this.extractOneOrMore(e,E),n=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.extract(e,this.consume,"=");const i=this.extractOneOrMore(e,(e=>e!==o&&f(e)));n.push({name:t,value:i})}this.attributes.identities.push({assertionValue:t,extensions:n})}parseMsidSemantic(e){this.peekChar(e)===o&&this.consumeAttributeSpace(e);const t={semantic:this.extract(e,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(e)}catch(e){break}if("*"===this.peekChar(e)){this.extract(e,this.consume,"*"),t.applyForAll=!0;break}{const n=this.extract(e,this.consumeTill,o);t.identifierList.push(n)}}this.attributes.msidSemantic=t}}class w extends C{constructor(e){super(),T(this,"attributes",void 0),-1!==e.protos.indexOf("RTP")||e.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"extmap":this.parseExtmap(e);break;case"setup":this.parseSetup(e);break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"candidate":this.parseCandidate(e);break;case"remote-candidate":this.parseRemoteCandidate(e);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(e);break;case"rtpmap":this.parseRtpmap(e);break;case"ptime":this.parsePtime(e);break;case"maxptime":this.parseMaxPtime(e);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(e);break;case"ssrc":this.parseSSRC(e);break;case"fmtp":this.parseFmtp(e);break;case"rtcp-fb":this.parseRtcpFb(e);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(e);break;case"mid":this.parseMid(e);break;case"msid":this.parseMsid(e);break;case"imageattr":this.parseImageAttr(e);break;case"rid":this.parseRid(e);break;case"simulcast":this.parseSimulcast(e);break;case"sctp-port":this.parseSctpPort(e);break;case"max-message-size":this.parseMaxMessageSize(e);break;case"ssrc-group":this.parseSSRCGroup(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing media attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}parseCandidate(e){const t=this.extractOneOrMore(e,m,[1,32]);this.consumeAttributeSpace(e);const n=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const r=this.extractOneOrMore(e,a,[1,10]);this.consumeAttributeSpace(e);const s=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const l=this.extract(e,this.consumePort);this.consumeAttributeSpace(e),this.extract(e,this.consume,"typ"),this.consumeAttributeSpace(e);const d={foundation:t,componentId:n,transport:i,priority:r,connectionAddress:s,port:l,type:this.extract(e,this.consumeToken),extension:{}};for(this.peek(e," raddr")&&(this.extract(e,this.consume," raddr"),this.consumeAttributeSpace(e),d.relAddr=this.extract(e,this.consumeAddress)),this.peek(e," rport")&&(this.extract(e,this.consume," rport"),this.consumeAttributeSpace(e),d.relPort=this.extract(e,this.consumePort));this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e),d.extension[t]=this.extractOneOrMore(e,c)}this.attributes.candidates.push(d)}parseRemoteCandidate(e){const t=[];for(;;){const n=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const r=this.extract(e,this.consumePort);t.push({componentId:n,connectionAddress:i,port:r});try{this.consumeAttributeSpace(e)}catch(e){break}}this.attributes.remoteCandidatesList.push(t)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,"/");this.extract(e,this.consume,"/");const i={encodingName:n,clockRate:this.extractOneOrMore(e,a)};this.atEnd(e)||"/"!==this.peekChar(e)||(this.extract(e,this.consume,"/"),i.encodingParameters=parseInt(this.extract(e,this.consumeTill),10));const r=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));r?r.rtpMap=i:this.attributes.payloads.push({payloadType:parseInt(t,10),rtpMap:i,rtcpFeedbacks:[]})}parsePtime(e){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(e,this.consumeTill)}parseMaxPtime(e){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(e,this.consumeTill)}parseDirection(e){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=e.attField}parseSSRC(e){const t=this.extractOneOrMore(e,a);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,":");let i;":"===this.peekChar(e)&&(this.extract(e,this.consume,":"),i=this.extract(e,this.consumeTill));const r=this.attributes.ssrcs.find((e=>e.ssrcId===parseInt(t,10)));r?r.attributes[n]=i:this.attributes.ssrcs.push({ssrcId:parseInt(t,10),attributes:{[n]:i}})}parseFmtp(e){const t=this.extract(e,this.consumeTill,o);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill),i={};n.split(";").forEach((e=>{let[t,n]=e.split("=");t=Bp(t).call(t);const r="string"==typeof n?Bp(n).call(n):null;"string"==typeof t&&t.length>0&&(i[t]=r)}));const r=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));r?r.fmtp={parameters:i}:this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[],fmtp:{parameters:i}})}parseFmtParameters(e){const t={},n=this.extract(e,this.consumeTill,"=");e._cur++;const i=this.extract(e,this.consumeTill,";");for(t[n]=i;";"===e.attValue[e._cur];){const n=this.extract(e,this.consumeTill,"=");e._cur++;const i=this.extract(e,this.consumeTill,";");t[n]=i}return t}parseRtcpFb(e){let t="";t="*"===this.peekChar(e)?this.extract(e,this.consume,"*"):this.extract(e,this.consumeTill,o),this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,o);let i;if("trr-int"===n)i={type:n,interval:this.extract(e,this.consumeTill)};else{const t={type:n};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.parameter=this.extract(e,this.consumeToken),this.peekChar(e)===o&&(t.additional=this.extract(e,this.consumeTill))),i=t}if("*"===t)this.attributes.rtcpFeedbackWildcards.push(i);else{const e=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));e?e.rtcpFeedbacks.push(i):this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[i]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(e){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const t={port:this.extract(e,this.consumePort)};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.netType=this.extractOneOrMore(e,d),this.consumeAttributeSpace(e),t.addressType=this.extractOneOrMore(e,d),this.consumeAttributeSpace(e),t.address=this.extract(e,this.consumeAddress)),this.attributes.rtcp=t}parseMsid(e){const t={id:this.extractOneOrMore(e,d,[1,64])};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.appdata=this.extractOneOrMore(e,d,[1,64])),this.attributes.msids.push(t)}parseImageAttr(e){this.attributes.imageattr.push(e.attValue)}parseRid(e){const t=this.extractOneOrMore(e,(e=>h(e)||a(e)||"_"===e||"-"===e));this.consumeAttributeSpace(e);const n={id:t,direction:this.extract(e,this.consumeToken),params:[]};if(this.peekChar(e)===o){if(this.consumeAttributeSpace(e),this.peek(e,"pt=")){this.extract(e,this.consume,"pt=");const t=[];for(;;){const n=this.extract(e,this.consumeToken);t.push(n);try{this.extract(e,this.consume,",")}catch(e){break}}n.payloads=t,this.peekChar(e)===o&&this.extract(e,this.consume,o)}for(;;){const t=this.extract(e,this.consumeToken);switch(t){case"depend":{const i={type:t,rids:this.extract(e,this.consume,"=").split(",")};n.params.push(i);break}default:{const i={type:t};"="===this.peekChar(e)&&(this.extract(e,this.consume,"="),i.val=this.extract(e,this.consumeTill,";")),n.params.push(i)}}try{this.extract(e,this.consume,";")}catch(e){break}}}this.attributes.rids.push(n)}parseSimulcast(e){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=e.attValue,this.extract(e,this.consumeTill)}parseSctpPort(e){this.attributes.sctpPort=this.extractOneOrMore(e,a,[1,5])}parseMaxMessageSize(e){this.attributes.maxMessageSize=this.extractOneOrMore(e,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(e){this.attributes.mid=this.extract(e,this.consumeToken)}parseSSRCGroup(e){const t=this.extract(e,this.consumeToken),n=[];for(;;)try{this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeInteger);n.push(parseInt(t,10))}catch(e){break}this.attributes.ssrcGroups.push({semantic:t,ssrcIds:n})}}function I(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class b{constructor(){I(this,"eol",r)}print(e,t){let n="";return t&&(this.eol=t),n+=this.printVersion(e.version),n+=this.printOrigin(e.origin),n+=this.printSessionName(e.sessionName),n+=this.printInformation(e.information),n+=this.printUri(e.uri),n+=this.printEmail(e.emails),n+=this.printPhone(e.phones),n+=this.printConnection(e.connection),n+=this.printBandwidth(e.bandwidths),n+=this.printTimeFields(e.timeFields),n+=this.printKey(e.key),n+=this.printSessionAttributes(e.attributes),n+=this.printMediaDescription(e.mediaDescriptions),n}printVersion(e){return"v=".concat(e).concat(this.eol)}printOrigin(e){return"o=".concat(e.username," ").concat(e.sessId," ").concat(e.sessVersion," ").concat(e.nettype," ").concat(e.addrtype," ").concat(e.unicastAddress).concat(this.eol)}printSessionName(e){return e?"s=".concat(e).concat(this.eol):""}printInformation(e){return e?"i=".concat(e).concat(this.eol):""}printUri(e){return e?"u=".concat(e).concat(this.eol):""}printEmail(e){let t="";for(const n of e)t+="e=".concat(n).concat(this.eol);return t}printPhone(e){let t="";for(const n of e)t+="e=".concat(n).concat(this.eol);return t}printConnection(e){return e?"c=".concat(e.nettype," ").concat(e.addrtype," ").concat(e.address).concat(this.eol):""}printBandwidth(e){let t="";for(const n of e)t+="b=".concat(n.bwtype,":").concat(n.bandwidth).concat(this.eol);return t}printTimeFields(e){let t="";for(const n of e){t+="t=".concat(n.time.startTime," ").concat(n.time.startTime).concat(this.eol);for(const e of n.repeats)t+="r=".concat(e.repeatInterval," ").concat(e.typedTimes.join(" ")).concat(this.eol);n.zoneAdjustments&&(t+="z=",t+="z=".concat(n.zoneAdjustments.map((e=>"".concat(e.time," ").concat(e.back?"-":""," ").concat(e.typedTime))).join(" ")).concat(this.eol),t+=this.eol)}return t}printKey(e){return e?"k=".concat(e).concat(this.eol):""}printAttributes(e){let t="";for(const n of e)t+="a=".concat(n.attField).concat(n.attValue?":".concat(n.attValue):"").concat(this.eol);return t}printMediaDescription(e){let t="";for(const n of e)t+=this.printMedia(n.media),t+=this.printInformation(n.information),t+=this.printConnections(n.connections),t+=this.printBandwidth(n.bandwidths),t+=this.printKey(n.key),t+=this.printMediaAttributes(n);return t}printConnections(e){let t="";for(const n of e)t+=this.printConnection(n);return t}printMedia(e){return"m=".concat(e.mediaType," ").concat(e.port," ").concat(e.protos.join("/")," ").concat(e.fmts.join(" ")).concat(this.eol)}printSessionAttributes(e){return new O(this.eol).print(e)}printMediaAttributes(e){return new N(this.eol).print(e)}}class A{constructor(e){I(this,"eol",void 0),this.eol=e}printIceUfrag(e){return void 0===e?"":"a=ice-ufrag:".concat(e).concat(this.eol)}printIcePwd(e){return void 0===e?"":"a=ice-pwd:".concat(e).concat(this.eol)}printIceOptions(e){return void 0===e?"":"a=ice-options:".concat(e.join(o)).concat(this.eol)}printFingerprints(e){return e.length>0?e.map((e=>"a=fingerprint:".concat(e.hashFunction).concat(o).concat(e.fingerprint))).join(this.eol)+this.eol:""}printExtmap(e){return e.map((e=>"a=extmap:".concat(e.entry).concat(e.direction?"/".concat(e.direction):"").concat(o).concat(e.extensionName).concat(e.extensionAttributes?"".concat(o).concat(e.extensionAttributes):"").concat(this.eol))).join("")}printSetup(e){return void 0===e?"":"a=setup:".concat(e).concat(this.eol)}printUnrecognized(e){return e.map((e=>"a=".concat(e.attField).concat(e.attValue?":".concat(e.attValue):"").concat(this.eol))).join("")}}class O extends A{print(e){let t="";return t+=this.printGroups(e.groups),t+=this.printMsidSemantic(e.msidSemantic),t+=this.printIceLite(e.iceLite),t+=this.printIceUfrag(e.iceUfrag),t+=this.printIcePwd(e.icePwd),t+=this.printIceOptions(e.iceOptions),t+=this.printFingerprints(e.fingerprints),t+=this.printSetup(e.setup),t+=this.printTlsId(e.tlsId),t+=this.printIdentity(e.identities),t+=this.printExtmap(e.extmaps),t+=this.printUnrecognized(e.unrecognized),t}printGroups(e){let t="";return e.length>0&&(t+=e.map((e=>"a=group:".concat(e.semantic).concat(e.identificationTag.map((e=>"".concat(o).concat(e))).join("")).concat(this.eol))).join("")),t}printIceLite(e){return void 0===e?"":"a=ice-lite"+this.eol}printTlsId(e){return e?"a=tls-id:".concat(e).concat(this.eol):""}printIdentity(e){return 0===e.length?"":e.map((e=>"a=identity:".concat(e.assertionValue).concat(e.extensions.map((e=>"".concat(o).concat(e.name).concat(e.value?"=".concat(e.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(e){if(!e)return"";let t="a=msid-semantic:".concat(e.semantic);return e.applyForAll?t+="".concat(o,"*"):e.identifierList.length>0&&(t+=e.identifierList.map((e=>"".concat(o).concat(e)))),t+this.eol}}class N extends A{print(e){const t=e.attributes;let n="";return n+=this.printRTCP(t.rtcp),n+=this.printIceUfrag(t.iceUfrag),n+=this.printIcePwd(t.icePwd),n+=this.printIceOptions(t.iceOptions),n+=this.printCandidates(t.candidates),n+=this.printRemoteCandidatesList(t.remoteCandidatesList),n+=this.printEndOfCandidates(t.endOfCandidates),n+=this.printFingerprints(t.fingerprints),n+=this.printSetup(t.setup),n+=this.printMid(t.mid),n+=this.printExtmap(t.extmaps),n+=this.printRTPRelated(t),n+=this.printPtime(t.ptime),n+=this.printMaxPtime(t.maxPtime),n+=this.printDirection(t.direction),n+=this.printSSRCGroups(t.ssrcGroups),n+=this.printSSRC(t.ssrcs),n+=this.printRTCPMux(t.rtcpMux),n+=this.printRTCPMuxOnly(t.rtcpMuxOnly),n+=this.printRTCPRsize(t.rtcpRsize),n+=this.printMSId(t.msids),n+=this.printImageattr(t.imageattr),n+=this.printRid(t.rids),n+=this.printSimulcast(t.simulcast),n+=this.printSCTPPort(t.sctpPort),n+=this.printMaxMessageSize(t.maxMessageSize),n+=this.printUnrecognized(t.unrecognized),n}printCandidates(e){return e.map((e=>"a=candidate:".concat(e.foundation).concat(o).concat(e.componentId).concat(o).concat(e.transport).concat(o).concat(e.priority).concat(o).concat(e.connectionAddress).concat(o).concat(e.port).concat(o,"typ").concat(o).concat(e.type).concat(e.relAddr?"".concat(o,"raddr").concat(o).concat(e.relAddr):"").concat(e.relPort?"".concat(o,"rport").concat(o).concat(e.relPort):"").concat(Object.keys(e.extension).map((t=>"".concat(o).concat(t).concat(o).concat(e.extension[t]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(e){return e.map((e=>"a=remote-candidates:".concat(e.join(o)).concat(this.eol))).join("")}printEndOfCandidates(e){return void 0===e?"":"a=end-of-candidates"+this.eol}printRTPRelated(e){if(!e.payloads)return"";const t=e.payloads;let n="";n+=e.rtcpFeedbackWildcards.map((e=>this.printRTCPFeedback("*",e))).join("");for(const i of t)n+=this.printRtpMap(i.payloadType,i.rtpMap),n+=this.printFmtp(i.payloadType,i.fmtp),n+=i.rtcpFeedbacks.map((e=>this.printRTCPFeedback(i.payloadType,e))).join("");return n}printFmtp(e,t){if(!t)return"";const n=Object.keys(t.parameters);return 1===n.length&&null===t.parameters[n[0]]?"a=fmtp:".concat(e).concat(o).concat(n[0]).concat(this.eol):"a=fmtp:".concat(e).concat(o).concat(Object.keys(t.parameters).map((e=>"".concat(e,"=").concat(t.parameters[e]))).join(";")).concat(this.eol)}printRtpMap(e,t){return t?"a=rtpmap:".concat(e).concat(o).concat(t.encodingName,"/").concat(t.clockRate).concat(t.encodingParameters?"/".concat(t.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(e,t){let n="a=rtcp-fb:".concat(e).concat(o),i=t;return"trr-int"===i.type?n+="ttr-int".concat(o).concat(i.interval):(n+="".concat(i.type),i.parameter&&(n+="".concat(o).concat(i.parameter),i.additional&&(n+="".concat(o).concat(i.additional)))),n+this.eol}printPtime(e){return void 0===e?"":"a=ptime:".concat(e).concat(this.eol)}printMaxPtime(e){return void 0===e?"":"a=maxptime:".concat(e).concat(this.eol)}printDirection(e){return void 0===e?"":"a=".concat(e).concat(this.eol)}printSSRC(e){return e.map((e=>Object.keys(e.attributes).map((t=>"a=ssrc:".concat(e.ssrcId.toString(10)).concat(o).concat(t).concat(e.attributes[t]?":".concat(e.attributes[t]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(e){return void 0===e?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(e){return void 0===e?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(e){return void 0===e?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(e){if(void 0===e)return"";let t="a=rtcp:".concat(e.port);return e.netType&&(t+="".concat(o).concat(e.netType)),e.addressType&&(t+="".concat(o).concat(e.addressType)),e.address&&(t+="".concat(o).concat(e.address)),t+this.eol}printMSId(e){return e.map((e=>"a=msid:".concat(e.id).concat(e.appdata?"".concat(o).concat(e.appdata):"").concat(this.eol))).join("")}printImageattr(e){return e.map((e=>"a=imageattr:".concat(e).concat(this.eol))).join("")}printRid(e){return e.map((e=>{let t="a=rid:".concat(e.id).concat(o).concat(e.direction);return e.payloads&&(t+="".concat(o,"pt=").concat(e.payloads.join(","))),e.params.length>0&&(t+="".concat(o).concat(e.params.map((e=>"depend"===e.type?"depend=".concat(e.rids.join(",")):"".concat(e.type,"=").concat(e.val))).join(";"))),t+this.eol})).join("")}printSimulcast(e){return void 0===e?"":"a=simulcast:".concat(e).concat(this.eol)}printSCTPPort(e){return void 0===e?"":"a=sctp-port:".concat(e).concat(this.eol)}printMaxMessageSize(e){return void 0===e?"":"a=max-message-size:".concat(e).concat(this.eol)}printMid(e){return void 0===e?"":"a=mid:".concat(e).concat(this.eol)}printSSRCGroups(e){return e.map((e=>"a=ssrc-group:".concat(e.semantic).concat(e.ssrcIds.map((e=>"".concat(o).concat(e.toString(10)))).join("")).concat(this.eol))).join("")}}function D(e){return(new y).parse(e)}function P(e,t){return(new b).print(e,t)}}},t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{}};return e[i](r,r.exports,n),r.exports}return n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n(8)})()}(bj);var Aj=bj.exports;function Oj(e){if(Array.isArray(e))return e.map((e=>e));if(!Nj(e))return e;const t={};for(const n in e){const i=e[n];Nj(i)||Array.isArray(i)?t[n]=Oj(i):t[n]=i}return t}function Nj(e){return!("object"!=typeof e||Array.isArray(e)||!e)}class Dj{constructor(e){iT(this,"input",[]),iT(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const Pj={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},kj={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Pj,remoteCandidate:Pj}},Lj={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0},Mj={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},Uj={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},xj={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function Vj(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Fj(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Vj(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Vj(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class jj{constructor(e,t){iT(this,"onFirstVideoReceived",void 0),iT(this,"onFirstVideoDecoded",void 0),iT(this,"onFirstAudioReceived",void 0),iT(this,"onFirstVideoDecodedTimeout",void 0),iT(this,"onFirstAudioDecoded",void 0),iT(this,"onSelectedLocalCandidateChanged",void 0),iT(this,"onSelectedRemoteCandidateChanged",void 0),iT(this,"videoIsReady",!1),iT(this,"videoIsReady2",{}),iT(this,"pc",void 0),iT(this,"options",void 0),iT(this,"intervalTimer",void 0),iT(this,"stats",Oj(kj)),iT(this,"isFirstVideoReceived",{}),iT(this,"isFirstVideoDecoded",{}),iT(this,"isFirstAudioReceived",{}),iT(this,"isFirstAudioDecoded",{}),iT(this,"isFirstVideoDecodedTimeout",{}),iT(this,"lossRateWindowStats",[]),this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Gh((e=>{e({local:Fj({},Pj),remote:Fj({},Pj)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"];let i=0,r=0,o=0,s=0;for(const a of n)e[a].forEach(((e,n)=>{if(!this.lossRateWindowStats[t-1][a][n]||!this.lossRateWindowStats[0][a][n])return;const c=this.lossRateWindowStats[t-1][a][n].packets-this.lossRateWindowStats[0][a][n].packets,l=this.lossRateWindowStats[t-1][a][n].packetsLost-this.lossRateWindowStats[0][a][n].packetsLost;"videoSend"===a||"audioSend"===a?(i+=c,o+=l):(r+=c,s+=l),Number.isNaN(c)||Number.isNaN(c)?e.packetLostRate=0:e.packetLostRate=c<=0||l<=0?0:l/(c+l)}));e.sendPacketLossRate=i<=0||o<=0?0:o/(i+o),e.recvPacketLossRate=r<=0||s<=0?0:s/(r+s)}}function Bj(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Gj(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Bj(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Bj(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class Wj extends jj{constructor(){super(...arguments),iT(this,"_stats",kj),iT(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=Oj(kj);const n=t.filter((e=>"ssrc"===e.type));this.processSSRCStats(n);const i=t.find((e=>"VideoBwe"===e.type));i&&this.processBandwidthStats(i),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((e=>{var t;const n=Pi(t=e.id).call(t,"send");switch("".concat(e.mediaType,"_").concat(n?"send":"recv")){case"video_send":{const t=Oj(Mj);t.codec=e.googCodecName,t.adaptionChangeReason="none",e.googCpuLimitedResolution&&(t.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(t.adaptionChangeReason="bandwidth"),t.avgEncodeMs=Number(e.googAvgEncodeMs),t.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.firsCount=Number(e.googFirReceived),t.nacksCount=Number(e.googNacksReceived),t.plisCount=Number(e.googPlisReceived),t.frameCount=Number(e.framesEncoded),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(t),this._stats.rtt=t.rttMs;break}case"video_recv":{const t=Oj(Lj),n=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(t.codec=e.googCodecName,t.targetDelayMs=Number(e.googTargetDelayMs),t.renderDelayMs=Number(e.googRenderDelayMs),t.currentDelayMs=Number(e.googCurrentDelayMs),t.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),t.decodeMs=Number(e.googDecodeMs),t.maxDecodeMs=Number(e.googMaxDecodeMs),t.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},t.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},t.decodeFrameRate=Number(e.googFrameRateDecoded),t.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},t.jitterBufferMs=Number(e.googJitterBufferMs),t.firsCount=Number(e.googFirsSent),t.nacksCount=Number(e.googNacksSent),t.plisCount=Number(e.googPlisSent),t.framesDecodeCount=Number(e.framesDecoded),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,t.decodedFrame.width,t.decodedFrame.height),this.isFirstVideoDecoded[t.ssrc]=!0),n){const i=n.stats,r=Date.now()-n.lts;t.framesDecodeFreezeTime=i.framesDecodeFreezeTime,t.framesDecodeInterval=i.framesDecodeInterval,t.framesDecodeCount>i.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(n.lts=Date.now(),t.framesDecodeInterval=r,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<n.stats.framesDecodeCount&&(t.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:Gj({},t),lts:Date.now()}),this._stats.videoRecv.push(t);break}case"audio_recv":{const t=Oj(xj);t.codec=e.googCodecName,t.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,t.decodingCNG=Number(e.googDecodingCNG),t.decodingCTN=Number(e.googDecodingCTN),t.decodingCTSG=Number(e.googDecodingCTSG),t.decodingNormal=Number(e.googDecodingNormal),t.decodingPLC=Number(e.googDecodingPLC),t.decodingPLCCNG=Number(e.googDecodingPLCCNG),t.expandRate=Number(e.googExpandRate),t.accelerateRate=Number(e.googAccelerateRate),t.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),t.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),t.speechExpandRate=Number(e.googSpeechExpandRate),t.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),t.jitterBufferMs=Number(e.googJitterBufferMs),t.jitterMs=Number(e.googJitterReceived),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),t.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.decodingNormal>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),this._stats.audioRecv.push(t);break}case"audio_send":{const t=Oj(Uj);t.codec=e.googCodecName,t.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,t.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),t.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),t.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),t.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.rtt=t.rttMs,this._stats.audioSend.push(t);break}}}))}_getStats(){return new Gh(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((e=>{const n={id:e.id,timestamp:e.timestamp.valueOf().toString(),type:e.type};e.names().forEach((t=>{n[t]=e.stat(t)})),t.push(n)})),t}}function Hj(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Kj(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Hj(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Hj(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class zj extends jj{constructor(){super(...arguments),iT(this,"_stats",kj),iT(this,"report",void 0),iT(this,"lastDecodeVideoReceiverStats",new Map),iT(this,"lastVideoFramesRecv",new Map),iT(this,"lastVideoFramesSent",new Map),iT(this,"lastVideoFramesDecode",new Map),iT(this,"lastVideoFramesOutput",new Map),iT(this,"lastVideoJBDelay",new Map),iT(this,"lastAudioJBDelay",new Map),iT(this,"mediaBytesSent",new Map),iT(this,"mediaBytesRetransmit",new Map),iT(this,"mediaBytesTargetEncode",new Map),iT(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=Oj(kj),this.report.forEach((e=>{switch(e.type){case fb.OUTBOUND:case fb.INBOUND:{const t=e.mediaType||e.kind,n=!t&&"frameWidth"in e,i=!t&&!("frameWidth"in e);e.type===fb.OUTBOUND?"audio"===t||i?this.processAudioOutboundStats(e):("video"===t||n)&&this.processVideoOutboundStats(e):e.type===fb.INBOUND&&("audio"===t||i?this.processAudioInboundStats(e):("video"===t||n)&&this.processVideoInboundStats(e));break}case fb.TRANSPORT:{const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case fb.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:Kj({},Pj),remote:Kj({},Pj)};return e.forEach((n=>{let i;if(n.type===fb.TRANSPORT&&(i=e.get(n.selectedCandidatePairId)),n.type===fb.CANDIDATE_PAIR&&n.selected&&(i=n),i){const n=(e,t)=>{e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol)};if(i.localCandidateId){const r=e.get(i.localCandidateId);r&&n(t.local,r)}if(i.remoteCandidateId){const r=e.get(i.remoteCandidateId);r&&n(t.remote,r)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===fb.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===fb.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===fb.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Kj({},t),Kj({},this.stats.selectedCandidatePair.localCandidate)),e.type===fb.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Kj({},t),Kj({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((t=>t.ssrc===e.ssrc));t||(t=Oj(xj),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),"number"==typeof e.concealedSamples&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find((t=>t.ssrc===e.ssrc));t||(t=Oj(Lj),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.framesDroppedCount=e.framesDropped,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,t.totalFreezesDuration=e.totalFreezesDuration;const n=this.lastDecodeVideoReceiverStats.get(t.ssrc),i=this.lastVideoFramesDecode.get(t.ssrc),r=this.lastVideoFramesOutput.get(t.ssrc),o=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const e=t.decodedFrame?t.decodedFrame.width:0,n=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,e,n),this.isFirstVideoDecoded[t.ssrc]=!0}if(n){const i=n.stats,r=o-n.lts;t.framesDecodeFreezeTime=i.framesDecodeFreezeTime,t.framesDecodeInterval=i.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&r>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>i.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(n.lts=Date.now(),t.framesDecodeInterval=r,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<i.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(n.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-n.qpSum)/(e.framesDecoded-n.stats.framesDecodeCount))}i&&o-i.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-i.count)/((o-i.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:o,rate:t.decodeFrameRate})):i?t.decodeFrameRate=i.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:o,rate:0}),t.framesDroppedCount&&e.framesReceived&&(r&&o-r.lts>=800?(t.outputFrameRate=Math.round((e.framesReceived-t.framesDroppedCount-r.count)/((o-r.lts)/1e3)),this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:o,rate:Math.max(t.outputFrameRate,0)})):r?t.outputFrameRate=r.rate:this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:o,rate:0})),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:Kj({},t),lts:n?n.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((t=>t.ssrc===e.ssrc));t||(t=Oj(Mj),this._stats.videoSend.push(t));const n=this.mediaBytesSent.get(e.ssrc);if(n)n.add(e.bytesSent);else{const t=new Dj(10);t.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,t)}if(void 0!==e.retransmittedBytesSent){const t=this.mediaBytesRetransmit.get(e.ssrc);if(t)t.add(e.retransmittedBytesSent);else{const t=new Dj(10);t.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,t)}}if(e.totalEncodedBytesTarget){const t=this.mediaBytesTargetEncode.get(e.ssrc);if(t)t.add(e.totalEncodedBytesTarget);else{const t=new Dj(10);t.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,t)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const n=this.lastEncoderMs.get(e.ssrc);if(!n||n.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const i=e.framesEncoded-n.lastFrameCount,r=e.totalEncodeTime-n.lastEncoderTime;t.avgEncodeMs=1e3*r/i}}if(e.framesEncoded&&e.qpSum){const n=this.lastEncoderMs.get(e.ssrc);!n||n.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-n.lastQpSum)/(e.framesEncoded-n.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const n=this.findRemoteStatsId(e.ssrc,fb.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((t=>t.ssrc===e.ssrc));if(t||(t=Oj(Uj),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const n=this.findRemoteStatsId(e.ssrc,fb.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,t)}}findRemoteStatsId(e,t){var n;const i=Array.from(hb(n=this.report).call(n)).find((n=>n.type===t&&n.ssrc===e));return i?i.id:null}processVideoMediaSource(e,t){const n=this.report.get(e);n&&n.width&&n.height&&n.framesPerSecond&&(t.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(e,t){const n=this.report.get(e);n&&(t.inputLevel=n.audioLevel)}processVideoTrackSenderStats(e,t,n){var i,r,o,s;const a=t?this.report.get(t):void 0,c=null!==(i=null==a?void 0:a.framesSent)&&void 0!==i?i:e.framesSent;if("number"!=typeof c)return;let l=null!==(r=null==a?void 0:a.frameWidth)&&void 0!==r?r:e.frameWidth,d=null!==(o=null==a?void 0:a.frameHeight)&&void 0!==o?o:e.frameHeight,u=null!==(s=null==a?void 0:a.framesPerSecond)&&void 0!==s?s:e.framesPerSecond;if("number"==typeof l&&"number"==typeof d||(l=0,d=0),null==u){const e=Date.now(),t=this.lastVideoFramesSent.get(n.ssrc);t&&e-t.lts>=800?(u=Math.round((c-t.count)/((e-t.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:e,rate:u})):t?u=t.rate:this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:e,rate:0})}n.sentFrame={width:l,height:d,frameRate:Math.max(0,u)}}processVideoTrackReceiverStats(e,t,n){var i,r,o,s,a;const c=t?this.report.get(t):void 0,l=null!==(i=null==c?void 0:c.framesReceived)&&void 0!==i?i:e.framesReceived,d=null!==(r=null==c?void 0:c.frameWidth)&&void 0!==r?r:e.frameWidth,u=null!==(o=null==c?void 0:c.frameHeight)&&void 0!==o?o:e.frameHeight,h=null!==(s=null==c?void 0:c.jitterBufferDelay)&&void 0!==s?s:e.jitterBufferDelay,p=null!==(a=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount;if("number"==typeof l){const e=this.lastVideoFramesRecv.get(n.ssrc),t=Date.now();n.framesReceivedCount=l;let i=0;e&&t-e.lts>=800?(i=Math.round((l-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:l,lts:t,rate:i})):e?i=e.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:l,lts:t,rate:0}),n.receivedFrame={width:d||0,height:u||0,frameRate:i||0},n.decodedFrame={width:d||0,height:u||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:d||0,height:u||0,frameRate:n.outputFrameRate||n.decodeFrameRate||0}}if(h&&p){const e=this.lastVideoJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const i=p-e.jitterBufferEmittedCount;i>0&&(t=1e3*(h-e.jitterBufferDelay)/i),n.jitterBufferMs=t,n.currentDelayMs=Math.round(t),this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:h,jitterBufferEmittedCount:p,jitterBufferMs:n.currentDelayMs})}}processAudioTrackSenderStats(e,t,n){var i,r,o,s;const a=t?this.report.get(t):void 0,c=null!==(i=null!==(r=null==a?void 0:a.echoReturnLoss)&&void 0!==r?r:e.echoReturnLoss)&&void 0!==i?i:0,l=null!==(o=null!==(s=null==a?void 0:a.echoReturnLossEnhancement)&&void 0!==s?s:e.echoReturnLossEnhancement)&&void 0!==o?o:0;n.aecReturnLoss=c,n.aecReturnLossEnhancement=l}processAudioTrackReceiverStats(e,t,n){var i,r,o,s,a,c,l;const d=t?this.report.get(t):void 0,u=null!==(i=null==d?void 0:d.removedSamplesForAcceleration)&&void 0!==i?i:e.removedSamplesForAcceleration,h=null!==(r=null==d?void 0:d.totalSamplesReceived)&&void 0!==r?r:e.totalSamplesReceived,p=null!==(o=null==d?void 0:d.jitterBufferDelay)&&void 0!==o?o:e.jitterBufferDelay,f=null!==(s=null==d?void 0:d.jitterBufferEmittedCount)&&void 0!==s?s:e.jitterBufferEmittedCount,m=null!==(a=null==d?void 0:d.audioLevel)&&void 0!==a?a:null==e?void 0:e.audioLevel,_=null!==(c=null==d?void 0:d.totalSamplesDuration)&&void 0!==c?c:null==e?void 0:e.totalSamplesDuration,E=null!==(l=null==d?void 0:d.concealedSamples)&&void 0!==l?l:e.concealedSamples;if(u&&h&&(n.accelerateRate=u/h),p&&f){const e=this.lastAudioJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const i=f-e.jitterBufferEmittedCount;i>0&&(t=1e3*(p-e.jitterBufferDelay)/i),n.jitterBufferMs=Math.round(t),this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:f,jitterBufferMs:n.jitterBufferMs})}n.outputLevel=m;let g=1920;_&&h&&(g=h/_/50,n.receivedFrames=Math.round(h/g)),E&&(n.droppedFrames=Math.round(E/g))}processRemoteInboundStats(e,t){const n=this.report.get(e);n&&(t.packetsLost=n.packetsLost,n.roundTripTime&&(t.rttMs=1e3*n.roundTripTime),n.jitter&&(t.jitterMs=1e3*n.jitter),n.timestamp&&(t.timestamp=n.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const n=t.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let e=0,t=null,n=null;this.mediaBytesSent.forEach((t=>{e+=t.diffMean()})),this.mediaBytesRetransmit.forEach((e=>{t=null===t?e.diffMean():t+e.diffMean()})),this.mediaBytesTargetEncode.forEach((e=>{n=null===n?e.diffMean():n+e.diffMean()}));const i=null!==t?e-t:e;this._stats.bitrate={actualEncoded:8*i/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==t&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),null!==n&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}}class qj extends jj{updateStats(){return Gh.resolve()}}function Yj(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=function(){const e=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return e&&e[0]?Number(e[0].split("/")[1]):null}();return o?o<76?new Wj(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new zj(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):function(e){return!!window.RTCStatsReport&&e.getStats()instanceof Gh}(e)?new zj(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new qj(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r})}function Jj(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Xj(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Jj(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Jj(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Qj(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:a,filterVideoCodec:c}=t,{useXR:l}=n;let d=[],u=[],h=[],p=[],f=!1,m=!1;if(Aj.parse(e).mediaDescriptions.forEach((e=>{i&&i!==e.attributes.direction||("video"!==e.media.mediaType||f||(u=e.attributes.payloads,p=e.attributes.extmaps,f=!0),"audio"!==e.media.mediaType||m||(d=e.attributes.payloads,h=e.attributes.extmaps,m=!0))})),!p||0===u.length)throw new Error("Cannot get video capabilities from SDP.");if(!h||0===d.length)throw new Error("Cannot get audio capabilities from SDP.");if(u.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),l&&e.rtcpFeedbacks.push({type:"rrtr"})})),d.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),l&&e.rtcpFeedbacks.push({type:"rrtr"})})),r&&(d=d.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),u=u.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),o&&(u=u.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),s&&(d=d.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),a&&(null==a?void 0:a.length)>0&&(d=d.filter((e=>{var t;return Pi(a).call(a,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),c&&(null==c?void 0:c.length)>0){const e=u.filter((e=>{var t;return Pi(c).call(c,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}));u=e.concat(r?[]:mB(e,u))}const _=Dw("UNSUPPORTED_VIDEO_CODEC");return _&&_.length>0&&(u=u.filter((e=>!(e.rtpMap&&Pi(_).call(_,e.rtpMap.encodingName.toLowerCase()))))),{audioCodecs:d,videoCodecs:u,audioExtensions:h,videoExtensions:p}}function Zj(e){const t=Aj.parse(e);let n,i;for(const r of t.mediaDescriptions){if(!n){const e=r.attributes.iceUfrag,t=r.attributes.icePwd;if(!e||!t)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:e,icePwd:t}}if(!i){const e=r.attributes.fingerprints;e.length>0&&(i={fingerprints:e})}}if(!i&&t.attributes.fingerprints.length>0&&(i={fingerprints:t.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:i}}function $j(e,t){const n=[],i=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),r=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),o=e.attributes.ssrcs;if(r)r.ssrcIds.forEach((e=>{var r;const o=null===(r=i.find((t=>t.ssrcIds[0]===e)))||void 0===r?void 0:r.ssrcIds[1];n.push({ssrcId:e,rtx:t?o:void 0})}));else if(i.length>0){const e=i[0].ssrcIds[0],r=i[0].ssrcIds[1];n.push({ssrcId:e,rtx:t?r:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:o[0].ssrcId})}return n}function eB(e,t){const{cname:n}=e;let i;t&&t.ip&&"number"==typeof t.port?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],Qw.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),Qw.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):i=e.iceParameters.candidates.map((e=>({foundation:e.foundation,componentId:"1",transport:e.protocol,priority:e.priority.toString(),connectionAddress:e.ip,port:e.port.toString(),type:e.type,extension:{}})));const r={fingerprints:e.dtlsParameters.fingerprints.map((e=>({hashFunction:e.algorithm,fingerprint:e.fingerprint})))},o={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let s;switch(e.dtlsParameters.role){case"server":s="passive";break;case"client":s="active";break;case"auto":s="actpass"}return{dtlsParameters:r,iceParameters:o,candidates:i,rtpCapabilities:uB(e.rtpCapabilities),setup:s,cname:n}}function tB(e,t,n){const i=[],r=[];return e.forEach((e=>{let{ssrcId:o,rtx:s}=e;const a=ew(8,"track-"),c={ssrcId:o,attributes:Xj({label:a,mslabel:n=n||ew(10,""),msid:"".concat(n," ").concat(a)},t&&{cname:t})};if(i.push(c),void 0!==s){const e={ssrcId:s,attributes:Xj({label:a,mslabel:n,msid:"".concat(n," ").concat(a)},t&&{cname:t})};i.push(e),r.push({semantic:"FID",ssrcIds:[o,s]})}})),e.length>1&&r.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:i,ssrcGroups:r}}function nB(e,t){t instanceof kV&&e.attributes.payloads.forEach((e=>{var n;const i=null===(n=e.rtpMap)||void 0===n?void 0:n.encodingName.toLowerCase();if(!i||-1===["opus","pcmu","pcma","g722"].indexOf(i))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const r=t._encoderConfig;r&&"pcmu"!==i&&"pcma"!==i&&"g722"!==i&&(r.bitrate&&!PC()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*r.bitrate))),r.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(r.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(r.sampleRate)),r.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function iB(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function rB(e,t){var n;if(!(t instanceof CF&&t._encoderConfig&&-1===t._hints.indexOf(kU.SCREEN_TRACK)))return;const i=t._encoderConfig;fU().supportMinBitrate&&i.bitrateMin&&e.attributes.payloads.forEach((e=>{var t,n;Pi(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(n=e.rtpMap)||void 0===n?void 0:n.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),fU().supportMinBitrate&&!Pi(n=t._hints).call(n,kU.LOW_STREAM)&&i.bitrateMax&&e.attributes.payloads.forEach((e=>{var t,n;Pi(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(n=e.rtpMap)||void 0===n?void 0:n.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(Dw("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function oB(e){if("video"!==e.media.mediaType)return;const t=RC();if(t.name!==TC.SAFARI&&t.os!==vC.IOS)return;const n=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==n&&e.attributes.extmaps.splice(n,1)}function sB(e,t,n){if(!t)return;let i,r;if("video"===e.media.mediaType?(i=n.videoExtensions,r=n.videoCodecs):(i=n.audioExtensions,r=n.audioCodecs),!0===t.twcc){const t=i.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const n=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(r,e.attributes.payloads);n.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=i.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const n=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(r,e.attributes.payloads);n.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function aB(e,t,n){if(PC())return;if("video"!==e.media.mediaType)return;if(!(t instanceof CF))return;if("vp9"!==n&&"vp8"!==n)return;if("vp8"===n&&!Dw("SIMULCAST"))return;if(void 0===t._scalabilityMode||t._scalabilityMode.numSpatialLayers<=1)return;const i="vp8"===n?2:t._scalabilityMode.numSpatialLayers,r=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===r.ssrcId)),s={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)e.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:GR(r.attributes)}),s.ssrcIds.push(r.ssrcId+a),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:GR(r.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,o.ssrcIds[1]+a]}));e.attributes.ssrcGroups.unshift(s)}async function cB(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const i=(await n.createOffer()).sdp,{send:r,recv:o,sendrecv:s}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;const i=Qj(n,e,t,"sendonly"),r=Qj(n,e,t,"recvonly"),o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(dB(i,r,"videoExtensions",o,s,a),dB(i,r,"videoCodecs",o,s,a),dB(i,r,"audioExtensions",o,s,a),dB(i,r,"audioCodecs",o,s,a),Dw("RAISE_H264_BASELINE_PRIORITY")){const e=a.videoCodecs.findIndex((e=>{var t,n;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"===(null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"])}));if(-1!==e){const t=a.videoCodecs.findIndex((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())}));if(t<e){Qw.debug("raising H264 baseline profile priority");const n=a.videoCodecs[e];a.videoCodecs.splice(e,1),a.videoCodecs.splice(t,0,n)}-1!==t&&(s.videoCodecs=s.videoCodecs.filter((e=>{var t,n;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"]))}))),-1!==t&&Dw("FILTER_SEND_H264_BASELINE")&&(o.videoCodecs=o.videoCodecs.filter((e=>{var t,n;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"]))})))}}return{send:o,recv:s,sendrecv:a}}(e,t,i);try{n.close()}catch(e){}return{send:r,recv:o,sendrecv:s}}function lB(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=Qj(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(dB(e,t,"videoExtensions",n,i,r),dB(e,t,"videoCodecs",n,i,r),dB(e,t,"audioExtensions",n,i,r),dB(e,t,"audioCodecs",n,i,r),Dw("RAISE_H264_BASELINE_PRIORITY")){const e=r.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const t=r.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(t<e){Qw.debug("raising H264 baseline profile priority");const n=r.videoCodecs[e];r.videoCodecs.splice(e,1),r.videoCodecs.splice(t,0,n)}-1!==t&&(i.videoCodecs=i.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:i,sendrecv:r}}function dB(e,t,n,i,r,o){if("videoExtensions"===n||"audioExtensions"===n){const s=[];return e[n].forEach((e=>{t[n].some(((t,n)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return s.push(n),!0}))?o[n].push(e):i[n].push(e)})),void t[n].forEach(((e,t)=>{-1===s.indexOf(t)&&r[n].push(e)}))}if("videoCodecs"===n||"audioCodecs"===n){const s=[];return e[n].forEach((e=>{t[n].some(((t,n)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return s.push(n),!0}))?o[n].push(e):i[n].push(e)})),void t[n].forEach(((e,t)=>{-1===s.indexOf(t)&&r[n].push(e)}))}}function uB(e){const{send:t,recv:n,sendrecv:i}=e;if(!i){if(!t||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:n}}let r,o;return t?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...t.audioCodecs,...i.audioCodecs],r.videoCodecs=[...t.videoCodecs,...i.videoCodecs],r.audioExtensions=[...t.audioExtensions,...i.audioExtensions],r.videoExtensions=[...t.videoExtensions,...i.videoExtensions]):r=i,n?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...n.audioCodecs,...i.audioCodecs],o.videoCodecs=[...n.videoCodecs,...i.videoCodecs],o.audioExtensions=[...n.audioExtensions,...i.audioExtensions],o.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):o=i,{send:r,recv:o}}function hB(e){"audio"===e.media.mediaType&&e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function pB(e){e.mediaDescriptions.forEach((e=>{"video"!==e.media.mediaType&&"audio"!==e.media.mediaType||e.attributes.payloads.forEach((e=>{-1===e.rtcpFeedbacks.findIndex((e=>"rrtr"===e.type))&&e.rtcpFeedbacks.push({type:"rrtr"})}))}))}function fB(e,t,n,i){let r=[];if(e===iA.VIDEO){if(Dw("H264_PROFILE_LEVEL_ID")&&"h264"===i&&(r=t.videoCodecs.filter((e=>{var t;return Pi(t=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(t,i)&&e&&e.fmtp&&e.fmtp.parameters["profile-level-id"]===Dw("H264_PROFILE_LEVEL_ID")}))),!Array.isArray(r)||0===r.length){let e=[];const o=[],s=[],a=[];if(n.videoCodecs.forEach((t=>{const n=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"";Pi(n).call(n,i)?e.push(t):Pi(n).call(n,"vp9")?o.push(t):Pi(n).call(n,"vp8")?s.push(t):Pi(n).call(n,"h264")&&a.push(t)})),0===e.length){let t="";0!==o.length?(e=o,t="vp9"):0!==s.length?(e=s,t="vp8"):0!==a.length&&(e=a,t="h264"),Qw.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(t))}0!==e.length&&(r=t.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(0===r.length&&(Qw.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),r=t.videoCodecs),Dw("USE_PUB_RTX")||Dw("USE_SUB_RTX")){const e=mB(r,t.videoCodecs);r=[...r,...e]}}else r=t.audioCodecs.filter((e=>{var t;return Pi(t=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(t,i)})),0===r.length&&(Qw.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=t.audioCodecs.filter((e=>{var t;return Pi(t=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(t,"opus")})));return r}function mB(e,t){const n=e.map((e=>e.payloadType.toString()));return t.filter((e=>e.rtpMap&&"rtx"===e.rtpMap.encodingName&&e.fmtp&&e.fmtp.parameters.apt&&Pi(n).call(n,e.fmtp&&e.fmtp.parameters.apt)))}let _B=class{get localCapabilities(){return GR(this._localCapabilities)}get rtpCapabilities(){return GR(this._rtpCapabilities)}get candidates(){return GR(this._candidates)}get iceParameters(){return GR(this._iceParameters)}get dtlsParameters(){return GR(this._dtlsParameters)}constructor(e){iT(this,"sessionDesc",void 0),iT(this,"_localCapabilities",void 0),iT(this,"_rtpCapabilities",void 0),iT(this,"_candidates",void 0),iT(this,"_iceParameters",void 0),iT(this,"_dtlsParameters",void 0),iT(this,"setup",void 0),iT(this,"currentMidIndex",void 0),iT(this,"cname","o/i14u9pJrxRKAsu"),iT(this,"firefoxSsrcMidMap",new Map),e=GR(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,localCapabilities:o,direction:s,setup:a,videoCodec:c,audioCodec:l}=e;let d;this.setup=a,d=s===wb.RECEIVE_ONLY?Aj.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"):Aj.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=o;const u=s===wb.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,h=s===wb.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=s===wb.RECEIVE_ONLY?r.send.videoCodecs:fB(iA.VIDEO,u,h,c),f=s===wb.RECEIVE_ONLY?r.send.audioCodecs:fB(iA.AUDIO,u,h,l);for(const m of d.mediaDescriptions)m.attributes.iceUfrag=t.iceUfrag,m.attributes.icePwd=t.icePwd,m.attributes.fingerprints=n.fingerprints,m.attributes.candidates=i,m.attributes.setup=this.setup,"application"===m.media.mediaType&&(m.attributes.sctpPort="5000"),"video"===m.media.mediaType&&(m.media.fmts=p.map((e=>e.payloadType.toString(10))),m.attributes.payloads=p,m.attributes.extmaps=u.videoExtensions),"audio"===m.media.mediaType&&(m.media.fmts=f.map((e=>e.payloadType.toString(10))),m.attributes.payloads=f,m.attributes.extmaps=u.audioExtensions,hB(m));this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return Aj.print(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every((e=>this.hasMid(e))):this.sessionDesc.mediaDescriptions.some((t=>t.attributes.mid===e))}send(e,t,n,i,r){n=n.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:s}=tB(t,this.cname,Dw("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(PC()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,o,i);let n;return-1===t?(n=this.createOrRecycleSendMedia(e,o,s,"sendonly",i,r),this.updateBundleMids()):(n=GR(this.sessionDesc.mediaDescriptions[t]),n.attributes.direction="sendonly",n.attributes.ssrcs=o,n.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(n,r)),PC()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,n.attributes.mid),{needExchangeSDP:!0,mid:n.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{e.attributes.ssrcs=[]})),this.updateBundleMids()}receive(e,t,n){const i=[];return e.forEach((e=>{const r=e._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(r);let s,a=!1;-1===o?(a=!0,s=this.createOrRecycleRecvMedia(e,[],"recvonly",t,n),this.updateBundleMids()):(s=GR(this.sessionDesc.mediaDescriptions[o]),s.attributes.direction="recvonly"),i.push({mid:s.attributes.mid,needCreateTransceiver:a})})),i}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:n,address:i,port:r,type:o,relatedAddress:s,relatedPort:a,priority:c}=new RTCIceCandidate(e),l={foundation:null!=t?t:"",componentId:"1",transport:null!=n?n:"",priority:c?c+"":"",connectionAddress:null!=i?i:"",port:r?r+"":"",type:o?o+"":"",relAddr:null!=s?s:"",relPort:a?a+"":"",extension:{}};this.candidates.some((e=>e.priority===l.priority&&e.connectionAddress===l.connectionAddress&&e.port===l.port))||(this._candidates.push(l),this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,n,i,r){const o=e._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,a=fB(o,s,this.localCapabilities.send,o===iA.AUDIO?r:i),c=o===iA.VIDEO?s.videoExtensions:s.audioExtensions,l="".concat(++this.currentMidIndex);let d={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};d=this.mungRecvMediaDsec(d,e);const u=this.findFirstClosedMedia(o);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Pi(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Pi(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}findAvailableMediaIndex(e,t,n){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const r=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(PC()){if(r){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return r&&i.attributes.mid===n}))}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex((t=>{const n=t.media.mediaType===e&&"0"!==t.media.port&&("recvonly"===t.attributes.direction||"sendrecv"===t.attributes.direction);return"0"!==t.attributes.mid&&"1"!==t.attributes.mid&&n}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}restartICE(e){e=GR(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}createOrRecycleSendMedia(e,t,n,i,r,o){const s=this.rtpCapabilities.send,a=e===iA.VIDEO?s.videoCodecs:s.audioCodecs,c=e===iA.VIDEO?s.videoExtensions:s.audioExtensions;PC()&&(r="".concat(++this.currentMidIndex));let l={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};l=this.mungSendMediaDesc(l,o);const d=this.findFirstClosedMedia(e);if(d){const e=this.sessionDesc.mediaDescriptions.indexOf(d);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}mungRecvMediaDsec(e,t,n){const i=GR(e);return iB(i),nB(i,t),rB(i,t),oB(i),sB(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=GR(e);return sB(n,t,this.localCapabilities.recv),hB(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==n){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=e}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return(null===(n=t.attributes)||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId)===e[0].ssrcId}))}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>PC()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}};const EB=["sdp"];var gB;function vB(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function TB(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vB(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vB(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let SB=(gB=class e extends tA{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(t,n,i){super(t,n),iT(this,"direction",void 0),iT(this,"name",void 0),iT(this,"store",void 0),iT(this,"spec",void 0),iT(this,"peerConnection",void 0),iT(this,"initialOffer",void 0),iT(this,"transport",void 0),iT(this,"statsFilter",void 0),iT(this,"localCandidateCount",0),iT(this,"_isInRestartIce",!1),iT(this,"mutex",new hw("P2PConnection-mutex")),iT(this,"onLocalCandidate",void 0),iT(this,"remoteSDP",void 0),iT(this,"pendingCandidates",[]),iT(this,"localCapabilities",void 0),iT(this,"isReady",!1),iT(this,"restartCnt",0),iT(this,"curTurnServerIndex",0),this.store=n,this.spec=t,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=null!=i?i:wb.SEND_ONLY,this.name=this.direction===wb.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Yj(this.peerConnection,Dw("STATS_UPDATE_INTERVAL"),void 0,PC()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const t=await cB();if(this.localCapabilities=uB(t),e){const{sdp:t}=e,n=Ij(e,EB),i=function(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=Qj(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(dB(t,e,"videoExtensions",n,i,r),dB(t,e,"videoCodecs",n,i,r),dB(t,e,"audioExtensions",n,i,r),dB(t,e,"audioCodecs",n,i,r),Dw("RAISE_H264_BASELINE_PRIORITY")){const e=r.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const t=r.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(t<e){Qw.debug("raising H264 baseline profile priority");const n=r.videoCodecs[e];r.videoCodecs.splice(e,1),r.videoCodecs.splice(t,0,n)}-1!==t&&Dw("FILTER_SEND_H264_BASELINE")&&(n.videoCodecs=n.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:i,sendrecv:r}}({},{},t);this.remoteSDP=new _B({remoteIceParameters:n.iceParameters,remoteDtlsParameters:n.dtlsParameters,candidates:[],remoteRTPCapabilities:i,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const r=await this.peerConnection.createAnswer();if(!r.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const o=Zj(r.sdp);await this.peerConnection.setLocalDescription(r);const s=await lB({},{},r.sdp);this.localCapabilities=uB(s);const a=this.peerConnection.getTransceivers()[0];return null!=a&&a.receiver&&a.receiver.transport&&this.tryBindTransportEvents(a.receiver.transport),TB(TB({},o),{},{sdp:r.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=Zj(e.sdp);return this.initialOffer=e,TB(TB({},t),{},{sdp:e.sdp})}}catch(e){throw new nR(tR.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:t,iceParameters:n,dtlsParameters:i}=e,r=await lB({},{},t);this.remoteSDP=new _B({remoteIceParameters:n,remoteDtlsParameters:i,candidates:[],remoteRTPCapabilities:r,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];null!=o&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((e=>{this.peerConnection.addIceCandidate(e)})),this.pendingCandidates=[])}catch(e){throw new nR(tR.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}send(e,t,n){var i=this;return pj((function*(){const r=yield rj(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const r=[],o=i.remoteSDP.receive(e,t,n);e.forEach(((e,t)=>{if(o[t].needCreateTransceiver){const t=i.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});r.push(t),e._updateRtpTransceiver(t)}else{const n=i.peerConnection.getTransceivers().find((e=>e.mid===o[t].mid));if(!n)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(o[t].mid));r.push(n),e._updateRtpTransceiver(n)}})),PC()&&!0===Dw("SIMULCAST")&&(yield rj(i.applySimulcastForFirefox(r,e)));const s=o.map((e=>e.mid)),a=yield rj(i.peerConnection.createOffer()),c=i.mungSendOfferSDP(a.sdp,e,s),l=Aj.parse(c),d=s.map((e=>{const t=l.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return $j(t,Dw("USE_PUB_RTX"))})),u=r.map(((e,t)=>{const n=s[t];return{localSSRC:d[t],id:n}}));yield rj(i.peerConnection.setLocalDescription({type:"offer",sdp:c}));try{yield u}catch(e){const n=i.remoteSDP.toString();throw yield rj(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield rj(i.peerConnection.setRemoteDescription({type:"answer",sdp:n})),yield rj(i.stopSending(s,!0)),e}yield rj(i.applySimulcastEncodings(r,e)),yield rj(i.applySendEncodings(r,e));const h=i.remoteSDP.toString(),p=i.logSDPExchange(c,"offer","local","send");return null==p||p(h),yield rj(i.setRemoteDescription({type:"answer",sdp:h})),r.map(((e,t)=>{const n=s[t];return{localSSRC:d[t],id:n}}))}catch(e){throw e instanceof nR?e:new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{r()}}))()}async stopSending(e,t){const n=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length (".concat(t.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==i||i(r),await this.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{n&&n()}}async receive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(e,t,n,i);if(o){const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(i.sdp,r,e);null==n||n(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),Qw.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else Qw.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const s=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!s||null===s.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,mid:s.mid,transceiver:s}}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async mockReceive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(e,t,n,i);if(o){const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(i.sdp,r,e);null==n||n(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),Qw.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else Qw.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===Iw.Auto&&(this.store.p2pTransport=Iw.SdRtn,fU().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,fU().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:t}=Zj(e.sdp);return this.store.descriptionStart(),this.direction===wb.SEND_ONLY&&await this.peerConnection.setLocalDescription(e),t}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===wb.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const e=await this.peerConnection.createAnswer();if(!e.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:t}=Zj(e.sdp);return await this.peerConnection.setLocalDescription(e),t}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(n.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const r=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==o||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===n.length&&(this.isVP8Simulcast(t)?PC()||await this.applySimulcastEncodings(n,[t]):await this.applySendEncodings(n,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getTransceivers().find((e=>e.mid===t));n&&await n.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:n,remote:i}=t.getSelectedCandidatePair();return{local:TB(TB({},Pj),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:TB(TB({},Pj),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,t;Pi(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(t=this.onICEConnectionStateChange)||void 0===t||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{var t;e.candidate?(e.candidate.candidate&&(null===(t=this.onLocalCandidate)||void 0===t||t.call(this,e.candidate.toJSON())),this.localCandidateCount+=1):Qw.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,n){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const r={iceServers:[]};var o;return t.iceServers?r.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(bR(t.turnServer.servers)?r.iceServers=t.turnServer.servers:(r.iceServers&&r.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers,n,i)),Dw("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&t.turnServer.serversFromGateway&&r.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway,n,i)),Pi(o=[Iw.Relay,Iw.SdRtn]).call(o,n)&&(r.iceTransportPolicy="relay"),Dw("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(r.iceTransportPolicy="relay")})))),Dw("ENABLE_ENCODED_TRANSFORM")&&fU().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),Qw.debug("P2PConnection p2pTransport is ".concat(n)),r}static turnServerConfigToIceServers(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i=[],r=e.filter((e=>e.tcpport));Qw.debug("P2PConnection turnServers is ".concat(r,", current index is ").concat(n));const o=r.length>n?r[n]:r[0];switch(t){case Iw.SdRtn:const t=e.filter((e=>{var t;return Pi(t=e.username).call(t,"glb:")&&e.turnServerURL==e.turnServerURL})),r=t.length>n?t[n]:t[0];r&&(i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(HA(r.turnServerURL),":").concat(r.tcpport,"?transport=udp")}),i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(HA(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}));break;case Iw.Relay:o&&(i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(HA(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),i.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(HA(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),i.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return i}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const t=e.iceTransport;t&&(t.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var n;t&&(null===(n=this.onICETransportStateChange)||void 0===n||n.call(this,t))},t.getSelectedCandidatePair&&(t.onselectedcandidatepairchange=()=>{if(t.getSelectedCandidatePair()){const{local:e,remote:n}=t.getSelectedCandidatePair();Qw.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var n;if(t||(t=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))),!t)return Qw.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return Qw.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!fU().supportSetRtpSenderParameters)return Qw.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const i={},r={};switch(e._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;default:i.degradationPreference="balanced"}if(e._encoderConfig){var o;const{bitrateMax:t,frameRate:n,scaleResolutionDownBy:i}=e._encoderConfig;t&&(r.maxBitrate=1e3*t),Pi(o=e._hints).call(o,kU.LOW_STREAM)&&(n&&(r.maxFramerate=zA(n)),i&&i>=1&&(r.scaleResolutionDownBy=i))}if(Dw("DSCP_TYPE")&&JC()){var s;const e=Dw("DSCP_TYPE");Pi(s=["very-low","low","medium","high"]).call(s,e)&&(r.networkPriority=e)}const a=t.getParameters(),c=null===(n=a.encodings)||void 0===n?void 0:n[0];PC()&&!c&&(i.encodings=[r]),c&&Object.assign(c,r),Object.assign(a,i),Qw.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await t.setParameters(a)}async applySendEncodings(e,t){try{if(!fU().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let n=0;n<e.length;n++){const i=e[n],r=t[n];r instanceof CF&&!this.isVP8Simulcast(r)&&await this.updateRtpSenderEncodings(r,i.sender)}}catch(e){Qw.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,n){const i=Aj.parse(e);return t.forEach(((e,t)=>{const r=n[t],o=i.mediaDescriptions.find((e=>e.attributes.mid===r));o&&(nB(o,e),aB(o,e,this.store.codec))})),Aj.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var n,i,r,o,s;const c=e[a],l=t[a];if(l instanceof CF&&!Pi(n=l._hints).call(n,kU.LOW_STREAM)&&null!==(i=l._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(r=l._encoderConfig)||void 0===r?void 0:r.bitrateMax)>200&&null!==(o=l._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(s=l._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const n=c.sender.getParameters();await c.sender.setParameters(Object.assign(n,e))}}}async applySimulcastEncodings(e,t){if(!PC()&&e.length===t.length)for(let n=0;n<e.length;n++){const i=t[n];if(i instanceof CF&&this.isVP8Simulcast(i)){const t=e[n],r={},o={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};r.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const s=t.sender.getParameters();await t.sender.setParameters(Object.assign(s,r))}}}isVP8Simulcast(e){var t,n,i,r,o;return!!(e instanceof CF&&Dw("SIMULCAST")&&"vp8"===this.store.codec&&!Pi(t=e._hints).call(t,kU.LOW_STREAM)&&null!==(n=e._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(r=e._scalabilityMode)&&void 0!==r&&r.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,t,n,i){if(Dw("SDP_LOGGING"))return Qw.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(t," SDP during P2PConnection.").concat(i,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",i)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async e=>{e.direction="sendonly"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}async getRemoteSSRC(e,t){var n,i;if(t=null!==(n=t)&&void 0!==n?n:null===(i=this.currentRemoteDescription)||void 0===i?void 0:i.sdp){var r;const n=null===(r=Aj.parse(t).mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===r?void 0:r.attributes.ssrcs;return null==n?void 0:n[0].ssrcId}}async setRemoteDescription(e){var t;await this.peerConnection.setRemoteDescription(e),Pi(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,t,n){const i=Aj.parse(e),r=i.mediaDescriptions.find((e=>e.attributes.mid===t));return r&&n===iA.AUDIO&&"audio"===r.media.mediaType&&hB(r),Aj.print(i)}},ib(gB.prototype,"establish",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"establish"),gB.prototype),ib(gB.prototype,"connect",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"connect"),gB.prototype),ib(gB.prototype,"receive",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"receive"),gB.prototype),ib(gB.prototype,"mockReceive",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"mockReceive"),gB.prototype),ib(gB.prototype,"stopReceiving",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"stopReceiving"),gB.prototype),ib(gB.prototype,"restartICE",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"restartICE"),gB.prototype),ib(gB.prototype,"close",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"close"),gB.prototype),ib(gB.prototype,"updateEncoderConfig",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"updateEncoderConfig"),gB.prototype),ib(gB.prototype,"updateSendParameters",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"updateSendParameters"),gB.prototype),ib(gB.prototype,"replaceTrack",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"replaceTrack"),gB.prototype),ib(gB.prototype,"muteLocal",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"muteLocal"),gB.prototype),ib(gB.prototype,"unmuteLocal",[yB],Object.getOwnPropertyDescriptor(gB.prototype,"unmuteLocal"),gB.prototype),gB);function yB(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From P2PConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function CB(e,t){let n=document.createElement("video"),i=document.createElement("canvas");n.setAttribute("style","display:none"),i.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),i.width=zA(t.width),i.height=zA(t.height);const r=zA(t.framerate||15);document.body.append(n),document.body.append(i);let o=e._mediaStreamTrack;n.srcObject=new MediaStream([o]),n.play();const s=i.getContext("2d");if(!s)throw new bb(tR.UNEXPECTED_ERROR,"can not get canvas context");const a=fU(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!n)return i.stopCapture&&i.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const e=n.videoWidth,t=n.videoHeight/e,r=i.width*t;Math.abs(r-i.height)>=2&&(Qw.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(r)),i.height=r)}s.drawImage(n,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),o!==e._mediaStreamTrack&&(o=e._mediaStreamTrack,n.srcObject=new MediaStream([o]))},i.stopCapture=hx((()=>i.startCapture&&i.startCapture()),r);const l=c.stop;return c.stop=()=>{l.call(c),n&&(n.remove(),n.srcObject=null,n=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),Qw.debug("clean low stream renderer")},c}var RB=function(e){return e[e.HEIGHT=2033]="HEIGHT",e[e.FRAME_RATE=2034]="FRAME_RATE",e[e.WIDTH=2035]="WIDTH",e}(RB||{}),wB=function(e){return e[e.FRAME_RATE=2002]="FRAME_RATE",e[e.WIDTH=2003]="WIDTH",e[e.HEIGHT=2004]="HEIGHT",e[e.PACKAGE_LOST=2005]="PACKAGE_LOST",e[e.AVG_ENCODE=2007]="AVG_ENCODE",e[e.NACKS=2009]="NACKS",e[e.PLIS=2010]="PLIS",e[e.FIRS=2011]="FIRS",e[e.BITRATE=2012]="BITRATE",e[e.PACKAGE_RATE=2031]="PACKAGE_RATE",e[e.ADAPTATION=2032]="ADAPTATION",e[e.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",e[e.BANDWIDTH=2061]="BANDWIDTH",e[e.RETRANSMIT=2062]="RETRANSMIT",e[e.TARGET_ENCODED=2064]="TARGET_ENCODED",e[e.TRANSMIT=2066]="TRANSMIT",e[e.FREEZE=2082]="FREEZE",e[e.DISABLED=2095]="DISABLED",e[e.PLAYER_STATUS=2128]="PLAYER_STATUS",e[e.QP_SUM=2143]="QP_SUM",e}(wB||{}),IB=function(e){return e[e.BITRATE=2069]="BITRATE",e[e.PACKAGE_LOST=2070]="PACKAGE_LOST",e[e.PACKAGE_RATE=2071]="PACKAGE_RATE",e[e.HEIGHT=2073]="HEIGHT",e[e.FRAME_RATE=2075]="FRAME_RATE",e[e.WIDTH=2077]="WIDTH",e}(IB||{}),bB=function(e){return e[e.JITTER=-1]="JITTER",e[e.PACKAGE_LOST=2014]="PACKAGE_LOST",e[e.WIDTH=2018]="WIDTH",e[e.HEIGHT=2019]="HEIGHT",e[e.FRAME_RATE=2020]="FRAME_RATE",e[e.JITTER_BUFFER=2023]="JITTER_BUFFER",e[e.CURRENT_DELAY=2024]="CURRENT_DELAY",e[e.NACKS=2026]="NACKS",e[e.PLIS=2027]="PLIS",e[e.FIRS=2028]="FIRS",e[e.BITRATE=2029]="BITRATE",e[e.PACKAGE_RATE=2078]="PACKAGE_RATE",e[e.FREEZE=2084]="FREEZE",e[e.DISABLED=2101]="DISABLED",e[e.PLAYER_STATUS=2129]="PLAYER_STATUS",e[e.QP_SUM=2144]="QP_SUM",e[e.I_FRAME_DELAY=2149]="I_FRAME_DELAY",e}(bB||{}),AB=function(e){return e[e.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",e[e.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",e[e.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",e[e.FREEZE_TIME=2109]="FREEZE_TIME",e[e.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",e[e.FREEZE_DURATION=2156]="FREEZE_DURATION",e}(AB||{}),OB=function(e){return e[e.PCM_LEVEL=2104]="PCM_LEVEL",e}(OB||{}),NB=function(e){return e[e.PACKAGE_LOST=-1]="PACKAGE_LOST",e[e.LEVEL=2038]="LEVEL",e[e.BITRATE=2039]="BITRATE",e[e.PACKAGE_RATE=2040]="PACKAGE_RATE",e[e.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",e[e.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",e[e.FREEZE=2081]="FREEZE",e[e.DISABLED=2096]="DISABLED",e}(NB||{}),DB=function(e){return e[e.BITRATE=2044]="BITRATE",e[e.PACKAGE_LOST=2045]="PACKAGE_LOST",e[e.PACKAGE_RATE=2046]="PACKAGE_RATE",e[e.CURRENT_DELAY=2047]="CURRENT_DELAY",e[e.JITTER_BUFFER=2054]="JITTER_BUFFER",e[e.JITTER=2055]="JITTER",e[e.FREEZE=2083]="FREEZE",e[e.DISABLED=2102]="DISABLED",e[e.PCM_LEVEL=2105]="PCM_LEVEL",e[e.PLAYER_STATUS=2130]="PLAYER_STATUS",e[e.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",e}(DB||{}),PB=function(e){return e[e.FREEZE_TIME=-1]="FREEZE_TIME",e[e.LEVEL=2043]="LEVEL",e}(PB||{}),kB=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e}(kB||{});const LB=1e3,MB=3;function UB(e,t,n){null!=n&&Number.isFinite(n)&&(e[t]=Math.round(Math.max(0,n)))}function xB(e){const t={[kB.CONN_TYPE]:0,[kB.RTT]:e.rtt};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===n&&(t[kB.CONN_TYPE]=1),"tcp"===n&&(t[kB.CONN_TYPE]=3),"tls"===n&&(t[kB.CONN_TYPE]=4);break}case"srflx":t[kB.CONN_TYPE]=2}return t}function VB(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class FB extends vR{constructor(e){super(),iT(this,"store",void 0),iT(this,"uploadWRTCStatsTimer",void 0),iT(this,"uploadOutboundDenoiserStatsTimer",void 0),iT(this,"uploadExtStatsTimer",void 0),iT(this,"uploadExtUsageStatsTimer",void 0),iT(this,"uploadInboundExtStatsTimer",void 0),iT(this,"requestStats",void 0),iT(this,"requestTransportStats",void 0),iT(this,"requestLocalMedia",void 0),iT(this,"requestRemoteMedia",void 0),iT(this,"requestAllTracks",void 0),iT(this,"requestVideoIsReady",void 0),iT(this,"requestUploadStats",void 0),iT(this,"requestUpload",void 0),iT(this,"uploadOutboundStarted",!1),iT(this,"uploadInboundStarted",!1),iT(this,"uploadTransportStarted",!1),iT(this,"uploadExtensionUsageStarted",!1),iT(this,"lastRecvStats",void 0),iT(this,"lastSendStats",void 0),iT(this,"lastFullRecvStats",void 0),iT(this,"lastFullSendStats",void 0),iT(this,"needUploadRenderFreezeTime",!0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let t,n;if(this.uploadTransportStarted&&(t=this.requestStats(),this.store.useP2P&&(n=this.requestStats(!0))),!t&&this.uploadOutboundStarted&&(t=this.requestStats()),!n&&this.uploadInboundStarted&&(n=this.requestStats(!0)),t||n){const i={};if(this.uploadTransportStarted&&t){const r=this.getTransportStats(t,n,e);r&&(i.misc=[r])}if(this.uploadOutboundStarted&&t){const n=this.getOutboundStats(t,e?this.lastSendStats:this.lastFullSendStats,e);n&&(i.outbound=[n])}if(this.uploadInboundStarted&&n){const t=this.getInboundStats(n,e?this.lastRecvStats:this.lastFullRecvStats,e);t&&(i.inbound=t)}this.requestUploadStats(i)}this.lastRecvStats=n,this.lastSendStats=t,e||(this.lastFullRecvStats=n,this.lastFullSendStats=t)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(e!==MB),++e===MB+1&&(e=1)}),LB)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,t,n){if(!this.requestStats)return;if(n)return null==e.rtt?void 0:{addition:{[kB.RTT]:e.rtt,[kB.CONN_TYPE]:void 0}};const i=xB(e);if(this.store.useP2P){if(t){const e=xB(t);i[kB.CONN_TYPE]+=e[kB.CONN_TYPE]<<3}i[kB.CONN_TYPE]+=110}else i[kB.CONN_TYPE]+=100;return{addition:i}}getOutboundStats(e,t,n){if(!this.requestUploadStats||!this.requestLocalMedia)return;const i=this.requestLocalMedia();if(!i||0===i.length)return;let r,o,s;return i.forEach((i=>{let[a,{track:c,ssrcs:l}]=i;switch(a){case sA.LocalVideoLowTrack:case sA.LocalVideoTrack:if(a===sA.LocalVideoTrack){const i=function(e,t,n,i,r){const o=t.videoSend.find((t=>t.ssrc===e));if(!o)return;const s={},{sentFrame:a,inputFrame:c}=o;if(c&&a){const e=c.frameRate,t=a.frameRate;s[wB.FREEZE]=function(e,t){let n=!0;return n=!(e<=5)&&(e<=10?t<3:e<=20?t<4:t<5),n}(e,t)?1:0}if(UB(s,wB.QP_SUM,o.qpSumPerFrame),r)return s;switch(a&&(UB(s,wB.HEIGHT,a.height),UB(s,wB.WIDTH,a.width),UB(s,wB.FRAME_RATE,a.frameRate)),s[wB.DISABLED]=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?1:0,o.adaptionChangeReason){case"none":s[wB.ADAPTATION]=0;break;case"cpu":s[wB.ADAPTATION]=1;break;case"bandwidth":s[wB.ADAPTATION]=2;break;case"other":s[wB.ADAPTATION]=3}let l=0;o.adaptionChangeReason&&(l+=VB(o.adaptionChangeReason)),t.qualityLimitationReason&&(l+=VB(t.qualityLimitationReason)<<3),s[wB.ADAPTATION]=l,s[wB.PLAYER_STATUS]=ZU[i._player?i._player.videoElementStatus:"uninit"],UB(s,wB.NACKS,o.nacksCount),UB(s,wB.PLIS,o.plisCount),UB(s,wB.FIRS,o.firsCount),UB(s,wB.AVG_ENCODE,o.avgEncodeMs);const d=n&&n.videoSend.find((t=>t.ssrc===e));if(d){let e=r?LB:LB*MB;d.timestamp&&o.timestamp&&(e=o.timestamp-d.timestamp),null!=d.packets&&null!=o.packets&&UB(s,wB.PACKAGE_RATE,1e3*(o.packets-d.packets)/e),null!=o.packetsLost&&null!=d.packetsLost&&UB(s,wB.PACKAGE_LOST,o.packetsLost-d.packetsLost),null!=d.bytes&&null!=o.bytes&&UB(s,wB.BITRATE,8*(o.bytes-d.bytes)/e)}return s}(l[0].ssrcId,e,t,c,n),r=n?null:function(e,t,n){const i=t.videoSend.find((t=>t.ssrc===e));if(!i)return null;const r={},o=i.inputFrame,s=o&&o.height||n&&n.videoHeight||0,a=o&&o.width||n&&n.videoWidth||0,c=o&&o.frameRate||0;return UB(r,RB.HEIGHT,s),UB(r,RB.WIDTH,a),UB(r,RB.FRAME_RATE,c),r}(l[0].ssrcId,e,c),s=n?null:function(e){const t={};return UB(t,wB.RETRANSMIT,e.bitrate.retransmit),UB(t,wB.TARGET_ENCODED,e.bitrate.targetEncoded),UB(t,wB.ACTUAL_ENCODED,e.bitrate.actualEncoded),UB(t,wB.TRANSMIT,e.bitrate.transmit),UB(t,wB.BANDWIDTH,e.sendBandwidth),t}(e);o=Object.assign({},i,r,s)}else s=n?void 0:function(e,t,n){const i=t.videoSend.find((t=>t.ssrc===e));if(!i)return;const r={},o=i.sentFrame;if(o&&(UB(r,IB.HEIGHT,o.height),UB(r,IB.WIDTH,o.width),UB(r,IB.FRAME_RATE,o.frameRate)),n){const t=n.videoSend.find((t=>t.ssrc===e));if(t){let e=LB*MB;t.timestamp&&i.timestamp&&(e=i.timestamp-t.timestamp),null!=t.packets&&null!=i.packets&&UB(r,IB.PACKAGE_RATE,1e3*(i.packets-t.packets)/e),null!=i.packetsLost&&null!=t.packetsLost&&UB(r,IB.PACKAGE_LOST,i.packetsLost-t.packetsLost),null!=t.bytes&&null!=i.bytes&&UB(r,IB.BITRATE,8*(i.bytes-t.bytes)/e)}}return r}(l[0].ssrcId,e,t);break;case sA.LocalAudioTrack:r=n?void 0:function(e,t,n,i){const r=t.audioSend.find((t=>t.ssrc===e));if(!r)return;const o={};o[NB.DISABLED]=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?1:0;const s=100*i._source.getAccurateVolumeLevel(),a=r.inputLevel;if(null!=a){const e=Math.ceil(50*Math.log10(100*a+1));UB(o,NB.LEVEL,e)}UB(o,OB.PCM_LEVEL,s),UB(o,NB.AEC_RETURN_LOSS,r.aecReturnLoss),UB(o,NB.AEC_RETURN_LOSS_ENH,r.aecReturnLossEnhancement),o[NB.FREEZE]=0;const c=n&&n.audioSend.find((t=>t.ssrc===e));if(c){let e=LB*MB;c.timestamp&&r.timestamp&&(e=r.timestamp-c.timestamp),null!=c.bytes&&null!=r.bytes&&UB(o,NB.BITRATE,8*(r.bytes-c.bytes)/e),null!=c.packets&&null!=r.packets&&UB(o,NB.PACKAGE_RATE,1e3*(r.packets-c.packets)/e)}return o}(l[0].ssrcId,e,t,c)}})),{high:o,low:s,audio:r}}getInboundStats(e,t,n){if(!this.requestRemoteMedia)return;const i=this.requestRemoteMedia()||[],r=[];return i.forEach((i=>{let[o,s]=i;const a={peer:o.uid};if(s.has(iA.VIDEO)&&o.videoTrack){const i=o._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(o._videoSSRC)||!1,r=o.videoTrack?function(e,t,n,i,r,o,s){var a;const c=t.videoRecv.find((t=>t.ssrc===e));if(!c)return;const l={},{receivedFrame:d,outputFrame:u,decodeFrameRate:h}=c,p=n&&n.videoRecv.find((t=>t.ssrc===e));if(l[bB.FREEZE]=r&&lG.isRemoteVideoFreeze(i,c,p)?1:0,UB(l,AB.FRAME_RATE_DECODE,h),UB(l,bB.QP_SUM,c.qpSumPerFrame),c.framesRateFirefox&&UB(l,bB.FRAME_RATE,c.framesRateFirefox),d&&UB(l,bB.FRAME_RATE,d.frameRate),p){const e=t.timestamp-n.timestamp||(s?LB:MB*LB);null!=c.packetsLost&&null!=p.packetsLost&&UB(l,bB.PACKAGE_LOST,c.packetsLost-p.packetsLost),null!=p.bytes&&null!=c.bytes&&UB(l,bB.BITRATE,8*(c.bytes-p.bytes)/e),null!=p.packets&&null!=c.packets&&UB(l,bB.PACKAGE_RATE,1e3*(c.packets-p.packets)/e)}if(s)return l;d?(UB(l,bB.HEIGHT,d.height),UB(l,bB.WIDTH,d.width)):i&&(UB(l,bB.HEIGHT,i._videoHeight||0),UB(l,bB.WIDTH,i._videoWidth||0)),u&&UB(l,AB.FRAME_RATE_OUTPUT,u.frameRate);const f=null===(a=i._player)||void 0===a?void 0:a.rendFrameRate.toFixed(0);if(f&&UB(l,AB.FRAME_RATE_RENDER,+f),UB(l,bB.JITTER_BUFFER,c.jitterBufferMs),UB(l,bB.CURRENT_DELAY,c.currentDelayMs),UB(l,bB.FIRS,c.firsCount),UB(l,bB.NACKS,c.nacksCount),UB(l,bB.PLIS,c.plisCount),i){l[bB.DISABLED]=i._originMediaStreamTrack.enabled&&i._mediaStreamTrack.enabled?0:1;const e=i._player;if(e){const{freezeTimeCounterList:t,renderFreezeAccTime:n,videoElementStatus:i}=e;if(t&&t.length>0&&UB(l,AB.FREEZE_TIME,t.splice(0,1)[0]),o&&"visible"===BF.visibility&&i===XU.PLAYING&&fU().supportRequestVideoFrameCallback){const t=Math.min(6e3,n);e.renderFreezeAccTime=Math.max(0,n-t),UB(l,AB.FREEZE_TIME_RENDER,t)}if("number"==typeof c.totalFreezesDuration){const e=p&&p.totalFreezesDuration?c.totalFreezesDuration-p.totalFreezesDuration:c.totalFreezesDuration;UB(l,AB.FREEZE_DURATION,1e3*e)}}}if(l[bB.PLAYER_STATUS]=ZU[i._player?i._player.videoElementStatus:"uninit"],p&&void 0!==c.totalInterFrameDelay&&void 0!==c.totalSquaredInterFrameDelay&&void 0!==p.totalInterFrameDelay&&void 0!==p.totalSquaredInterFrameDelay){const e=c.totalInterFrameDelay-p.totalInterFrameDelay,t=c.totalSquaredInterFrameDelay-p.totalSquaredInterFrameDelay,n=c.framesDecodeCount-p.framesDecodeCount,i=e/n*1e3,r=Math.round(1e3*Math.sqrt((t-Math.pow(e,2)/n)/n));!isNaN(r)&&i+r>Math.max(3*i,i+150)&&(l[bB.I_FRAME_DELAY]=r)}return l}(o._videoSSRC,e,t,o.videoTrack,!0===i,this.needUploadRenderFreezeTime,n):void 0;r&&(a.video=r)}if(s.has(iA.AUDIO)&&o.audioTrack){const i=o.audioTrack?function(e,t,n,i,r){const o=t.audioRecv.find((t=>t.ssrc===e));if(!o)return;const s={},a=n&&n.audioRecv.find((t=>t.ssrc===e)),{receivedFrames:c,droppedFrames:l}=o;var d;if(UB(s,DB.JITTER,o.jitterMs),null!=c&&null!=l&&(s[DB.FREEZE]=0===(d=c)||100*l/d>20?1:0),a){const e=t.timestamp-n.timestamp||(r?LB:LB*MB);null!=o.packets&&null!=a.packets&&UB(s,DB.PACKAGE_RATE,1e3*(o.packets-a.packets)/e),null!=a.bytes&&null!=o.bytes&&UB(s,DB.BITRATE,8*(o.bytes-a.bytes)/e),null!=o.packetsLost&&null!=a.packetsLost&&UB(s,DB.PACKAGE_LOST,o.packetsLost-a.packetsLost)}if(r)return s;const u=100*i._source.getAccurateVolumeLevel(),h=o.outputLevel;if(null!=h){const e=Math.ceil(50*Math.log10(100*h+1));UB(s,PB.LEVEL,e)}if(UB(s,DB.PCM_LEVEL,u),i&&(s[DB.DISABLED]=i._originMediaStreamTrack.enabled&&i._mediaStreamTrack.enabled?0:1),UB(s,DB.JITTER_BUFFER,o.jitterBufferMs),UB(s,DB.CURRENT_DELAY,o.jitterBufferMs),s[DB.PLAYER_STATUS]=ZU[Px.getPlayerState(i.getTrackId())],a){const e=o.concealedSamples-a.concealedSamples;e>0&&UB(s,DB.CONCEALED_SAMPLES,e)}return s}(o._audioSSRC,e,t,o.audioTrack,n):void 0;i&&(a.audio=i)}(a.video||a.audio)&&r.push(a)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,r}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find((e=>e instanceof LV));if(e&&e._external.getDenoiserStats){const t=e._external.getDenoiserStats();t&&this.requestUpload(Cb.DENOISER_STATS,t)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{this.requestAllTracks&&this.requestUpload&&this.requestAllTracks().forEach((e=>{e.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{this.requestUpload&&this.requestRemoteMedia&&(this.requestRemoteMedia()||[]).forEach((e=>{let[t,n]=e;n.has(iA.VIDEO)&&t.videoTrack&&t.videoTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)})),n.has(iA.AUDIO)&&t.audioTrack&&t.audioTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const t=Date.now(),n={connectionInterval:Dw("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:t};let i=[];const r=this.requestAllTracks&&this.requestAllTracks()||[];for(const e of r)!e.muted&&e.enabled&&(i=i.concat(await e.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[e,c]of o)c.has(iA.VIDEO)&&e.videoTrack&&(i=i.concat(await e.videoTrack.getProcessorUsage())),c.has(iA.AUDIO)&&e.audioTrack&&(i=i.concat(await e.audioTrack.getProcessorUsage()));if(0===i.length)return;n.details=function(e,t){const n={};for(const{id:s,value:a,level:c,direction:l}of e){var i;const e=null!==(i=t.get(s))&&void 0!==i?i:0,d=2===a?e+Dw("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var r,o;t.set(s,d),n[s]?(2===a&&(n[s].value=a),c>n[s].level&&(n[s].level=c),"remote"===l&&(n[s].remoteUidCount+=1),n[s].totalTs=null!==(r=t.get(s))&&void 0!==r?r:0):n[s]={value:a,level:c,remoteUidCount:"local"===l?0:1,totalTs:null!==(o=t.get(s))&&void 0!==o?o:0}}return Object.keys(n).map((e=>{const{level:t,value:i,totalTs:r}=n[e];return{id:e,level:t,value:i,totalTs:r}}))}(i,e);const s=Date.now(),a=s>t?s:t+1;this.requestUpload&&this.requestUpload(Cb.EXTENSION_USAGE_STATS,{usageStats:n,sendTs:a})}),Dw("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class jB{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){iT(this,"uid",void 0),iT(this,"_uintid",void 0),iT(this,"_trust_in_room_",!0),iT(this,"_trust_audio_enabled_state_",!0),iT(this,"_trust_video_enabled_state_",!0),iT(this,"_trust_audio_mute_state_",!0),iT(this,"_trust_video_mute_state_",!0),iT(this,"_audio_muted_",!1),iT(this,"_video_muted_",!1),iT(this,"_audio_enabled_",!0),iT(this,"_video_enabled_",!0),iT(this,"_audio_added_",!1),iT(this,"_video_added_",!1),iT(this,"_is_pre_created",!1),iT(this,"_video_pre_subscribed",!1),iT(this,"_audio_pre_subscribed",!1),iT(this,"_trust_video_stream_added_state_",!0),iT(this,"_trust_audio_stream_added_state_",!0),iT(this,"_audioTrack",void 0),iT(this,"_videoTrack",void 0),iT(this,"_dataChannels",[]),iT(this,"_audioSSRC",void 0),iT(this,"_videoSSRC",void 0),iT(this,"_audioOrtc",void 0),iT(this,"_videoOrtc",void 0),iT(this,"_cname",void 0),iT(this,"_rtxSsrcId",void 0),iT(this,"_videoMid",void 0),iT(this,"_audioMid",void 0),this.uid=e,this._uintid=t}}let BB=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});function GB(e,t){var n;let i;switch(t){case sA.LocalAudioTrack:i=Kb.Audio;break;case sA.LocalVideoTrack:i=Pi(n=e._hints).call(n,kU.SCREEN_TRACK)?Kb.Screen:Kb.High;break;case sA.LocalVideoLowTrack:i=Kb.Low}return i}function WB(e){const t=fU();if(e.some((e=>e._bypassWebAudio)))throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function HB(e,t){WB(e);const n=t||new UV;return e.forEach((e=>n.addAudioTrack(e))),n}var KB,zB,qB,YB,JB,XB,QB,ZB,$B,eG,tG,nG;function iG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function rG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?iG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let oG=(KB=sG(BB.SEND_ONLY),zB=sG(BB.SEND_ONLY),qB=sG(),YB=sG(BB.RECEIVE_ONLY),JB=sG(BB.RECEIVE_ONLY),XB=sG(BB.RECEIVE_ONLY),QB=sG(BB.RECEIVE_ONLY),ZB=sG(BB.RECEIVE_ONLY),$B=sG(BB.RECEIVE_ONLY),eG=sG(),tG=sG(BB.RECEIVE_ONLY),nG=class extends vR{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(cA.StateChange,t,this._state)}constructor(e,t){super(),iT(this,"store",void 0),iT(this,"statsUploader",void 0),iT(this,"sendConnection",void 0),iT(this,"recvConnection",void 0),iT(this,"localTrackMap",new Map),iT(this,"remoteUserMap",new Map),iT(this,"localDataChannels",[]),iT(this,"pendingLocalTracks",[]),iT(this,"pendingRemoteTracks",[]),iT(this,"statsCollector",void 0),iT(this,"dtlsFailedCount",0),iT(this,"sendMutex",new hw("P2PChannel2-send-mutex")),iT(this,"recvMutex",new hw("P2PChannel2-recv-mutex")),iT(this,"_state",aA.Disconnected),iT(this,"_restartStates",["disconnected","failed"]),iT(this,"reconnectInterval",void 0),iT(this,"uploadUnplinkStarted",!1),iT(this,"uploadDownlinkStarted",!1),iT(this,"uplinkStateUploadInterval",void 0),iT(this,"downlinkStatsUploadInterval",void 0),iT(this,"handleMuteLocalTrack",(async(e,t,n)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==aA.Connected)return void n(new nR(tR.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const i=this.filterTobeMutedTracks(e);if(0===i.length)return void t();const s=i.find((e=>"videoLowTrack"===e[0]));s&&s[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(i.map((e=>{let[,{id:t}]=e;return t})));let a=!1;var r,o;a="video"===e.trackMediaType?!(null===(r=this.localTrackMap.get(sA.LocalAudioTrack))||void 0===r||!r.track._muted):void 0===(null===(o=this.localTrackMap.get(sA.LocalVideoTrack))||void 0===o?void 0:o.id);const c=this.createMuteMessage(i);await MR(this,cA.RequestMuteLocal,c);const l="video"===e.trackMediaType?TA.MUTE_LOCAL_VIDEO:TA.MUTE_LOCAL_AUDIO;await MR(this,cA.RequestP2PMuteLocal,{action:l,message:c,isMuteAll:a}),t()}catch(e){n(e)}finally{i()}})),iT(this,"handleUnmuteLocalTrack",(async(e,t,n)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==aA.Connected)return void n(new nR(tR.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const i=this.filterTobeUnmutedTracks(e);if(0===i.length)return void t();await this.sendConnection.unmuteLocal(i.map((e=>{let[,{id:t}]=e;return t})));const r=this.createUnmuteMessage(i),o="video"===e.trackMediaType?TA.UNMUTE_LOCAL_VIDEO:TA.UNMUTE_LOCAL_AUDIO;await MR(this,cA.RequestP2PMuteLocal,{action:o,message:r}),t()}catch(e){n(e)}finally{i()}})),iT(this,"handleUpdateVideoEncoder",(async(e,t,n)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const n=this.localTrackMap.get(sA.LocalVideoTrack);if(!this.sendConnection||!n||n.track!==e||this.state!==aA.Connected)return void t();const{id:i,track:r}=n;i&&(await this.sendConnection.updateSendParameters(i,r),await this.sendConnection.updateEncoderConfig(i,r),this.emit(cA.UpdateVideoEncoder,r)),t()}catch(e){n(e)}finally{i()}})),iT(this,"handleUpdateVideoSendParameters",(async(e,t,n)=>{const i=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const n=this.localTrackMap.get(sA.LocalVideoTrack);if(!this.sendConnection||!n||n.track!==e||this.state!==aA.Connected)return void t();const{id:i,track:r}=n;i&&await this.sendConnection.updateSendParameters(i,r),t()}catch(e){n(e)}finally{i()}})),iT(this,"handleReplaceTrack",(async(e,t,n,i)=>{let r;Qw.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof i&&i||(r=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var o;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(!this.sendConnection||!n||void 0===n[1].id||this.state!==aA.Connected)return void t();if(await(null===(o=this.sendConnection)||void 0===o?void 0:o.replaceTrack(e,n[1].id)),n[0]===sA.LocalVideoTrack&&fU().supportDualStreamEncoding){const t=this.localTrackMap.get(sA.LocalVideoLowTrack);if(t){const n=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=n,t.track._originMediaStreamTrack=n,await new Gh(((e,n)=>{this.handleReplaceTrack(t.track,e,n,!0)}))}}t()}catch(e){n(e)}finally{var s;null===(s=r)||void 0===s||s()}})),iT(this,"handleGetLocalVideoStats",(e=>{e(this.statsCollector.getLocalVideoTrackStats())})),iT(this,"handleGetLocalAudioStats",(e=>{e(this.statsCollector.getLocalAudioTrackStats())})),iT(this,"handleGetRemoteVideoStats",(e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid])),iT(this,"handleGetRemoteAudioStats",(e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid])),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new FB(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((e=>{e&&("disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))}))}),Dw("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new nR(tR.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,t,n,i,r,o){throw new nR(tR.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let n;try{if(t){this.recvConnection&&(Qw.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new SB(e,this.store,wb.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const i=await this.recvConnection.establish(t);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=aA.New,this.sendConnection&&(Qw.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new SB(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const t=await this.sendConnection.establish();return{iceParameters:t.iceParameters,dtlsParameters:t.dtlsParameters,sdp:t.sdp}}}finally{n&&n()}}async p2pConnect(e){if(!this.sendConnection)throw new nR(tR.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=aA.Connected}async addRemoteCandidate(e,t){if(t===wb.RECEIVE_ONLY){if(!this.sendConnection)throw new nR(tR.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new nR(tR.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,n){var i=this;return pj((function*(){const r=yield rj(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==aA.Connected){i.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===i.pendingLocalTracks.indexOf(e)));return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(t))}i.store.pubId=i.store.pubId+1,nj.markPublishStart(i.store.clientId,i.store.pubId);const r=i.filterTobePublishedTracks(e,t,n);if(0===r.length)return void(yield rj(i.tryToUnmuteAudio(e)));r.forEach((e=>{let{track:t,type:n}=e;const r=Date.now();i.store.publish(t.getTrackId(),n===sA.LocalAudioTrack?"audio":"video",r)})),i.bindLocalTrackEvents(r);const o=yield rj(i.sendConnection.send(r.map((e=>{let{track:t}=e;return t})),i.store.codec,i.store.audioCodec)),s=(yield rj(o.next())).value,a=i.createGatewayPublishMessage(r,s);try{yield a}catch(e){throw o.throw(e),(null==e?void 0:e.code)===tR.WS_ABORT&&r.forEach((e=>{let{track:t}=e;-1===i.pendingLocalTracks.indexOf(t)&&i.pendingLocalTracks.push(t)})),i.unbindLocalTrackEvents(r),e}yield rj(o.next()),r.forEach((e=>{let{type:t}=e;i.statsCollector.addLocalStats(t)})),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(r,s),r.forEach((e=>{let{track:t,type:n}=e;const r=Date.now();i.store.publish(t.getTrackId(),n===sA.LocalAudioTrack?"audio":"video",void 0,r)})),i.startUploadUplinkState()}finally{r()}}))()}async unpublish(e){if(!this.sendConnection||this.state!==aA.Connected)return void(0===e.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((t=>!Pi(e).call(e,t))));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const n=t.find((e=>"videoLowTrack"===e[0]));n&&n[1].track.close();const i=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:n}]=e;return{type:t,track:n}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===aA.Connected)return n&&n[1].track.close(),i;e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const e=[],t=[];Array.from(this.localTrackMap.entries()).forEach((n=>{let[i,{track:r,ssrcs:o}]=n;const s={stream_type:GB(r,i),ssrcs:o};r._muted||!r._enabled?e.push(s):t.push(s)})),e.length>0&&e.forEach((e=>{MR(this,cA.RequestMuteLocal,[e])})),t.length>0&&t.forEach((e=>{MR(this,cA.RequestUnmuteLocal,[e])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return pj((function*(){throw new nR(tR.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(Qw.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await LR(this,cA.RequestRePublish,this.pendingLocalTracks),this.emit(cA.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new nR(tR.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,n,i){var r;if(!this.recvConnection)throw new nR(tR.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(r=this.remoteUserMap.get(e))&&void 0!==r&&r.has(t))return;const{track:o,mid:s,transceiver:a}=await this.recvConnection.receive(t,[{ssrcId:n}],String(e.uid),i);t===iA.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new jF(o,e.uid,e._uintid,this.store),Qw.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),a&&e._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new FF(o,e.uid,e._uintid,this.store),Qw.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),a&&e._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._videoTrack));const c=this.remoteUserMap.get(e);c?c.set(t,s):this.remoteUserMap.set(e,new Map([[t,s]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const l=this.pendingRemoteTracks.findIndex((n=>{let{user:i,kind:r}=n;return i.uid===e.uid&&t===r}));-1!==l&&(this.pendingRemoteTracks.splice(l,1),this.emit(cA.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,n,i){if(!this.recvConnection)throw new nR(tR.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:n}],String(e.uid),i)}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter((n=>{let{user:i,kind:r}=n;return void 0!==t?i.uid===e.uid&&t===r:i.uid===e.uid}));if(i.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.recvConnection||n||i.forEach((t=>{let{kind:n}=t;var i;if(n===iA.AUDIO)null===(i=e._audioTrack)||void 0===i||i._destroy(),e._audioTrack=void 0;else if(n===iA.VIDEO){var r;null===(r=e._videoTrack)||void 0===r||r._destroy(),e._videoTrack=void 0}})),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(e,t);0!==r.length&&(await this.recvConnection.stopReceiving(r.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawRemoteTracks(r),0===this.remoteUserMap.size&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach((e=>{let[t,{kind:i}]=e;var r,o;if(i===iA.VIDEO&&t._videoSSRC&&(null===(r=this.recvConnection)||void 0===r||r.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),i===iA.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),n||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(i===iA.AUDIO){var s;this.unbindRemoteTrackEvents(t._audioTrack),n||(null===(s=t._audioTrack)||void 0===s||s._destroy(),t._audioTrack=void 0)}})),r.forEach((e=>{let[,{kind:t}]=e;MR(this,cA.RequestP2PMuteRemote,t)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((e=>{let[,t]=e;[iA.VIDEO,iA.AUDIO].forEach((e=>{t.has(e)?MR(this,cA.RequestP2PUnmuteRemote,e):MR(this,cA.RequestP2PMuteRemote,e)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new nR(tR.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new nR(tR.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new nR(tR.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new nR(tR.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void Qw.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void Qw.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===iA.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==i&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);n?n.get(t)||Qw.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,".")):Qw.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."))}getAllTracks(e){const t=this.localTrackMap.get(sA.LocalAudioTrack);if((null==t?void 0:t.track)instanceof UV){const n=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==sA.LocalAudioTrack})).filter((t=>{let[n]=t;return!(e&&n===sA.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[n]=t;return!(e&&n===sA.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}reportPublishEvent(e,t,n,i,r){if(e){const n=this.localTrackMap.get(sA.LocalAudioTrack),o=i?this.localTrackMap.get(sA.LocalVideoLowTrack):this.localTrackMap.get(sA.LocalVideoTrack);oI.publish(this.store.sessionId,{eventElapse:nj.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==o?void 0:o.track.getTrackLabel(),screenshare:-1!==(null==o?void 0:o.track._hints.indexOf(kU.SCREEN_TRACK)),audio:!!n,video:!!o,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const s=n.find((e=>e instanceof kV)),a=i?null===(o=this.localTrackMap.get(sA.LocalVideoTrack))||void 0===o?void 0:o.track:n.find((e=>e instanceof CF));oI.publish(this.store.sessionId,{eventElapse:nj.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==s?void 0:s.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(kU.SCREEN_TRACK)),audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===iA.VIDEO?n._videoSSRC:n._audioSSRC;r&&oI.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===iA.VIDEO,audio:i===iA.AUDIO,peerid:n.uid,subscribeRequestid:i===iA.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:nj.measureFromSubscribeStart(this.store.clientId,r)})}reset(){Qw.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new hw("P2PChannel2-send-mutex"),this.sendMutex=new hw("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(sA.LocalAudioTrack);if((null==e?void 0:e.track)instanceof UV){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=aA.Disconnected}getStats(e){var t,n;return e?null===(n=this.recvConnection)||void 0===n?void 0:n.getStats():null===(t=this.sendConnection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.recvConnection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(sA.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(sA.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof CF||t&&t.track instanceof kV?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(df(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(sA.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=sm(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(Qw.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=aA.Reconnecting,Dw("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&(null===(n=t._videoTrack._player.getVideoElement())||void 0===n||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[n,{track:i}]=e;switch(n){case sA.LocalVideoTrack:Pi(t=i._hints).call(t,kU.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case sA.LocalAudioTrack:i instanceof UV?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case sA.LocalVideoLowTrack:}})),this.emit(cA.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;Array.from(df(n).call(n)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(cA.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),Qw.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof jB?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let n,i;if(e===wb.SEND_ONLY){if(!this.sendConnection)throw new nR(tR.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection}else{if(!this.recvConnection)throw new nR(tR.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection}try{if(t){const e=await i.restartICE(t);return i.isInRestartIce=!1,e}{const e=await i.restartICE();if(e){const t=await LR(this,cA.RequestP2PRestartICE,{direction:wb.RECEIVE_ONLY,iceParameter:e});await i.restartICE(t),i.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(sA.LocalVideoTrack),n=this.localTrackMap.get(sA.LocalAudioTrack),i=e.videoSend.find((e=>{var n;return e.ssrc===(null==t||null===(n=t.ssrcs)||void 0===n?void 0:n[0].ssrcId)})),r=e.audioSend.find((e=>{var t;return e.ssrc===(null==n||null===(t=n.ssrcs)||void 0===t?void 0:t[0].ssrcId)}));if(!i||!r)return 1;const o=UR(this,cA.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,l=(c&&o?(c+o)/2:c||o)||0,d=100*e.sendPacketLossRate*.7/50+.3*l/1500,u=d<.17?1:d<.36?2:d<.59?3:d<.1?4:5,h=null==t?void 0:t.track;if(h&&h._encoderConfig&&-1===h._hints.indexOf(kU.SCREEN_TRACK)){const t=h._encoderConfig.bitrateMax,n=e.bitrate.actualEncoded;if(t&&n){const e=(1e3*t-n)/(1e3*t);return cI[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,o=i._videoSSRC,s=e.audioRecv.find((e=>e.ssrc===r)),a=e.videoRecv.find((e=>e.ssrc===o));if(!s&&!a)return void(t+=1);const c=UR(this,cA.NeedSignalRTT),l=e.rtt,d=(l&&c?(l+c)/2:l||c)||0,u=s?s.jitterMs:void 0,h=e.recvPacketLossRate;let p=.7*h*100/50+.3*d/1500;u&&(p=.6*h*100/50+.2*d/1500+.2*u/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Gh(((t,n)=>{this.handleMuteLocalTrack(e,t,n)}))}filterTobePublishedTracks(e,t,n){const i=[],r=fU(),o=this.getAllTracks();e=jR(e=e.filter((e=>-1===o.indexOf(e))));let s=!1,a=!1;for(const c of e){if(c instanceof CF&&(this.localTrackMap.has(sA.LocalVideoTrack)||s?new nR(tR.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:sA.LocalVideoTrack}),s=!0),t)){const e=this.getLowVideoTrack(c,n);i.push({track:e,type:sA.LocalVideoLowTrack})}if(c instanceof kV){const e=this.localTrackMap.get(sA.LocalAudioTrack);if(e){if(!(e.track instanceof UV))throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const e=i.find((e=>{let{type:t}=e;return t===sA.LocalAudioTrack}));if(!(e.track instanceof UV))throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof UV||c._bypassWebAudio)i.push({track:c,type:sA.LocalAudioTrack});else{const e=new UV;e.addAudioTrack(c),i.push({track:e,type:sA.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=jR(e=e.filter((e=>-1!==n.indexOf(e))));for(const i of e){if(i instanceof kV){const e=this.localTrackMap.get(sA.LocalAudioTrack);if(!e)continue;e.track instanceof UV?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([sA.LocalAudioTrack,e]),e.track.close())):t.push([sA.LocalAudioTrack,e])}if(i instanceof CF){const e=this.localTrackMap.get(sA.LocalVideoTrack);if(!e)continue;t.push([sA.LocalVideoTrack,e]);const n=this.localTrackMap.get(sA.LocalVideoLowTrack);n&&t.push([sA.LocalVideoLowTrack,n])}}return t}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:n}=e;switch(n){case sA.LocalVideoTrack:t.addListener(PU.GET_STATS,this.handleGetLocalVideoStats),t.addListener(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(PU.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(PU.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.addListener(PU.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case sA.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case sA.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof UV?e.trackList.forEach((e=>{e.addListener(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(PU.GET_STATS,this.handleGetLocalAudioStats),e.addListener(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(PU.GET_STATS,this.handleGetLocalAudioStats),e.addListener(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(PU.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:n}]=e;return{track:n,type:t}}))),e.forEach((e=>{let{track:t,type:n}=e;switch(n){case sA.LocalVideoTrack:t.off(PU.GET_STATS,this.handleGetLocalVideoStats),t.off(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(PU.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(PU.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.off(PU.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case sA.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case sA.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof UV?e.trackList.forEach((e=>{e.off(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(PU.GET_STATS,this.handleGetLocalAudioStats),e.off(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(PU.GET_STATS,this.handleGetLocalAudioStats),e.off(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(PU.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof FF&&t.addListener(PU.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof jF&&t.addListener(PU.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(PU.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;n.has(iA.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(iA.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,n)=>{var i;let r,{track:o,type:s}=e;switch(s){case sA.LocalAudioTrack:r=Kb.Audio;break;case sA.LocalVideoTrack:r=Pi(i=o._hints).call(i,kU.SCREEN_TRACK)?Kb.Screen:Kb.High;break;case sA.LocalVideoLowTrack:r=Kb.Low}return{kind:s===sA.LocalAudioTrack?iA.AUDIO:iA.VIDEO,stream_type:r,mid:t[n].id,ssrcs:t[n].localSSRC,isMuted:o.muted||!o.enabled}}))}createGatewayUnpublishMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case sA.LocalVideoTrack:n=Pi(t=r._hints).call(t,kU.SCREEN_TRACK)?Kb.Screen:Kb.High;break;case sA.LocalAudioTrack:n=Kb.Audio;break;case sA.LocalVideoLowTrack:n=Kb.Low}return{stream_type:n,ssrcs:o,mid:s}}))}assignLocalTracks(e,t){e.forEach(((e,n)=>{let{track:i,type:r}=e;this.localTrackMap.set(r,{track:i,id:t[n].id,ssrcs:t[n].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{var n;Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(cA.PeerConnectionStateChange,t),"connected"!==t||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===t&&(e.isInRestartIce=!1),Pi(n=this._restartStates).call(n,t)&&!e.isInRestartIce&&("disconnected"===t&&await $R(800),"disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),oI.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:CR.TRACER}).onSuccess(),this.emit(cA.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{var t;const n=Array.from(df(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var i;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),null===(i=n.audioTrack)||void 0===i||i.emit(FU.FIRST_FRAME_DECODED),oI.firstRemoteFrame(this.store.sessionId,tI.FIRST_AUDIO_DECODE,nI.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:nj.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{var t;const n=Array.from(df(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));n&&oI.firstRemoteFrame(this.store.sessionId,tI.FIRST_AUDIO_RECEIVED,nI.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:nj.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,n)=>{this.reportVideoFirstFrameDecoded(e,t,n)},e.onFirstVideoReceived=e=>{var t;const n=Array.from(df(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));n&&oI.firstRemoteFrame(this.store.sessionId,tI.FIRST_VIDEO_RECEIVED,nI.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:nj.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,t)=>{const n="relay"===e.candidateType,i="relay"===t.candidateType;"unknown"!==t.candidateType&&n===i||this.emit(cA.ConnectionTypeChange,n),Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ZA(t))," -> ").concat(JSON.stringify(ZA(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,t)=>{Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ZA(t))," -> ").concat(JSON.stringify(ZA(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(cA.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===wb.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,Qw.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===wb.SEND_ONLY?this.restartICE(e):LR(this,cA.RequestP2PRestartICE,{direction:wb.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const n=this.localTrackMap.get(sA.LocalAudioTrack);if(e instanceof kV&&(null==n?void 0:n.track)instanceof UV)return n.track.isActive||t.push([sA.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(i&&(t.push(i),i[0]===sA.LocalVideoTrack)){const e=this.localTrackMap.get(sA.LocalVideoLowTrack);e&&t.push([sA.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(sA.LocalAudioTrack);if(e instanceof kV&&(null==n?void 0:n.track)instanceof UV)return n.track.isActive&&t.push([sA.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(i)if(i[0]===sA.LocalVideoTrack){t.push(i);const e=this.localTrackMap.get(sA.LocalVideoLowTrack);e&&t.push([sA.LocalVideoLowTrack,e])}else t.push(i);return t}createMuteMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case sA.LocalAudioTrack:n=Kb.Audio;break;case sA.LocalVideoTrack:n=Pi(t=r._hints).call(t,kU.SCREEN_TRACK)?Kb.Screen:Kb.High;break;case sA.LocalVideoLowTrack:n=Kb.Low}return{stream_type:n,ssrcs:o,mid:s}}))}createUnmuteMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case sA.LocalAudioTrack:n=Kb.Audio;break;case sA.LocalVideoTrack:n=Pi(t=r._hints).call(t,kU.SCREEN_TRACK)?Kb.Screen:Kb.High;break;case sA.LocalVideoLowTrack:n=Kb.Low}return{stream_type:n,ssrcs:o,mid:s}}))}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach((t=>{let[i,r]=t;n.push([e,{kind:i,id:r}])}));return n}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[n,{kind:i,id:r}]=e;switch(i){case iA.VIDEO:return void(n._videoSSRC&&t.push({stream_type:iA.VIDEO,ssrcId:n._videoSSRC}));case iA.AUDIO:return void(n._audioSSRC&&t.push({stream_type:iA.AUDIO,ssrcId:n._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:n}]=e;const i=this.remoteUserMap.get(t);i&&(i.delete(n),0===Array.from(i.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(sA.LocalVideoTrack),n=this.localTrackMap.get(sA.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),n&&e.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return"connected"!==e&&"connected"!==t}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof kV){const n=this.filterTobeUnmutedTracks(e[t]);if(0===n.length)continue;const i=this.createUnmuteMessage(n);return void await MR(this,cA.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.recvConnection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(cA.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(cA.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await $R(mw(this.dtlsFailedCount,fw)),this.emit(cA.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(sA.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof CF))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof CF)).length>1)throw new nR(tR.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof kV)).length>1&&(e.some((e=>e instanceof kV&&e._bypassWebAudio))||!fU().webAudioMediaStreamDest))throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof CF&&this.pendingLocalTracks.some((e=>e instanceof CF)))throw new nR(tR.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof kV&&this.pendingLocalTracks.some((e=>e instanceof kV))&&(!fU().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof kV&&e._bypassWebAudio))))throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const n=!Dw("DISABLE_DUAL_STREAM_USE_ENCODING")&&fU().supportDualStreamEncoding,i=rG(rG({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=n?e._mediaStreamTrack.clone():CB(e,i);const o=ew(8,"track-low-"),s=new CF(r,rG(rG({},n&&{scaleResolutionDownBy:QA(i,e)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(xU.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,LU.LOW_STREAM)})),s._hints.push(kU.LOW_STREAM),e.addListener(PU.NEED_CLOSE,(()=>{s.close()})),s}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,n,i){var r;const o=Array.from(df(r=this.remoteUserMap).call(r)).find((t=>t._videoSSRC===e));if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const r=this.store.keyMetrics,s=r.subscribe.find((e=>e.userId===o.uid&&"video"===e.type));oI.firstRemoteVideoDecode(this.store.sessionId,tI.FIRST_VIDEO_DECODE,nI.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:t,videoheight:n,subscribeElapse:nj.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:r.requestAPEnd||0,apStart:r.requestAPStart||0,joinGwEnd:r.joinGatewayEnd||0,joinGwStart:r.joinGatewayStart||0,pcEnd:r.peerConnectionEnd||0,pcStart:r.peerConnectionStart||0,subscriberEnd:(null==s?void 0:s.subscribeEnd)||0,subscriberStart:(null==s?void 0:s.subscribeStart)||0,videoAddNotify:(null==s?void 0:s.streamAdded)||0,state:i?1:0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.recvConnection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const o=await this.recvConnection.getRemoteSSRC(r);return void 0!==o&&o!==n}resetConnection(e){Qw.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===aA.Connected?(Qw.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new nR(tR.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new nR(tR.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new nR(tR.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new nR(tR.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new nR(tR.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new nR(tR.NOT_SUPPORTED)}async preConnect(e,t,n,i,r,o){throw new nR(tR.NOT_SUPPORTED)}getEstablishParams(){throw new nR(tR.NOT_SUPPORTED)}async reSubscribe(e){throw new nR(tR.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new nR(tR.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:n}]=e;t===sA.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,LU.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}},ib(nG.prototype,"p2pConnect",[KB],Object.getOwnPropertyDescriptor(nG.prototype,"p2pConnect"),nG.prototype),ib(nG.prototype,"unpublish",[zB],Object.getOwnPropertyDescriptor(nG.prototype,"unpublish"),nG.prototype),ib(nG.prototype,"unpublishLowStream",[qB],Object.getOwnPropertyDescriptor(nG.prototype,"unpublishLowStream"),nG.prototype),ib(nG.prototype,"subscribe",[YB],Object.getOwnPropertyDescriptor(nG.prototype,"subscribe"),nG.prototype),ib(nG.prototype,"mockSubscribe",[JB],Object.getOwnPropertyDescriptor(nG.prototype,"mockSubscribe"),nG.prototype),ib(nG.prototype,"unsubscribe",[XB],Object.getOwnPropertyDescriptor(nG.prototype,"unsubscribe"),nG.prototype),ib(nG.prototype,"muteRemote",[QB],Object.getOwnPropertyDescriptor(nG.prototype,"muteRemote"),nG.prototype),ib(nG.prototype,"unmuteRemote",[ZB],Object.getOwnPropertyDescriptor(nG.prototype,"unmuteRemote"),nG.prototype),ib(nG.prototype,"hasRemoteMediaWithLock",[$B],Object.getOwnPropertyDescriptor(nG.prototype,"hasRemoteMediaWithLock"),nG.prototype),ib(nG.prototype,"disconnectForReconnect",[eG],Object.getOwnPropertyDescriptor(nG.prototype,"disconnectForReconnect"),nG.prototype),ib(nG.prototype,"remoteMediaSsrcChanged",[tG],Object.getOwnPropertyDescriptor(nG.prototype,"remoteMediaSsrcChanged"),nG.prototype),nG);function sG(e){return function(t,n,i){const r=t[n];if("function"!=typeof r)throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];switch(e){case BB.SEND_ONLY:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,i)}finally{e()}}case BB.RECEIVE_ONLY:{const e=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,i)}finally{e()}}default:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(n)),t=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,i)}finally{e(),t()}}}},i}}function aG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function cG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?aG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):aG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class lG{constructor(e){iT(this,"store",void 0),iT(this,"onStatsException",void 0),iT(this,"onUploadPublishDuration",void 0),iT(this,"onStatsChanged",void 0),iT(this,"localStats",new Map),iT(this,"remoteStats",new Map),iT(this,"updateStatsInterval",void 0),iT(this,"trafficStats",void 0),iT(this,"trafficStatsPeerList",[]),iT(this,"uplinkStats",void 0),iT(this,"exceptionMonitor",void 0),iT(this,"p2pChannel",void 0),iT(this,"scalabilityMode",pb.L1T1),iT(this,"updateStats",(()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))})),this.store=e,this.exceptionMonitor=new ej,this.exceptionMonitor.on("exception",((e,t,n)=>{this.onStatsException&&this.onStatsException(e,t,n)}))}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(sA.LocalAudioTrack)||cG({},BU)}getLocalVideoTrackStats(){return this.localStats.get(sA.LocalVideoTrack)||cG({},GU)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const n=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return n&&(t.publishDuration=n.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},n={};if(e){var i;const r=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.audioStats;r&&(n[e]=t(e,r))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{audioStats:r}]=e;r&&(n[i]=t(i,r))}));return n}getRemoteNetworkQualityStats(e){const t={};if(e){var n;const i=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.networkStats;i&&(t[e]=i)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{networkStats:i}]=e;i&&(t[n]=i)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const n=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return n&&(t.publishDuration=n.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},n={};if(e){var i;const r=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.videoStats;r&&(n[e]=t(e,r))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{videoStats:r}]=e;r&&(n[i]=t(i,r))}));return n}getRTCStats(){let e=0,t=0,n=0,i=0;const r=this.localStats.get(sA.LocalAudioTrack);r&&(e+=r.sendBytes,t+=r.sendBitrate);const o=this.localStats.get(sA.LocalVideoTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate);const s=this.localStats.get(sA.LocalVideoLowTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:r}=e;t&&(n+=t.receiveBytes,i+=t.receiveBitrate),r&&(n+=r.receiveBytes,i+=r.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:t,SendBytes:e,RecvBytes:n,RecvBitrate:i,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd)),e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const n=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),i=null!=n&&n.videoSSRC?nj.measureFromSubscribeStart(this.store.clientId,n.videoSSRC):0,r=null!=n&&n.audioSSRC?nj.measureFromSubscribeStart(this.store.clientId,n.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,i>r?i:r),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&Qw.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,n){if(!e)return!1;const i=!!n&&t.framesDecodeFreezeTime>n.framesDecodeFreezeTime,r=!n||t.framesDecodeCount>n.framesDecodeCount;return i||!r}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((t=>{let[n,i]=t;switch(n){case sA.LocalVideoTrack:case sA.LocalVideoLowTrack:{const t=i,o=cG({},GU),s=e.getStats(),a=e.getLocalMedia(n);if(s){const n=s.videoSend.find((e=>e.ssrc===(null==a?void 0:a.ssrcs[0].ssrcId)));if(n){const i=e.getLocalVideoSize(),r=e.getEncoderConfig(sA.LocalVideoTrack);"H264"!==n.codec&&"H265"!==n.codec&&"VP8"!==n.codec&&"VP9"!==n.codec&&"AV1X"!==n.codec&&"AV1"!==n.codec||(o.codecType=n.codec),o.sendBytes=n.bytes,o.sendBitrate=t?8*Math.max(0,o.sendBytes-t.sendBytes):0,n.inputFrame?(o.captureFrameRate=n.inputFrame.frameRate,o.captureResolutionHeight=n.inputFrame.height,o.captureResolutionWidth=n.inputFrame.width):i&&(o.captureResolutionWidth=i.width,o.captureResolutionHeight=i.height),n.sentFrame?(o.sendFrameRate=n.sentFrame.frameRate,o.sendResolutionHeight=n.sentFrame.height,o.sendResolutionWidth=n.sentFrame.width):i&&(o.sendResolutionWidth=i.width,o.sendResolutionHeight=i.height),n.avgEncodeMs&&(o.encodeDelay=n.avgEncodeMs),r&&r.bitrateMax&&(o.targetSendBitrate=1e3*r.bitrateMax),o.sendPackets=n.packets,o.sendPacketsLost=n.packetsLost,o.sendJitterMs=n.jitterMs,o.sendRttMs=n.rttMs,o.totalDuration=t?t.totalDuration+1:1,o.totalFreezeTime=t?t.totalFreezeTime:0,this.isLocalVideoFreeze(n)&&(o.totalFreezeTime+=1),n.scalabilityMode&&this.scalabilityMode!==n.scalabilityMode&&(Qw.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(n.scalabilityMode)),this.scalabilityMode=n.scalabilityMode)}this.trafficStats&&(o.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var r;this.localStats.set(n,o),((null==t?void 0:t.sendResolutionWidth)!==o.sendResolutionWidth||(null==t?void 0:t.sendResolutionHeight)!==o.sendResolutionHeight)&&(null===(r=this.onStatsChanged)||void 0===r||r.call(this,"resolution",{width:o.sendResolutionWidth,height:o.sendResolutionHeight})),o&&a&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,a.track,o);break}case sA.LocalAudioTrack:{const t=i,r=cG({},BU),o=e.getStats(),s=e.getLocalMedia(n);if(o){const n=o.audioSend.find((e=>e.ssrc===(null==s?void 0:s.ssrcs[0].ssrcId)));if(n){if("opus"!==n.codec&&"aac"!==n.codec&&"PCMU"!==n.codec&&"PCMA"!==n.codec&&"G722"!==n.codec||(r.codecType=n.codec),n.inputLevel)r.sendVolumeLevel=Math.round(32767*n.inputLevel);else{const t=e.getLocalAudioVolume();t&&(r.sendVolumeLevel=Math.round(32767*t))}r.sendBytes=n.bytes,r.sendPackets=n.packets,r.sendPacketsLost=n.packetsLost,r.sendJitterMs=n.jitterMs,r.sendRttMs=n.rttMs,r.sendBitrate=t?8*Math.max(0,r.sendBytes-t.sendBytes):0}}this.trafficStats&&(r.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(sA.LocalAudioTrack,r),r&&s&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,s.track,r);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{var n,i;let[r,{videoStats:o,audioStats:s,videoPcStats:a}]=t;const c=s,l=o,d=a,u=cG({},WU),h=cG({},KU),p=cG({},HU),{audioTrack:f,videoTrack:m,audioSSRC:_,videoSSRC:E}=e.getRemoteMedia(r);let g;g=e instanceof oG?e.getStats(!0):e.getStats();const v=null===(n=g)||void 0===n?void 0:n.audioRecv.find((e=>e.ssrc===_)),T=null===(i=g)||void 0===i?void 0:i.videoRecv.find((e=>e.ssrc===E)),S=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===r));if(v&&("opus"!==v.codec&&"aac"!==v.codec&&"PCMU"!==v.codec&&"PCMA"!==v.codec&&"G722"!==v.codec||(u.codecType=v.codec),v.outputLevel?u.receiveLevel=Math.round(32767*v.outputLevel):f&&(u.receiveLevel=Math.round(32767*f.getVolumeLevel())),u.receiveBytes=v.bytes,u.receivePackets=v.packets,u.receivePacketsLost=v.packetsLost,u.packetLossRate=u.receivePacketsLost/(u.receivePackets+u.receivePacketsLost),u.receiveBitrate=c?8*Math.max(0,u.receiveBytes-c.receiveBytes):0,u.totalDuration=c?c.totalDuration+1:1,u.totalFreezeTime=c?c.totalFreezeTime:0,u.freezeRate=u.totalFreezeTime/u.totalDuration,u.receiveDelay=v.jitterBufferMs,u.totalDuration>10&&lG.isRemoteAudioFreeze(f)&&(u.totalFreezeTime+=1)),T){"H264"!==T.codec&&"H265"!==T.codec&&"VP8"!==T.codec&&"VP9"!==T.codec&&"AV1X"!==T.codec&&"AV1"!==T.codec||(h.codecType=T.codec),h.receiveBytes=T.bytes,h.receiveBitrate=l?8*Math.max(0,h.receiveBytes-l.receiveBytes):0,h.decodeFrameRate=T.decodeFrameRate<0?0:T.decodeFrameRate,h.renderFrameRate=T.decodeFrameRate<0?0:T.decodeFrameRate,T.outputFrame&&(h.renderFrameRate=T.outputFrame.frameRate),T.receivedFrame?(h.receiveFrameRate=T.receivedFrame.frameRate,h.receiveResolutionHeight=T.receivedFrame.height,h.receiveResolutionWidth=T.receivedFrame.width):m&&(h.receiveResolutionHeight=m._videoHeight||0,h.receiveResolutionWidth=m._videoWidth||0),void 0!==T.framesRateFirefox&&(h.receiveFrameRate=Math.round(T.framesRateFirefox)),h.receivePackets=T.packets,h.receivePacketsLost=T.packetsLost,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.totalDuration=l?l.totalDuration+1:1,h.totalFreezeTime=l?l.totalFreezeTime:0,h.receiveDelay=T.jitterBufferMs||0;const t=!!E&&e.getRemoteVideoIsReady(E);m&&t&&lG.isRemoteVideoFreeze(m,T,d)&&(h.totalFreezeTime+=1),h.freezeRate=h.totalFreezeTime/h.totalDuration}S&&(u.end2EndDelay=S.B_ad,h.end2EndDelay=S.B_vd,u.transportDelay=S.B_ed,h.transportDelay=S.B_ed,u.currentPacketLossRate=S.B_ealr4/100,h.currentPacketLossRate=S.B_evlr4/100,p.uplinkNetworkQuality=S.B_punq?S.B_punq:0,p.downlinkNetworkQuality=S.B_pdnq?S.B_pdnq:0),this.remoteStats.set(r,{audioStats:u,videoStats:h,videoPcStats:T,networkStats:p}),f&&this.exceptionMonitor.setRemoteAudioStats(f,u),m&&this.exceptionMonitor.setRemoteVideoStats(m,h)}))}}function dG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function uG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?dG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):dG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class hG extends vR{constructor(e,t,n,i){super(),iT(this,"spec",void 0),iT(this,"token",void 0),iT(this,"websocket",void 0),iT(this,"pingpongTimer",void 0),iT(this,"reconnectMode","retry"),iT(this,"serviceMode",void 0),iT(this,"reqId",0),iT(this,"commandReqId",0),iT(this,"handleWebSocketOpen",(()=>{this.reconnectMode="retry",this.startPingPong()})),iT(this,"handleWebSocketMessage",(e=>{if(!e.data)return;const t=JSON.parse(e.data);t.requestId?this.emit("@".concat(t.requestId,"-").concat(t.sid),t):this.serviceMode===Nb.INJECT?this.emit(xb.INJECT_STREAM_STATUS,t):(oI.workerEvent(this.spec.sid,{actionType:"status",serverCode:t.code,workerType:this.serviceMode===Nb.TRANSCODE?1:2}),this.emit(xb.PUBLISH_STREAM_STATUS,t))})),this.spec=t,this.token=e,this.serviceMode=i,this.websocket=new FA("live-streaming",n),this.websocket.on(Ib.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Ib.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Ib.REQUEST_NEW_URLS,((e,t)=>{LR(this,xb.REQUEST_NEW_ADDRESS).then(e).catch(t)})),this.websocket.on(Ib.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(e){return this.websocket.init(e)}async request(e,t,n,i){this.reqId+=1,"request"===e&&(this.commandReqId+=1);const r=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new bb(tR.UNEXPECTED_ERROR);const s=uG({command:e,sdkVersion:"4.21.0"===Rw?"0.0.1":Rw,seq:o,requestId:o,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if("closed"===this.websocket.state)throw new bb(tR.WS_DISCONNECT);const a=()=>new Gh(((e,t)=>{this.websocket.once(Ib.CLOSED,(()=>t(new bb(tR.WS_ABORT)))),this.websocket.once(Ib.CONNECTED,e)}));"connected"!==this.websocket.state&&await a(),s.clientRequest&&(s.clientRequest.workerToken=this.token);const c=new Gh(((e,t)=>{const n=()=>{t(new bb(tR.WS_ABORT))};this.websocket.once(Ib.RECONNECTING,n),this.websocket.once(Ib.CLOSED,n),this.once("@".concat(o,"-").concat(this.spec.sid),(t=>{e(t)}))}));i&&oI.workerEvent(this.spec.sid,uG(uG({},i),{},{requestId:r,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));const l=Date.now();this.websocket.sendMessage(s);let d=null;try{d=await c}catch(i){if("closed"===this.websocket.state)throw i;return await a(),await this.request(e,t,n)}return i&&oI.workerEvent(this.spec.sid,uG(uG({},i),{},{requestId:r,actionType:"response",payload:JSON.stringify(d.serverResponse),serverCode:d.code,success:200===d.code,responseTime:Date.now()-l})),200!==d.code&&this.handleResponseError(d),d}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e="4.21.0"===Rw?"0.0.1":Rw;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case Fb.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void Qw.warning("live stream response already exists stream");case Fb.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Fb.LIVE_STREAM_RESPONSE_BAD_STREAM:case Fb.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new bb(tR.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case Fb.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new bb(tR.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Fb.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new bb(tR.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case Fb.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const t=new bb(tR.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(xb.WARNING,t,e.serverResponse.url)}case Fb.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const t=new bb(tR.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(xb.WARNING,t,e.serverResponse.url)}case Fb.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new bb(tR.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Fb.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new bb(tR.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case Fb.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const t=new bb(tR.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(xb.WARNING,t,e.serverResponse.url)}case Fb.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new bb(tR.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case Fb.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new bb(tR.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Fb.LIVE_STREAM_RESPONSE_WORKER_LOST:case Fb.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new bb(tR.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Fb.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;if("UpdateTranscoding"===e.serverResponse.command||"ControlStream"===e.serverResponse.command)return new bb(tR.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new bb(tR.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Fb.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Fb.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Fb.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Fb.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new bb(tR.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(nw)}),6e3)}}function pG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function fG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}class mG extends vR{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:fw,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:fw;super(),iT(this,"onLiveStreamWarning",void 0),iT(this,"onLiveStreamError",void 0),iT(this,"onInjectStatusChange",void 0),iT(this,"spec",void 0),iT(this,"retryTimeout",1e4),iT(this,"connection",void 0),iT(this,"httpRetryConfig",void 0),iT(this,"wsRetryConfig",void 0),iT(this,"streamingTasks",new Map),iT(this,"isStartingStreamingTask",!1),iT(this,"taskMutex",new hw("live-streaming")),iT(this,"cancelToken",pC.CancelToken.source()),iT(this,"transcodingConfig",void 0),iT(this,"injectConfig",fG({},Ub)),iT(this,"injectLoopTimes",0),iT(this,"uapResponse",void 0),iT(this,"lastTaskId",1),iT(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=n,this.wsRetryConfig=t}async setTranscodingConfig(e){const t=fG(fG({},Mb),e);66!==t.videoCodecProfile&&77!==t.videoCodecProfile&&100!==t.videoCodecProfile&&(Qw.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(t.videoCodecProfile," -> 100")),t.videoCodecProfile=100),t.transcodingUsers||(t.transcodingUsers=t.userConfigs),t.transcodingUsers&&(t.transcodingUsers=t.transcodingUsers.map((e=>fG(fG(fG({},Pb),e),{},{zOrder:e.zOrder?e.zOrder+1:1})))),function(e){lR(e.width)||oR(e.width,"config.width",0,1e4),lR(e.height)||oR(e.height,"config.height",0,1e4),lR(e.videoBitrate)||oR(e.videoBitrate,"config.videoBitrate",1,1e6),lR(e.videoFrameRate)||oR(e.videoFrameRate,"config.videoFrameRate"),lR(e.lowLatency)||iR(e.lowLatency,"config.lowLatency"),lR(e.audioSampleRate)||rR(e.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),lR(e.audioBitrate)||oR(e.audioBitrate,"config.audioBitrate",1,128),lR(e.audioChannels)||rR(e.audioChannels,"config.audioChannels",[1,2,3,4,5]),lR(e.videoGop)||oR(e.videoGop,"config.videoGop"),lR(e.videoCodecProfile)||rR(e.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),lR(e.userCount)||oR(e.userCount,"config.userCount",0,17),lR(e.backgroundColor)||oR(e.backgroundColor,"config.backgroundColor",0,16777215),lR(e.userConfigExtraInfo)||aR(e.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),e.transcodingUsers&&!lR(e.transcodingUsers)&&(cR(e.transcodingUsers,"config.transcodingUsers"),e.transcodingUsers.forEach(((e,t)=>{Ob(e.uid),lR(e.x)||oR(e.x,"transcodingUser[".concat(t,"].x"),0,1e4),lR(e.y)||oR(e.y,"transcodingUser[".concat(t,"].y"),0,1e4),lR(e.width)||oR(e.width,"transcodingUser[".concat(t,"].width"),0,1e4),lR(e.height)||oR(e.height,"transcodingUser[".concat(t,"].height"),0,1e4),lR(e.zOrder)||oR(e.zOrder-1,"transcodingUser[".concat(t,"].zOrder"),0,100),lR(e.alpha)||oR(e.alpha,"transcodingUser[".concat(t,"].alpha"),0,1,!1)}))),lR(e.watermark)||Lb(e.watermark,"watermark"),lR(e.backgroundImage)||Lb(e.backgroundImage,"backgroundImage"),e.images&&!lR(e.images)&&(cR(e.images,"config.images"),e.images.forEach(((e,t)=>{Lb(e,"images[".concat(t,"]"))})))}(t);const n=[];t.images&&n.push(...t.images.map((e=>fG(fG(fG({},kb),e),{},{zOrder:255})))),t.backgroundImage&&(n.push(fG(fG(fG({},kb),t.backgroundImage),{},{zOrder:0})),delete t.backgroundImage),t.watermark&&(n.push(fG(fG(fG({},kb),t.watermark),{},{zOrder:255})),delete t.watermark),t.images=n,t.transcodingUsers&&(t.userConfigs=t.transcodingUsers.map((e=>fG({},e))),t.userCount=t.transcodingUsers.length,delete t.transcodingUsers);const i=(t.userConfigs||[]).map((e=>"number"==typeof e.uid?Gh.resolve(e.uid):BO(e.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await Gh.all(i)).forEach(((e,n)=>{t.userConfigs&&t.userConfigs[n]&&(t.userConfigs[n].uid=e)})),this.transcodingConfig=t,this.connection)try{var r;const e=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(hb(r=this.streamingTasks).call(r)).map((e=>e.taskId)).join("#")});Qw.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(e.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(e){if(!e.data||!e.data.retry)throw e;e.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((t=>{Qw.warning("[".concat(this.spec.clientId,"] live streaming receive error"),e.toString(),"try to republish",t.url),this.startLiveStreamingTask(t.url,t.mode,e).then((()=>{Qw.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(t.url," success"))})).catch((e=>{Qw.error("[".concat(this.spec.clientId,"] live streaming republish failed"),t.url,e.toString()),this.onLiveStreamError&&this.onLiveStreamError(t.url,e)}))}))}}setInjectStreamConfig(e,t){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=t}async startLiveStreamingTask(e,t,n){var i;const r=Array.from(hb(i=this.streamingTasks).call(i)).find((e=>e.mode===Nb.INJECT));if(r&&t===Nb.INJECT)return new bb(tR.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&t===Nb.TRANSCODE)throw new bb(tR.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let o={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};Qw.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(t));const s=await this.taskMutex.lock();if(!this.connection&&n)return void s();if(this.streamingTasks.get(e)&&!n)return s(),new bb(tR.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(t))}catch(e){throw s(),e}switch(t){case Nb.TRANSCODE:o.transcodingConfig=fG({},this.transcodingConfig);break;case Nb.RAW:break;case Nb.INJECT:o={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(o.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const i=new Gh(((t,i)=>{$R(this.retryTimeout).then((()=>{if(n)return i(n);const t=this.statusError.get(e);return t?(this.statusError.delete(e),i(t)):void 0}))})),r=await Gh.race([this.connection.request("request",{clientRequest:o},!0,{url:e,command:"PublishStream",workerType:t===Nb.TRANSCODE?1:2,requestByUser:!n,tid:a.toString()}),i]);this.isStartingStreamingTask=!1,Qw.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(r.code)),this.streamingTasks.set(e,{clientRequest:o,mode:t,url:e,taskId:a}),s()}catch(i){if(s(),this.isStartingStreamingTask=!1,!i.data||!i.data.retry||n)throw i;return i.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,t,i)):await this.startLiveStreamingTask(e,t,i)}}stopLiveStreamingTask(e){return new Gh(((t,n)=>{const i=this.streamingTasks.get(e);if(!i||!this.connection)return new bb(tR.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const r=i.mode;i.abortTask=()=>{Qw.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),t()},this.connection.request("request",{clientRequest:{command:r===Nb.INJECT?"UninjectStream":"UnpublishStream",url:i.url}},!1,{url:e,command:"UnPublishStream",workerType:r===Nb.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((n=>{Qw.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(n.code)),this.streamingTasks.delete(e),0===this.streamingTasks.size&&r!==Nb.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),t(),r===Nb.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(Db.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)})).catch(n)}))}async controlInjectStream(e,t,n,i){const r=this.streamingTasks.get(e);if(!r||!this.connection||r.mode!==Nb.INJECT)throw new bb(tR.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:t,audioVolume:n,position:i}})).serverResponse}resetAllTask(){var e;const t=Array.from(hb(e=this.streamingTasks).call(e));this.terminate();for(const n of t)this.startLiveStreamingTask(n.url,n.mode).catch((e=>{this.onLiveStreamError&&this.onLiveStreamError(n.url,e)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=pC.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new bb(tR.UNEXPECTED_ERROR,"live streaming connection has already connected");const t=await LR(this,Vb.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new hG(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(xb.WARNING,((e,t)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e))),this.connection.on(xb.PUBLISH_STREAM_STATUS,(e=>this.handlePublishStreamServer(e))),this.connection.on(xb.INJECT_STREAM_STATUS,(e=>this.handleInjectStreamServerStatus(e))),this.connection.on(xb.REQUEST_NEW_ADDRESS,((t,n)=>{if(!this.connection)return n(new bb(tR.UNEXPECTED_ERROR,"can not get new live streaming address list"));LR(this,Vb.REQUEST_WORKER_MANAGER_LIST,e).then((e=>{this.uapResponse=e,t(e.addressList)})).catch(n)})),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(e){const t=e.serverStatus&&e.serverStatus.url||"empty_url",n=this.streamingTasks.get(t),i=e.reason;switch(e.code){case Fb.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Fb.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Fb.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Fb.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const i=new bb(tR.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(n)return Qw.error(i.toString()),this.onLiveStreamError&&this.onLiveStreamError(t,i);if(!this.isStartingStreamingTask)return;this.statusError.set(t,i)}case Fb.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new bb(tR.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,i);return this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e)}case Fb.LIVE_STREAM_RESPONSE_WORKER_LOST:case Fb.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var r;if(!this.connection)return;this.connection.tryNextAddress();const t=Array.from(hb(r=this.streamingTasks).call(r));for(const n of t)n.abortTask?n.abortTask():(Qw.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",n.url),this.startLiveStreamingTask(n.url,n.mode,new bb(tR.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then((()=>{Qw.debug("[".concat(this.spec.clientId,"] republish live stream success"),n.url)})).catch((e=>{Qw.error(e.toString()),this.onLiveStreamError&&this.onLiveStreamError(n.url,e)})));return}}}handleInjectStreamServerStatus(e){const t=Number(e.uid),n=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(Db.INJECT_STREAM_STATUS_START_SUCCESS,t,n));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(Db.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,t,n),void this.streamingTasks.delete(n);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(Db.INJECT_STREAM_STATUS_START_UNAUTHORIZED,t,n),void this.streamingTasks.delete(n);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(Db.INJECT_STREAM_STATUS_BROKEN,t,n),void this.streamingTasks.delete(n);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(Db.INJECT_STREAM_STATUS_START_TIMEOUT,t,n),void this.streamingTasks.delete(n);default:return void Qw.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class _G{constructor(){iT(this,"destChannelMediaInfos",new Map),iT(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){jb(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){jb(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){Ab(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function EG(e){if(!(e instanceof _G))return new bb(tR.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),n=e.getDestChannelMediaInfo();return t?0===n.size?new bb(tR.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw():void 0:new bb(tR.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}class gG extends vR{constructor(e,t,n){super(),iT(this,"ws",void 0),iT(this,"requestId",1),iT(this,"heartBeatTimer",void 0),iT(this,"joinInfo",void 0),iT(this,"clientId",void 0),iT(this,"onOpen",(()=>{this.emit("open"),this.startHeartBeatCheck()})),iT(this,"onClose",(e=>{this.emit("close"),this.dispose()})),iT(this,"onMessage",(e=>{const t=JSON.parse(e.data);if(!t||"serverResponse"!==t.command||!t.requestId)return t&&"serverStatus"===t.command&&t.serverStatus&&t.serverStatus.command?(this.emit("status",t.serverStatus),void this.emit(t.serverStatus.command,t.serverStatus)):void 0;this.emit("req_".concat(t.requestId),t)})),this.joinInfo=e,this.clientId=t,this.ws=new FA("cross-channel-".concat(this.clientId),n),this.ws.on(Ib.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(Ib.CONNECTED,this.onOpen),this.ws.on(Ib.ON_MESSAGE,this.onMessage),this.ws.on(Ib.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new Gh(((t,n)=>{const i=window.setTimeout((()=>{n(new bb(tR.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(r=>{window.clearTimeout(i),r.state&&0!==r.state?n(new bb(tR.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)})),this.once("dispose",(()=>{window.clearTimeout(i),n(new bb(tR.WS_ABORT))}))}))}async request(e){if("closed"===this.ws.state)throw new bb(tR.WS_DISCONNECT);const t=()=>new Gh(((e,t)=>{this.ws.once(Ib.CLOSED,(()=>t(new bb(tR.WS_ABORT)))),this.ws.once(Ib.CONNECTED,e)}));"connected"!==this.ws.state&&await t();const n=this.sendMessage(e),i=new Gh(((e,t)=>{const i=()=>{t(new bb(tR.WS_ABORT))};this.ws.once(Ib.RECONNECTING,i),this.ws.once(Ib.CLOSED,i),this.once("req_".concat(n),e),$R(3e3).then((()=>{this.removeAllListeners("req_".concat(n)),this.ws.off(Ib.RECONNECTING,i),this.ws.off(Ib.CLOSED,i),t(new bb(tR.TIMEOUT,"cross channel ws request timeout"))}))})),r=await i;if(!r||200!==r.code)throw new bb(tR.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(r)));return r}async connect(e){this.ws.removeAllListeners(Ib.REQUEST_NEW_URLS),this.ws.on(Ib.REQUEST_NEW_URLS,(t=>{t(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class vG extends vR{set state(e){e!==this._state&&(e!==Wb.RELAY_STATE_FAILURE&&(this.errorCode=Hb.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,t,n,i,r){super(),iT(this,"joinInfo",void 0),iT(this,"sid",void 0),iT(this,"clientId",void 0),iT(this,"cancelToken",pC.CancelToken.source()),iT(this,"workerToken",void 0),iT(this,"requestId",0),iT(this,"signal",void 0),iT(this,"prevChannelMediaConfig",void 0),iT(this,"httpRetryConfig",void 0),iT(this,"_resolution",void 0),iT(this,"_state",Wb.RELAY_STATE_IDLE),iT(this,"errorCode",Hb.RELAY_OK),iT(this,"onStatus",(e=>{Qw.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(e))),e&&e.command&&("onAudioPacketReceived"===e.command&&this.emit("event",Gb.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===e.command&&this.emit("event",Gb.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===e.command&&(this.errorCode=Hb.SRC_TOKEN_EXPIRED,this.state=Wb.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===e.command&&(this.errorCode=Hb.DEST_TOKEN_EXPIRED,this.state=Wb.RELAY_STATE_FAILURE))})),iT(this,"onReconnect",(async()=>{Qw.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Gb.NETWORK_DISCONNECTED),this.state=Wb.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((e=>{this.state!==Wb.RELAY_STATE_IDLE&&(Qw.error("auto restart channel media relay failed",e.toString()),this.errorCode=Hb.SERVER_CONNECTION_LOST,this.state=Wb.RELAY_STATE_FAILURE)}))})),this.joinInfo=e,this.clientId=t,this.sid=tw(),this.signal=new gG(this.joinInfo,this.clientId,n),this.httpRetryConfig=i,this._resolution=r}async startChannelMediaRelay(e){if(this.state!==Wb.RELAY_STATE_IDLE)throw new bb(tR.INVALID_OPERATION);this.state=Wb.RELAY_STATE_CONNECTING,await this.connect(),Qw.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(e){if(e.data&&e.data.serverResponse&&"SetSourceChannel"===e.data.serverResponse.command)throw new bb(tR.CROSS_CHANNEL_FAILED_JOIN_SRC);if(e.data&&e.data.serverResponse&&"SetDestChannelStatus"===e.serverResponse.command)throw new bb(tR.CROSS_CHANNEL_FAILED_JOIN_DEST);if(e.data&&e.data.serverResponse&&"StartPacketTransfer"===e.serverResponse.command)throw new bb(tR.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw e}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==Wb.RELAY_STATE_RUNNING)throw new bb(tR.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==Wb.RELAY_STATE_RUNNING)throw new bb(tR.INVALID_OPERATION);const t=this.genMessage(Bb.SetVideoProfile);await this.signal.request(t),Qw.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),Qw.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Wb.RELAY_STATE_IDLE,this.dispose()}dispose(){Qw.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=pC.CancelToken.source(),this.state=Wb.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await qO(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",Gb.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const t=this.genMessage(Bb.StopPacketTransfer);await this.signal.request(t),await this.signal.waitStatus("Normal Quit"),Qw.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const n=this.genMessage(Bb.SetSdkProfile,e);await this.signal.request(n),Qw.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const i=this.genMessage(Bb.SetSourceChannel,e);await this.signal.request(i),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Gb.PACKET_JOINED_SRC_CHANNEL),Qw.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const r=this.genMessage(Bb.SetSourceUserId,e);await this.signal.request(r),Qw.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const o=this.genMessage(Bb.SetDestChannel,e);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Gb.PACKET_JOINED_DEST_CHANNEL),Qw.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const s=this.genMessage(Bb.StartPacketTransfer,e);await this.signal.request(s),this.emit("event",Gb.PACKET_SENT_TO_DEST_CHANNEL),this.state=Wb.RELAY_STATE_RUNNING,Qw.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const t=this.genMessage(Bb.UpdateDestChannel,e);await this.signal.request(t),this.emit("event",Gb.PACKET_UPDATE_DEST_CHANNEL),Qw.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(Bb.StopPacketTransfer);await this.signal.request(e),Qw.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){const n=[],i=[],r=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Rw,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.21.0"===o.sdkVersion&&(o.sdkVersion="0.0.1");let s=null,a=null;switch(e){case Bb.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case Bb.SetSourceChannel:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new bb(tR.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},o;case Bb.SetSourceUserId:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new bb(tR.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:a.uid+""},o;case Bb.SetDestChannel:if(s=t&&t.getDestChannelMediaInfo(),!s)throw new bb(tR.UNEXPECTED_ERROR,"can not find dest config");return s.forEach((e=>{n.push(e.channelName),i.push(e.uid+""),r.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:n,uid:i,token:r},o;case Bb.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case Bb.Reconnect:return o.clientRequest={command:"Reconnect"},o;case Bb.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case Bb.UpdateDestChannel:if(s=t&&t.getDestChannelMediaInfo(),!s)throw new bb(tR.UNEXPECTED_ERROR,"can not find dest config");return s.forEach((e=>{n.push(e.channelName),i.push(e.uid+""),r.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:n,uid:i,token:r},o;case Bb.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}function TG(e){var t={},n=!1;function i(t,i){return n=!0,{done:!1,value:new ij(i=new lj((function(n){n(e[t](i))})),1)}}return t[void 0!==Zv&&$v||"@@iterator"]=function(){return this},t.next=function(e){return n?(n=!1,e):i("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(n)throw n=!1,e;return i("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return n?(n=!1,e):i("return",e)}),t}var SG,yG=i(dj);function CG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function RG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?CG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):CG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function wG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function IG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?wG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let bG=(SG=class e extends nA{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Pi(t=Object.keys(Mw)).call(t,e)})))]}constructor(t,n){super(t,n),iT(this,"store",void 0),iT(this,"peerConnection",void 0),iT(this,"remoteSDP",void 0),iT(this,"initialOffer",void 0),iT(this,"statsFilter",void 0),iT(this,"useRTX",!1),iT(this,"localCapabilities",void 0),iT(this,"localCandidateCount",0),iT(this,"allCandidatesReceived",!1),iT(this,"establishPromise",void 0),iT(this,"mutex",new hw("P2PConnection-mutex")),this.store=n,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=Yj(this.peerConnection,Dw("STATS_UPDATE_INTERVAL"),void 0,PC()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=Zj(e.sdp),n=Qj(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:Dw("FILTER_VIDEO_FEC"),filterAudioFec:Dw("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=n,this.initialOffer=e,IG(IG({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:n},offerSDP:e.sdp})}catch(e){throw new nR(tR.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,n,i,r,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(e){iT(this,"sessionDesc",void 0),iT(this,"localCapabilities",void 0),iT(this,"rtpCapabilities",void 0),iT(this,"candidates",void 0),iT(this,"iceParameters",void 0),iT(this,"dtlsParameters",void 0),iT(this,"setup",void 0),iT(this,"currentMidIndex",void 0),iT(this,"cname",void 0),e=GR(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:s,sdkCodec:a,cname:c}=e,l=Aj.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=r,this.candidates=i,this.iceParameters=t,this.dtlsParameters=n,this.setup=o,this.localCapabilities=s,this.cname=c;for(let d=0;d<l.mediaDescriptions.length;d++){const e=l.mediaDescriptions[d];if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=n.fingerprints,e.attributes.candidates=i,e.attributes.setup=o,"video"===e.media.mediaType){e.media.fmts=r.videoCodecs.map((e=>e.payloadType.toString(10)));let t=r.videoCodecs.filter((e=>{var t,n;return null===(t=e.rtpMap)||void 0===t?void 0:Pi(n=t.encodingName.toLowerCase()).call(n,a)}));0===t.length&&(t=r.videoCodecs),e.attributes.payloads=t,e.attributes.extmaps=r.videoExtensions}"audio"===e.media.mediaType&&(e.media.fmts=r.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=r.audioCodecs,e.attributes.extmaps=r.audioExtensions),l.mediaDescriptions[d]=this.mungMediaDesc(e)}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return Aj.print(this.sessionDesc)}send(e,t,n){const{ssrcs:i,ssrcGroups:r}=tB(t,this.cname),o=this.sessionDesc.mediaDescriptions.find((t=>e===iA.VIDEO?"video"===t.media.mediaType:"audio"===t.media.mediaType)),s=i[0].attributes.label,a=i[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(i),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(r),{id:s,mslabel:a}}batchSend(e){return e.map((e=>{let{kind:t,ssrcMsg:n}=e;return this.send(t,n,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((t=>{const n=[],i=[],r=[];t.attributes.ssrcs.forEach((t=>{Pi(e).call(e,t.attributes.label||"")?r.push(t):n.push(t)})),t.attributes.ssrcGroups.forEach((e=>{var t;Pi(t=r.map((e=>e.ssrcId))).call(t,e.ssrcIds[0])||i.push(e)})),t.attributes.ssrcs=n,t.attributes.ssrcGroups=i}))}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,n){e.forEach(((e,t)=>{const n=e._mediaStreamTrack,i=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===n.kind)),r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=r}))}stopReceiving(e){}updateCandidates(e){e===rA.TCP?this.candidates.forEach((e=>{-1===this.candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this.candidates.push(RG(RG({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this.candidates=this.candidates.filter((e=>"tcp"!==e.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(e){e=GR(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}mungRecvMediaDsec(e,t){const n=GR(e);return nB(n,t),rB(n,t),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==n){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=e}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,n){const i=this.sessionDesc.mediaDescriptions.find((t=>e===iA.VIDEO?"video"===t.attributes.mid:"audio"===t.attributes.mid));if(i){const e=i.attributes.ssrcs.find((e=>e.attributes.label===t));var r;e&&(e.attributes.label=n,null===(r=e.attributes.msid)||void 0===r||r.replace(t,n))}}mungMediaDesc(e){const t=GR(e);return iB(t),function(e){const t=e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&e.attributes.extmaps.splice(e.attributes.extmaps.indexOf(t),1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}(t),t}getSSRC(e){for(const t of this.sessionDesc.mediaDescriptions)for(const n of t.attributes.ssrcs)if(n.attributes.label===e)return[n]}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:n,remoteRTPCapabilities:i.send,remoteSetup:r,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const s=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,t){throw new nR(tR.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,t){var n=this;return pj((function*(){const i=yield rj(n.mutex.lock());try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const i=e.map((e=>n.peerConnection.addTrack(e._mediaStreamTrack))),r=yield rj(n.peerConnection.createOffer()),o=Aj.parse(r.sdp),s=e.map((e=>{const t=e._mediaStreamTrack,i=o.mediaDescriptions.find((e=>e.attributes.mid===t.kind));if(!i)throw new Error("Cannot extract ssrc from mediaDescription.");return function(e,t,n){const i=e.attributes.ssrcs.filter((e=>e.attributes.label===t)),r=e.attributes.ssrcGroups;if(0===i.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(r&&i.length>1){const e=r.find((e=>-1!==e.ssrcIds.indexOf(i[0].ssrcId)));return e?[{ssrcId:e.ssrcIds[0],rtx:n?e.ssrcIds[1]:void 0}]:[{ssrcId:i[0].ssrcId}]}return[{ssrcId:i[0].ssrcId}]}(i,t.id,n.useRTX)}));let a;try{a=yield s}catch(e){throw i.forEach((e=>{NC()&&e.replaceTrack(null),n.peerConnection.removeTrack(e)})),e}const c=n.mungSendOfferSDP(r.sdp,e);n.remoteSDP.receive(e,t,a);const l=n.remoteSDP.toString();return yield rj(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield rj(n.applySendEncodings(i,e)),yield rj(n.peerConnection.setRemoteDescription({type:"answer",sdp:l})),e.map(((e,t)=>{const n=e._mediaStreamTrack.id;return{localSSRC:s[t],id:n}}))}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{i()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getSenders().filter((t=>{var n;return-1!==e.indexOf((null===(n=t.track)||void 0===n?void 0:n.id)||"")}));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{NC()&&e.replaceTrack(null),this.peerConnection.removeTrack(e)}));const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:n,mslabel:r}=this.remoteSDP.send(e,t,i),o=new Gh(((t,i)=>{const o=setTimeout((()=>{i(new Error("Cannot receive track, id: ".concat(n)))}),1e4),s=i=>{const a=RC();if(("Safari"===a.name&&11===Number(a.version)||kC())&&i.track.id!==n&&i.streams[0].id===r){var c;const r=i.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(e,n,i.track.id),this.peerConnection.removeEventListener("track",s),clearTimeout(o),void t(r)}if(i.track.id===n)return this.peerConnection.removeEventListener("track",s),clearTimeout(o),void t(i.track)};this.peerConnection.addEventListener("track",s)})),s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const a=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(a),{track:await o,id:n}}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n)}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var n;return-1!==e.indexOf((null===(n=t.track)||void 0===n?void 0:n.id)||"")}));if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map((e=>{if(NC()&&e.track)e.track.enabled=!1;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!1)),e.setParameters(t)}}))}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var n;return-1!==e.indexOf((null===(n=t.track)||void 0===n?void 0:n.id)||"")}));if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map((async e=>{if(NC()&&e.track)e.track.enabled=!0;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!0)),await e.setParameters(t)}}));const n=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(n);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return pj((function*(){const n=yield rj(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(fU().supportPCSetConfiguration){const n=t.peerConnection.getConfiguration(),i=e===rA.RELAY?"relay":"all";n.iceTransportPolicy!==i&&(Qw.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(i,"]")),n.iceTransportPolicy=i,t.peerConnection.setConfiguration(n))}else if(e===rA.RELAY)return;e!==rA.RELAY&&t.remoteSDP.updateCandidates(e);const n=yield rj(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const i=Zj(n.sdp),{remoteIceParameters:r}=yield i.iceParameters;t.remoteSDP.restartICE(r);const o=t.remoteSDP.toString();yield rj(t.peerConnection.setLocalDescription(n)),yield rj(t.peerConnection.setRemoteDescription({type:"answer",sdp:o}))}catch(e){Qw.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const e=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(e.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);const i=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getSenders().filter((t=>{var n;return(null===(n=t.track)||void 0===n?void 0:n.id)===e}));1===n.length&&await this.applySendEncodings(n,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getSenders().find((e=>{var n;return(null===(n=e.track)||void 0===n?void 0:n.id)===t}));n&&await n.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new nR(tR.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new nR(tR.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Qw.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Qw.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Dw("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(bR(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),Dw("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(n.iceTransportPolicy="relay")})))),n}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async updateRtpSenderEncodings(e,t){var n;if(t||(t=this.peerConnection.getSenders().find((t=>{var n;return(null===(n=t.track)||void 0===n?void 0:n.id)===e._mediaStreamTrack.id}))),!t)return Qw.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!fU().supportSetRtpSenderParameters)return Qw.warn("Browser not support set rtp-sender parameters");const i={},r={};if(e instanceof CF)switch(e._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;default:i.degradationPreference="balanced"}if(Dw("DSCP_TYPE")&&JC()){var o;const e=Dw("DSCP_TYPE");Pi(o=["very-low","low","medium","high"]).call(o,e)&&(r.networkPriority=e)}const s=t.getParameters(),a=null===(n=s.encodings)||void 0===n?void 0:n[0];a&&Object.assign(a,r),Object.assign(s,i),Qw.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(s.encodings))),await t.setParameters(s)}async applySendEncodings(e,t){try{if(!fU().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let n=0;n<e.length;n++){const i=e[n],r=t[n];i&&r&&await this.updateRtpSenderEncodings(r,i)}}catch(e){Qw.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){const n=Aj.parse(e);return t.forEach(((e,t)=>{const i=e._mediaStreamTrack,r=n.mediaDescriptions.find((e=>e.attributes.mid===i.kind));r&&nB(r,e)})),Aj.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const t=this.remoteSDP.batchSend(e).map(((t,n)=>{let{id:i,mslabel:r}=t;const{kind:o}=e[n];return new Gh(((e,t)=>{const n=setTimeout((()=>{t(new Error("Cannot receive track, id: ".concat(i)))}),1e4),s=t=>{const a=RC();if("Safari"===a.name&&11===Number(a.version)&&t.track.id!==i&&t.streams[0].id===r){var c;const r=t.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(o,i,t.track.id),this.peerConnection.removeEventListener("track",s),clearTimeout(n),void e({track:r,id:i})}if(t.track.id===i)return this.peerConnection.removeEventListener("track",s),clearTimeout(n),void e({track:t.track,id:i})};this.peerConnection.addEventListener("track",s)}))})),n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(i),await Gh.all(t)}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(fU().supportPCSetConfiguration){const n=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}}},ib(SG.prototype,"connect",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"connect"),SG.prototype),ib(SG.prototype,"stopSending",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"stopSending"),SG.prototype),ib(SG.prototype,"receive",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"receive"),SG.prototype),ib(SG.prototype,"stopReceiving",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"stopReceiving"),SG.prototype),ib(SG.prototype,"muteRemote",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"muteRemote"),SG.prototype),ib(SG.prototype,"unmuteRemote",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"unmuteRemote"),SG.prototype),ib(SG.prototype,"muteLocal",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"muteLocal"),SG.prototype),ib(SG.prototype,"unmuteLocal",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"unmuteLocal"),SG.prototype),ib(SG.prototype,"close",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"close"),SG.prototype),ib(SG.prototype,"updateEncoderConfig",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"updateEncoderConfig"),SG.prototype),ib(SG.prototype,"updateSendParameters",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"updateSendParameters"),SG.prototype),ib(SG.prototype,"replaceTrack",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"replaceTrack"),SG.prototype),ib(SG.prototype,"getRemoteSSRC",[AG],Object.getOwnPropertyDescriptor(SG.prototype,"getRemoteSSRC"),SG.prototype),SG);function AG(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("Locking from P2PConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function OG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function NG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?OG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):OG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const DG="9",PG=4e4;function kG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function LG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?kG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):kG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let MG=function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e}({});var UG=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(UG||{});const xG=new Map;function VG(e,t,n,i){let{scale:r}=e;if(0===r&&i===UG.UP||r>=t.length-1&&i===UG.DOWN)return e;let o=LG(LG({},e),{},{scale:i===UG.DOWN?++r:--r});switch(n){case"maintain-framerate":o=LG(LG({},o),t[r].motion);break;case"maintain-resolution":o=LG(LG({},o),t[r].detail);break;case"balanced":o=LG(LG({},o),t[r].balanced)}return o}function FG(e,t){if(t){const n={overUse:0,underUse:0,adaptationList:jG(t)};xG.set(e,n)}else xG.delete(e)}function jG(e){const t=LG({},e),{bitrateMax:n,frameRate:i,scaleResolutionDownBy:r,bitrateMin:o}=t,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:l,BITRATE_MAX_THRESHOLD:d,BWE_SCALE_UP_THRESHOLD:u,BWE_SCALE_DOWN_THRESHOLD:h,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:f,BALANCE_BITRATE_FACTOR:m,BALANCE_FRAMERATE_FACTOR:_,BALANCE_RESOLUTION_FACTOR:E,MOTION_RESOLUTION_FACTOR:g,MOTION_BITRATE_FACTOR:v,DETAIL_FRAMERATE_FACTOR:T,DETAIL_BITRATE_FACTOR:S}=bw,y=Math.min(t.frameRate,a),C=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(h,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(p,1)*y),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o}}];for(let R=1;R<=c;R++){const e={bwe_up:Math.round(Math.pow(u,R)*n),bwe_down:Math.round(Math.pow(h,R+1)*n),fps_up:Math.round(Math.pow(f,R)*y),fps_down:Math.round(Math.pow(p,R+1)*y)},t={scaleResolutionDownBy:r/Math.pow(E,R),frameRate:Math.max(Math.round(Math.pow(_,R)*i),s),bitrateMax:Math.max(Math.round(Math.pow(m,R)*n),d),bitrateMin:Math.max(Math.round(Math.pow(m,R)*o),l)},a={scaleResolutionDownBy:r/Math.pow(g,R),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(v,R)*n),d),bitrateMin:Math.max(Math.round(Math.pow(v,R)*o),l)},c={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(T,R)*i),s),bitrateMax:Math.max(Math.round(Math.pow(S,R)*n),d),bitrateMin:Math.max(Math.round(Math.pow(S,R)*o),l)};C.push({scale:R,threshold:e,balanced:t,motion:a,detail:c})}return C}function BG(e,t,n,i,r,o){const s=xG.get(e)||{overUse:0,underUse:0,adaptationList:jG(r)},{adaptationList:a}=s;xG.set(e,s);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:l}=bw,{scale:d}=i;let u,h;return"number"==typeof t&&t>0&&function(e,t,n,i){if(t>=n.length)return!1;let{threshold:{fps_down:r}}=n[t];return Dw("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===i&&(r=n[0].threshold.fps_down),e<r}(t,d,a,o)&&(s.overUse++,h=MG.CPU,s.overUse>c)||"number"==typeof n&&n>0&&function(e,t,n){if(t>=n.length)return!1;const{threshold:{bwe_down:i}}=n[t];return e<i}(n,d,a)&&(s.overUse++,h=MG.BANDWIDTH,s.overUse>c)?(s.overUse=0,s.underUse=0,u=VG(i,a,o,UG.DOWN),[u,h]):("number"==typeof t&&t>0&&"number"==typeof n&&n>0&&function(e,t,n,i){if(0===t)return;let{threshold:{fps_up:r}}=n[t];return Dw("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===i&&(r=n[1].threshold.fps_up),e>r}(t,d,a,o)&&function(e,t,n){if(0===t)return;const{threshold:{bwe_up:i}}=n[t];return e>i}(n,d,a)&&(s.underUse++,s.underUse>l&&(s.overUse=0,s.underUse=0,u=VG(i,a,o,UG.UP),0===u.scale&&(h=MG.NONE))),[u,h])}function GG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function WG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?GG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):GG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function HG(e){var t;return!!Dw("ENABLE_AG_ADAPTATION")&&!!(e instanceof RF||Pi(t=e._hints).call(t,kU.CUSTOM_TRACK))&&(!!Dw("FORCE_SUPPORT_AG_ADAPTATION")||!!(function(e){const t=RC();if(t.os!==vC.IOS||!t.osVersion)return!1;const n=t.osVersion.split(".");return Number(n[0])>=e}(14)&&xC(17,4,!0)||UC(14)&&VC(17,4,!0)))}const KG=new Map;function zG(e){const t=KG.get(e);if(t){const{timer:n,adaptationFunc:i,originConfig:r}=t;window.clearTimeout(n),i(r),KG.delete(e)}FG(e)}var qG;function YG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function JG(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?YG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):YG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let XG=(qG=class e extends nA{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Pi(t=Object.keys(Mw)).call(t,e)})))]}constructor(t,n){super(t,n),iT(this,"store",void 0),iT(this,"peerConnection",void 0),iT(this,"id",ew(5,"connection-")),iT(this,"remoteSDP",void 0),iT(this,"initialOffer",void 0),iT(this,"transportEventReceiver",void 0),iT(this,"statsFilter",void 0),iT(this,"useXR",Dw("USE_XR")),iT(this,"localCapabilities",void 0),iT(this,"remoteCodecs",void 0),iT(this,"localCandidateCount",0),iT(this,"allCandidatesReceived",!1),iT(this,"dataStreamChannelMap",new Map),iT(this,"establishPromise",void 0),iT(this,"recoveredDataChannelIds",[]),iT(this,"currentDataChannelId",1),iT(this,"mutex",new hw("P2PConnection-mutex")),iT(this,"qualityLimitationReason",MG.NONE),this.store=n,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=Yj(this.peerConnection,Dw("STATS_UPDATE_INTERVAL"),void 0,PC()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(e,t){if(this.remoteCodecs=t,this.remoteSDP)if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const n=this.remoteSDP.toString();null==t||t(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}else Qw.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else Qw.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(t))}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=Zj(e.sdp),n=await cB({filterRTX:!Dw("USE_PUB_RTX")&&!Dw("USE_SUB_RTX"),filterVideoFec:Dw("FILTER_VIDEO_FEC"),filterAudioFec:Dw("FILTER_AUDIO_FEC"),filterVideoCodec:Dw("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=uB(n),this.initialOffer=e,JG(JG({},t),{},{rtpCapabilities:n,offerSDP:e.sdp})}catch(e){throw new nR(tR.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,n,i,r,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return GR(this._localCapabilities)}get rtpCapabilities(){return GR(this._rtpCapabilities)}get candidates(){return GR(this._candidates)}get iceParameters(){return GR(this._iceParameters)}get dtlsParameters(){return GR(this._dtlsParameters)}constructor(e){iT(this,"sessionDesc",void 0),iT(this,"_localCapabilities",void 0),iT(this,"_rtpCapabilities",void 0),iT(this,"_candidates",void 0),iT(this,"_iceParameters",void 0),iT(this,"_dtlsParameters",void 0),iT(this,"setup",void 0),iT(this,"currentMidIndex",void 0),iT(this,"cname",void 0),iT(this,"firefoxSsrcMidMap",new Map),e=GR(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:s,cname:a}=e,c=Aj.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=s,this.setup=o,this.cname=a;const l=this.rtpCapabilities.send;for(const d of c.mediaDescriptions){if(d.attributes.iceUfrag=t.iceUfrag,d.attributes.icePwd=t.icePwd,d.attributes.fingerprints=n.fingerprints,d.attributes.candidates=i,d.attributes.setup=o,"video"===d.media.mediaType&&(d.media.fmts=l.videoCodecs.map((e=>e.payloadType.toString(10))),d.attributes.payloads=l.videoCodecs,d.attributes.extmaps=l.videoExtensions,Dw("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=tB([{ssrcId:PG,rtx:Dw("USE_SUB_RTX")?40001:void 0}],this.cname);d.attributes.ssrcs=e,d.attributes.ssrcGroups=t}if("audio"===d.media.mediaType&&(d.media.fmts=l.audioCodecs.map((e=>e.payloadType.toString(10))),d.attributes.payloads=l.audioCodecs,d.attributes.extmaps=l.audioExtensions,hB(d),Dw("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=tB([{ssrcId:2e4}],this.cname);d.attributes.ssrcs=e,d.attributes.ssrcGroups=t}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const e=Dw("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const t=this.candidates,n=this.dtlsParameters,i=this.iceParameters,r=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+2e4,s=2*o+PG,{ssrcs:a,ssrcGroups:c}=tB([{ssrcId:e}],this.cname),{ssrcs:l,ssrcGroups:d}=tB([{ssrcId:s,rtx:Dw("USE_SUB_RTX")?s+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:DG,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:t,extmaps:r.videoExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:d,rtcpFeedbackWildcards:[],payloads:r.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:DG,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:t,extmaps:r.audioExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:r.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Aj.print(this.sessionDesc)}send(e,t,n,i){const{ssrcs:r,ssrcGroups:o}=tB(t,this.cname,Dw("SYNC_GROUP")?n:void 0),s=this.findPreloadMediaDesc(r);if(s){if(PC()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,s.attributes.mid),i&&(i.twcc||i.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(s);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(s,i),{mid:s.attributes.mid,needExchangeSDP:!0}}return{mid:s.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,r);let n;return-1===t||1===t&&(NC()||jC())||0===t&&Dw("USE_SUB_RTX")||BC()?(n=this.createOrRecycleSendMedia(e,r,o,"sendonly",i),this.updateBundleMids()):(n=GR(this.sessionDesc.mediaDescriptions[t]),n.attributes.direction="sendonly",n.attributes.ssrcs=r,n.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(n,i)),PC()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,n.attributes.mid),{mid:n.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:n,mslabel:i}=e;return this.send(t,n,i)})),n=[];let i=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:r}=e;r&&(i=!0),n.push(t)})),{mids:n,needExchangeSDP:i}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||PC()||BC()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Pi(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Pi(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,n,i){e.forEach(((e,r)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,n,i[r])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){const t=this._candidates.filter((e=>"udp"===e.transport));if(e===rA.TCP){if(0===t.length)return;if(Dw("TCP_CANDIDATE_ONLY")){const e=this._candidates.filter((e=>"tcp"===e.transport));t.forEach((t=>{-1===e.findIndex((e=>e.connectionAddress===t.connectionAddress))&&e.push(NG(NG({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=e}else{const e=[];t.forEach((t=>{e.push(NG(NG({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=[...t,...e]}}else if(e===rA.RELAY){if(0!==t.length)return;{const e=this._candidates.filter((e=>"tcp"===e.transport));e.forEach((e=>{t.push(NG(NG({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=[...t,...e]}}else 0===t.length?(this._candidates.filter((e=>"tcp"===e.transport)).forEach((e=>{t.push(NG(NG({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=t):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const n of this.sessionDesc.mediaDescriptions)n.attributes.candidates=this.candidates}restartICE(e){e=GR(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const i=n.media.mediaType===e&&"0"!==n.media.port&&("sendonly"===n.attributes.direction||"sendrecv"===n.attributes.direction)&&0===n.attributes.ssrcs.length;if(PC()){if(i){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==n.attributes.mid&&"1"!==n.attributes.mid)||!(!e||e!==n.attributes.mid)}return!1}return i}))}createOrRecycleDataChannel(){for(const n of this.sessionDesc.mediaDescriptions)if("application"===n.media.mediaType)return{mediaDesc:n,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:DG,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,n,i,r,o){const s=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=fB(s,a,this.localCapabilities.send,s===iA.VIDEO?i:r),l=s===iA.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let u={media:{mediaType:s,port:DG,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungRecvMediaDsec(u,e,o);const h=this.findFirstClosedMedia(s);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateRemoteCodec(e,t,n){const i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Pi(t=Object.keys(Mw)).call(t,e)})))],r=new Set(t);if(i.every((e=>r.has(e))))return Qw.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter((e=>t.some((t=>{var n;return Pi(n=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(n,t)}))));if(0===o.length)return Qw.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(t)),!1;const s=[...new Set(o.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let a;if(Qw.debug("updateRemoteCodec, from ".concat(i," to ").concat(s)),0===e.length)a=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(a=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&Pi(e).call(e,t.attributes.mid)&&"recvonly"===t.attributes.direction)),a.length!==e.length)return Qw.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;if(Dw("USE_PUB_RTX")||Dw("USE_SUB_RTX")){const e=mB(o,this.rtpCapabilities.recv.videoCodecs);o.push(...e)}this._rtpCapabilities.recv.videoCodecs=o;const c=this.localCapabilities.send,l=this.rtpCapabilities.recv,d=fB(iA.VIDEO,l,c,n);return a.forEach((e=>{const t=d.map((e=>e.payloadType.toString(10)));Qw.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(d)),e.attributes.payloads=d,e.media.fmts=t})),!0}createOrRecycleSendMedia(e,t,n,i,r){const o=this.rtpCapabilities.send,s=e===iA.VIDEO?o.videoCodecs:o.audioCodecs,a=e===iA.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let l={media:{mediaType:e,port:DG,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:s,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};l=this.mungSendMediaDesc(l,r);const d=this.findFirstClosedMedia(e);if(d){const e=this.sessionDesc.mediaDescriptions.indexOf(d);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,n){const i=GR(e);return iB(i),nB(i,t),rB(i,t),oB(i),sB(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=GR(e);return sB(n,t,this.localCapabilities.recv),hB(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==n){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>PC()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return(null===(n=t.attributes)||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:n,remoteRTPCapabilities:i,remoteSetup:r,localCapabilities:this.localCapabilities,cname:o}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString(),a=Aj.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&hB(c),this.useXR&&pB(a);const l=Aj.print(a),d=this.logSDPExchange(l||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),null==d||d(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s});const u=this.peerConnection.getTransceivers()[0];if(null!=u&&u.receiver&&this.tryBindTransportEvents(u.receiver),Dw("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t,n){var i=this;return pj((function*(){const r=yield rj(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[];e.forEach((e=>{const t=i.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t),e._updateRtpTransceiver(t)})),PC()&&!0===Dw("SIMULCAST")&&(yield rj(i.applySimulcastForFirefox(o,e)));const s=yield rj(i.peerConnection.createOffer()),a=i.remoteSDP.predictReceivingMids(e.length),c=i.mungSendOfferSDP(s.sdp,e,a),l=Aj.parse(c),d=a.map((e=>{const t=l.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return $j(t,Dw("USE_PUB_RTX"))}));let u;try{u=yield d}catch(r){u=[],i.remoteSDP.receive(e,t,n,u);const o=i.remoteSDP.toString();throw yield rj(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield rj(i.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield rj(i.stopSending(a,!0)),r}i.remoteSDP.receive(e,t,n,u);const h=i.remoteSDP.toString(),p=i.logSDPExchange(c,"offer","local","send");return yield rj(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield rj(i.applySimulcastEncodings(o,e)),yield rj(i.applySendEncodings(o,e)),null==p||p(h),yield rj(i.peerConnection.setRemoteDescription({type:"answer",sdp:h})),o.map(((e,t)=>{const n=a[t];return{localSSRC:d[t],id:n,transceiver:e}}))}catch(e){throw e instanceof nR?e:new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{r()}}))()}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);if(n&&"open"===n.readyState)Qw.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const t=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if("number"!=typeof t)throw new Error("create DataChannel error, because cannot get dc id");n=this.peerConnection.createDataChannel("datastream-channel",{id:t,negotiated:!0,ordered:!1,maxRetransmits:Dw("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)}t.forEach((e=>{e._updateOriginDataChannel(n)}));const{needExchangeSDP:i}=this.remoteSDP.sendDataChannel();if(i){const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t),Qw.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else Qw.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof nR?e:new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return t&&(t.id&&this.recoveredDataChannelIds.push(t.id),t.close()),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof nR?e:new nR(tR.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const n=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;zG(this.id+e.mid),e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{n&&n()}}async receive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(e,t,n,i);if(o){const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(i.sdp,r,e);null==n||n(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),Qw.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else Qw.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const s=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:t,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),t=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==t||t(n.sdp||""),await this.peerConnection.setLocalDescription(n),Qw.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else Qw.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return t.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return pj((function*(){const n=yield rj(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(fU().supportPCSetConfiguration){const n=t.peerConnection.getConfiguration(),i=e===rA.RELAY?"relay":"all";n.iceTransportPolicy!==i&&(Qw.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(i,"]")),n.iceTransportPolicy=i,t.peerConnection.setConfiguration(n))}else if(e===rA.RELAY)return;t.remoteSDP.updateCandidates(e);const n=yield rj(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const i=Zj(n.sdp),{remoteIceParameters:r}=yield i.iceParameters;t.remoteSDP.restartICE(r);const o=t.remoteSDP.toString(),s=t.logSDPExchange(n.sdp||"","offer","local","restartICE");t.store.descriptionStart(),yield rj(t.peerConnection.setLocalDescription(n)),null==s||s(o),yield rj(t.peerConnection.setRemoteDescription({type:"answer",sdp:o}))}catch(e){Qw.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.getTransceivers().forEach((e=>{zG(this.id+e.mid)})),this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return JG(JG({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(n.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const r=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==o||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new nR(tR.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===n.length&&(this.isVP8Simulcast(t)?PC()||await this.applySimulcastEncodings(n,[t]):await this.applySendEncodings(n,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getTransceivers().find((e=>e.mid===t));n&&await n.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:n,remote:i}=t.getSelectedCandidatePair();return{local:JG(JG({},Pj),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:JG(JG({},Pj),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Qw.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Qw.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Dw("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(bR(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),Dw("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),Dw("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(n.iceTransportPolicy="relay")})))),Dw("ENABLE_ENCODED_TRANSFORM")&&fU().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(HA(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!Dw("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}tryBindTransportEvents(e){const t=e.transport;if(t){this.transportEventReceiver=e,t.onstatechange=()=>{var e;null!=t&&t.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,t.state))},t.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const n=t.iceTransport;n&&(n.onstatechange=()=>{const e=null==t?void 0:t.iceTransport.state;var n;e&&(null===(n=this.onICETransportStateChange)||void 0===n||n.call(this,e))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:e,remote:t}=n.getSelectedCandidatePair();Qw.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:t.type,protocol:t.protocol,address:t.address,port:t.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var n,i;if(!t){const n=this.peerConnection.getSenders();t=n.find((t=>t.track===e._mediaStreamTrack))}if(!t)return Qw.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return Qw.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!fU().supportSetRtpSenderParameters)return Qw.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},o={};switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;case"balanced":r.degradationPreference="balanced"}const s=function(e,t){return e.getTransceivers().find((e=>e.sender.track===t||e.receiver.track===t))}(this.peerConnection,e._mediaStreamTrack),a=Wx(e);if(HG(e)&&s&&t&&a&&this.getLocalVideoStats&&Pi(n=["vp8","vp9"]).call(n,this.store.codec)){var c;const n=r.degradationPreference||(Pi(c=e._hints).call(c,kU.CUSTOM_TRACK)?Dw("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");!function(e,t,n,i,r,o){if(zG(e),"balanced"!==i&&"maintain-framerate"!==i&&"maintain-resolution"!==i)return;let s=-1;FG(e,t);const a=window.setInterval((()=>{const a=KG.get(e);if(!Dw("ENABLE_AG_ADAPTATION")||!a)return void zG(e);const c=o();if(c.sendPackets>0&&c.OutgoingAvailableBandwidth>0){if(-1===s)return void(s=Date.now());if(Date.now()-s<1e3)return;const o=c.sendFrameRate,l=c.OutgoingAvailableBandwidth,[d,u]=BG(e,o,l,a.adaptationConfig,t,i);u&&(n.qualityLimitationReason=u),d&&a.adaptationConfig.scale!==d.scale&&(Qw.debug("[".concat(e,"] applyAdaptation: ").concat(n.qualityLimitationReason,"\n           sendFps ").concat(o,", bwe ").concat(l,", switch from ").concat(a.adaptationConfig.scale," to ").concat(d.scale," ")),a.adaptationConfig=WG(WG({},a.adaptationConfig),d),r(d))}}),Dw("CHECK_LOCAL_STATS_INTERVAL")),c=WG({},t);KG.set(e,{timer:a,adaptationConfig:c,originConfig:t,adaptationFunc:r}),Qw.debug("[".concat(e,"] start adaptation, originConfig: ").concat(JSON.stringify(t),", degradationPreference: ").concat(i))}(this.id+s.mid,a,this,n,(e=>{t&&this.updateAdaptation(t,e)}),this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var l;const{bitrateMax:t,frameRate:n,scaleResolutionDownBy:i}=e._encoderConfig;t&&(o.maxBitrate=1e3*t),(Pi(l=e._hints).call(l,kU.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(n&&(o.maxFramerate=zA(n)),i&&i>=1&&(o.scaleResolutionDownBy=i))}const{maxFramerate:d}=Dw("ENCODER_CONFIG_LIMIT");if(d&&"number"==typeof d&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,d):d),Dw("DSCP_TYPE")&&JC()){var u;const e=Dw("DSCP_TYPE");Pi(u=["very-low","low","medium","high"]).call(u,e)&&(o.networkPriority=e)}const h=t.getParameters(),p=null===(i=h.encodings)||void 0===i?void 0:i[0];PC()&&!p&&(r.encodings=[o]),p&&Object.assign(p,o),Object.assign(h,r),Qw.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(h.encodings))),await t.setParameters(h)}async updateAdaptation(e,t){var n,i;if(!e)return Qw.debug("[updateAdaptation] no rtpSender found");if(!fU().supportSetRtpSenderParameters)return Qw.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const r={},{bitrateMax:o,frameRate:s,scaleResolutionDownBy:a}=t;o&&(r.maxBitrate=1e3*o),s&&(r.maxFramerate=zA(s)),a&&a>=1&&Pi(n=["vp8","vp9"]).call(n,this.store.codec)&&(r.scaleResolutionDownBy=a);const c=e.getParameters(),l=null===(i=c.encodings)||void 0===i?void 0:i[0];l&&Object.assign(l,r),Object.assign(c,{});try{await e.setParameters(c),Qw.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(c.encodings)))}catch(t){!("transport"in e)||e.transport&&"connected"===e.transport.state?"connected"!==this.peerConnectionState?Qw.debug("[updateAdaptation] peerConnection not connected}"):Qw.debug("[updateAdaptation] updateRtpSenderEncodings failed",t):Qw.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,t){try{if(!fU().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let n=0;n<e.length;n++){const i=e[n],r=t[n];r instanceof CF&&!this.isVP8Simulcast(r)&&await this.updateRtpSenderEncodings(r,i.sender)}}catch(e){Qw.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,n){const i=Aj.parse(e);return t.forEach(((e,t)=>{const r=n[t],o=i.mediaDescriptions.find((e=>e.attributes.mid===r));o&&(nB(o,e),aB(o,e,this.store.codec))})),Aj.print(i)}mungReceiveAnswerSDP(e,t,n){const i=Aj.parse(e),r=i.mediaDescriptions.find((e=>e.attributes.mid===t));return r&&(n===iA.AUDIO&&"audio"===r.media.mediaType&&hB(r),this.useXR&&pB(i)),Aj.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var n,i,r,o,s;const c=e[a],l=t[a];if(l instanceof CF&&!Pi(n=l._hints).call(n,kU.LOW_STREAM)&&null!==(i=l._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(r=l._encoderConfig)||void 0===r?void 0:r.bitrateMax)>200&&null!==(o=l._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(s=l._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const n=c.sender.getParameters();await c.sender.setParameters(Object.assign(n,e))}}}async applySimulcastEncodings(e,t){if(!PC()&&e.length===t.length)for(let n=0;n<e.length;n++){const i=t[n];if(i instanceof CF&&this.isVP8Simulcast(i)){const t=e[n],r={},o={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};r.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const s=t.sender.getParameters();await t.sender.setParameters(Object.assign(s,r))}}}isVP8Simulcast(e){var t,n,i,r,o;return!!(e instanceof CF&&Dw("SIMULCAST")&&"vp8"===this.store.codec&&!Pi(t=e._hints).call(t,kU.LOW_STREAM)&&null!==(n=e._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(r=e._scalabilityMode)&&void 0!==r&&r.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,t,n,i){if(Dw("SDP_LOGGING"))return Qw.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(t," SDP during P2PConnection.").concat(i,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",i)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(fU().supportPCSetConfiguration){const n=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}}},ib(qG.prototype,"updateRemoteRTPCapabilities",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"updateRemoteRTPCapabilities"),qG.prototype),ib(qG.prototype,"connect",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"connect"),qG.prototype),ib(qG.prototype,"createDataChannels",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"createDataChannels"),qG.prototype),ib(qG.prototype,"receive",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"receive"),qG.prototype),ib(qG.prototype,"batchReceive",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"batchReceive"),qG.prototype),ib(qG.prototype,"stopReceiving",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"stopReceiving"),qG.prototype),ib(qG.prototype,"muteRemote",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"muteRemote"),qG.prototype),ib(qG.prototype,"unmuteRemote",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"unmuteRemote"),qG.prototype),ib(qG.prototype,"muteLocal",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"muteLocal"),qG.prototype),ib(qG.prototype,"unmuteLocal",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"unmuteLocal"),qG.prototype),ib(qG.prototype,"close",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"close"),qG.prototype),ib(qG.prototype,"updateEncoderConfig",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"updateEncoderConfig"),qG.prototype),ib(qG.prototype,"updateSendParameters",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"updateSendParameters"),qG.prototype),ib(qG.prototype,"replaceTrack",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"replaceTrack"),qG.prototype),ib(qG.prototype,"updateAdaptation",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"updateAdaptation"),qG.prototype),ib(qG.prototype,"getRemoteSSRC",[QG],Object.getOwnPropertyDescriptor(qG.prototype,"getRemoteSSRC"),qG.prototype),qG);function QG(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From P2PConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function ZG(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function $G(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ZG(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ZG(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const eW="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",tW="9",nW=2e4,iW=4e4;class rW{get localCapabilities(){return GR(this._localCapabilities)}get rtpCapabilities(){return GR(this._rtpCapabilities)}get candidates(){return GR(this._candidates)}get iceParameters(){return GR(this._iceParameters)}get dtlsParameters(){return GR(this._dtlsParameters)}constructor(e){iT(this,"sessionDesc",void 0),iT(this,"_localCapabilities",void 0),iT(this,"_rtpCapabilities",void 0),iT(this,"_candidates",void 0),iT(this,"_iceParameters",void 0),iT(this,"_dtlsParameters",void 0),iT(this,"setup",void 0),iT(this,"currentMidIndex",void 0),iT(this,"cname",void 0),iT(this,"firefoxSsrcMidMap",new Map),e=GR(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:s,cname:a}=e,c=Aj.parse(eW);this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=s,this.setup=o,this.cname=a;const l=this.rtpCapabilities.send;for(const d of c.mediaDescriptions){if(d.attributes.iceUfrag=t.iceUfrag,d.attributes.icePwd=t.icePwd,d.attributes.fingerprints=n.fingerprints,d.attributes.candidates=i,d.attributes.setup=o,"application"===d.media.mediaType&&(d.attributes.sctpPort="5000"),"video"===d.media.mediaType&&(d.media.fmts=l.videoCodecs.map((e=>e.payloadType.toString(10))),d.attributes.payloads=l.videoCodecs,d.attributes.extmaps=l.videoExtensions,Dw("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=tB([{ssrcId:iW,rtx:Dw("USE_SUB_RTX")?40001:void 0}],this.cname);d.attributes.ssrcs=e,d.attributes.ssrcGroups=t}if("audio"===d.media.mediaType&&(d.media.fmts=l.audioCodecs.map((e=>e.payloadType.toString(10))),d.attributes.payloads=l.audioCodecs,d.attributes.extmaps=l.audioExtensions,hB(d),Dw("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=tB([{ssrcId:nW}],this.cname);d.attributes.ssrcs=e,d.attributes.ssrcGroups=t}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const t=Aj.parse(eW);this._rtpCapabilities=e;const n=this.rtpCapabilities.send;for(const i of t.mediaDescriptions){if(i.attributes.iceUfrag=this._iceParameters.iceUfrag,i.attributes.icePwd=this._iceParameters.icePwd,i.attributes.fingerprints=this._dtlsParameters.fingerprints,i.attributes.candidates=this._candidates,i.attributes.setup=this.setup,"application"===i.media.mediaType&&(i.attributes.sctpPort="5000"),"video"===i.media.mediaType&&(i.media.fmts=n.videoCodecs.map((e=>e.payloadType.toString(10))),i.attributes.payloads=n.videoCodecs,i.attributes.extmaps=n.videoExtensions,Dw("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=tB([{ssrcId:iW,rtx:Dw("USE_SUB_RTX")?40001:void 0}],this.cname);i.attributes.ssrcs=e,i.attributes.ssrcGroups=t}if("audio"===i.media.mediaType&&(i.media.fmts=n.audioCodecs.map((e=>e.payloadType.toString(10))),i.attributes.payloads=n.audioCodecs,i.attributes.extmaps=n.audioExtensions,Dw("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:e,ssrcGroups:t}=tB([{ssrcId:nW}],this.cname);i.attributes.ssrcs=e,i.attributes.ssrcGroups=t}}this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const t=this.candidates,n=this.dtlsParameters,i=this.iceParameters,r=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+nW,s=2*o+iW,{ssrcs:a,ssrcGroups:c}=tB([{ssrcId:e}],this.cname),{ssrcs:l,ssrcGroups:d}=tB([{ssrcId:s,rtx:Dw("USE_SUB_RTX")?s+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:tW,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:t,extmaps:r.videoExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:d,rtcpFeedbackWildcards:[],payloads:r.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:tW,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:i.iceUfrag,icePwd:i.icePwd,unrecognized:[],candidates:t,extmaps:r.audioExtensions,fingerprints:n.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:r.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Aj.print(this.sessionDesc)}send(e,t,n,i){const{ssrcs:r,ssrcGroups:o}=tB(t,this.cname,Dw("SYNC_GROUP")?n:void 0),s=this.findPreloadMediaDesc(r);if(s){if(PC()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,s.attributes.mid),i&&(i.twcc||i.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(s);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(s,i),{mid:s.attributes.mid,needExchangeSDP:!0}}return{mid:s.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,r);let n;return-1===t||NC()||kC()||jC()||0===t&&Dw("USE_SUB_RTX")?(n=this.createOrRecycleSendMedia(e,r,o,"sendonly",i),this.updateBundleMids()):(n=GR(this.sessionDesc.mediaDescriptions[t]),n.attributes.direction="sendonly",n.attributes.ssrcs=r,n.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(n,i)),PC()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,n.attributes.mid),{mid:n.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:n,mslabel:i}=e;return this.send(t,n,i)})),n=[];let i=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:r}=e;r&&(i=!0),n.push(t)})),{mids:n,needExchangeSDP:i}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||PC()||NC()||kC()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Pi(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>Pi(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,n,i){e.forEach(((e,r)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,n,i[r])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){e===rA.TCP?this._candidates.forEach((e=>{-1===this._candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this._candidates.push($G($G({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const t of this.sessionDesc.mediaDescriptions)t.attributes.candidates=this.candidates}restartICE(e){e=GR(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const i=n.media.mediaType===e&&"0"!==n.media.port&&("sendonly"===n.attributes.direction||"sendrecv"===n.attributes.direction)&&0===n.attributes.ssrcs.length;if(PC()){if(i){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==n.attributes.mid&&"1"!==n.attributes.mid)||!(!e||e!==n.attributes.mid)}return!1}return i}))}createOrRecycleRecvMedia(e,t,n,i,r,o){const s=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=fB(s,a,this.localCapabilities.send,s===iA.VIDEO?i:r),l=s===iA.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let u={media:{mediaType:s,port:tW,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};u=this.mungRecvMediaDsec(u,e,o);const h=this.findFirstClosedMedia(s);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateRemoteCodec(e,t,n){const i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Pi(t=Object.keys(Mw)).call(t,e)})))],r=new Set(t);if(i.every((e=>r.has(e))))return Qw.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter((e=>t.some((t=>{var n;return Pi(n=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").call(n,t)}))));if(0===o.length)return Qw.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(t)),!1;const s=[...new Set(o.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let a;if(Qw.debug("updateRemoteCodec, from ".concat(i," to ").concat(s)),0===e.length)a=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(a=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&Pi(e).call(e,t.attributes.mid)&&"recvonly"===t.attributes.direction)),a.length!==e.length)return Qw.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;this._rtpCapabilities.recv.videoCodecs=o;const c=this.localCapabilities.send,l=this.rtpCapabilities.recv,d=fB(iA.VIDEO,l,c,n);return a.forEach((e=>{const t=d.map((e=>e.payloadType.toString(10)));Qw.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(d)),e.attributes.payloads=d,e.media.fmts=t})),!0}createOrRecycleSendMedia(e,t,n,i,r){const o=this.rtpCapabilities.send,s=e===iA.VIDEO?o.videoCodecs:o.audioCodecs,a=e===iA.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let l={media:{mediaType:e,port:tW,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:s,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};l=this.mungSendMediaDesc(l,r);const d=this.findFirstClosedMedia(e);if(d){const e=this.sessionDesc.mediaDescriptions.indexOf(d);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,n){const i=GR(e);return iB(i),nB(i,t),rB(i,t),oB(i),sB(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=GR(e);return sB(n,t,this.localCapabilities.recv),hB(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==n){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>PC()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return(null===(n=t.attributes)||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}var oW;function sW(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function aW(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sW(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sW(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}let cW=(oW=class e extends nA{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let e;return this.localCapabilities&&(e=uB(this.localCapabilities)),[...new Set(e&&e.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>{var t;return Pi(t=Object.keys(Mw)).call(t,e)})))]}constructor(e,t,n){super(e,t),iT(this,"store",void 0),iT(this,"peerConnection",void 0),iT(this,"remoteSDP",void 0),iT(this,"initialOffer",void 0),iT(this,"transportEventReceiver",void 0),iT(this,"statsFilter",void 0),iT(this,"useXR",Dw("USE_XR")),iT(this,"localCapabilities",void 0),iT(this,"localCandidateCount",0),iT(this,"allCandidatesReceived",!1),iT(this,"remoteCodecs",void 0),iT(this,"dataStreamChannelMap",new Map),iT(this,"establishPromise",void 0),iT(this,"mutex",new hw("NVExtentionsConnection-mutex")),iT(this,"rtcMedia",void 0),this.store=t,this.peerConnection=n,this.statsFilter=Yj(this.peerConnection,Dw("STATS_UPDATE_INTERVAL"),void 0,PC()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=Zj(e.sdp),n=await cB({filterRTX:!Dw("USE_PUB_RTX")&&!Dw("USE_SUB_RTX"),filterVideoFec:Dw("FILTER_VIDEO_FEC"),filterAudioFec:Dw("FILTER_AUDIO_FEC"),filterVideoCodec:Dw("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=n,this.initialOffer=e,aW(aW({},t),{},{rtpCapabilities:n,offerSDP:e.sdp})}catch(e){throw new bb(tR.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,n,i,r,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new rW({remoteIceParameters:e,remoteDtlsParameters:t,candidates:n,remoteRTPCapabilities:i,remoteSetup:r,localCapabilities:uB(this.localCapabilities),cname:o});const s=this.remoteSDP.toString(),a=Aj.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&hB(c),this.useXR&&pB(a);const l=Aj.print(a),d=this.logSDPExchange(l||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),null==d||d(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,t){if(this.remoteCodecs=t,this.remoteSDP)if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const n=this.remoteSDP.toString();null==t||t(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}else Qw.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else Qw.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(t))}async updateRemoteConnect(e){var t,n,i,r;null===(t=this.remoteSDP)||void 0===t||t.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&(null===(r=this.remoteSDP)||void 0===r||r.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),null===(n=this.remoteSDP)||void 0===n||n.preloadRemoteMedia(2);const o=null===(i=this.remoteSDP)||void 0===i?void 0:i.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),Qw.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,t,n){var i=this;return pj((function*(){const r=yield rj(i.mutex.lock("From NVExtentionsConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const o=[];e.forEach((e=>{const t=i.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t)})),PC()&&!0===Dw("SIMULCAST")&&(yield rj(i.applySimulcastForFirefox(o,e)));const s=yield rj(i.peerConnection.createOffer()),a=i.remoteSDP.predictReceivingMids(e.length),c=i.mungSendOfferSDP(s.sdp,e,a),l=Aj.parse(c),d=a.map((e=>{const t=l.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return $j(t,Dw("USE_PUB_RTX"))}));let u;try{u=yield d}catch(r){u=[],i.remoteSDP.receive(e,t,n,u);const o=i.remoteSDP.toString();throw yield rj(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield rj(i.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield rj(i.stopSending(a,!0)),r}i.remoteSDP.receive(e,t,n,u);const h=i.remoteSDP.toString(),p=i.logSDPExchange(c,"offer","local","send");return yield rj(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield rj(i.applySimulcastEncodings(o,e)),yield rj(i.applySendEncodings(o,e)),null==p||p(h),yield rj(i.peerConnection.setRemoteDescription({type:"answer",sdp:h})),o.map(((e,t)=>{const n=a[t];return{localSSRC:d[t],id:n,transceiver:e}}))}catch(e){throw e instanceof bb?e:new bb(tR.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(e.toString()))}finally{r()}}))()}async stopSending(e,t){const n=t?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(e.toString()))}finally{n&&n()}}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);return n&&"open"===n.readyState?Qw.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:Dw("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)),void t.forEach((e=>{e._updateOriginDataChannel(n)}))}catch(e){throw e instanceof bb?e:new bb(tR.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof bb?e:new bb(tR.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(e.toString()))}}async receive(e,t,n,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:r,needExchangeSDP:o}=this.remoteSDP.send(e,t,n,i);if(o){const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer(),o=this.mungReceiveAnswerSDP(i.sdp,r,e);null==n||n(o||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:o}),Qw.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else Qw.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const s=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r}}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:t,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),t=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==t||t(n.sdp||""),await this.peerConnection.setLocalDescription(n),Qw.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else Qw.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return t.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e}}))}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);const r=this.remoteSDP.toString();null==i||i(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return pj((function*(){const n=yield rj(t.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(fU().supportPCSetConfiguration){const n=t.peerConnection.getConfiguration(),i=e===rA.RELAY?"relay":"all";n.iceTransportPolicy!==i&&(Qw.debug("restartICE change iceTransportPolicy from [".concat(n.iceTransportPolicy,"] to [").concat(i,"]")),n.iceTransportPolicy=i,t.peerConnection.setConfiguration(n))}else if(e===rA.RELAY)return;e!==rA.RELAY&&t.remoteSDP.updateCandidates(e);const n=yield rj(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const i=Zj(n.sdp),{remoteIceParameters:r}=yield i.iceParameters;t.remoteSDP.restartICE(r);const o=t.remoteSDP.toString(),s=t.logSDPExchange(n.sdp||"","offer","local","restartICE");yield rj(t.peerConnection.setLocalDescription(n)),null==s||s(o),yield rj(t.peerConnection.setRemoteDescription({type:"answer",sdp:o}))}catch(e){Qw.warning("restart ICE failed, abort operation",e)}finally{n()}}))()}close(){var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(n.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const r=this.remoteSDP.toString(),o=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==o||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new bb(tR.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===n.length&&(this.isVP8Simulcast(t)?PC()||await this.applySimulcastEncodings(n,[t]):await this.applySendEncodings(n,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getTransceivers().find((e=>e.mid===t));n&&await n.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if(null===(e=this.peerConnection.currentLocalDescription)||void 0===e||!e.sdp||!this.localCapabilities)throw new Error;return aW(aW({},Zj(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,Qw.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,Qw.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),Dw("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(bR(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),Dw("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),Dw("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(n.iceTransportPolicy="relay")})))),n}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(HA(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!Dw("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async applySendEncodings(e,t){try{if(!fU().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let d=0;d<e.length;d++){const u=e[d],h=t[d];if(h&&h instanceof CF){var n,i,r;if(this.isVP8Simulcast(h))continue;const e={},t={};switch(h._optimizationMode){case"motion":e.degradationPreference="maintain-framerate";break;case"detail":e.degradationPreference="maintain-resolution";break;default:e.degradationPreference="balanced"}var o,s,a,c;if(null!==(n=h._encoderConfig)&&void 0!==n&&n.bitrateMax&&(t.maxBitrate=1e3*(null===(o=h._encoderConfig)||void 0===o?void 0:o.bitrateMax)),Pi(i=h._hints).call(i,kU.LOW_STREAM)&&(null!==(s=h._encoderConfig)&&void 0!==s&&s.frameRate&&(t.maxFramerate=zA(h._encoderConfig.frameRate)),null!==(a=h._encoderConfig)&&void 0!==a&&a.scaleResolutionDownBy&&(null===(c=h._encoderConfig)||void 0===c?void 0:c.scaleResolutionDownBy)>1&&(t.scaleResolutionDownBy=h._encoderConfig.scaleResolutionDownBy)),Dw("DSCP_TYPE")&&JC()){var l;const e=Dw("DSCP_TYPE");Pi(l=["very-low","low","medium","high"]).call(l,e)&&(t.networkPriority=e)}const d=u.sender.getParameters(),p=null===(r=d.encodings)||void 0===r?void 0:r[0];PC()&&!p&&(e.encodings=[t]),p&&Object.assign(p,t),Object.assign(d,e),await u.sender.setParameters(d)}}}catch(e){Qw.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,n){const i=Aj.parse(e);return t.forEach(((e,t)=>{const r=n[t],o=i.mediaDescriptions.find((e=>e.attributes.mid===r));o&&(nB(o,e),aB(o,e,this.store.codec))})),Aj.print(i)}mungReceiveAnswerSDP(e,t,n){const i=Aj.parse(e),r=i.mediaDescriptions.find((e=>e.attributes.mid===t));return r&&n===iA.AUDIO&&"audio"===r.media.mediaType&&hB(r),this.useXR&&pB(i),Aj.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var n,i,r,o,s;const c=e[a],l=t[a];if(l instanceof CF&&!Pi(n=l._hints).call(n,kU.LOW_STREAM)&&null!==(i=l._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(r=l._encoderConfig)||void 0===r?void 0:r.bitrateMax)>200&&null!==(o=l._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(s=l._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const n=c.sender.getParameters();await c.sender.setParameters(Object.assign(n,e))}}}async applySimulcastEncodings(e,t){if(!PC()&&e.length===t.length)for(let n=0;n<e.length;n++){const i=t[n];if(i instanceof CF&&this.isVP8Simulcast(i)){const t=e[n],r={},o={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};r.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const s=t.sender.getParameters();await t.sender.setParameters(Object.assign(s,r))}}}isVP8Simulcast(e){var t,n,i,r,o;return!!(e instanceof CF&&Dw("SIMULCAST")&&"vp8"===this.store.codec&&!Pi(t=e._hints).call(t,kU.LOW_STREAM)&&null!==(n=e._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(r=e._scalabilityMode)&&void 0!==r&&r.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,t,n,i){if(Dw("SDP_LOGGING"))return Qw.upload("exchanging ".concat(n," ").concat(t," SDP during NVExtentionsConnection.").concat(i,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",i)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(fU().supportPCSetConfiguration){const n=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}}},ib(oW.prototype,"connect",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"connect"),oW.prototype),ib(oW.prototype,"updateRemoteRTPCapabilities",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"updateRemoteRTPCapabilities"),oW.prototype),ib(oW.prototype,"updateRemoteConnect",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"updateRemoteConnect"),oW.prototype),ib(oW.prototype,"createDataChannels",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"createDataChannels"),oW.prototype),ib(oW.prototype,"receive",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"receive"),oW.prototype),ib(oW.prototype,"batchReceive",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"batchReceive"),oW.prototype),ib(oW.prototype,"stopReceiving",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"stopReceiving"),oW.prototype),ib(oW.prototype,"muteRemote",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"muteRemote"),oW.prototype),ib(oW.prototype,"unmuteRemote",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"unmuteRemote"),oW.prototype),ib(oW.prototype,"muteLocal",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"muteLocal"),oW.prototype),ib(oW.prototype,"unmuteLocal",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"unmuteLocal"),oW.prototype),ib(oW.prototype,"close",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"close"),oW.prototype),ib(oW.prototype,"updateEncoderConfig",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"updateEncoderConfig"),oW.prototype),ib(oW.prototype,"updateSendParameters",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"updateSendParameters"),oW.prototype),ib(oW.prototype,"replaceTrack",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"replaceTrack"),oW.prototype),ib(oW.prototype,"getRemoteSSRC",[lW],Object.getOwnPropertyDescriptor(oW.prototype,"getRemoteSSRC"),oW.prototype),oW);function lW(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From NVExtentionsConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}var dW;function uW(e){var t,n,i,r=2;for("undefined"!=typeof Symbol&&(n=yG,i=Symbol.iterator);r--;){if(n&&null!=(t=e[n]))return t.call(e);if(i&&null!=(t=e[i]))return new hW(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function hW(e){function t(e){if(Object(e)!==e)return Gh.reject(new TypeError(e+" is not an object."));var t=e.done;return Gh.resolve(e.value).then((function(e){return{value:e,done:t}}))}return hW=function(e){this.s=e,this.n=e.next},hW.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Gh.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Gh.reject(e):t(n.apply(this.s,arguments))}},new hW(e)}let pW=(dW=class e extends nA{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,n){super(t,n),iT(this,"store",void 0),iT(this,"peerConnection",void 0),iT(this,"cname",void 0),iT(this,"mutex",new hw("DataChannelConnection-mutex")),iT(this,"dataChannel",void 0),iT(this,"_p2pConnection",void 0),iT(this,"establishPromise",void 0),iT(this,"_nvMedia",void 0),this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new cW(t,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const t=null===(e=this._nvMedia)||void 0===e?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(t)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,t,n,i,r,o){return this.cname=o,await this._p2pConnection.connect(e,t,n,i,r,o),await new Gh(((e,t)=>{const i=setTimeout((()=>{this.closeSignal(),t(new bb(tR.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(n))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(i),void e()},this.dataChannel.onerror=e=>{this.closeSignal(),t(e)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,t){return this._p2pConnection.updateRemoteRTPCapabilities(e,t)}send(e,t,n){var i=this;return pj((function*(){const r=yield rj(i.mutex.lock("From DataChannelConnection.send"));try{return yield*TG(uW(i._p2pConnection.send(e,t,n)))}finally{r()}}))()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,t,n,i){return this._nvMedia?(Qw.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,t,this.cname)):(Qw.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,t,n,i))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return pj((function*(){return yield*TG(uW(t._p2pConnection.restartICE(e)))}))()}close(){var e;null===(e=this._nvMedia)||void 0===e||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;null===(t=this._nvMedia)||void 0===t||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,t,n,i){if(Dw("SDP_LOGGING"))return Qw.upload("exchanging ".concat(n," ").concat(t," SDP during DataChannelConnection.").concat(i,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",i)}:void 0}static resolvePCConfiguration(t){const n={iceServers:[]};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(bR(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),Dw("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),Dw("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(n.iceTransportPolicy="relay")})))),n}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(HA(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!Dw("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return null===(t=this.onICEConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return null===(t=this.onConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return null===(t=this.onDTLSTransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return null===(t=this.onDTLSTransportError)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return null===(t=this.onICETransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return null===(t=this.onFirstAudioReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return null===(t=this.onFirstVideoReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return null===(t=this.onFirstAudioDecoded)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,n)=>{var i;return null===(i=this.onFirstVideoDecoded)||void 0===i?void 0:i.call(this,e,t,n)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return null===(t=this.onFirstVideoDecodedTimeout)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var n;return null===(n=this.onSelectedLocalCandidateChanged)||void 0===n?void 0:n.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var n;return null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n?void 0:n.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}},ib(dW.prototype,"connect",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"connect"),dW.prototype),ib(dW.prototype,"updateRemoteRTPCapabilities",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"updateRemoteRTPCapabilities"),dW.prototype),ib(dW.prototype,"createDataChannels",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"createDataChannels"),dW.prototype),ib(dW.prototype,"receive",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"receive"),dW.prototype),ib(dW.prototype,"stopReceiving",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"stopReceiving"),dW.prototype),ib(dW.prototype,"muteRemote",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"muteRemote"),dW.prototype),ib(dW.prototype,"unmuteRemote",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"unmuteRemote"),dW.prototype),ib(dW.prototype,"muteLocal",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"muteLocal"),dW.prototype),ib(dW.prototype,"unmuteLocal",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"unmuteLocal"),dW.prototype),ib(dW.prototype,"close",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"close"),dW.prototype),ib(dW.prototype,"updateEncoderConfig",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"updateEncoderConfig"),dW.prototype),ib(dW.prototype,"updateSendParameters",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"updateSendParameters"),dW.prototype),ib(dW.prototype,"replaceTrack",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"replaceTrack"),dW.prototype),ib(dW.prototype,"getRemoteSSRC",[fW],Object.getOwnPropertyDescriptor(dW.prototype,"getRemoteSSRC"),dW.prototype),dW);function fW(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From DataChannelConnection.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}var mW;function _W(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function EW(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_W(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_W(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function gW(e){var t,n,i,r=2;for("undefined"!=typeof Symbol&&(n=yG,i=Symbol.iterator);r--;){if(n&&null!=(t=e[n]))return t.call(e);if(i&&null!=(t=e[i]))return new vW(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function vW(e){function t(e){if(Object(e)!==e)return Gh.reject(new TypeError(e+" is not an object."));var t=e.done;return Gh.resolve(e.value).then((function(e){return{value:e,done:t}}))}return vW=function(e){this.s=e,this.n=e.next},vW.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Gh.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Gh.reject(e):t(n.apply(this.s,arguments))}},new vW(e)}let TW=(mW=class extends vR{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(cA.StateChange,t,this._state)}constructor(e,t){super(),iT(this,"store",void 0),iT(this,"statsUploader",void 0),iT(this,"connection",void 0),iT(this,"localTrackMap",new Map),iT(this,"remoteUserMap",new Map),iT(this,"localDataChannels",[]),iT(this,"remoteDataChannelMap",new Map),iT(this,"pendingLocalTracks",[]),iT(this,"pendingRemoteTracks",[]),iT(this,"pendingLocalDataChannels",[]),iT(this,"pendingRemoteDataChannels",[]),iT(this,"statsCollector",void 0),iT(this,"isPlanB",!1),iT(this,"shouldForwardP2PCreation",void 0),iT(this,"iceFailedCount",0),iT(this,"dtlsFailedCount",0),iT(this,"mutex",new hw("P2PChannel-mutex")),iT(this,"_state",aA.Disconnected),iT(this,"_pcStatsUploadType",Dw("NEW_ICE_RESTART")?oA.FIRST_CONNECTION:oA.OLD_FIRST_CONNECTION),iT(this,"_isInRestartIce",!1),iT(this,"_isStartRestartIce",!1),iT(this,"_restartStates",["disconnected","failed"]),iT(this,"_restartTimer",void 0),iT(this,"_isFirstConnected",!0),iT(this,"handleMuteLocalTrack",(async(e,t,n)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==aA.Connected)return void n(new nR(tR.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const i=this.filterTobeMutedTracks(e);if(0===i.length)return void t();const r=i.find((e=>"videoLowTrack"===e[0]));r&&r[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(i.map((e=>{let[,{id:t}]=e;return t})));const o=this.createMuteMessage(i);await MR(this,cA.RequestMuteLocal,o),t()}catch(e){n(e)}finally{i()}})),iT(this,"handleUnmuteLocalTrack",(async(e,t,n)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==aA.Connected)return void n(new nR(tR.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const i=this.filterTobeUnmutedTracks(e);if(0===i.length)return void t();const r=i.find((e=>"videoLowTrack"===e[0]));if(r){const t=r[1];if(t.track._originMediaStreamTrack.stop(),!Dw("DISABLE_DUAL_STREAM_USE_ENCODING")&&fU().supportDualStreamEncoding){const n=e._mediaStreamTrack.clone();t.track._mediaStreamTrack=n,t.track._originMediaStreamTrack=n}else{const n=CB(e,xR(this,cA.RequestLowStreamParameter));t.track._mediaStreamTrack=n,t.track._originMediaStreamTrack=n}await new Gh(((e,n)=>{this.handleReplaceTrack(t.track,e,n,!0)}))}await this.connection.unmuteLocal(i.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnmuteMessage(i);await MR(this,cA.RequestUnmuteLocal,o),t()}catch(e){n(e)}finally{i()}})),iT(this,"handleUpdateVideoEncoder",(async(e,t,n)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const n=this.localTrackMap.get(sA.LocalVideoTrack);if(!this.connection||!n||n.track!==e||this.state!==aA.Connected)return void t();const{id:i,track:r}=n;await this.connection.updateSendParameters(i,r),await this.connection.updateEncoderConfig(i,r),this.emit(cA.UpdateVideoEncoder,r),t()}catch(e){n(e)}finally{i()}})),iT(this,"handleUpdateVideoSendParameters",(async(e,t,n)=>{const i=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const n=this.localTrackMap.get(sA.LocalVideoTrack);if(!this.connection||!n||n.track!==e||this.state!==aA.Connected)return void t();const{id:i,track:r}=n;await this.connection.updateSendParameters(i,r),t()}catch(e){n(e)}finally{i()}})),iT(this,"handleReplaceMixingTrack",(async(e,t,n,i)=>{if(!this.connection||this.state!==aA.Connected)return void t();const r=HB([e]);let o;Qw.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(r.getTrackId(),"]")),"boolean"==typeof i&&i||(o=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(e,r),t()}catch(e){n(e)}finally{var s;null===(s=o)||void 0===s||s()}})),iT(this,"handleReplaceTrack",(async(e,t,n,i)=>{let r;Qw.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof i&&i||(r=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var o;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(!this.connection||!n||this.state!==aA.Connected)return void t();if(await(null===(o=this.connection)||void 0===o?void 0:o.replaceTrack(e,n[1].id)),this.isPlanB){const t=n[1];t.id=e._mediaStreamTrack.id,this.localTrackMap.set(n[0],t)}if(n[0]===sA.LocalVideoTrack&&!Dw("DISABLE_DUAL_STREAM_USE_ENCODING")&&fU().supportDualStreamEncoding){const t=this.localTrackMap.get(sA.LocalVideoLowTrack);if(t){const n=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=n,t.track._originMediaStreamTrack=n,await new Gh(((e,n)=>{this.handleReplaceTrack(t.track,e,n,!0)}))}}t()}catch(e){n(e)}finally{var s;null===(s=r)||void 0===s||s()}})),iT(this,"handleGetRTCStats",(e=>{e(this.statsCollector.getRTCStats())})),iT(this,"handleGetLocalVideoStats",(e=>{e(this.statsCollector.getLocalVideoTrackStats())})),iT(this,"handleGetLocalAudioStats",(e=>{e(this.statsCollector.getLocalAudioTrackStats())})),iT(this,"handleGetRemoteVideoStats",(e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid])),iT(this,"handleGetRemoteAudioStats",(e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid])),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new FB(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!fU().supportUnifiedPlan||Dw("CHROME_FORCE_PLAN_B")&&JC(),this.shouldForwardP2PCreation=Dw("FORWARD_P2P_CREATION")&&fU().supportPCSetConfiguration&&YC(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new pW({},this.store):this.isPlanB?new bG({},this.store):new XG({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var n;this.state=aA.New;const i=this.shouldForwardP2PCreation&&"closed"===(null===(n=this.connection)||void 0===n?void 0:n.peerConnectionState);if(this.shouldForwardP2PCreation&&!i||(i&&this.connection&&(Qw.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new pW(e,this.store):this.isPlanB?new bG(e,this.store):new XG(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new nR(tR.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=Dw("NEW_ICE_RESTART")?oA.FIRST_CONNECTION:oA.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,n,i,r,o){if(!this.connection)throw new nR(tR.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof pW?this.connection.updateRemoteConnect(i):(this.store.peerConnectionStart(),await this.connection.connect(e,t,n,i,r,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=aA.Connected)}updateRemoteRTPCapabilities(e){const t=Array.from(this.localTrackMap.entries()).filter((e=>{var t;let[n]=e;return Pi(t=[sA.LocalVideoLowTrack,sA.LocalVideoTrack]).call(t,n)})),n=t.map((e=>{let[,{id:t}]=e;return t})),i=t.map((e=>{let[t]=e;return t}));if(this.connection instanceof XG){if(oI.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!Pi(e).call(e,this.store.codec)){const t=["vp9","vp8","h264"].find((t=>Pi(e).call(e,t)));t&&(this.store.codec=t,Qw.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(t,".")))}this.connection.updateRemoteRTPCapabilities(n,e)}}async preConnect(e,t,n,i,r,o){if(!this.connection)throw new nR(tR.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const s=await this.connection.connect(e,t,n,i,r,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=aA.Connected,s}getEstablishParams(){if(this.connection instanceof pW)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection||this.state!==aA.Connected){if(this.state===aA.Disconnected)throw new nR(tR.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return void e.forEach((e=>{var t;Pi(t=this.pendingLocalDataChannels).call(t,e)||this.pendingLocalDataChannels.push(e)}))}const t=this.filterTobePublishedDataChannels(e);0!==t.length&&(t.forEach((e=>{const t=Date.now();this.store.publish(e.id.toString(),"datachannel",t)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((e=>{this.localDataChannels.push(e);const t=Date.now();this.store.publish(e.id+"","datachannel",void 0,t)})))}publish(e,t,n){var i=this;return pj((function*(){const r=yield rj(i.mutex.lock("From P2PChannel.publish"));try{if(!i.connection||i.state!==aA.Connected){if(i.state===aA.Disconnected)throw new nR(tR.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===i.pendingLocalTracks.indexOf(e)));return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(t))}i.store.pubId=i.store.pubId+1,nj.markPublishStart(i.store.clientId,i.store.pubId);const r=i.filterTobePublishedTracks(e,t,n);if(0===r.length)return void(yield rj(i.tryToUnmuteAudio(e)));yield*TG(gW(i.doPublish(i.connection,r)))}finally{r()}}))()}doPublish(e,t){var n=this;return pj((function*(){t.forEach((e=>{let{track:t,type:i}=e;const r=Date.now();n.store.publish(t.getTrackId(),i===sA.LocalAudioTrack?"audio":"video",r)})),n.bindLocalTrackEvents(t);const i=t.map((e=>{let{track:t}=e;return t})),r=yield rj(e.send(t.map((e=>{let{track:t}=e;return t})),n.store.codec,n.store.audioCodec)),o=(yield rj(r.next())).value,s=n.createGatewayPublishMessage(t,o);let a;try{a=yield s}catch(e){throw r.throw(e),(null==e?void 0:e.code)===tR.WS_ABORT&&t.forEach((e=>{let{track:t}=e;-1===n.pendingLocalTracks.indexOf(t)&&n.pendingLocalTracks.push(t)})),n.unbindLocalTrackEvents(t),e}const c=n.mapPubResToRemoteConfig(s,a),l=(yield rj(r.next(c))).value,d=Dw("ENABLE_VIDEO_SEI");i.forEach((async e=>{const t=e.getRTCRtpTransceiver();t&&d&&(e.trackMediaType===iA.VIDEO?await QF(t.sender,e):e.trackMediaType===iA.AUDIO&&await async function(e){if(!fU().supportWebRTCEncodedTransform)return void Qw.warning("browser not support audio encoded transform");if(YF.has(e))return;if(!e.track)return;const t={track:e.track};if(OC()){if(!e.createEncodedStreams)return void Qw.warning("browser not support createEncodedStreams() API");let i=null;try{i=e.createEncodedStreams()}catch(e){return void Qw.error("create audio-encoded-streams error",e&&e.message)}const r=new TransformStream({transform(i,r){t.controller||(t.controller=r),e.track&&e.track.id!==t.track.id&&(Qw.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",n),t.track=e.track,t.track.addEventListener("ended",n)),r.enqueue(i)}});i.readable.pipeThrough(r).pipeTo(i.writable)}else if(NC()){if("undefined"==typeof RTCRtpScriptTransform)return void Qw.warning("browser not support RTCRtpScriptTransform");const i=qF(),r=new MessageChannel;await new Gh((e=>i.onmessage=t=>{"registered"===t.data&&e(void 0)}));const o=new RTCRtpScriptTransform(i,{name:"tx",port:r.port2},[r.port2]);e.transform=o,await new Gh((e=>i.onmessage=t=>{"started"===t.data&&e(void 0)})),r.port1.onmessage=i=>{var r;i.data.transformed&&e.track&&(null===(r=e.track)||void 0===r?void 0:r.id)!==t.track.id&&(Qw.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",n),t.track=e.track,t.track.addEventListener("ended",n))},t.worker=i}function n(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",n)}const t=YF.get(e);if(t){YF.delete(e);try{var i,r;null===(i=t.controller)||void 0===i||i.terminate(),null===(r=t.worker)||void 0===r||r.terminate()}catch(e){Qw.warning(e&&e.message)}}}YF.set(e,t),e.track.addEventListener("ended",n)}(t.sender))})),t.forEach((e=>{let{type:t}=e;n.statsCollector.addLocalStats(t)})),n.assignLocalTracks(t,l),n.statsUploader.startUploadOutboundStats(),t.forEach((e=>{let{track:t,type:i}=e;const r=Date.now();n.store.publish(t.getTrackId(),i===sA.LocalAudioTrack?"audio":"video",void 0,r)}))}))()}async updateVideoStreamParameter(e,t){const n=this.localTrackMap.get(t);if(!n)return;if(!(n.track instanceof CF))return Qw.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof XG||this.connection instanceof bG))return Qw.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:i}=n,r=function(e,t){const n={};return e.height&&e.width&&(n.scaleResolutionDownBy=QA(e,t)),n.maxFramerate=e.framerate?zA(e.framerate):void 0,n.maxBitrate=e.bitrate?1e3*e.bitrate:void 0,n}(e,i);if(i._encoderConfig||(i._encoderConfig={}),t!==sA.LocalVideoLowTrack||!Dw("DISABLE_DUAL_STREAM_USE_ENCODING")&&fU().supportDualStreamEncoding)null!=r.scaleResolutionDownBy&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const t=i._originMediaStreamTrack;if(!t.canvas)return Qw.warn("[".concat(i.getTrackId(),"] no canvas on track"));!function(e,t){const n=e.canvas;t.width&&(n.width=zA(t.width)),t.height&&(n.height=zA(t.height)),t.framerate&&(n.stopCapture&&n.stopCapture(),n.stopCapture=hx((()=>{!n.startCapture&&n.stopCapture&&n.stopCapture(),n.startCapture&&n.startCapture()}),zA(t.framerate)))}(t,e)}null!=r.maxBitrate&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),null!=r.maxFramerate&&(i._encoderConfig.frameRate&&"object"==typeof i._encoderConfig.frameRate?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),Qw.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i)}publishLowStream(e){var t=this;return pj((function*(){if(!t.connection||t.state!==aA.Connected)return;const n=yield rj(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const n=t.localTrackMap.get(sA.LocalVideoTrack);if(!n)throw new nR(tR.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(sA.LocalVideoLowTrack))throw new nR(tR.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const r=[{track:t.getLowVideoTrack(n.track,e),type:sA.LocalVideoLowTrack}];if(yield*TG(gW(t.doPublish(t.connection,r))),n.track.muted||!n.track.enabled){var i;const e=null===(i=t.localTrackMap.get(sA.LocalVideoLowTrack))||void 0===i?void 0:i.id;void 0!==e&&(yield rj(t.connection.muteLocal([e])))}}finally{n()}}))()}async republish(){this.pendingLocalTracks.length>0&&(Qw.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await LR(this,cA.RequestRePublish,this.pendingLocalTracks),this.emit(cA.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(Qw.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await LR(this,cA.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:e,kind:n}=this.pendingRemoteTracks[t];(n!==iA.AUDIO||e._audio_added_&&e._audioSSRC)&&(n!==iA.VIDEO||e._video_added_&&e._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await LR(this,cA.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:n}of this.pendingRemoteTracks)await this.subscribe(t,n,n===iA.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:t}=e;this.emit(cA.MediaReconnectEnd,t.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==aA.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const n=t.find((e=>"videoLowTrack"===e[0]));return n&&n[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==aA.Connected)return void e.forEach((e=>{const t=this.pendingLocalDataChannels.indexOf(e);-1!==t&&this.pendingLocalDataChannels.splice(t,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return 0!==t.length?(t.forEach((e=>{const t=this.localDataChannels.indexOf(e);-1!==t&&this.localDataChannels.splice(t,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),t.map((e=>e.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==aA.Connected)return;const e=this.localTrackMap.get(sA.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[sA.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const n=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:n}]=e;return{type:t,track:n}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(e,t){if(!this.connection||this.state!==aA.Connected)throw new nR(tR.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=t.filter((t=>{var n;return!(null!==(n=this.remoteDataChannelMap.get(e))&&void 0!==n&&n.get(t.id))}));if(0!==n.length)return await this.connection.createDataChannels(e.uid,n),n.forEach((t=>{var n;this.remoteDataChannelMap.has(e)?null===(n=this.remoteDataChannelMap.get(e))||void 0===n||n.set(t.id,t):this.remoteDataChannelMap.set(e,new Map([[t.id,t]]));const i=this.pendingRemoteDataChannels.findIndex((n=>{let{user:i,id:r}=n;return i.uid===e.uid&&r===t.id}));-1!==i&&this.pendingRemoteDataChannels.splice(i,1)})),n.map((e=>e.id))}async subscribe(e,t,n,i,r){var o;if(!this.connection||this.state!==aA.Connected)throw new nR(tR.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(o=this.remoteUserMap.get(e))&&void 0!==o&&o.has(t))return;let s,a,c;if(r){const n=r.find((e=>{let{stream_type:n}=e;return n===t}));if(!n)throw new nR(tR.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const i=await this.connection.receive(t,n.ssrcs,String(e._uintid),n.attributes);this.connection instanceof XG&&(c=i.transceiver),s=i.track,a=i.id}else{const r=await this.connection.receive(t,[{ssrcId:n,rtx:i}],String(e._uintid),void 0);this.connection instanceof XG&&(c=r.transceiver),s=r.track,a=r.id}t===iA.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(s):(e._audioTrack=new jF(s,e.uid,e._uintid,this.store),Qw.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(s):(e._videoTrack=new FF(s,e.uid,e._uintid,this.store),Qw.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack)),Dw("ENABLE_VIDEO_SEI")&&c&&(t==iA.VIDEO?await $F(c.receiver,{onSei:t=>{var n;null===(n=e._videoTrack)||void 0===n||n._onSei(t)}}):t==iA.AUDIO&&await async function(e){if(!fU().supportWebRTCEncodedTransform)return void Qw.warning("browser not support audio encoded transform");if(JF.has(e))return;const t={track:e.track};if(OC()){if(!e.createEncodedStreams)return void Qw.warning("browser not support createEncodedStreams() API");let i=null;try{i=e.createEncodedStreams()}catch(e){return void Qw.error("create audio-encoded-streams error",e&&e.message)}const r=new TransformStream({transform(i,r){t.controller||(t.controller=r),e.track&&e.track.id!==t.track.id&&(Qw.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",n),t.track=e.track,t.track.addEventListener("ended",n)),r.enqueue(i)}});i.readable.pipeThrough(r).pipeTo(i.writable)}else if(NC()){if("undefined"==typeof RTCRtpScriptTransform)return void Qw.warning("browser not support RTCRtpScriptTransform");const i=qF(),r=new MessageChannel;await new Gh((e=>i.onmessage=t=>{"registered"===t.data&&e(void 0)}));const o=new RTCRtpScriptTransform(i,{name:"rx",port:r.port2},[r.port2]);e.transform=o,await new Gh((e=>i.onmessage=t=>{"started"===t.data&&e(void 0)})),r.port1.onmessage=i=>{var r;i.data.transformed&&e.track&&(null===(r=e.track)||void 0===r?void 0:r.id)!==t.track.id&&(Qw.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",n),t.track=e.track,t.track.addEventListener("ended",n))},t.worker=i}function n(){e.track.removeEventListener("ended",n),function(e){const t=JF.get(e);if(t){JF.delete(e);try{var n,i;null===(n=t.controller)||void 0===n||n.terminate(),null===(i=t.worker)||void 0===i||i.terminate()}catch(e){Qw.warning(e&&e.message)}}}(e)}JF.set(e,t),e.track.addEventListener("ended",n)}(c.receiver));const l=this.remoteUserMap.get(e);l?l.set(t,a):this.remoteUserMap.set(e,new Map([[t,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const d=this.pendingRemoteTracks.findIndex((n=>{let{user:i,kind:r}=n;return i.uid===e.uid&&t===r}));-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(cA.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==aA.Connected)throw new nR(tR.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((e=>{var t;let{user:n,mediaType:i}=e;return!(null!==(t=this.remoteUserMap.get(n))&&void 0!==t&&t.has(i))}));const t=await this.connection.batchReceive(e.map((e=>{let{user:t,mediaType:n,ssrcId:i,rtxSsrcId:r}=e;return{kind:n,ssrcMsg:[{ssrcId:i,rtx:r}],mslabel:String(t._uintid)}})));e.forEach(((e,n)=>{let{user:i,mediaType:r}=e;const{track:o,id:s,transceiver:a}=t[n];r===iA.AUDIO?(i._audioTrack?i._audioTrack._updateOriginMediaStreamTrack(o):(i._audioTrack=new jF(o,i.uid,i._uintid,this.store),Qw.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(i._audioTrack.getTrackId()))),a&&i._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(i,i._audioTrack)):(i._videoTrack?i._videoTrack._updateOriginMediaStreamTrack(o):(i._videoTrack=new FF(o,i.uid,i._uintid,this.store),Qw.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(i._videoTrack.getTrackId()))),a&&i._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(i,i._videoTrack));const c=this.remoteUserMap.get(i);c?c.set(r,s):this.remoteUserMap.set(i,new Map([[r,s]])),this.statsCollector.addRemoteStats(i.uid),this.statsUploader.startUploadInboundStats();const l=this.pendingRemoteTracks.findIndex((e=>{let{user:t,kind:n}=e;return t.uid===i.uid&&r===n}));-1!==l&&(this.pendingRemoteTracks.splice(l,1),this.emit(cA.MediaReconnectEnd,i.uid))}))}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter((n=>{let{user:i,kind:r}=n;return void 0!==t?i.uid===e.uid&&t===r:i.uid===e.uid}));if(i.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.connection&&this.state===aA.Connected||n||i.forEach((t=>{let{kind:n}=t;var i;if(n===iA.AUDIO)null===(i=e._audioTrack)||void 0===i||i._destroy(),e._audioTrack=void 0;else if(n===iA.VIDEO){var r;null===(r=e._videoTrack)||void 0===r||r._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==aA.Connected)return;const r=this.filterTobeUnSubscribedTracks(e,t);if(0===r.length)return;await this.connection.stopReceiving(r.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),r.forEach((e=>{let[t,{kind:i}]=e;var r,o;if(i===iA.VIDEO&&t._videoSSRC&&(null===(r=this.connection)||void 0===r||r.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),i===iA.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),n||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(i===iA.AUDIO){var s;this.unbindRemoteTrackEvents(t._audioTrack),n||(null===(s=t._audioTrack)||void 0===s||s._destroy(),t._audioTrack=void 0)}})),o}async unsubscribeDataChannel(e,t){if(t.forEach((e=>{const t=this.pendingRemoteDataChannels.findIndex((t=>t.id===e.id));-1!==t&&this.pendingRemoteDataChannels.splice(t,1)})),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(e,t);if(0===n.length)return;t.forEach((e=>{e._close()}));const i=this.remoteDataChannelMap.get(e);return n.forEach((e=>{i&&i.delete(e.id)})),i&&0===i.size&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),n.map((e=>e.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:r,mediaType:o}of e){const e=this.pendingRemoteTracks.filter((e=>{let{user:t,kind:n}=e;return void 0!==o?t.uid===r.uid&&o===n:t.uid===r.uid}));e.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),t=t.concat(e)}if(!this.connection||this.state!==aA.Connected)return void t.forEach((e=>{let{user:t,kind:n}=e;var i;if(n===iA.AUDIO)null===(i=t._audioTrack)||void 0===i||i._destroy(),t._audioTrack=void 0;else if(n===iA.VIDEO){var r;null===(r=t._videoTrack)||void 0===r||r._destroy(),t._videoTrack=void 0}}));const n=Xi(e).call(e,((e,t)=>{let{user:n,mediaType:i}=t;const r=this.filterTobeUnSubscribedTracks(n,i);return e.concat(r)}),[]);if(0===n.length)return;await this.connection.stopReceiving(n.map((e=>{let[,{id:t}]=e;return t})));const i=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),n.forEach((e=>{let[t,{kind:n}]=e;var i,r;if(n===iA.VIDEO&&t._videoSSRC&&(null===(i=this.connection)||void 0===i||i.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),n===iA.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),null===(r=t._videoTrack)||void 0===r||r._destroy(),t._videoTrack=void 0;else if(n===iA.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0}})),i}async muteRemote(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void Qw.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void Qw.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===iA.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==i&&this.connection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);n?n.get(t)||Qw.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,".")):Qw.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."))}getAllTracks(e){const t=this.localTrackMap.get(sA.LocalAudioTrack);if((null==t?void 0:t.track)instanceof UV){const n=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==sA.LocalAudioTrack})).filter((t=>{let[n]=t;return!(e&&n===sA.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[n]=t;return!(e&&n===sA.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,i,r){if(e){const n=this.localTrackMap.get(sA.LocalAudioTrack),o=i?this.localTrackMap.get(sA.LocalVideoLowTrack):this.localTrackMap.get(sA.LocalVideoTrack);oI.publish(this.store.sessionId,{eventElapse:nj.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==o?void 0:o.track.getTrackLabel(),screenshare:-1!==(null==o?void 0:o.track._hints.indexOf(kU.SCREEN_TRACK)),audio:!!n,video:!!o,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const s=n.find((e=>e instanceof kV)),a=i?null===(o=this.localTrackMap.get(sA.LocalVideoTrack))||void 0===o?void 0:o.track:n.find((e=>e instanceof CF));oI.publish(this.store.sessionId,{eventElapse:nj.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==s?void 0:s.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(kU.SCREEN_TRACK)),audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===iA.VIDEO?n._videoSSRC:n._audioSSRC;r&&oI.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===iA.VIDEO,audio:i===iA.AUDIO,peerid:n.uid,subscribeRequestid:i===iA.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:nj.measureFromSubscribeStart(this.store.clientId,r)})}reset(){Qw.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new hw("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new pW({},this.store):this.isPlanB?new bG({},this.store):new XG({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(sA.LocalAudioTrack);if((null==e?void 0:e.track)instanceof UV){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=aA.Disconnected}getStats(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.connection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(sA.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(sA.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof CF||t&&t.track instanceof kV?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(df(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(sA.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=sm(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.connection&&(Qw.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=aA.Reconnecting,Dw("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&(null===(n=t._videoTrack._player.getVideoElement())||void 0===n||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new pW({},this.store):this.isPlanB?new bG({},this.store):new XG({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[n,{track:i}]=e;switch(n){case sA.LocalVideoTrack:Pi(t=i._hints).call(t,kU.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case sA.LocalAudioTrack:i instanceof UV?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case sA.LocalVideoLowTrack:}})),this.emit(cA.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;Array.from(df(n).call(n)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(cA.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,n]=e;Array.from(df(n).call(n)).forEach((e=>{this.setPendingRemoteDataChannel(t,e)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),Qw.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const n of this.pendingRemoteDataChannels){const{user:i,id:r}=n;if((e instanceof jB?e.uid:e)===i.uid&&r===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof jB?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return pj((function*(){if(!t.connection||t.state!==aA.Connected||t.connection instanceof pW)return;const n=yield rj(t.mutex.lock("From P2PChannel.restartICE"));let i;try{i=yield rj(t.connection.restartICE(e));const n=yield rj(i.next());if(n.done)return;const r=n.value,o=yield r;switch(t.reportPCDisconnectedOrFailed(e),e){case rA.TCP:t._pcStatsUploadType=oA.TCP_RESTART;break;case rA.RELAY:t._pcStatsUploadType=oA.RELAY_RESTART;break;default:t._pcStatsUploadType=oA.OLD_RESTART}t._isInRestartIce=!0,i.next(o)}catch(e){var r;null===(r=i)||void 0===r||r.throw(e)}finally{n()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(sA.LocalVideoTrack),n=this.localTrackMap.get(sA.LocalAudioTrack),i=e.videoSend.find((e=>e.ssrc===(null==t?void 0:t.ssrcs[0].ssrcId))),r=e.audioSend.find((e=>e.ssrc===(null==n?void 0:n.ssrcs[0].ssrcId)));if(!i||!r)return 1;const o=UR(this,cA.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,l=(c&&o?(c+o)/2:c||o)||0,d=100*e.sendPacketLossRate*.7/50+.3*l/1500,u=d<.17?1:d<.36?2:d<.59?3:d<.1?4:5,h=null==t?void 0:t.track;if(h&&h._encoderConfig&&-1===h._hints.indexOf(kU.SCREEN_TRACK)){const t=h._encoderConfig.bitrateMax,n=e.bitrate.actualEncoded;if(t&&n){const e=(1e3*t-n)/(1e3*t);return cI[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,o=i._videoSSRC,s=e.audioRecv.find((e=>e.ssrc===r)),a=e.videoRecv.find((e=>e.ssrc===o));if(!s&&!a)return void(t+=1);const c=UR(this,cA.NeedSignalRTT),l=e.rtt,d=(l&&c?(l+c)/2:l||c)||0,u=s?s.jitterMs:void 0,h=e.recvPacketLossRate;let p=.7*h*100/50+.3*d/1500;u&&(p=.6*h*100/50+.2*d/1500+.2*u/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Gh(((t,n)=>{this.handleMuteLocalTrack(e,t,n)}))}async replaceTrack(e,t){var n;if(Qw.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(t.getTrackId(),"]")),!this.connection||this.state!==aA.Connected)return;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(!i)return;const r=i[0];if(e!==t&&(this.unbindLocalTrackEvents([{track:e,type:r}]),this.bindLocalTrackEvents([{track:t,type:r}]),i[1].track=t),await(null===(n=this.connection)||void 0===n?void 0:n.replaceTrack(t,i[1].id)),this.isPlanB){const e=i[1];e.id=t._mediaStreamTrack.id,this.localTrackMap.set(r,e)}if(r===sA.LocalVideoTrack&&!Dw("DISABLE_DUAL_STREAM_USE_ENCODING")&&fU().supportDualStreamEncoding){const t=this.localTrackMap.get(sA.LocalVideoLowTrack);if(t){const n=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=n,t.track._originMediaStreamTrack=n,await new Gh(((e,n)=>{this.handleReplaceTrack(t.track,e,n,!0)}))}}}filterTobePublishedTracks(e,t,n){const i=[],r=this.getAllTracks();e=jR(e=e.filter((e=>-1===r.indexOf(e))));let o,s=!1;const a=this.localTrackMap.get(sA.LocalAudioTrack);for(const c of e){if(c instanceof CF&&(this.localTrackMap.has(sA.LocalVideoTrack)||s?new nR(tR.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:sA.LocalVideoTrack}),s=!0),t)){const e=this.getLowVideoTrack(c,n);i.push({track:e,type:sA.LocalVideoLowTrack})}if(c instanceof kV)if(a){const e=a.track;if(e instanceof UV)WB([c]),e.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{const t=HB([e,c]);Qw.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(t.getTrackId(),"]")),this.replaceTrack(e,t)}}else o instanceof UV?(WB([c]),o.addAudioTrack(c)):o=o||!c._useAudioElement&&fU().webAudioMediaStreamDest&&!c._bypassWebAudio?HB(o?[c,o]:[c]):c}return o&&(Qw.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),i.push({track:o,type:sA.LocalAudioTrack})),i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=jR(e=e.filter((e=>-1!==n.indexOf(e))));for(const i of e){if(i instanceof kV){const e=this.localTrackMap.get(sA.LocalAudioTrack);if(!e)continue;e.track instanceof UV?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([sA.LocalAudioTrack,e]),e.track.close())):t.push([sA.LocalAudioTrack,e])}if(i instanceof CF){const e=this.localTrackMap.get(sA.LocalVideoTrack);if(!e)continue;t.push([sA.LocalVideoTrack,e]);const n=this.localTrackMap.get(sA.LocalVideoLowTrack);n&&t.push([sA.LocalVideoLowTrack,n])}}return t}filterTobePublishedDataChannels(e){return(e=jR(e)).filter((e=>-1===this.localDataChannels.findIndex((t=>t.id===e.id))))}filterTobeUnpublishedDataChannels(e){return(e=(e=jR(e)).filter((e=>-1!==this.localDataChannels.indexOf(e)))).filter((e=>e._originDataChannel))}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:n}=e;switch(n){case sA.LocalVideoTrack:t.addListener(PU.GET_STATS,this.handleGetLocalVideoStats),t.addListener(PU.GET_RTC_STATS,this.handleGetRTCStats),t.addListener(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(PU.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(PU.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.addListener(PU.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case sA.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case sA.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof UV?e.trackList.forEach((e=>{e.addListener(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(PU.GET_STATS,this.handleGetLocalAudioStats),e.addListener(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(PU.GET_STATS,this.handleGetLocalAudioStats),e.addListener(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(PU.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(PU.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:n}]=e;return{track:n,type:t}}))),e.forEach((e=>{let{track:t,type:n}=e;switch(n){case sA.LocalVideoTrack:t.off(PU.GET_STATS,this.handleGetLocalVideoStats),t.off(PU.GET_RTC_STATS,this.handleGetRTCStats),t.off(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(PU.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(PU.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.off(PU.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case sA.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case sA.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof UV?e.trackList.forEach((e=>{e.off(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(PU.GET_STATS,this.handleGetLocalAudioStats),e.off(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(PU.GET_STATS,this.handleGetLocalAudioStats),e.off(PU.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(PU.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(PU.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(PU.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(PU.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(PU.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof FF&&t.addListener(PU.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof jF&&t.addListener(PU.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(PU.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;n.has(iA.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(iA.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,n)=>{var i;let r,o,{track:s,type:a}=e;switch(a){case sA.LocalAudioTrack:r=Kb.Audio,o={dtx:s instanceof LV&&s._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case sA.LocalVideoTrack:r=Pi(i=s._hints).call(i,kU.SCREEN_TRACK)?Kb.Screen:Kb.High,o=EW(EW({},qA(s)),{},{codec:this.store.codec});break;case sA.LocalVideoLowTrack:r=Kb.Low,o=EW(EW({},qA(s)),{},{codec:this.store.codec})}return{stream_type:r,attributes:o,ssrcs:t[n]}}))}createGatewayUnpublishMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case sA.LocalVideoTrack:n=Pi(t=r._hints).call(t,kU.SCREEN_TRACK)?Kb.Screen:Kb.High;break;case sA.LocalAudioTrack:n=Kb.Audio;break;case sA.LocalVideoLowTrack:n=Kb.Low}return{stream_type:n,ssrcs:o,mid:s}}))}assignLocalTracks(e,t){e.forEach(((e,n)=>{let{track:i,type:r}=e;this.localTrackMap.set(r,{track:i,id:t[n].id,ssrcs:t[n].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(cA.PeerConnectionStateChange,t),"connected"!==t||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===t&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),Dw("NEW_ICE_RESTART")){var n;if(Pi(n=this._restartStates).call(n,t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const t=t=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(Qw.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(t)),"CONNECTED"===UR(this,cA.QueryClientConnectionState)&&this.emit(cA.RequestRestartICE,t))},n=()=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),Qw.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(cA.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},i=Dw("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(Dw("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&fU().supportPCSetConfiguration)t(rA.RELAY),this._restartTimer=window.setTimeout(n,i);else if(PC())t(rA.UDP),this._restartTimer=window.setTimeout(n,4e3);else{if(t(rA.TCP),fU().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{t(rA.RELAY),this._restartTimer=window.setTimeout(n,i)}),i));this._restartTimer=window.setTimeout(n,i)}}),800))}}else{if("disconnected"===t&&"disconnected"===e.iceConnectionState)return setTimeout((()=>{"disconnected"===e.iceConnectionState&&Dw("ICE_RESTART")&&"CONNECTED"===UR(this,cA.QueryClientConnectionState)&&this.emit(cA.RequestRestartICE)}),800),void setTimeout((()=>{"disconnected"===e.peerConnectionState&&(Qw.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(cA.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===t&&(Qw.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(cA.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),oI.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:CR.TRACER}).onSuccess(),this.emit(cA.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{var t;const n=Array.from(df(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var i;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),null===(i=n.audioTrack)||void 0===i||i.emit(FU.FIRST_FRAME_DECODED),oI.firstRemoteFrame(this.store.sessionId,tI.FIRST_AUDIO_DECODE,nI.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:nj.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{var t;const n=Array.from(df(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));n&&oI.firstRemoteFrame(this.store.sessionId,tI.FIRST_AUDIO_RECEIVED,nI.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:nj.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,n)=>{this.reportVideoFirstFrameDecoded(e,t,n)},e.onFirstVideoReceived=e=>{var t;const n=Array.from(df(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));n&&oI.firstRemoteFrame(this.store.sessionId,tI.FIRST_VIDEO_RECEIVED,nI.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:nj.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,t)=>{const n="relay"===e.candidateType,i="relay"===t.candidateType;"unknown"!==t.candidateType&&n===i||this.emit(cA.ConnectionTypeChange,n),Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ZA(t))," -> ").concat(JSON.stringify(ZA(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,t)=>{Qw.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ZA(t))," -> ").concat(JSON.stringify(ZA(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.getLocalVideoStats=()=>{const e=this.statsCollector.getLocalVideoTrackStats(),t=this.statsCollector.getRTCStats();return EW(EW({},e),t)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const n=this.localTrackMap.get(sA.LocalAudioTrack);if(e instanceof kV&&(null==n?void 0:n.track)instanceof UV)return n.track.isActive||t.push([sA.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(i&&(t.push(i),i[0]===sA.LocalVideoTrack)){const e=this.localTrackMap.get(sA.LocalVideoLowTrack);e&&t.push([sA.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(sA.LocalAudioTrack);if(e instanceof kV&&(null==n?void 0:n.track)instanceof UV)return n.track.isActive&&t.push([sA.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:n}]=t;return e===n}));if(i)if(i[0]===sA.LocalVideoTrack){t.push(i);const e=this.localTrackMap.get(sA.LocalVideoLowTrack);e&&t.push([sA.LocalVideoLowTrack,e])}else t.push(i);return t}createMuteMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case sA.LocalAudioTrack:n=Kb.Audio;break;case sA.LocalVideoTrack:n=Pi(t=r._hints).call(t,kU.SCREEN_TRACK)?Kb.Screen:Kb.High;break;case sA.LocalVideoLowTrack:n=Kb.Low}return{stream_type:n,ssrcs:o,mid:s}}))}createUnmuteMessage(e){return e.map((e=>{var t;let n,[i,{track:r,ssrcs:o,id:s}]=e;switch(i){case sA.LocalAudioTrack:n=Kb.Audio;break;case sA.LocalVideoTrack:n=Pi(t=r._hints).call(t,kU.SCREEN_TRACK)?Kb.Screen:Kb.High;break;case sA.LocalVideoLowTrack:n=Kb.Low}return{stream_type:n,ssrcs:o,mid:s}}))}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach((t=>{let[i,r]=t;n.push([e,{kind:i,id:r}])}));return n}filterTobeUnSubscribedDataChannels(e,t){const n=[];return t.forEach((t=>{var i;null!==(i=this.remoteDataChannelMap.get(e))&&void 0!==i&&i.has(t.id)&&n.push(t)})),n}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[n,{kind:i,id:r}]=e;switch(i){case iA.VIDEO:return void(n._videoSSRC&&t.push({stream_type:iA.VIDEO,ssrcId:n._videoSSRC}));case iA.AUDIO:return void(n._audioSSRC&&t.push({stream_type:iA.AUDIO,ssrcId:n._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((e=>{let[n,{kind:i}]=e;if(t.has(n)){let e=t.get(n);i===iA.VIDEO?e|=Yb.Video:e|=Yb.Audio,t.set(n,e)}else i===iA.VIDEO?t.set(n,Yb.Video):t.set(n,Yb.Audio)})),{users:Array.from(t.entries()).map((e=>{let[t,n]=e;return{stream_id:t.uid,stream_type:n}}))}}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:n}]=e;const i=this.remoteUserMap.get(t);i&&(i.delete(n),0===Array.from(i.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(sA.LocalVideoTrack),n=this.localTrackMap.get(sA.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),n&&e.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return!this.connection||"connected"!==this.connection.peerConnectionState}mapPubResToRemoteConfig(e,t){return e.map(((e,n)=>{var i;let{stream_type:r}=e;return null===(i=t.find((e=>{let{stream_type:t}=e;return r===t})))||void 0===i?void 0:i.attributes}))}async tryToUnmuteAudio(e){for(let n=0;n<e.length;n++)if(e[n]instanceof kV){var t;const i=this.filterTobeUnmutedTracks(e[n]);if(0===i.length)continue;await(null===(t=this.connection)||void 0===t?void 0:t.unmuteLocal(i.map((e=>{let[,{id:t}]=e;return t}))));const r=this.createUnmuteMessage(i);return void await MR(this,cA.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.connection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(cA.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(cA.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await $R(mw(this.dtlsFailedCount,fw)),this.emit(cA.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await LR(this,cA.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(cA.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(sA.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof CF))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof CF)).length>1)throw new nR(tR.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof kV)).length>1&&(e.some((e=>e instanceof kV&&e._bypassWebAudio))||!fU().webAudioMediaStreamDest))throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof CF&&this.pendingLocalTracks.some((e=>e instanceof CF)))throw new nR(tR.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof kV&&this.pendingLocalTracks.some((e=>e instanceof kV))&&(!fU().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof kV&&e._bypassWebAudio))))throw new nR(tR.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const n=!Dw("DISABLE_DUAL_STREAM_USE_ENCODING")&&fU().supportDualStreamEncoding,i=EW(EW({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=n?e._mediaStreamTrack.clone():CB(e,i);const o=ew(8,"track-low-"),s=new CF(r,EW(EW({},n&&{scaleResolutionDownBy:QA(i,e)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(xU.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,LU.LOW_STREAM)})),s._hints.push(kU.LOW_STREAM),e.on("sei-to-send",(e=>{s.emit("sei-to-send",e)})),e.addListener(PU.NEED_CLOSE,(()=>{s.close()})),s}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof XG){var r,o,s,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:l,dtlsTransportState:d,peerConnectionState:u}=this.connection,{local:h,remote:p}=await this.connection.getSelectedCandidatePair();oI.pcStats(this.store.sessionId,{startTime:c,eventElapse:e-c||0,iceconnectionsate:l,dtlsstate:d,connectionstate:u,intSucc:t?1:2,error:i,selectedLocalCandidateProtocol:null!==(r=null==h?void 0:h.protocol)&&void 0!==r?r:"",selectedLocalCandidateType:null!==(o=h.candidateType)&&void 0!==o?o:"",selectedLocalCandidateAddress:"".concat(h.address,":").concat(h.port),selectedRemoteCandidateProtocol:null!==(s=p.protocol)&&void 0!==s?s:"",selectedRemoteCandidateType:null!==(a=p.candidateType)&&void 0!==a?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:n})}}reportVideoFirstFrameDecoded(e,t,n,i){var r;const o=Array.from(df(r=this.remoteUserMap).call(r)).find((t=>t._videoSSRC===e));if(o){i||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const r=this.store.keyMetrics,s=r.subscribe.find((e=>e.userId===o.uid&&"video"===e.type));oI.firstRemoteVideoDecode(this.store.sessionId,tI.FIRST_VIDEO_DECODE,nI.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:t,videoheight:n,subscribeElapse:nj.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:r.requestAPEnd||0,apStart:r.requestAPStart||0,joinGwEnd:r.joinGatewayEnd||0,joinGwStart:r.joinGatewayStart||0,pcEnd:r.peerConnectionEnd||0,pcStart:r.peerConnectionStart||0,subscriberEnd:(null==s?void 0:s.subscribeEnd)||0,subscriberStart:(null==s?void 0:s.subscribeStart)||0,videoAddNotify:(null==s?void 0:s.streamAdded)||0,state:i?1:0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.connection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const o=await this.connection.getRemoteSSRC(r);return void 0!==o&&o!==n}resetConnection(e){Qw.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===aA.Connected?(Qw.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===Jb.datachannel?new pW({},this.store):this.isPlanB?new bG({},this.store):new XG({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:n}]=e;t===sA.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,LU.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof XG&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===oA.TCP_RESTART&&e===rA.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,oA.DISCONNECTED_OR_FAILED)))}},ib(mW.prototype,"startP2PConnection",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"startP2PConnection"),mW.prototype),ib(mW.prototype,"connect",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"connect"),mW.prototype),ib(mW.prototype,"updateRemoteRTPCapabilities",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"updateRemoteRTPCapabilities"),mW.prototype),ib(mW.prototype,"preConnect",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"preConnect"),mW.prototype),ib(mW.prototype,"publishDataChannel",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"publishDataChannel"),mW.prototype),ib(mW.prototype,"unpublish",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"unpublish"),mW.prototype),ib(mW.prototype,"unpublishDataChannel",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"unpublishDataChannel"),mW.prototype),ib(mW.prototype,"unpublishLowStream",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"unpublishLowStream"),mW.prototype),ib(mW.prototype,"subscribeDataChannel",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"subscribeDataChannel"),mW.prototype),ib(mW.prototype,"subscribe",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"subscribe"),mW.prototype),ib(mW.prototype,"massSubscribe",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"massSubscribe"),mW.prototype),ib(mW.prototype,"unsubscribe",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"unsubscribe"),mW.prototype),ib(mW.prototype,"unsubscribeDataChannel",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"unsubscribeDataChannel"),mW.prototype),ib(mW.prototype,"massUnsubscribe",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"massUnsubscribe"),mW.prototype),ib(mW.prototype,"muteRemote",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"muteRemote"),mW.prototype),ib(mW.prototype,"unmuteRemote",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"unmuteRemote"),mW.prototype),ib(mW.prototype,"hasRemoteMediaWithLock",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"hasRemoteMediaWithLock"),mW.prototype),ib(mW.prototype,"disconnectForReconnect",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"disconnectForReconnect"),mW.prototype),ib(mW.prototype,"updateBitrateLimit",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"updateBitrateLimit"),mW.prototype),ib(mW.prototype,"remoteMediaSsrcChanged",[SW],Object.getOwnPropertyDescriptor(mW.prototype,"remoteMediaSsrcChanged"),mW.prototype),mW);function SW(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From P2PChannel.".concat(t));try{for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return await i.apply(this,o)}finally{n()}},n}function yW(e){let t=kW();return function(e,t){let n=e.appId;void 0!==n&&(qW(t,10),jW(t,n));let i=e.cid;void 0!==i&&(qW(t,16),qW(t,i));let r=e.cname;void 0!==r&&(qW(t,26),jW(t,r));let o=e.deviceId;void 0!==o&&(qW(t,34),jW(t,o));let s=e.elapse;void 0!==s&&(qW(t,40),YW(t,s));let a=e.fileSize;void 0!==a&&(qW(t,48),YW(t,DW(a)));let c=e.height;void 0!==c&&(qW(t,56),YW(t,DW(c)));let l=e.jpg;void 0!==l&&(qW(t,66),qW(t,l.length),function(e,t){let n=xW(e,t.length);e.bytes.set(t,n)}(t,l));let d=e.networkType;void 0!==d&&(qW(t,72),YW(t,DW(d)));let u=e.osType;void 0!==u&&(qW(t,80),YW(t,DW(u)));let h=e.requestId;void 0!==h&&(qW(t,90),jW(t,h));let p=e.sdkVersion;void 0!==p&&(qW(t,98),jW(t,p));let f=e.sequence;void 0!==f&&(qW(t,104),YW(t,DW(f)));let m=e.sid;void 0!==m&&(qW(t,114),jW(t,m));let _=e.timestamp;void 0!==_&&(qW(t,120),YW(t,_));let E=e.uid;void 0!==E&&(qW(t,128),qW(t,E));let g=e.vid;void 0!==g&&(qW(t,136),qW(t,g));let v=e.width;void 0!==v&&(qW(t,144),YW(t,DW(v)));let T=e.service;void 0!==T&&(qW(t,152),qW(t,T));let S=e.callbackData;void 0!==S&&(qW(t,162),jW(t,S));let y=e.jpgEncryption;void 0!==y&&(qW(t,168),qW(t,y));let C=e.requestType;void 0!==C&&(qW(t,176),qW(t,C));let R=e.scorePorn;void 0!==R&&(qW(t,185),KW(t,R));let w=e.scoreSexy;void 0!==w&&(qW(t,193),KW(t,w));let I=e.scoreNeutral;void 0!==I&&(qW(t,201),KW(t,I));let b=e.scene;void 0!==b&&(qW(t,208),qW(t,b));let A=e.ossFilePrefix;void 0!==A&&(qW(t,218),jW(t,A));let O=e.serviceVendor;if(void 0!==O)for(let N of O){qW(t,226);let e=kW();wW(N,e),qW(t,e.limit),BW(t,e),LW(e)}}(e,t),function(e){let t=e.bytes,n=e.limit;return t.length===n?t:t.subarray(0,n)}(t)}function CW(e){return function(e){let t={};e:for(;!UW(e);){let n=zW(e);switch(n>>>3){case 0:break e;case 1:t.code=zW(e);break;case 2:t.msg=FW(e,zW(e));break;case 3:{let n=IW(e);t.data=RW(e),e.limit=n;break}default:bW(e,7&n)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function RW(e){let t={};e:for(;!UW(e);){let n=zW(e);switch(n>>>3){case 0:break e;case 1:t.requestId=FW(e,zW(e));break;case 2:t.requestType=zW(e)>>>0;break;case 3:t.scorePorn=HW(e);break;case 4:t.scoreSexy=HW(e);break;case 5:t.scoreNeutral=HW(e);break;case 6:t.requestScene=zW(e)>>>0;break;case 7:t.scene=zW(e)>>>0;break;default:bW(e,7&n)}}return t}function wW(e,t){let n=e.service;void 0!==n&&(qW(t,8),qW(t,n));let i=e.vendor;void 0!==i&&(qW(t,16),qW(t,i));let r=e.token;void 0!==r&&(qW(t,26),jW(t,r));let o=e.callbackUrl;void 0!==o&&(qW(t,34),jW(t,o))}function IW(e){let t=zW(e),n=e.limit;return e.limit=e.offset+t,n}function bW(e,t){switch(t){case 0:for(;128&GW(e););break;case 2:MW(e,zW(e));break;case 5:MW(e,4);break;case 1:MW(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let AW=new Float32Array(1);new Uint8Array(AW.buffer);let OW=new Float64Array(1),NW=new Uint8Array(OW.buffer);function DW(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let PW=[];function kW(){const e=PW.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function LW(e){PW.push(e)}function MW(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function UW(e){return e.offset>=e.limit}function xW(e,t){let n=e.bytes,i=e.offset,r=e.limit,o=i+t;if(o>n.length){let t=new Uint8Array(2*o);t.set(n),e.bytes=t}return e.offset=o,o>r&&(e.limit=o),i}function VW(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function FW(e,t){let n=VW(e,t),i=String.fromCharCode,r=e.bytes,o="\ufffd",s="";for(let a=0;a<t;a++){let e,c,l,d,u=r[a+n];0==(128&u)?s+=i(u):192==(224&u)?a+1>=t?s+=o:(e=r[a+n+1],128!=(192&e)?s+=o:(d=(31&u)<<6|63&e,d<128?s+=o:(s+=i(d),a++))):224==(240&u)?a+2>=t?s+=o:(e=r[a+n+1],c=r[a+n+2],32896!=(49344&(e|c<<8))?s+=o:(d=(15&u)<<12|(63&e)<<6|63&c,d<2048||d>=55296&&d<=57343?s+=o:(s+=i(d),a+=2))):240==(248&u)?a+3>=t?s+=o:(e=r[a+n+1],c=r[a+n+2],l=r[a+n+3],8421504!=(12632256&(e|c<<8|l<<16))?s+=o:(d=(7&u)<<18|(63&e)<<12|(63&c)<<6|63&l,d<65536||d>1114111?s+=o:(d-=65536,s+=i(55296+(d>>10),56320+(1023&d)),a+=3))):s+=o}return s}function jW(e,t){let n=t.length,i=0;for(let s=0;s<n;s++){let e=t.charCodeAt(s);e>=55296&&e<=56319&&s+1<n&&(e=(e<<10)+t.charCodeAt(++s)-56613888),i+=e<128?1:e<2048?2:e<65536?3:4}qW(e,i);let r=xW(e,i),o=e.bytes;for(let s=0;s<n;s++){let e=t.charCodeAt(s);e>=55296&&e<=56319&&s+1<n&&(e=(e<<10)+t.charCodeAt(++s)-56613888),e<128?o[r++]=e:(e<2048?o[r++]=e>>6&31|192:(e<65536?o[r++]=e>>12&15|224:(o[r++]=e>>18&7|240,o[r++]=e>>12&63|128),o[r++]=e>>6&63|128),o[r++]=63&e|128)}}function BW(e,t){let n=xW(e,t.limit),i=e.bytes,r=t.bytes;for(let o=0,s=t.limit;o<s;o++)i[o+n]=r[o]}function GW(e){return e.bytes[VW(e,1)]}function WW(e,t){let n=xW(e,1);e.bytes[n]=t}function HW(e){let t=VW(e,8),n=e.bytes;return NW[0]=n[t++],NW[1]=n[t++],NW[2]=n[t++],NW[3]=n[t++],NW[4]=n[t++],NW[5]=n[t++],NW[6]=n[t++],NW[7]=n[t++],OW[0]}function KW(e,t){let n=xW(e,8),i=e.bytes;OW[0]=t,i[n++]=NW[0],i[n++]=NW[1],i[n++]=NW[2],i[n++]=NW[3],i[n++]=NW[4],i[n++]=NW[5],i[n++]=NW[6],i[n++]=NW[7]}function zW(e){let t,n=0,i=0;do{t=GW(e),n<32&&(i|=(127&t)<<n),n+=7}while(128&t);return i}function qW(e,t){for(t>>>=0;t>=128;)WW(e,127&t|128),t>>>=7;WW(e,t)}function YW(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,o=0===r?0===i?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=xW(e,o),a=e.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=9!==o?128|r:127&r;case 8:a[s+7]=8!==o?i>>>21|128:i>>>21&127;case 7:a[s+6]=7!==o?i>>>14|128:i>>>14&127;case 6:a[s+5]=6!==o?i>>>7|128:i>>>7&127;case 5:a[s+4]=5!==o?128|i:127&i;case 4:a[s+3]=4!==o?n>>>21|128:n>>>21&127;case 3:a[s+2]=3!==o?n>>>14|128:n>>>14&127;case 2:a[s+1]=2!==o?n>>>7|128:n>>>7&127;case 1:a[s]=1!==o?128|n:127&n}}function JW(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}const XW=new Map([["moderation",1],["supervise",2]]);class QW extends vR{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(uA.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){var t;this._inspectMode=Xi(t=e.map((e=>XW.get(e)||0))).call(t,((e,t)=>e+t)),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(e){super(),iT(this,"name","AgoraRTCVideoContentInspect"),iT(this,"_connectionState",lA.CONNECTING),iT(this,"_innerConnectionState",void 0),iT(this,"sequence",0),iT(this,"inspectStartTime",void 0),iT(this,"workerManagerConnection",void 0),iT(this,"workerConnection",void 0),iT(this,"workerMessageLengthLimit",void 0),iT(this,"inspectIntervalMinimum",void 0),iT(this,"qualityRatio",void 0),iT(this,"_connectInfo",void 0),iT(this,"_cancelTokenSource",pC.CancelToken.source()),iT(this,"_retryConfig",void 0),iT(this,"wmSequence",0),iT(this,"inspectInterval",void 0),iT(this,"inspectTimer",null),iT(this,"ossFilePrefix",void 0),iT(this,"extraInfo",void 0),iT(this,"_inspectType",void 0),iT(this,"_inspectMode",void 0),iT(this,"_quality",1),iT(this,"qualityTimer",null),iT(this,"_inspectId",void 0),iT(this,"_needWorkUrlOnly",!1),iT(this,"inspectImage",(()=>{if(this.connectionState!==lA.CONNECTED)throw new bb(tR.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===lA.CONNECTED?this.requestToInspectImage():Qw.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()})),this._inspectId=ew(5,"inspect-"),this.workerMessageLengthLimit=Dw("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=Dw("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=Dw("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new FA("worker-manager-"+this._inspectId,fw),this.on(uA.STATE_CHANGE,((e,t)=>{this._innerConnectionState=e,Qw.debug("[".concat(this._inspectId,"] Inspect operation :").concat(dA[e]," ").concat(t||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new FA("worker-"+this._inspectId,fw),this.handleWorkerEvents()}async init(e,t){this.emit(uA.STATE_CHANGE,dA.CONNECT_AP),this._connectInfo=e;const n=this._cancelTokenSource.token;return this._retryConfig=t,new Gh(((i,r)=>{this.on(uA.CONNECTION_STATE_CHANGE,((e,t)=>{t===lA.CONNECTED&&i()})),this.requestAP(e,n,t).then((e=>{this.connectWorkerManager(e)})).catch((e=>{r(e)}))}))}async requestAP(e,t,n){const i=Dw("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),r=await function(e,t,n,i){let{appId:r,areaCode:o,cname:s,sid:a,token:c,uid:l}=t;MO++;const d="image_moderation_api",u={service_name:d,json_body:JSON.stringify({appId:r,areaCode:o,cname:s,command:"allocateEdge",requestId:MO,seq:MO,sid:a,token:c,ts:Date.now(),uid:l+""})};let h,p,f=e[0];return _w((async()=>{h=Date.now();const e=await pO(f,{data:u,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-h,0!==e.code){const t=new bb(tR.UNEXPECTED_RESPONSE,"image inspect ap error, code"+e.code,{retry:!0,responseTime:p});throw Qw.error(t.toString()),t}const t=JSON.parse(e.json_body);if(200!==t.code){const e=new bb(tR.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(t.code,", reason: ").concat(t.reason),{code:t.code,responseTime:p});throw Qw.error(e.toString()),e}if(!t.servers||!Array.isArray(t.servers)||0===t.servers.length){const e=new bb(tR.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:t.code,responseTime:p});throw Qw.error(e.toString()),e}const i=Dw("VIDEO_INSPECT_WORKER_MANAGER_HOST"),r=Dw("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:t.servers.map((e=>{let{address:t,wss:n}=e;if(t&&n)return"wss://".concat(t.replace(/\./g,"-"),".").concat(i,":").concat(r||n)})).filter((e=>!!e)),workerToken:t.workerToken,vid:t.vid,responseTime:p}}),((t,n)=>(oI.apworkerEvent(a,{success:!0,sc:200,serviceName:d,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:p,serverIp:e[n%e.length]}),!1)),((t,n)=>(oI.apworkerEvent(a,{success:!1,sc:t.data&&t.data.code||200,serviceName:d,responseTime:p,serverIp:e[n%e.length]}),!!(t.code!==tR.OPERATION_ABORTED&&t.code!==tR.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(n+1)%e.length],!0))),i)}(i,e,t,n);this.emit(uA.STATE_CHANGE,dA.AP_CONNECTED);const{addressList:o}=r;return this.wmSequence++,o}async connectWorkerManager(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=t,this.emit(uA.STATE_CHANGE,dA.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Ib.CONNECTED,(async()=>{this.emit(uA.STATE_CHANGE,dA.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.21.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(Ib.CLOSED,(()=>{this._innerConnectionState<dA.GET_WORKER_MANAGER_RESPONSE&&Qw.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(Ib.FAILED,(()=>{this._innerConnectionState<dA.GET_WORKER_MANAGER_RESPONSE&&Qw.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(Ib.RECONNECTING,(()=>{this._innerConnectionState<dA.GET_WORKER_MANAGER_RESPONSE&&Qw.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(Ib.ON_MESSAGE,(async e=>{this.emit(uA.STATE_CHANGE,dA.GET_WORKER_MANAGER_RESPONSE);const t=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(e.data);if(200!==n.code)throw Qw.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new bb(tR.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&t))throw Qw.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new bb(tR.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const e=Dw("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,i=t.replace(/:\d+\/?$/,":".concat(e));this.emit(uA.STATE_CHANGE,dA.CONNECT_WORKER,i),this._needWorkUrlOnly?this.emit(uA.REQUEST_NEW_WORKER_URL,i):await this.connectWorker(i)}})),this.workerManagerConnection.on(Ib.WILL_RECONNECT,((e,t,n)=>{n(e)})),this.workerManagerConnection.on(Ib.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}handleWorkerEvents(){this.workerConnection.on(Ib.CONNECTED,(async()=>{this.emit(uA.STATE_CHANGE,dA.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=lA.CONNECTED})),this.workerConnection.on(Ib.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const n=CW(new Uint8Array(e.data));if(Dw("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&Qw.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),200===n.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(uA.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var t;const e={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},i=Xi(t=Object.keys(e)).call(t,((t,n)=>e[t]>e[n]?t:n),"porn"),r=Object.keys(e).find((e=>e===i));this.emit(uA.INSPECT_RESULT,r)}else this.emit(uA.INSPECT_RESULT,void 0,new bb(tR.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(uA.INSPECT_RESULT,void 0,new bb(tR.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else Qw.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(uA.INSPECT_RESULT,void 0,new bb(tR.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(Ib.CLOSED,(()=>{this.connectionState=lA.CLOSED})),this.workerConnection.on(Ib.FAILED,(()=>{this.connectionState=lA.CLOSED})),this.workerConnection.on(Ib.RECONNECTING,(()=>{this.connectionState=this.connectionState===lA.CONNECTED?lA.RECONNECTING:lA.CONNECTING})),this.workerConnection.on(Ib.WILL_RECONNECT,((e,t,n)=>{"recover"===e&&n(e),n("tryNext")})),this.workerConnection.on(Ib.REQUEST_NEW_URLS,((e,t)=>{this.workerManagerConnection.close(),this.once(uA.REQUEST_NEW_WORKER_URL,(t=>{e([t])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((e=>{this.connectWorkerManager(e,!0)})).catch((e=>{t(e)}))}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=UR(this,uA.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(uA.INSPECT_RESULT,void 0,new bb(tR.INVALID_OPERATION,"Only the track being played can be inspected"));const n=await this.generateRequestData(e,t);this.workerConnection.sendMessage(n,!0,!0)}else this.emit(uA.INSPECT_RESULT,void 0,new bb(tR.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,t){let{appId:n,cname:i,cid:r,vid:o,sid:s,uid:a}=t;const c=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),d=await Hx(l,n,i),u=this.sequence+"-"+r+"-"+a+"-"+c+"-"+ew(12,""),h={appId:n,cid:r,cname:i,deviceId:"",elapse:QW.intToLong(Number(c-this.inspectStartTime)),fileSize:d.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:d,networkType:6,osType:7,requestId:u,sdkVersion:"4.21.0",sequence:this.sequence,sid:s,timestamp:QW.intToLong(c),uid:a,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete h.callbackData,void 0===this.ossFilePrefix&&delete h.ossFilePrefix;const p=yW(h);if(p.byteLength<this.workerMessageLengthLimit){if(Dw("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const e=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?JW(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):JW(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},h);delete e.jpg,Qw.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(e))}return p}{const t=this.quality*this.qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:i,cid:r,vid:o,sid:s,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=pC.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=lA.CLOSED,this.emit(uA.STATE_CHANGE,dA.CLOSED)}}function ZW(e){let t=function(){const e=nH.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,t){let n=e.appId;void 0!==n&&(pH(t,10),lH(t,n));let i=e.cid;void 0!==i&&(pH(t,16),pH(t,i));let r=e.cname;void 0!==r&&(pH(t,26),lH(t,r));let o=e.deviceId;void 0!==o&&(pH(t,34),lH(t,o));let s=e.elapse;void 0!==s&&(pH(t,40),mH(t,s));let a=e.fileSize;void 0!==a&&(pH(t,48),mH(t,tH(a)));let c=e.height;void 0!==c&&(pH(t,56),mH(t,tH(c)));let l=e.jpg;void 0!==l&&(pH(t,66),pH(t,l.length),aH(t,l));let d=e.networkType;void 0!==d&&(pH(t,72),mH(t,tH(d)));let u=e.osType;void 0!==u&&(pH(t,80),mH(t,tH(u)));let h=e.requestId;void 0!==h&&(pH(t,90),lH(t,h));let p=e.sdkVersion;void 0!==p&&(pH(t,98),lH(t,p));let f=e.sequence;void 0!==f&&(pH(t,104),mH(t,tH(f)));let m=e.sid;void 0!==m&&(pH(t,114),lH(t,m));let _=e.timestamp;void 0!==_&&(pH(t,120),mH(t,_));let E=e.uid;void 0!==E&&(pH(t,128),pH(t,E));let g=e.vid;void 0!==g&&(pH(t,136),pH(t,g));let v=e.width;void 0!==v&&(pH(t,144),mH(t,tH(v)));let T=e.service;void 0!==T&&(pH(t,152),pH(t,T));let S=e.callbackData;void 0!==S&&(pH(t,162),pH(t,S.length),aH(t,S));let y=e.ticket;void 0!==y&&(pH(t,170),lH(t,y));let C=e.vendorConfigs;void 0!==C&&(pH(t,178),lH(t,C))}(e,t),function(e){let t=e.bytes,n=e.limit;return t.length===n?t:t.subarray(0,n)}(t)}function $W(e){return function(e){let t={};e:for(;!rH(e);){let n=hH(e);switch(n>>>3){case 0:break e;case 1:t.code=hH(e);break;case 2:t.msg=cH(e,hH(e));break;case 3:t.requestId=cH(e,hH(e));break;case 4:t.timestamp=fH(e,!1);break;default:eH(e,7&n)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function eH(e,t){switch(t){case 0:for(;128&dH(e););break;case 2:iH(e,hH(e));break;case 5:iH(e,4);break;case 1:iH(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function tH(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let nH=[];function iH(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function rH(e){return e.offset>=e.limit}function oH(e,t){let n=e.bytes,i=e.offset,r=e.limit,o=i+t;if(o>n.length){let t=new Uint8Array(2*o);t.set(n),e.bytes=t}return e.offset=o,o>r&&(e.limit=o),i}function sH(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function aH(e,t){let n=oH(e,t.length);e.bytes.set(t,n)}function cH(e,t){let n=sH(e,t),i=String.fromCharCode,r=e.bytes,o="\ufffd",s="";for(let a=0;a<t;a++){let e,c,l,d,u=r[a+n];0==(128&u)?s+=i(u):192==(224&u)?a+1>=t?s+=o:(e=r[a+n+1],128!=(192&e)?s+=o:(d=(31&u)<<6|63&e,d<128?s+=o:(s+=i(d),a++))):224==(240&u)?a+2>=t?s+=o:(e=r[a+n+1],c=r[a+n+2],32896!=(49344&(e|c<<8))?s+=o:(d=(15&u)<<12|(63&e)<<6|63&c,d<2048||d>=55296&&d<=57343?s+=o:(s+=i(d),a+=2))):240==(248&u)?a+3>=t?s+=o:(e=r[a+n+1],c=r[a+n+2],l=r[a+n+3],8421504!=(12632256&(e|c<<8|l<<16))?s+=o:(d=(7&u)<<18|(63&e)<<12|(63&c)<<6|63&l,d<65536||d>1114111?s+=o:(d-=65536,s+=i(55296+(d>>10),56320+(1023&d)),a+=3))):s+=o}return s}function lH(e,t){let n=t.length,i=0;for(let s=0;s<n;s++){let e=t.charCodeAt(s);e>=55296&&e<=56319&&s+1<n&&(e=(e<<10)+t.charCodeAt(++s)-56613888),i+=e<128?1:e<2048?2:e<65536?3:4}pH(e,i);let r=oH(e,i),o=e.bytes;for(let s=0;s<n;s++){let e=t.charCodeAt(s);e>=55296&&e<=56319&&s+1<n&&(e=(e<<10)+t.charCodeAt(++s)-56613888),e<128?o[r++]=e:(e<2048?o[r++]=e>>6&31|192:(e<65536?o[r++]=e>>12&15|224:(o[r++]=e>>18&7|240,o[r++]=e>>12&63|128),o[r++]=e>>6&63|128),o[r++]=63&e|128)}}function dH(e){return e.bytes[sH(e,1)]}function uH(e,t){let n=oH(e,1);e.bytes[n]=t}function hH(e){let t,n=0,i=0;do{t=dH(e),n<32&&(i|=(127&t)<<n),n+=7}while(128&t);return i}function pH(e,t){for(t>>>=0;t>=128;)uH(e,127&t|128),t>>>=7;uH(e,t)}function fH(e,t){let n,i=0,r=0,o=0;return n=dH(e),i=127&n,128&n&&(n=dH(e),i|=(127&n)<<7,128&n&&(n=dH(e),i|=(127&n)<<14,128&n&&(n=dH(e),i|=(127&n)<<21,128&n&&(n=dH(e),r=127&n,128&n&&(n=dH(e),r|=(127&n)<<7,128&n&&(n=dH(e),r|=(127&n)<<14,128&n&&(n=dH(e),r|=(127&n)<<21,128&n&&(n=dH(e),o=127&n,128&n&&(n=dH(e),o|=(127&n)<<7))))))))),{low:i|r<<28,high:r>>>4|o<<24,unsigned:t}}function mH(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,o=0===r?0===i?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=oH(e,o),a=e.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=9!==o?128|r:127&r;case 8:a[s+7]=8!==o?i>>>21|128:i>>>21&127;case 7:a[s+6]=7!==o?i>>>14|128:i>>>14&127;case 6:a[s+5]=6!==o?i>>>7|128:i>>>7&127;case 5:a[s+4]=5!==o?128|i:127&i;case 4:a[s+3]=4!==o?n>>>21|128:n>>>21&127;case 3:a[s+2]=3!==o?n>>>14|128:n>>>14&127;case 2:a[s+1]=2!==o?n>>>7|128:n>>>7&127;case 1:a[s]=1!==o?128|n:127&n}}const _H={},EH={},gH=4294967296,vH=gH*gH,TH=vH/2,SH=IH(0,!0),yH=IH(0),CH=bH(0,-2147483648,!1),RH=bH(-1,2147483647,!1),wH=bH(-1,-1,!0);function IH(e,t){let n,i,r;return t?(r=0<=(e>>>=0)&&e<256)&&(i=EH[e],i)?i:(n=bH(e,0,!0),r&&(EH[e]=n),n):(r=-128<=(e|=0)&&e<128)&&(i=_H[e],i)?i:(n=bH(e,e<0?-1:0,!1),r&&(_H[e]=n),n)}function bH(e,t,n){return{low:0|e,high:0|t,unsigned:!!n}}function AH(e,t){if(isNaN(e))return t?SH:yH;if(t){if(e<0)return SH;if(e>=vH)return wH}else{if(e<=-TH)return CH;if(e+1>=TH)return RH}return e<0?t?SH:yH:bH(e%gH|0,e/gH|0,t)}function OH(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}class NH extends vR{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(_A.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(e){var t;super(),iT(this,"name","AgoraRTCImageModeration"),iT(this,"_connectionState",mA.CONNECTING),iT(this,"_sequence",0),iT(this,"_moderationStartTime",void 0),iT(this,"_workerConnection",void 0),iT(this,"_workerMessageLengthLimit",void 0),iT(this,"_qualityRatio",void 0),iT(this,"_connectInfo",void 0),iT(this,"_cancelTokenSource",pC.CancelToken.source()),iT(this,"_retryConfig",void 0),iT(this,"_moderationInterval",void 0),iT(this,"_moderationTimer",null),iT(this,"_moderationMode",1),iT(this,"_quality",1),iT(this,"_qualityTimer",null),iT(this,"_ticket",void 0),iT(this,"_moderationIntervalMinimum",void 0),iT(this,"_uploadFailedNum",0),iT(this,"_uploadNum",0),iT(this,"_uploadTimer",null),iT(this,"_extraInfo",void 0),iT(this,"_vendor",""),iT(this,"_encoder",new TextEncoder),iT(this,"_moderationId",void 0),iT(this,"inspectImage",(()=>{if(this.connectionState!==mA.CONNECTED)throw new bb(tR.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===mA.CONNECTED?this.requestToInspectImage():Qw.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()})),this._moderationId=ew(5,"image-moderation-"),this._workerMessageLengthLimit=Dw("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=Dw("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(t=e.interval)&&void 0!==t?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=Dw("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new FA("worker-"+this._moderationId,fw),this.on(_A.STATE_CHANGE,((e,t)=>{Qw.debug("[".concat(this._moderationId,"] Moderation operation :").concat(EA[e]," ").concat(t||""))})),this.handleWorkerEvents()}async init(e,t){this.emit(_A.STATE_CHANGE,EA.CONNECT_AP),this._connectInfo=e;const n=this._cancelTokenSource.token;return this._retryConfig=t,new Gh(((i,r)=>{this.on(_A.CONNECTION_STATE_CHANGE,((e,t)=>{e===mA.CONNECTED&&i()})),this.requestAP(e,n,t).then((e=>{this.connectWorker(e)})).catch((e=>{r(e)}))}))}updateConfig(e){var t;this._moderationInterval=null!==(t=e.interval)&&void 0!==t?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),Qw.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===mA.CONNECTED&&this.inspectImage()}async requestAP(e,t,n){const i=Dw("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),r=await function(e,t,n,i){let{appId:r,areaCode:o,cname:s,sid:a,token:c,uid:l}=t;MO++;const d="moderation_plugin",u={service_name:d,json_body:JSON.stringify({appId:r,areaCode:o,cname:s,command:"allocateEdge",requestId:MO,seq:MO,sid:a,appToken:c,ts:Date.now(),uid:l+""})};let h,p,f=e[0];return _w((async()=>{h=Date.now();const e=await pO(f,{data:u,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-h,0!==e.code){const t=new bb(tR.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+e.code,{retry:!0,responseTime:p});throw Qw.error(t.toString()),t}const t=JSON.parse(e.json_body);if(200!==t.code){const e=new bb(tR.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(t.code,", reason: ").concat(t.reason),{code:t.code,responseTime:p});throw Qw.error(e.toString()),e}if(!t.servers||!Array.isArray(t.servers)||0===t.servers.length){const e=new bb(tR.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:t.code,responseTime:p});throw Qw.error(e.toString()),e}if(!t.servers.some((e=>!!e.wss))){const e=new bb(tR.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:t.code,responseTime:p});throw Qw.error(e.toString()),e}const i=Dw("IMAGE_MODERATION_WORKER_HOST");return{addressList:t.servers.map((e=>{let{address:t,wss:n}=e;if(t&&n)return"wss://".concat(t.replace(/\./g,"-"),".").concat(i,":").concat(n,"/moderation")})).filter((e=>!!e)),workerToken:t.workerToken,vid:t.vid,ticket:t.appTicket,responseTime:p}}),((t,n)=>(oI.apworkerEvent(a,{success:!0,sc:200,serviceName:d,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:p,serverIp:e[n%e.length]}),!1)),((t,n)=>(oI.apworkerEvent(a,{success:!1,sc:t.data&&t.data.code||200,serviceName:d,responseTime:p,serverIp:e[n%e.length]}),!!(t.code!==tR.OPERATION_ABORTED&&t.code!==tR.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(n+1)%e.length],!0))),i)}(i,e,t,n);this.emit(_A.STATE_CHANGE,EA.AP_CONNECTED);const{addressList:o,ticket:s}=r;return this._ticket=s,o}async connectWorker(e){this.emit(_A.STATE_CHANGE,EA.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(Ib.CONNECTED,(async()=>{this.emit(_A.STATE_CHANGE,EA.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=mA.CONNECTED})),this._workerConnection.on(Ib.CLOSED,(()=>{this.connectionState=mA.CLOSED})),this._workerConnection.on(Ib.FAILED,(()=>{this.connectionState=mA.CLOSED})),this._workerConnection.on(Ib.RECONNECTING,(()=>{this.connectionState=this.connectionState===mA.CONNECTED?mA.RECONNECTING:mA.CONNECTING})),this._workerConnection.on(Ib.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const t=$W(new Uint8Array(e.data));Dw("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&Qw.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(t)),this._uploadNum++,void 0===t.code||0===t.code||(this._uploadFailedNum++,Qw.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(t.code,", msg is ").concat(t.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{oI.reportApiInvoke(this._connectInfo.sid||null,{name:yR.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,t.code],tag:CR.TRACER}).onError(new bb(tR.IMAGE_MODERATION_UPLOAD_FAILED,t.msg)),this._uploadTimer=null}),Dw("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else Qw.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(Ib.WILL_RECONNECT,((e,t,n)=>{"recover"===e&&n(e),n("tryNext")})),this._workerConnection.on(Ib.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=UR(this,_A.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(Dw("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&Qw.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(e,t);this._workerConnection.sendMessage(n,!0,!0)}else Dw("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&Qw.debug("Only the track being published can be inspected")}async generateRequestData(e,t){let{appId:n,cname:i,cid:r,vid:o,sid:s,uid:a}=t;const c=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),d=await Hx(l,n,i),u=this._sequence+"-"+r+"-"+a+"-"+c+"-"+ew(12,""),h={appId:n,cid:r,cname:i,deviceId:"",elapse:NH.intToLong(Number(c-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:d,networkType:6,osType:7,requestId:u,sdkVersion:"4.21.0",sequence:this._sequence,sid:s,timestamp:AH(c),uid:a,vid:o,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};void 0===this._extraInfo&&delete h.callbackData;const p=ZW(h);if(p.byteLength<this._workerMessageLengthLimit){if(Dw("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const e=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?OH(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):OH(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},h);delete e.jpg,Qw.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(e))}return p}{const t=this.quality*this._qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:i,cid:r,vid:o,sid:s,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=pC.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=mA.CLOSED,this.emit(_A.STATE_CHANGE,EA.CLOSED)}}function DH(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function PH(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?DH(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):DH(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const kH=Date.now(),LH=20,MH=new Map,UH=new Map;async function xH(e){const t=MH.get(e),n=Array.isArray(t)&&t[t.length-1],i=UH.get(e);if(!n)return void(i.isSyncing=!1);const r={uid:n.uid,payload:n.payload};0===i.firstRecvTs&&(i.firstRecvTs=n.recvTs,i.firstSendTs=n.sendTs);const o=n.sendTs-i.firstSendTs,s=o-(Date.now()-i.firstRecvTs);s>0&&(i.firstRecvTs=Date.now()-o);let a=n.mediaDelay+s;a<=0?(t.pop(),VH(n.context,r),a=0):a=Math.min(a,LH),setTimeout((()=>t.length&&xH(e)),a)}function VH(e,t){e.safeEmit(NR.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function FH(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return VH(n,{uid:e.uid,payload:e.payload});const i="".concat(n.id,"-").concat(e.uid),r=MH.get(i)||[],o=r.findIndex((t=>e.sendTs>=t.sendTs)),s=PH(PH({},e),{},{context:n,mediaDelay:t,recvTs:Date.now()});-1===o?r.push(s):r.splice(o,0,s),MH.set(i,r);let a=!1;var c;UH.has(i)?a=!(null===(c=UH.get(i))||void 0===c||!c.isSyncing):UH.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||xH(i)}const jH=RC().name;function BH(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function GH(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?BH(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):BH(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const WH="websdk_ng_cache_parameter",HH=Dw("MAX_PRELOAD_ASYNC_LENGTH"),KH=1e4,zH=new Map,qH=[];let YH=null,JH=0,XH=0;const QH=new Map,ZH=function(e,t){const n=[];let i=0;const r=async()=>{const e=n.shift();e&&await e(),n.length>0&&i<t?r():i--};return async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];return new Gh((async(o,a)=>{n.push((async()=>{try{const t=await e(...s);o(t)}catch(e){a(e)}})),i<t&&(i++,r())}))}}(eK,HH),$H=pC.CancelToken.source();async function eK(e,t,n,i,r){try{if(!Dw("ENABLE_PRELOAD"))return;if(!fU().supportWebCrypto)return void KR((()=>{Qw.warn("Your browser does not support preloading, this feature  be run in a secure environment")}),"preload_webcrypto_not_supported");if(!n&&null!==n)throw new nR(tR.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&aR(n,"token",1,2047),aR(e,"appid",1,2047),Ab(t),i&&Ob(i);const o=tw();Qw.debug("preload channel ".concat(t,", uid is ").concat(i));const s={appId:e,cname:t,token:n||e,uid:"string"!=typeof i?i:null,sid:o,proxyServer:r};let a,c;"string"==typeof i?(s.stringUid=i,[c,a]=await Gh.all([GO(i,{sid:o,appId:e},$H.token),HO(GH(GH({},s),{},{token:n||e,uid:0}),$H.token)]),s.uid=c.uid,a.gatewayInfo.uid=s.uid,a.gatewayInfo.res.uid=s.uid):a=await HO(s,$H.token);const l={sid:o,appId:e,cname:t,token:n||e,uid:s.stringUid||i,intUid:s.uid||a.gatewayInfo.uid,stringUid:s.stringUid,ts:Date.now(),sua:c,ap:a};await async function(e){let t;try{e.uid&&nK({appId:e.appId,cname:e.cname,token:e.token,uid:e.uid,stringUid:e.stringUid});const n=cK(e),i=await async function(e,t){try{const n=await window.crypto.subtle.importKey("raw",YR(t),"AES-GCM",!1,["encrypt"]),i=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},n,zR(window.btoa(JSON.stringify(e))));return qR(new Uint8Array(i))}catch(e){return}}(e,e.token||e.appId);if(!i)return;t=sK(WH);const r=t?JSON.parse(t):[];r.push({[n]:i}),r.length>Dw("AP_CACHE_NUM")&&r.shift(),aK(WH,JSON.stringify(r))}catch(e){Qw.warn("Error caching server parameters:",e.message),aK(WH,"")}}(l),JH++}catch(e){throw XH++,function(e){YH||(YH=window.setTimeout((()=>{let t="";QH.forEach(((e,n)=>{t+="".concat(n,": ").concat(e," ;")})),oI.reportApiInvoke(null,{name:yR.PRELOAD,options:{success:JH,failed:XH,err:t}}).onError(e),JH=0,XH=0,QH.clear(),YH=null}),KH));const t=QH.get(e.code)||0;QH.set(e.code,t+1)}(e),e}}async function tK(e){try{const t=nK(e);if(!t||"disabled"!==e.cloudProxyServer)return;const n=await async function(e,t){try{const n=await window.crypto.subtle.importKey("raw",YR(t),"AES-GCM",!1,["decrypt"]),i=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},n,zR(e));return JSON.parse(window.atob(qR(new Uint8Array(i))))}catch(e){return}}(t,e.token||e.appId);if(!n)return;if(!function(e,t){return!(e.cname!==t.cname||e.appId!==t.appId||e.token!==t.token)&&(t.stringUid?e.stringUid===t.stringUid:"number"==typeof t.uid?e.uid===t.uid:e.uid==t.uid)}(n,e))return;if(n&&Date.now()-n.ts<Dw("AP_CACHE_LIFETIME"))return n}catch(e){Qw.warn("Error get preloadInfo",e.message)}}function nK(e){let t;try{if(t=sK(WH),!t)return;const n=JSON.parse(t),i=cK(e),r=function(e,t){for(let n=e.length-1;n>=0;n--)if(t(e[n]))return n;return-1}(n,(e=>i in e));if(-1===r)return;const o=n.splice(r,1)[0];return aK(WH,JSON.stringify(n)),o[i]}catch(e){Qw.warn("Error delete preload info: ".concat(t),e.message),aK(WH,"")}}function iK(e){if(e){let t=zH.get(e);t&&(window.clearTimeout(t),t=null,zH.delete(e)),Pi(qH).call(qH,e)||"disabled"!==e.cloudProxyServer||qH.push(e)}if(zH.size<Dw("AP_CACHE_NUM")&&qH.length>0){const e=qH.shift();zH.set(e,window.setTimeout((async()=>{const{appId:t,cname:n,token:i,uid:r,proxyServer:o}=e;try{await ZH(t,n,i,r,o),zH.has(e)&&iK(e)}catch(t){Qw.warn("update preload failed",t.message),rK(e)}}),Dw("AP_UPDATE_INTERVAL")))}}function rK(e){const t=qH.indexOf(e);-1!==t&&qH.splice(t,1);let n=zH.get(e);n&&(window.clearTimeout(n),n=null,zH.delete(e),iK())}function oK(e,t){const n=e.sua,i=e.ap;t&&n&&oI.reqUserAccount(e.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:t,uid:e.intUid,errorCode:null,extend:n.req}),oI.reportResourceTiming(e.ap.url,e.sid),oI.joinWebProxyAP(e.sid,{lts:i.requestTime,elapse:i.elapse,sucess:1,apServerAddr:i.url,turnServerAddrList:i.proxyInfo.addresses.map((e=>e.ip)).join(","),eventType:"disabled",unilbsServerIds:[BA.CHOOSE_SERVER,BA.CLOUD_PROXY_FALLBACK].toString()}),oI.joinChooseServer(e.sid,{lts:i.requestTime,elapse:i.elapse,succ:!0,csAddr:i.url,opid:i.opid,serverList:i.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,cid:i.gatewayInfo.cid.toString(),uid:i.gatewayInfo.uid.toString(),csIp:i.gatewayInfo.csIp,unilbsServerIds:[BA.CHOOSE_SERVER].toString(),isHttp3:i.isHttp3})}function sK(e){return window.atob(window.localStorage.getItem(e)||"")}function aK(e,t){window.localStorage.setItem(e,window.btoa(t))}function cK(e){let t="".concat(e.appId,"_").concat(e.cname);return"string"==typeof e.uid&&(t+="_s_".concat(e.uid)),"number"==typeof e.uid&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),lw(t)}var lK,dK,uK,hK,pK,fK,mK,_K,EK,gK,vK,TK,SK,yK,CK,RK,wK,IK,bK,AK,OK,NK,DK,PK,kK,LK,MK,UK,xK,VK,FK,jK,BK,GK,WK,HK,KK,zK,qK,YK,JK,XK,QK;function ZK(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function $K(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ZK(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ZK(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}hw.setLogger(Qw);let ez=(lK=rI(),dK=rI({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof ox))return[t];t=[t]}return t.map((e=>e?Object(e).toString():"null"))}}),uK=rI({argsMap:(e,t)=>(t||(t=[]),t instanceof zF?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map((e=>e.getTrackId()))))}),hK=rI({argsMap:(e,t,n,i)=>["object"==typeof t?t.uid:t,n,i]}),pK=rI({argsMap:(e,t,n)=>[t,n]}),fK=rI({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:n}=e;return[null==t?void 0:t.uid,n]}))}),mK=rI({argsMap:(e,t,n,i)=>["object"==typeof t?t.uid:t,n,i]}),_K=rI({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:n}=e;return{uid:null==t?void 0:t.uid,mediaType:n}}))}),EK=rI(),gK=rI(),vK=rI(),TK=rI(),SK=rI(),yK=rI(),CK=rI(),RK=rI(),wK=rI(),IK=rI(),bK=rI(),AK=rI(),OK=rI(),NK=rI(),DK=rI({argsMap:(e,t)=>[t]}),PK=rI(),kK=rI(),LK=rI(),MK=rI(),UK=rI(),xK=rI(),VK=rI(),FK=rI(),jK=rI(),BK=rI(),GK=rI({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),WK=rI(),HK=rI(),KK=rI(),zK=rI(),qK=rI(),YK=rI(),JK=rI({reportResult:!0}),XK=rI(),QK=class extends vR{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return(null===(e=this._config)||void 0===e?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let t;if(super(),iT(this,"store",void 0),iT(this,"_uid",void 0),iT(this,"_channelName",void 0),iT(this,"_uintUid",void 0),iT(this,"_users",[]),iT(this,"_config",void 0),iT(this,"_clientId",void 0),iT(this,"_appId",void 0),iT(this,"_sessionId",null),iT(this,"_key",void 0),iT(this,"_rtmConfig",{}),iT(this,"_joinInfo",void 0),iT(this,"_gateway",void 0),iT(this,"_statsCollector",void 0),iT(this,"_configDistribute",void 0),iT(this,"_leaveMutex",new hw("client-leave")),iT(this,"_publishMutex",new hw("client-publish")),iT(this,"_renewTokenMutex",new hw("client-renewtoken")),iT(this,"_subscribeMutex",new hw("client-subscribe")),iT(this,"_encryptionMode","none"),iT(this,"_encryptionSecret",null),iT(this,"_encryptionSalt",null),iT(this,"_encryptDataStream",!1),iT(this,"_encryptDataStreamKey",null),iT(this,"_encryptDataStreamIv",null),iT(this,"_proxyServer",void 0),iT(this,"_turnServer",{servers:[],mode:"auto"}),iT(this,"_cloudProxyServerMode","disabled"),iT(this,"_isDualStreamEnabled",!1),iT(this,"_defaultStreamFallbackType",void 0),iT(this,"_lowStreamParameter",void 0),iT(this,"_streamFallbackTypeCacheMap",new Map),iT(this,"_remoteStreamTypeCacheMap",new Map),iT(this,"_axiosCancelSource",pC.CancelToken.source()),iT(this,"_audioVolumeIndicationInterval",void 0),iT(this,"_networkQualityInterval",void 0),iT(this,"_userOfflineTimeout",void 0),iT(this,"_streamRemovedTimeout",void 0),iT(this,"_injectStreamingClient",void 0),iT(this,"_liveTranscodeStreamingClient",void 0),iT(this,"_liveRawStreamingClient",void 0),iT(this,"_channelMediaRelayClient",void 0),iT(this,"_networkQualitySensitivity","normal"),iT(this,"_p2pChannel",void 0),iT(this,"_useLocalAccessPoint",!1),iT(this,"_setLocalAPVersion",void 0),iT(this,"_joinAndNotLeaveYet",!1),iT(this,"_numberOfJoinCount",0),iT(this,"_remoteDefaultVideoStreamType",void 0),iT(this,"_inspect",void 0),iT(this,"_moderation",void 0),iT(this,"_license",void 0),iT(this,"_pendingPublishedUsers",[]),iT(this,"ntpAlignErrorCount",0),iT(this,"remoteInboundOffset",0),iT(this,"_handleLocalTrackEnable",((e,t,n)=>{this.publish(e,!1).then(t).catch(n)})),iT(this,"_handleLocalTrackDisable",((e,t,n)=>{this.unpublish(e).then(t).catch(n)})),iT(this,"_handleUserOnline",(e=>{if(Dw("BLOCK_LOCAL_CLIENT")&&dI(e.uid,this.channelName))return void Qw.debug("[".concat(e.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof e.uid&&Qw.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const t=this._users.find((t=>t.uid===e.uid));if(t)t._trust_in_room_=!0,t._is_pre_created&&(t._is_pre_created=!1,this.safeEmit(NR.USER_JOINED,t));else{const t=new jB(e.uid,e.uint_id||e.uid);this._users.push(t),Qw.debug("[".concat(this._clientId,"] user online"),e.uid),this.safeEmit(NR.USER_JOINED,t)}})),iT(this,"_handleUserOffline",(e=>{if(Dw("BLOCK_LOCAL_CLIENT")&&dI(e.uid,this.channelName))return;const t=this._users.find((t=>t.uid===e.uid));t&&(this._handleRemoveStream(e),this._handleRemoveDataChannels(e),t._audio_pre_subscribed||t._video_pre_subscribed?t._is_pre_created=!0:FR(this._users,t),this._remoteStreamTypeCacheMap.delete(t.uid),this._streamFallbackTypeCacheMap.delete(t.uid),Qw.debug("[".concat(this._clientId,"] user offline"),e.uid,"reason:",e.reason),this.safeEmit(NR.USER_LEAVED,t,e.reason))})),iT(this,"_handleAddAudioOrVideoStream",((e,t,n,i,r,o,s)=>{if(Dw("BLOCK_LOCAL_CLIENT")&&dI(t,this.channelName))return;const a=this._users.find((e=>e.uid===t));if(!a)return void Qw.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));Qw.debug("[".concat(this._clientId,"] stream added with uid ").concat(t,", type ").concat(e)),this.store.subscribe(a.uid,e,void 0,void 0,void 0,Date.now());const c="audio"===e?a.hasAudio:a.hasVideo;a._uintid||(a._uintid=r||t),"audio"===e?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,"audio"===e?(a._audio_added_=!0,void 0!==n&&(a._audioSSRC=n),void 0!==i&&(a._cname=i),o&&(a._audioOrtc=o)):(a._video_added_=!0,void 0!==n&&(a._videoSSRC=n),void 0!==i&&(a._cname=i),void 0!==s&&(a._rtxSsrcId=s),o&&(a._videoOrtc=o)),("audio"===e?a.hasAudio:a.hasVideo)&&!c&&(Qw.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(e)),this.safeEmit(NR.USER_PUBLISHED,a,e)),"video"===e?oI.onGatewayStream(this._sessionId,tI.ON_ADD_VIDEO_STREAM,nI.ON_ADD_VIDEO_STREAM,{peer:r||t,ssrc:a._videoSSRC}):oI.onGatewayStream(this._sessionId,tI.ON_ADD_AUDIO_STREAM,nI.ON_ADD_AUDIO_STREAM,{peer:r||t,ssrc:a._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(a,e,n).then((t=>{if(t&&(Qw.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(a.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof TW))return this._p2pChannel.unsubscribe(a,e,!0).then((()=>this._subscribe(a,e,!0).catch((e=>{Qw.error("[".concat(this._clientId,"] resubscribe error"),e.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(a,e)&&(Qw.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,e,!0).catch((e=>{Qw.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))})),iT(this,"_handleRemoveStream",(e=>{if(Dw("BLOCK_LOCAL_CLIENT")&&dI(e.uid,this.channelName))return;const t=this._users.find((t=>t.uid===e.uid));if(!t)return void Qw.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));Qw.debug("[".concat(this._clientId,"] stream removed with uid ").concat(e.uid));let n=()=>{};t.hasAudio&&t.hasVideo?n=()=>{Qw.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished audio track")),this.safeEmit(NR.USER_UNPUBLISHED,t,"audio"),Qw.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished video track")),this.safeEmit(NR.USER_UNPUBLISHED,t,"video")}:t.hasVideo?n=()=>{Qw.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished video track")),this.safeEmit(NR.USER_UNPUBLISHED,t,"video")}:t.hasAudio&&(n=()=>{Qw.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished audio track")),this.safeEmit(NR.USER_UNPUBLISHED,t,"audio")}),t._video_pre_subscribed||t._audio_pre_subscribed||(t._trust_audio_stream_added_state_=!0,t._trust_video_stream_added_state_=!0,t._audio_added_=!1,t._video_added_=!1,this._p2pChannel instanceof TW&&this._p2pChannel.unsubscribe(t).then((e=>{if(e)return this._gateway.unsubscribe(e,t.uid)})),t._audioSSRC=void 0,t._videoSSRC=void 0,t._audioOrtc=void 0,t._videoOrtc=void 0,t._rtxSsrcId=void 0),oI.onGatewayStream(this._sessionId,tI.ON_REMOVE_STREAM,nI.ON_REMOVE_STREAM,{peer:e.uint_id||e.uid}),n()})),iT(this,"_handleSetStreamLocalEnable",((e,t,n)=>{if(Dw("BLOCK_LOCAL_CLIENT")&&dI(t,this.channelName))return;const i=this._users.find((e=>e.uid===t));if(!i)return void Qw.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));Qw.debug("[".concat(this._clientId,"] local ").concat(e," ").concat(n?"enabled":"disabled"," with uid ").concat(t));const r="audio"===e?i.hasAudio:i.hasVideo;if("audio"===e){i._trust_audio_enabled_state_=!0;const e=i._audio_enabled_;if(i._audio_enabled_=n,i._audio_enabled_===e)return;{const e=i._audio_enabled_?"enable-local-audio":"disable-local-audio";Qw.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(NR.USER_INFO_UPDATED,t,e)}}else{i._trust_video_enabled_state_=!0;const e=i._video_enabled_;if(i._video_enabled_=n,i._video_enabled_===e)return;{const e=i._video_enabled_?"enable-local-video":"disable-local-video";Qw.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(NR.USER_INFO_UPDATED,t,e)}}const o="audio"===e?i.hasAudio:i.hasVideo;return r!==o?!r&&o?(Qw.info("[".concat(this._clientId,"] remote user ").concat(t," published ").concat(e)),void this.safeEmit(NR.USER_PUBLISHED,i,e)):("video"===e&&i._videoTrack&&i._videoTrack._destroy(),"audio"===e&&i._audioTrack,this._p2pChannel.muteRemote(i,e),Qw.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished ").concat(e)),void this.safeEmit(NR.USER_UNPUBLISHED,i,e)):void 0})),iT(this,"_handleMuteStream",((e,t,n)=>{if(Dw("BLOCK_LOCAL_CLIENT")&&dI(e,this.channelName))return;Qw.debug("[".concat(this._clientId,"] receive mute message"),e,t,n);const i=this._users.find((t=>t.uid===e));if(!i)return void Qw.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(e));const r="audio"===t?i.hasAudio:i.hasVideo;if("audio"===t){i._trust_audio_mute_state_=!0;const t=i._audio_muted_;if(i._audio_muted_=n,i._audio_muted_===t)return;{const t=i._audio_muted_?"mute-audio":"unmute-audio";Qw.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(NR.USER_INFO_UPDATED,e,t)}}else{i._trust_video_mute_state_=!0;const t=i._video_muted_;if(i._video_muted_=n,i._video_muted_===t)return;{const t=i._video_muted_?"mute-video":"unmute-video";Qw.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(NR.USER_INFO_UPDATED,e,t)}}const o="audio"===t?i.hasAudio:i.hasVideo;if(r!==o){if(!r&&o)return("audio"===t?i._audioSSRC:i._videoSSRC)?(Qw.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(t)),void this.safeEmit(NR.USER_PUBLISHED,i,t)):void Qw.warning("[".concat(this._clientId,"] remote user ").concat(e," receive ").concat(t," unmute message  before add stream message, ").concat(t," SSRC doesn't exist yet."));"video"===t&&i._videoTrack&&!i._video_pre_subscribed&&i._videoTrack._destroy(),"audio"===t&&i._audioTrack,this._p2pChannel.muteRemote(i,t),Qw.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(t)),this.safeEmit(NR.USER_UNPUBLISHED,i,t)}})),iT(this,"_handleP2PLost",(async e=>{Qw.debug("[".concat(this._clientId,"] receive p2p lost"),e),parseInt(e.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():Qw.warning("[".concat(this._clientId,"] P2PLost stream not found"),e)})),iT(this,"_handleTokenWillExpire",(()=>{Qw.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(NR.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)})),iT(this,"_handleBeforeUnload",(e=>{"beforeunload"===e.type&&void 0!==e.returnValue&&""!==e.returnValue||(this.leave(),Qw.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))})),iT(this,"_handleUpdateNetworkQuality",(()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(NR.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const e={downlinkNetworkQuality:0,uplinkNetworkQuality:0};e.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),e.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(NR.NETWORK_QUALITY,e)})),iT(this,"_handleP2PAddAudioOrVideoStream",((e,t,n,i)=>{const r=this._users.find((e=>e.uid===t));if(!r)return void Qw.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));Qw.debug("[".concat(this._clientId,"] stream added with uid ").concat(t,", type ").concat(e)),this.store.subscribe(r.uid,e,void 0,void 0,void 0,Date.now());const o="audio"===e?r.hasAudio:r.hasVideo;"audio"===e?r._trust_audio_stream_added_state_=!0:r._trust_video_stream_added_state_=!0,"audio"===e?(r._audio_added_=!0,void 0!==n&&(r._audioSSRC=n),void 0!==i&&(r._audioMid=i)):(r._video_added_=!0,void 0!==n&&(r._videoSSRC=n),void 0!==i&&(r._videoMid=i)),("audio"===e?r.hasAudio:r.hasVideo)&&!o&&(Qw.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published ").concat(e)),this.safeEmit(NR.USER_PUBLISHED,r,e)),this._p2pChannel.hasPendingRemoteMedia(r,e)&&(Qw.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(r.uid," after reconnect.")),this._subscribe(r,e,!0).catch((e=>{Qw.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))})),this._config=e,this._clientId=ew(5,"client-"),this.store=new Lw(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),Qw.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Rw," build: ").concat(Aw,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{OR(e.clientRoleOptions),t=Object.assign({},e.clientRoleOptions)}catch(e){Qw.warning("[".concat(this._clientId,"] ").concat(e.toString()))}this._statsCollector=new lG(this.store),this._statsCollector.onStatsException=(e,t,n)=>{Qw.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(e,", msg: ").concat(t,", uid: ").concat(n)),this.safeEmit(NR.EXCEPTION,{code:e,msg:t,uid:n})},this._statsCollector.onUploadPublishDuration=(e,t,n,i)=>{const r=this._users.find((t=>t.uid===e));r&&oI.peerPublishStatus(this._sessionId,{subscribeElapse:i,audioPublishDuration:t,videoPublishDuration:n,peer:r._uintid})},this.store.useDataChannel=fU().supportDataChannel&&Dw("SIGNAL_CHANNEL"),this.store.useP2P="p2p"===e.mode,this._gateway=new dO(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||fw,httpRetryConfig:e.httpRetryConfig||fw,forceWaitGatewayResponse:void 0===e.forceWaitGatewayResponse||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:t}),this._configDistribute=new QO,this.store.useP2P?(this._p2pChannel=new oG(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new TW(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,n,i,r){let o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],s=arguments.length>6&&void 0!==arguments[6]&&arguments[6];Nw("JOIN_GATEWAY_USE_443PORT_ONLY",o),Nw("JOIN_GATEWAY_USE_DUAL_DOMAIN",s);const a=this._gateway.signal.websocket;return a instanceof VA&&(a.use443PortOnly=o,a.tryDoubleDomain=s),async function(e,t,n){_C.get(e)||_C.set(e,[]),EC.get(e)||EC.set(e,t),gC.get(e)||gC.set(e,0);const i=_C.get(e),r=EC.get(e);if(!i||!r)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(gC.get(e)===r){const e=mC();i.push(e),await e.promise}gC.set(e,gC.get(e)+1);for(var o=arguments.length,s=new Array(o>3?o-3:0),a=3;a<o;a++)s[a-3]=arguments[a];const c=await n(...s);return gC.set(e,gC.get(e)-1),gC.get(e)===r-1&&i.length>0&&(i[0].resolve(),i.shift()),0===gC.get(e)&&(_C.set(e,[]),EC.set(e,0),gC.set(e,0)),c}("client.join",Dw("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,n,i,r)}async join(e,t,n,i,r){const o=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);const s="HTTPS"===(gw||gw||(gw=(window.location.protocol.split(":")[0]||"").toUpperCase(),gw)),a=Cw()?window.isSecureContext:"Browser Not Support";if(!Cw()&&!s||!window.isSecureContext){const e="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";Qw.warning(e)}"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),Qw.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),oI.setAppId(e);try{if(!n&&null!==n)throw new bb(tR.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&aR(n,"token",1,2047),aR(e,"appid",1,2047),Ab(t),i&&Ob(i),r&&aR(r,"optionalInfo",1,2047)}catch(r){throw oI.reportApiInvoke(tw(),{name:yR.JOIN,options:[e,t,n,i],states:{isHttps:s,isSecureContext:a},tag:CR.TRACER}).onError(r),r}const c=await tK({appId:e,cname:t,uid:i,stringUid:"string"==typeof i?i:void 0,token:n||e,cloudProxyServer:this._cloudProxyServerMode}),l=(null==c?void 0:c.sid)||tw(),d=oI.reportApiInvoke(l,{name:yR.JOIN,options:[e,t,n,i],states:{isHttps:s,isSecureContext:a},tag:CR.TRACER});if(Qw.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(o)),this._leaveMutex.isLocked&&(Qw.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),Qw.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const e=new bb(tR.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw d.onError(e),e}this._sessionId||(this._sessionId=l,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const u=$K($K({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:"string"!=typeof i?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!c},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(u.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof i&&(u.stringUid=i,this._uintUid?(u.uid=this._uintUid,this._uintUid=void 0):u.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(u.aesmode=this._encryptionMode,u.aespassword=await(async e=>{const t=function(e){const t=window.atob("MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu\nSTM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+\nHvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy\nxQiYDz3vqa6bP29adwIDAQAB"),n=new Uint8Array(new ArrayBuffer(t.length));for(let i=0;i<t.length;i+=1)n[i]=t.charCodeAt(i);return n}(),n=await window.crypto.subtle.importKey("spki",t,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),i=_R(e),r=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},n,i);return function(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return window.btoa(t)}(new Uint8Array(r))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new bb(tR.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(u.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&("aes-128-gcm2"===this._encryptionMode||"aes-256-gcm2"===this._encryptionMode))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const e=new TextEncoder,t=Dw("USE_PURE_ENCRYPTION_MASTER_KEY")?e.encode(u.appId+this._encryptionSecret+this._encryptionSecret):e.encode(u.appId+u.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(e,t,n){const i=await window.crypto.subtle.importKey("raw",t,"PBKDF2",!1,["deriveBits","deriveKey"]),r="aes-128-gcm2"===e?128:256,o=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:Vw,hash:"SHA-256",salt:n},i,r+xw);return new Uint8Array(o).subarray(r/8)}(this._encryptionMode,t,zR(this._encryptionSalt)),this._encryptDataStreamKey=await async function(e,t,n){const i=await window.crypto.subtle.importKey("raw",t,"PBKDF2",!1,["deriveBits","deriveKey"]),r="aes-128-gcm2"===e?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:Vw,hash:"SHA-256",salt:n},i,{name:"AES-GCM",length:r},!0,["encrypt","decrypt"])}(this._encryptionMode,t,zR(this._encryptionSalt))}else a?Qw.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):Qw.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,Qw.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:t,appId:e,stringUid:u.stringUid,preload:u.preload});const h=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&h===this._sessionId&&oI.joinChannelTimeout(this._sessionId,5)}),5e3);try{var p;let i;const r=u.cloudProxyServer;if(Pi(p=["proxy3","proxy4","proxy5"]).call(p,r)){const e=Dw("PROXY_SERVER_TYPE3");Array.isArray(e)?u.proxyServer=e[0]:u.proxyServer=e}if(oI.setProxyServer(u.proxyServer),Qw.setProxyServer(u.proxyServer),this.store.requestAPStart(),c){if(Qw.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(u.stringUid?", ".concat(u.stringUid," => ").concat(c.intUid):""," ")),u.stringUid&&!u.uid&&(u.uid=c.intUid),i={gatewayInfo:c.ap.gatewayInfo},Dw("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&"auto"===u.turnServer.mode)if(0===c.ap.proxyInfo.addresses.length)Qw.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const e=(await XA(c.ap.proxyInfo,c.ap.gatewayInfo.uid)).map((e=>({turnServerURL:e.address,tcpport:e.tcpport||aI.tcpport,udpport:e.udpport||aI.udpport,username:e.username||aI.username,password:e.password||aI.password,forceturn:!1,security:!0})));u.turnServer={mode:"manual",servers:e}}oK(c,u.stringUid)}else{if(u.stringUid&&!u.uid){let e;[e,i]=await Gh.all([BO(u.stringUid,u,this._axiosCancelSource.token,this._config.httpRetryConfig||fw,this.store),jO(u,this._axiosCancelSource.token,this._config.httpRetryConfig||fw,!0,this.store)]),Qw.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(u.stringUid," => ").concat(e)),u.uid=e,i.gatewayInfo.uid=e,i.gatewayInfo.res.uid=e}else i=await jO(u,this._axiosCancelSource.token,this._config.httpRetryConfig||fw,!0,this.store);if(!this._joinAndNotLeaveYet)throw new bb(tR.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(u,this._axiosCancelSource.token),this._configDistribute.on(eA.UPDATE_BITRATE_LIMIT,(e=>{this._p2pChannel.updateBitrateLimit(e)}))}),0),this._key=n||e;const o=i.gatewayInfo,s=u.uid?u.uid:o.uid;this._joinInfo=$K($K({},u),{},{cid:o.cid,uid:s,vid:o.vid,apResponse:o.res,uni_lbs_ip:o.uni_lbs_ip,gatewayAddrs:o.gatewayAddrs}),this.store.intUid=s;const a=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new bb(tR.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));d.onSuccess(a),this._appId=e,this._channelName=u.cname,this._uid=a,this.store.uid=a,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(NC()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()}),0);const l=u.stringUid?"string uid: ".concat(u.stringUid,",uid: ").concat(u.uid):"uid: ".concat(this._uid);return Qw.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(l)),setTimeout((()=>{Qw.startUpload()}),5e3),this.store.joinEnd(),f=this,Pi(lI).call(lI,f)||lI.push(f),"disabled"===this._cloudProxyServerMode&&fU().supportWebCrypto&&Dw("ENABLE_PRELOAD")&&iK(this._joinInfo),a}catch(e){const t=Array.isArray(e)?e[0]:e;throw t&&t.code===tR.OPERATION_ABORTED?Qw.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),t):Qw.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),t),t.code!==tR.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),d.onError(t),t}var f}_joinGateway(){if(!this._joinInfo||!this._key)throw new bb(tR.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!Dw("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((e=>e)).catch((e=>{if(e.code===tR.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,IR.FALLBACK),e;if(e.code===tR.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,IR.FALLBACK),e;throw e})).then((e=>{if(e instanceof bb){if(e.code===tR.INIT_WEBSOCKET_TIMEOUT){if(Qw.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new bb(tR.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=Dw("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),n=t.slice(t.length-2).join(".");e.forEach((e=>{this._joinInfo&&Pi(e).call(e,n)&&(this._joinInfo.proxyServer=e)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const t=Dw("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return t&&t[1]&&"443"!==t[1]&&Qw.setProxyServer(this._joinInfo.proxyServer),"443"!==Dw("STATS_COLLECTOR_PORT").toString()&&oI.setProxyServer(this._joinInfo.proxyServer),oI.reportApiInvoke(this._sessionId,{name:yR.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:CR.TRACER}).onSuccess(),this.safeEmit(NR.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),Dw("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((e=>{"forceturn"in e&&(e.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if(Qw.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new bb(tR.INVALID_OPERATION);return oI.reportApiInvoke(this._sessionId,{name:yR.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:CR.TRACER}).onSuccess(),this._joinGateway()}return e})).then((e=>e))}async leave(){Qw.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(NC()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const t=lI.indexOf(e);-1!==t&&lI.splice(t,1)}(this),this._statsCollector.stopUpdateStats();const e=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return Qw.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave("CONNECTED"!==this.connectionState),Qw.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(e)){if(!(e instanceof ox))return this._publishDataChannel(e);e=[e]}if(0===e.length)throw new bb(tR.INVALID_PARAMS,"param list is empty");const n=e;if("audience"===this._gateway.role)throw new bb(tR.INVALID_OPERATION,"audience can not publish stream");for(const r of n){if(!(r instanceof ox))throw new bb(tR.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&t)throw new bb(tR.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}Qw.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))));const i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&n.forEach((e=>{const t=this._configDistribute.getBitrateLimit();e instanceof CF&&t&&e.setBitrateLimit(t.uplink)}));try{await this._publishHighStream(n),Qw.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))))}catch(e){throw Qw.error("[".concat(this._clientId,"] publish error"),e.toString()),e}finally{i()}}async _publishDataChannel(e){oR(e.id,"id",0,65535,!0),iR(e.ordered,"ordered"),aR(e.metadata,"metadata",0,512),Qw.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const t=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((t=>t.id===e.id)))throw new bb(tR.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new bb(tR.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&Dw("FORCE_TURN")&&!Dw("TURN_ENABLE_TCP")&&!Dw("TURN_ENABLE_UDP"))throw new bb(tR.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const t=new zF(e);if(await this._p2pChannel.publishDataChannel([t]),!this._p2pChannel.isP2PDisconnected()){if("number"!=typeof t._originDataChannelId)throw Qw.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new bb(tR.CREATE_DATACHANNEL_ERROR);try{const n={streamId:e.id,ordered:e.ordered,maxRetransmits:Dw("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:t._originDataChannelId};await this._gateway.publishDataChannel(this._uid,n,!0),await t._waitTillOpen()}catch(e){if(e.code!==tR.DISCONNECT_P2P)throw e}}return Qw.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(t.id)),t}catch(e){throw Qw.error("[".concat(this._clientId,"] publish datachannels error"),e.toString()),e}finally{t()}}async unpublish(e){if(!this._joinInfo||void 0===this._uid)throw new bb(tR.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof ox))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);Qw.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map((e=>"".concat(e.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof oG){const e=await this._p2pChannel.unpublish(t);e&&await this._gateway.sendExtensionMessage(gA.UNPUBLISH,{unpubMsg:e},!0)}else{const e=await this._p2pChannel.unpublish(t);e&&await this._gateway.unpublish(e,this._uid),Qw.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map((e=>"".concat(e.getTrackId())))))}}catch(e){throw Qw.error("[".concat(this._clientId,"] unpublish error"),e.toString()),e}finally{n&&n()}}async _unpublishDataChannel(e){void 0!==e&&0!==e.length||(e=this._p2pChannel.getAllDataChannels()),Qw.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map((e=>"".concat(e.id," ")))," "));const t=await this._publishMutex.lock();try{const t=await this._p2pChannel.unpublishDataChannel(e);t&&await this._gateway.unpublishDataChannel(t),Qw.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map((e=>"".concat(e.id)))))}catch(e){throw Qw.error("[".concat(this._clientId,"] unpublish dataChannel error"),e.toString()),e}finally{t&&t()}}async subscribe(e,t,n){if(!(e instanceof jB)){const t=this.remoteUsers.find((t=>t.uid===e));if(!t)throw new bb(tR.INVALID_REMOTE_USER,"user is not in the channel");e=t}return"datachannel"===t?this._subscribeDataChannel(e,n):this._subscribe(e,t)}async presubscribe(e,t){if(rR(t,"mediaType",["audio","video"]),this._p2pChannel instanceof oG)throw new bb(tR.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"can't presub when not join");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=t===iA.AUDIO,i=t===iA.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:r,ortc:o,rtxSsrcId:s,cname:a,uint_id:c}=await this._gateway.presubscribe(e,t,!0);if(null==r)throw new bb(tR.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find((t=>t.uid===e));l||(l=new jB(e,c||e),l._is_pre_created=!0,this._users.push(l)),a&&(l._cname=a),l._uintid||(l._uintid=c||e),n&&(l._audioSSRC=r,l._audio_pre_subscribed=!0,o&&(l._audioOrtc=o)),i&&(l._videoSSRC=r,l._video_pre_subscribed=!0,o&&(l._videoOrtc=o),null!=s&&(l._rtxSsrcId=s)),Qw.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(r)),await this._p2pChannel.subscribe(l,t,r,s,o);const d=n?l._audioTrack:l._videoTrack;if(!d)throw new bb(tR.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),i&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),d}catch(t){throw Qw.error("[".concat(this._clientId,"] presub user ").concat(e," error"),t),t}finally{r()}}async _subscribeDataChannel(e,t){var n;if(oR(t,"channelId",0,65535,!0),!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));const i=this._users.find((t=>t===e));if(!i)throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new bb(tR.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&0===e._dataChannels.length)throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new bb(tR.INVALID_REMOTE_USER,"user is not published");const r=null===(n=e._dataChannels)||void 0===n?void 0:n.find((e=>e.id===t));if(!r)throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new bb(tR.REMOTE_USER_IS_NOT_PUBLISHED);const o=await this._subscribeMutex.lock();Qw.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const n=await this._p2pChannel.subscribeDataChannel(e,[r]);if(n&&Pi(n).call(n,r.id))try{var s;if("number"!=typeof r._originDataChannelId)throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new bb(tR.CREATE_DATACHANNEL_ERROR);const t={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:null!==(s=r.metadata)&&void 0!==s?s:""};await this._gateway.subscribeDataChannel(e.uid,t,!0),await r._waitTillOpen()}catch(t){if((null==t?void 0:t.code)!==tR.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[r]),t;await this._p2pChannel.unsubscribeDataChannel(e,[r]),this._p2pChannel.setPendingRemoteDataChannel(e,r.id)}return Qw.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),r}finally{o()}}async _p2pSubscribe(e,t,n){if(rR(t,"mediaType",["audio","video"]),!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const i=this._users.find((t=>t===e));if(!i){const t=new bb(tR.INVALID_REMOTE_USER,"user is not in the channel");throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),t}if(!e.hasAudio&&!e.hasVideo){const t=new bb(tR.INVALID_REMOTE_USER,"user is not published");throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),t}if(!n&&("audio"===t&&!e.hasAudio||"video"===t&&!e.hasVideo)){const n=new bb(tR.REMOTE_USER_IS_NOT_PUBLISHED);throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),n}const r=await this._subscribeMutex.lock();Qw.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const n="audio"===t?e._audioSSRC:e._videoSSRC,i="audio"===t?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this._p2pChannel instanceof oG&&await this._p2pChannel.subscribe(e,t,n,i)}catch(e){throw e}Qw.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{Qw.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===t?e._audioTrack:e._videoTrack;if(!n)throw new bb(tR.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(t){throw Qw.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),t),t}finally{r()}}async _subscribe(e,t,n){if(this._p2pChannel instanceof oG)return this._p2pSubscribe(e,t);if(rR(t,"mediaType",["audio","video"]),!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const i=this._users.find((t=>t===e));if(!i){const t=new bb(tR.INVALID_REMOTE_USER,"user is not in the channel");throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),t}if(!e.hasAudio&&!e.hasVideo){const t=new bb(tR.INVALID_REMOTE_USER,"user is not published");throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),t}if(!(n||("audio"!==t||e.hasAudio&&void 0!==e._audioSSRC)&&("video"!==t||e.hasVideo&&void 0!==e._videoSSRC))){const n=new bb(tR.REMOTE_USER_IS_NOT_PUBLISHED);throw Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),n}let r="audio"===t?e._audioSSRC:e._videoSSRC,o="audio"===t?e._audioOrtc:e._videoOrtc,s="video"===t?e._rtxSsrcId:void 0,a={stream_type:"audio"===t?iA.AUDIO:iA.VIDEO,ssrcId:r};const c=await this._subscribeMutex.lock();Qw.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const i="audio"===t?e._audioSSRC:e._videoSSRC;void 0!==i&&i!==r&&(r=i,o="audio"===t?e._audioOrtc:e._videoOrtc,s="video"===t?e._rtxSsrcId:void 0,a={stream_type:"audio"===t?iA.AUDIO:iA.VIDEO,ssrcId:r}),nj.markSubscribeStart(this.store.clientId,r),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,r,s,o);try{await this._gateway.subscribe(e.uid,a,!0)}catch(n){if((null==n?void 0:n.code)!==tR.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),n;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(n){throw this._p2pChannel.reportSubscribeEvent(!1,null==n?void 0:n.code,e,t),n}Qw.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{Qw.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const i="audio"===t?e._audioTrack:e._videoTrack;if(!i)throw new bb(tR.UNEXPECTED_ERROR,"can not find remote track in user object");return i}catch(t){throw Qw.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),t),t}finally{c()}}async massSubscribe(e){if(cR(e,"subscribeList"),!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),n=new Map,i=await this._subscribeMutex.lock();Qw.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((e=>{let{user:t,mediaType:n}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(n)})).join("; ")));const r=(e=[...e]).map((e=>{let{user:t,mediaType:n}=e;return{user:t,mediaType:n}})),o=await this._p2pChannel.globalLock();try{var s;for(let t=e.length-1;t>=0;t--){const i=e[t],{user:o,mediaType:s}=i;if(rR(s,"mediaType",["audio","video"]),!o){const e=new bb(tR.INVALID_PARAMS,"user property does not exist in subscribeList item");throw Qw.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),e}const a=this._users.find((e=>e===o));if(!a){const n=new bb(tR.INVALID_REMOTE_USER,"user is not in the channel");Qw.error("[".concat(this._clientId,"] can not massSubscribe ").concat(o.uid,", this user is not in the channel")),r[t].error=n,e.splice(t,1);continue}if("audio"===s&&(!o.hasAudio||void 0===o._audioSSRC)||"video"===s&&(!o.hasVideo||void 0===o._videoSSRC)){const n=new bb(tR.REMOTE_USER_IS_NOT_PUBLISHED);Qw.error("[".concat(this._clientId,"] can not subscribe ").concat(o.uid," with mediaType ").concat(s,", remote user is not published")),r[t].error=n,e.splice(t,1);continue}const c=Yb.Video|Yb.LwoVideo,l=n.get(o);if(l){if("video"===s?l&c:l&Yb.Audio){e.splice(t,1),Qw.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(o.uid,", mediaType:").concat(s," twice"));continue}n.set(o,l|("video"===s?c:Yb.Audio))}else n.set(o,"video"===s?c:Yb.Audio)}for(let t=e.length-1;t>=0;t--){const i=e[t],{user:r,mediaType:o}=i,s=Yb.Video|Yb.LwoVideo;if(this._p2pChannel.hasRemoteMedia(r,o)){await this._p2pChannel.unmuteRemoteNoLock(r,o);const i=n.get(r);n.set(r,"video"===o?i^s:i^Yb.Audio),e.splice(t,1)}}this.store.massSubscribe(e.map((e=>({userId:e.user.uid,type:e.mediaType}))),t);const i=Xi(s=Array.from(n.entries())).call(s,((e,t)=>{let[n,i]=t;if(0===i)return e;const r={stream_id:n.uid,stream_type:i};return i&Yb.Audio&&(r.audio_ssrc=n._audioSSRC),i&Yb.Video&&(r.video_ssrc=n._videoSSRC),e.push(r),e}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((e=>{let{user:t,mediaType:n}=e;return{user:t,mediaType:n,ssrcId:n===iA.VIDEO?t._videoSSRC:t._audioSSRC,rtxSsrcId:n===iA.VIDEO?t._rtxSsrcId:void 0}})));const n=new Map;if(i.length>0){const e=await this._gateway.subscribeAll(i,!0);((null==e?void 0:e.users)||[]).forEach((e=>{let{stream_id:t,video_error_code:i,audio_error_code:r,error_code:o}=e;(i||r||o)&&n.set(t,{video_error_code:i,audio_error_code:r,error_code:o})}))}if(Array.from(n.entries()).length>0){const e=[];Array.from(n.entries()).forEach((t=>{let[n,i]=t;const r=this.remoteUsers.find((e=>e.uid===n));if(r){let t;i.error_code||i.video_error_code&&i.audio_error_code?t=void 0:i.video_error_code?t=iA.VIDEO:i.audio_error_code&&(t=iA.AUDIO),e.push({user:r,mediaType:t})}})),e.length>0&&await this._p2pChannel.massUnsubscribeNoLock(e)}for(const e of r){const t=n.get(e.user.uid);if(t){const n=t.error_code||"audio"===e.mediaType&&t.audio_error_code||"video"===e.mediaType&&t.video_error_code;if(n){const t=wA(n);Qw.error("user:".concat(e.user.uid," mediaType:").concat(e.mediaType," has massSubscribe error ").concat(t.desc)),e.error=new bb(tR.SUBSCRIBE_FAILED,"code ".concat(n,": ").concat(t.desc))}}e.error||("video"===e.mediaType?e.track=e.user.videoTrack:e.track=e.user.audioTrack)}return this.store.massSubscribe(r.filter((e=>!e.error)).map((e=>({userId:e.user.uid,type:e.mediaType}))),void 0,Date.now()),r.forEach((e=>{var n;oI.subscribe(this.store.sessionId,{succ:!!e.error,ec:(null===(n=e.error)||void 0===n?void 0:n.code)||null,video:e.mediaType===iA.VIDEO,audio:e.mediaType===iA.AUDIO,peerid:e.user.uid,subscribeRequestid:e.mediaType===iA.VIDEO?e.user._videoSSRC:e.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t)},!0)})),Qw.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((e=>{let{user:t,mediaType:n}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(n)})).join("; "))),r}catch(t){throw await this._p2pChannel.massUnsubscribeNoLock(e),t}}finally{o(),i()}}async unsubscribe(e,t,n){if(!(e instanceof jB)){const t=this.remoteUsers.find((t=>t.uid===e));if(!t)throw new bb(tR.INVALID_REMOTE_USER,"user is not in the channel");e=t}if(t||this.store.useP2P){if("datachannel"===t)return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(t&&rR(t,"mediaType",["audio","video"]),!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");const i=this._users.find((t=>t===e));if(!i){const t=new bb(tR.INVALID_REMOTE_USER,"user is not in the channel");throw Qw.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),t}Qw.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));const r=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof oG)await this._p2pChannel.unsubscribe(e,t);else{const n=await this._p2pChannel.unsubscribe(e,t);n&&await this._gateway.unsubscribe(n,e.uid),t&&"audio"!==t||(e._audio_pre_subscribed=!1),t&&"video"!==t||(e._video_pre_subscribed=!1),e._is_pre_created&&FR(this._users,e),Qw.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(t){if(t.code===tR.DISCONNECT_P2P)return void Qw.warning("disconnecting p2p, abort unsubscribe request.");throw Qw.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),t.toString()),t}finally{r()}}async _unsubscribeDataChannel(e,t){if(t&&oR(t,"id",0,65535,!0),!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");const n=this._users.find((t=>t===e));if(!n){const t=new bb(tR.INVALID_REMOTE_USER,"user is not in the channel");throw Qw.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),t}let i;if("number"==typeof t){const n=e._dataChannels.find((e=>e.id===t));n&&(i=[n])}else i=e._dataChannels;if(void 0===i){const n=new bb(tR.REMOTE_USER_IS_NOT_PUBLISHED);throw Qw.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),n}Qw.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i.map((e=>e.id))));try{const t=await this._p2pChannel.unsubscribeDataChannel(e,i);t&&await this._gateway.unsubscribeDataChannel(t,e.uid),Qw.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(t))}catch(t){if(t.code===tR.DISCONNECT_P2P)return void Qw.warning("disconnecting p2p, abort unsubscribe request.");throw Qw.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),t.toString()),t}}async massUnsubscribe(e){if(cR(e,"unsubscribeList"),!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");Qw.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((e=>{let{user:t,mediaType:n}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(n,";")})).join())),e=[...e];const t=new Map;for(let n=e.length-1;n>=0;n--){const{user:i,mediaType:r}=e[n];if(!i){const e=new bb(tR.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw Qw.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),e}rR(r,"mediaType",["video","audio",void 0]);const o=this._users.find((e=>e===i));if(!o){Qw.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),e.splice(n,1);continue}const s=Yb.Video|Yb.LwoVideo;if(t.has(i)){const o=t.get(i);let a;switch(r){case"video":a=o&s;break;case"audio":a=o&Yb.Audio;break;default:a=o&(Yb.Audio|s)}if(a){Qw.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),e.splice(n,1);continue}r?"audio"===r?t.set(i,o|Yb.Audio):"video"===r&&t.set(i,o|s):t.set(i,o|Yb.Audio|s)}else r?"audio"===r?t.set(i,Yb.Audio):"video"===r&&t.set(i,s):t.set(i,Yb.Audio|s)}try{const t=await this._p2pChannel.massUnsubscribe(e);t&&await this._gateway.massUnsubscribe(t),Qw.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((e=>{let{user:t,mediaType:n}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(n,";")})).join()))}catch(e){if(e.code===tR.DISCONNECT_P2P)return void Qw.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw Qw.error("[".concat(this._clientId,"] massUnsubscribe error"),e.toString()),e}}async setLowStreamParameter(e){!function(e){if(!e)throw new nR(tR.INVALID_PARAMS);lR(e.width)||sR(e.width,"streamParameter.width"),lR(e.height)||sR(e.height,"streamParameter.height"),lR(e.framerate)||sR(e.framerate,"streamParameter.framerate"),lR(e.bitrate)||oR(e.bitrate,"streamParameter.bitrate")}(e),(!e.width&&e.height||e.width&&!e.height)&&Qw.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),Qw.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,sA.LocalVideoLowTrack)}async enableDualStream(){if(!fU().supportDualStream)throw oI.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new bb(tR.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new bb(tR.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw oI.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,oI.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),Qw.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(sA.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw oI.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,oI.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),Qw.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(function(e){rR(e,"role",["audience","host"])}(e),t&&OR(t),"rtc"===this.mode||"p2p"===this.mode)throw Qw.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new bb(tR.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&"host"===e)throw new bb(tR.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===e&&this._p2pChannel.hasLocalMedia())throw new bb(tR.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,t),this._config.role=e,Qw.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level))}getRemoteInboundOffset(){var e;const t=null===(e=this._p2pChannel.getStats())||void 0===e?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const n=t.timestamp-Date.now();return Math.abs(n)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(aR(e,"proxyServer"),!t){if("DISCONNECTED"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new bb(tR.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,oI.setProxyServer(this._proxyServer),Qw.setProxyServer(this._proxyServer),Qw.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if("DISCONNECTED"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new bb(tR.INVALID_OPERATION,"You have already set the proxy")}if(bR(e))return this._turnServer={servers:e,mode:"original-manual"},void Qw.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map((e=>e.urls)).join(","),"."));e.forEach((e=>AR(e))),this._turnServer={servers:e,mode:"manual"},Qw.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if("DISCONNECTED"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"you should set license before join channel");if(aR(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new bb(tR.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,Qw.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if("DISCONNECTED"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new bb(tR.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let n;switch(void 0===e&&(e=3),e){case 1:case 2:throw new bb(tR.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new bb(tR.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,Qw.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"Stop proxy server after leave channel");oI.setProxyServer(),Qw.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",Qw.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new bb(tR.INVALID_PARAMS,"accessPoints is required.");cR(e.accessPoints.serverList,"accessPoints.serverList"),aR(e.accessPoints.domain,"accessPoints.domain");const t=(e,t)=>{oR(e,t,0,65535,!0)};let n=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new bb(tR.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");Dw("CLOSE_AFB_FOR_LOCAL_AP")&&(Nw("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Nw("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=e.accessPoints.domain,o=e.accessPoints.serverList.map((e=>i.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(r):e)),s=o.map((e=>"".concat(e,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Nw("WEBCS_DOMAIN",s),Nw("WEBCS_DOMAIN_BACKUP_LIST",s),Nw("GATEWAY_DOMAINS",[r]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(cR(e.report.hostname,"report.hostname"),Nw("EVENT_REPORT_DOMAIN",e.report.hostname[0]),Nw("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(Nw("EVENT_REPORT_DOMAIN",o[0]),Nw("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),a=e.report.port),Nw("STATS_COLLECTOR_PORT",a),e.report?Nw("ENABLE_EVENT_REPORT",!0):Nw("ENABLE_EVENT_REPORT",!1);let c="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(cR(e.log.hostname,"log.hostname"),c=e.log.hostname[0]):c=o[0];let l=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),l=e.log.port),Nw("LOG_UPLOAD_SERVER","".concat(c,":").concat(l));let d=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(cR(e.cds.hostname,"cds.hostname"),d=e.cds.hostname):d=o;let u=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),u=e.cds.port),Nw("CDS_AP",d.map((e=>"".concat(e,":").concat(u)))),e.cds?Nw("ENABLE_CONFIG_DISTRIBUTE",!0):Nw("ENABLE_CONFIG_DISTRIBUTE",!1),Qw.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(cR(e,"serverList"),aR(t,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new bb(tR.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((e=>n.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(t):e)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Nw("WEBCS_DOMAIN",e),Nw("WEBCS_DOMAIN_BACKUP_LIST",e),Nw("GATEWAY_DOMAINS",[t]),Nw("EVENT_REPORT_DOMAIN",e[0]),Nw("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),Nw("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),Qw.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(rR(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw Qw.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else Qw.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){rR(t,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout((()=>{const t=this._users.find((t=>t.uid===e));t&&t.videoTrack&&t.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(e){throw Qw.error("[".concat(this._clientId,"] set remote video stream type error"),e.toString()),e}Qw.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){rR(t,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(e){throw Qw.error("[".concat(this._clientId,"] set stream fallback option"),e.toString()),e}Qw.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,n,i){!function(e){rR(e,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])}(e),aR(t,"secret");const r=["aes-128-gcm2","aes-256-gcm2"];if(Pi(r).call(r,e)){if(!n||!(n instanceof Uint8Array&&32===n.length))throw new bb(tR.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new bb(tR.INVALID_PARAMS,"current encrypt mode does not need salt");if(i){if(iR(i,"encryptDataStream"),!Pi(r).call(r,e))throw new bb(tR.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(t)||Qw.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=e,this._encryptionSecret=t,n&&(this._encryptionSalt=qR(n))}async renewToken(e){if(aR(e,"token",1,2047),!this._key||!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(Dw("USE_NEW_TOKEN")){Qw.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const t=await YO(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||fw);Qw.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:t})}else Qw.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});Qw.debug("[".concat(this._clientId,"] renewToken success"))}catch(e){throw this._key=t,this._joinInfo.token=t,Qw.error("[".concat(this._clientId,"] renewToken failed"),e.toString()),e}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?Qw.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(NR.VOLUME_INDICATOR,e)}),Dw("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if("h264"!==this.codec)throw new bb(tR.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new bb(tR.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new bb(tR.LIVE_STREAMING_TASK_CONFLICT);const n=t?Nb.TRANSCODE:Nb.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(e,n)}setLiveTranscoding(e){return this._createLiveStreamingClient(Nb.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((t=>t&&t.hasUrl(e)));if(!t.length)throw new bb(tR.INVALID_PARAMS,"can not find live streaming url to stop");await Gh.all(t.map((t=>t&&t.stopLiveStreamingTask(e))))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const n=this._createLiveStreamingClient(Nb.INJECT);n.setInjectStreamConfig(t,0),await n.startLiveStreamingTask(e,Nb.INJECT)}async removeInjectStreamUrl(){var e;const t=this._createLiveStreamingClient(Nb.INJECT),n=Array.from(hb(e=t.streamingTasks).call(e)).find((e=>e.mode===Nb.INJECT));if(!this._joinInfo||!n)throw new bb(tR.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await t.stopLiveStreamingTask(n.url)}async startChannelMediaRelay(e){EG(e);const t=this._createChannelMediaRelayClient();await t.startChannelMediaRelay(e)}async updateChannelMediaRelay(e){EG(e);const t=this._createChannelMediaRelayClient();await t.updateChannelMediaRelay(e)}async stopChannelMediaRelay(){const e=this._createChannelMediaRelayClient();await e.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(e){var t;let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof e||e instanceof Uint8Array)&&(e={payload:e}),"string"==typeof e.payload){const t=new TextEncoder;e.payload=t.encode(e.payload)}let i=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Pi(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)&&(i=!0,e.payload=await async function(e,t,n){var i;const r=Xi(i=Array.from(n)).call(i,((e,t)=>e+t),0),o={serverTs:0,seq:jw++,length:n.length,checkSum:r},s=new Uint8Array(aw(r,2)),a=new ArrayBuffer(Fw),c=new DataView(a);c.setUint32(0,o.serverTs),c.setUint16(4,o.seq),c.setUint16(6,o.length),c.setUint16(8,o.checkSum);const l=16-n.length%16;n=JR(n,new Uint8Array(l));const d=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:e,tagLength:Uw,additionalData:s},t,n);return JR(new Uint8Array(a),new Uint8Array(d))}(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new bb(tR.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(yb.DATA_STREAM,{payload:qR(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-kH},!n)}sendMetadata(e){if(!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new bb(tR.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(yb.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:qR(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach($w),!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"can not send custom report, not joined");await oI.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,t){rR(t.spatialLayer,"spatialLayer",[0,1,2,3]),rR(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(e){throw Qw.error("[".concat(this._clientId,"] pick SVC layer failed"),e.toString()),e}}async setRTMConfig(e){const{apRTM:t=!1,rtmFlag:n}=e;if(iR(t,"apRTM"),oR(n,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=n,Qw.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),("CONNECTED"===this.connectionState||"RECONNECTING"===this.connectionState)&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(Qw.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=pC.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&rK(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((e=>e._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new hw("client-publish"),this._subscribeMutex=new hw("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(e){}if(this._moderation)try{this.setImageModeration(!1)}catch(e){}}_startSession(e,t){var n;const i=e||tw();e?Qw.debug("[".concat(this._clientId,"] new Session ").concat(i)):Qw.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));const r=e?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i;const o={lts:(new Date).getTime(),mode:this.mode,buildFormat:1,stringUid:(null==t?void 0:t.stringUid)||(null===(n=this._joinInfo)||void 0===n?void 0:n.stringUid),channelProfile:"live"===this.mode?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:"audience"===this.role?2:1};t?oI.sessionInit(this._sessionId,$K({cname:t.channel,appid:t.appId,preload:t.preload},o)):this._joinInfo?oI.sessionInit(this._sessionId,$K({cname:this._joinInfo.cname,appid:this._joinInfo.appId,preload:!!this._joinInfo.recoverPreloadCache},o)):this._gateway.joinInfo&&oI.sessionInit(this._sessionId,$K({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},o)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(e){if(!this._joinInfo||void 0===this._uid)throw new bb(tR.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&Dw("FORCE_TURN")&&!Dw("TURN_ENABLE_TCP")&&!Dw("TURN_ENABLE_UDP"))throw new bb(tR.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");Qw.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof oG){const t=(await n.next()).value;if(t){try{await this._gateway.sendExtensionMessage(gA.PUBLISH,t,!0)}catch(e){throw n.throw(e),e}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const i=(await n.next()).value;if(i){var t;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(e){if(e.code!==tR.DISCONNECT_P2P)throw n.throw(e),e}await n.next((null===(t=r)||void 0===t?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const t of e)t instanceof CF&&t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig),!t.muted&&t.enabled||await this._p2pChannel.muteLocalTrack(t)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,e),(null==t?void 0:t.code)===tR.WS_ABORT)return;throw t}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new bb(tR.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new bb(tR.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));Qw.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const e=await this._p2pChannel.publishLowStream(this._lowStreamParameter),n=(await e.next()).value;if(n){var t;let i;try{i=await this._gateway.publish(this._uid,n,!0)}catch(t){if(t.code!==tR.DISCONNECT_P2P)throw e.throw(t),t}e.next((null===(t=i)||void 0===t?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,void 0,!0),(null==e?void 0:e.code)===tR.WS_ABORT)return;throw e}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId)return new bb(tR.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const t=()=>new mG(this._joinInfo,this._config.websocketRetryConfig||fw,this._config.httpRetryConfig||fw),n=e=>{e.onLiveStreamError=(e,t)=>{oI.reportApiInvoke(this._sessionId,{name:yR.ON_LIVE_STREAM_ERROR,options:[e,t],tag:CR.TRACER}).onSuccess(),this.safeEmit(NR.LIVE_STREAMING_ERROR,e,t)},e.onLiveStreamWarning=(e,t)=>{oI.reportApiInvoke(this._sessionId,{name:yR.ON_LIVE_STREAM_WARNING,options:[e,t],tag:CR.TRACER}).onSuccess(),this.safeEmit(NR.LIVE_STREAMING_WARNING,e,t)},e.on(Vb.REQUEST_WORKER_MANAGER_LIST,((e,t,n)=>{if(!this._joinInfo)return n(new bb(tR.INVALID_OPERATION,"can not find join info to get worker manager"));zO(e,this._joinInfo,this._axiosCancelSource.token,fw).then(t).catch(n)}))};switch(e){case Nb.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),n(this._liveRawStreamingClient)),this._liveRawStreamingClient;case Nb.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),n(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case Nb.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(Vb.REQUEST_WORKER_MANAGER_LIST,((e,t,n)=>{if(!this._joinInfo)return n(new bb(tR.INVALID_OPERATION,"can not find join info to get worker manager"));zO(e,this._joinInfo,this._axiosCancelSource.token,fw).then(t).catch(n)})),this._injectStreamingClient.onInjectStatusChange=(e,t,n)=>{this.safeEmit(NR.INJECT_STREAM_STATUS,e,t,n)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new bb(tR.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),n={width:e,height:t};this._channelMediaRelayClient=new vG(this._joinInfo,this._clientId,this._config.websocketRetryConfig||fw,this._config.httpRetryConfig||fw,n),this._channelMediaRelayClient.on("state",(e=>{e===Wb.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(NR.CHANNEL_MEDIA_RELAY_STATE,e)})),this._channelMediaRelayClient.on("event",(e=>{this.safeEmit(NR.CHANNEL_MEDIA_RELAY_EVENT,e)})),this._statsCollector.onStatsChanged=(e,t)=>{var n;"resolution"===e&&(null===(n=this._channelMediaRelayClient)||void 0===n||n.setVideoProfile(t))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){const{added:n,deleted:i}=e,r=[];Array.isArray(n)&&n.length>0&&n.forEach((e=>{const{uid:n,stream_id:i,ordered:o,max_retrans_times:s,metadata:a}=e,c=this._users.find((e=>e._uintid===n));if(c){if(Qw.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(n)),Pi(r).call(r,c)||r.push(c),c._uintid||(c._uintid=n),-1===c._dataChannels.findIndex((t=>t.id===e.stream_id))){const e={id:i,ordered:!!o,maxRetransmits:s,metadata:a},n=new KF(e);c._dataChannels.push(n),Qw.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published datachannel")),t||this.safeEmit(NR.USER_PUBLISHED,c,"datachannel",e)}this._p2pChannel.hasPendingRemoteDataChannel(c,e.stream_id)&&(Qw.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(c.uid," after reconnect.")),this._subscribeDataChannel(c,e.stream_id).catch((e=>{Qw.error("[".concat(this._clientId,"] resubscribe datachannel error"),e.toString())})))}else Qw.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"))})),t&&(this.safeEmit(NR.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach((e=>{const{uid:t,stream_id:n}=e,i=this._users.find((e=>e._uintid===t));if(!i)return void Qw.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const r=i._dataChannels.find((t=>t.id===e.stream_id));r&&(Qw.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(t)),this._p2pChannel.unsubscribeDataChannel(i,[r]).then((e=>{if(i._dataChannels=i._dataChannels.filter((e=>e!==r)),e)return this._gateway.unsubscribeDataChannel(e,i.uid)})),Qw.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished datachannel ,id:").concat(r.id)),this.safeEmit(NR.USER_UNPUBLISHED,i,"datachannel",r._config))}))}_handleRemoveDataChannels(e){const t=this._users.find((t=>t.uid===e.uid));if(t){if(void 0!==t._dataChannels&&t._dataChannels.length>0){Qw.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{Qw.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach((e=>{this.safeEmit(NR.USER_UNPUBLISHED,t,"datachannel",e._config)}))};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then((e=>{if(e)return this._gateway.unsubscribeDataChannel(e,t.uid)})),n()}}else Qw.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(zb.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(zb.CONNECTION_STATE_CHANGE,((e,t,n)=>{var i;if(n===IR.FALLBACK)return;const r=()=>{this.safeEmit(NR.CONNECTION_STATE_CHANGE,e,t,n)};if(oI.reportApiInvoke(this._sessionId||(null===(i=this._gateway.joinInfo)||void 0===i?void 0:i.sid)||null,{name:yR.CONNECTION_STATE_CHANGE,options:[e,t,n],tag:CR.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:n})),Qw.info("[".concat(this._clientId,"] connection state change: ").concat(t," -> ").concat(e)),"DISCONNECTED"===e)return this._reset(),void r();if("RECONNECTING"===e)this._users.forEach((e=>{e._trust_in_room_=!1,e._trust_audio_enabled_state_=!1,e._trust_video_enabled_state_=!1,e._trust_audio_mute_state_=!1,e._trust_video_mute_state_=!1,e._trust_audio_stream_added_state_=!1,e._trust_video_stream_added_state_=!1,e._is_pre_created||(e._audio_pre_subscribed||(e._audioSSRC=void 0,e._audioOrtc=void 0),e._video_pre_subscribed||(e._videoSSRC=void 0,e._videoOrtc=void 0,e._rtxSsrcId=void 0),e._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===e){var o;this._streamFallbackTypeCacheMap.forEach(((e,t)=>{this._gateway.setStreamFallbackOption(t,e).catch((e=>{Qw.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),e)}))})),this._remoteStreamTypeCacheMap.forEach(((e,t)=>{this._gateway.setRemoteVideoStreamType(t,e).catch((e=>{Qw.warning("[".concat(this._clientId,"] auto set remote stream type failed"),e)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(o=this._joinInfo)||void 0===o?void 0:o.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{Qw.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((e=>{Qw.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(e))})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._userOfflineTimeout=void 0,this._users.filter((e=>!e._trust_in_room_)).forEach((e=>{Qw.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(e.uid)),this._handleUserOffline({uid:e.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((e=>{e._trust_audio_mute_state_||(Qw.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,iA.AUDIO,!1)),e._trust_video_mute_state_||(Qw.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,iA.VIDEO,!1)),e._trust_audio_enabled_state_||(Qw.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(e.uid)),this._handleSetStreamLocalEnable("audio",e.uid,!0)),e._trust_video_enabled_state_||(Qw.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(e.uid)),this._handleSetStreamLocalEnable("video",e.uid,!0)),e._trust_video_stream_added_state_||(Qw.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(e.uid)),this._handleResetAddStream(e,"video")),e._trust_audio_stream_added_state_||(Qw.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(e.uid)),this._handleResetAddStream(e,"audio")),e._video_added_||e._audio_added_||(Qw.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(e.uid)),this._handleRemoveStream({uid:e.uid,uint_id:e._uintid}))})))}),1e3))}r()})),this._gateway.on(zb.REQUEST_NEW_GATEWAY_LIST,(async(e,t)=>{if(!this._joinInfo)return t(new bb(tR.UNEXPECTED_ERROR,"can not recover, no join info"));try{let t;this._joinInfo.recoverPreloadCache?(t=this._joinInfo.recoverPreloadCache.ap,oK(this._joinInfo.recoverPreloadCache),this._joinInfo.recoverPreloadCache=void 0):t=await FO(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||fw,this.store),this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip);const n=[];t.gatewayInfo.gatewayAddrs.forEach((e=>{let{address:t}=e;const[i,r]=t.split(":");this._joinInfo&&this._joinInfo.proxyServer?n.push({proxy:this._joinInfo.proxyServer,host:i,port:r}):n.push({host:i,port:r})})),e(n)}catch(e){t(e)}})),this._gateway.on(zb.NETWORK_QUALITY,(e=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(NR.NETWORK_QUALITY,e)})),this._gateway.on(zb.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(NR.STREAM_TYPE_CHANGED,e,t),oI.reportApiInvoke(this._sessionId,{name:yR.STREAM_TYPE_CHANGE,options:[e,t],tag:CR.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.on(zb.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(zb.NEED_RENEW_SESSION,(async e=>{if("recover"===e&&this._joinInfo){const e=await tK($K($K({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));this._joinInfo.recoverPreloadCache=e,this._startSession(null==e?void 0:e.sid)}else this._startSession()})),this._gateway.on(zb.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,n)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(e){n(e)}})),this._gateway.on(zb.JOIN_RESPONSE,((e,t)=>{if(this.store.useP2P)return;const{dtlsParameters:n,iceParameters:i,candidates:r,rtpCapabilities:o,setup:s,cname:a}=eB(e.ortc,t);this._p2pChannel.connect(i,n,r,o,s,a)})),this._gateway.on(zb.REQUEST_DC_CONNECTION_PARAMS,(e=>{e(this._p2pChannel.getEstablishParams())})),this._gateway.on(zb.RESET_SIGNAL,(e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()})),this._gateway.on(zb.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(zb.DATACHANNEL_PRECONNECT,(async(e,t,n,i)=>{var r,o,s,a,c,l;await this._p2pChannel.startP2PConnection({turnServer:null===(r=this._joinInfo)||void 0===r?void 0:r.turnServer},!0);const d=function(e,t){let n;return t&&t.ip&&"number"==typeof t.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],Qw.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),Qw.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],n}(e,t);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(o=this._joinInfo)||void 0===o?void 0:o.apResponse.cid,"_").concat(null===(s=this._joinInfo)||void 0===s?void 0:s.apResponse.cert),icePwd:"".concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cid,"_").concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(l=Dw("FINGERPRINT"))&&void 0!==l?l:e.fingerprint}]},d,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(i)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(Rb.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Rb.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Rb.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc))),this._gateway.signal.on(Rb.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(Rb.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(Rb.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)})),this._gateway.signal.on(Rb.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Rb.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Rb.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,iA.AUDIO,!0))),this._gateway.signal.on(Rb.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,iA.AUDIO,!1))),this._gateway.signal.on(Rb.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,iA.VIDEO,!0))),this._gateway.signal.on(Rb.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,iA.VIDEO,!1))),this._gateway.signal.on(Rb.RECEIVE_METADATA,(e=>{const t=zR(e.metadata);this.safeEmit(NR.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(Rb.ON_DATA_STREAM,(async e=>{var t;if(!e)return;let n=zR(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Pi(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)){if(e.payload.length<Fw)throw new bb(tR.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(Fw));const t=await async function(e,t,n){const i=n.subarray(0,Fw),r=i.slice(8,Fw),o=(r[0]<<8)+r[1],s=(i[6]<<8)+i[7],a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:e,tagLength:Uw,additionalData:new Uint8Array(aw(o,2))},t,n.subarray(Fw));return new Uint8Array(a).subarray(0,s)}(this._encryptDataStreamIv,this._encryptDataStreamKey,n);n=t}let i=0;if(e.ordered||e.syncWithAudio){const t=this._p2pChannel.getStats(),n=this.remoteUsers.find((t=>t.uid===e.uid)),r=null==t?void 0:t.audioRecv.find((e=>e.ssrc===(null==n?void 0:n._audioSSRC)));i=null==r?void 0:r.jitterBufferMs}null==i&&(i=0),FH($K($K({},e),{},{payload:n}),i,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(Rb.ON_CRYPT_ERROR,(()=>{KR((()=>{Qw.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(NR.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(Rb.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Rb.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{Qw.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,IR.TOKEN_EXPIRE),this.safeEmit(NR.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(Rb.ON_STREAM_FALLBACK_UPDATE,(e=>{Qw.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(NR.STREAM_FALLBACK,e.stream_id,1===e.stream_type?"fallback":"recover")})),this._gateway.signal.on(Rb.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),Qw.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(Rb.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(Rb.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(Sb.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case yb.PUBLISH:{if(!t)return;const e=t.ortc;if(e){var n,i;const r=e.some((e=>{let{stream_type:t}=e;return t===Kb.Audio})),o=e.some((e=>{let{stream_type:t}=e;return t!==Kb.Audio})),s=e.some((e=>{let{stream_type:t}=e;return t===Kb.Screen||t===Kb.ScreenLow}));"offer"===t.state&&oI.publish(this._joinInfo.sid,{eventElapse:nj.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:tR.TIMEOUT,audio:r,video:o,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:s,audioName:r?null===(n=e.find((e=>{let{stream_type:t}=e;return t===Kb.Audio})))||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0,videoName:o?null===(i=e.find((e=>{let{stream_type:t}=e;return t!==Kb.Audio})))||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId.toString():void 0})}break}case yb.SUBSCRIBE:t&&oI.subscribe(this._joinInfo.sid,{succ:!1,ec:tR.TIMEOUT,audio:t.stream_type===iA.AUDIO,video:t.stream_type===iA.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:nj.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}})),this._gateway.signal.on(Rb.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(Rb.ON_PUBLISHED_USER_LIST,(e=>{if(null==e||!e.users)return;Dw("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((e=>!dI(e.string_id||e.stream_id,this.channelName))));const t=[],n=[];for(const i of e.users){let e=this._users.find((e=>e._uintid===i.stream_id));e?e._trust_in_room_=!0:(e=new jB(i.string_id||i.stream_id,i.stream_id),this._users.push(e),0===this.getListeners(NR.PUBLISHED_USER_LIST).length&&(Qw.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(NR.USER_JOINED,e)));const r=Yb.Audio&i.stream_type,o=(Yb.Video|Yb.LwoVideo)&i.stream_type,s=0!=(65280&i.stream_type),a=r&&e.hasAudio,c=o&&e.hasVideo;o&&(e._trust_video_stream_added_state_=!0,e._video_added_=!0,e._videoSSRC=i.video_ssrc,e._rtxSsrcId=i.video_rtx),r&&(e._trust_audio_stream_added_state_=!0,e._audio_added_=!0,e._audioSSRC=i.audio_ssrc),r&&!a&&0===this.getListeners(NR.PUBLISHED_USER_LIST).length&&(Qw.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published audio")),this.safeEmit(NR.USER_PUBLISHED,e,"audio")),o&&!c&&0===this.getListeners(NR.PUBLISHED_USER_LIST).length&&(Qw.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published video")),this.safeEmit(NR.USER_PUBLISHED,e,"video")),(r&&!a||o&&!c||s)&&t.push(e),o&&this._p2pChannel.hasPendingRemoteMedia(e,"video")&&n.push({user:e,mediaType:"video"}),r&&this._p2pChannel.hasPendingRemoteMedia(e,"audio")&&n.push({user:e,mediaType:"audio"})}n.length>0&&(Qw.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((e=>"user: ".concat(e.user.uid,", mediaType: ").concat(e.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((e=>{Qw.error("[".concat(this._clientId,"] mass resubscribe error"),e.toString())}))),this.getListeners(NR.PUBLISHED_USER_LIST).length>0?Dw("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(Qw.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map((e=>e.uid)).join(", "))),this.safeEmit(NR.PUBLISHED_USER_LIST,t)):Qw.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map((e=>e.uid)).join(", ")))})),this._gateway.signal.on(Rb.ON_RTP_CAPABILITY_CHANGE,(e=>{const{video_codec:t}=e;this._p2pChannel instanceof TW&&this._p2pChannel.updateRemoteRTPCapabilities(t.map((e=>e.toLowerCase())).filter((e=>{var t;return Pi(t=Object.keys(Mw)).call(t,e)})))}))}_handleP2PEvents(){this._gateway.signal.on(Rb.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(gA.PUBLISH,((e,t,n)=>{const{uid:i}=e;e.forEach((e=>{const{kind:r,ssrcs:o,mid:s,isMuted:a}=e;this._handleP2PAddAudioOrVideoStream(r,i,o[0].ssrcId,s);const c=this._users.find((e=>e.uid===i));return c&&this._p2pChannel instanceof oG?this._p2pChannel.mockSubscribe(c,r,o[0].ssrcId,s).then((()=>{t()})).catch(n):t(),this._handleMuteStream(i,r,!!a)}))})),this._gateway.signal.on(gA.CALL,(async(e,t,n)=>{if(this._p2pChannel instanceof oG)try{var i;t(await this._p2pChannel.startP2P({turnServer:null===(i=this._joinInfo)||void 0===i?void 0:i.turnServer},e))}catch(e){n(e)}})),this._gateway.signal.on(Sb.P2P_CONNECTION,(async e=>{this._p2pChannel instanceof oG&&await this._p2pChannel.p2pConnect(e)})),this._gateway.signal.on(gA.UNPUBLISH,(async(e,t,n)=>{if(this._p2pChannel instanceof oG){const{unpubMsg:i,uid:r}=e,o=this._users.find((e=>e.uid===r));if(!o)return Qw.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void t();try{i.forEach((async e=>{let{stream_type:t}=e;const n=t===Kb.Audio?iA.AUDIO:iA.VIDEO;await this._p2pChannel.unsubscribe(o,n),this._handleMuteStream(r,n,!0)})),t()}catch(e){n(e)}}})),this._gateway.signal.on(gA.CONTROL,(async(e,t)=>{const{action:n}=e;switch(n){case TA.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,iA.VIDEO,!0);break;case TA.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,iA.AUDIO,!0);break;case TA.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,iA.VIDEO,!1);break;case TA.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,iA.AUDIO,!1)}})),this._gateway.signal.on(gA.RESTART_ICE,(async(e,t,n)=>{if(this._p2pChannel instanceof oG)try{const{direction:n,iceParameter:i}=e;n!==wb.SEND_ONLY||i?t(await this._p2pChannel.restartICE(n,i)):(this._p2pChannel.handleDisconnect(n),t())}catch(e){n(e)}})),this._gateway.signal.on(gA.CANDIDATE,(e=>{if(this._p2pChannel instanceof oG){const{candidate:t,direction:n}=e;this._p2pChannel.addRemoteCandidate(t,n)}})),this._p2pChannel.on(cA.RequestP2PRestartICE,(async(e,t,n)=>{try{const{direction:n}=e;t(await this._gateway.sendExtensionMessage(gA.RESTART_ICE,e,n===wb.SEND_ONLY))}catch(e){n(e)}})),this._p2pChannel.on(cA.LocalCandidate,(e=>{this._gateway.sendExtensionMessage(gA.CANDIDATE,JSON.stringify(e),!0)})),this._p2pChannel.on(cA.RequestP2PMuteLocal,(async(e,t,n)=>{try{await this._gateway.sendExtensionMessage(gA.CONTROL,e,!0),t()}catch(e){n(e)}})),this._p2pChannel.on(cA.RequestP2PUnmuteRemote,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===tR.DISCONNECT_P2P?t():n(e)}else t()})),this._p2pChannel.on(cA.RequestP2PMuteRemote,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===tR.DISCONNECT_P2P?t():n(e)}else t()})),this._p2pChannel.on(cA.StateChange,((e,t)=>{t===aA.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(cA.RequestMuteLocal,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===tR.DISCONNECT_P2P?t():n(e)}else t()})),this._p2pChannel.on(cA.RequestUnmuteLocal,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===tR.DISCONNECT_P2P?t():n(e)}else t()})),this._p2pChannel.on(cA.RequestRePublish,((e,t,n)=>{this.publish(e,!1).then(t).catch(n)})),this._p2pChannel.on(cA.RequestRePublishDataChannel,((e,t,n)=>{Gh.all(e.map((async e=>{await this._p2pChannel.publishDataChannel([e]);const t={streamId:e.id,ordered:e.ordered,maxRetransmits:e.maxRetransmits,metadata:e.metadata,channelId:e._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,t,!0)}catch(e){if(e.code!==tR.DISCONNECT_P2P)throw e}}))).then(t).catch(n)})),this._p2pChannel.on(cA.RequestReSubscribe,(async(e,t,n)=>{try{for(const{user:t,kind:n}of e)n===iA.VIDEO?await this.subscribe(t,"video"):await this.subscribe(t,"audio");t()}catch(e){n(e)}})),this._p2pChannel.on(cA.RequestUpload,((e,t)=>{this._gateway.upload(e,t)})),this._p2pChannel.on(cA.RequestUploadStats,(e=>{this._gateway.uploadWRTCStats(e)})),this._p2pChannel.on(cA.MediaReconnectStart,(e=>{this.safeEmit(NR.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(cA.MediaReconnectEnd,(e=>{this.safeEmit(NR.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(cA.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(cA.RequestRestartICE,(async e=>{if(this._p2pChannel instanceof oG)return;const t=await this._p2pChannel.restartICE(e),n=await t.next();if(n.done)return;const i=n.value;let r;try{r=await this._gateway.restartICE({iceParameters:i})}catch(e){return void t.throw(e)}const{iceParameters:o}=function(e){const t=e.iceParameters;return{iceParameters:{iceUfrag:t.iceUfrag,icePwd:t.icePwd}}}(r);await t.next({remoteIceParameters:o})})),this._p2pChannel.on(cA.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(cA.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:null===(e=this._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:n,rtpCapabilities:i}),{dtlsParameters:s,iceParameters:a,candidates:c,rtpCapabilities:l,setup:d,cname:u}=eB(r,o);await this._p2pChannel.connect(a,s,c,l,d,u),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(cA.RequestUnpublishForReconnectPC,(async(e,t,n)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(e,this._uid),t()):n()})),this._p2pChannel.on(cA.P2PLost,(()=>{this.safeEmit(NR.P2P_LOST,this.store.uid)})),this._p2pChannel.on(cA.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(cA.ConnectionTypeChange,(e=>{this.safeEmit(NR.IS_USING_CLOUD_PROXY,e)})),this._p2pChannel.on(cA.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(cA.QueryClientConnectionState,(e=>{e(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new bb(tR.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new bb(tR.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new bb(tR.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const t=[...new Set(e.inspectType)];t.forEach((e=>{var t;if(!Pi(t=["supervise","moderation"]).call(t,e))throw new bb(tR.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(e," is not a valid inspect type."))})),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new bb(tR.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const t=new QW(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},fw)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new bb(tR.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(iR(e,"enabled"),e){if(!t)throw new bb(tR.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(oR(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new bb(tR.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(t&&t.vendor&&t.vendor.length>1024)throw new bb(tR.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new bb(tR.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);const e=new NH(t);this._moderation=e,this.handleImageModerationEvents(this._moderation),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},fw)}catch(e){throw Array.isArray(e)?e[0]:e}}else{if(!this._moderation)throw new bb(tR.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}}setP2PTransport(e){if(function(e){rR(e,"transport",["default","auto","relay","sd-rtn"])}(e),"p2p"!==this.mode)throw new bb(tR.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,Qw.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}handleImageModerationEvents(e){e.on(_A.CONNECTION_STATE_CHANGE,((t,n)=>{if(this.safeEmit(NR.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,n),t===mA.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new bb(tR.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(_A.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}handleVideoInspectEvents(e){e.on(uA.CONNECTION_STATE_CHANGE,((t,n)=>{if(this.safeEmit(NR.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,n),n===lA.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(NR.CONTENT_INSPECT_ERROR,new bb(tR.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(uA.INSPECT_RESULT,((e,t)=>{var n;if((null==t?void 0:t.code)===tR.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return Qw.debug("Stop inspect content because that has left channel"),null==this||null===(n=this._inspect)||void 0===n||n.close(),void(this._inspect=void 0);this.safeEmit(NR.CONTENT_INSPECT_RESULT,e,t)})),e.on(uA.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return Qw.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){iR(e,"enabled"),Nw("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}},ib(QK.prototype,"leave",[lK],Object.getOwnPropertyDescriptor(QK.prototype,"leave"),QK.prototype),ib(QK.prototype,"publish",[dK],Object.getOwnPropertyDescriptor(QK.prototype,"publish"),QK.prototype),ib(QK.prototype,"unpublish",[uK],Object.getOwnPropertyDescriptor(QK.prototype,"unpublish"),QK.prototype),ib(QK.prototype,"subscribe",[hK],Object.getOwnPropertyDescriptor(QK.prototype,"subscribe"),QK.prototype),ib(QK.prototype,"presubscribe",[pK],Object.getOwnPropertyDescriptor(QK.prototype,"presubscribe"),QK.prototype),ib(QK.prototype,"massSubscribe",[fK],Object.getOwnPropertyDescriptor(QK.prototype,"massSubscribe"),QK.prototype),ib(QK.prototype,"unsubscribe",[mK],Object.getOwnPropertyDescriptor(QK.prototype,"unsubscribe"),QK.prototype),ib(QK.prototype,"massUnsubscribe",[_K],Object.getOwnPropertyDescriptor(QK.prototype,"massUnsubscribe"),QK.prototype),ib(QK.prototype,"setLowStreamParameter",[EK],Object.getOwnPropertyDescriptor(QK.prototype,"setLowStreamParameter"),QK.prototype),ib(QK.prototype,"enableDualStream",[gK],Object.getOwnPropertyDescriptor(QK.prototype,"enableDualStream"),QK.prototype),ib(QK.prototype,"disableDualStream",[vK],Object.getOwnPropertyDescriptor(QK.prototype,"disableDualStream"),QK.prototype),ib(QK.prototype,"setClientRole",[TK],Object.getOwnPropertyDescriptor(QK.prototype,"setClientRole"),QK.prototype),ib(QK.prototype,"setProxyServer",[SK],Object.getOwnPropertyDescriptor(QK.prototype,"setProxyServer"),QK.prototype),ib(QK.prototype,"setTurnServer",[yK],Object.getOwnPropertyDescriptor(QK.prototype,"setTurnServer"),QK.prototype),ib(QK.prototype,"setLicense",[CK],Object.getOwnPropertyDescriptor(QK.prototype,"setLicense"),QK.prototype),ib(QK.prototype,"startProxyServer",[RK],Object.getOwnPropertyDescriptor(QK.prototype,"startProxyServer"),QK.prototype),ib(QK.prototype,"stopProxyServer",[wK],Object.getOwnPropertyDescriptor(QK.prototype,"stopProxyServer"),QK.prototype),ib(QK.prototype,"setLocalAccessPointsV2",[IK],Object.getOwnPropertyDescriptor(QK.prototype,"setLocalAccessPointsV2"),QK.prototype),ib(QK.prototype,"setLocalAccessPoints",[bK],Object.getOwnPropertyDescriptor(QK.prototype,"setLocalAccessPoints"),QK.prototype),ib(QK.prototype,"setRemoteDefaultVideoStreamType",[AK],Object.getOwnPropertyDescriptor(QK.prototype,"setRemoteDefaultVideoStreamType"),QK.prototype),ib(QK.prototype,"setRemoteVideoStreamType",[OK],Object.getOwnPropertyDescriptor(QK.prototype,"setRemoteVideoStreamType"),QK.prototype),ib(QK.prototype,"setStreamFallbackOption",[NK],Object.getOwnPropertyDescriptor(QK.prototype,"setStreamFallbackOption"),QK.prototype),ib(QK.prototype,"setEncryptionConfig",[DK],Object.getOwnPropertyDescriptor(QK.prototype,"setEncryptionConfig"),QK.prototype),ib(QK.prototype,"renewToken",[PK],Object.getOwnPropertyDescriptor(QK.prototype,"renewToken"),QK.prototype),ib(QK.prototype,"enableAudioVolumeIndicator",[kK],Object.getOwnPropertyDescriptor(QK.prototype,"enableAudioVolumeIndicator"),QK.prototype),ib(QK.prototype,"startLiveStreaming",[LK],Object.getOwnPropertyDescriptor(QK.prototype,"startLiveStreaming"),QK.prototype),ib(QK.prototype,"setLiveTranscoding",[MK],Object.getOwnPropertyDescriptor(QK.prototype,"setLiveTranscoding"),QK.prototype),ib(QK.prototype,"stopLiveStreaming",[UK],Object.getOwnPropertyDescriptor(QK.prototype,"stopLiveStreaming"),QK.prototype),ib(QK.prototype,"addInjectStreamUrl",[xK],Object.getOwnPropertyDescriptor(QK.prototype,"addInjectStreamUrl"),QK.prototype),ib(QK.prototype,"removeInjectStreamUrl",[VK],Object.getOwnPropertyDescriptor(QK.prototype,"removeInjectStreamUrl"),QK.prototype),ib(QK.prototype,"startChannelMediaRelay",[FK],Object.getOwnPropertyDescriptor(QK.prototype,"startChannelMediaRelay"),QK.prototype),ib(QK.prototype,"updateChannelMediaRelay",[jK],Object.getOwnPropertyDescriptor(QK.prototype,"updateChannelMediaRelay"),QK.prototype),ib(QK.prototype,"stopChannelMediaRelay",[BK],Object.getOwnPropertyDescriptor(QK.prototype,"stopChannelMediaRelay"),QK.prototype),ib(QK.prototype,"sendCustomReportMessage",[GK],Object.getOwnPropertyDescriptor(QK.prototype,"sendCustomReportMessage"),QK.prototype),ib(QK.prototype,"pickSVCLayer",[WK],Object.getOwnPropertyDescriptor(QK.prototype,"pickSVCLayer"),QK.prototype),ib(QK.prototype,"setRTMConfig",[HK],Object.getOwnPropertyDescriptor(QK.prototype,"setRTMConfig"),QK.prototype),ib(QK.prototype,"enableContentInspect",[KK],Object.getOwnPropertyDescriptor(QK.prototype,"enableContentInspect"),QK.prototype),ib(QK.prototype,"disableContentInspect",[zK],Object.getOwnPropertyDescriptor(QK.prototype,"disableContentInspect"),QK.prototype),ib(QK.prototype,"setImageModeration",[qK],Object.getOwnPropertyDescriptor(QK.prototype,"setImageModeration"),QK.prototype),ib(QK.prototype,"setP2PTransport",[YK],Object.getOwnPropertyDescriptor(QK.prototype,"setP2PTransport"),QK.prototype),ib(QK.prototype,"getJoinChannelServiceRecords",[JK],Object.getOwnPropertyDescriptor(QK.prototype,"getJoinChannelServiceRecords"),QK.prototype),ib(QK.prototype,"setPublishAudioFilterEnabled",[XK],Object.getOwnPropertyDescriptor(QK.prototype,"setPublishAudioFilterEnabled"),QK.prototype),QK);class tz{constructor(e,t){iT(this,"id",0),iT(this,"element",void 0),iT(this,"peerPair",void 0),iT(this,"context",void 0),iT(this,"audioPlayerElement",void 0),iT(this,"audioTrack",void 0),tz.count+=1,this.id=tz.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;const e=async(e,t)=>{const n="offer"===t?await e.createOffer():await e.createAnswer();return await e.setLocalDescription(n),"complete"===e.iceGatheringState?e.localDescription:new Gh((t=>{e.onicegatheringstatechange=()=>{"complete"===e.iceGatheringState&&t(e.localDescription)}}))},t=async(e,t)=>await e.setRemoteDescription(t);try{const n=await e(this.peerPair[0],"offer");await t(this.peerPair[1],n);const i=await e(this.peerPair[1],"answer");await t(this.peerPair[0],i)}catch(e){throw new bb(tR.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(t)}catch(e){throw new bb(tR.LOCAL_AEC_ERROR,e.toString()).print()}if(!t)throw new bb(tR.LOCAL_AEC_ERROR,"no dest node when local aec").print();const n=t.stream.getAudioTracks()[0];return this.audioTrack=n,n}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){Qw.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var nz,iz;iT(tz,"count",0);const rz=window.AudioContext||window.webkitAudioContext,oz=new(nz=rI({report:oI}),ib((iz=class{constructor(){iT(this,"units",[]),iT(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return Qw.debug("the system does not need to process local aec"),-1;this.context||(this.context=new rz);let t=this.units.find((t=>t&&t.getElement()===e));return t||(t=new tz(e,this.context),this.units.push(t)),t.startEchoCancellation(),Qw.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return RC().name!==TC.SAFARI}}).prototype,"processExternalMediaAEC",[nz],Object.getOwnPropertyDescriptor(iz.prototype,"processExternalMediaAEC"),iz.prototype),iz);function sz(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function az(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?sz(Object(n),!0).forEach((function(t){iT(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):sz(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const cz=window||document;function lz(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!cz)return;const n=uz._cspEventHandlerPointer;if(n&&t)return void console.error(n,t);const i=e=>{if(!(e&&e.blockedURI&&(uz.onSecurityPolicyViolation||uz.getListeners(fA.SECURITY_POLICY_VIOLATION).length>0)))return;const t=e.blockedURI;Dw("CSP_DETECTED_HOSTNAME_LIST").some((e=>Pi(t).call(t,e)))&&(uz.onSecurityPolicyViolation&&"function"==typeof uz.onSecurityPolicyViolation&&uz.onSecurityPolicyViolation(e),uz.getListeners(fA.SECURITY_POLICY_VIOLATION).length>0&&uz.safeEmit(fA.SECURITY_POLICY_VIOLATION,e))};n&&cz.removeEventListener("securitypolicyviolation",n),(t||e&&"function"==typeof e||uz.getListeners(fA.SECURITY_POLICY_VIOLATION).length>0)&&cz.addEventListener("securitypolicyviolation",i),uz._cspEventHandlerPointer=i}Nw("PROCESS_ID","process-".concat(ew(8,""),"-").concat(ew(4,""),"-").concat(ew(4,""),"-").concat(ew(4,""),"-").concat(ew(12,""))),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void Qw.error("Error loading sdk config",e.message)}if(e)try{const t=JSON.parse(window.atob(e)),n=Date.now();Qw.debug("Loading global parameters from cache",t),Object.keys(t).forEach((e=>{if(Object.prototype.hasOwnProperty.call(Ow,e)){const{value:i,expires:r}=t[e];if(r&&r<=n)return;Pw[e]=i,Ow[e]=i}}))}catch(t){Qw.error("Error loading mutableParamsCache: ".concat(e),t.message)}}(),Array.isArray(Pw.AREAS)&&Pw.AREAS.length>0&&yO(Pw.AREAS,!0);const dz=(e,t,n)=>{Qw.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(t))),Nw(e,t,n)},uz=function(e){const t=new vR,n=e,i={getListeners:t.getListeners.bind(t),on:(e,n)=>(function(e,t){e===fA.SECURITY_POLICY_VIOLATION&&lz(t,!0)}(e,n),t.on.bind(t)(e,n)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return az(az({},n),i)}({__TRACK_LIST__:NU,VERSION:Rw,BUILD:Aw,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:dz,getParameter:Dw,getSupportedCodec:async function(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;const n=await async function(e){let t;return fU().supportUnifiedPlan?(e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"}),t=(await e.createOffer()).sdp):t=(await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,t}(t);if(!n)return e;t.close(),t=null,e=function(e){const t={video:[],audio:[]};return e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ VP9/i)&&t.video.push("VP9"),e.match(/ AV1/i)&&t.video.push("AV1"),e.match(/ H264/i)&&t.video.push("H264"),e.match(/ H265/i)&&t.video.push("H265"),e.match(/ opus/i)&&t.audio.push("OPUS"),e.match(/ PCMU/i)&&t.audio.push("PCMU"),e.match(/ PCMA/i)&&t.audio.push("PCMA"),e.match(/ G722/i)&&t.audio.push("G722"),t}(n)}catch(e){throw new bb(tR.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return e},checkSystemRequirements:function(){const e=oI.reportApiInvoke(null,{name:yR.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:CR.TRACER});let t=!1;try{const e=window.RTCPeerConnection,n=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,i=window.WebSocket;t=!!(e&&n&&i),t&&YC()&&function(e){const t=RC();return!(t.name!==TC.CHROME||!t.osVersion)&&Number(t.version)<e}(75)&&(new e).close()}catch(e){return Qw.error("check system requirement failed: ",e),!1}let n=!1;const i=RC();i.name===TC.CHROME&&Number(i.version)>=58&&("WebKit"!==yC.engine.name||function(){const e=RC();if(AC()){if(e.os===vC.MAC_OS)return!0;if(e.os===vC.IOS){const e=yC.os.version&&yC.os.version.split(".");if(e&&14===Number(e[0])&&e[1]&&Number(e[1])>=3)return!0;if(e&&Number(e[0])>14)return!0}}return!1}())&&(n=!0),(i.name===TC.FIREFOX&&Number(i.version)>=56||i.name===TC.OPERA&&Number(i.version)>=45||i.name===TC.SAFARI&&Number(i.version)>=11||"WebKit"===i.name&&(kC()||KC())&&i.osVersion&&Number(i.osVersion.split(".")[0])>=11||zC()||RC().name===TC.QQ)&&(n=!0),Qw.debug("checkSystemRequirements, api:",t,"browser",n);const r=t&&n;return e.onSuccess(r),r},getDevices:function(e){return Ix.enumerateDevices(!0,!0,e)},getMicrophones:function(e){return Ix.getRecordingDevices(e)},getCameras:function(e){return Ix.getCamerasDevices(e)},getElectronScreenSources:gx,getPlaybackDevices:function(e){return Ix.getSpeakers(e)},createClient:function(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=oI.reportApiInvoke(null,{name:yR.CREATE_CLIENT,options:[t],tag:CR.TRACER});try{!function(e){rR(e.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),rR(e.mode,"config.mode",["rtc","live","p2p"]),void 0!==e.audioCodec&&rR(e.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),void 0!==e.proxyServer&&aR(e.proxyServer,"config.proxyServer",1,1e4),void 0!==e.turnServer&&AR(e.turnServer),void 0!==e.httpRetryConfig&&RR(e.httpRetryConfig),void 0!==e.websocketRetryConfig&&RR(e.websocketRetryConfig)}(t)}catch(e){throw n.onError(e),e}return(xC(16,0,!0)||VC(16,0,!0))&&("vp9"===t.codec&&(t.codec="vp8",Qw.debug("browser not support vp9, force use vp8")),Nw("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===t.audioCodec&&(t.audioCodec="opus"),n.onSuccess(),new ez($K($K({forceWaitGatewayResponse:!0},t),{},{role:Pi(e=["rtc","p2p"]).call(e,t.mode)?"host":t.role||"audience"}))},createCameraVideoTrack:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=Dw("CAMERA_CAPTURE_CONFIG"),n=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.CREATE_CAM_VIDEO_TRACK,options:[tx({},e),t]});t&&(e.encoderConfig=t);const i=Bx(e),r=ew(8,"track-cam-");let o=null;const s="720p_auto"===e.encoderConfig;Qw.info("start create camera video track with config",JSON.stringify(e),"trackId",r);try{o=(await yx({video:i},r)).getVideoTracks()[0]||null}catch(e){throw n.onError(e),e}if(!o){const e=new nR(tR.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(e),e.throw(Qw)}e.optimizationMode&&wF(r,o,e,wU(e.encoderConfig));const a=new RF(o,e,i,e.scalabiltyMode?bU(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r);return s&&a.startMonitorStats(),n.onSuccess(a.getTrackId()),Qw.info("create camera video success, trackId:",r),a},createCustomVideoTrack:function(e){const t=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.CREATE_CUSTOM_VIDEO_TRACK,options:[e]}),n=new CF(e.mediaStreamTrack,{width:e.width,height:e.height,frameRate:e.frameRate,bitrateMax:e.bitrateMax,bitrateMin:e.bitrateMin},e.scalabiltyMode?bU(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,ew(8,"track-cus-"),[kU.CUSTOM_TRACK]);return t.onSuccess(n.getTrackId()),Qw.info("create custom video track success with config",e,"trackId",n.getTrackId()),n},createScreenVideoTrack:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"disable";const n=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.CREATE_SCREEN_VIDEO_TRACK,options:[tx({},e),t]}),i="720p_auto"===e.encoderConfig;e.encoderConfig?"string"==typeof e.encoderConfig||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";const r=function(e){const t={};e.screenSourceType&&(t.mediaSource=e.screenSourceType),e.extensionId&&OC()&&(t.extensionId=e.extensionId);const{displaySurface:n,selfBrowserSurface:i,surfaceSwitching:r,systemAudio:o}=e;(LC(107)||MC(107)||FC(93))&&(n&&(rR(n,"displaySurface",["browser","window","monitor"]),t.displaySurface=n),i?(rR(i,"selfBrowserSurface",["exclude","include"]),t.selfBrowserSurface=i):t.selfBrowserSurface="include",r&&(rR(r,"surfaceSwitching",["exclude","include"]),t.surfaceSwitching=r)),(LC(105)||MC(105)||FC(91))&&o&&(rR(o,"systemAudio",["exclude","include"]),t.systemAudio=o),e.electronScreenSourceId&&(t.sourceId=e.electronScreenSourceId);const s=e.encoderConfig?IU(e.encoderConfig):null;return t.mandatory={chromeMediaSource:"desktop",maxWidth:s?s.width:void 0,maxHeight:s?s.height:void 0},s&&(s.frameRate&&("number"==typeof s.frameRate?(t.mandatory.maxFrameRate=s.frameRate,t.mandatory.minFrameRate=s.frameRate):(t.mandatory.maxFrameRate=s.frameRate.max||s.frameRate.ideal||s.frameRate.exact||void 0,t.mandatory.minFrameRate=s.frameRate.min||s.frameRate.ideal||s.frameRate.exact||void 0),t.frameRate=s.frameRate),s.width&&(t.width=s.width),s.height&&(t.height=s.height)),t}(e),o=ew(8,"track-scr-v-");let s=null,a=null;const c=fU();if(!c.supportShareAudio&&"enable"===t){const e=new nR(tR.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return n.onError(e),e.throw(Qw)}Qw.info("start create screen video track with config",e,"withAudio",t,"trackId",o);try{const e=await yx({screen:r,screenAudio:"auto"===t?c.supportShareAudio:"enable"===t},o);s=e.getVideoTracks()[0]||null,a=e.getAudioTracks()[0]||null}catch(e){throw n.onError(e),e}if(!s){const e=new nR(tR.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(e),e.throw(Qw)}if(!a&&"enable"===t){s&&s.stop();const e=new nR(tR.SHARE_AUDIO_NOT_ALLOWED);return n.onError(e),e.throw(Qw)}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(wF(o,s,e,e.encoderConfig&&IU(e.encoderConfig)||void 0),e.encoderConfig&&"string"!=typeof e.encoderConfig&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));const l=new CF(s,e.encoderConfig?IU(e.encoderConfig):{},e.scalabiltyMode?bU(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,o,[kU.SCREEN_TRACK]);if(i&&l.startMonitorStats(),!a)return n.onSuccess(l.getTrackId()),Qw.info("create screen video track success","video:",l.getTrackId()),l;const d=new kV(a,void 0,ew(8,"track-scr-a-"),!1);return n.onSuccess([l.getTrackId(),d.getTrackId()]),Qw.info("create screen video track success","video:",l.getTrackId(),"audio:",d.getTrackId()),[l,d]},createMicrophoneAndCameraTracks:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=Dw("CAMERA_CAPTURE_CONFIG"),i=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.CREATE_MIC_AND_CAM_TRACKS,options:[e,t,n]});n&&(t.encoderConfig=n);const r="720p_auto"===t.encoderConfig,o=Bx(t),s=Gx(e),a=ew(8,"track-mic-"),c=ew(8,"track-cam-");let l=null,d=null;Qw.info("start create camera video track(".concat(c,") and microphone audio track(").concat(a,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(t)));try{const e=await yx({audio:s,video:o},"".concat(a,"-").concat(c));l=e.getAudioTracks()[0],d=e.getVideoTracks()[0]}catch(e){throw i.onError(e),e}if(!l||!d){const e=new nR(tR.UNEXPECTED_ERROR,"can not find tracks in media stream");return i.onError(e),e.throw(Qw)}t.optimizationMode&&wF(c,d,t,wU(t.encoderConfig));const u=new LV(l,e,s,a),h=new RF(d,t,o,t.scalabiltyMode?bU(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,c);return r&&h.startMonitorStats(),i.onSuccess([u.getTrackId(),h.getTrackId()]),Qw.info("create camera video track(".concat(c,") and microphone audio track(").concat(a,") success")),[u,h]},createMicrophoneAudioTrack:async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.CREATE_MIC_AUDIO_TRACK,options:[e]}),n=Gx(e),i=ew(8,"track-mic-");let r=null;Qw.info("start create microphone audio track with config",JSON.stringify(e),"trackId",i);try{r=(await yx({audio:n},i)).getAudioTracks()[0]||null}catch(e){throw t.onError(e),e}if(!r){const e=new nR(tR.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(e),e.throw(Qw)}const o=new LV(r,e,n,i);return t.onSuccess(o.getTrackId()),Qw.info("create microphone audio track success, trackId:",i),o},createCustomAudioTrack:function(e){const t=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.CREATE_CUSTOM_AUDIO_TRACK,options:[e]}),n=new kV(e.mediaStreamTrack,e.encoderConfig?OU(e.encoderConfig):{},ew(8,"track-cus-"),!1);return Qw.info("create custom audio track success with config",e,"trackId",n.getTrackId()),t.onSuccess(n.getTrackId()),n},createBufferSourceAudioTrack:async function(e){var t;const{cacheOnlineFile:n,encoderConfig:i}=e;let{source:r}=e;const o={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?null!==(t=File.name)&&void 0!==t?t:"File":r,cacheOnlineFile:n,encoderConfig:i},s=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(Dw("DISABLE_WEBAUDIO"))throw new nR(tR.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");const a=ew(8,"track-buf-");Qw.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",a);const c=r;if(!(r instanceof AudioBuffer))try{r=await async function(e,t){let n=null;if("string"==typeof e){const t=VV.get(e);if(t)return Qw.debug("use cached audio resource: ",e),t;try{n=(await _w((()=>pC.get(e,{responseType:"arraybuffer"})),void 0,void 0,{maxRetryCount:3})).data}catch(e){throw new nR(tR.FETCH_AUDIO_FILE_FAILED,e.toString())}}else{const t=new Gh(((t,n)=>{const i=new FileReader;i.onload=e=>{e.target?t(e.target.result):n(new nR(tR.READ_LOCAL_AUDIO_FILE_ERROR))},i.onerror=()=>{n(new nR(tR.READ_LOCAL_AUDIO_FILE_ERROR))},i.readAsArrayBuffer(e)}));n=await t}const i=await function(e){const t=lx();return new Gh(((n,i)=>{t.decodeAudioData(e,(e=>{n(e)}),(e=>{i(new nR(tR.DECODE_AUDIO_FILE_FAILED,e.toString()))}))}))}(n);return"string"==typeof e&&t&&VV.set(e,i),i}(r,n)}catch(e){return s.onError(e),e.throw(Qw)}const l=new xV(r),d=new MV(c,l,i?OU(i):{},a);return Qw.info("create buffer source audio track success, trackId:",a),s.onSuccess(d.getTrackId()),d},setAppType:function(e){if(Qw.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw Qw.debug("Invalid appType"),new bb(tR.INVALID_PARAMS,"invalid app type",e);Nw("APP_TYPE",Math.floor(e))},setLogLevel:function(e){Qw.setLogLevel(e)},enableLogUpload:function(){Dw("USE_NEW_LOG")?Nw("UPLOAD_LOG",!0):Qw.enableLogUpload()},disableLogUpload:function(){Dw("USE_NEW_LOG")?Nw("UPLOAD_LOG",!1):Qw.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new _G},checkAudioTrackIsActive:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const n=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof kV||e instanceof jF)){const e=new bb(tR.INVALID_TRACK,"the parameter is not a audio track");return n.onError(e),e.throw()}t&&t<1e3&&(t=1e3);const i=e instanceof kV?e.getTrackLabel():"remote_track",r=e.getVolumeLevel();let o=r,s=r;const a=Date.now();return new Gh((r=>{const c=setInterval((()=>{const l=e.getVolumeLevel();o=l>o?l:o,s=l<s?l:s;const d=o-s>1e-4,u=Date.now()-a;if(d||u>t){clearInterval(c);const t=d,s={duration:u,deviceLabel:i,maxVolumeLevel:o,result:t};Qw.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(s))),n.onSuccess(s),r(t)}}),200)}))},checkVideoTrackIsActive:async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const n=oI.reportApiInvoke(null,{tag:CR.TRACER,name:yR.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof CF||e instanceof FF)){const e=new bb(tR.INVALID_TRACK,"the parameter is not a video track");return n.onError(e),e.throw()}t&&t<1e3&&(t=1e3);const i=e instanceof CF?e.getTrackLabel():"remote_track",r=e.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(NC()||AC())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([r]),o.play();const s=document.createElement("canvas");s.width=160,s.height=120;let a=0,c=0;try{const e=Date.now();a=await function(e,t,n,i){let r,o=0,s=null;return new Gh(((a,c)=>{function l(){o>i&&r&&(r(),a(o));const t=n.getContext("2d");if(!t){const e=new bb(tR.UNEXPECTED_ERROR,"can not get canvas 2d context.");return Qw.error(e.toString()),void c(e)}t.drawImage(e,0,0,160,120);const l=t.getImageData(0,0,n.width,n.height),d=Math.floor(l.data.length/3);if(s){for(let e=0;e<d;e+=3)if(l.data[e]!==s[e])return o+=1,void(s=l.data);s=l.data}else s=l.data}setTimeout((()=>{r&&(r(),a(o))}),t),r=hx((()=>{l()}),30)}))}(o,t,s,4),c=Date.now()-e}catch(e){throw n.onError(e),e}jH===TC.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;const l=a>4,d={duration:c,changedPicNum:a,deviceLabel:i,result:l};return Qw.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(d))),n.onSuccess(d),l},setArea:yO,audioElementPlayCenter:Px,resumeAudioContext:function(){Px.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(e){oz.processExternalMediaAEC(e)},registerExtensions:function(e){const t=Dw("PLUGIN_INFO")||[];e.forEach((e=>{"name"in e&&!Pi(t).call(t,e.name)&&t.push(e.name);const n=e;n.__registered__=!0,n.logger.hookLog=Qw.extLog,n.reporter.hookApiInvoke=oI.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach((e=>{n.parameters[e]=Dw(e)}))})),dz("PLUGIN_INFO",t)},ChannelMediaRelayError:Hb,ChannelMediaRelayEvent:Gb,ChannelMediaRelayState:Wb,RemoteStreamFallbackType:UU,RemoteStreamType:MU,ConnectionDisconnectedReason:IR,AudienceLatencyLevelType:wR,AREAS:Xb,preload:async function(e,t,n,i){return eK(e,t,n,i)}});return Object.defineProperties(uz,{onAudioAutoplayFailed:{get:()=>Ax.onAudioAutoplayFailed,set:e=>{Ax.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>Ax.onAutoplayFailed,set:e=>{Ax.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>uz._onSecurityPolicyViolation,set(e){uz._onSecurityPolicyViolation=e,lz(e)}},__CLIENT_LIST__:{get:()=>Dw("SHOW_GLOBAL_CLIENT_LIST")?lI:[]}}),Ix.on(JU.CAMERA_DEVICE_CHANGED,(e=>{Qw.info("camera device changed",JSON.stringify(e)),uz.onCameraChanged&&uz.onCameraChanged(e),uz.safeEmit(fA.CAMERA_CHANGED,e)})),Ix.on(JU.RECORDING_DEVICE_CHANGED,(e=>{Qw.info("microphone device changed",JSON.stringify(e)),uz.onMicrophoneChanged&&uz.onMicrophoneChanged(e),uz.safeEmit(fA.MICROPHONE_CHANGED,e)})),Ix.on(JU.PLAYOUT_DEVICE_CHANGED,(e=>{Qw.debug("playout device changed",JSON.stringify(e)),uz.onPlaybackDeviceChanged&&uz.onPlaybackDeviceChanged(e),uz.safeEmit(fA.PLAYBACK_DEVICE_CHANGED,e)})),Px.onAutoplayFailed=()=>{Qw.info("detect audio element autoplay failed"),Ax.onAudioAutoplayFailed&&Ax.onAudioAutoplayFailed()},cx.on("autoplay-failed",(()=>{Qw.info("detect webaudio autoplay failed"),Ax.onAudioAutoplayFailed&&Ax.onAudioAutoplayFailed(),uz.safeEmit(fA.AUTOPLAY_FAILED)})),cx.on(_U.STATE_CHANGE,((e,t)=>{Qw.info("audio context state changed: ".concat(t," => ").concat(e)),uz.onAudioContextStateChanged&&uz.onAudioContextStateChanged(e,t),uz.safeEmit(fA.AUDIO_CONTEXT_STATE_CHANGED,e,t)})),VR.on(kR.NETWORK_STATE_CHANGE,((e,t)=>{Qw.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))})),window&&(window.__ARTC__=uz),uz}()},730:(e,t,n)=>{"use strict";var i=n(43),r=n(853);function o(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var s=new Set,a={};function c(e,t){l(e,t),l(e+"Capture",t)}function l(e,t){for(a[e]=t,e=0;e<t.length;e++)s.add(t[e])}var d=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),u=Object.prototype.hasOwnProperty,h=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,p={},f={};function m(e,t,n,i,r,o,s){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=i,this.attributeNamespace=r,this.mustUseProperty=n,this.propertyName=e,this.type=t,this.sanitizeURL=o,this.removeEmptyString=s}var _={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){_[e]=new m(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var t=e[0];_[t]=new m(t,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){_[e]=new m(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){_[e]=new m(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){_[e]=new m(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){_[e]=new m(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){_[e]=new m(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){_[e]=new m(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){_[e]=new m(e,5,!1,e.toLowerCase(),null,!1,!1)}));var E=/[\-:]([a-z])/g;function g(e){return e[1].toUpperCase()}function v(e,t,n,i){var r=_.hasOwnProperty(t)?_[t]:null;(null!==r?0!==r.type:i||!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&(function(e,t,n,i){if(null===t||"undefined"===typeof t||function(e,t,n,i){if(null!==n&&0===n.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!i&&(null!==n?!n.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,n,i))return!0;if(i)return!1;if(null!==n)switch(n.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,n,r,i)&&(n=null),i||null===r?function(e){return!!u.call(f,e)||!u.call(p,e)&&(h.test(e)?f[e]=!0:(p[e]=!0,!1))}(t)&&(null===n?e.removeAttribute(t):e.setAttribute(t,""+n)):r.mustUseProperty?e[r.propertyName]=null===n?3!==r.type&&"":n:(t=r.attributeName,i=r.attributeNamespace,null===n?e.removeAttribute(t):(n=3===(r=r.type)||4===r&&!0===n?"":""+n,i?e.setAttributeNS(i,t,n):e.setAttribute(t,n))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var t=e.replace(E,g);_[t]=new m(t,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var t=e.replace(E,g);_[t]=new m(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var t=e.replace(E,g);_[t]=new m(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){_[e]=new m(e,1,!1,e.toLowerCase(),null,!1,!1)})),_.xlinkHref=new m("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){_[e]=new m(e,1,!1,e.toLowerCase(),null,!0,!0)}));var T=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,S=Symbol.for("react.element"),y=Symbol.for("react.portal"),C=Symbol.for("react.fragment"),R=Symbol.for("react.strict_mode"),w=Symbol.for("react.profiler"),I=Symbol.for("react.provider"),b=Symbol.for("react.context"),A=Symbol.for("react.forward_ref"),O=Symbol.for("react.suspense"),N=Symbol.for("react.suspense_list"),D=Symbol.for("react.memo"),P=Symbol.for("react.lazy");Symbol.for("react.scope"),Symbol.for("react.debug_trace_mode");var k=Symbol.for("react.offscreen");Symbol.for("react.legacy_hidden"),Symbol.for("react.cache"),Symbol.for("react.tracing_marker");var L=Symbol.iterator;function M(e){return null===e||"object"!==typeof e?null:"function"===typeof(e=L&&e[L]||e["@@iterator"])?e:null}var U,x=Object.assign;function V(e){if(void 0===U)try{throw Error()}catch(n){var t=n.stack.trim().match(/\n( *(at )?)/);U=t&&t[1]||""}return"\n"+U+e}var F=!1;function j(e,t){if(!e||F)return"";F=!0;var n=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"===typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(l){var i=l}Reflect.construct(e,[],t)}else{try{t.call()}catch(l){i=l}e.call(t.prototype)}else{try{throw Error()}catch(l){i=l}e()}}catch(l){if(l&&i&&"string"===typeof l.stack){for(var r=l.stack.split("\n"),o=i.stack.split("\n"),s=r.length-1,a=o.length-1;1<=s&&0<=a&&r[s]!==o[a];)a--;for(;1<=s&&0<=a;s--,a--)if(r[s]!==o[a]){if(1!==s||1!==a)do{if(s--,0>--a||r[s]!==o[a]){var c="\n"+r[s].replace(" at new "," at ");return e.displayName&&c.includes("<anonymous>")&&(c=c.replace("<anonymous>",e.displayName)),c}}while(1<=s&&0<=a);break}}}finally{F=!1,Error.prepareStackTrace=n}return(e=e?e.displayName||e.name:"")?V(e):""}function B(e){switch(e.tag){case 5:return V(e.type);case 16:return V("Lazy");case 13:return V("Suspense");case 19:return V("SuspenseList");case 0:case 2:case 15:return e=j(e.type,!1);case 11:return e=j(e.type.render,!1);case 1:return e=j(e.type,!0);default:return""}}function G(e){if(null==e)return null;if("function"===typeof e)return e.displayName||e.name||null;if("string"===typeof e)return e;switch(e){case C:return"Fragment";case y:return"Portal";case w:return"Profiler";case R:return"StrictMode";case O:return"Suspense";case N:return"SuspenseList"}if("object"===typeof e)switch(e.$$typeof){case b:return(e.displayName||"Context")+".Consumer";case I:return(e._context.displayName||"Context")+".Provider";case A:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case D:return null!==(t=e.displayName||null)?t:G(e.type)||"Memo";case P:t=e._payload,e=e._init;try{return G(e(t))}catch(n){}}return null}function W(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=t.render).displayName||e.name||"",t.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return G(t);case 8:return t===R?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"===typeof t)return t.displayName||t.name||null;if("string"===typeof t)return t}return null}function H(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":case"object":return e;default:return""}}function K(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function z(e){e._valueTracker||(e._valueTracker=function(e){var t=K(e)?"checked":"value",n=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),i=""+e[t];if(!e.hasOwnProperty(t)&&"undefined"!==typeof n&&"function"===typeof n.get&&"function"===typeof n.set){var r=n.get,o=n.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return r.call(this)},set:function(e){i=""+e,o.call(this,e)}}),Object.defineProperty(e,t,{enumerable:n.enumerable}),{getValue:function(){return i},setValue:function(e){i=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function q(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var n=t.getValue(),i="";return e&&(i=K(e)?e.checked?"true":"false":e.value),(e=i)!==n&&(t.setValue(e),!0)}function Y(e){if("undefined"===typeof(e=e||("undefined"!==typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function J(e,t){var n=t.checked;return x({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=n?n:e._wrapperState.initialChecked})}function X(e,t){var n=null==t.defaultValue?"":t.defaultValue,i=null!=t.checked?t.checked:t.defaultChecked;n=H(null!=t.value?t.value:n),e._wrapperState={initialChecked:i,initialValue:n,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function Q(e,t){null!=(t=t.checked)&&v(e,"checked",t,!1)}function Z(e,t){Q(e,t);var n=H(t.value),i=t.type;if(null!=n)"number"===i?(0===n&&""===e.value||e.value!=n)&&(e.value=""+n):e.value!==""+n&&(e.value=""+n);else if("submit"===i||"reset"===i)return void e.removeAttribute("value");t.hasOwnProperty("value")?ee(e,t.type,n):t.hasOwnProperty("defaultValue")&&ee(e,t.type,H(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function $(e,t,n){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var i=t.type;if(!("submit"!==i&&"reset"!==i||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,n||t===e.value||(e.value=t),e.defaultValue=t}""!==(n=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==n&&(e.name=n)}function ee(e,t,n){"number"===t&&Y(e.ownerDocument)===e||(null==n?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+n&&(e.defaultValue=""+n))}var te=Array.isArray;function ne(e,t,n,i){if(e=e.options,t){t={};for(var r=0;r<n.length;r++)t["$"+n[r]]=!0;for(n=0;n<e.length;n++)r=t.hasOwnProperty("$"+e[n].value),e[n].selected!==r&&(e[n].selected=r),r&&i&&(e[n].defaultSelected=!0)}else{for(n=""+H(n),t=null,r=0;r<e.length;r++){if(e[r].value===n)return e[r].selected=!0,void(i&&(e[r].defaultSelected=!0));null!==t||e[r].disabled||(t=e[r])}null!==t&&(t.selected=!0)}}function ie(e,t){if(null!=t.dangerouslySetInnerHTML)throw Error(o(91));return x({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function re(e,t){var n=t.value;if(null==n){if(n=t.children,t=t.defaultValue,null!=n){if(null!=t)throw Error(o(92));if(te(n)){if(1<n.length)throw Error(o(93));n=n[0]}t=n}null==t&&(t=""),n=t}e._wrapperState={initialValue:H(n)}}function oe(e,t){var n=H(t.value),i=H(t.defaultValue);null!=n&&((n=""+n)!==e.value&&(e.value=n),null==t.defaultValue&&e.defaultValue!==n&&(e.defaultValue=n)),null!=i&&(e.defaultValue=""+i)}function se(e){var t=e.textContent;t===e._wrapperState.initialValue&&""!==t&&null!==t&&(e.value=t)}function ae(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function ce(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?ae(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var le,de,ue=(de=function(e,t){if("http://www.w3.org/2000/svg"!==e.namespaceURI||"innerHTML"in e)e.innerHTML=t;else{for((le=le||document.createElement("div")).innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=le.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,n,i){MSApp.execUnsafeLocalFunction((function(){return de(e,t)}))}:de);function he(e,t){if(t){var n=e.firstChild;if(n&&n===e.lastChild&&3===n.nodeType)return void(n.nodeValue=t)}e.textContent=t}var pe={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},fe=["Webkit","ms","Moz","O"];function me(e,t,n){return null==t||"boolean"===typeof t||""===t?"":n||"number"!==typeof t||0===t||pe.hasOwnProperty(e)&&pe[e]?(""+t).trim():t+"px"}function _e(e,t){for(var n in e=e.style,t)if(t.hasOwnProperty(n)){var i=0===n.indexOf("--"),r=me(n,t[n],i);"float"===n&&(n="cssFloat"),i?e.setProperty(n,r):e[n]=r}}Object.keys(pe).forEach((function(e){fe.forEach((function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),pe[t]=pe[e]}))}));var Ee=x({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function ge(e,t){if(t){if(Ee[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML))throw Error(o(137,e));if(null!=t.dangerouslySetInnerHTML){if(null!=t.children)throw Error(o(60));if("object"!==typeof t.dangerouslySetInnerHTML||!("__html"in t.dangerouslySetInnerHTML))throw Error(o(61))}if(null!=t.style&&"object"!==typeof t.style)throw Error(o(62))}}function ve(e,t){if(-1===e.indexOf("-"))return"string"===typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Te=null;function Se(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var ye=null,Ce=null,Re=null;function we(e){if(e=vr(e)){if("function"!==typeof ye)throw Error(o(280));var t=e.stateNode;t&&(t=Sr(t),ye(e.stateNode,e.type,t))}}function Ie(e){Ce?Re?Re.push(e):Re=[e]:Ce=e}function be(){if(Ce){var e=Ce,t=Re;if(Re=Ce=null,we(e),t)for(e=0;e<t.length;e++)we(t[e])}}function Ae(e,t){return e(t)}function Oe(){}var Ne=!1;function De(e,t,n){if(Ne)return e(t,n);Ne=!0;try{return Ae(e,t,n)}finally{Ne=!1,(null!==Ce||null!==Re)&&(Oe(),be())}}function Pe(e,t){var n=e.stateNode;if(null===n)return null;var i=Sr(n);if(null===i)return null;n=i[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(i=!i.disabled)||(i=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!i;break e;default:e=!1}if(e)return null;if(n&&"function"!==typeof n)throw Error(o(231,t,typeof n));return n}var ke=!1;if(d)try{var Le={};Object.defineProperty(Le,"passive",{get:function(){ke=!0}}),window.addEventListener("test",Le,Le),window.removeEventListener("test",Le,Le)}catch(de){ke=!1}function Me(e,t,n,i,r,o,s,a,c){var l=Array.prototype.slice.call(arguments,3);try{t.apply(n,l)}catch(d){this.onError(d)}}var Ue=!1,xe=null,Ve=!1,Fe=null,je={onError:function(e){Ue=!0,xe=e}};function Be(e,t,n,i,r,o,s,a,c){Ue=!1,xe=null,Me.apply(je,arguments)}function Ge(e){var t=e,n=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{0!==(4098&(t=e).flags)&&(n=t.return),e=t.return}while(e)}return 3===t.tag?n:null}function We(e){if(13===e.tag){var t=e.memoizedState;if(null===t&&(null!==(e=e.alternate)&&(t=e.memoizedState)),null!==t)return t.dehydrated}return null}function He(e){if(Ge(e)!==e)throw Error(o(188))}function Ke(e){return null!==(e=function(e){var t=e.alternate;if(!t){if(null===(t=Ge(e)))throw Error(o(188));return t!==e?null:e}for(var n=e,i=t;;){var r=n.return;if(null===r)break;var s=r.alternate;if(null===s){if(null!==(i=r.return)){n=i;continue}break}if(r.child===s.child){for(s=r.child;s;){if(s===n)return He(r),e;if(s===i)return He(r),t;s=s.sibling}throw Error(o(188))}if(n.return!==i.return)n=r,i=s;else{for(var a=!1,c=r.child;c;){if(c===n){a=!0,n=r,i=s;break}if(c===i){a=!0,i=r,n=s;break}c=c.sibling}if(!a){for(c=s.child;c;){if(c===n){a=!0,n=s,i=r;break}if(c===i){a=!0,i=s,n=r;break}c=c.sibling}if(!a)throw Error(o(189))}}if(n.alternate!==i)throw Error(o(190))}if(3!==n.tag)throw Error(o(188));return n.stateNode.current===n?e:t}(e))?ze(e):null}function ze(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var t=ze(e);if(null!==t)return t;e=e.sibling}return null}var qe=r.unstable_scheduleCallback,Ye=r.unstable_cancelCallback,Je=r.unstable_shouldYield,Xe=r.unstable_requestPaint,Qe=r.unstable_now,Ze=r.unstable_getCurrentPriorityLevel,$e=r.unstable_ImmediatePriority,et=r.unstable_UserBlockingPriority,tt=r.unstable_NormalPriority,nt=r.unstable_LowPriority,it=r.unstable_IdlePriority,rt=null,ot=null;var st=Math.clz32?Math.clz32:function(e){return e>>>=0,0===e?32:31-(at(e)/ct|0)|0},at=Math.log,ct=Math.LN2;var lt=64,dt=4194304;function ut(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function ht(e,t){var n=e.pendingLanes;if(0===n)return 0;var i=0,r=e.suspendedLanes,o=e.pingedLanes,s=268435455&n;if(0!==s){var a=s&~r;0!==a?i=ut(a):0!==(o&=s)&&(i=ut(o))}else 0!==(s=n&~r)?i=ut(s):0!==o&&(i=ut(o));if(0===i)return 0;if(0!==t&&t!==i&&0===(t&r)&&((r=i&-i)>=(o=t&-t)||16===r&&0!==(4194240&o)))return t;if(0!==(4&i)&&(i|=16&n),0!==(t=e.entangledLanes))for(e=e.entanglements,t&=i;0<t;)r=1<<(n=31-st(t)),i|=e[n],t&=~r;return i}function pt(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;default:return-1}}function ft(e){return 0!==(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function mt(){var e=lt;return 0===(4194240&(lt<<=1))&&(lt=64),e}function _t(e){for(var t=[],n=0;31>n;n++)t.push(e);return t}function Et(e,t,n){e.pendingLanes|=t,536870912!==t&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[t=31-st(t)]=n}function gt(e,t){var n=e.entangledLanes|=t;for(e=e.entanglements;n;){var i=31-st(n),r=1<<i;r&t|e[i]&t&&(e[i]|=t),n&=~r}}var vt=0;function Tt(e){return 1<(e&=-e)?4<e?0!==(268435455&e)?16:536870912:4:1}var St,yt,Ct,Rt,wt,It=!1,bt=[],At=null,Ot=null,Nt=null,Dt=new Map,Pt=new Map,kt=[],Lt="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Mt(e,t){switch(e){case"focusin":case"focusout":At=null;break;case"dragenter":case"dragleave":Ot=null;break;case"mouseover":case"mouseout":Nt=null;break;case"pointerover":case"pointerout":Dt.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":Pt.delete(t.pointerId)}}function Ut(e,t,n,i,r,o){return null===e||e.nativeEvent!==o?(e={blockedOn:t,domEventName:n,eventSystemFlags:i,nativeEvent:o,targetContainers:[r]},null!==t&&(null!==(t=vr(t))&&yt(t)),e):(e.eventSystemFlags|=i,t=e.targetContainers,null!==r&&-1===t.indexOf(r)&&t.push(r),e)}function xt(e){var t=gr(e.target);if(null!==t){var n=Ge(t);if(null!==n)if(13===(t=n.tag)){if(null!==(t=We(n)))return e.blockedOn=t,void wt(e.priority,(function(){Ct(n)}))}else if(3===t&&n.stateNode.current.memoizedState.isDehydrated)return void(e.blockedOn=3===n.tag?n.stateNode.containerInfo:null)}e.blockedOn=null}function Vt(e){if(null!==e.blockedOn)return!1;for(var t=e.targetContainers;0<t.length;){var n=Jt(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==n)return null!==(t=vr(n))&&yt(t),e.blockedOn=n,!1;var i=new(n=e.nativeEvent).constructor(n.type,n);Te=i,n.target.dispatchEvent(i),Te=null,t.shift()}return!0}function Ft(e,t,n){Vt(e)&&n.delete(t)}function jt(){It=!1,null!==At&&Vt(At)&&(At=null),null!==Ot&&Vt(Ot)&&(Ot=null),null!==Nt&&Vt(Nt)&&(Nt=null),Dt.forEach(Ft),Pt.forEach(Ft)}function Bt(e,t){e.blockedOn===t&&(e.blockedOn=null,It||(It=!0,r.unstable_scheduleCallback(r.unstable_NormalPriority,jt)))}function Gt(e){function t(t){return Bt(t,e)}if(0<bt.length){Bt(bt[0],e);for(var n=1;n<bt.length;n++){var i=bt[n];i.blockedOn===e&&(i.blockedOn=null)}}for(null!==At&&Bt(At,e),null!==Ot&&Bt(Ot,e),null!==Nt&&Bt(Nt,e),Dt.forEach(t),Pt.forEach(t),n=0;n<kt.length;n++)(i=kt[n]).blockedOn===e&&(i.blockedOn=null);for(;0<kt.length&&null===(n=kt[0]).blockedOn;)xt(n),null===n.blockedOn&&kt.shift()}var Wt=T.ReactCurrentBatchConfig,Ht=!0;function Kt(e,t,n,i){var r=vt,o=Wt.transition;Wt.transition=null;try{vt=1,qt(e,t,n,i)}finally{vt=r,Wt.transition=o}}function zt(e,t,n,i){var r=vt,o=Wt.transition;Wt.transition=null;try{vt=4,qt(e,t,n,i)}finally{vt=r,Wt.transition=o}}function qt(e,t,n,i){if(Ht){var r=Jt(e,t,n,i);if(null===r)Hi(e,t,i,Yt,n),Mt(e,i);else if(function(e,t,n,i,r){switch(t){case"focusin":return At=Ut(At,e,t,n,i,r),!0;case"dragenter":return Ot=Ut(Ot,e,t,n,i,r),!0;case"mouseover":return Nt=Ut(Nt,e,t,n,i,r),!0;case"pointerover":var o=r.pointerId;return Dt.set(o,Ut(Dt.get(o)||null,e,t,n,i,r)),!0;case"gotpointercapture":return o=r.pointerId,Pt.set(o,Ut(Pt.get(o)||null,e,t,n,i,r)),!0}return!1}(r,e,t,n,i))i.stopPropagation();else if(Mt(e,i),4&t&&-1<Lt.indexOf(e)){for(;null!==r;){var o=vr(r);if(null!==o&&St(o),null===(o=Jt(e,t,n,i))&&Hi(e,t,i,Yt,n),o===r)break;r=o}null!==r&&i.stopPropagation()}else Hi(e,t,i,null,n)}}var Yt=null;function Jt(e,t,n,i){if(Yt=null,null!==(e=gr(e=Se(i))))if(null===(t=Ge(e)))e=null;else if(13===(n=t.tag)){if(null!==(e=We(t)))return e;e=null}else if(3===n){if(t.stateNode.current.memoizedState.isDehydrated)return 3===t.tag?t.stateNode.containerInfo:null;e=null}else t!==e&&(e=null);return Yt=e,null}function Xt(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Ze()){case $e:return 1;case et:return 4;case tt:case nt:return 16;case it:return 536870912;default:return 16}default:return 16}}var Qt=null,Zt=null,$t=null;function en(){if($t)return $t;var e,t,n=Zt,i=n.length,r="value"in Qt?Qt.value:Qt.textContent,o=r.length;for(e=0;e<i&&n[e]===r[e];e++);var s=i-e;for(t=1;t<=s&&n[i-t]===r[o-t];t++);return $t=r.slice(e,1<t?1-t:void 0)}function tn(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}function nn(){return!0}function rn(){return!1}function on(e){function t(t,n,i,r,o){for(var s in this._reactName=t,this._targetInst=i,this.type=n,this.nativeEvent=r,this.target=o,this.currentTarget=null,e)e.hasOwnProperty(s)&&(t=e[s],this[s]=t?t(r):r[s]);return this.isDefaultPrevented=(null!=r.defaultPrevented?r.defaultPrevented:!1===r.returnValue)?nn:rn,this.isPropagationStopped=rn,this}return x(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!==typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=nn)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!==typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=nn)},persist:function(){},isPersistent:nn}),t}var sn,an,cn,ln={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},dn=on(ln),un=x({},ln,{view:0,detail:0}),hn=on(un),pn=x({},un,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:wn,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==cn&&(cn&&"mousemove"===e.type?(sn=e.screenX-cn.screenX,an=e.screenY-cn.screenY):an=sn=0,cn=e),sn)},movementY:function(e){return"movementY"in e?e.movementY:an}}),fn=on(pn),mn=on(x({},pn,{dataTransfer:0})),_n=on(x({},un,{relatedTarget:0})),En=on(x({},ln,{animationName:0,elapsedTime:0,pseudoElement:0})),gn=x({},ln,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),vn=on(gn),Tn=on(x({},ln,{data:0})),Sn={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},yn={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Cn={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Rn(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=Cn[e])&&!!t[e]}function wn(){return Rn}var In=x({},un,{key:function(e){if(e.key){var t=Sn[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=tn(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?yn[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:wn,charCode:function(e){return"keypress"===e.type?tn(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?tn(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),bn=on(In),An=on(x({},pn,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),On=on(x({},un,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:wn})),Nn=on(x({},ln,{propertyName:0,elapsedTime:0,pseudoElement:0})),Dn=x({},pn,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0}),Pn=on(Dn),kn=[9,13,27,32],Ln=d&&"CompositionEvent"in window,Mn=null;d&&"documentMode"in document&&(Mn=document.documentMode);var Un=d&&"TextEvent"in window&&!Mn,xn=d&&(!Ln||Mn&&8<Mn&&11>=Mn),Vn=String.fromCharCode(32),Fn=!1;function jn(e,t){switch(e){case"keyup":return-1!==kn.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Bn(e){return"object"===typeof(e=e.detail)&&"data"in e?e.data:null}var Gn=!1;var Wn={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Hn(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Wn[e.type]:"textarea"===t}function Kn(e,t,n,i){Ie(i),0<(t=zi(t,"onChange")).length&&(n=new dn("onChange","change",null,n,i),e.push({event:n,listeners:t}))}var zn=null,qn=null;function Yn(e){Vi(e,0)}function Jn(e){if(q(Tr(e)))return e}function Xn(e,t){if("change"===e)return t}var Qn=!1;if(d){var Zn;if(d){var $n="oninput"in document;if(!$n){var ei=document.createElement("div");ei.setAttribute("oninput","return;"),$n="function"===typeof ei.oninput}Zn=$n}else Zn=!1;Qn=Zn&&(!document.documentMode||9<document.documentMode)}function ti(){zn&&(zn.detachEvent("onpropertychange",ni),qn=zn=null)}function ni(e){if("value"===e.propertyName&&Jn(qn)){var t=[];Kn(t,qn,e,Se(e)),De(Yn,t)}}function ii(e,t,n){"focusin"===e?(ti(),qn=n,(zn=t).attachEvent("onpropertychange",ni)):"focusout"===e&&ti()}function ri(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return Jn(qn)}function oi(e,t){if("click"===e)return Jn(t)}function si(e,t){if("input"===e||"change"===e)return Jn(t)}var ai="function"===typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e===1/t)||e!==e&&t!==t};function ci(e,t){if(ai(e,t))return!0;if("object"!==typeof e||null===e||"object"!==typeof t||null===t)return!1;var n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(i=0;i<n.length;i++){var r=n[i];if(!u.call(t,r)||!ai(e[r],t[r]))return!1}return!0}function li(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function di(e,t){var n,i=li(e);for(e=0;i;){if(3===i.nodeType){if(n=e+i.textContent.length,e<=t&&n>=t)return{node:i,offset:t-e};e=n}e:{for(;i;){if(i.nextSibling){i=i.nextSibling;break e}i=i.parentNode}i=void 0}i=li(i)}}function ui(e,t){return!(!e||!t)&&(e===t||(!e||3!==e.nodeType)&&(t&&3===t.nodeType?ui(e,t.parentNode):"contains"in e?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t))))}function hi(){for(var e=window,t=Y();t instanceof e.HTMLIFrameElement;){try{var n="string"===typeof t.contentWindow.location.href}catch(i){n=!1}if(!n)break;t=Y((e=t.contentWindow).document)}return t}function pi(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}function fi(e){var t=hi(),n=e.focusedElem,i=e.selectionRange;if(t!==n&&n&&n.ownerDocument&&ui(n.ownerDocument.documentElement,n)){if(null!==i&&pi(n))if(t=i.start,void 0===(e=i.end)&&(e=t),"selectionStart"in n)n.selectionStart=t,n.selectionEnd=Math.min(e,n.value.length);else if((e=(t=n.ownerDocument||document)&&t.defaultView||window).getSelection){e=e.getSelection();var r=n.textContent.length,o=Math.min(i.start,r);i=void 0===i.end?o:Math.min(i.end,r),!e.extend&&o>i&&(r=i,i=o,o=r),r=di(n,o);var s=di(n,i);r&&s&&(1!==e.rangeCount||e.anchorNode!==r.node||e.anchorOffset!==r.offset||e.focusNode!==s.node||e.focusOffset!==s.offset)&&((t=t.createRange()).setStart(r.node,r.offset),e.removeAllRanges(),o>i?(e.addRange(t),e.extend(s.node,s.offset)):(t.setEnd(s.node,s.offset),e.addRange(t)))}for(t=[],e=n;e=e.parentNode;)1===e.nodeType&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for("function"===typeof n.focus&&n.focus(),n=0;n<t.length;n++)(e=t[n]).element.scrollLeft=e.left,e.element.scrollTop=e.top}}var mi=d&&"documentMode"in document&&11>=document.documentMode,_i=null,Ei=null,gi=null,vi=!1;function Ti(e,t,n){var i=n.window===n?n.document:9===n.nodeType?n:n.ownerDocument;vi||null==_i||_i!==Y(i)||("selectionStart"in(i=_i)&&pi(i)?i={start:i.selectionStart,end:i.selectionEnd}:i={anchorNode:(i=(i.ownerDocument&&i.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:i.anchorOffset,focusNode:i.focusNode,focusOffset:i.focusOffset},gi&&ci(gi,i)||(gi=i,0<(i=zi(Ei,"onSelect")).length&&(t=new dn("onSelect","select",null,t,n),e.push({event:t,listeners:i}),t.target=_i)))}function Si(e,t){var n={};return n[e.toLowerCase()]=t.toLowerCase(),n["Webkit"+e]="webkit"+t,n["Moz"+e]="moz"+t,n}var yi={animationend:Si("Animation","AnimationEnd"),animationiteration:Si("Animation","AnimationIteration"),animationstart:Si("Animation","AnimationStart"),transitionend:Si("Transition","TransitionEnd")},Ci={},Ri={};function wi(e){if(Ci[e])return Ci[e];if(!yi[e])return e;var t,n=yi[e];for(t in n)if(n.hasOwnProperty(t)&&t in Ri)return Ci[e]=n[t];return e}d&&(Ri=document.createElement("div").style,"AnimationEvent"in window||(delete yi.animationend.animation,delete yi.animationiteration.animation,delete yi.animationstart.animation),"TransitionEvent"in window||delete yi.transitionend.transition);var Ii=wi("animationend"),bi=wi("animationiteration"),Ai=wi("animationstart"),Oi=wi("transitionend"),Ni=new Map,Di="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Pi(e,t){Ni.set(e,t),c(t,[e])}for(var ki=0;ki<Di.length;ki++){var Li=Di[ki];Pi(Li.toLowerCase(),"on"+(Li[0].toUpperCase()+Li.slice(1)))}Pi(Ii,"onAnimationEnd"),Pi(bi,"onAnimationIteration"),Pi(Ai,"onAnimationStart"),Pi("dblclick","onDoubleClick"),Pi("focusin","onFocus"),Pi("focusout","onBlur"),Pi(Oi,"onTransitionEnd"),l("onMouseEnter",["mouseout","mouseover"]),l("onMouseLeave",["mouseout","mouseover"]),l("onPointerEnter",["pointerout","pointerover"]),l("onPointerLeave",["pointerout","pointerover"]),c("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),c("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),c("onBeforeInput",["compositionend","keypress","textInput","paste"]),c("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),c("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),c("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Mi="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Ui=new Set("cancel close invalid load scroll toggle".split(" ").concat(Mi));function xi(e,t,n){var i=e.type||"unknown-event";e.currentTarget=n,function(e,t,n,i,r,s,a,c,l){if(Be.apply(this,arguments),Ue){if(!Ue)throw Error(o(198));var d=xe;Ue=!1,xe=null,Ve||(Ve=!0,Fe=d)}}(i,t,void 0,e),e.currentTarget=null}function Vi(e,t){t=0!==(4&t);for(var n=0;n<e.length;n++){var i=e[n],r=i.event;i=i.listeners;e:{var o=void 0;if(t)for(var s=i.length-1;0<=s;s--){var a=i[s],c=a.instance,l=a.currentTarget;if(a=a.listener,c!==o&&r.isPropagationStopped())break e;xi(r,a,l),o=c}else for(s=0;s<i.length;s++){if(c=(a=i[s]).instance,l=a.currentTarget,a=a.listener,c!==o&&r.isPropagationStopped())break e;xi(r,a,l),o=c}}}if(Ve)throw e=Fe,Ve=!1,Fe=null,e}function Fi(e,t){var n=t[mr];void 0===n&&(n=t[mr]=new Set);var i=e+"__bubble";n.has(i)||(Wi(t,e,2,!1),n.add(i))}function ji(e,t,n){var i=0;t&&(i|=4),Wi(n,e,i,t)}var Bi="_reactListening"+Math.random().toString(36).slice(2);function Gi(e){if(!e[Bi]){e[Bi]=!0,s.forEach((function(t){"selectionchange"!==t&&(Ui.has(t)||ji(t,!1,e),ji(t,!0,e))}));var t=9===e.nodeType?e:e.ownerDocument;null===t||t[Bi]||(t[Bi]=!0,ji("selectionchange",!1,t))}}function Wi(e,t,n,i){switch(Xt(t)){case 1:var r=Kt;break;case 4:r=zt;break;default:r=qt}n=r.bind(null,t,n,e),r=void 0,!ke||"touchstart"!==t&&"touchmove"!==t&&"wheel"!==t||(r=!0),i?void 0!==r?e.addEventListener(t,n,{capture:!0,passive:r}):e.addEventListener(t,n,!0):void 0!==r?e.addEventListener(t,n,{passive:r}):e.addEventListener(t,n,!1)}function Hi(e,t,n,i,r){var o=i;if(0===(1&t)&&0===(2&t)&&null!==i)e:for(;;){if(null===i)return;var s=i.tag;if(3===s||4===s){var a=i.stateNode.containerInfo;if(a===r||8===a.nodeType&&a.parentNode===r)break;if(4===s)for(s=i.return;null!==s;){var c=s.tag;if((3===c||4===c)&&((c=s.stateNode.containerInfo)===r||8===c.nodeType&&c.parentNode===r))return;s=s.return}for(;null!==a;){if(null===(s=gr(a)))return;if(5===(c=s.tag)||6===c){i=o=s;continue e}a=a.parentNode}}i=i.return}De((function(){var i=o,r=Se(n),s=[];e:{var a=Ni.get(e);if(void 0!==a){var c=dn,l=e;switch(e){case"keypress":if(0===tn(n))break e;case"keydown":case"keyup":c=bn;break;case"focusin":l="focus",c=_n;break;case"focusout":l="blur",c=_n;break;case"beforeblur":case"afterblur":c=_n;break;case"click":if(2===n.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":c=fn;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":c=mn;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":c=On;break;case Ii:case bi:case Ai:c=En;break;case Oi:c=Nn;break;case"scroll":c=hn;break;case"wheel":c=Pn;break;case"copy":case"cut":case"paste":c=vn;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":c=An}var d=0!==(4&t),u=!d&&"scroll"===e,h=d?null!==a?a+"Capture":null:a;d=[];for(var p,f=i;null!==f;){var m=(p=f).stateNode;if(5===p.tag&&null!==m&&(p=m,null!==h&&(null!=(m=Pe(f,h))&&d.push(Ki(f,m,p)))),u)break;f=f.return}0<d.length&&(a=new c(a,l,null,n,r),s.push({event:a,listeners:d}))}}if(0===(7&t)){if(c="mouseout"===e||"pointerout"===e,(!(a="mouseover"===e||"pointerover"===e)||n===Te||!(l=n.relatedTarget||n.fromElement)||!gr(l)&&!l[fr])&&(c||a)&&(a=r.window===r?r:(a=r.ownerDocument)?a.defaultView||a.parentWindow:window,c?(c=i,null!==(l=(l=n.relatedTarget||n.toElement)?gr(l):null)&&(l!==(u=Ge(l))||5!==l.tag&&6!==l.tag)&&(l=null)):(c=null,l=i),c!==l)){if(d=fn,m="onMouseLeave",h="onMouseEnter",f="mouse","pointerout"!==e&&"pointerover"!==e||(d=An,m="onPointerLeave",h="onPointerEnter",f="pointer"),u=null==c?a:Tr(c),p=null==l?a:Tr(l),(a=new d(m,f+"leave",c,n,r)).target=u,a.relatedTarget=p,m=null,gr(r)===i&&((d=new d(h,f+"enter",l,n,r)).target=p,d.relatedTarget=u,m=d),u=m,c&&l)e:{for(h=l,f=0,p=d=c;p;p=qi(p))f++;for(p=0,m=h;m;m=qi(m))p++;for(;0<f-p;)d=qi(d),f--;for(;0<p-f;)h=qi(h),p--;for(;f--;){if(d===h||null!==h&&d===h.alternate)break e;d=qi(d),h=qi(h)}d=null}else d=null;null!==c&&Yi(s,a,c,d,!1),null!==l&&null!==u&&Yi(s,u,l,d,!0)}if("select"===(c=(a=i?Tr(i):window).nodeName&&a.nodeName.toLowerCase())||"input"===c&&"file"===a.type)var _=Xn;else if(Hn(a))if(Qn)_=si;else{_=ri;var E=ii}else(c=a.nodeName)&&"input"===c.toLowerCase()&&("checkbox"===a.type||"radio"===a.type)&&(_=oi);switch(_&&(_=_(e,i))?Kn(s,_,n,r):(E&&E(e,a,i),"focusout"===e&&(E=a._wrapperState)&&E.controlled&&"number"===a.type&&ee(a,"number",a.value)),E=i?Tr(i):window,e){case"focusin":(Hn(E)||"true"===E.contentEditable)&&(_i=E,Ei=i,gi=null);break;case"focusout":gi=Ei=_i=null;break;case"mousedown":vi=!0;break;case"contextmenu":case"mouseup":case"dragend":vi=!1,Ti(s,n,r);break;case"selectionchange":if(mi)break;case"keydown":case"keyup":Ti(s,n,r)}var g;if(Ln)e:{switch(e){case"compositionstart":var v="onCompositionStart";break e;case"compositionend":v="onCompositionEnd";break e;case"compositionupdate":v="onCompositionUpdate";break e}v=void 0}else Gn?jn(e,n)&&(v="onCompositionEnd"):"keydown"===e&&229===n.keyCode&&(v="onCompositionStart");v&&(xn&&"ko"!==n.locale&&(Gn||"onCompositionStart"!==v?"onCompositionEnd"===v&&Gn&&(g=en()):(Zt="value"in(Qt=r)?Qt.value:Qt.textContent,Gn=!0)),0<(E=zi(i,v)).length&&(v=new Tn(v,e,null,n,r),s.push({event:v,listeners:E}),g?v.data=g:null!==(g=Bn(n))&&(v.data=g))),(g=Un?function(e,t){switch(e){case"compositionend":return Bn(t);case"keypress":return 32!==t.which?null:(Fn=!0,Vn);case"textInput":return(e=t.data)===Vn&&Fn?null:e;default:return null}}(e,n):function(e,t){if(Gn)return"compositionend"===e||!Ln&&jn(e,t)?(e=en(),$t=Zt=Qt=null,Gn=!1,e):null;switch(e){case"paste":default:return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return xn&&"ko"!==t.locale?null:t.data}}(e,n))&&(0<(i=zi(i,"onBeforeInput")).length&&(r=new Tn("onBeforeInput","beforeinput",null,n,r),s.push({event:r,listeners:i}),r.data=g))}Vi(s,t)}))}function Ki(e,t,n){return{instance:e,listener:t,currentTarget:n}}function zi(e,t){for(var n=t+"Capture",i=[];null!==e;){var r=e,o=r.stateNode;5===r.tag&&null!==o&&(r=o,null!=(o=Pe(e,n))&&i.unshift(Ki(e,o,r)),null!=(o=Pe(e,t))&&i.push(Ki(e,o,r))),e=e.return}return i}function qi(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function Yi(e,t,n,i,r){for(var o=t._reactName,s=[];null!==n&&n!==i;){var a=n,c=a.alternate,l=a.stateNode;if(null!==c&&c===i)break;5===a.tag&&null!==l&&(a=l,r?null!=(c=Pe(n,o))&&s.unshift(Ki(n,c,a)):r||null!=(c=Pe(n,o))&&s.push(Ki(n,c,a))),n=n.return}0!==s.length&&e.push({event:t,listeners:s})}var Ji=/\r\n?/g,Xi=/\u0000|\uFFFD/g;function Qi(e){return("string"===typeof e?e:""+e).replace(Ji,"\n").replace(Xi,"")}function Zi(e,t,n){if(t=Qi(t),Qi(e)!==t&&n)throw Error(o(425))}function $i(){}var er=null,tr=null;function nr(e,t){return"textarea"===e||"noscript"===e||"string"===typeof t.children||"number"===typeof t.children||"object"===typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var ir="function"===typeof setTimeout?setTimeout:void 0,rr="function"===typeof clearTimeout?clearTimeout:void 0,or="function"===typeof Promise?Promise:void 0,sr="function"===typeof queueMicrotask?queueMicrotask:"undefined"!==typeof or?function(e){return or.resolve(null).then(e).catch(ar)}:ir;function ar(e){setTimeout((function(){throw e}))}function cr(e,t){var n=t,i=0;do{var r=n.nextSibling;if(e.removeChild(n),r&&8===r.nodeType)if("/$"===(n=r.data)){if(0===i)return e.removeChild(r),void Gt(t);i--}else"$"!==n&&"$?"!==n&&"$!"!==n||i++;n=r}while(n);Gt(t)}function lr(e){for(;null!=e;e=e.nextSibling){var t=e.nodeType;if(1===t||3===t)break;if(8===t){if("$"===(t=e.data)||"$!"===t||"$?"===t)break;if("/$"===t)return null}}return e}function dr(e){e=e.previousSibling;for(var t=0;e;){if(8===e.nodeType){var n=e.data;if("$"===n||"$!"===n||"$?"===n){if(0===t)return e;t--}else"/$"===n&&t++}e=e.previousSibling}return null}var ur=Math.random().toString(36).slice(2),hr="__reactFiber$"+ur,pr="__reactProps$"+ur,fr="__reactContainer$"+ur,mr="__reactEvents$"+ur,_r="__reactListeners$"+ur,Er="__reactHandles$"+ur;function gr(e){var t=e[hr];if(t)return t;for(var n=e.parentNode;n;){if(t=n[fr]||n[hr]){if(n=t.alternate,null!==t.child||null!==n&&null!==n.child)for(e=dr(e);null!==e;){if(n=e[hr])return n;e=dr(e)}return t}n=(e=n).parentNode}return null}function vr(e){return!(e=e[hr]||e[fr])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function Tr(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(o(33))}function Sr(e){return e[pr]||null}var yr=[],Cr=-1;function Rr(e){return{current:e}}function wr(e){0>Cr||(e.current=yr[Cr],yr[Cr]=null,Cr--)}function Ir(e,t){Cr++,yr[Cr]=e.current,e.current=t}var br={},Ar=Rr(br),Or=Rr(!1),Nr=br;function Dr(e,t){var n=e.type.contextTypes;if(!n)return br;var i=e.stateNode;if(i&&i.__reactInternalMemoizedUnmaskedChildContext===t)return i.__reactInternalMemoizedMaskedChildContext;var r,o={};for(r in n)o[r]=t[r];return i&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=o),o}function Pr(e){return null!==(e=e.childContextTypes)&&void 0!==e}function kr(){wr(Or),wr(Ar)}function Lr(e,t,n){if(Ar.current!==br)throw Error(o(168));Ir(Ar,t),Ir(Or,n)}function Mr(e,t,n){var i=e.stateNode;if(t=t.childContextTypes,"function"!==typeof i.getChildContext)return n;for(var r in i=i.getChildContext())if(!(r in t))throw Error(o(108,W(e)||"Unknown",r));return x({},n,i)}function Ur(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||br,Nr=Ar.current,Ir(Ar,e),Ir(Or,Or.current),!0}function xr(e,t,n){var i=e.stateNode;if(!i)throw Error(o(169));n?(e=Mr(e,t,Nr),i.__reactInternalMemoizedMergedChildContext=e,wr(Or),wr(Ar),Ir(Ar,e)):wr(Or),Ir(Or,n)}var Vr=null,Fr=!1,jr=!1;function Br(e){null===Vr?Vr=[e]:Vr.push(e)}function Gr(){if(!jr&&null!==Vr){jr=!0;var e=0,t=vt;try{var n=Vr;for(vt=1;e<n.length;e++){var i=n[e];do{i=i(!0)}while(null!==i)}Vr=null,Fr=!1}catch(r){throw null!==Vr&&(Vr=Vr.slice(e+1)),qe($e,Gr),r}finally{vt=t,jr=!1}}return null}var Wr=[],Hr=0,Kr=null,zr=0,qr=[],Yr=0,Jr=null,Xr=1,Qr="";function Zr(e,t){Wr[Hr++]=zr,Wr[Hr++]=Kr,Kr=e,zr=t}function $r(e,t,n){qr[Yr++]=Xr,qr[Yr++]=Qr,qr[Yr++]=Jr,Jr=e;var i=Xr;e=Qr;var r=32-st(i)-1;i&=~(1<<r),n+=1;var o=32-st(t)+r;if(30<o){var s=r-r%5;o=(i&(1<<s)-1).toString(32),i>>=s,r-=s,Xr=1<<32-st(t)+r|n<<r|i,Qr=o+e}else Xr=1<<o|n<<r|i,Qr=e}function eo(e){null!==e.return&&(Zr(e,1),$r(e,1,0))}function to(e){for(;e===Kr;)Kr=Wr[--Hr],Wr[Hr]=null,zr=Wr[--Hr],Wr[Hr]=null;for(;e===Jr;)Jr=qr[--Yr],qr[Yr]=null,Qr=qr[--Yr],qr[Yr]=null,Xr=qr[--Yr],qr[Yr]=null}var no=null,io=null,ro=!1,oo=null;function so(e,t){var n=Dl(5,null,null,0);n.elementType="DELETED",n.stateNode=t,n.return=e,null===(t=e.deletions)?(e.deletions=[n],e.flags|=16):t.push(n)}function ao(e,t){switch(e.tag){case 5:var n=e.type;return null!==(t=1!==t.nodeType||n.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,no=e,io=lr(t.firstChild),!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,no=e,io=null,!0);case 13:return null!==(t=8!==t.nodeType?null:t)&&(n=null!==Jr?{id:Xr,overflow:Qr}:null,e.memoizedState={dehydrated:t,treeContext:n,retryLane:1073741824},(n=Dl(18,null,null,0)).stateNode=t,n.return=e,e.child=n,no=e,io=null,!0);default:return!1}}function co(e){return 0!==(1&e.mode)&&0===(128&e.flags)}function lo(e){if(ro){var t=io;if(t){var n=t;if(!ao(e,t)){if(co(e))throw Error(o(418));t=lr(n.nextSibling);var i=no;t&&ao(e,t)?so(i,n):(e.flags=-4097&e.flags|2,ro=!1,no=e)}}else{if(co(e))throw Error(o(418));e.flags=-4097&e.flags|2,ro=!1,no=e}}}function uo(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;no=e}function ho(e){if(e!==no)return!1;if(!ro)return uo(e),ro=!0,!1;var t;if((t=3!==e.tag)&&!(t=5!==e.tag)&&(t="head"!==(t=e.type)&&"body"!==t&&!nr(e.type,e.memoizedProps)),t&&(t=io)){if(co(e))throw po(),Error(o(418));for(;t;)so(e,t),t=lr(t.nextSibling)}if(uo(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(o(317));e:{for(e=e.nextSibling,t=0;e;){if(8===e.nodeType){var n=e.data;if("/$"===n){if(0===t){io=lr(e.nextSibling);break e}t--}else"$"!==n&&"$!"!==n&&"$?"!==n||t++}e=e.nextSibling}io=null}}else io=no?lr(e.stateNode.nextSibling):null;return!0}function po(){for(var e=io;e;)e=lr(e.nextSibling)}function fo(){io=no=null,ro=!1}function mo(e){null===oo?oo=[e]:oo.push(e)}var _o=T.ReactCurrentBatchConfig;function Eo(e,t,n){if(null!==(e=n.ref)&&"function"!==typeof e&&"object"!==typeof e){if(n._owner){if(n=n._owner){if(1!==n.tag)throw Error(o(309));var i=n.stateNode}if(!i)throw Error(o(147,e));var r=i,s=""+e;return null!==t&&null!==t.ref&&"function"===typeof t.ref&&t.ref._stringRef===s?t.ref:(t=function(e){var t=r.refs;null===e?delete t[s]:t[s]=e},t._stringRef=s,t)}if("string"!==typeof e)throw Error(o(284));if(!n._owner)throw Error(o(290,e))}return e}function go(e,t){throw e=Object.prototype.toString.call(t),Error(o(31,"[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function vo(e){return(0,e._init)(e._payload)}function To(e){function t(t,n){if(e){var i=t.deletions;null===i?(t.deletions=[n],t.flags|=16):i.push(n)}}function n(n,i){if(!e)return null;for(;null!==i;)t(n,i),i=i.sibling;return null}function i(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function r(e,t){return(e=kl(e,t)).index=0,e.sibling=null,e}function s(t,n,i){return t.index=i,e?null!==(i=t.alternate)?(i=i.index)<n?(t.flags|=2,n):i:(t.flags|=2,n):(t.flags|=1048576,n)}function a(t){return e&&null===t.alternate&&(t.flags|=2),t}function c(e,t,n,i){return null===t||6!==t.tag?((t=xl(n,e.mode,i)).return=e,t):((t=r(t,n)).return=e,t)}function l(e,t,n,i){var o=n.type;return o===C?u(e,t,n.props.children,i,n.key):null!==t&&(t.elementType===o||"object"===typeof o&&null!==o&&o.$$typeof===P&&vo(o)===t.type)?((i=r(t,n.props)).ref=Eo(e,t,n),i.return=e,i):((i=Ll(n.type,n.key,n.props,null,e.mode,i)).ref=Eo(e,t,n),i.return=e,i)}function d(e,t,n,i){return null===t||4!==t.tag||t.stateNode.containerInfo!==n.containerInfo||t.stateNode.implementation!==n.implementation?((t=Vl(n,e.mode,i)).return=e,t):((t=r(t,n.children||[])).return=e,t)}function u(e,t,n,i,o){return null===t||7!==t.tag?((t=Ml(n,e.mode,i,o)).return=e,t):((t=r(t,n)).return=e,t)}function h(e,t,n){if("string"===typeof t&&""!==t||"number"===typeof t)return(t=xl(""+t,e.mode,n)).return=e,t;if("object"===typeof t&&null!==t){switch(t.$$typeof){case S:return(n=Ll(t.type,t.key,t.props,null,e.mode,n)).ref=Eo(e,null,t),n.return=e,n;case y:return(t=Vl(t,e.mode,n)).return=e,t;case P:return h(e,(0,t._init)(t._payload),n)}if(te(t)||M(t))return(t=Ml(t,e.mode,n,null)).return=e,t;go(e,t)}return null}function p(e,t,n,i){var r=null!==t?t.key:null;if("string"===typeof n&&""!==n||"number"===typeof n)return null!==r?null:c(e,t,""+n,i);if("object"===typeof n&&null!==n){switch(n.$$typeof){case S:return n.key===r?l(e,t,n,i):null;case y:return n.key===r?d(e,t,n,i):null;case P:return p(e,t,(r=n._init)(n._payload),i)}if(te(n)||M(n))return null!==r?null:u(e,t,n,i,null);go(e,n)}return null}function f(e,t,n,i,r){if("string"===typeof i&&""!==i||"number"===typeof i)return c(t,e=e.get(n)||null,""+i,r);if("object"===typeof i&&null!==i){switch(i.$$typeof){case S:return l(t,e=e.get(null===i.key?n:i.key)||null,i,r);case y:return d(t,e=e.get(null===i.key?n:i.key)||null,i,r);case P:return f(e,t,n,(0,i._init)(i._payload),r)}if(te(i)||M(i))return u(t,e=e.get(n)||null,i,r,null);go(t,i)}return null}function m(r,o,a,c){for(var l=null,d=null,u=o,m=o=0,_=null;null!==u&&m<a.length;m++){u.index>m?(_=u,u=null):_=u.sibling;var E=p(r,u,a[m],c);if(null===E){null===u&&(u=_);break}e&&u&&null===E.alternate&&t(r,u),o=s(E,o,m),null===d?l=E:d.sibling=E,d=E,u=_}if(m===a.length)return n(r,u),ro&&Zr(r,m),l;if(null===u){for(;m<a.length;m++)null!==(u=h(r,a[m],c))&&(o=s(u,o,m),null===d?l=u:d.sibling=u,d=u);return ro&&Zr(r,m),l}for(u=i(r,u);m<a.length;m++)null!==(_=f(u,r,m,a[m],c))&&(e&&null!==_.alternate&&u.delete(null===_.key?m:_.key),o=s(_,o,m),null===d?l=_:d.sibling=_,d=_);return e&&u.forEach((function(e){return t(r,e)})),ro&&Zr(r,m),l}function _(r,a,c,l){var d=M(c);if("function"!==typeof d)throw Error(o(150));if(null==(c=d.call(c)))throw Error(o(151));for(var u=d=null,m=a,_=a=0,E=null,g=c.next();null!==m&&!g.done;_++,g=c.next()){m.index>_?(E=m,m=null):E=m.sibling;var v=p(r,m,g.value,l);if(null===v){null===m&&(m=E);break}e&&m&&null===v.alternate&&t(r,m),a=s(v,a,_),null===u?d=v:u.sibling=v,u=v,m=E}if(g.done)return n(r,m),ro&&Zr(r,_),d;if(null===m){for(;!g.done;_++,g=c.next())null!==(g=h(r,g.value,l))&&(a=s(g,a,_),null===u?d=g:u.sibling=g,u=g);return ro&&Zr(r,_),d}for(m=i(r,m);!g.done;_++,g=c.next())null!==(g=f(m,r,_,g.value,l))&&(e&&null!==g.alternate&&m.delete(null===g.key?_:g.key),a=s(g,a,_),null===u?d=g:u.sibling=g,u=g);return e&&m.forEach((function(e){return t(r,e)})),ro&&Zr(r,_),d}return function e(i,o,s,c){if("object"===typeof s&&null!==s&&s.type===C&&null===s.key&&(s=s.props.children),"object"===typeof s&&null!==s){switch(s.$$typeof){case S:e:{for(var l=s.key,d=o;null!==d;){if(d.key===l){if((l=s.type)===C){if(7===d.tag){n(i,d.sibling),(o=r(d,s.props.children)).return=i,i=o;break e}}else if(d.elementType===l||"object"===typeof l&&null!==l&&l.$$typeof===P&&vo(l)===d.type){n(i,d.sibling),(o=r(d,s.props)).ref=Eo(i,d,s),o.return=i,i=o;break e}n(i,d);break}t(i,d),d=d.sibling}s.type===C?((o=Ml(s.props.children,i.mode,c,s.key)).return=i,i=o):((c=Ll(s.type,s.key,s.props,null,i.mode,c)).ref=Eo(i,o,s),c.return=i,i=c)}return a(i);case y:e:{for(d=s.key;null!==o;){if(o.key===d){if(4===o.tag&&o.stateNode.containerInfo===s.containerInfo&&o.stateNode.implementation===s.implementation){n(i,o.sibling),(o=r(o,s.children||[])).return=i,i=o;break e}n(i,o);break}t(i,o),o=o.sibling}(o=Vl(s,i.mode,c)).return=i,i=o}return a(i);case P:return e(i,o,(d=s._init)(s._payload),c)}if(te(s))return m(i,o,s,c);if(M(s))return _(i,o,s,c);go(i,s)}return"string"===typeof s&&""!==s||"number"===typeof s?(s=""+s,null!==o&&6===o.tag?(n(i,o.sibling),(o=r(o,s)).return=i,i=o):(n(i,o),(o=xl(s,i.mode,c)).return=i,i=o),a(i)):n(i,o)}}var So=To(!0),yo=To(!1),Co=Rr(null),Ro=null,wo=null,Io=null;function bo(){Io=wo=Ro=null}function Ao(e){var t=Co.current;wr(Co),e._currentValue=t}function Oo(e,t,n){for(;null!==e;){var i=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,null!==i&&(i.childLanes|=t)):null!==i&&(i.childLanes&t)!==t&&(i.childLanes|=t),e===n)break;e=e.return}}function No(e,t){Ro=e,Io=wo=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!==(e.lanes&t)&&(va=!0),e.firstContext=null)}function Do(e){var t=e._currentValue;if(Io!==e)if(e={context:e,memoizedValue:t,next:null},null===wo){if(null===Ro)throw Error(o(308));wo=e,Ro.dependencies={lanes:0,firstContext:e}}else wo=wo.next=e;return t}var Po=null;function ko(e){null===Po?Po=[e]:Po.push(e)}function Lo(e,t,n,i){var r=t.interleaved;return null===r?(n.next=n,ko(t)):(n.next=r.next,r.next=n),t.interleaved=n,Mo(e,i)}function Mo(e,t){e.lanes|=t;var n=e.alternate;for(null!==n&&(n.lanes|=t),n=e,e=e.return;null!==e;)e.childLanes|=t,null!==(n=e.alternate)&&(n.childLanes|=t),n=e,e=e.return;return 3===n.tag?n.stateNode:null}var Uo=!1;function xo(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Vo(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function Fo(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function jo(e,t,n){var i=e.updateQueue;if(null===i)return null;if(i=i.shared,0!==(2&Ac)){var r=i.pending;return null===r?t.next=t:(t.next=r.next,r.next=t),i.pending=t,Mo(e,n)}return null===(r=i.interleaved)?(t.next=t,ko(i)):(t.next=r.next,r.next=t),i.interleaved=t,Mo(e,n)}function Bo(e,t,n){if(null!==(t=t.updateQueue)&&(t=t.shared,0!==(4194240&n))){var i=t.lanes;n|=i&=e.pendingLanes,t.lanes=n,gt(e,n)}}function Go(e,t){var n=e.updateQueue,i=e.alternate;if(null!==i&&n===(i=i.updateQueue)){var r=null,o=null;if(null!==(n=n.firstBaseUpdate)){do{var s={eventTime:n.eventTime,lane:n.lane,tag:n.tag,payload:n.payload,callback:n.callback,next:null};null===o?r=o=s:o=o.next=s,n=n.next}while(null!==n);null===o?r=o=t:o=o.next=t}else r=o=t;return n={baseState:i.baseState,firstBaseUpdate:r,lastBaseUpdate:o,shared:i.shared,effects:i.effects},void(e.updateQueue=n)}null===(e=n.lastBaseUpdate)?n.firstBaseUpdate=t:e.next=t,n.lastBaseUpdate=t}function Wo(e,t,n,i){var r=e.updateQueue;Uo=!1;var o=r.firstBaseUpdate,s=r.lastBaseUpdate,a=r.shared.pending;if(null!==a){r.shared.pending=null;var c=a,l=c.next;c.next=null,null===s?o=l:s.next=l,s=c;var d=e.alternate;null!==d&&((a=(d=d.updateQueue).lastBaseUpdate)!==s&&(null===a?d.firstBaseUpdate=l:a.next=l,d.lastBaseUpdate=c))}if(null!==o){var u=r.baseState;for(s=0,d=l=c=null,a=o;;){var h=a.lane,p=a.eventTime;if((i&h)===h){null!==d&&(d=d.next={eventTime:p,lane:0,tag:a.tag,payload:a.payload,callback:a.callback,next:null});e:{var f=e,m=a;switch(h=t,p=n,m.tag){case 1:if("function"===typeof(f=m.payload)){u=f.call(p,u,h);break e}u=f;break e;case 3:f.flags=-65537&f.flags|128;case 0:if(null===(h="function"===typeof(f=m.payload)?f.call(p,u,h):f)||void 0===h)break e;u=x({},u,h);break e;case 2:Uo=!0}}null!==a.callback&&0!==a.lane&&(e.flags|=64,null===(h=r.effects)?r.effects=[a]:h.push(a))}else p={eventTime:p,lane:h,tag:a.tag,payload:a.payload,callback:a.callback,next:null},null===d?(l=d=p,c=u):d=d.next=p,s|=h;if(null===(a=a.next)){if(null===(a=r.shared.pending))break;a=(h=a).next,h.next=null,r.lastBaseUpdate=h,r.shared.pending=null}}if(null===d&&(c=u),r.baseState=c,r.firstBaseUpdate=l,r.lastBaseUpdate=d,null!==(t=r.shared.interleaved)){r=t;do{s|=r.lane,r=r.next}while(r!==t)}else null===o&&(r.shared.lanes=0);Uc|=s,e.lanes=s,e.memoizedState=u}}function Ho(e,t,n){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var i=e[t],r=i.callback;if(null!==r){if(i.callback=null,i=n,"function"!==typeof r)throw Error(o(191,r));r.call(i)}}}var Ko={},zo=Rr(Ko),qo=Rr(Ko),Yo=Rr(Ko);function Jo(e){if(e===Ko)throw Error(o(174));return e}function Xo(e,t){switch(Ir(Yo,t),Ir(qo,e),Ir(zo,Ko),e=t.nodeType){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:ce(null,"");break;default:t=ce(t=(e=8===e?t.parentNode:t).namespaceURI||null,e=e.tagName)}wr(zo),Ir(zo,t)}function Qo(){wr(zo),wr(qo),wr(Yo)}function Zo(e){Jo(Yo.current);var t=Jo(zo.current),n=ce(t,e.type);t!==n&&(Ir(qo,e),Ir(zo,n))}function $o(e){qo.current===e&&(wr(zo),wr(qo))}var es=Rr(0);function ts(e){for(var t=e;null!==t;){if(13===t.tag){var n=t.memoizedState;if(null!==n&&(null===(n=n.dehydrated)||"$?"===n.data||"$!"===n.data))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(0!==(128&t.flags))return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var ns=[];function is(){for(var e=0;e<ns.length;e++)ns[e]._workInProgressVersionPrimary=null;ns.length=0}var rs=T.ReactCurrentDispatcher,os=T.ReactCurrentBatchConfig,ss=0,as=null,cs=null,ls=null,ds=!1,us=!1,hs=0,ps=0;function fs(){throw Error(o(321))}function ms(e,t){if(null===t)return!1;for(var n=0;n<t.length&&n<e.length;n++)if(!ai(e[n],t[n]))return!1;return!0}function _s(e,t,n,i,r,s){if(ss=s,as=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,rs.current=null===e||null===e.memoizedState?$s:ea,e=n(i,r),us){s=0;do{if(us=!1,hs=0,25<=s)throw Error(o(301));s+=1,ls=cs=null,t.updateQueue=null,rs.current=ta,e=n(i,r)}while(us)}if(rs.current=Zs,t=null!==cs&&null!==cs.next,ss=0,ls=cs=as=null,ds=!1,t)throw Error(o(300));return e}function Es(){var e=0!==hs;return hs=0,e}function gs(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===ls?as.memoizedState=ls=e:ls=ls.next=e,ls}function vs(){if(null===cs){var e=as.alternate;e=null!==e?e.memoizedState:null}else e=cs.next;var t=null===ls?as.memoizedState:ls.next;if(null!==t)ls=t,cs=e;else{if(null===e)throw Error(o(310));e={memoizedState:(cs=e).memoizedState,baseState:cs.baseState,baseQueue:cs.baseQueue,queue:cs.queue,next:null},null===ls?as.memoizedState=ls=e:ls=ls.next=e}return ls}function Ts(e,t){return"function"===typeof t?t(e):t}function Ss(e){var t=vs(),n=t.queue;if(null===n)throw Error(o(311));n.lastRenderedReducer=e;var i=cs,r=i.baseQueue,s=n.pending;if(null!==s){if(null!==r){var a=r.next;r.next=s.next,s.next=a}i.baseQueue=r=s,n.pending=null}if(null!==r){s=r.next,i=i.baseState;var c=a=null,l=null,d=s;do{var u=d.lane;if((ss&u)===u)null!==l&&(l=l.next={lane:0,action:d.action,hasEagerState:d.hasEagerState,eagerState:d.eagerState,next:null}),i=d.hasEagerState?d.eagerState:e(i,d.action);else{var h={lane:u,action:d.action,hasEagerState:d.hasEagerState,eagerState:d.eagerState,next:null};null===l?(c=l=h,a=i):l=l.next=h,as.lanes|=u,Uc|=u}d=d.next}while(null!==d&&d!==s);null===l?a=i:l.next=c,ai(i,t.memoizedState)||(va=!0),t.memoizedState=i,t.baseState=a,t.baseQueue=l,n.lastRenderedState=i}if(null!==(e=n.interleaved)){r=e;do{s=r.lane,as.lanes|=s,Uc|=s,r=r.next}while(r!==e)}else null===r&&(n.lanes=0);return[t.memoizedState,n.dispatch]}function ys(e){var t=vs(),n=t.queue;if(null===n)throw Error(o(311));n.lastRenderedReducer=e;var i=n.dispatch,r=n.pending,s=t.memoizedState;if(null!==r){n.pending=null;var a=r=r.next;do{s=e(s,a.action),a=a.next}while(a!==r);ai(s,t.memoizedState)||(va=!0),t.memoizedState=s,null===t.baseQueue&&(t.baseState=s),n.lastRenderedState=s}return[s,i]}function Cs(){}function Rs(e,t){var n=as,i=vs(),r=t(),s=!ai(i.memoizedState,r);if(s&&(i.memoizedState=r,va=!0),i=i.queue,Us(bs.bind(null,n,i,e),[e]),i.getSnapshot!==t||s||null!==ls&&1&ls.memoizedState.tag){if(n.flags|=2048,Ds(9,Is.bind(null,n,i,r,t),void 0,null),null===Oc)throw Error(o(349));0!==(30&ss)||ws(n,t,r)}return r}function ws(e,t,n){e.flags|=16384,e={getSnapshot:t,value:n},null===(t=as.updateQueue)?(t={lastEffect:null,stores:null},as.updateQueue=t,t.stores=[e]):null===(n=t.stores)?t.stores=[e]:n.push(e)}function Is(e,t,n,i){t.value=n,t.getSnapshot=i,As(t)&&Os(e)}function bs(e,t,n){return n((function(){As(t)&&Os(e)}))}function As(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!ai(e,n)}catch(i){return!0}}function Os(e){var t=Mo(e,1);null!==t&&nl(t,e,1,-1)}function Ns(e){var t=gs();return"function"===typeof e&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Ts,lastRenderedState:e},t.queue=e,e=e.dispatch=Ys.bind(null,as,e),[t.memoizedState,e]}function Ds(e,t,n,i){return e={tag:e,create:t,destroy:n,deps:i,next:null},null===(t=as.updateQueue)?(t={lastEffect:null,stores:null},as.updateQueue=t,t.lastEffect=e.next=e):null===(n=t.lastEffect)?t.lastEffect=e.next=e:(i=n.next,n.next=e,e.next=i,t.lastEffect=e),e}function Ps(){return vs().memoizedState}function ks(e,t,n,i){var r=gs();as.flags|=e,r.memoizedState=Ds(1|t,n,void 0,void 0===i?null:i)}function Ls(e,t,n,i){var r=vs();i=void 0===i?null:i;var o=void 0;if(null!==cs){var s=cs.memoizedState;if(o=s.destroy,null!==i&&ms(i,s.deps))return void(r.memoizedState=Ds(t,n,o,i))}as.flags|=e,r.memoizedState=Ds(1|t,n,o,i)}function Ms(e,t){return ks(8390656,8,e,t)}function Us(e,t){return Ls(2048,8,e,t)}function xs(e,t){return Ls(4,2,e,t)}function Vs(e,t){return Ls(4,4,e,t)}function Fs(e,t){return"function"===typeof t?(e=e(),t(e),function(){t(null)}):null!==t&&void 0!==t?(e=e(),t.current=e,function(){t.current=null}):void 0}function js(e,t,n){return n=null!==n&&void 0!==n?n.concat([e]):null,Ls(4,4,Fs.bind(null,t,e),n)}function Bs(){}function Gs(e,t){var n=vs();t=void 0===t?null:t;var i=n.memoizedState;return null!==i&&null!==t&&ms(t,i[1])?i[0]:(n.memoizedState=[e,t],e)}function Ws(e,t){var n=vs();t=void 0===t?null:t;var i=n.memoizedState;return null!==i&&null!==t&&ms(t,i[1])?i[0]:(e=e(),n.memoizedState=[e,t],e)}function Hs(e,t,n){return 0===(21&ss)?(e.baseState&&(e.baseState=!1,va=!0),e.memoizedState=n):(ai(n,t)||(n=mt(),as.lanes|=n,Uc|=n,e.baseState=!0),t)}function Ks(e,t){var n=vt;vt=0!==n&&4>n?n:4,e(!0);var i=os.transition;os.transition={};try{e(!1),t()}finally{vt=n,os.transition=i}}function zs(){return vs().memoizedState}function qs(e,t,n){var i=tl(e);if(n={lane:i,action:n,hasEagerState:!1,eagerState:null,next:null},Js(e))Xs(t,n);else if(null!==(n=Lo(e,t,n,i))){nl(n,e,i,el()),Qs(n,t,i)}}function Ys(e,t,n){var i=tl(e),r={lane:i,action:n,hasEagerState:!1,eagerState:null,next:null};if(Js(e))Xs(t,r);else{var o=e.alternate;if(0===e.lanes&&(null===o||0===o.lanes)&&null!==(o=t.lastRenderedReducer))try{var s=t.lastRenderedState,a=o(s,n);if(r.hasEagerState=!0,r.eagerState=a,ai(a,s)){var c=t.interleaved;return null===c?(r.next=r,ko(t)):(r.next=c.next,c.next=r),void(t.interleaved=r)}}catch(l){}null!==(n=Lo(e,t,r,i))&&(nl(n,e,i,r=el()),Qs(n,t,i))}}function Js(e){var t=e.alternate;return e===as||null!==t&&t===as}function Xs(e,t){us=ds=!0;var n=e.pending;null===n?t.next=t:(t.next=n.next,n.next=t),e.pending=t}function Qs(e,t,n){if(0!==(4194240&n)){var i=t.lanes;n|=i&=e.pendingLanes,t.lanes=n,gt(e,n)}}var Zs={readContext:Do,useCallback:fs,useContext:fs,useEffect:fs,useImperativeHandle:fs,useInsertionEffect:fs,useLayoutEffect:fs,useMemo:fs,useReducer:fs,useRef:fs,useState:fs,useDebugValue:fs,useDeferredValue:fs,useTransition:fs,useMutableSource:fs,useSyncExternalStore:fs,useId:fs,unstable_isNewReconciler:!1},$s={readContext:Do,useCallback:function(e,t){return gs().memoizedState=[e,void 0===t?null:t],e},useContext:Do,useEffect:Ms,useImperativeHandle:function(e,t,n){return n=null!==n&&void 0!==n?n.concat([e]):null,ks(4194308,4,Fs.bind(null,t,e),n)},useLayoutEffect:function(e,t){return ks(4194308,4,e,t)},useInsertionEffect:function(e,t){return ks(4,2,e,t)},useMemo:function(e,t){var n=gs();return t=void 0===t?null:t,e=e(),n.memoizedState=[e,t],e},useReducer:function(e,t,n){var i=gs();return t=void 0!==n?n(t):t,i.memoizedState=i.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},i.queue=e,e=e.dispatch=qs.bind(null,as,e),[i.memoizedState,e]},useRef:function(e){return e={current:e},gs().memoizedState=e},useState:Ns,useDebugValue:Bs,useDeferredValue:function(e){return gs().memoizedState=e},useTransition:function(){var e=Ns(!1),t=e[0];return e=Ks.bind(null,e[1]),gs().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,n){var i=as,r=gs();if(ro){if(void 0===n)throw Error(o(407));n=n()}else{if(n=t(),null===Oc)throw Error(o(349));0!==(30&ss)||ws(i,t,n)}r.memoizedState=n;var s={value:n,getSnapshot:t};return r.queue=s,Ms(bs.bind(null,i,s,e),[e]),i.flags|=2048,Ds(9,Is.bind(null,i,s,n,t),void 0,null),n},useId:function(){var e=gs(),t=Oc.identifierPrefix;if(ro){var n=Qr;t=":"+t+"R"+(n=(Xr&~(1<<32-st(Xr)-1)).toString(32)+n),0<(n=hs++)&&(t+="H"+n.toString(32)),t+=":"}else t=":"+t+"r"+(n=ps++).toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},ea={readContext:Do,useCallback:Gs,useContext:Do,useEffect:Us,useImperativeHandle:js,useInsertionEffect:xs,useLayoutEffect:Vs,useMemo:Ws,useReducer:Ss,useRef:Ps,useState:function(){return Ss(Ts)},useDebugValue:Bs,useDeferredValue:function(e){return Hs(vs(),cs.memoizedState,e)},useTransition:function(){return[Ss(Ts)[0],vs().memoizedState]},useMutableSource:Cs,useSyncExternalStore:Rs,useId:zs,unstable_isNewReconciler:!1},ta={readContext:Do,useCallback:Gs,useContext:Do,useEffect:Us,useImperativeHandle:js,useInsertionEffect:xs,useLayoutEffect:Vs,useMemo:Ws,useReducer:ys,useRef:Ps,useState:function(){return ys(Ts)},useDebugValue:Bs,useDeferredValue:function(e){var t=vs();return null===cs?t.memoizedState=e:Hs(t,cs.memoizedState,e)},useTransition:function(){return[ys(Ts)[0],vs().memoizedState]},useMutableSource:Cs,useSyncExternalStore:Rs,useId:zs,unstable_isNewReconciler:!1};function na(e,t){if(e&&e.defaultProps){for(var n in t=x({},t),e=e.defaultProps)void 0===t[n]&&(t[n]=e[n]);return t}return t}function ia(e,t,n,i){n=null===(n=n(i,t=e.memoizedState))||void 0===n?t:x({},t,n),e.memoizedState=n,0===e.lanes&&(e.updateQueue.baseState=n)}var ra={isMounted:function(e){return!!(e=e._reactInternals)&&Ge(e)===e},enqueueSetState:function(e,t,n){e=e._reactInternals;var i=el(),r=tl(e),o=Fo(i,r);o.payload=t,void 0!==n&&null!==n&&(o.callback=n),null!==(t=jo(e,o,r))&&(nl(t,e,r,i),Bo(t,e,r))},enqueueReplaceState:function(e,t,n){e=e._reactInternals;var i=el(),r=tl(e),o=Fo(i,r);o.tag=1,o.payload=t,void 0!==n&&null!==n&&(o.callback=n),null!==(t=jo(e,o,r))&&(nl(t,e,r,i),Bo(t,e,r))},enqueueForceUpdate:function(e,t){e=e._reactInternals;var n=el(),i=tl(e),r=Fo(n,i);r.tag=2,void 0!==t&&null!==t&&(r.callback=t),null!==(t=jo(e,r,i))&&(nl(t,e,i,n),Bo(t,e,i))}};function oa(e,t,n,i,r,o,s){return"function"===typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(i,o,s):!t.prototype||!t.prototype.isPureReactComponent||(!ci(n,i)||!ci(r,o))}function sa(e,t,n){var i=!1,r=br,o=t.contextType;return"object"===typeof o&&null!==o?o=Do(o):(r=Pr(t)?Nr:Ar.current,o=(i=null!==(i=t.contextTypes)&&void 0!==i)?Dr(e,r):br),t=new t(n,o),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=ra,e.stateNode=t,t._reactInternals=e,i&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=r,e.__reactInternalMemoizedMaskedChildContext=o),t}function aa(e,t,n,i){e=t.state,"function"===typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(n,i),"function"===typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(n,i),t.state!==e&&ra.enqueueReplaceState(t,t.state,null)}function ca(e,t,n,i){var r=e.stateNode;r.props=n,r.state=e.memoizedState,r.refs={},xo(e);var o=t.contextType;"object"===typeof o&&null!==o?r.context=Do(o):(o=Pr(t)?Nr:Ar.current,r.context=Dr(e,o)),r.state=e.memoizedState,"function"===typeof(o=t.getDerivedStateFromProps)&&(ia(e,t,o,n),r.state=e.memoizedState),"function"===typeof t.getDerivedStateFromProps||"function"===typeof r.getSnapshotBeforeUpdate||"function"!==typeof r.UNSAFE_componentWillMount&&"function"!==typeof r.componentWillMount||(t=r.state,"function"===typeof r.componentWillMount&&r.componentWillMount(),"function"===typeof r.UNSAFE_componentWillMount&&r.UNSAFE_componentWillMount(),t!==r.state&&ra.enqueueReplaceState(r,r.state,null),Wo(e,n,r,i),r.state=e.memoizedState),"function"===typeof r.componentDidMount&&(e.flags|=4194308)}function la(e,t){try{var n="",i=t;do{n+=B(i),i=i.return}while(i);var r=n}catch(o){r="\nError generating stack: "+o.message+"\n"+o.stack}return{value:e,source:t,stack:r,digest:null}}function da(e,t,n){return{value:e,source:null,stack:null!=n?n:null,digest:null!=t?t:null}}function ua(e,t){try{console.error(t.value)}catch(n){setTimeout((function(){throw n}))}}var ha="function"===typeof WeakMap?WeakMap:Map;function pa(e,t,n){(n=Fo(-1,n)).tag=3,n.payload={element:null};var i=t.value;return n.callback=function(){Hc||(Hc=!0,Kc=i),ua(0,t)},n}function fa(e,t,n){(n=Fo(-1,n)).tag=3;var i=e.type.getDerivedStateFromError;if("function"===typeof i){var r=t.value;n.payload=function(){return i(r)},n.callback=function(){ua(0,t)}}var o=e.stateNode;return null!==o&&"function"===typeof o.componentDidCatch&&(n.callback=function(){ua(0,t),"function"!==typeof i&&(null===zc?zc=new Set([this]):zc.add(this));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),n}function ma(e,t,n){var i=e.pingCache;if(null===i){i=e.pingCache=new ha;var r=new Set;i.set(t,r)}else void 0===(r=i.get(t))&&(r=new Set,i.set(t,r));r.has(n)||(r.add(n),e=wl.bind(null,e,t,n),t.then(e,e))}function _a(e){do{var t;if((t=13===e.tag)&&(t=null===(t=e.memoizedState)||null!==t.dehydrated),t)return e;e=e.return}while(null!==e);return null}function Ea(e,t,n,i,r){return 0===(1&e.mode)?(e===t?e.flags|=65536:(e.flags|=128,n.flags|=131072,n.flags&=-52805,1===n.tag&&(null===n.alternate?n.tag=17:((t=Fo(-1,1)).tag=2,jo(n,t,1))),n.lanes|=1),e):(e.flags|=65536,e.lanes=r,e)}var ga=T.ReactCurrentOwner,va=!1;function Ta(e,t,n,i){t.child=null===e?yo(t,null,n,i):So(t,e.child,n,i)}function Sa(e,t,n,i,r){n=n.render;var o=t.ref;return No(t,r),i=_s(e,t,n,i,o,r),n=Es(),null===e||va?(ro&&n&&eo(t),t.flags|=1,Ta(e,t,i,r),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,Ha(e,t,r))}function ya(e,t,n,i,r){if(null===e){var o=n.type;return"function"!==typeof o||Pl(o)||void 0!==o.defaultProps||null!==n.compare||void 0!==n.defaultProps?((e=Ll(n.type,null,i,t,t.mode,r)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=o,Ca(e,t,o,i,r))}if(o=e.child,0===(e.lanes&r)){var s=o.memoizedProps;if((n=null!==(n=n.compare)?n:ci)(s,i)&&e.ref===t.ref)return Ha(e,t,r)}return t.flags|=1,(e=kl(o,i)).ref=t.ref,e.return=t,t.child=e}function Ca(e,t,n,i,r){if(null!==e){var o=e.memoizedProps;if(ci(o,i)&&e.ref===t.ref){if(va=!1,t.pendingProps=i=o,0===(e.lanes&r))return t.lanes=e.lanes,Ha(e,t,r);0!==(131072&e.flags)&&(va=!0)}}return Ia(e,t,n,i,r)}function Ra(e,t,n){var i=t.pendingProps,r=i.children,o=null!==e?e.memoizedState:null;if("hidden"===i.mode)if(0===(1&t.mode))t.memoizedState={baseLanes:0,cachePool:null,transitions:null},Ir(kc,Pc),Pc|=n;else{if(0===(1073741824&n))return e=null!==o?o.baseLanes|n:n,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null,transitions:null},t.updateQueue=null,Ir(kc,Pc),Pc|=e,null;t.memoizedState={baseLanes:0,cachePool:null,transitions:null},i=null!==o?o.baseLanes:n,Ir(kc,Pc),Pc|=i}else null!==o?(i=o.baseLanes|n,t.memoizedState=null):i=n,Ir(kc,Pc),Pc|=i;return Ta(e,t,r,n),t.child}function wa(e,t){var n=t.ref;(null===e&&null!==n||null!==e&&e.ref!==n)&&(t.flags|=512,t.flags|=2097152)}function Ia(e,t,n,i,r){var o=Pr(n)?Nr:Ar.current;return o=Dr(t,o),No(t,r),n=_s(e,t,n,i,o,r),i=Es(),null===e||va?(ro&&i&&eo(t),t.flags|=1,Ta(e,t,n,r),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,Ha(e,t,r))}function ba(e,t,n,i,r){if(Pr(n)){var o=!0;Ur(t)}else o=!1;if(No(t,r),null===t.stateNode)Wa(e,t),sa(t,n,i),ca(t,n,i,r),i=!0;else if(null===e){var s=t.stateNode,a=t.memoizedProps;s.props=a;var c=s.context,l=n.contextType;"object"===typeof l&&null!==l?l=Do(l):l=Dr(t,l=Pr(n)?Nr:Ar.current);var d=n.getDerivedStateFromProps,u="function"===typeof d||"function"===typeof s.getSnapshotBeforeUpdate;u||"function"!==typeof s.UNSAFE_componentWillReceiveProps&&"function"!==typeof s.componentWillReceiveProps||(a!==i||c!==l)&&aa(t,s,i,l),Uo=!1;var h=t.memoizedState;s.state=h,Wo(t,i,s,r),c=t.memoizedState,a!==i||h!==c||Or.current||Uo?("function"===typeof d&&(ia(t,n,d,i),c=t.memoizedState),(a=Uo||oa(t,n,a,i,h,c,l))?(u||"function"!==typeof s.UNSAFE_componentWillMount&&"function"!==typeof s.componentWillMount||("function"===typeof s.componentWillMount&&s.componentWillMount(),"function"===typeof s.UNSAFE_componentWillMount&&s.UNSAFE_componentWillMount()),"function"===typeof s.componentDidMount&&(t.flags|=4194308)):("function"===typeof s.componentDidMount&&(t.flags|=4194308),t.memoizedProps=i,t.memoizedState=c),s.props=i,s.state=c,s.context=l,i=a):("function"===typeof s.componentDidMount&&(t.flags|=4194308),i=!1)}else{s=t.stateNode,Vo(e,t),a=t.memoizedProps,l=t.type===t.elementType?a:na(t.type,a),s.props=l,u=t.pendingProps,h=s.context,"object"===typeof(c=n.contextType)&&null!==c?c=Do(c):c=Dr(t,c=Pr(n)?Nr:Ar.current);var p=n.getDerivedStateFromProps;(d="function"===typeof p||"function"===typeof s.getSnapshotBeforeUpdate)||"function"!==typeof s.UNSAFE_componentWillReceiveProps&&"function"!==typeof s.componentWillReceiveProps||(a!==u||h!==c)&&aa(t,s,i,c),Uo=!1,h=t.memoizedState,s.state=h,Wo(t,i,s,r);var f=t.memoizedState;a!==u||h!==f||Or.current||Uo?("function"===typeof p&&(ia(t,n,p,i),f=t.memoizedState),(l=Uo||oa(t,n,l,i,h,f,c)||!1)?(d||"function"!==typeof s.UNSAFE_componentWillUpdate&&"function"!==typeof s.componentWillUpdate||("function"===typeof s.componentWillUpdate&&s.componentWillUpdate(i,f,c),"function"===typeof s.UNSAFE_componentWillUpdate&&s.UNSAFE_componentWillUpdate(i,f,c)),"function"===typeof s.componentDidUpdate&&(t.flags|=4),"function"===typeof s.getSnapshotBeforeUpdate&&(t.flags|=1024)):("function"!==typeof s.componentDidUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!==typeof s.getSnapshotBeforeUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),t.memoizedProps=i,t.memoizedState=f),s.props=i,s.state=f,s.context=c,i=l):("function"!==typeof s.componentDidUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),"function"!==typeof s.getSnapshotBeforeUpdate||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),i=!1)}return Aa(e,t,n,i,o,r)}function Aa(e,t,n,i,r,o){wa(e,t);var s=0!==(128&t.flags);if(!i&&!s)return r&&xr(t,n,!1),Ha(e,t,o);i=t.stateNode,ga.current=t;var a=s&&"function"!==typeof n.getDerivedStateFromError?null:i.render();return t.flags|=1,null!==e&&s?(t.child=So(t,e.child,null,o),t.child=So(t,null,a,o)):Ta(e,t,a,o),t.memoizedState=i.state,r&&xr(t,n,!0),t.child}function Oa(e){var t=e.stateNode;t.pendingContext?Lr(0,t.pendingContext,t.pendingContext!==t.context):t.context&&Lr(0,t.context,!1),Xo(e,t.containerInfo)}function Na(e,t,n,i,r){return fo(),mo(r),t.flags|=256,Ta(e,t,n,i),t.child}var Da,Pa,ka,La,Ma={dehydrated:null,treeContext:null,retryLane:0};function Ua(e){return{baseLanes:e,cachePool:null,transitions:null}}function xa(e,t,n){var i,r=t.pendingProps,s=es.current,a=!1,c=0!==(128&t.flags);if((i=c)||(i=(null===e||null!==e.memoizedState)&&0!==(2&s)),i?(a=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(s|=1),Ir(es,1&s),null===e)return lo(t),null!==(e=t.memoizedState)&&null!==(e=e.dehydrated)?(0===(1&t.mode)?t.lanes=1:"$!"===e.data?t.lanes=8:t.lanes=1073741824,null):(c=r.children,e=r.fallback,a?(r=t.mode,a=t.child,c={mode:"hidden",children:c},0===(1&r)&&null!==a?(a.childLanes=0,a.pendingProps=c):a=Ul(c,r,0,null),e=Ml(e,r,n,null),a.return=t,e.return=t,a.sibling=e,t.child=a,t.child.memoizedState=Ua(n),t.memoizedState=Ma,e):Va(t,c));if(null!==(s=e.memoizedState)&&null!==(i=s.dehydrated))return function(e,t,n,i,r,s,a){if(n)return 256&t.flags?(t.flags&=-257,Fa(e,t,a,i=da(Error(o(422))))):null!==t.memoizedState?(t.child=e.child,t.flags|=128,null):(s=i.fallback,r=t.mode,i=Ul({mode:"visible",children:i.children},r,0,null),(s=Ml(s,r,a,null)).flags|=2,i.return=t,s.return=t,i.sibling=s,t.child=i,0!==(1&t.mode)&&So(t,e.child,null,a),t.child.memoizedState=Ua(a),t.memoizedState=Ma,s);if(0===(1&t.mode))return Fa(e,t,a,null);if("$!"===r.data){if(i=r.nextSibling&&r.nextSibling.dataset)var c=i.dgst;return i=c,Fa(e,t,a,i=da(s=Error(o(419)),i,void 0))}if(c=0!==(a&e.childLanes),va||c){if(null!==(i=Oc)){switch(a&-a){case 4:r=2;break;case 16:r=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:r=32;break;case 536870912:r=268435456;break;default:r=0}0!==(r=0!==(r&(i.suspendedLanes|a))?0:r)&&r!==s.retryLane&&(s.retryLane=r,Mo(e,r),nl(i,e,r,-1))}return ml(),Fa(e,t,a,i=da(Error(o(421))))}return"$?"===r.data?(t.flags|=128,t.child=e.child,t=bl.bind(null,e),r._reactRetry=t,null):(e=s.treeContext,io=lr(r.nextSibling),no=t,ro=!0,oo=null,null!==e&&(qr[Yr++]=Xr,qr[Yr++]=Qr,qr[Yr++]=Jr,Xr=e.id,Qr=e.overflow,Jr=t),t=Va(t,i.children),t.flags|=4096,t)}(e,t,c,r,i,s,n);if(a){a=r.fallback,c=t.mode,i=(s=e.child).sibling;var l={mode:"hidden",children:r.children};return 0===(1&c)&&t.child!==s?((r=t.child).childLanes=0,r.pendingProps=l,t.deletions=null):(r=kl(s,l)).subtreeFlags=14680064&s.subtreeFlags,null!==i?a=kl(i,a):(a=Ml(a,c,n,null)).flags|=2,a.return=t,r.return=t,r.sibling=a,t.child=r,r=a,a=t.child,c=null===(c=e.child.memoizedState)?Ua(n):{baseLanes:c.baseLanes|n,cachePool:null,transitions:c.transitions},a.memoizedState=c,a.childLanes=e.childLanes&~n,t.memoizedState=Ma,r}return e=(a=e.child).sibling,r=kl(a,{mode:"visible",children:r.children}),0===(1&t.mode)&&(r.lanes=n),r.return=t,r.sibling=null,null!==e&&(null===(n=t.deletions)?(t.deletions=[e],t.flags|=16):n.push(e)),t.child=r,t.memoizedState=null,r}function Va(e,t){return(t=Ul({mode:"visible",children:t},e.mode,0,null)).return=e,e.child=t}function Fa(e,t,n,i){return null!==i&&mo(i),So(t,e.child,null,n),(e=Va(t,t.pendingProps.children)).flags|=2,t.memoizedState=null,e}function ja(e,t,n){e.lanes|=t;var i=e.alternate;null!==i&&(i.lanes|=t),Oo(e.return,t,n)}function Ba(e,t,n,i,r){var o=e.memoizedState;null===o?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:i,tail:n,tailMode:r}:(o.isBackwards=t,o.rendering=null,o.renderingStartTime=0,o.last=i,o.tail=n,o.tailMode=r)}function Ga(e,t,n){var i=t.pendingProps,r=i.revealOrder,o=i.tail;if(Ta(e,t,i.children,n),0!==(2&(i=es.current)))i=1&i|2,t.flags|=128;else{if(null!==e&&0!==(128&e.flags))e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&ja(e,n,t);else if(19===e.tag)ja(e,n,t);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}i&=1}if(Ir(es,i),0===(1&t.mode))t.memoizedState=null;else switch(r){case"forwards":for(n=t.child,r=null;null!==n;)null!==(e=n.alternate)&&null===ts(e)&&(r=n),n=n.sibling;null===(n=r)?(r=t.child,t.child=null):(r=n.sibling,n.sibling=null),Ba(t,!1,r,n,o);break;case"backwards":for(n=null,r=t.child,t.child=null;null!==r;){if(null!==(e=r.alternate)&&null===ts(e)){t.child=r;break}e=r.sibling,r.sibling=n,n=r,r=e}Ba(t,!0,n,null,o);break;case"together":Ba(t,!1,null,null,void 0);break;default:t.memoizedState=null}return t.child}function Wa(e,t){0===(1&t.mode)&&null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2)}function Ha(e,t,n){if(null!==e&&(t.dependencies=e.dependencies),Uc|=t.lanes,0===(n&t.childLanes))return null;if(null!==e&&t.child!==e.child)throw Error(o(153));if(null!==t.child){for(n=kl(e=t.child,e.pendingProps),t.child=n,n.return=t;null!==e.sibling;)e=e.sibling,(n=n.sibling=kl(e,e.pendingProps)).return=t;n.sibling=null}return t.child}function Ka(e,t){if(!ro)switch(e.tailMode){case"hidden":t=e.tail;for(var n=null;null!==t;)null!==t.alternate&&(n=t),t=t.sibling;null===n?e.tail=null:n.sibling=null;break;case"collapsed":n=e.tail;for(var i=null;null!==n;)null!==n.alternate&&(i=n),n=n.sibling;null===i?t||null===e.tail?e.tail=null:e.tail.sibling=null:i.sibling=null}}function za(e){var t=null!==e.alternate&&e.alternate.child===e.child,n=0,i=0;if(t)for(var r=e.child;null!==r;)n|=r.lanes|r.childLanes,i|=14680064&r.subtreeFlags,i|=14680064&r.flags,r.return=e,r=r.sibling;else for(r=e.child;null!==r;)n|=r.lanes|r.childLanes,i|=r.subtreeFlags,i|=r.flags,r.return=e,r=r.sibling;return e.subtreeFlags|=i,e.childLanes=n,t}function qa(e,t,n){var i=t.pendingProps;switch(to(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return za(t),null;case 1:case 17:return Pr(t.type)&&kr(),za(t),null;case 3:return i=t.stateNode,Qo(),wr(Or),wr(Ar),is(),i.pendingContext&&(i.context=i.pendingContext,i.pendingContext=null),null!==e&&null!==e.child||(ho(t)?t.flags|=4:null===e||e.memoizedState.isDehydrated&&0===(256&t.flags)||(t.flags|=1024,null!==oo&&(sl(oo),oo=null))),Pa(e,t),za(t),null;case 5:$o(t);var r=Jo(Yo.current);if(n=t.type,null!==e&&null!=t.stateNode)ka(e,t,n,i,r),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!i){if(null===t.stateNode)throw Error(o(166));return za(t),null}if(e=Jo(zo.current),ho(t)){i=t.stateNode,n=t.type;var s=t.memoizedProps;switch(i[hr]=t,i[pr]=s,e=0!==(1&t.mode),n){case"dialog":Fi("cancel",i),Fi("close",i);break;case"iframe":case"object":case"embed":Fi("load",i);break;case"video":case"audio":for(r=0;r<Mi.length;r++)Fi(Mi[r],i);break;case"source":Fi("error",i);break;case"img":case"image":case"link":Fi("error",i),Fi("load",i);break;case"details":Fi("toggle",i);break;case"input":X(i,s),Fi("invalid",i);break;case"select":i._wrapperState={wasMultiple:!!s.multiple},Fi("invalid",i);break;case"textarea":re(i,s),Fi("invalid",i)}for(var c in ge(n,s),r=null,s)if(s.hasOwnProperty(c)){var l=s[c];"children"===c?"string"===typeof l?i.textContent!==l&&(!0!==s.suppressHydrationWarning&&Zi(i.textContent,l,e),r=["children",l]):"number"===typeof l&&i.textContent!==""+l&&(!0!==s.suppressHydrationWarning&&Zi(i.textContent,l,e),r=["children",""+l]):a.hasOwnProperty(c)&&null!=l&&"onScroll"===c&&Fi("scroll",i)}switch(n){case"input":z(i),$(i,s,!0);break;case"textarea":z(i),se(i);break;case"select":case"option":break;default:"function"===typeof s.onClick&&(i.onclick=$i)}i=r,t.updateQueue=i,null!==i&&(t.flags|=4)}else{c=9===r.nodeType?r:r.ownerDocument,"http://www.w3.org/1999/xhtml"===e&&(e=ae(n)),"http://www.w3.org/1999/xhtml"===e?"script"===n?((e=c.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"===typeof i.is?e=c.createElement(n,{is:i.is}):(e=c.createElement(n),"select"===n&&(c=e,i.multiple?c.multiple=!0:i.size&&(c.size=i.size))):e=c.createElementNS(e,n),e[hr]=t,e[pr]=i,Da(e,t,!1,!1),t.stateNode=e;e:{switch(c=ve(n,i),n){case"dialog":Fi("cancel",e),Fi("close",e),r=i;break;case"iframe":case"object":case"embed":Fi("load",e),r=i;break;case"video":case"audio":for(r=0;r<Mi.length;r++)Fi(Mi[r],e);r=i;break;case"source":Fi("error",e),r=i;break;case"img":case"image":case"link":Fi("error",e),Fi("load",e),r=i;break;case"details":Fi("toggle",e),r=i;break;case"input":X(e,i),r=J(e,i),Fi("invalid",e);break;case"option":default:r=i;break;case"select":e._wrapperState={wasMultiple:!!i.multiple},r=x({},i,{value:void 0}),Fi("invalid",e);break;case"textarea":re(e,i),r=ie(e,i),Fi("invalid",e)}for(s in ge(n,r),l=r)if(l.hasOwnProperty(s)){var d=l[s];"style"===s?_e(e,d):"dangerouslySetInnerHTML"===s?null!=(d=d?d.__html:void 0)&&ue(e,d):"children"===s?"string"===typeof d?("textarea"!==n||""!==d)&&he(e,d):"number"===typeof d&&he(e,""+d):"suppressContentEditableWarning"!==s&&"suppressHydrationWarning"!==s&&"autoFocus"!==s&&(a.hasOwnProperty(s)?null!=d&&"onScroll"===s&&Fi("scroll",e):null!=d&&v(e,s,d,c))}switch(n){case"input":z(e),$(e,i,!1);break;case"textarea":z(e),se(e);break;case"option":null!=i.value&&e.setAttribute("value",""+H(i.value));break;case"select":e.multiple=!!i.multiple,null!=(s=i.value)?ne(e,!!i.multiple,s,!1):null!=i.defaultValue&&ne(e,!!i.multiple,i.defaultValue,!0);break;default:"function"===typeof r.onClick&&(e.onclick=$i)}switch(n){case"button":case"input":case"select":case"textarea":i=!!i.autoFocus;break e;case"img":i=!0;break e;default:i=!1}}i&&(t.flags|=4)}null!==t.ref&&(t.flags|=512,t.flags|=2097152)}return za(t),null;case 6:if(e&&null!=t.stateNode)La(e,t,e.memoizedProps,i);else{if("string"!==typeof i&&null===t.stateNode)throw Error(o(166));if(n=Jo(Yo.current),Jo(zo.current),ho(t)){if(i=t.stateNode,n=t.memoizedProps,i[hr]=t,(s=i.nodeValue!==n)&&null!==(e=no))switch(e.tag){case 3:Zi(i.nodeValue,n,0!==(1&e.mode));break;case 5:!0!==e.memoizedProps.suppressHydrationWarning&&Zi(i.nodeValue,n,0!==(1&e.mode))}s&&(t.flags|=4)}else(i=(9===n.nodeType?n:n.ownerDocument).createTextNode(i))[hr]=t,t.stateNode=i}return za(t),null;case 13:if(wr(es),i=t.memoizedState,null===e||null!==e.memoizedState&&null!==e.memoizedState.dehydrated){if(ro&&null!==io&&0!==(1&t.mode)&&0===(128&t.flags))po(),fo(),t.flags|=98560,s=!1;else if(s=ho(t),null!==i&&null!==i.dehydrated){if(null===e){if(!s)throw Error(o(318));if(!(s=null!==(s=t.memoizedState)?s.dehydrated:null))throw Error(o(317));s[hr]=t}else fo(),0===(128&t.flags)&&(t.memoizedState=null),t.flags|=4;za(t),s=!1}else null!==oo&&(sl(oo),oo=null),s=!0;if(!s)return 65536&t.flags?t:null}return 0!==(128&t.flags)?(t.lanes=n,t):((i=null!==i)!==(null!==e&&null!==e.memoizedState)&&i&&(t.child.flags|=8192,0!==(1&t.mode)&&(null===e||0!==(1&es.current)?0===Lc&&(Lc=3):ml())),null!==t.updateQueue&&(t.flags|=4),za(t),null);case 4:return Qo(),Pa(e,t),null===e&&Gi(t.stateNode.containerInfo),za(t),null;case 10:return Ao(t.type._context),za(t),null;case 19:if(wr(es),null===(s=t.memoizedState))return za(t),null;if(i=0!==(128&t.flags),null===(c=s.rendering))if(i)Ka(s,!1);else{if(0!==Lc||null!==e&&0!==(128&e.flags))for(e=t.child;null!==e;){if(null!==(c=ts(e))){for(t.flags|=128,Ka(s,!1),null!==(i=c.updateQueue)&&(t.updateQueue=i,t.flags|=4),t.subtreeFlags=0,i=n,n=t.child;null!==n;)e=i,(s=n).flags&=14680066,null===(c=s.alternate)?(s.childLanes=0,s.lanes=e,s.child=null,s.subtreeFlags=0,s.memoizedProps=null,s.memoizedState=null,s.updateQueue=null,s.dependencies=null,s.stateNode=null):(s.childLanes=c.childLanes,s.lanes=c.lanes,s.child=c.child,s.subtreeFlags=0,s.deletions=null,s.memoizedProps=c.memoizedProps,s.memoizedState=c.memoizedState,s.updateQueue=c.updateQueue,s.type=c.type,e=c.dependencies,s.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),n=n.sibling;return Ir(es,1&es.current|2),t.child}e=e.sibling}null!==s.tail&&Qe()>Gc&&(t.flags|=128,i=!0,Ka(s,!1),t.lanes=4194304)}else{if(!i)if(null!==(e=ts(c))){if(t.flags|=128,i=!0,null!==(n=e.updateQueue)&&(t.updateQueue=n,t.flags|=4),Ka(s,!0),null===s.tail&&"hidden"===s.tailMode&&!c.alternate&&!ro)return za(t),null}else 2*Qe()-s.renderingStartTime>Gc&&1073741824!==n&&(t.flags|=128,i=!0,Ka(s,!1),t.lanes=4194304);s.isBackwards?(c.sibling=t.child,t.child=c):(null!==(n=s.last)?n.sibling=c:t.child=c,s.last=c)}return null!==s.tail?(t=s.tail,s.rendering=t,s.tail=t.sibling,s.renderingStartTime=Qe(),t.sibling=null,n=es.current,Ir(es,i?1&n|2:1&n),t):(za(t),null);case 22:case 23:return ul(),i=null!==t.memoizedState,null!==e&&null!==e.memoizedState!==i&&(t.flags|=8192),i&&0!==(1&t.mode)?0!==(1073741824&Pc)&&(za(t),6&t.subtreeFlags&&(t.flags|=8192)):za(t),null;case 24:case 25:return null}throw Error(o(156,t.tag))}function Ya(e,t){switch(to(t),t.tag){case 1:return Pr(t.type)&&kr(),65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 3:return Qo(),wr(Or),wr(Ar),is(),0!==(65536&(e=t.flags))&&0===(128&e)?(t.flags=-65537&e|128,t):null;case 5:return $o(t),null;case 13:if(wr(es),null!==(e=t.memoizedState)&&null!==e.dehydrated){if(null===t.alternate)throw Error(o(340));fo()}return 65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 19:return wr(es),null;case 4:return Qo(),null;case 10:return Ao(t.type._context),null;case 22:case 23:return ul(),null;default:return null}}Da=function(e,t){for(var n=t.child;null!==n;){if(5===n.tag||6===n.tag)e.appendChild(n.stateNode);else if(4!==n.tag&&null!==n.child){n.child.return=n,n=n.child;continue}if(n===t)break;for(;null===n.sibling;){if(null===n.return||n.return===t)return;n=n.return}n.sibling.return=n.return,n=n.sibling}},Pa=function(){},ka=function(e,t,n,i){var r=e.memoizedProps;if(r!==i){e=t.stateNode,Jo(zo.current);var o,s=null;switch(n){case"input":r=J(e,r),i=J(e,i),s=[];break;case"select":r=x({},r,{value:void 0}),i=x({},i,{value:void 0}),s=[];break;case"textarea":r=ie(e,r),i=ie(e,i),s=[];break;default:"function"!==typeof r.onClick&&"function"===typeof i.onClick&&(e.onclick=$i)}for(d in ge(n,i),n=null,r)if(!i.hasOwnProperty(d)&&r.hasOwnProperty(d)&&null!=r[d])if("style"===d){var c=r[d];for(o in c)c.hasOwnProperty(o)&&(n||(n={}),n[o]="")}else"dangerouslySetInnerHTML"!==d&&"children"!==d&&"suppressContentEditableWarning"!==d&&"suppressHydrationWarning"!==d&&"autoFocus"!==d&&(a.hasOwnProperty(d)?s||(s=[]):(s=s||[]).push(d,null));for(d in i){var l=i[d];if(c=null!=r?r[d]:void 0,i.hasOwnProperty(d)&&l!==c&&(null!=l||null!=c))if("style"===d)if(c){for(o in c)!c.hasOwnProperty(o)||l&&l.hasOwnProperty(o)||(n||(n={}),n[o]="");for(o in l)l.hasOwnProperty(o)&&c[o]!==l[o]&&(n||(n={}),n[o]=l[o])}else n||(s||(s=[]),s.push(d,n)),n=l;else"dangerouslySetInnerHTML"===d?(l=l?l.__html:void 0,c=c?c.__html:void 0,null!=l&&c!==l&&(s=s||[]).push(d,l)):"children"===d?"string"!==typeof l&&"number"!==typeof l||(s=s||[]).push(d,""+l):"suppressContentEditableWarning"!==d&&"suppressHydrationWarning"!==d&&(a.hasOwnProperty(d)?(null!=l&&"onScroll"===d&&Fi("scroll",e),s||c===l||(s=[])):(s=s||[]).push(d,l))}n&&(s=s||[]).push("style",n);var d=s;(t.updateQueue=d)&&(t.flags|=4)}},La=function(e,t,n,i){n!==i&&(t.flags|=4)};var Ja=!1,Xa=!1,Qa="function"===typeof WeakSet?WeakSet:Set,Za=null;function $a(e,t){var n=e.ref;if(null!==n)if("function"===typeof n)try{n(null)}catch(i){Rl(e,t,i)}else n.current=null}function ec(e,t,n){try{n()}catch(i){Rl(e,t,i)}}var tc=!1;function nc(e,t,n){var i=t.updateQueue;if(null!==(i=null!==i?i.lastEffect:null)){var r=i=i.next;do{if((r.tag&e)===e){var o=r.destroy;r.destroy=void 0,void 0!==o&&ec(t,n,o)}r=r.next}while(r!==i)}}function ic(e,t){if(null!==(t=null!==(t=t.updateQueue)?t.lastEffect:null)){var n=t=t.next;do{if((n.tag&e)===e){var i=n.create;n.destroy=i()}n=n.next}while(n!==t)}}function rc(e){var t=e.ref;if(null!==t){var n=e.stateNode;e.tag,e=n,"function"===typeof t?t(e):t.current=e}}function oc(e){var t=e.alternate;null!==t&&(e.alternate=null,oc(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&(null!==(t=e.stateNode)&&(delete t[hr],delete t[pr],delete t[mr],delete t[_r],delete t[Er])),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function sc(e){return 5===e.tag||3===e.tag||4===e.tag}function ac(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||sc(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function cc(e,t,n){var i=e.tag;if(5===i||6===i)e=e.stateNode,t?8===n.nodeType?n.parentNode.insertBefore(e,t):n.insertBefore(e,t):(8===n.nodeType?(t=n.parentNode).insertBefore(e,n):(t=n).appendChild(e),null!==(n=n._reactRootContainer)&&void 0!==n||null!==t.onclick||(t.onclick=$i));else if(4!==i&&null!==(e=e.child))for(cc(e,t,n),e=e.sibling;null!==e;)cc(e,t,n),e=e.sibling}function lc(e,t,n){var i=e.tag;if(5===i||6===i)e=e.stateNode,t?n.insertBefore(e,t):n.appendChild(e);else if(4!==i&&null!==(e=e.child))for(lc(e,t,n),e=e.sibling;null!==e;)lc(e,t,n),e=e.sibling}var dc=null,uc=!1;function hc(e,t,n){for(n=n.child;null!==n;)pc(e,t,n),n=n.sibling}function pc(e,t,n){if(ot&&"function"===typeof ot.onCommitFiberUnmount)try{ot.onCommitFiberUnmount(rt,n)}catch(a){}switch(n.tag){case 5:Xa||$a(n,t);case 6:var i=dc,r=uc;dc=null,hc(e,t,n),uc=r,null!==(dc=i)&&(uc?(e=dc,n=n.stateNode,8===e.nodeType?e.parentNode.removeChild(n):e.removeChild(n)):dc.removeChild(n.stateNode));break;case 18:null!==dc&&(uc?(e=dc,n=n.stateNode,8===e.nodeType?cr(e.parentNode,n):1===e.nodeType&&cr(e,n),Gt(e)):cr(dc,n.stateNode));break;case 4:i=dc,r=uc,dc=n.stateNode.containerInfo,uc=!0,hc(e,t,n),dc=i,uc=r;break;case 0:case 11:case 14:case 15:if(!Xa&&(null!==(i=n.updateQueue)&&null!==(i=i.lastEffect))){r=i=i.next;do{var o=r,s=o.destroy;o=o.tag,void 0!==s&&(0!==(2&o)||0!==(4&o))&&ec(n,t,s),r=r.next}while(r!==i)}hc(e,t,n);break;case 1:if(!Xa&&($a(n,t),"function"===typeof(i=n.stateNode).componentWillUnmount))try{i.props=n.memoizedProps,i.state=n.memoizedState,i.componentWillUnmount()}catch(a){Rl(n,t,a)}hc(e,t,n);break;case 21:hc(e,t,n);break;case 22:1&n.mode?(Xa=(i=Xa)||null!==n.memoizedState,hc(e,t,n),Xa=i):hc(e,t,n);break;default:hc(e,t,n)}}function fc(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var n=e.stateNode;null===n&&(n=e.stateNode=new Qa),t.forEach((function(t){var i=Al.bind(null,e,t);n.has(t)||(n.add(t),t.then(i,i))}))}}function mc(e,t){var n=t.deletions;if(null!==n)for(var i=0;i<n.length;i++){var r=n[i];try{var s=e,a=t,c=a;e:for(;null!==c;){switch(c.tag){case 5:dc=c.stateNode,uc=!1;break e;case 3:case 4:dc=c.stateNode.containerInfo,uc=!0;break e}c=c.return}if(null===dc)throw Error(o(160));pc(s,a,r),dc=null,uc=!1;var l=r.alternate;null!==l&&(l.return=null),r.return=null}catch(d){Rl(r,t,d)}}if(12854&t.subtreeFlags)for(t=t.child;null!==t;)_c(t,e),t=t.sibling}function _c(e,t){var n=e.alternate,i=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(mc(t,e),Ec(e),4&i){try{nc(3,e,e.return),ic(3,e)}catch(_){Rl(e,e.return,_)}try{nc(5,e,e.return)}catch(_){Rl(e,e.return,_)}}break;case 1:mc(t,e),Ec(e),512&i&&null!==n&&$a(n,n.return);break;case 5:if(mc(t,e),Ec(e),512&i&&null!==n&&$a(n,n.return),32&e.flags){var r=e.stateNode;try{he(r,"")}catch(_){Rl(e,e.return,_)}}if(4&i&&null!=(r=e.stateNode)){var s=e.memoizedProps,a=null!==n?n.memoizedProps:s,c=e.type,l=e.updateQueue;if(e.updateQueue=null,null!==l)try{"input"===c&&"radio"===s.type&&null!=s.name&&Q(r,s),ve(c,a);var d=ve(c,s);for(a=0;a<l.length;a+=2){var u=l[a],h=l[a+1];"style"===u?_e(r,h):"dangerouslySetInnerHTML"===u?ue(r,h):"children"===u?he(r,h):v(r,u,h,d)}switch(c){case"input":Z(r,s);break;case"textarea":oe(r,s);break;case"select":var p=r._wrapperState.wasMultiple;r._wrapperState.wasMultiple=!!s.multiple;var f=s.value;null!=f?ne(r,!!s.multiple,f,!1):p!==!!s.multiple&&(null!=s.defaultValue?ne(r,!!s.multiple,s.defaultValue,!0):ne(r,!!s.multiple,s.multiple?[]:"",!1))}r[pr]=s}catch(_){Rl(e,e.return,_)}}break;case 6:if(mc(t,e),Ec(e),4&i){if(null===e.stateNode)throw Error(o(162));r=e.stateNode,s=e.memoizedProps;try{r.nodeValue=s}catch(_){Rl(e,e.return,_)}}break;case 3:if(mc(t,e),Ec(e),4&i&&null!==n&&n.memoizedState.isDehydrated)try{Gt(t.containerInfo)}catch(_){Rl(e,e.return,_)}break;case 4:default:mc(t,e),Ec(e);break;case 13:mc(t,e),Ec(e),8192&(r=e.child).flags&&(s=null!==r.memoizedState,r.stateNode.isHidden=s,!s||null!==r.alternate&&null!==r.alternate.memoizedState||(Bc=Qe())),4&i&&fc(e);break;case 22:if(u=null!==n&&null!==n.memoizedState,1&e.mode?(Xa=(d=Xa)||u,mc(t,e),Xa=d):mc(t,e),Ec(e),8192&i){if(d=null!==e.memoizedState,(e.stateNode.isHidden=d)&&!u&&0!==(1&e.mode))for(Za=e,u=e.child;null!==u;){for(h=Za=u;null!==Za;){switch(f=(p=Za).child,p.tag){case 0:case 11:case 14:case 15:nc(4,p,p.return);break;case 1:$a(p,p.return);var m=p.stateNode;if("function"===typeof m.componentWillUnmount){i=p,n=p.return;try{t=i,m.props=t.memoizedProps,m.state=t.memoizedState,m.componentWillUnmount()}catch(_){Rl(i,n,_)}}break;case 5:$a(p,p.return);break;case 22:if(null!==p.memoizedState){Sc(h);continue}}null!==f?(f.return=p,Za=f):Sc(h)}u=u.sibling}e:for(u=null,h=e;;){if(5===h.tag){if(null===u){u=h;try{r=h.stateNode,d?"function"===typeof(s=r.style).setProperty?s.setProperty("display","none","important"):s.display="none":(c=h.stateNode,a=void 0!==(l=h.memoizedProps.style)&&null!==l&&l.hasOwnProperty("display")?l.display:null,c.style.display=me("display",a))}catch(_){Rl(e,e.return,_)}}}else if(6===h.tag){if(null===u)try{h.stateNode.nodeValue=d?"":h.memoizedProps}catch(_){Rl(e,e.return,_)}}else if((22!==h.tag&&23!==h.tag||null===h.memoizedState||h===e)&&null!==h.child){h.child.return=h,h=h.child;continue}if(h===e)break e;for(;null===h.sibling;){if(null===h.return||h.return===e)break e;u===h&&(u=null),h=h.return}u===h&&(u=null),h.sibling.return=h.return,h=h.sibling}}break;case 19:mc(t,e),Ec(e),4&i&&fc(e);case 21:}}function Ec(e){var t=e.flags;if(2&t){try{e:{for(var n=e.return;null!==n;){if(sc(n)){var i=n;break e}n=n.return}throw Error(o(160))}switch(i.tag){case 5:var r=i.stateNode;32&i.flags&&(he(r,""),i.flags&=-33),lc(e,ac(e),r);break;case 3:case 4:var s=i.stateNode.containerInfo;cc(e,ac(e),s);break;default:throw Error(o(161))}}catch(a){Rl(e,e.return,a)}e.flags&=-3}4096&t&&(e.flags&=-4097)}function gc(e,t,n){Za=e,vc(e,t,n)}function vc(e,t,n){for(var i=0!==(1&e.mode);null!==Za;){var r=Za,o=r.child;if(22===r.tag&&i){var s=null!==r.memoizedState||Ja;if(!s){var a=r.alternate,c=null!==a&&null!==a.memoizedState||Xa;a=Ja;var l=Xa;if(Ja=s,(Xa=c)&&!l)for(Za=r;null!==Za;)c=(s=Za).child,22===s.tag&&null!==s.memoizedState?yc(r):null!==c?(c.return=s,Za=c):yc(r);for(;null!==o;)Za=o,vc(o,t,n),o=o.sibling;Za=r,Ja=a,Xa=l}Tc(e)}else 0!==(8772&r.subtreeFlags)&&null!==o?(o.return=r,Za=o):Tc(e)}}function Tc(e){for(;null!==Za;){var t=Za;if(0!==(8772&t.flags)){var n=t.alternate;try{if(0!==(8772&t.flags))switch(t.tag){case 0:case 11:case 15:Xa||ic(5,t);break;case 1:var i=t.stateNode;if(4&t.flags&&!Xa)if(null===n)i.componentDidMount();else{var r=t.elementType===t.type?n.memoizedProps:na(t.type,n.memoizedProps);i.componentDidUpdate(r,n.memoizedState,i.__reactInternalSnapshotBeforeUpdate)}var s=t.updateQueue;null!==s&&Ho(t,s,i);break;case 3:var a=t.updateQueue;if(null!==a){if(n=null,null!==t.child)switch(t.child.tag){case 5:case 1:n=t.child.stateNode}Ho(t,a,n)}break;case 5:var c=t.stateNode;if(null===n&&4&t.flags){n=c;var l=t.memoizedProps;switch(t.type){case"button":case"input":case"select":case"textarea":l.autoFocus&&n.focus();break;case"img":l.src&&(n.src=l.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===t.memoizedState){var d=t.alternate;if(null!==d){var u=d.memoizedState;if(null!==u){var h=u.dehydrated;null!==h&&Gt(h)}}}break;default:throw Error(o(163))}Xa||512&t.flags&&rc(t)}catch(p){Rl(t,t.return,p)}}if(t===e){Za=null;break}if(null!==(n=t.sibling)){n.return=t.return,Za=n;break}Za=t.return}}function Sc(e){for(;null!==Za;){var t=Za;if(t===e){Za=null;break}var n=t.sibling;if(null!==n){n.return=t.return,Za=n;break}Za=t.return}}function yc(e){for(;null!==Za;){var t=Za;try{switch(t.tag){case 0:case 11:case 15:var n=t.return;try{ic(4,t)}catch(c){Rl(t,n,c)}break;case 1:var i=t.stateNode;if("function"===typeof i.componentDidMount){var r=t.return;try{i.componentDidMount()}catch(c){Rl(t,r,c)}}var o=t.return;try{rc(t)}catch(c){Rl(t,o,c)}break;case 5:var s=t.return;try{rc(t)}catch(c){Rl(t,s,c)}}}catch(c){Rl(t,t.return,c)}if(t===e){Za=null;break}var a=t.sibling;if(null!==a){a.return=t.return,Za=a;break}Za=t.return}}var Cc,Rc=Math.ceil,wc=T.ReactCurrentDispatcher,Ic=T.ReactCurrentOwner,bc=T.ReactCurrentBatchConfig,Ac=0,Oc=null,Nc=null,Dc=0,Pc=0,kc=Rr(0),Lc=0,Mc=null,Uc=0,xc=0,Vc=0,Fc=null,jc=null,Bc=0,Gc=1/0,Wc=null,Hc=!1,Kc=null,zc=null,qc=!1,Yc=null,Jc=0,Xc=0,Qc=null,Zc=-1,$c=0;function el(){return 0!==(6&Ac)?Qe():-1!==Zc?Zc:Zc=Qe()}function tl(e){return 0===(1&e.mode)?1:0!==(2&Ac)&&0!==Dc?Dc&-Dc:null!==_o.transition?(0===$c&&($c=mt()),$c):0!==(e=vt)?e:e=void 0===(e=window.event)?16:Xt(e.type)}function nl(e,t,n,i){if(50<Xc)throw Xc=0,Qc=null,Error(o(185));Et(e,n,i),0!==(2&Ac)&&e===Oc||(e===Oc&&(0===(2&Ac)&&(xc|=n),4===Lc&&al(e,Dc)),il(e,i),1===n&&0===Ac&&0===(1&t.mode)&&(Gc=Qe()+500,Fr&&Gr()))}function il(e,t){var n=e.callbackNode;!function(e,t){for(var n=e.suspendedLanes,i=e.pingedLanes,r=e.expirationTimes,o=e.pendingLanes;0<o;){var s=31-st(o),a=1<<s,c=r[s];-1===c?0!==(a&n)&&0===(a&i)||(r[s]=pt(a,t)):c<=t&&(e.expiredLanes|=a),o&=~a}}(e,t);var i=ht(e,e===Oc?Dc:0);if(0===i)null!==n&&Ye(n),e.callbackNode=null,e.callbackPriority=0;else if(t=i&-i,e.callbackPriority!==t){if(null!=n&&Ye(n),1===t)0===e.tag?function(e){Fr=!0,Br(e)}(cl.bind(null,e)):Br(cl.bind(null,e)),sr((function(){0===(6&Ac)&&Gr()})),n=null;else{switch(Tt(i)){case 1:n=$e;break;case 4:n=et;break;case 16:default:n=tt;break;case 536870912:n=it}n=Ol(n,rl.bind(null,e))}e.callbackPriority=t,e.callbackNode=n}}function rl(e,t){if(Zc=-1,$c=0,0!==(6&Ac))throw Error(o(327));var n=e.callbackNode;if(yl()&&e.callbackNode!==n)return null;var i=ht(e,e===Oc?Dc:0);if(0===i)return null;if(0!==(30&i)||0!==(i&e.expiredLanes)||t)t=_l(e,i);else{t=i;var r=Ac;Ac|=2;var s=fl();for(Oc===e&&Dc===t||(Wc=null,Gc=Qe()+500,hl(e,t));;)try{gl();break}catch(c){pl(e,c)}bo(),wc.current=s,Ac=r,null!==Nc?t=0:(Oc=null,Dc=0,t=Lc)}if(0!==t){if(2===t&&(0!==(r=ft(e))&&(i=r,t=ol(e,r))),1===t)throw n=Mc,hl(e,0),al(e,i),il(e,Qe()),n;if(6===t)al(e,i);else{if(r=e.current.alternate,0===(30&i)&&!function(e){for(var t=e;;){if(16384&t.flags){var n=t.updateQueue;if(null!==n&&null!==(n=n.stores))for(var i=0;i<n.length;i++){var r=n[i],o=r.getSnapshot;r=r.value;try{if(!ai(o(),r))return!1}catch(a){return!1}}}if(n=t.child,16384&t.subtreeFlags&&null!==n)n.return=t,t=n;else{if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(r)&&(2===(t=_l(e,i))&&(0!==(s=ft(e))&&(i=s,t=ol(e,s))),1===t))throw n=Mc,hl(e,0),al(e,i),il(e,Qe()),n;switch(e.finishedWork=r,e.finishedLanes=i,t){case 0:case 1:throw Error(o(345));case 2:case 5:Sl(e,jc,Wc);break;case 3:if(al(e,i),(130023424&i)===i&&10<(t=Bc+500-Qe())){if(0!==ht(e,0))break;if(((r=e.suspendedLanes)&i)!==i){el(),e.pingedLanes|=e.suspendedLanes&r;break}e.timeoutHandle=ir(Sl.bind(null,e,jc,Wc),t);break}Sl(e,jc,Wc);break;case 4:if(al(e,i),(4194240&i)===i)break;for(t=e.eventTimes,r=-1;0<i;){var a=31-st(i);s=1<<a,(a=t[a])>r&&(r=a),i&=~s}if(i=r,10<(i=(120>(i=Qe()-i)?120:480>i?480:1080>i?1080:1920>i?1920:3e3>i?3e3:4320>i?4320:1960*Rc(i/1960))-i)){e.timeoutHandle=ir(Sl.bind(null,e,jc,Wc),i);break}Sl(e,jc,Wc);break;default:throw Error(o(329))}}}return il(e,Qe()),e.callbackNode===n?rl.bind(null,e):null}function ol(e,t){var n=Fc;return e.current.memoizedState.isDehydrated&&(hl(e,t).flags|=256),2!==(e=_l(e,t))&&(t=jc,jc=n,null!==t&&sl(t)),e}function sl(e){null===jc?jc=e:jc.push.apply(jc,e)}function al(e,t){for(t&=~Vc,t&=~xc,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var n=31-st(t),i=1<<n;e[n]=-1,t&=~i}}function cl(e){if(0!==(6&Ac))throw Error(o(327));yl();var t=ht(e,0);if(0===(1&t))return il(e,Qe()),null;var n=_l(e,t);if(0!==e.tag&&2===n){var i=ft(e);0!==i&&(t=i,n=ol(e,i))}if(1===n)throw n=Mc,hl(e,0),al(e,t),il(e,Qe()),n;if(6===n)throw Error(o(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,Sl(e,jc,Wc),il(e,Qe()),null}function ll(e,t){var n=Ac;Ac|=1;try{return e(t)}finally{0===(Ac=n)&&(Gc=Qe()+500,Fr&&Gr())}}function dl(e){null!==Yc&&0===Yc.tag&&0===(6&Ac)&&yl();var t=Ac;Ac|=1;var n=bc.transition,i=vt;try{if(bc.transition=null,vt=1,e)return e()}finally{vt=i,bc.transition=n,0===(6&(Ac=t))&&Gr()}}function ul(){Pc=kc.current,wr(kc)}function hl(e,t){e.finishedWork=null,e.finishedLanes=0;var n=e.timeoutHandle;if(-1!==n&&(e.timeoutHandle=-1,rr(n)),null!==Nc)for(n=Nc.return;null!==n;){var i=n;switch(to(i),i.tag){case 1:null!==(i=i.type.childContextTypes)&&void 0!==i&&kr();break;case 3:Qo(),wr(Or),wr(Ar),is();break;case 5:$o(i);break;case 4:Qo();break;case 13:case 19:wr(es);break;case 10:Ao(i.type._context);break;case 22:case 23:ul()}n=n.return}if(Oc=e,Nc=e=kl(e.current,null),Dc=Pc=t,Lc=0,Mc=null,Vc=xc=Uc=0,jc=Fc=null,null!==Po){for(t=0;t<Po.length;t++)if(null!==(i=(n=Po[t]).interleaved)){n.interleaved=null;var r=i.next,o=n.pending;if(null!==o){var s=o.next;o.next=r,i.next=s}n.pending=i}Po=null}return e}function pl(e,t){for(;;){var n=Nc;try{if(bo(),rs.current=Zs,ds){for(var i=as.memoizedState;null!==i;){var r=i.queue;null!==r&&(r.pending=null),i=i.next}ds=!1}if(ss=0,ls=cs=as=null,us=!1,hs=0,Ic.current=null,null===n||null===n.return){Lc=1,Mc=t,Nc=null;break}e:{var s=e,a=n.return,c=n,l=t;if(t=Dc,c.flags|=32768,null!==l&&"object"===typeof l&&"function"===typeof l.then){var d=l,u=c,h=u.tag;if(0===(1&u.mode)&&(0===h||11===h||15===h)){var p=u.alternate;p?(u.updateQueue=p.updateQueue,u.memoizedState=p.memoizedState,u.lanes=p.lanes):(u.updateQueue=null,u.memoizedState=null)}var f=_a(a);if(null!==f){f.flags&=-257,Ea(f,a,c,0,t),1&f.mode&&ma(s,d,t),l=d;var m=(t=f).updateQueue;if(null===m){var _=new Set;_.add(l),t.updateQueue=_}else m.add(l);break e}if(0===(1&t)){ma(s,d,t),ml();break e}l=Error(o(426))}else if(ro&&1&c.mode){var E=_a(a);if(null!==E){0===(65536&E.flags)&&(E.flags|=256),Ea(E,a,c,0,t),mo(la(l,c));break e}}s=l=la(l,c),4!==Lc&&(Lc=2),null===Fc?Fc=[s]:Fc.push(s),s=a;do{switch(s.tag){case 3:s.flags|=65536,t&=-t,s.lanes|=t,Go(s,pa(0,l,t));break e;case 1:c=l;var g=s.type,v=s.stateNode;if(0===(128&s.flags)&&("function"===typeof g.getDerivedStateFromError||null!==v&&"function"===typeof v.componentDidCatch&&(null===zc||!zc.has(v)))){s.flags|=65536,t&=-t,s.lanes|=t,Go(s,fa(s,c,t));break e}}s=s.return}while(null!==s)}Tl(n)}catch(T){t=T,Nc===n&&null!==n&&(Nc=n=n.return);continue}break}}function fl(){var e=wc.current;return wc.current=Zs,null===e?Zs:e}function ml(){0!==Lc&&3!==Lc&&2!==Lc||(Lc=4),null===Oc||0===(268435455&Uc)&&0===(268435455&xc)||al(Oc,Dc)}function _l(e,t){var n=Ac;Ac|=2;var i=fl();for(Oc===e&&Dc===t||(Wc=null,hl(e,t));;)try{El();break}catch(r){pl(e,r)}if(bo(),Ac=n,wc.current=i,null!==Nc)throw Error(o(261));return Oc=null,Dc=0,Lc}function El(){for(;null!==Nc;)vl(Nc)}function gl(){for(;null!==Nc&&!Je();)vl(Nc)}function vl(e){var t=Cc(e.alternate,e,Pc);e.memoizedProps=e.pendingProps,null===t?Tl(e):Nc=t,Ic.current=null}function Tl(e){var t=e;do{var n=t.alternate;if(e=t.return,0===(32768&t.flags)){if(null!==(n=qa(n,t,Pc)))return void(Nc=n)}else{if(null!==(n=Ya(n,t)))return n.flags&=32767,void(Nc=n);if(null===e)return Lc=6,void(Nc=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}if(null!==(t=t.sibling))return void(Nc=t);Nc=t=e}while(null!==t);0===Lc&&(Lc=5)}function Sl(e,t,n){var i=vt,r=bc.transition;try{bc.transition=null,vt=1,function(e,t,n,i){do{yl()}while(null!==Yc);if(0!==(6&Ac))throw Error(o(327));n=e.finishedWork;var r=e.finishedLanes;if(null===n)return null;if(e.finishedWork=null,e.finishedLanes=0,n===e.current)throw Error(o(177));e.callbackNode=null,e.callbackPriority=0;var s=n.lanes|n.childLanes;if(function(e,t){var n=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var i=e.eventTimes;for(e=e.expirationTimes;0<n;){var r=31-st(n),o=1<<r;t[r]=0,i[r]=-1,e[r]=-1,n&=~o}}(e,s),e===Oc&&(Nc=Oc=null,Dc=0),0===(2064&n.subtreeFlags)&&0===(2064&n.flags)||qc||(qc=!0,Ol(tt,(function(){return yl(),null}))),s=0!==(15990&n.flags),0!==(15990&n.subtreeFlags)||s){s=bc.transition,bc.transition=null;var a=vt;vt=1;var c=Ac;Ac|=4,Ic.current=null,function(e,t){if(er=Ht,pi(e=hi())){if("selectionStart"in e)var n={start:e.selectionStart,end:e.selectionEnd};else e:{var i=(n=(n=e.ownerDocument)&&n.defaultView||window).getSelection&&n.getSelection();if(i&&0!==i.rangeCount){n=i.anchorNode;var r=i.anchorOffset,s=i.focusNode;i=i.focusOffset;try{n.nodeType,s.nodeType}catch(S){n=null;break e}var a=0,c=-1,l=-1,d=0,u=0,h=e,p=null;t:for(;;){for(var f;h!==n||0!==r&&3!==h.nodeType||(c=a+r),h!==s||0!==i&&3!==h.nodeType||(l=a+i),3===h.nodeType&&(a+=h.nodeValue.length),null!==(f=h.firstChild);)p=h,h=f;for(;;){if(h===e)break t;if(p===n&&++d===r&&(c=a),p===s&&++u===i&&(l=a),null!==(f=h.nextSibling))break;p=(h=p).parentNode}h=f}n=-1===c||-1===l?null:{start:c,end:l}}else n=null}n=n||{start:0,end:0}}else n=null;for(tr={focusedElem:e,selectionRange:n},Ht=!1,Za=t;null!==Za;)if(e=(t=Za).child,0!==(1028&t.subtreeFlags)&&null!==e)e.return=t,Za=e;else for(;null!==Za;){t=Za;try{var m=t.alternate;if(0!==(1024&t.flags))switch(t.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==m){var _=m.memoizedProps,E=m.memoizedState,g=t.stateNode,v=g.getSnapshotBeforeUpdate(t.elementType===t.type?_:na(t.type,_),E);g.__reactInternalSnapshotBeforeUpdate=v}break;case 3:var T=t.stateNode.containerInfo;1===T.nodeType?T.textContent="":9===T.nodeType&&T.documentElement&&T.removeChild(T.documentElement);break;default:throw Error(o(163))}}catch(S){Rl(t,t.return,S)}if(null!==(e=t.sibling)){e.return=t.return,Za=e;break}Za=t.return}m=tc,tc=!1}(e,n),_c(n,e),fi(tr),Ht=!!er,tr=er=null,e.current=n,gc(n,e,r),Xe(),Ac=c,vt=a,bc.transition=s}else e.current=n;if(qc&&(qc=!1,Yc=e,Jc=r),s=e.pendingLanes,0===s&&(zc=null),function(e){if(ot&&"function"===typeof ot.onCommitFiberRoot)try{ot.onCommitFiberRoot(rt,e,void 0,128===(128&e.current.flags))}catch(t){}}(n.stateNode),il(e,Qe()),null!==t)for(i=e.onRecoverableError,n=0;n<t.length;n++)r=t[n],i(r.value,{componentStack:r.stack,digest:r.digest});if(Hc)throw Hc=!1,e=Kc,Kc=null,e;0!==(1&Jc)&&0!==e.tag&&yl(),s=e.pendingLanes,0!==(1&s)?e===Qc?Xc++:(Xc=0,Qc=e):Xc=0,Gr()}(e,t,n,i)}finally{bc.transition=r,vt=i}return null}function yl(){if(null!==Yc){var e=Tt(Jc),t=bc.transition,n=vt;try{if(bc.transition=null,vt=16>e?16:e,null===Yc)var i=!1;else{if(e=Yc,Yc=null,Jc=0,0!==(6&Ac))throw Error(o(331));var r=Ac;for(Ac|=4,Za=e.current;null!==Za;){var s=Za,a=s.child;if(0!==(16&Za.flags)){var c=s.deletions;if(null!==c){for(var l=0;l<c.length;l++){var d=c[l];for(Za=d;null!==Za;){var u=Za;switch(u.tag){case 0:case 11:case 15:nc(8,u,s)}var h=u.child;if(null!==h)h.return=u,Za=h;else for(;null!==Za;){var p=(u=Za).sibling,f=u.return;if(oc(u),u===d){Za=null;break}if(null!==p){p.return=f,Za=p;break}Za=f}}}var m=s.alternate;if(null!==m){var _=m.child;if(null!==_){m.child=null;do{var E=_.sibling;_.sibling=null,_=E}while(null!==_)}}Za=s}}if(0!==(2064&s.subtreeFlags)&&null!==a)a.return=s,Za=a;else e:for(;null!==Za;){if(0!==(2048&(s=Za).flags))switch(s.tag){case 0:case 11:case 15:nc(9,s,s.return)}var g=s.sibling;if(null!==g){g.return=s.return,Za=g;break e}Za=s.return}}var v=e.current;for(Za=v;null!==Za;){var T=(a=Za).child;if(0!==(2064&a.subtreeFlags)&&null!==T)T.return=a,Za=T;else e:for(a=v;null!==Za;){if(0!==(2048&(c=Za).flags))try{switch(c.tag){case 0:case 11:case 15:ic(9,c)}}catch(y){Rl(c,c.return,y)}if(c===a){Za=null;break e}var S=c.sibling;if(null!==S){S.return=c.return,Za=S;break e}Za=c.return}}if(Ac=r,Gr(),ot&&"function"===typeof ot.onPostCommitFiberRoot)try{ot.onPostCommitFiberRoot(rt,e)}catch(y){}i=!0}return i}finally{vt=n,bc.transition=t}}return!1}function Cl(e,t,n){e=jo(e,t=pa(0,t=la(n,t),1),1),t=el(),null!==e&&(Et(e,1,t),il(e,t))}function Rl(e,t,n){if(3===e.tag)Cl(e,e,n);else for(;null!==t;){if(3===t.tag){Cl(t,e,n);break}if(1===t.tag){var i=t.stateNode;if("function"===typeof t.type.getDerivedStateFromError||"function"===typeof i.componentDidCatch&&(null===zc||!zc.has(i))){t=jo(t,e=fa(t,e=la(n,e),1),1),e=el(),null!==t&&(Et(t,1,e),il(t,e));break}}t=t.return}}function wl(e,t,n){var i=e.pingCache;null!==i&&i.delete(t),t=el(),e.pingedLanes|=e.suspendedLanes&n,Oc===e&&(Dc&n)===n&&(4===Lc||3===Lc&&(130023424&Dc)===Dc&&500>Qe()-Bc?hl(e,0):Vc|=n),il(e,t)}function Il(e,t){0===t&&(0===(1&e.mode)?t=1:(t=dt,0===(130023424&(dt<<=1))&&(dt=4194304)));var n=el();null!==(e=Mo(e,t))&&(Et(e,t,n),il(e,n))}function bl(e){var t=e.memoizedState,n=0;null!==t&&(n=t.retryLane),Il(e,n)}function Al(e,t){var n=0;switch(e.tag){case 13:var i=e.stateNode,r=e.memoizedState;null!==r&&(n=r.retryLane);break;case 19:i=e.stateNode;break;default:throw Error(o(314))}null!==i&&i.delete(t),Il(e,n)}function Ol(e,t){return qe(e,t)}function Nl(e,t,n,i){this.tag=e,this.key=n,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=i,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Dl(e,t,n,i){return new Nl(e,t,n,i)}function Pl(e){return!(!(e=e.prototype)||!e.isReactComponent)}function kl(e,t){var n=e.alternate;return null===n?((n=Dl(e.tag,t,e.key,e.mode)).elementType=e.elementType,n.type=e.type,n.stateNode=e.stateNode,n.alternate=e,e.alternate=n):(n.pendingProps=t,n.type=e.type,n.flags=0,n.subtreeFlags=0,n.deletions=null),n.flags=14680064&e.flags,n.childLanes=e.childLanes,n.lanes=e.lanes,n.child=e.child,n.memoizedProps=e.memoizedProps,n.memoizedState=e.memoizedState,n.updateQueue=e.updateQueue,t=e.dependencies,n.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},n.sibling=e.sibling,n.index=e.index,n.ref=e.ref,n}function Ll(e,t,n,i,r,s){var a=2;if(i=e,"function"===typeof e)Pl(e)&&(a=1);else if("string"===typeof e)a=5;else e:switch(e){case C:return Ml(n.children,r,s,t);case R:a=8,r|=8;break;case w:return(e=Dl(12,n,t,2|r)).elementType=w,e.lanes=s,e;case O:return(e=Dl(13,n,t,r)).elementType=O,e.lanes=s,e;case N:return(e=Dl(19,n,t,r)).elementType=N,e.lanes=s,e;case k:return Ul(n,r,s,t);default:if("object"===typeof e&&null!==e)switch(e.$$typeof){case I:a=10;break e;case b:a=9;break e;case A:a=11;break e;case D:a=14;break e;case P:a=16,i=null;break e}throw Error(o(130,null==e?e:typeof e,""))}return(t=Dl(a,n,t,r)).elementType=e,t.type=i,t.lanes=s,t}function Ml(e,t,n,i){return(e=Dl(7,e,i,t)).lanes=n,e}function Ul(e,t,n,i){return(e=Dl(22,e,i,t)).elementType=k,e.lanes=n,e.stateNode={isHidden:!1},e}function xl(e,t,n){return(e=Dl(6,e,null,t)).lanes=n,e}function Vl(e,t,n){return(t=Dl(4,null!==e.children?e.children:[],e.key,t)).lanes=n,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function Fl(e,t,n,i,r){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=_t(0),this.expirationTimes=_t(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=_t(0),this.identifierPrefix=i,this.onRecoverableError=r,this.mutableSourceEagerHydrationData=null}function jl(e,t,n,i,r,o,s,a,c){return e=new Fl(e,t,n,a,c),1===t?(t=1,!0===o&&(t|=8)):t=0,o=Dl(3,null,null,t),e.current=o,o.stateNode=e,o.memoizedState={element:i,isDehydrated:n,cache:null,transitions:null,pendingSuspenseBoundaries:null},xo(o),e}function Bl(e){if(!e)return br;e:{if(Ge(e=e._reactInternals)!==e||1!==e.tag)throw Error(o(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(Pr(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(null!==t);throw Error(o(171))}if(1===e.tag){var n=e.type;if(Pr(n))return Mr(e,n,t)}return t}function Gl(e,t,n,i,r,o,s,a,c){return(e=jl(n,i,!0,e,0,o,0,a,c)).context=Bl(null),n=e.current,(o=Fo(i=el(),r=tl(n))).callback=void 0!==t&&null!==t?t:null,jo(n,o,r),e.current.lanes=r,Et(e,r,i),il(e,i),e}function Wl(e,t,n,i){var r=t.current,o=el(),s=tl(r);return n=Bl(n),null===t.context?t.context=n:t.pendingContext=n,(t=Fo(o,s)).payload={element:e},null!==(i=void 0===i?null:i)&&(t.callback=i),null!==(e=jo(r,t,s))&&(nl(e,r,s,o),Bo(e,r,s)),s}function Hl(e){return(e=e.current).child?(e.child.tag,e.child.stateNode):null}function Kl(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var n=e.retryLane;e.retryLane=0!==n&&n<t?n:t}}function zl(e,t){Kl(e,t),(e=e.alternate)&&Kl(e,t)}Cc=function(e,t,n){if(null!==e)if(e.memoizedProps!==t.pendingProps||Or.current)va=!0;else{if(0===(e.lanes&n)&&0===(128&t.flags))return va=!1,function(e,t,n){switch(t.tag){case 3:Oa(t),fo();break;case 5:Zo(t);break;case 1:Pr(t.type)&&Ur(t);break;case 4:Xo(t,t.stateNode.containerInfo);break;case 10:var i=t.type._context,r=t.memoizedProps.value;Ir(Co,i._currentValue),i._currentValue=r;break;case 13:if(null!==(i=t.memoizedState))return null!==i.dehydrated?(Ir(es,1&es.current),t.flags|=128,null):0!==(n&t.child.childLanes)?xa(e,t,n):(Ir(es,1&es.current),null!==(e=Ha(e,t,n))?e.sibling:null);Ir(es,1&es.current);break;case 19:if(i=0!==(n&t.childLanes),0!==(128&e.flags)){if(i)return Ga(e,t,n);t.flags|=128}if(null!==(r=t.memoizedState)&&(r.rendering=null,r.tail=null,r.lastEffect=null),Ir(es,es.current),i)break;return null;case 22:case 23:return t.lanes=0,Ra(e,t,n)}return Ha(e,t,n)}(e,t,n);va=0!==(131072&e.flags)}else va=!1,ro&&0!==(1048576&t.flags)&&$r(t,zr,t.index);switch(t.lanes=0,t.tag){case 2:var i=t.type;Wa(e,t),e=t.pendingProps;var r=Dr(t,Ar.current);No(t,n),r=_s(null,t,i,e,r,n);var s=Es();return t.flags|=1,"object"===typeof r&&null!==r&&"function"===typeof r.render&&void 0===r.$$typeof?(t.tag=1,t.memoizedState=null,t.updateQueue=null,Pr(i)?(s=!0,Ur(t)):s=!1,t.memoizedState=null!==r.state&&void 0!==r.state?r.state:null,xo(t),r.updater=ra,t.stateNode=r,r._reactInternals=t,ca(t,i,e,n),t=Aa(null,t,i,!0,s,n)):(t.tag=0,ro&&s&&eo(t),Ta(null,t,r,n),t=t.child),t;case 16:i=t.elementType;e:{switch(Wa(e,t),e=t.pendingProps,i=(r=i._init)(i._payload),t.type=i,r=t.tag=function(e){if("function"===typeof e)return Pl(e)?1:0;if(void 0!==e&&null!==e){if((e=e.$$typeof)===A)return 11;if(e===D)return 14}return 2}(i),e=na(i,e),r){case 0:t=Ia(null,t,i,e,n);break e;case 1:t=ba(null,t,i,e,n);break e;case 11:t=Sa(null,t,i,e,n);break e;case 14:t=ya(null,t,i,na(i.type,e),n);break e}throw Error(o(306,i,""))}return t;case 0:return i=t.type,r=t.pendingProps,Ia(e,t,i,r=t.elementType===i?r:na(i,r),n);case 1:return i=t.type,r=t.pendingProps,ba(e,t,i,r=t.elementType===i?r:na(i,r),n);case 3:e:{if(Oa(t),null===e)throw Error(o(387));i=t.pendingProps,r=(s=t.memoizedState).element,Vo(e,t),Wo(t,i,null,n);var a=t.memoizedState;if(i=a.element,s.isDehydrated){if(s={element:i,isDehydrated:!1,cache:a.cache,pendingSuspenseBoundaries:a.pendingSuspenseBoundaries,transitions:a.transitions},t.updateQueue.baseState=s,t.memoizedState=s,256&t.flags){t=Na(e,t,i,n,r=la(Error(o(423)),t));break e}if(i!==r){t=Na(e,t,i,n,r=la(Error(o(424)),t));break e}for(io=lr(t.stateNode.containerInfo.firstChild),no=t,ro=!0,oo=null,n=yo(t,null,i,n),t.child=n;n;)n.flags=-3&n.flags|4096,n=n.sibling}else{if(fo(),i===r){t=Ha(e,t,n);break e}Ta(e,t,i,n)}t=t.child}return t;case 5:return Zo(t),null===e&&lo(t),i=t.type,r=t.pendingProps,s=null!==e?e.memoizedProps:null,a=r.children,nr(i,r)?a=null:null!==s&&nr(i,s)&&(t.flags|=32),wa(e,t),Ta(e,t,a,n),t.child;case 6:return null===e&&lo(t),null;case 13:return xa(e,t,n);case 4:return Xo(t,t.stateNode.containerInfo),i=t.pendingProps,null===e?t.child=So(t,null,i,n):Ta(e,t,i,n),t.child;case 11:return i=t.type,r=t.pendingProps,Sa(e,t,i,r=t.elementType===i?r:na(i,r),n);case 7:return Ta(e,t,t.pendingProps,n),t.child;case 8:case 12:return Ta(e,t,t.pendingProps.children,n),t.child;case 10:e:{if(i=t.type._context,r=t.pendingProps,s=t.memoizedProps,a=r.value,Ir(Co,i._currentValue),i._currentValue=a,null!==s)if(ai(s.value,a)){if(s.children===r.children&&!Or.current){t=Ha(e,t,n);break e}}else for(null!==(s=t.child)&&(s.return=t);null!==s;){var c=s.dependencies;if(null!==c){a=s.child;for(var l=c.firstContext;null!==l;){if(l.context===i){if(1===s.tag){(l=Fo(-1,n&-n)).tag=2;var d=s.updateQueue;if(null!==d){var u=(d=d.shared).pending;null===u?l.next=l:(l.next=u.next,u.next=l),d.pending=l}}s.lanes|=n,null!==(l=s.alternate)&&(l.lanes|=n),Oo(s.return,n,t),c.lanes|=n;break}l=l.next}}else if(10===s.tag)a=s.type===t.type?null:s.child;else if(18===s.tag){if(null===(a=s.return))throw Error(o(341));a.lanes|=n,null!==(c=a.alternate)&&(c.lanes|=n),Oo(a,n,t),a=s.sibling}else a=s.child;if(null!==a)a.return=s;else for(a=s;null!==a;){if(a===t){a=null;break}if(null!==(s=a.sibling)){s.return=a.return,a=s;break}a=a.return}s=a}Ta(e,t,r.children,n),t=t.child}return t;case 9:return r=t.type,i=t.pendingProps.children,No(t,n),i=i(r=Do(r)),t.flags|=1,Ta(e,t,i,n),t.child;case 14:return r=na(i=t.type,t.pendingProps),ya(e,t,i,r=na(i.type,r),n);case 15:return Ca(e,t,t.type,t.pendingProps,n);case 17:return i=t.type,r=t.pendingProps,r=t.elementType===i?r:na(i,r),Wa(e,t),t.tag=1,Pr(i)?(e=!0,Ur(t)):e=!1,No(t,n),sa(t,i,r),ca(t,i,r,n),Aa(null,t,i,!0,e,n);case 19:return Ga(e,t,n);case 22:return Ra(e,t,n)}throw Error(o(156,t.tag))};var ql="function"===typeof reportError?reportError:function(e){console.error(e)};function Yl(e){this._internalRoot=e}function Jl(e){this._internalRoot=e}function Xl(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType)}function Ql(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function Zl(){}function $l(e,t,n,i,r){var o=n._reactRootContainer;if(o){var s=o;if("function"===typeof r){var a=r;r=function(){var e=Hl(s);a.call(e)}}Wl(t,s,e,r)}else s=function(e,t,n,i,r){if(r){if("function"===typeof i){var o=i;i=function(){var e=Hl(s);o.call(e)}}var s=Gl(t,i,e,0,null,!1,0,"",Zl);return e._reactRootContainer=s,e[fr]=s.current,Gi(8===e.nodeType?e.parentNode:e),dl(),s}for(;r=e.lastChild;)e.removeChild(r);if("function"===typeof i){var a=i;i=function(){var e=Hl(c);a.call(e)}}var c=jl(e,0,!1,null,0,!1,0,"",Zl);return e._reactRootContainer=c,e[fr]=c.current,Gi(8===e.nodeType?e.parentNode:e),dl((function(){Wl(t,c,n,i)})),c}(n,t,e,r,i);return Hl(s)}Jl.prototype.render=Yl.prototype.render=function(e){var t=this._internalRoot;if(null===t)throw Error(o(409));Wl(e,t,null,null)},Jl.prototype.unmount=Yl.prototype.unmount=function(){var e=this._internalRoot;if(null!==e){this._internalRoot=null;var t=e.containerInfo;dl((function(){Wl(null,e,null,null)})),t[fr]=null}},Jl.prototype.unstable_scheduleHydration=function(e){if(e){var t=Rt();e={blockedOn:null,target:e,priority:t};for(var n=0;n<kt.length&&0!==t&&t<kt[n].priority;n++);kt.splice(n,0,e),0===n&&xt(e)}},St=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var n=ut(t.pendingLanes);0!==n&&(gt(t,1|n),il(t,Qe()),0===(6&Ac)&&(Gc=Qe()+500,Gr()))}break;case 13:dl((function(){var t=Mo(e,1);if(null!==t){var n=el();nl(t,e,1,n)}})),zl(e,1)}},yt=function(e){if(13===e.tag){var t=Mo(e,134217728);if(null!==t)nl(t,e,134217728,el());zl(e,134217728)}},Ct=function(e){if(13===e.tag){var t=tl(e),n=Mo(e,t);if(null!==n)nl(n,e,t,el());zl(e,t)}},Rt=function(){return vt},wt=function(e,t){var n=vt;try{return vt=e,t()}finally{vt=n}},ye=function(e,t,n){switch(t){case"input":if(Z(e,n),t=n.name,"radio"===n.type&&null!=t){for(n=e;n.parentNode;)n=n.parentNode;for(n=n.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<n.length;t++){var i=n[t];if(i!==e&&i.form===e.form){var r=Sr(i);if(!r)throw Error(o(90));q(i),Z(i,r)}}}break;case"textarea":oe(e,n);break;case"select":null!=(t=n.value)&&ne(e,!!n.multiple,t,!1)}},Ae=ll,Oe=dl;var ed={usingClientEntryPoint:!1,Events:[vr,Tr,Sr,Ie,be,ll]},td={findFiberByHostInstance:gr,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},nd={bundleType:td.bundleType,version:td.version,rendererPackageName:td.rendererPackageName,rendererConfig:td.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:T.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=Ke(e))?null:e.stateNode},findFiberByHostInstance:td.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if("undefined"!==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var id=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!id.isDisabled&&id.supportsFiber)try{rt=id.inject(nd),ot=id}catch(de){}}t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=ed,t.createPortal=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!Xl(t))throw Error(o(200));return function(e,t,n){var i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:y,key:null==i?null:""+i,children:e,containerInfo:t,implementation:n}}(e,t,null,n)},t.createRoot=function(e,t){if(!Xl(e))throw Error(o(299));var n=!1,i="",r=ql;return null!==t&&void 0!==t&&(!0===t.unstable_strictMode&&(n=!0),void 0!==t.identifierPrefix&&(i=t.identifierPrefix),void 0!==t.onRecoverableError&&(r=t.onRecoverableError)),t=jl(e,1,!1,null,0,n,0,i,r),e[fr]=t.current,Gi(8===e.nodeType?e.parentNode:e),new Yl(t)},t.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternals;if(void 0===t){if("function"===typeof e.render)throw Error(o(188));throw e=Object.keys(e).join(","),Error(o(268,e))}return e=null===(e=Ke(t))?null:e.stateNode},t.flushSync=function(e){return dl(e)},t.hydrate=function(e,t,n){if(!Ql(t))throw Error(o(200));return $l(null,e,t,!0,n)},t.hydrateRoot=function(e,t,n){if(!Xl(e))throw Error(o(405));var i=null!=n&&n.hydratedSources||null,r=!1,s="",a=ql;if(null!==n&&void 0!==n&&(!0===n.unstable_strictMode&&(r=!0),void 0!==n.identifierPrefix&&(s=n.identifierPrefix),void 0!==n.onRecoverableError&&(a=n.onRecoverableError)),t=Gl(t,null,e,1,null!=n?n:null,r,0,s,a),e[fr]=t.current,Gi(e),i)for(e=0;e<i.length;e++)r=(r=(n=i[e])._getVersion)(n._source),null==t.mutableSourceEagerHydrationData?t.mutableSourceEagerHydrationData=[n,r]:t.mutableSourceEagerHydrationData.push(n,r);return new Jl(t)},t.render=function(e,t,n){if(!Ql(t))throw Error(o(200));return $l(null,e,t,!1,n)},t.unmountComponentAtNode=function(e){if(!Ql(e))throw Error(o(40));return!!e._reactRootContainer&&(dl((function(){$l(null,null,e,!1,(function(){e._reactRootContainer=null,e[fr]=null}))})),!0)},t.unstable_batchedUpdates=ll,t.unstable_renderSubtreeIntoContainer=function(e,t,n,i){if(!Ql(n))throw Error(o(200));if(null==e||void 0===e._reactInternals)throw Error(o(38));return $l(e,t,n,!1,i)},t.version="18.3.1-next-f1338f8080-20240426"},391:(e,t,n)=>{"use strict";var i=n(950);t.createRoot=i.createRoot,t.hydrateRoot=i.hydrateRoot},950:(e,t,n)=>{"use strict";!function e(){if("undefined"!==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(t){console.error(t)}}(),e.exports=n(730)},153:(e,t,n)=>{"use strict";var i=n(43),r=Symbol.for("react.element"),o=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,a=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,n){var i,o={},l=null,d=null;for(i in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(d=t.ref),t)s.call(t,i)&&!c.hasOwnProperty(i)&&(o[i]=t[i]);if(e&&e.defaultProps)for(i in t=e.defaultProps)void 0===o[i]&&(o[i]=t[i]);return{$$typeof:r,type:e,key:l,ref:d,props:o,_owner:a.current}}t.jsx=l,t.jsxs=l},202:(e,t)=>{"use strict";var n=Symbol.for("react.element"),i=Symbol.for("react.portal"),r=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),c=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),d=Symbol.for("react.suspense"),u=Symbol.for("react.memo"),h=Symbol.for("react.lazy"),p=Symbol.iterator;var f={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,_={};function E(e,t,n){this.props=e,this.context=t,this.refs=_,this.updater=n||f}function g(){}function v(e,t,n){this.props=e,this.context=t,this.refs=_,this.updater=n||f}E.prototype.isReactComponent={},E.prototype.setState=function(e,t){if("object"!==typeof e&&"function"!==typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},E.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},g.prototype=E.prototype;var T=v.prototype=new g;T.constructor=v,m(T,E.prototype),T.isPureReactComponent=!0;var S=Array.isArray,y=Object.prototype.hasOwnProperty,C={current:null},R={key:!0,ref:!0,__self:!0,__source:!0};function w(e,t,i){var r,o={},s=null,a=null;if(null!=t)for(r in void 0!==t.ref&&(a=t.ref),void 0!==t.key&&(s=""+t.key),t)y.call(t,r)&&!R.hasOwnProperty(r)&&(o[r]=t[r]);var c=arguments.length-2;if(1===c)o.children=i;else if(1<c){for(var l=Array(c),d=0;d<c;d++)l[d]=arguments[d+2];o.children=l}if(e&&e.defaultProps)for(r in c=e.defaultProps)void 0===o[r]&&(o[r]=c[r]);return{$$typeof:n,type:e,key:s,ref:a,props:o,_owner:C.current}}function I(e){return"object"===typeof e&&null!==e&&e.$$typeof===n}var b=/\/+/g;function A(e,t){return"object"===typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function O(e,t,r,o,s){var a=typeof e;"undefined"!==a&&"boolean"!==a||(e=null);var c=!1;if(null===e)c=!0;else switch(a){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case n:case i:c=!0}}if(c)return s=s(c=e),e=""===o?"."+A(c,0):o,S(s)?(r="",null!=e&&(r=e.replace(b,"$&/")+"/"),O(s,t,r,"",(function(e){return e}))):null!=s&&(I(s)&&(s=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(s,r+(!s.key||c&&c.key===s.key?"":(""+s.key).replace(b,"$&/")+"/")+e)),t.push(s)),1;if(c=0,o=""===o?".":o+":",S(e))for(var l=0;l<e.length;l++){var d=o+A(a=e[l],l);c+=O(a,t,r,d,s)}else if(d=function(e){return null===e||"object"!==typeof e?null:"function"===typeof(e=p&&e[p]||e["@@iterator"])?e:null}(e),"function"===typeof d)for(e=d.call(e),l=0;!(a=e.next()).done;)c+=O(a=a.value,t,r,d=o+A(a,l++),s);else if("object"===a)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return c}function N(e,t,n){if(null==e)return e;var i=[],r=0;return O(e,i,"","",(function(e){return t.call(n,e,r++)})),i}function D(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var P={current:null},k={transition:null},L={ReactCurrentDispatcher:P,ReactCurrentBatchConfig:k,ReactCurrentOwner:C};function M(){throw Error("act(...) is not supported in production builds of React.")}t.Children={map:N,forEach:function(e,t,n){N(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return N(e,(function(){t++})),t},toArray:function(e){return N(e,(function(e){return e}))||[]},only:function(e){if(!I(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=E,t.Fragment=r,t.Profiler=s,t.PureComponent=v,t.StrictMode=o,t.Suspense=d,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=L,t.act=M,t.cloneElement=function(e,t,i){if(null===e||void 0===e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var r=m({},e.props),o=e.key,s=e.ref,a=e._owner;if(null!=t){if(void 0!==t.ref&&(s=t.ref,a=C.current),void 0!==t.key&&(o=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(l in t)y.call(t,l)&&!R.hasOwnProperty(l)&&(r[l]=void 0===t[l]&&void 0!==c?c[l]:t[l])}var l=arguments.length-2;if(1===l)r.children=i;else if(1<l){c=Array(l);for(var d=0;d<l;d++)c[d]=arguments[d+2];r.children=c}return{$$typeof:n,type:e.type,key:o,ref:s,props:r,_owner:a}},t.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},t.createElement=w,t.createFactory=function(e){var t=w.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:l,render:e}},t.isValidElement=I,t.lazy=function(e){return{$$typeof:h,_payload:{_status:-1,_result:e},_init:D}},t.memo=function(e,t){return{$$typeof:u,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=k.transition;k.transition={};try{e()}finally{k.transition=t}},t.unstable_act=M,t.useCallback=function(e,t){return P.current.useCallback(e,t)},t.useContext=function(e){return P.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return P.current.useDeferredValue(e)},t.useEffect=function(e,t){return P.current.useEffect(e,t)},t.useId=function(){return P.current.useId()},t.useImperativeHandle=function(e,t,n){return P.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return P.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return P.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return P.current.useMemo(e,t)},t.useReducer=function(e,t,n){return P.current.useReducer(e,t,n)},t.useRef=function(e){return P.current.useRef(e)},t.useState=function(e){return P.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return P.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return P.current.useTransition()},t.version="18.3.1"},43:(e,t,n)=>{"use strict";e.exports=n(202)},579:(e,t,n)=>{"use strict";e.exports=n(153)},234:(e,t)=>{"use strict";function n(e,t){var n=e.length;e.push(t);e:for(;0<n;){var i=n-1>>>1,r=e[i];if(!(0<o(r,t)))break e;e[i]=t,e[n]=r,n=i}}function i(e){return 0===e.length?null:e[0]}function r(e){if(0===e.length)return null;var t=e[0],n=e.pop();if(n!==t){e[0]=n;e:for(var i=0,r=e.length,s=r>>>1;i<s;){var a=2*(i+1)-1,c=e[a],l=a+1,d=e[l];if(0>o(c,n))l<r&&0>o(d,c)?(e[i]=d,e[l]=n,i=l):(e[i]=c,e[a]=n,i=a);else{if(!(l<r&&0>o(d,n)))break e;e[i]=d,e[l]=n,i=l}}}return t}function o(e,t){var n=e.sortIndex-t.sortIndex;return 0!==n?n:e.id-t.id}if("object"===typeof performance&&"function"===typeof performance.now){var s=performance;t.unstable_now=function(){return s.now()}}else{var a=Date,c=a.now();t.unstable_now=function(){return a.now()-c}}var l=[],d=[],u=1,h=null,p=3,f=!1,m=!1,_=!1,E="function"===typeof setTimeout?setTimeout:null,g="function"===typeof clearTimeout?clearTimeout:null,v="undefined"!==typeof setImmediate?setImmediate:null;function T(e){for(var t=i(d);null!==t;){if(null===t.callback)r(d);else{if(!(t.startTime<=e))break;r(d),t.sortIndex=t.expirationTime,n(l,t)}t=i(d)}}function S(e){if(_=!1,T(e),!m)if(null!==i(l))m=!0,k(y);else{var t=i(d);null!==t&&L(S,t.startTime-e)}}function y(e,n){m=!1,_&&(_=!1,g(I),I=-1),f=!0;var o=p;try{for(T(n),h=i(l);null!==h&&(!(h.expirationTime>n)||e&&!O());){var s=h.callback;if("function"===typeof s){h.callback=null,p=h.priorityLevel;var a=s(h.expirationTime<=n);n=t.unstable_now(),"function"===typeof a?h.callback=a:h===i(l)&&r(l),T(n)}else r(l);h=i(l)}if(null!==h)var c=!0;else{var u=i(d);null!==u&&L(S,u.startTime-n),c=!1}return c}finally{h=null,p=o,f=!1}}"undefined"!==typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var C,R=!1,w=null,I=-1,b=5,A=-1;function O(){return!(t.unstable_now()-A<b)}function N(){if(null!==w){var e=t.unstable_now();A=e;var n=!0;try{n=w(!0,e)}finally{n?C():(R=!1,w=null)}}else R=!1}if("function"===typeof v)C=function(){v(N)};else if("undefined"!==typeof MessageChannel){var D=new MessageChannel,P=D.port2;D.port1.onmessage=N,C=function(){P.postMessage(null)}}else C=function(){E(N,0)};function k(e){w=e,R||(R=!0,C())}function L(e,n){I=E((function(){e(t.unstable_now())}),n)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(e){e.callback=null},t.unstable_continueExecution=function(){m||f||(m=!0,k(y))},t.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):b=0<e?Math.floor(1e3/e):5},t.unstable_getCurrentPriorityLevel=function(){return p},t.unstable_getFirstCallbackNode=function(){return i(l)},t.unstable_next=function(e){switch(p){case 1:case 2:case 3:var t=3;break;default:t=p}var n=p;p=t;try{return e()}finally{p=n}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=function(){},t.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var n=p;p=e;try{return t()}finally{p=n}},t.unstable_scheduleCallback=function(e,r,o){var s=t.unstable_now();switch("object"===typeof o&&null!==o?o="number"===typeof(o=o.delay)&&0<o?s+o:s:o=s,e){case 1:var a=-1;break;case 2:a=250;break;case 5:a=1073741823;break;case 4:a=1e4;break;default:a=5e3}return e={id:u++,callback:r,priorityLevel:e,startTime:o,expirationTime:a=o+a,sortIndex:-1},o>s?(e.sortIndex=o,n(d,e),null===i(l)&&e===i(d)&&(_?(g(I),I=-1):_=!0,L(S,o-s))):(e.sortIndex=a,n(l,e),m||f||(m=!0,k(y))),e},t.unstable_shouldYield=O,t.unstable_wrapCallback=function(e){var t=p;return function(){var n=p;p=t;try{return e.apply(this,arguments)}finally{p=n}}}},853:(e,t,n)=>{"use strict";e.exports=n(234)}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,n),o.exports}n.m=e,n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},(()=>{var e,t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__;n.t=function(i,r){if(1&r&&(i=this(i)),8&r)return i;if("object"===typeof i&&i){if(4&r&&i.__esModule)return i;if(16&r&&"function"===typeof i.then)return i}var o=Object.create(null);n.r(o);var s={};e=e||[null,t({}),t([]),t(t)];for(var a=2&r&&i;"object"==typeof a&&!~e.indexOf(a);a=t(a))Object.getOwnPropertyNames(a).forEach((e=>s[e]=()=>i[e]));return s.default=()=>i,n.d(o,s),o}})(),n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,i)=>(n.f[i](e,t),t)),[])),n.u=e=>"static/js/"+e+".a6a97343.chunk.js",n.miniCssF=e=>{},n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={},t="app:";n.l=(i,r,o,s)=>{if(e[i])e[i].push(r);else{var a,c;if(void 0!==o)for(var l=document.getElementsByTagName("script"),d=0;d<l.length;d++){var u=l[d];if(u.getAttribute("src")==i||u.getAttribute("data-webpack")==t+o){a=u;break}}a||(c=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,n.nc&&a.setAttribute("nonce",n.nc),a.setAttribute("data-webpack",t+o),a.src=i),e[i]=[r];var h=(t,n)=>{a.onerror=a.onload=null,clearTimeout(p);var r=e[i];if(delete e[i],a.parentNode&&a.parentNode.removeChild(a),r&&r.forEach((e=>e(n))),t)return t(n)},p=setTimeout(h.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=h.bind(null,a.onerror),a.onload=h.bind(null,a.onload),c&&document.head.appendChild(a)}}})(),n.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.p="/chat-app/",(()=>{var e={792:0};n.f.j=(t,i)=>{var r=n.o(e,t)?e[t]:void 0;if(0!==r)if(r)i.push(r[2]);else{var o=new Promise(((n,i)=>r=e[t]=[n,i]));i.push(r[2]=o);var s=n.p+n.u(t),a=new Error;n.l(s,(i=>{if(n.o(e,t)&&(0!==(r=e[t])&&(e[t]=void 0),r)){var o=i&&("load"===i.type?"missing":i.type),s=i&&i.target&&i.target.src;a.message="Loading chunk "+t+" failed.\n("+o+": "+s+")",a.name="ChunkLoadError",a.type=o,a.request=s,r[1](a)}}),"chunk-"+t,t)}};var t=(t,i)=>{var r,o,s=i[0],a=i[1],c=i[2],l=0;if(s.some((t=>0!==e[t]))){for(r in a)n.o(a,r)&&(n.m[r]=a[r]);if(c)c(n)}for(t&&t(i);l<s.length;l++)o=s[l],n.o(e,o)&&e[o]&&e[o][0](),e[o]=0},i=self.webpackChunkapp=self.webpackChunkapp||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})(),(()=>{"use strict";var e,t=n(43),i=n.t(t,2),r=n(391);function o(){return o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},o.apply(this,arguments)}!function(e){e.Pop="POP",e.Push="PUSH",e.Replace="REPLACE"}(e||(e={}));const s="popstate";function a(e,t){if(!1===e||null===e||"undefined"===typeof e)throw new Error(t)}function c(e,t){if(!e){"undefined"!==typeof console&&console.warn(t);try{throw new Error(t)}catch(n){}}}function l(e,t){return{usr:e.state,key:e.key,idx:t}}function d(e,t,n,i){return void 0===n&&(n=null),o({pathname:"string"===typeof e?e:e.pathname,search:"",hash:""},"string"===typeof t?h(t):t,{state:n,key:t&&t.key||i||Math.random().toString(36).substr(2,8)})}function u(e){let{pathname:t="/",search:n="",hash:i=""}=e;return n&&"?"!==n&&(t+="?"===n.charAt(0)?n:"?"+n),i&&"#"!==i&&(t+="#"===i.charAt(0)?i:"#"+i),t}function h(e){let t={};if(e){let n=e.indexOf("#");n>=0&&(t.hash=e.substr(n),e=e.substr(0,n));let i=e.indexOf("?");i>=0&&(t.search=e.substr(i),e=e.substr(0,i)),e&&(t.pathname=e)}return t}function p(t,n,i,r){void 0===r&&(r={});let{window:c=document.defaultView,v5Compat:h=!1}=r,p=c.history,f=e.Pop,m=null,_=E();function E(){return(p.state||{idx:null}).idx}function g(){f=e.Pop;let t=E(),n=null==t?null:t-_;_=t,m&&m({action:f,location:T.location,delta:n})}function v(e){let t="null"!==c.location.origin?c.location.origin:c.location.href,n="string"===typeof e?e:u(e);return n=n.replace(/ $/,"%20"),a(t,"No window.location.(origin|href) available to create URL for href: "+n),new URL(n,t)}null==_&&(_=0,p.replaceState(o({},p.state,{idx:_}),""));let T={get action(){return f},get location(){return t(c,p)},listen(e){if(m)throw new Error("A history only accepts one active listener");return c.addEventListener(s,g),m=e,()=>{c.removeEventListener(s,g),m=null}},createHref:e=>n(c,e),createURL:v,encodeLocation(e){let t=v(e);return{pathname:t.pathname,search:t.search,hash:t.hash}},push:function(t,n){f=e.Push;let r=d(T.location,t,n);i&&i(r,t),_=E()+1;let o=l(r,_),s=T.createHref(r);try{p.pushState(o,"",s)}catch(a){if(a instanceof DOMException&&"DataCloneError"===a.name)throw a;c.location.assign(s)}h&&m&&m({action:f,location:T.location,delta:1})},replace:function(t,n){f=e.Replace;let r=d(T.location,t,n);i&&i(r,t),_=E();let o=l(r,_),s=T.createHref(r);p.replaceState(o,"",s),h&&m&&m({action:f,location:T.location,delta:0})},go:e=>p.go(e)};return T}var f;!function(e){e.data="data",e.deferred="deferred",e.redirect="redirect",e.error="error"}(f||(f={}));new Set(["lazy","caseSensitive","path","id","index","children"]);function m(e,t,n){void 0===n&&(n="/");let i=O(("string"===typeof t?h(t):t).pathname||"/",n);if(null==i)return null;let r=_(e);!function(e){e.sort(((e,t)=>e.score!==t.score?t.score-e.score:function(e,t){let n=e.length===t.length&&e.slice(0,-1).every(((e,n)=>e===t[n]));return n?e[e.length-1]-t[t.length-1]:0}(e.routesMeta.map((e=>e.childrenIndex)),t.routesMeta.map((e=>e.childrenIndex)))))}(r);let o=null;for(let s=0;null==o&&s<r.length;++s){let e=A(i);o=I(r[s],e)}return o}function _(e,t,n,i){void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i="");let r=(e,r,o)=>{let s={relativePath:void 0===o?e.path||"":o,caseSensitive:!0===e.caseSensitive,childrenIndex:r,route:e};s.relativePath.startsWith("/")&&(a(s.relativePath.startsWith(i),'Absolute route path "'+s.relativePath+'" nested under path "'+i+'" is not valid. An absolute child route path must start with the combined path of all its parent routes.'),s.relativePath=s.relativePath.slice(i.length));let c=L([i,s.relativePath]),l=n.concat(s);e.children&&e.children.length>0&&(a(!0!==e.index,'Index routes must not have child routes. Please remove all child routes from route path "'+c+'".'),_(e.children,t,l,c)),(null!=e.path||e.index)&&t.push({path:c,score:w(c,e.index),routesMeta:l})};return e.forEach(((e,t)=>{var n;if(""!==e.path&&null!=(n=e.path)&&n.includes("?"))for(let i of E(e.path))r(e,t,i);else r(e,t)})),t}function E(e){let t=e.split("/");if(0===t.length)return[];let[n,...i]=t,r=n.endsWith("?"),o=n.replace(/\?$/,"");if(0===i.length)return r?[o,""]:[o];let s=E(i.join("/")),a=[];return a.push(...s.map((e=>""===e?o:[o,e].join("/")))),r&&a.push(...s),a.map((t=>e.startsWith("/")&&""===t?"/":t))}const g=/^:[\w-]+$/,v=3,T=2,S=1,y=10,C=-2,R=e=>"*"===e;function w(e,t){let n=e.split("/"),i=n.length;return n.some(R)&&(i+=C),t&&(i+=T),n.filter((e=>!R(e))).reduce(((e,t)=>e+(g.test(t)?v:""===t?S:y)),i)}function I(e,t){let{routesMeta:n}=e,i={},r="/",o=[];for(let s=0;s<n.length;++s){let e=n[s],a=s===n.length-1,c="/"===r?t:t.slice(r.length)||"/",l=b({path:e.relativePath,caseSensitive:e.caseSensitive,end:a},c);if(!l)return null;Object.assign(i,l.params);let d=e.route;o.push({params:i,pathname:L([r,l.pathname]),pathnameBase:M(L([r,l.pathnameBase])),route:d}),"/"!==l.pathnameBase&&(r=L([r,l.pathnameBase]))}return o}function b(e,t){"string"===typeof e&&(e={path:e,caseSensitive:!1,end:!0});let[n,i]=function(e,t,n){void 0===t&&(t=!1);void 0===n&&(n=!0);c("*"===e||!e.endsWith("*")||e.endsWith("/*"),'Route path "'+e+'" will be treated as if it were "'+e.replace(/\*$/,"/*")+'" because the `*` character must always follow a `/` in the pattern. To get rid of this warning, please change the route path to "'+e.replace(/\*$/,"/*")+'".');let i=[],r="^"+e.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,((e,t,n)=>(i.push({paramName:t,isOptional:null!=n}),n?"/?([^\\/]+)?":"/([^\\/]+)")));e.endsWith("*")?(i.push({paramName:"*"}),r+="*"===e||"/*"===e?"(.*)$":"(?:\\/(.+)|\\/*)$"):n?r+="\\/*$":""!==e&&"/"!==e&&(r+="(?:(?=\\/|$))");let o=new RegExp(r,t?void 0:"i");return[o,i]}(e.path,e.caseSensitive,e.end),r=t.match(n);if(!r)return null;let o=r[0],s=o.replace(/(.)\/+$/,"$1"),a=r.slice(1);return{params:i.reduce(((e,t,n)=>{let{paramName:i,isOptional:r}=t;if("*"===i){let e=a[n]||"";s=o.slice(0,o.length-e.length).replace(/(.)\/+$/,"$1")}const c=a[n];return e[i]=r&&!c?void 0:(c||"").replace(/%2F/g,"/"),e}),{}),pathname:o,pathnameBase:s,pattern:e}}function A(e){try{return e.split("/").map((e=>decodeURIComponent(e).replace(/\//g,"%2F"))).join("/")}catch(t){return c(!1,'The URL path "'+e+'" could not be decoded because it is is a malformed URL segment. This is probably due to a bad percent encoding ('+t+")."),e}}function O(e,t){if("/"===t)return e;if(!e.toLowerCase().startsWith(t.toLowerCase()))return null;let n=t.endsWith("/")?t.length-1:t.length,i=e.charAt(n);return i&&"/"!==i?null:e.slice(n)||"/"}function N(e,t,n,i){return"Cannot include a '"+e+"' character in a manually specified `to."+t+"` field ["+JSON.stringify(i)+"].  Please separate it out to the `to."+n+'` field. Alternatively you may provide the full path as a string in <Link to="..."> and the router will parse it for you.'}function D(e){return e.filter(((e,t)=>0===t||e.route.path&&e.route.path.length>0))}function P(e,t){let n=D(e);return t?n.map(((t,n)=>n===e.length-1?t.pathname:t.pathnameBase)):n.map((e=>e.pathnameBase))}function k(e,t,n,i){let r;void 0===i&&(i=!1),"string"===typeof e?r=h(e):(r=o({},e),a(!r.pathname||!r.pathname.includes("?"),N("?","pathname","search",r)),a(!r.pathname||!r.pathname.includes("#"),N("#","pathname","hash",r)),a(!r.search||!r.search.includes("#"),N("#","search","hash",r)));let s,c=""===e||""===r.pathname,l=c?"/":r.pathname;if(null==l)s=n;else{let e=t.length-1;if(!i&&l.startsWith("..")){let t=l.split("/");for(;".."===t[0];)t.shift(),e-=1;r.pathname=t.join("/")}s=e>=0?t[e]:"/"}let d=function(e,t){void 0===t&&(t="/");let{pathname:n,search:i="",hash:r=""}="string"===typeof e?h(e):e,o=n?n.startsWith("/")?n:function(e,t){let n=t.replace(/\/+$/,"").split("/");return e.split("/").forEach((e=>{".."===e?n.length>1&&n.pop():"."!==e&&n.push(e)})),n.length>1?n.join("/"):"/"}(n,t):t;return{pathname:o,search:U(i),hash:x(r)}}(r,s),u=l&&"/"!==l&&l.endsWith("/"),p=(c||"."===l)&&n.endsWith("/");return d.pathname.endsWith("/")||!u&&!p||(d.pathname+="/"),d}const L=e=>e.join("/").replace(/\/\/+/g,"/"),M=e=>e.replace(/\/+$/,"").replace(/^\/*/,"/"),U=e=>e&&"?"!==e?e.startsWith("?")?e:"?"+e:"",x=e=>e&&"#"!==e?e.startsWith("#")?e:"#"+e:"";Error;function V(e){return null!=e&&"number"===typeof e.status&&"string"===typeof e.statusText&&"boolean"===typeof e.internal&&"data"in e}const F=["post","put","patch","delete"],j=(new Set(F),["get",...F]);new Set(j),new Set([301,302,303,307,308]),new Set([307,308]);Symbol("deferred");function B(){return B=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},B.apply(this,arguments)}const G=t.createContext(null);const W=t.createContext(null);const H=t.createContext(null);const K=t.createContext(null);const z=t.createContext({outlet:null,matches:[],isDataRoute:!1});const q=t.createContext(null);function Y(){return null!=t.useContext(K)}function J(){return Y()||a(!1),t.useContext(K).location}function X(e){t.useContext(H).static||t.useLayoutEffect(e)}function Q(){let{isDataRoute:e}=t.useContext(z);return e?function(){let{router:e}=ae(oe.UseNavigateStable),n=le(se.UseNavigateStable),i=t.useRef(!1);return X((()=>{i.current=!0})),t.useCallback((function(t,r){void 0===r&&(r={}),i.current&&("number"===typeof t?e.navigate(t):e.navigate(t,B({fromRouteId:n},r)))}),[e,n])}():function(){Y()||a(!1);let e=t.useContext(G),{basename:n,future:i,navigator:r}=t.useContext(H),{matches:o}=t.useContext(z),{pathname:s}=J(),c=JSON.stringify(P(o,i.v7_relativeSplatPath)),l=t.useRef(!1);return X((()=>{l.current=!0})),t.useCallback((function(t,i){if(void 0===i&&(i={}),!l.current)return;if("number"===typeof t)return void r.go(t);let o=k(t,JSON.parse(c),s,"path"===i.relative);null==e&&"/"!==n&&(o.pathname="/"===o.pathname?n:L([n,o.pathname])),(i.replace?r.replace:r.push)(o,i.state,i)}),[n,r,c,s,e])}()}function Z(e,n){let{relative:i}=void 0===n?{}:n,{future:r}=t.useContext(H),{matches:o}=t.useContext(z),{pathname:s}=J(),a=JSON.stringify(P(o,r.v7_relativeSplatPath));return t.useMemo((()=>k(e,JSON.parse(a),s,"path"===i)),[e,a,s,i])}function $(n,i,r,o){Y()||a(!1);let{navigator:s}=t.useContext(H),{matches:c}=t.useContext(z),l=c[c.length-1],d=l?l.params:{},u=(l&&l.pathname,l?l.pathnameBase:"/");l&&l.route;let p,f=J();if(i){var _;let e="string"===typeof i?h(i):i;"/"===u||(null==(_=e.pathname)?void 0:_.startsWith(u))||a(!1),p=e}else p=f;let E=p.pathname||"/",g=E;if("/"!==u){let e=u.replace(/^\//,"").split("/");g="/"+E.replace(/^\//,"").split("/").slice(e.length).join("/")}let v=m(n,{pathname:g});let T=re(v&&v.map((e=>Object.assign({},e,{params:Object.assign({},d,e.params),pathname:L([u,s.encodeLocation?s.encodeLocation(e.pathname).pathname:e.pathname]),pathnameBase:"/"===e.pathnameBase?u:L([u,s.encodeLocation?s.encodeLocation(e.pathnameBase).pathname:e.pathnameBase])}))),c,r,o);return i&&T?t.createElement(K.Provider,{value:{location:B({pathname:"/",search:"",hash:"",state:null,key:"default"},p),navigationType:e.Pop}},T):T}function ee(){let e=function(){var e;let n=t.useContext(q),i=ce(se.UseRouteError),r=le(se.UseRouteError);if(void 0!==n)return n;return null==(e=i.errors)?void 0:e[r]}(),n=V(e)?e.status+" "+e.statusText:e instanceof Error?e.message:JSON.stringify(e),i=e instanceof Error?e.stack:null,r="rgba(200,200,200, 0.5)",o={padding:"0.5rem",backgroundColor:r};return t.createElement(t.Fragment,null,t.createElement("h2",null,"Unexpected Application Error!"),t.createElement("h3",{style:{fontStyle:"italic"}},n),i?t.createElement("pre",{style:o},i):null,null)}const te=t.createElement(ee,null);class ne extends t.Component{constructor(e){super(e),this.state={location:e.location,revalidation:e.revalidation,error:e.error}}static getDerivedStateFromError(e){return{error:e}}static getDerivedStateFromProps(e,t){return t.location!==e.location||"idle"!==t.revalidation&&"idle"===e.revalidation?{error:e.error,location:e.location,revalidation:e.revalidation}:{error:void 0!==e.error?e.error:t.error,location:t.location,revalidation:e.revalidation||t.revalidation}}componentDidCatch(e,t){console.error("React Router caught the following error during render",e,t)}render(){return void 0!==this.state.error?t.createElement(z.Provider,{value:this.props.routeContext},t.createElement(q.Provider,{value:this.state.error,children:this.props.component})):this.props.children}}function ie(e){let{routeContext:n,match:i,children:r}=e,o=t.useContext(G);return o&&o.static&&o.staticContext&&(i.route.errorElement||i.route.ErrorBoundary)&&(o.staticContext._deepestRenderedBoundaryId=i.route.id),t.createElement(z.Provider,{value:n},r)}function re(e,n,i,r){var o;if(void 0===n&&(n=[]),void 0===i&&(i=null),void 0===r&&(r=null),null==e){var s;if(null==(s=i)||!s.errors)return null;e=i.matches}let c=e,l=null==(o=i)?void 0:o.errors;if(null!=l){let e=c.findIndex((e=>e.route.id&&void 0!==(null==l?void 0:l[e.route.id])));e>=0||a(!1),c=c.slice(0,Math.min(c.length,e+1))}let d=!1,u=-1;if(i&&r&&r.v7_partialHydration)for(let t=0;t<c.length;t++){let e=c[t];if((e.route.HydrateFallback||e.route.hydrateFallbackElement)&&(u=t),e.route.id){let{loaderData:t,errors:n}=i,r=e.route.loader&&void 0===t[e.route.id]&&(!n||void 0===n[e.route.id]);if(e.route.lazy||r){d=!0,c=u>=0?c.slice(0,u+1):[c[0]];break}}}return c.reduceRight(((e,r,o)=>{let s,a=!1,h=null,p=null;var f;i&&(s=l&&r.route.id?l[r.route.id]:void 0,h=r.route.errorElement||te,d&&(u<0&&0===o?(f="route-fallback",!1||de[f]||(de[f]=!0),a=!0,p=null):u===o&&(a=!0,p=r.route.hydrateFallbackElement||null)));let m=n.concat(c.slice(0,o+1)),_=()=>{let n;return n=s?h:a?p:r.route.Component?t.createElement(r.route.Component,null):r.route.element?r.route.element:e,t.createElement(ie,{match:r,routeContext:{outlet:e,matches:m,isDataRoute:null!=i},children:n})};return i&&(r.route.ErrorBoundary||r.route.errorElement||0===o)?t.createElement(ne,{location:i.location,revalidation:i.revalidation,component:h,error:s,children:_(),routeContext:{outlet:null,matches:m,isDataRoute:!0}}):_()}),null)}var oe=function(e){return e.UseBlocker="useBlocker",e.UseRevalidator="useRevalidator",e.UseNavigateStable="useNavigate",e}(oe||{}),se=function(e){return e.UseBlocker="useBlocker",e.UseLoaderData="useLoaderData",e.UseActionData="useActionData",e.UseRouteError="useRouteError",e.UseNavigation="useNavigation",e.UseRouteLoaderData="useRouteLoaderData",e.UseMatches="useMatches",e.UseRevalidator="useRevalidator",e.UseNavigateStable="useNavigate",e.UseRouteId="useRouteId",e}(se||{});function ae(e){let n=t.useContext(G);return n||a(!1),n}function ce(e){let n=t.useContext(W);return n||a(!1),n}function le(e){let n=function(e){let n=t.useContext(z);return n||a(!1),n}(),i=n.matches[n.matches.length-1];return i.route.id||a(!1),i.route.id}const de={};i.startTransition;function ue(e){let{to:n,replace:i,state:r,relative:o}=e;Y()||a(!1);let{future:s,static:c}=t.useContext(H),{matches:l}=t.useContext(z),{pathname:d}=J(),u=Q(),h=k(n,P(l,s.v7_relativeSplatPath),d,"path"===o),p=JSON.stringify(h);return t.useEffect((()=>u(JSON.parse(p),{replace:i,state:r,relative:o})),[u,p,o,i,r]),null}function he(e){a(!1)}function pe(n){let{basename:i="/",children:r=null,location:o,navigationType:s=e.Pop,navigator:c,static:l=!1,future:d}=n;Y()&&a(!1);let u=i.replace(/^\/*/,"/"),p=t.useMemo((()=>({basename:u,navigator:c,static:l,future:B({v7_relativeSplatPath:!1},d)})),[u,d,c,l]);"string"===typeof o&&(o=h(o));let{pathname:f="/",search:m="",hash:_="",state:E=null,key:g="default"}=o,v=t.useMemo((()=>{let e=O(f,u);return null==e?null:{location:{pathname:e,search:m,hash:_,state:E,key:g},navigationType:s}}),[u,f,m,_,E,g,s]);return null==v?null:t.createElement(H.Provider,{value:p},t.createElement(K.Provider,{children:r,value:v}))}function fe(e){let{children:t,location:n}=e;return $(me(t),n)}new Promise((()=>{}));t.Component;function me(e,n){void 0===n&&(n=[]);let i=[];return t.Children.forEach(e,((e,r)=>{if(!t.isValidElement(e))return;let o=[...n,r];if(e.type===t.Fragment)return void i.push.apply(i,me(e.props.children,o));e.type!==he&&a(!1),e.props.index&&e.props.children&&a(!1);let s={id:e.props.id||o.join("-"),caseSensitive:e.props.caseSensitive,element:e.props.element,Component:e.props.Component,index:e.props.index,path:e.props.path,loader:e.props.loader,action:e.props.action,errorElement:e.props.errorElement,ErrorBoundary:e.props.ErrorBoundary,hasErrorBoundary:null!=e.props.ErrorBoundary||null!=e.props.errorElement,shouldRevalidate:e.props.shouldRevalidate,handle:e.props.handle,lazy:e.props.lazy};e.props.children&&(s.children=me(e.props.children,o)),i.push(s)})),i}var _e=n(950),Ee=n.t(_e,2);function ge(){return ge=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},ge.apply(this,arguments)}function ve(e,t){if(null==e)return{};var n,i,r={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}new Set(["application/x-www-form-urlencoded","multipart/form-data","text/plain"]);const Te=["onClick","relative","reloadDocument","replace","state","target","to","preventScrollReset","unstable_viewTransition"];try{window.__reactRouterVersion="6"}catch(Dm){}new Map;const Se=i.startTransition;Ee.flushSync,i.useId;function ye(e){let{basename:n,children:i,future:r,window:o}=e,s=t.useRef();var a;null==s.current&&(s.current=(void 0===(a={window:o,v5Compat:!0})&&(a={}),p((function(e,t){let{pathname:n,search:i,hash:r}=e.location;return d("",{pathname:n,search:i,hash:r},t.state&&t.state.usr||null,t.state&&t.state.key||"default")}),(function(e,t){return"string"===typeof t?t:u(t)}),null,a)));let c=s.current,[l,h]=t.useState({action:c.action,location:c.location}),{v7_startTransition:f}=r||{},m=t.useCallback((e=>{f&&Se?Se((()=>h(e))):h(e)}),[h,f]);return t.useLayoutEffect((()=>c.listen(m)),[c,m]),t.createElement(pe,{basename:n,children:i,location:l.location,navigationType:l.action,navigator:c,future:r})}const Ce="undefined"!==typeof window&&"undefined"!==typeof window.document&&"undefined"!==typeof window.document.createElement,Re=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,we=t.forwardRef((function(e,n){let i,{onClick:r,relative:o,reloadDocument:s,replace:c,state:l,target:d,to:h,preventScrollReset:p,unstable_viewTransition:f}=e,m=ve(e,Te),{basename:_}=t.useContext(H),E=!1;if("string"===typeof h&&Re.test(h)&&(i=h,Ce))try{let e=new URL(window.location.href),t=h.startsWith("//")?new URL(e.protocol+h):new URL(h),n=O(t.pathname,_);t.origin===e.origin&&null!=n?h=n+t.search+t.hash:E=!0}catch(Dm){}let g=function(e,n){let{relative:i}=void 0===n?{}:n;Y()||a(!1);let{basename:r,navigator:o}=t.useContext(H),{hash:s,pathname:c,search:l}=Z(e,{relative:i}),d=c;return"/"!==r&&(d="/"===c?r:L([r,c])),o.createHref({pathname:d,search:l,hash:s})}(h,{relative:o}),v=function(e,n){let{target:i,replace:r,state:o,preventScrollReset:s,relative:a,unstable_viewTransition:c}=void 0===n?{}:n,l=Q(),d=J(),h=Z(e,{relative:a});return t.useCallback((t=>{if(function(e,t){return 0===e.button&&(!t||"_self"===t)&&!function(e){return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}(e)}(t,i)){t.preventDefault();let n=void 0!==r?r:u(d)===u(h);l(e,{replace:n,state:o,preventScrollReset:s,relative:a,unstable_viewTransition:c})}}),[d,l,h,r,o,i,e,s,a,c])}(h,{replace:c,state:l,target:d,preventScrollReset:p,relative:o,unstable_viewTransition:f});return t.createElement("a",ge({},m,{href:i||g,onClick:E||s?r:function(e){r&&r(e),e.defaultPrevented||v(e)},ref:n,target:d}))}));var Ie,be;(function(e){e.UseScrollRestoration="useScrollRestoration",e.UseSubmit="useSubmit",e.UseSubmitFetcher="useSubmitFetcher",e.UseFetcher="useFetcher",e.useViewTransitionState="useViewTransitionState"})(Ie||(Ie={})),function(e){e.UseFetcher="useFetcher",e.UseFetchers="useFetchers",e.UseScrollRestoration="useScrollRestoration"}(be||(be={}));const Ae=function(e){const t=[];let n=0;for(let i=0;i<e.length;i++){let r=e.charCodeAt(i);r<128?t[n++]=r:r<2048?(t[n++]=r>>6|192,t[n++]=63&r|128):55296===(64512&r)&&i+1<e.length&&56320===(64512&e.charCodeAt(i+1))?(r=65536+((1023&r)<<10)+(1023&e.charCodeAt(++i)),t[n++]=r>>18|240,t[n++]=r>>12&63|128,t[n++]=r>>6&63|128,t[n++]=63&r|128):(t[n++]=r>>12|224,t[n++]=r>>6&63|128,t[n++]=63&r|128)}return t},Oe={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"===typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let r=0;r<e.length;r+=3){const t=e[r],o=r+1<e.length,s=o?e[r+1]:0,a=r+2<e.length,c=a?e[r+2]:0,l=t>>2,d=(3&t)<<4|s>>4;let u=(15&s)<<2|c>>6,h=63&c;a||(h=64,o||(u=64)),i.push(n[l],n[d],n[u],n[h])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(Ae(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,i=0;for(;n<e.length;){const r=e[n++];if(r<128)t[i++]=String.fromCharCode(r);else if(r>191&&r<224){const o=e[n++];t[i++]=String.fromCharCode((31&r)<<6|63&o)}else if(r>239&&r<365){const o=((7&r)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;t[i++]=String.fromCharCode(55296+(o>>10)),t[i++]=String.fromCharCode(56320+(1023&o))}else{const o=e[n++],s=e[n++];t[i++]=String.fromCharCode((15&r)<<12|(63&o)<<6|63&s)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let r=0;r<e.length;){const t=n[e.charAt(r++)],o=r<e.length?n[e.charAt(r)]:0;++r;const s=r<e.length?n[e.charAt(r)]:64;++r;const a=r<e.length?n[e.charAt(r)]:64;if(++r,null==t||null==o||null==s||null==a)throw new Ne;const c=t<<2|o>>4;if(i.push(c),64!==s){const e=o<<4&240|s>>2;if(i.push(e),64!==a){const e=s<<6&192|a;i.push(e)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class Ne extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const De=function(e){return function(e){const t=Ae(e);return Oe.encodeByteArray(t,!0)}(e).replace(/\./g,"")},Pe=function(e){try{return Oe.decodeString(e,!0)}catch(Dm){console.error("base64Decode failed: ",Dm)}return null};const ke=()=>function(){if("undefined"!==typeof self)return self;if("undefined"!==typeof window)return window;if("undefined"!==typeof n.g)return n.g;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,Le=()=>{try{return ke()||(()=>{if("undefined"===typeof process)return;const e={NODE_ENV:"production",PUBLIC_URL:"/chat-app",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0})()||(()=>{if("undefined"===typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(Dm){return}const t=e&&Pe(e[1]);return t&&JSON.parse(t)})()}catch(Dm){return void console.info("Unable to get __FIREBASE_DEFAULTS__ due to: ".concat(Dm))}},Me=e=>{var t,n;return null===(n=null===(t=Le())||void 0===t?void 0:t.emulatorHosts)||void 0===n?void 0:n[e]},Ue=e=>{const t=Me(e);if(!t)return;const n=t.lastIndexOf(":");if(n<=0||n+1===t.length)throw new Error("Invalid host ".concat(t," with no separate hostname and port!"));const i=parseInt(t.substring(n+1),10);return"["===t[0]?[t.substring(1,n-1),i]:[t.substring(0,n),i]},xe=()=>{var e;return null===(e=Le())||void 0===e?void 0:e.config},Ve=e=>{var t;return null===(t=Le())||void 0===t?void 0:t["_".concat(e)]};class Fe{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}wrapCallback(e){return(t,n)=>{t?this.reject(t):this.resolve(n),"function"===typeof e&&(this.promise.catch((()=>{})),1===e.length?e(t):e(t,n))}}}function je(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=t||"demo-project",i=e.iat||0,r=e.sub||e.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o=Object.assign({iss:"https://securetoken.google.com/".concat(n),aud:n,iat:i,exp:i+3600,auth_time:i,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},e);return[De(JSON.stringify({alg:"none",type:"JWT"})),De(JSON.stringify(o)),""].join(".")}function Be(){return"undefined"!==typeof navigator&&"string"===typeof navigator.userAgent?navigator.userAgent:""}function Ge(){return!function(){var e;const t=null===(e=Le())||void 0===e?void 0:e.forceEnvironment;if("node"===t)return!0;if("browser"===t)return!1;try{return"[object process]"===Object.prototype.toString.call(n.g.process)}catch(Dm){return!1}}()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function We(){try{return"object"===typeof indexedDB}catch(Dm){return!1}}class He extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,He.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,Ke.prototype.create)}}class Ke{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e){const t=(arguments.length<=1?void 0:arguments[1])||{},n="".concat(this.service,"/").concat(e),i=this.errors[e],r=i?function(e,t){return e.replace(ze,((e,n)=>{const i=t[n];return null!=i?String(i):"<".concat(n,"?>")}))}(i,t):"Error",o="".concat(this.serviceName,": ").concat(r," (").concat(n,").");return new He(n,o,t)}}const ze=/\{\$([^}]+)}/g;function qe(e,t){if(e===t)return!0;const n=Object.keys(e),i=Object.keys(t);for(const r of n){if(!i.includes(r))return!1;const n=e[r],o=t[r];if(Ye(n)&&Ye(o)){if(!qe(n,o))return!1}else if(n!==o)return!1}for(const r of i)if(!n.includes(r))return!1;return!0}function Ye(e){return null!==e&&"object"===typeof e}function Je(e){const t=[];for(const[n,i]of Object.entries(e))Array.isArray(i)?i.forEach((e=>{t.push(encodeURIComponent(n)+"="+encodeURIComponent(e))})):t.push(encodeURIComponent(n)+"="+encodeURIComponent(i));return t.length?"&"+t.join("&"):""}function Xe(e){const t={};return e.replace(/^\?/,"").split("&").forEach((e=>{if(e){const[n,i]=e.split("=");t[decodeURIComponent(n)]=decodeURIComponent(i)}})),t}function Qe(e){const t=e.indexOf("?");if(!t)return"";const n=e.indexOf("#",t);return e.substring(t,n>0?n:void 0)}class Ze{constructor(e,t){this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then((()=>{e(this)})).catch((e=>{this.error(e)}))}next(e){this.forEachObserver((t=>{t.next(e)}))}error(e){this.forEachObserver((t=>{t.error(e)})),this.close(e)}complete(){this.forEachObserver((e=>{e.complete()})),this.close()}subscribe(e,t,n){let i;if(void 0===e&&void 0===t&&void 0===n)throw new Error("Missing Observer.");i=function(e,t){if("object"!==typeof e||null===e)return!1;for(const n of t)if(n in e&&"function"===typeof e[n])return!0;return!1}(e,["next","error","complete"])?e:{next:e,error:t,complete:n},void 0===i.next&&(i.next=$e),void 0===i.error&&(i.error=$e),void 0===i.complete&&(i.complete=$e);const r=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then((()=>{try{this.finalError?i.error(this.finalError):i.complete()}catch(Dm){}})),this.observers.push(i),r}unsubscribeOne(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))}forEachObserver(e){if(!this.finalized)for(let t=0;t<this.observers.length;t++)this.sendOne(t,e)}sendOne(e,t){this.task.then((()=>{if(void 0!==this.observers&&void 0!==this.observers[e])try{t(this.observers[e])}catch(Dm){"undefined"!==typeof console&&console.error&&console.error(Dm)}}))}close(e){this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then((()=>{this.observers=void 0,this.onNoObservers=void 0})))}}function $e(){}function et(e){return e&&e._delegate?e._delegate:e}class tt{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const nt="[DEFAULT]";class it{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const e=new Fe;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:t});n&&e.resolve(n)}catch(Dm){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const n=this.normalizeInstanceIdentifier(null===e||void 0===e?void 0:e.identifier),i=null!==(t=null===e||void 0===e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(i)return null;throw Error("Service ".concat(this.name," is not available"))}try{return this.getOrInitializeService({instanceIdentifier:n})}catch(Dm){if(i)return null;throw Dm}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error("Mismatching Component ".concat(e.name," for Provider ").concat(this.name,"."));if(this.component)throw Error("Component for ".concat(this.name," has already been provided"));if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:nt})}catch(Dm){}for(const[e,t]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const e=this.getOrInitializeService({instanceIdentifier:n});t.resolve(e)}catch(Dm){}}}}clearInstance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:nt;this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter((e=>"INTERNAL"in e)).map((e=>e.INTERNAL.delete())),...e.filter((e=>"_delete"in e)).map((e=>e._delete()))])}isComponentSet(){return null!=this.component}isInitialized(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:nt;return this.instances.has(e)}getOptions(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:nt;return this.instancesOptions.get(e)||{}}initialize(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{options:t={}}=e,n=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(n))throw Error("".concat(this.name,"(").concat(n,") has already been initialized"));if(!this.isComponentSet())throw Error("Component ".concat(this.name," has not been registered yet"));const i=this.getOrInitializeService({instanceIdentifier:n,options:t});for(const[r,o]of this.instancesDeferred.entries()){n===this.normalizeInstanceIdentifier(r)&&o.resolve(i)}return i}onInit(e,t){var n;const i=this.normalizeInstanceIdentifier(t),r=null!==(n=this.onInitCallbacks.get(i))&&void 0!==n?n:new Set;r.add(e),this.onInitCallbacks.set(i,r);const o=this.instances.get(i);return o&&e(o,i),()=>{r.delete(e)}}invokeOnInitCallbacks(e,t){const n=this.onInitCallbacks.get(t);if(n)for(const r of n)try{r(e,t)}catch(i){}}getOrInitializeService(e){let{instanceIdentifier:t,options:n={}}=e,i=this.instances.get(t);if(!i&&this.component&&(i=this.component.instanceFactory(this.container,{instanceIdentifier:(r=t,r===nt?void 0:r),options:n}),this.instances.set(t,i),this.instancesOptions.set(t,n),this.invokeOnInitCallbacks(i,t),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,t,i)}catch(o){}var r;return i||null}normalizeInstanceIdentifier(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:nt;return this.component?this.component.multipleInstances?e:nt:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class rt{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error("Component ".concat(e.name," has already been registered with ").concat(this.name));t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new it(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}const ot=[];var st;!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(st||(st={}));const at={debug:st.DEBUG,verbose:st.VERBOSE,info:st.INFO,warn:st.WARN,error:st.ERROR,silent:st.SILENT},ct=st.INFO,lt={[st.DEBUG]:"log",[st.VERBOSE]:"log",[st.INFO]:"info",[st.WARN]:"warn",[st.ERROR]:"error"},dt=function(e,t){if(t<e.logLevel)return;const n=(new Date).toISOString(),i=lt[t];if(!i)throw new Error("Attempted to log a message with an invalid logType (value: ".concat(t,")"));for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];console[i]("[".concat(n,"]  ").concat(e.name,":"),...o)};class ut{constructor(e){this.name=e,this._logLevel=ct,this._logHandler=dt,this._userLogHandler=null,ot.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in st))throw new TypeError('Invalid value "'.concat(e,'" assigned to `logLevel`'));this._logLevel=e}setLogLevel(e){this._logLevel="string"===typeof e?at[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!==typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler(this,st.DEBUG,...t),this._logHandler(this,st.DEBUG,...t)}log(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler(this,st.VERBOSE,...t),this._logHandler(this,st.VERBOSE,...t)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler(this,st.INFO,...t),this._logHandler(this,st.INFO,...t)}warn(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler(this,st.WARN,...t),this._logHandler(this,st.WARN,...t)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this._userLogHandler&&this._userLogHandler(this,st.ERROR,...t),this._logHandler(this,st.ERROR,...t)}}const ht=(e,t)=>t.some((t=>e instanceof t));let pt,ft;const mt=new WeakMap,_t=new WeakMap,Et=new WeakMap,gt=new WeakMap,vt=new WeakMap;let Tt={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return _t.get(e);if("objectStoreNames"===t)return e.objectStoreNames||Et.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return Ct(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function St(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(ft||(ft=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return e.apply(Rt(this),n),Ct(mt.get(this))}:function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return Ct(e.apply(Rt(this),n))}:function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];const o=e.call(Rt(this),t,...i);return Et.set(o,t.sort?t.sort():[t]),Ct(o)}}function yt(e){return"function"===typeof e?St(e):(e instanceof IDBTransaction&&function(e){if(_t.has(e))return;const t=new Promise(((t,n)=>{const i=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",o),e.removeEventListener("abort",o)},r=()=>{t(),i()},o=()=>{n(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",r),e.addEventListener("error",o),e.addEventListener("abort",o)}));_t.set(e,t)}(e),ht(e,pt||(pt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,Tt):e)}function Ct(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const i=()=>{e.removeEventListener("success",r),e.removeEventListener("error",o)},r=()=>{t(Ct(e.result)),i()},o=()=>{n(e.error),i()};e.addEventListener("success",r),e.addEventListener("error",o)}));return t.then((t=>{t instanceof IDBCursor&&mt.set(t,e)})).catch((()=>{})),vt.set(t,e),t}(e);if(gt.has(e))return gt.get(e);const t=yt(e);return t!==e&&(gt.set(e,t),vt.set(t,e)),t}const Rt=e=>vt.get(e);const wt=["get","getKey","getAll","getAllKeys","count"],It=["put","add","delete","clear"],bt=new Map;function At(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!==typeof t)return;if(bt.get(t))return bt.get(t);const n=t.replace(/FromIndex$/,""),i=t!==n,r=It.includes(n);if(!(n in(i?IDBIndex:IDBObjectStore).prototype)||!r&&!wt.includes(n))return;const o=async function(e){const t=this.transaction(e,r?"readwrite":"readonly");let o=t.store;for(var s=arguments.length,a=new Array(s>1?s-1:0),c=1;c<s;c++)a[c-1]=arguments[c];return i&&(o=o.index(a.shift())),(await Promise.all([o[n](...a),r&&t.done]))[0]};return bt.set(t,o),o}Tt=(e=>({...e,get:(t,n,i)=>At(t,n)||e.get(t,n,i),has:(t,n)=>!!At(t,n)||e.has(t,n)}))(Tt);class Ot{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map((e=>{if(function(e){const t=e.getComponent();return"VERSION"===(null===t||void 0===t?void 0:t.type)}(e)){const t=e.getImmediate();return"".concat(t.library,"/").concat(t.version)}return null})).filter((e=>e)).join(" ")}}const Nt="@firebase/app",Dt="0.10.5",Pt=new ut("@firebase/app"),kt="@firebase/app-compat",Lt="@firebase/analytics-compat",Mt="@firebase/analytics",Ut="@firebase/app-check-compat",xt="@firebase/app-check",Vt="@firebase/auth",Ft="@firebase/auth-compat",jt="@firebase/database",Bt="@firebase/database-compat",Gt="@firebase/functions",Wt="@firebase/functions-compat",Ht="@firebase/installations",Kt="@firebase/installations-compat",zt="@firebase/messaging",qt="@firebase/messaging-compat",Yt="@firebase/performance",Jt="@firebase/performance-compat",Xt="@firebase/remote-config",Qt="@firebase/remote-config-compat",Zt="@firebase/storage",$t="@firebase/storage-compat",en="@firebase/firestore",tn="@firebase/vertexai-preview",nn="@firebase/firestore-compat",rn="firebase",on="[DEFAULT]",sn={[Nt]:"fire-core",[kt]:"fire-core-compat",[Mt]:"fire-analytics",[Lt]:"fire-analytics-compat",[xt]:"fire-app-check",[Ut]:"fire-app-check-compat",[Vt]:"fire-auth",[Ft]:"fire-auth-compat",[jt]:"fire-rtdb",[Bt]:"fire-rtdb-compat",[Gt]:"fire-fn",[Wt]:"fire-fn-compat",[Ht]:"fire-iid",[Kt]:"fire-iid-compat",[zt]:"fire-fcm",[qt]:"fire-fcm-compat",[Yt]:"fire-perf",[Jt]:"fire-perf-compat",[Xt]:"fire-rc",[Qt]:"fire-rc-compat",[Zt]:"fire-gcs",[$t]:"fire-gcs-compat",[en]:"fire-fst",[nn]:"fire-fst-compat",[tn]:"fire-vertex","fire-js":"fire-js",[rn]:"fire-js-all"},an=new Map,cn=new Map,ln=new Map;function dn(e,t){try{e.container.addComponent(t)}catch(Dm){Pt.debug("Component ".concat(t.name," failed to register with FirebaseApp ").concat(e.name),Dm)}}function un(e){const t=e.name;if(ln.has(t))return Pt.debug("There were multiple attempts to register component ".concat(t,".")),!1;ln.set(t,e);for(const n of an.values())dn(n,e);for(const n of cn.values())dn(n,e);return!0}function hn(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}function pn(e){return void 0!==e.settings}const fn=new Ke("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."});class mn{constructor(e,t,n){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new tt("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw fn.create("app-deleted",{appName:this._name})}}const _n="10.12.2";function En(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e;if("object"!==typeof t){t={name:t}}const i=Object.assign({name:on,automaticDataCollectionEnabled:!1},t),r=i.name;if("string"!==typeof r||!r)throw fn.create("bad-app-name",{appName:String(r)});if(n||(n=xe()),!n)throw fn.create("no-options");const o=an.get(r);if(o){if(qe(n,o.options)&&qe(i,o.config))return o;throw fn.create("duplicate-app",{appName:r})}const s=new rt(r);for(const c of ln.values())s.addComponent(c);const a=new mn(n,i,s);return an.set(r,a),a}function gn(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:on;const t=an.get(e);if(!t&&e===on&&xe())return En();if(!t)throw fn.create("no-app",{appName:e});return t}function vn(e,t,n){var i;let r=null!==(i=sn[e])&&void 0!==i?i:e;n&&(r+="-".concat(n));const o=r.match(/\s|\//),s=t.match(/\s|\//);if(o||s){const e=['Unable to register library "'.concat(r,'" with version "').concat(t,'":')];return o&&e.push('library name "'.concat(r,'" contains illegal characters (whitespace or "/")')),o&&s&&e.push("and"),s&&e.push('version name "'.concat(t,'" contains illegal characters (whitespace or "/")')),void Pt.warn(e.join(" "))}un(new tt("".concat(r,"-version"),(()=>({library:r,version:t})),"VERSION"))}const Tn="firebase-heartbeat-database",Sn=1,yn="firebase-heartbeat-store";let Cn=null;function Rn(){return Cn||(Cn=function(e,t){let{blocked:n,upgrade:i,blocking:r,terminated:o}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const s=indexedDB.open(e,t),a=Ct(s);return i&&s.addEventListener("upgradeneeded",(e=>{i(Ct(s.result),e.oldVersion,e.newVersion,Ct(s.transaction),e)})),n&&s.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),a.then((e=>{o&&e.addEventListener("close",(()=>o())),r&&e.addEventListener("versionchange",(e=>r(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}(Tn,Sn,{upgrade:(e,t)=>{if(0===t)try{e.createObjectStore(yn)}catch(Dm){console.warn(Dm)}}}).catch((e=>{throw fn.create("idb-open",{originalErrorMessage:e.message})}))),Cn}async function wn(e,t){try{const n=(await Rn()).transaction(yn,"readwrite"),i=n.objectStore(yn);await i.put(t,In(e)),await n.done}catch(Dm){if(Dm instanceof He)Pt.warn(Dm.message);else{const t=fn.create("idb-set",{originalErrorMessage:null===Dm||void 0===Dm?void 0:Dm.message});Pt.warn(t.message)}}}function In(e){return"".concat(e.name,"!").concat(e.options.appId)}class bn{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new On(t),this._heartbeatsCachePromise=this._storage.read().then((e=>(this._heartbeatsCache=e,e)))}async triggerHeartbeat(){var e,t;const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),i=An();if((null!=(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||(this._heartbeatsCache=await this._heartbeatsCachePromise,null!=(null===(t=this._heartbeatsCache)||void 0===t?void 0:t.heartbeats)))&&this._heartbeatsCache.lastSentHeartbeatDate!==i&&!this._heartbeatsCache.heartbeats.some((e=>e.date===i)))return this._heartbeatsCache.heartbeats.push({date:i,agent:n}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((e=>{const t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){var e;if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null==(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||0===this._heartbeatsCache.heartbeats.length)return"";const t=An(),{heartbeatsToSend:n,unsentEntries:i}=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1024;const n=[];let i=e.slice();for(const r of e){const e=n.find((e=>e.agent===r.agent));if(e){if(e.dates.push(r.date),Nn(n)>t){e.dates.pop();break}}else if(n.push({agent:r.agent,dates:[r.date]}),Nn(n)>t){n.pop();break}i=i.slice(1)}return{heartbeatsToSend:n,unsentEntries:i}}(this._heartbeatsCache.heartbeats),r=De(JSON.stringify({version:2,heartbeats:n}));return this._heartbeatsCache.lastSentHeartbeatDate=t,i.length>0?(this._heartbeatsCache.heartbeats=i,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}}function An(){return(new Date).toISOString().substring(0,10)}class On{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!We()&&new Promise(((e,t)=>{try{let n=!0;const i="validate-browser-context-for-indexeddb-analytics-module",r=self.indexedDB.open(i);r.onsuccess=()=>{r.result.close(),n||self.indexedDB.deleteDatabase(i),e(!0)},r.onupgradeneeded=()=>{n=!1},r.onerror=()=>{var e;t((null===(e=r.error)||void 0===e?void 0:e.message)||"")}}catch(n){t(n)}})).then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){const e=await async function(e){try{const t=(await Rn()).transaction(yn),n=await t.objectStore(yn).get(In(e));return await t.done,n}catch(Dm){if(Dm instanceof He)Pt.warn(Dm.message);else{const t=fn.create("idb-get",{originalErrorMessage:null===Dm||void 0===Dm?void 0:Dm.message});Pt.warn(t.message)}}}(this.app);return(null===e||void 0===e?void 0:e.heartbeats)?e:{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return wn(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return wn(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...e.heartbeats]})}}}function Nn(e){return De(JSON.stringify({version:2,heartbeats:e})).length}var Dn;Dn="",un(new tt("platform-logger",(e=>new Ot(e)),"PRIVATE")),un(new tt("heartbeat",(e=>new bn(e)),"PRIVATE")),vn(Nt,Dt,Dn),vn(Nt,Dt,"esm2017"),vn("fire-js","");function Pn(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"===typeof Object.getOwnPropertySymbols){var r=0;for(i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]])}return n}Object.create;Object.create;"function"===typeof SuppressedError&&SuppressedError;function kn(){return{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}}const Ln=kn,Mn=new Ke("auth","Firebase",{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}),Un=new ut("@firebase/auth");function xn(e){if(Un.logLevel<=st.ERROR){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];Un.error("Auth (".concat(_n,"): ").concat(e),...n)}}function Vn(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];throw Gn(e,...n)}function Fn(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return Gn(e,...n)}function jn(e,t,n){const i=Object.assign(Object.assign({},Ln()),{[t]:n});return new Ke("auth","Firebase",i).create(t,{appName:e.name})}function Bn(e){return jn(e,"operation-not-supported-in-this-environment","Operations that alter the current user are not supported in conjunction with FirebaseServerApp")}function Gn(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if("string"!==typeof e){const t=n[0],i=[...n.slice(1)];return i[0]&&(i[0].appName=e.name),e._errorFactory.create(t,...i)}return Mn.create(e,...n)}function Wn(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];throw Gn(t,...i)}}function Hn(e){const t="INTERNAL ASSERTION FAILED: "+e;throw xn(t),new Error(t)}function Kn(e,t){e||Hn(t)}function zn(){var e;return"undefined"!==typeof self&&(null===(e=self.location)||void 0===e?void 0:e.href)||""}function qn(){return"http:"===Yn()||"https:"===Yn()}function Yn(){var e;return"undefined"!==typeof self&&(null===(e=self.location)||void 0===e?void 0:e.protocol)||null}function Jn(){return!("undefined"!==typeof navigator&&navigator&&"onLine"in navigator&&"boolean"===typeof navigator.onLine&&(qn()||function(){const e="object"===typeof chrome?chrome.runtime:"object"===typeof browser?browser.runtime:void 0;return"object"===typeof e&&void 0!==e.id}()||"connection"in navigator))||navigator.onLine}class Xn{constructor(e,t){this.shortDelay=e,this.longDelay=t,Kn(t>e,"Short delay should be less than long delay!"),this.isMobile="undefined"!==typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(Be())||"object"===typeof navigator&&"ReactNative"===navigator.product}get(){return Jn()?this.isMobile?this.longDelay:this.shortDelay:Math.min(5e3,this.shortDelay)}}function Qn(e,t){Kn(e.emulator,"Emulator should always be set here");const{url:n}=e.emulator;return t?"".concat(n).concat(t.startsWith("/")?t.slice(1):t):n}class Zn{static initialize(e,t,n){this.fetchImpl=e,t&&(this.headersImpl=t),n&&(this.responseImpl=n)}static fetch(){return this.fetchImpl?this.fetchImpl:"undefined"!==typeof self&&"fetch"in self?self.fetch:"undefined"!==typeof globalThis&&globalThis.fetch?globalThis.fetch:"undefined"!==typeof fetch?fetch:void Hn("Could not find fetch implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static headers(){return this.headersImpl?this.headersImpl:"undefined"!==typeof self&&"Headers"in self?self.Headers:"undefined"!==typeof globalThis&&globalThis.Headers?globalThis.Headers:"undefined"!==typeof Headers?Headers:void Hn("Could not find Headers implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static response(){return this.responseImpl?this.responseImpl:"undefined"!==typeof self&&"Response"in self?self.Response:"undefined"!==typeof globalThis&&globalThis.Response?globalThis.Response:"undefined"!==typeof Response?Response:void Hn("Could not find Response implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}}const $n={CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_PASSWORD:"wrong-password",MISSING_PASSWORD:"missing-password",INVALID_LOGIN_CREDENTIALS:"invalid-credential",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_REQ_TYPE:"internal-error",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",PASSWORD_DOES_NOT_MEET_REQUIREMENTS:"password-does-not-meet-requirements",INVALID_CODE:"invalid-verification-code",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_SESSION_INFO:"missing-verification-id",SESSION_EXPIRED:"code-expired",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",ADMIN_ONLY_OPERATION:"admin-restricted-operation",INVALID_MFA_PENDING_CREDENTIAL:"invalid-multi-factor-session",MFA_ENROLLMENT_NOT_FOUND:"multi-factor-info-not-found",MISSING_MFA_ENROLLMENT_ID:"missing-multi-factor-info",MISSING_MFA_PENDING_CREDENTIAL:"missing-multi-factor-session",SECOND_FACTOR_EXISTS:"second-factor-already-in-use",SECOND_FACTOR_LIMIT_EXCEEDED:"maximum-second-factor-count-exceeded",BLOCKING_FUNCTION_ERROR_RESPONSE:"internal-error",RECAPTCHA_NOT_ENABLED:"recaptcha-not-enabled",MISSING_RECAPTCHA_TOKEN:"missing-recaptcha-token",INVALID_RECAPTCHA_TOKEN:"invalid-recaptcha-token",INVALID_RECAPTCHA_ACTION:"invalid-recaptcha-action",MISSING_CLIENT_TYPE:"missing-client-type",MISSING_RECAPTCHA_VERSION:"missing-recaptcha-version",INVALID_RECAPTCHA_VERSION:"invalid-recaptcha-version",INVALID_REQ_TYPE:"invalid-req-type"},ei=new Xn(3e4,6e4);function ti(e,t){return e.tenantId&&!t.tenantId?Object.assign(Object.assign({},t),{tenantId:e.tenantId}):t}async function ni(e,t,n,i){return ii(e,arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},(async()=>{let r={},o={};i&&("GET"===t?o=i:r={body:JSON.stringify(i)});const s=Je(Object.assign({key:e.config.apiKey},o)).slice(1),a=await e._getAdditionalHeaders();return a["Content-Type"]="application/json",e.languageCode&&(a["X-Firebase-Locale"]=e.languageCode),Zn.fetch()(oi(e,e.config.apiHost,n,s),Object.assign({method:t,headers:a,referrerPolicy:"no-referrer"},r))}))}async function ii(e,t,n){e._canInitEmulator=!1;const i=Object.assign(Object.assign({},$n),t);try{const t=new ai(e),r=await Promise.race([n(),t.promise]);t.clearNetworkTimeout();const o=await r.json();if("needConfirmation"in o)throw ci(e,"account-exists-with-different-credential",o);if(r.ok&&!("errorMessage"in o))return o;{const t=r.ok?o.errorMessage:o.error.message,[n,s]=t.split(" : ");if("FEDERATED_USER_ID_ALREADY_LINKED"===n)throw ci(e,"credential-already-in-use",o);if("EMAIL_EXISTS"===n)throw ci(e,"email-already-in-use",o);if("USER_DISABLED"===n)throw ci(e,"user-disabled",o);const a=i[n]||n.toLowerCase().replace(/[_\s]+/g,"-");if(s)throw jn(e,a,s);Vn(e,a)}}catch(Dm){if(Dm instanceof He)throw Dm;Vn(e,"network-request-failed",{message:String(Dm)})}}async function ri(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const o=await ni(e,t,n,i,r);return"mfaPendingCredential"in o&&Vn(e,"multi-factor-auth-required",{_serverResponse:o}),o}function oi(e,t,n,i){const r="".concat(t).concat(n,"?").concat(i);return e.config.emulator?Qn(e.config,r):"".concat(e.config.apiScheme,"://").concat(r)}function si(e){switch(e){case"ENFORCE":return"ENFORCE";case"AUDIT":return"AUDIT";case"OFF":return"OFF";default:return"ENFORCEMENT_STATE_UNSPECIFIED"}}class ai{constructor(e){this.auth=e,this.timer=null,this.promise=new Promise(((e,t)=>{this.timer=setTimeout((()=>t(Fn(this.auth,"network-request-failed"))),ei.get())}))}clearNetworkTimeout(){clearTimeout(this.timer)}}function ci(e,t,n){const i={appName:e.name};n.email&&(i.email=n.email),n.phoneNumber&&(i.phoneNumber=n.phoneNumber);const r=Fn(e,t,i);return r.customData._tokenResponse=n,r}function li(e){return void 0!==e&&void 0!==e.enterprise}class di{constructor(e){if(this.siteKey="",this.recaptchaEnforcementState=[],void 0===e.recaptchaKey)throw new Error("recaptchaKey undefined");this.siteKey=e.recaptchaKey.split("/")[3],this.recaptchaEnforcementState=e.recaptchaEnforcementState}getProviderEnforcementState(e){if(!this.recaptchaEnforcementState||0===this.recaptchaEnforcementState.length)return null;for(const t of this.recaptchaEnforcementState)if(t.provider&&t.provider===e)return si(t.enforcementState);return null}isProviderEnabled(e){return"ENFORCE"===this.getProviderEnforcementState(e)||"AUDIT"===this.getProviderEnforcementState(e)}}async function ui(e,t){return ni(e,"GET","/v2/recaptchaConfig",ti(e,t))}async function hi(e,t){return ni(e,"POST","/v1/accounts:lookup",t)}function pi(e){if(e)try{const t=new Date(Number(e));if(!isNaN(t.getTime()))return t.toUTCString()}catch(Dm){}}function fi(e){return 1e3*Number(e)}function mi(e){const[t,n,i]=e.split(".");if(void 0===t||void 0===n||void 0===i)return xn("JWT malformed, contained fewer than 3 sections"),null;try{const e=Pe(n);return e?JSON.parse(e):(xn("Failed to decode base64 JWT payload"),null)}catch(Dm){return xn("Caught error parsing JWT payload as JSON",null===Dm||void 0===Dm?void 0:Dm.toString()),null}}function _i(e){const t=mi(e);return Wn(t,"internal-error"),Wn("undefined"!==typeof t.exp,"internal-error"),Wn("undefined"!==typeof t.iat,"internal-error"),Number(t.exp)-Number(t.iat)}async function Ei(e,t){if(arguments.length>2&&void 0!==arguments[2]&&arguments[2])return t;try{return await t}catch(Dm){throw Dm instanceof He&&function(e){let{code:t}=e;return t==="auth/".concat("user-disabled")||t==="auth/".concat("user-token-expired")}(Dm)&&e.auth.currentUser===e&&await e.auth.signOut(),Dm}}class gi{constructor(e){this.user=e,this.isRunning=!1,this.timerId=null,this.errorBackoff=3e4}_start(){this.isRunning||(this.isRunning=!0,this.schedule())}_stop(){this.isRunning&&(this.isRunning=!1,null!==this.timerId&&clearTimeout(this.timerId))}getInterval(e){var t;if(e){const e=this.errorBackoff;return this.errorBackoff=Math.min(2*this.errorBackoff,96e4),e}{this.errorBackoff=3e4;const e=(null!==(t=this.user.stsTokenManager.expirationTime)&&void 0!==t?t:0)-Date.now()-3e5;return Math.max(0,e)}}schedule(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.isRunning)return;const t=this.getInterval(e);this.timerId=setTimeout((async()=>{await this.iteration()}),t)}async iteration(){try{await this.user.getIdToken(!0)}catch(Dm){return void((null===Dm||void 0===Dm?void 0:Dm.code)==="auth/".concat("network-request-failed")&&this.schedule(!0))}this.schedule()}}class vi{constructor(e,t){this.createdAt=e,this.lastLoginAt=t,this._initializeTime()}_initializeTime(){this.lastSignInTime=pi(this.lastLoginAt),this.creationTime=pi(this.createdAt)}_copy(e){this.createdAt=e.createdAt,this.lastLoginAt=e.lastLoginAt,this._initializeTime()}toJSON(){return{createdAt:this.createdAt,lastLoginAt:this.lastLoginAt}}}async function Ti(e){var t;const n=e.auth,i=await e.getIdToken(),r=await Ei(e,hi(n,{idToken:i}));Wn(null===r||void 0===r?void 0:r.users.length,n,"internal-error");const o=r.users[0];e._notifyReloadListener(o);const s=(null===(t=o.providerUserInfo)||void 0===t?void 0:t.length)?Si(o.providerUserInfo):[],a=(c=e.providerData,l=s,[...c.filter((e=>!l.some((t=>t.providerId===e.providerId)))),...l]);var c,l;const d=e.isAnonymous,u=!(e.email&&o.passwordHash)&&!(null===a||void 0===a?void 0:a.length),h=!!d&&u,p={uid:o.localId,displayName:o.displayName||null,photoURL:o.photoUrl||null,email:o.email||null,emailVerified:o.emailVerified||!1,phoneNumber:o.phoneNumber||null,tenantId:o.tenantId||null,providerData:a,metadata:new vi(o.createdAt,o.lastLoginAt),isAnonymous:h};Object.assign(e,p)}function Si(e){return e.map((e=>{var{providerId:t}=e,n=Pn(e,["providerId"]);return{providerId:t,uid:n.rawId||"",displayName:n.displayName||null,email:n.email||null,phoneNumber:n.phoneNumber||null,photoURL:n.photoUrl||null}}))}class yi{constructor(){this.refreshToken=null,this.accessToken=null,this.expirationTime=null}get isExpired(){return!this.expirationTime||Date.now()>this.expirationTime-3e4}updateFromServerResponse(e){Wn(e.idToken,"internal-error"),Wn("undefined"!==typeof e.idToken,"internal-error"),Wn("undefined"!==typeof e.refreshToken,"internal-error");const t="expiresIn"in e&&"undefined"!==typeof e.expiresIn?Number(e.expiresIn):_i(e.idToken);this.updateTokensAndExpiration(e.idToken,e.refreshToken,t)}updateFromIdToken(e){Wn(0!==e.length,"internal-error");const t=_i(e);this.updateTokensAndExpiration(e,null,t)}async getToken(e){return arguments.length>1&&void 0!==arguments[1]&&arguments[1]||!this.accessToken||this.isExpired?(Wn(this.refreshToken,e,"user-token-expired"),this.refreshToken?(await this.refresh(e,this.refreshToken),this.accessToken):null):this.accessToken}clearRefreshToken(){this.refreshToken=null}async refresh(e,t){const{accessToken:n,refreshToken:i,expiresIn:r}=await async function(e,t){const n=await ii(e,{},(async()=>{const n=Je({grant_type:"refresh_token",refresh_token:t}).slice(1),{tokenApiHost:i,apiKey:r}=e.config,o=oi(e,i,"/v1/token","key=".concat(r)),s=await e._getAdditionalHeaders();return s["Content-Type"]="application/x-www-form-urlencoded",Zn.fetch()(o,{method:"POST",headers:s,body:n})}));return{accessToken:n.access_token,expiresIn:n.expires_in,refreshToken:n.refresh_token}}(e,t);this.updateTokensAndExpiration(n,i,Number(r))}updateTokensAndExpiration(e,t,n){this.refreshToken=t||null,this.accessToken=e||null,this.expirationTime=Date.now()+1e3*n}static fromJSON(e,t){const{refreshToken:n,accessToken:i,expirationTime:r}=t,o=new yi;return n&&(Wn("string"===typeof n,"internal-error",{appName:e}),o.refreshToken=n),i&&(Wn("string"===typeof i,"internal-error",{appName:e}),o.accessToken=i),r&&(Wn("number"===typeof r,"internal-error",{appName:e}),o.expirationTime=r),o}toJSON(){return{refreshToken:this.refreshToken,accessToken:this.accessToken,expirationTime:this.expirationTime}}_assign(e){this.accessToken=e.accessToken,this.refreshToken=e.refreshToken,this.expirationTime=e.expirationTime}_clone(){return Object.assign(new yi,this.toJSON())}_performRefresh(){return Hn("not implemented")}}function Ci(e,t){Wn("string"===typeof e||"undefined"===typeof e,"internal-error",{appName:t})}class Ri{constructor(e){var{uid:t,auth:n,stsTokenManager:i}=e,r=Pn(e,["uid","auth","stsTokenManager"]);this.providerId="firebase",this.proactiveRefresh=new gi(this),this.reloadUserInfo=null,this.reloadListener=null,this.uid=t,this.auth=n,this.stsTokenManager=i,this.accessToken=i.accessToken,this.displayName=r.displayName||null,this.email=r.email||null,this.emailVerified=r.emailVerified||!1,this.phoneNumber=r.phoneNumber||null,this.photoURL=r.photoURL||null,this.isAnonymous=r.isAnonymous||!1,this.tenantId=r.tenantId||null,this.providerData=r.providerData?[...r.providerData]:[],this.metadata=new vi(r.createdAt||void 0,r.lastLoginAt||void 0)}async getIdToken(e){const t=await Ei(this,this.stsTokenManager.getToken(this.auth,e));return Wn(t,this.auth,"internal-error"),this.accessToken!==t&&(this.accessToken=t,await this.auth._persistUserIfCurrent(this),this.auth._notifyListenersIfCurrent(this)),t}getIdTokenResult(e){return async function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=et(e),i=await n.getIdToken(t),r=mi(i);Wn(r&&r.exp&&r.auth_time&&r.iat,n.auth,"internal-error");const o="object"===typeof r.firebase?r.firebase:void 0,s=null===o||void 0===o?void 0:o.sign_in_provider;return{claims:r,token:i,authTime:pi(fi(r.auth_time)),issuedAtTime:pi(fi(r.iat)),expirationTime:pi(fi(r.exp)),signInProvider:s||null,signInSecondFactor:(null===o||void 0===o?void 0:o.sign_in_second_factor)||null}}(this,e)}reload(){return async function(e){const t=et(e);await Ti(t),await t.auth._persistUserIfCurrent(t),t.auth._notifyListenersIfCurrent(t)}(this)}_assign(e){this!==e&&(Wn(this.uid===e.uid,this.auth,"internal-error"),this.displayName=e.displayName,this.photoURL=e.photoURL,this.email=e.email,this.emailVerified=e.emailVerified,this.phoneNumber=e.phoneNumber,this.isAnonymous=e.isAnonymous,this.tenantId=e.tenantId,this.providerData=e.providerData.map((e=>Object.assign({},e))),this.metadata._copy(e.metadata),this.stsTokenManager._assign(e.stsTokenManager))}_clone(e){const t=new Ri(Object.assign(Object.assign({},this),{auth:e,stsTokenManager:this.stsTokenManager._clone()}));return t.metadata._copy(this.metadata),t}_onReload(e){Wn(!this.reloadListener,this.auth,"internal-error"),this.reloadListener=e,this.reloadUserInfo&&(this._notifyReloadListener(this.reloadUserInfo),this.reloadUserInfo=null)}_notifyReloadListener(e){this.reloadListener?this.reloadListener(e):this.reloadUserInfo=e}_startProactiveRefresh(){this.proactiveRefresh._start()}_stopProactiveRefresh(){this.proactiveRefresh._stop()}async _updateTokensIfNecessary(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=!1;e.idToken&&e.idToken!==this.stsTokenManager.accessToken&&(this.stsTokenManager.updateFromServerResponse(e),n=!0),t&&await Ti(this),await this.auth._persistUserIfCurrent(this),n&&this.auth._notifyListenersIfCurrent(this)}async delete(){if(pn(this.auth.app))return Promise.reject(Bn(this.auth));const e=await this.getIdToken();return await Ei(this,async function(e,t){return ni(e,"POST","/v1/accounts:delete",t)}(this.auth,{idToken:e})),this.stsTokenManager.clearRefreshToken(),this.auth.signOut()}toJSON(){return Object.assign(Object.assign({uid:this.uid,email:this.email||void 0,emailVerified:this.emailVerified,displayName:this.displayName||void 0,isAnonymous:this.isAnonymous,photoURL:this.photoURL||void 0,phoneNumber:this.phoneNumber||void 0,tenantId:this.tenantId||void 0,providerData:this.providerData.map((e=>Object.assign({},e))),stsTokenManager:this.stsTokenManager.toJSON(),_redirectEventId:this._redirectEventId},this.metadata.toJSON()),{apiKey:this.auth.config.apiKey,appName:this.auth.name})}get refreshToken(){return this.stsTokenManager.refreshToken||""}static _fromJSON(e,t){var n,i,r,o,s,a,c,l;const d=null!==(n=t.displayName)&&void 0!==n?n:void 0,u=null!==(i=t.email)&&void 0!==i?i:void 0,h=null!==(r=t.phoneNumber)&&void 0!==r?r:void 0,p=null!==(o=t.photoURL)&&void 0!==o?o:void 0,f=null!==(s=t.tenantId)&&void 0!==s?s:void 0,m=null!==(a=t._redirectEventId)&&void 0!==a?a:void 0,_=null!==(c=t.createdAt)&&void 0!==c?c:void 0,E=null!==(l=t.lastLoginAt)&&void 0!==l?l:void 0,{uid:g,emailVerified:v,isAnonymous:T,providerData:S,stsTokenManager:y}=t;Wn(g&&y,e,"internal-error");const C=yi.fromJSON(this.name,y);Wn("string"===typeof g,e,"internal-error"),Ci(d,e.name),Ci(u,e.name),Wn("boolean"===typeof v,e,"internal-error"),Wn("boolean"===typeof T,e,"internal-error"),Ci(h,e.name),Ci(p,e.name),Ci(f,e.name),Ci(m,e.name),Ci(_,e.name),Ci(E,e.name);const R=new Ri({uid:g,auth:e,email:u,emailVerified:v,displayName:d,isAnonymous:T,photoURL:p,phoneNumber:h,tenantId:f,stsTokenManager:C,createdAt:_,lastLoginAt:E});return S&&Array.isArray(S)&&(R.providerData=S.map((e=>Object.assign({},e)))),m&&(R._redirectEventId=m),R}static async _fromIdTokenResponse(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=new yi;i.updateFromServerResponse(t);const r=new Ri({uid:t.localId,auth:e,stsTokenManager:i,isAnonymous:n});return await Ti(r),r}static async _fromGetAccountInfoResponse(e,t,n){const i=t.users[0];Wn(void 0!==i.localId,"internal-error");const r=void 0!==i.providerUserInfo?Si(i.providerUserInfo):[],o=!(i.email&&i.passwordHash)&&!(null===r||void 0===r?void 0:r.length),s=new yi;s.updateFromIdToken(n);const a=new Ri({uid:i.localId,auth:e,stsTokenManager:s,isAnonymous:o}),c={uid:i.localId,displayName:i.displayName||null,photoURL:i.photoUrl||null,email:i.email||null,emailVerified:i.emailVerified||!1,phoneNumber:i.phoneNumber||null,tenantId:i.tenantId||null,providerData:r,metadata:new vi(i.createdAt,i.lastLoginAt),isAnonymous:!(i.email&&i.passwordHash)&&!(null===r||void 0===r?void 0:r.length)};return Object.assign(a,c),a}}const wi=new Map;function Ii(e){Kn(e instanceof Function,"Expected a class definition");let t=wi.get(e);return t?(Kn(t instanceof e,"Instance stored in cache mismatched with class"),t):(t=new e,wi.set(e,t),t)}class bi{constructor(){this.type="NONE",this.storage={}}async _isAvailable(){return!0}async _set(e,t){this.storage[e]=t}async _get(e){const t=this.storage[e];return void 0===t?null:t}async _remove(e){delete this.storage[e]}_addListener(e,t){}_removeListener(e,t){}}bi.type="NONE";const Ai=bi;function Oi(e,t,n){return"firebase".concat(":",e,":").concat(t,":").concat(n)}class Ni{constructor(e,t,n){this.persistence=e,this.auth=t,this.userKey=n;const{config:i,name:r}=this.auth;this.fullUserKey=Oi(this.userKey,i.apiKey,r),this.fullPersistenceKey=Oi("persistence",i.apiKey,r),this.boundEventHandler=t._onStorageEvent.bind(t),this.persistence._addListener(this.fullUserKey,this.boundEventHandler)}setCurrentUser(e){return this.persistence._set(this.fullUserKey,e.toJSON())}async getCurrentUser(){const e=await this.persistence._get(this.fullUserKey);return e?Ri._fromJSON(this.auth,e):null}removeCurrentUser(){return this.persistence._remove(this.fullUserKey)}savePersistenceForRedirect(){return this.persistence._set(this.fullPersistenceKey,this.persistence.type)}async setPersistence(e){if(this.persistence===e)return;const t=await this.getCurrentUser();return await this.removeCurrentUser(),this.persistence=e,t?this.setCurrentUser(t):void 0}delete(){this.persistence._removeListener(this.fullUserKey,this.boundEventHandler)}static async create(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"authUser";if(!t.length)return new Ni(Ii(Ai),e,n);const i=(await Promise.all(t.map((async e=>{if(await e._isAvailable())return e})))).filter((e=>e));let r=i[0]||Ii(Ai);const o=Oi(n,e.config.apiKey,e.name);let s=null;for(const l of t)try{const t=await l._get(o);if(t){const n=Ri._fromJSON(e,t);l!==r&&(s=n),r=l;break}}catch(c){}const a=i.filter((e=>e._shouldAllowMigration));return r._shouldAllowMigration&&a.length?(r=a[0],s&&await r._set(o,s.toJSON()),await Promise.all(t.map((async e=>{if(e!==r)try{await e._remove(o)}catch(c){}}))),new Ni(r,e,n)):new Ni(r,e,n)}}function Di(e){const t=e.toLowerCase();if(t.includes("opera/")||t.includes("opr/")||t.includes("opios/"))return"Opera";if(Mi(t))return"IEMobile";if(t.includes("msie")||t.includes("trident/"))return"IE";if(t.includes("edge/"))return"Edge";if(Pi(t))return"Firefox";if(t.includes("silk/"))return"Silk";if(xi(t))return"Blackberry";if(Vi(t))return"Webos";if(ki(t))return"Safari";if((t.includes("chrome/")||Li(t))&&!t.includes("edge/"))return"Chrome";if(Ui(t))return"Android";{const t=/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/,n=e.match(t);if(2===(null===n||void 0===n?void 0:n.length))return n[1]}return"Other"}function Pi(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be();return/firefox\//i.test(e)}function ki(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be()).toLowerCase();return e.includes("safari/")&&!e.includes("chrome/")&&!e.includes("crios/")&&!e.includes("android")}function Li(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be();return/crios\//i.test(e)}function Mi(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be();return/iemobile/i.test(e)}function Ui(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be();return/android/i.test(e)}function xi(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be();return/blackberry/i.test(e)}function Vi(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be();return/webos/i.test(e)}function Fi(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be();return/iphone|ipad|ipod/i.test(e)||/macintosh/i.test(e)&&/mobile/i.test(e)}function ji(){return function(){const e=Be();return e.indexOf("MSIE ")>=0||e.indexOf("Trident/")>=0}()&&10===document.documentMode}function Bi(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be();return Fi(e)||Ui(e)||Vi(e)||xi(e)||/windows phone/i.test(e)||Mi(e)}function Gi(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];switch(e){case"Browser":t=Di(Be());break;case"Worker":t="".concat(Di(Be()),"-").concat(e);break;default:t=e}const i=n.length?n.join(","):"FirebaseCore-web";return"".concat(t,"/","JsCore","/").concat(_n,"/").concat(i)}class Wi{constructor(e){this.auth=e,this.queue=[]}pushCallback(e,t){const n=t=>new Promise(((n,i)=>{try{n(e(t))}catch(Dm){i(Dm)}}));n.onAbort=t,this.queue.push(n);const i=this.queue.length-1;return()=>{this.queue[i]=()=>Promise.resolve()}}async runMiddleware(e){if(this.auth.currentUser===e)return;const t=[];try{for(const n of this.queue)await n(e),n.onAbort&&t.push(n.onAbort)}catch(Dm){t.reverse();for(const i of t)try{i()}catch(n){}throw this.auth._errorFactory.create("login-blocked",{originalMessage:null===Dm||void 0===Dm?void 0:Dm.message})}}}class Hi{constructor(e){var t,n,i,r;const o=e.customStrengthOptions;this.customStrengthOptions={},this.customStrengthOptions.minPasswordLength=null!==(t=o.minPasswordLength)&&void 0!==t?t:6,o.maxPasswordLength&&(this.customStrengthOptions.maxPasswordLength=o.maxPasswordLength),void 0!==o.containsLowercaseCharacter&&(this.customStrengthOptions.containsLowercaseLetter=o.containsLowercaseCharacter),void 0!==o.containsUppercaseCharacter&&(this.customStrengthOptions.containsUppercaseLetter=o.containsUppercaseCharacter),void 0!==o.containsNumericCharacter&&(this.customStrengthOptions.containsNumericCharacter=o.containsNumericCharacter),void 0!==o.containsNonAlphanumericCharacter&&(this.customStrengthOptions.containsNonAlphanumericCharacter=o.containsNonAlphanumericCharacter),this.enforcementState=e.enforcementState,"ENFORCEMENT_STATE_UNSPECIFIED"===this.enforcementState&&(this.enforcementState="OFF"),this.allowedNonAlphanumericCharacters=null!==(i=null===(n=e.allowedNonAlphanumericCharacters)||void 0===n?void 0:n.join(""))&&void 0!==i?i:"",this.forceUpgradeOnSignin=null!==(r=e.forceUpgradeOnSignin)&&void 0!==r&&r,this.schemaVersion=e.schemaVersion}validatePassword(e){var t,n,i,r,o,s;const a={isValid:!0,passwordPolicy:this};return this.validatePasswordLengthOptions(e,a),this.validatePasswordCharacterOptions(e,a),a.isValid&&(a.isValid=null===(t=a.meetsMinPasswordLength)||void 0===t||t),a.isValid&&(a.isValid=null===(n=a.meetsMaxPasswordLength)||void 0===n||n),a.isValid&&(a.isValid=null===(i=a.containsLowercaseLetter)||void 0===i||i),a.isValid&&(a.isValid=null===(r=a.containsUppercaseLetter)||void 0===r||r),a.isValid&&(a.isValid=null===(o=a.containsNumericCharacter)||void 0===o||o),a.isValid&&(a.isValid=null===(s=a.containsNonAlphanumericCharacter)||void 0===s||s),a}validatePasswordLengthOptions(e,t){const n=this.customStrengthOptions.minPasswordLength,i=this.customStrengthOptions.maxPasswordLength;n&&(t.meetsMinPasswordLength=e.length>=n),i&&(t.meetsMaxPasswordLength=e.length<=i)}validatePasswordCharacterOptions(e,t){let n;this.updatePasswordCharacterOptionsStatuses(t,!1,!1,!1,!1);for(let i=0;i<e.length;i++)n=e.charAt(i),this.updatePasswordCharacterOptionsStatuses(t,n>="a"&&n<="z",n>="A"&&n<="Z",n>="0"&&n<="9",this.allowedNonAlphanumericCharacters.includes(n))}updatePasswordCharacterOptionsStatuses(e,t,n,i,r){this.customStrengthOptions.containsLowercaseLetter&&(e.containsLowercaseLetter||(e.containsLowercaseLetter=t)),this.customStrengthOptions.containsUppercaseLetter&&(e.containsUppercaseLetter||(e.containsUppercaseLetter=n)),this.customStrengthOptions.containsNumericCharacter&&(e.containsNumericCharacter||(e.containsNumericCharacter=i)),this.customStrengthOptions.containsNonAlphanumericCharacter&&(e.containsNonAlphanumericCharacter||(e.containsNonAlphanumericCharacter=r))}}class Ki{constructor(e,t,n,i){this.app=e,this.heartbeatServiceProvider=t,this.appCheckServiceProvider=n,this.config=i,this.currentUser=null,this.emulatorConfig=null,this.operations=Promise.resolve(),this.authStateSubscription=new qi(this),this.idTokenSubscription=new qi(this),this.beforeStateQueue=new Wi(this),this.redirectUser=null,this.isProactiveRefreshEnabled=!1,this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION=1,this._canInitEmulator=!0,this._isInitialized=!1,this._deleted=!1,this._initializationPromise=null,this._popupRedirectResolver=null,this._errorFactory=Mn,this._agentRecaptchaConfig=null,this._tenantRecaptchaConfigs={},this._projectPasswordPolicy=null,this._tenantPasswordPolicies={},this.lastNotifiedUid=void 0,this.languageCode=null,this.tenantId=null,this.settings={appVerificationDisabledForTesting:!1},this.frameworks=[],this.name=e.name,this.clientVersion=i.sdkClientVersion}_initializeWithPersistence(e,t){return t&&(this._popupRedirectResolver=Ii(t)),this._initializationPromise=this.queue((async()=>{var n,i;if(!this._deleted&&(this.persistenceManager=await Ni.create(this,e),!this._deleted)){if(null===(n=this._popupRedirectResolver)||void 0===n?void 0:n._shouldInitProactively)try{await this._popupRedirectResolver._initialize(this)}catch(Dm){}await this.initializeCurrentUser(t),this.lastNotifiedUid=(null===(i=this.currentUser)||void 0===i?void 0:i.uid)||null,this._deleted||(this._isInitialized=!0)}})),this._initializationPromise}async _onStorageEvent(){if(this._deleted)return;const e=await this.assertedPersistence.getCurrentUser();return this.currentUser||e?this.currentUser&&e&&this.currentUser.uid===e.uid?(this._currentUser._assign(e),void await this.currentUser.getIdToken()):void await this._updateCurrentUser(e,!0):void 0}async initializeCurrentUserFromIdToken(e){try{const t=await hi(this,{idToken:e}),n=await Ri._fromGetAccountInfoResponse(this,t,e);await this.directlySetCurrentUser(n)}catch(t){console.warn("FirebaseServerApp could not login user with provided authIdToken: ",t),await this.directlySetCurrentUser(null)}}async initializeCurrentUser(e){var t;if(pn(this.app)){const e=this.app.settings.authIdToken;return e?new Promise((t=>{setTimeout((()=>this.initializeCurrentUserFromIdToken(e).then(t,t)))})):this.directlySetCurrentUser(null)}const n=await this.assertedPersistence.getCurrentUser();let i=n,r=!1;if(e&&this.config.authDomain){await this.getOrInitRedirectPersistenceManager();const n=null===(t=this.redirectUser)||void 0===t?void 0:t._redirectEventId,o=null===i||void 0===i?void 0:i._redirectEventId,s=await this.tryRedirectSignIn(e);n&&n!==o||!(null===s||void 0===s?void 0:s.user)||(i=s.user,r=!0)}if(!i)return this.directlySetCurrentUser(null);if(!i._redirectEventId){if(r)try{await this.beforeStateQueue.runMiddleware(i)}catch(Dm){i=n,this._popupRedirectResolver._overrideRedirectResult(this,(()=>Promise.reject(Dm)))}return i?this.reloadAndSetCurrentUserOrClear(i):this.directlySetCurrentUser(null)}return Wn(this._popupRedirectResolver,this,"argument-error"),await this.getOrInitRedirectPersistenceManager(),this.redirectUser&&this.redirectUser._redirectEventId===i._redirectEventId?this.directlySetCurrentUser(i):this.reloadAndSetCurrentUserOrClear(i)}async tryRedirectSignIn(e){let t=null;try{t=await this._popupRedirectResolver._completeRedirectFn(this,e,!0)}catch(Dm){await this._setRedirectUser(null)}return t}async reloadAndSetCurrentUserOrClear(e){try{await Ti(e)}catch(Dm){if((null===Dm||void 0===Dm?void 0:Dm.code)!=="auth/".concat("network-request-failed"))return this.directlySetCurrentUser(null)}return this.directlySetCurrentUser(e)}useDeviceLanguage(){this.languageCode=function(){if("undefined"===typeof navigator)return null;const e=navigator;return e.languages&&e.languages[0]||e.language||null}()}async _delete(){this._deleted=!0}async updateCurrentUser(e){if(pn(this.app))return Promise.reject(Bn(this));const t=e?et(e):null;return t&&Wn(t.auth.config.apiKey===this.config.apiKey,this,"invalid-user-token"),this._updateCurrentUser(t&&t._clone(this))}async _updateCurrentUser(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this._deleted)return e&&Wn(this.tenantId===e.tenantId,this,"tenant-id-mismatch"),t||await this.beforeStateQueue.runMiddleware(e),this.queue((async()=>{await this.directlySetCurrentUser(e),this.notifyAuthListeners()}))}async signOut(){return pn(this.app)?Promise.reject(Bn(this)):(await this.beforeStateQueue.runMiddleware(null),(this.redirectPersistenceManager||this._popupRedirectResolver)&&await this._setRedirectUser(null),this._updateCurrentUser(null,!0))}setPersistence(e){return pn(this.app)?Promise.reject(Bn(this)):this.queue((async()=>{await this.assertedPersistence.setPersistence(Ii(e))}))}_getRecaptchaConfig(){return null==this.tenantId?this._agentRecaptchaConfig:this._tenantRecaptchaConfigs[this.tenantId]}async validatePassword(e){this._getPasswordPolicyInternal()||await this._updatePasswordPolicy();const t=this._getPasswordPolicyInternal();return t.schemaVersion!==this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION?Promise.reject(this._errorFactory.create("unsupported-password-policy-schema-version",{})):t.validatePassword(e)}_getPasswordPolicyInternal(){return null===this.tenantId?this._projectPasswordPolicy:this._tenantPasswordPolicies[this.tenantId]}async _updatePasswordPolicy(){const e=await async function(e){return ni(e,"GET","/v2/passwordPolicy",ti(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}))}(this),t=new Hi(e);null===this.tenantId?this._projectPasswordPolicy=t:this._tenantPasswordPolicies[this.tenantId]=t}_getPersistence(){return this.assertedPersistence.persistence.type}_updateErrorMap(e){this._errorFactory=new Ke("auth","Firebase",e())}onAuthStateChanged(e,t,n){return this.registerStateListener(this.authStateSubscription,e,t,n)}beforeAuthStateChanged(e,t){return this.beforeStateQueue.pushCallback(e,t)}onIdTokenChanged(e,t,n){return this.registerStateListener(this.idTokenSubscription,e,t,n)}authStateReady(){return new Promise(((e,t)=>{if(this.currentUser)e();else{const n=this.onAuthStateChanged((()=>{n(),e()}),t)}}))}async revokeAccessToken(e){if(this.currentUser){const t={providerId:"apple.com",tokenType:"ACCESS_TOKEN",token:e,idToken:await this.currentUser.getIdToken()};null!=this.tenantId&&(t.tenantId=this.tenantId),await async function(e,t){return ni(e,"POST","/v2/accounts:revokeToken",ti(e,t))}(this,t)}}toJSON(){var e;return{apiKey:this.config.apiKey,authDomain:this.config.authDomain,appName:this.name,currentUser:null===(e=this._currentUser)||void 0===e?void 0:e.toJSON()}}async _setRedirectUser(e,t){const n=await this.getOrInitRedirectPersistenceManager(t);return null===e?n.removeCurrentUser():n.setCurrentUser(e)}async getOrInitRedirectPersistenceManager(e){if(!this.redirectPersistenceManager){const t=e&&Ii(e)||this._popupRedirectResolver;Wn(t,this,"argument-error"),this.redirectPersistenceManager=await Ni.create(this,[Ii(t._redirectPersistence)],"redirectUser"),this.redirectUser=await this.redirectPersistenceManager.getCurrentUser()}return this.redirectPersistenceManager}async _redirectUserForId(e){var t,n;return this._isInitialized&&await this.queue((async()=>{})),(null===(t=this._currentUser)||void 0===t?void 0:t._redirectEventId)===e?this._currentUser:(null===(n=this.redirectUser)||void 0===n?void 0:n._redirectEventId)===e?this.redirectUser:null}async _persistUserIfCurrent(e){if(e===this.currentUser)return this.queue((async()=>this.directlySetCurrentUser(e)))}_notifyListenersIfCurrent(e){e===this.currentUser&&this.notifyAuthListeners()}_key(){return"".concat(this.config.authDomain,":").concat(this.config.apiKey,":").concat(this.name)}_startProactiveRefresh(){this.isProactiveRefreshEnabled=!0,this.currentUser&&this._currentUser._startProactiveRefresh()}_stopProactiveRefresh(){this.isProactiveRefreshEnabled=!1,this.currentUser&&this._currentUser._stopProactiveRefresh()}get _currentUser(){return this.currentUser}notifyAuthListeners(){var e,t;if(!this._isInitialized)return;this.idTokenSubscription.next(this.currentUser);const n=null!==(t=null===(e=this.currentUser)||void 0===e?void 0:e.uid)&&void 0!==t?t:null;this.lastNotifiedUid!==n&&(this.lastNotifiedUid=n,this.authStateSubscription.next(this.currentUser))}registerStateListener(e,t,n,i){if(this._deleted)return()=>{};const r="function"===typeof t?t:t.next.bind(t);let o=!1;const s=this._isInitialized?Promise.resolve():this._initializationPromise;if(Wn(s,this,"internal-error"),s.then((()=>{o||r(this.currentUser)})),"function"===typeof t){const r=e.addObserver(t,n,i);return()=>{o=!0,r()}}{const n=e.addObserver(t);return()=>{o=!0,n()}}}async directlySetCurrentUser(e){this.currentUser&&this.currentUser!==e&&this._currentUser._stopProactiveRefresh(),e&&this.isProactiveRefreshEnabled&&e._startProactiveRefresh(),this.currentUser=e,e?await this.assertedPersistence.setCurrentUser(e):await this.assertedPersistence.removeCurrentUser()}queue(e){return this.operations=this.operations.then(e,e),this.operations}get assertedPersistence(){return Wn(this.persistenceManager,this,"internal-error"),this.persistenceManager}_logFramework(e){e&&!this.frameworks.includes(e)&&(this.frameworks.push(e),this.frameworks.sort(),this.clientVersion=Gi(this.config.clientPlatform,this._getFrameworks()))}_getFrameworks(){return this.frameworks}async _getAdditionalHeaders(){var e;const t={"X-Client-Version":this.clientVersion};this.app.options.appId&&(t["X-Firebase-gmpid"]=this.app.options.appId);const n=await(null===(e=this.heartbeatServiceProvider.getImmediate({optional:!0}))||void 0===e?void 0:e.getHeartbeatsHeader());n&&(t["X-Firebase-Client"]=n);const i=await this._getAppCheckToken();return i&&(t["X-Firebase-AppCheck"]=i),t}async _getAppCheckToken(){var e;const t=await(null===(e=this.appCheckServiceProvider.getImmediate({optional:!0}))||void 0===e?void 0:e.getToken());return(null===t||void 0===t?void 0:t.error)&&function(e){if(Un.logLevel<=st.WARN){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];Un.warn("Auth (".concat(_n,"): ").concat(e),...n)}}("Error while retrieving App Check token: ".concat(t.error)),null===t||void 0===t?void 0:t.token}}function zi(e){return et(e)}class qi{constructor(e){this.auth=e,this.observer=null,this.addObserver=function(e,t){const n=new Ze(e,t);return n.subscribe.bind(n)}((e=>this.observer=e))}get next(){return Wn(this.observer,this.auth,"internal-error"),this.observer.next.bind(this.observer)}}let Yi={async loadJS(){throw new Error("Unable to load external scripts")},recaptchaV2Script:"",recaptchaEnterpriseScript:"",gapiScript:""};function Ji(e){return Yi.loadJS(e)}function Xi(e){return"__".concat(e).concat(Math.floor(1e6*Math.random()))}class Qi{constructor(e){this.type="recaptcha-enterprise",this.auth=zi(e)}async verify(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"verify",t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];function n(t,n,i){const r=window.grecaptcha;li(r)?r.enterprise.ready((()=>{r.enterprise.execute(t,{action:e}).then((e=>{n(e)})).catch((()=>{n("NO_RECAPTCHA")}))})):i(Error("No reCAPTCHA enterprise script loaded."))}return new Promise(((e,i)=>{(async function(e){if(!t){if(null==e.tenantId&&null!=e._agentRecaptchaConfig)return e._agentRecaptchaConfig.siteKey;if(null!=e.tenantId&&void 0!==e._tenantRecaptchaConfigs[e.tenantId])return e._tenantRecaptchaConfigs[e.tenantId].siteKey}return new Promise((async(t,n)=>{ui(e,{clientType:"CLIENT_TYPE_WEB",version:"RECAPTCHA_ENTERPRISE"}).then((i=>{if(void 0!==i.recaptchaKey){const n=new di(i);return null==e.tenantId?e._agentRecaptchaConfig=n:e._tenantRecaptchaConfigs[e.tenantId]=n,t(n.siteKey)}n(new Error("recaptcha Enterprise site key undefined"))})).catch((e=>{n(e)}))}))})(this.auth).then((r=>{if(!t&&li(window.grecaptcha))n(r,e,i);else{if("undefined"===typeof window)return void i(new Error("RecaptchaVerifier is only supported in browser"));let t=Yi.recaptchaEnterpriseScript;0!==t.length&&(t+=r),Ji(t).then((()=>{n(r,e,i)})).catch((e=>{i(e)}))}})).catch((e=>{i(e)}))}))}}async function Zi(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=new Qi(e);let o;try{o=await r.verify(n)}catch(a){o=await r.verify(n,!0)}const s=Object.assign({},t);return i?Object.assign(s,{captchaResp:o}):Object.assign(s,{captchaResponse:o}),Object.assign(s,{clientType:"CLIENT_TYPE_WEB"}),Object.assign(s,{recaptchaVersion:"RECAPTCHA_ENTERPRISE"}),s}async function $i(e,t,n,i){var r;if(null===(r=e._getRecaptchaConfig())||void 0===r?void 0:r.isProviderEnabled("EMAIL_PASSWORD_PROVIDER")){const r=await Zi(e,t,n,"getOobCode"===n);return i(e,r)}return i(e,t).catch((async r=>{if(r.code==="auth/".concat("missing-recaptcha-token")){console.log("".concat(n," is protected by reCAPTCHA Enterprise for this project. Automatically triggering the reCAPTCHA flow and restarting the flow."));const r=await Zi(e,t,n,"getOobCode"===n);return i(e,r)}return Promise.reject(r)}))}function er(e,t,n){const i=zi(e);Wn(i._canInitEmulator,i,"emulator-config-failed"),Wn(/^https?:\/\//.test(t),i,"invalid-emulator-scheme");const r=!!(null===n||void 0===n?void 0:n.disableWarnings),o=tr(t),{host:s,port:a}=function(e){const t=tr(e),n=/(\/\/)?([^?#/]+)/.exec(e.substr(t.length));if(!n)return{host:"",port:null};const i=n[2].split("@").pop()||"",r=/^(\[[^\]]+\])(:|$)/.exec(i);if(r){const e=r[1];return{host:e,port:nr(i.substr(e.length+1))}}{const[e,t]=i.split(":");return{host:e,port:nr(t)}}}(t),c=null===a?"":":".concat(a);i.config.emulator={url:"".concat(o,"//").concat(s).concat(c,"/")},i.settings.appVerificationDisabledForTesting=!0,i.emulatorConfig=Object.freeze({host:s,port:a,protocol:o.replace(":",""),options:Object.freeze({disableWarnings:r})}),r||function(){function e(){const e=document.createElement("p"),t=e.style;e.innerText="Running in emulator mode. Do not use with production credentials.",t.position="fixed",t.width="100%",t.backgroundColor="#ffffff",t.border=".1em solid #000000",t.color="#b50000",t.bottom="0px",t.left="0px",t.margin="0px",t.zIndex="10000",t.textAlign="center",e.classList.add("firebase-emulator-warning"),document.body.appendChild(e)}"undefined"!==typeof console&&"function"===typeof console.info&&console.info("WARNING: You are using the Auth Emulator, which is intended for local testing only.  Do not use with production credentials.");"undefined"!==typeof window&&"undefined"!==typeof document&&("loading"===document.readyState?window.addEventListener("DOMContentLoaded",e):e())}()}function tr(e){const t=e.indexOf(":");return t<0?"":e.substr(0,t+1)}function nr(e){if(!e)return null;const t=Number(e);return isNaN(t)?null:t}class ir{constructor(e,t){this.providerId=e,this.signInMethod=t}toJSON(){return Hn("not implemented")}_getIdTokenResponse(e){return Hn("not implemented")}_linkToIdToken(e,t){return Hn("not implemented")}_getReauthenticationResolver(e){return Hn("not implemented")}}async function rr(e,t){return ni(e,"POST","/v1/accounts:signUp",t)}async function or(e,t){return ri(e,"POST","/v1/accounts:signInWithPassword",ti(e,t))}class sr extends ir{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;super("password",n),this._email=e,this._password=t,this._tenantId=i}static _fromEmailAndPassword(e,t){return new sr(e,t,"password")}static _fromEmailAndCode(e,t){return new sr(e,t,"emailLink",arguments.length>2&&void 0!==arguments[2]?arguments[2]:null)}toJSON(){return{email:this._email,password:this._password,signInMethod:this.signInMethod,tenantId:this._tenantId}}static fromJSON(e){const t="string"===typeof e?JSON.parse(e):e;if((null===t||void 0===t?void 0:t.email)&&(null===t||void 0===t?void 0:t.password)){if("password"===t.signInMethod)return this._fromEmailAndPassword(t.email,t.password);if("emailLink"===t.signInMethod)return this._fromEmailAndCode(t.email,t.password,t.tenantId)}return null}async _getIdTokenResponse(e){switch(this.signInMethod){case"password":return $i(e,{returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"},"signInWithPassword",or);case"emailLink":return async function(e,t){return ri(e,"POST","/v1/accounts:signInWithEmailLink",ti(e,t))}(e,{email:this._email,oobCode:this._password});default:Vn(e,"internal-error")}}async _linkToIdToken(e,t){switch(this.signInMethod){case"password":return $i(e,{idToken:t,returnSecureToken:!0,email:this._email,password:this._password,clientType:"CLIENT_TYPE_WEB"},"signUpPassword",rr);case"emailLink":return async function(e,t){return ri(e,"POST","/v1/accounts:signInWithEmailLink",ti(e,t))}(e,{idToken:t,email:this._email,oobCode:this._password});default:Vn(e,"internal-error")}}_getReauthenticationResolver(e){return this._getIdTokenResponse(e)}}async function ar(e,t){return ri(e,"POST","/v1/accounts:signInWithIdp",ti(e,t))}class cr extends ir{constructor(){super(...arguments),this.pendingToken=null}static _fromParams(e){const t=new cr(e.providerId,e.signInMethod);return e.idToken||e.accessToken?(e.idToken&&(t.idToken=e.idToken),e.accessToken&&(t.accessToken=e.accessToken),e.nonce&&!e.pendingToken&&(t.nonce=e.nonce),e.pendingToken&&(t.pendingToken=e.pendingToken)):e.oauthToken&&e.oauthTokenSecret?(t.accessToken=e.oauthToken,t.secret=e.oauthTokenSecret):Vn("argument-error"),t}toJSON(){return{idToken:this.idToken,accessToken:this.accessToken,secret:this.secret,nonce:this.nonce,pendingToken:this.pendingToken,providerId:this.providerId,signInMethod:this.signInMethod}}static fromJSON(e){const t="string"===typeof e?JSON.parse(e):e,{providerId:n,signInMethod:i}=t,r=Pn(t,["providerId","signInMethod"]);if(!n||!i)return null;const o=new cr(n,i);return o.idToken=r.idToken||void 0,o.accessToken=r.accessToken||void 0,o.secret=r.secret,o.nonce=r.nonce,o.pendingToken=r.pendingToken||null,o}_getIdTokenResponse(e){return ar(e,this.buildRequest())}_linkToIdToken(e,t){const n=this.buildRequest();return n.idToken=t,ar(e,n)}_getReauthenticationResolver(e){const t=this.buildRequest();return t.autoCreate=!1,ar(e,t)}buildRequest(){const e={requestUri:"http://localhost",returnSecureToken:!0};if(this.pendingToken)e.pendingToken=this.pendingToken;else{const t={};this.idToken&&(t.id_token=this.idToken),this.accessToken&&(t.access_token=this.accessToken),this.secret&&(t.oauth_token_secret=this.secret),t.providerId=this.providerId,this.nonce&&!this.pendingToken&&(t.nonce=this.nonce),e.postBody=Je(t)}return e}}const lr={USER_NOT_FOUND:"user-not-found"};class dr extends ir{constructor(e){super("phone","phone"),this.params=e}static _fromVerification(e,t){return new dr({verificationId:e,verificationCode:t})}static _fromTokenResponse(e,t){return new dr({phoneNumber:e,temporaryProof:t})}_getIdTokenResponse(e){return async function(e,t){return ri(e,"POST","/v1/accounts:signInWithPhoneNumber",ti(e,t))}(e,this._makeVerificationRequest())}_linkToIdToken(e,t){return async function(e,t){const n=await ri(e,"POST","/v1/accounts:signInWithPhoneNumber",ti(e,t));if(n.temporaryProof)throw ci(e,"account-exists-with-different-credential",n);return n}(e,Object.assign({idToken:t},this._makeVerificationRequest()))}_getReauthenticationResolver(e){return async function(e,t){return ri(e,"POST","/v1/accounts:signInWithPhoneNumber",ti(e,Object.assign(Object.assign({},t),{operation:"REAUTH"})),lr)}(e,this._makeVerificationRequest())}_makeVerificationRequest(){const{temporaryProof:e,phoneNumber:t,verificationId:n,verificationCode:i}=this.params;return e&&t?{temporaryProof:e,phoneNumber:t}:{sessionInfo:n,code:i}}toJSON(){const e={providerId:this.providerId};return this.params.phoneNumber&&(e.phoneNumber=this.params.phoneNumber),this.params.temporaryProof&&(e.temporaryProof=this.params.temporaryProof),this.params.verificationCode&&(e.verificationCode=this.params.verificationCode),this.params.verificationId&&(e.verificationId=this.params.verificationId),e}static fromJSON(e){"string"===typeof e&&(e=JSON.parse(e));const{verificationId:t,verificationCode:n,phoneNumber:i,temporaryProof:r}=e;return n||t||i||r?new dr({verificationId:t,verificationCode:n,phoneNumber:i,temporaryProof:r}):null}}class ur{constructor(e){var t,n,i,r,o,s;const a=Xe(Qe(e)),c=null!==(t=a.apiKey)&&void 0!==t?t:null,l=null!==(n=a.oobCode)&&void 0!==n?n:null,d=function(e){switch(e){case"recoverEmail":return"RECOVER_EMAIL";case"resetPassword":return"PASSWORD_RESET";case"signIn":return"EMAIL_SIGNIN";case"verifyEmail":return"VERIFY_EMAIL";case"verifyAndChangeEmail":return"VERIFY_AND_CHANGE_EMAIL";case"revertSecondFactorAddition":return"REVERT_SECOND_FACTOR_ADDITION";default:return null}}(null!==(i=a.mode)&&void 0!==i?i:null);Wn(c&&l&&d,"argument-error"),this.apiKey=c,this.operation=d,this.code=l,this.continueUrl=null!==(r=a.continueUrl)&&void 0!==r?r:null,this.languageCode=null!==(o=a.languageCode)&&void 0!==o?o:null,this.tenantId=null!==(s=a.tenantId)&&void 0!==s?s:null}static parseLink(e){const t=function(e){const t=Xe(Qe(e)).link,n=t?Xe(Qe(t)).deep_link_id:null,i=Xe(Qe(e)).deep_link_id;return(i?Xe(Qe(i)).link:null)||i||n||t||e}(e);try{return new ur(t)}catch(n){return null}}}class hr{constructor(){this.providerId=hr.PROVIDER_ID}static credential(e,t){return sr._fromEmailAndPassword(e,t)}static credentialWithLink(e,t){const n=ur.parseLink(t);return Wn(n,"argument-error"),sr._fromEmailAndCode(e,n.code,n.tenantId)}}hr.PROVIDER_ID="password",hr.EMAIL_PASSWORD_SIGN_IN_METHOD="password",hr.EMAIL_LINK_SIGN_IN_METHOD="emailLink";class pr{constructor(e){this.providerId=e,this.defaultLanguageCode=null,this.customParameters={}}setDefaultLanguage(e){this.defaultLanguageCode=e}setCustomParameters(e){return this.customParameters=e,this}getCustomParameters(){return this.customParameters}}class fr extends pr{constructor(){super(...arguments),this.scopes=[]}addScope(e){return this.scopes.includes(e)||this.scopes.push(e),this}getScopes(){return[...this.scopes]}}class mr extends fr{constructor(){super("facebook.com")}static credential(e){return cr._fromParams({providerId:mr.PROVIDER_ID,signInMethod:mr.FACEBOOK_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return mr.credentialFromTaggedObject(e)}static credentialFromError(e){return mr.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject(e){let{_tokenResponse:t}=e;if(!t||!("oauthAccessToken"in t))return null;if(!t.oauthAccessToken)return null;try{return mr.credential(t.oauthAccessToken)}catch(n){return null}}}mr.FACEBOOK_SIGN_IN_METHOD="facebook.com",mr.PROVIDER_ID="facebook.com";class _r extends fr{constructor(){super("google.com"),this.addScope("profile")}static credential(e,t){return cr._fromParams({providerId:_r.PROVIDER_ID,signInMethod:_r.GOOGLE_SIGN_IN_METHOD,idToken:e,accessToken:t})}static credentialFromResult(e){return _r.credentialFromTaggedObject(e)}static credentialFromError(e){return _r.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject(e){let{_tokenResponse:t}=e;if(!t)return null;const{oauthIdToken:n,oauthAccessToken:i}=t;if(!n&&!i)return null;try{return _r.credential(n,i)}catch(r){return null}}}_r.GOOGLE_SIGN_IN_METHOD="google.com",_r.PROVIDER_ID="google.com";class Er extends fr{constructor(){super("github.com")}static credential(e){return cr._fromParams({providerId:Er.PROVIDER_ID,signInMethod:Er.GITHUB_SIGN_IN_METHOD,accessToken:e})}static credentialFromResult(e){return Er.credentialFromTaggedObject(e)}static credentialFromError(e){return Er.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject(e){let{_tokenResponse:t}=e;if(!t||!("oauthAccessToken"in t))return null;if(!t.oauthAccessToken)return null;try{return Er.credential(t.oauthAccessToken)}catch(n){return null}}}Er.GITHUB_SIGN_IN_METHOD="github.com",Er.PROVIDER_ID="github.com";class gr extends fr{constructor(){super("twitter.com")}static credential(e,t){return cr._fromParams({providerId:gr.PROVIDER_ID,signInMethod:gr.TWITTER_SIGN_IN_METHOD,oauthToken:e,oauthTokenSecret:t})}static credentialFromResult(e){return gr.credentialFromTaggedObject(e)}static credentialFromError(e){return gr.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject(e){let{_tokenResponse:t}=e;if(!t)return null;const{oauthAccessToken:n,oauthTokenSecret:i}=t;if(!n||!i)return null;try{return gr.credential(n,i)}catch(r){return null}}}async function vr(e,t){return ri(e,"POST","/v1/accounts:signUp",ti(e,t))}gr.TWITTER_SIGN_IN_METHOD="twitter.com",gr.PROVIDER_ID="twitter.com";class Tr{constructor(e){this.user=e.user,this.providerId=e.providerId,this._tokenResponse=e._tokenResponse,this.operationType=e.operationType}static async _fromIdTokenResponse(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=await Ri._fromIdTokenResponse(e,n,i),o=Sr(n);return new Tr({user:r,providerId:o,_tokenResponse:n,operationType:t})}static async _forOperation(e,t,n){await e._updateTokensIfNecessary(n,!0);const i=Sr(n);return new Tr({user:e,providerId:i,_tokenResponse:n,operationType:t})}}function Sr(e){return e.providerId?e.providerId:"phoneNumber"in e?"phone":null}class yr extends He{constructor(e,t,n,i){var r;super(t.code,t.message),this.operationType=n,this.user=i,Object.setPrototypeOf(this,yr.prototype),this.customData={appName:e.name,tenantId:null!==(r=e.tenantId)&&void 0!==r?r:void 0,_serverResponse:t.customData._serverResponse,operationType:n}}static _fromErrorAndOperation(e,t,n,i){return new yr(e,t,n,i)}}function Cr(e,t,n,i){return("reauthenticate"===t?n._getReauthenticationResolver(e):n._getIdTokenResponse(e)).catch((n=>{if(n.code==="auth/".concat("multi-factor-auth-required"))throw yr._fromErrorAndOperation(e,n,t,i);throw n}))}async function Rr(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=await Ei(e,t._linkToIdToken(e.auth,await e.getIdToken()),n);return Tr._forOperation(e,"link",i)}async function wr(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{auth:i}=e;if(pn(i.app))return Promise.reject(Bn(i));const r="reauthenticate";try{const o=await Ei(e,Cr(i,r,t,e),n);Wn(o.idToken,i,"internal-error");const s=mi(o.idToken);Wn(s,i,"internal-error");const{sub:a}=s;return Wn(e.uid===a,i,"user-mismatch"),Tr._forOperation(e,r,o)}catch(Dm){throw(null===Dm||void 0===Dm?void 0:Dm.code)==="auth/".concat("user-not-found")&&Vn(i,"user-mismatch"),Dm}}async function Ir(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(pn(e.app))return Promise.reject(Bn(e));const i="signIn",r=await Cr(e,i,t),o=await Tr._fromIdTokenResponse(e,i,r);return n||await e._updateCurrentUser(o.user),o}async function br(e,t){return Ir(zi(e),t)}async function Ar(e){const t=zi(e);t._getPasswordPolicyInternal()&&await t._updatePasswordPolicy()}new WeakMap;const Or="__sak";class Nr{constructor(e,t){this.storageRetriever=e,this.type=t}_isAvailable(){try{return this.storage?(this.storage.setItem(Or,"1"),this.storage.removeItem(Or),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return Promise.resolve(!1)}}_set(e,t){return this.storage.setItem(e,JSON.stringify(t)),Promise.resolve()}_get(e){const t=this.storage.getItem(e);return Promise.resolve(t?JSON.parse(t):null)}_remove(e){return this.storage.removeItem(e),Promise.resolve()}get storage(){return this.storageRetriever()}}class Dr extends Nr{constructor(){super((()=>window.localStorage),"LOCAL"),this.boundEventHandler=(e,t)=>this.onStorageEvent(e,t),this.listeners={},this.localCache={},this.pollTimer=null,this.safariLocalStorageNotSynced=function(){const e=Be();return ki(e)||Fi(e)}()&&function(){try{return!(!window||window===window.top)}catch(Dm){return!1}}(),this.fallbackToPolling=Bi(),this._shouldAllowMigration=!0}forAllChangedKeys(e){for(const t of Object.keys(this.listeners)){const n=this.storage.getItem(t),i=this.localCache[t];n!==i&&e(t,i,n)}}onStorageEvent(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.key)return void this.forAllChangedKeys(((e,t,n)=>{this.notifyListeners(e,n)}));const n=e.key;if(t?this.detachListener():this.stopPolling(),this.safariLocalStorageNotSynced){const i=this.storage.getItem(n);if(e.newValue!==i)null!==e.newValue?this.storage.setItem(n,e.newValue):this.storage.removeItem(n);else if(this.localCache[n]===e.newValue&&!t)return}const i=()=>{const e=this.storage.getItem(n);(t||this.localCache[n]!==e)&&this.notifyListeners(n,e)},r=this.storage.getItem(n);ji()&&r!==e.newValue&&e.newValue!==e.oldValue?setTimeout(i,10):i()}notifyListeners(e,t){this.localCache[e]=t;const n=this.listeners[e];if(n)for(const i of Array.from(n))i(t?JSON.parse(t):t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval((()=>{this.forAllChangedKeys(((e,t,n)=>{this.onStorageEvent(new StorageEvent("storage",{key:e,oldValue:t,newValue:n}),!0)}))}),1e3)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}attachListener(){window.addEventListener("storage",this.boundEventHandler)}detachListener(){window.removeEventListener("storage",this.boundEventHandler)}_addListener(e,t){0===Object.keys(this.listeners).length&&(this.fallbackToPolling?this.startPolling():this.attachListener()),this.listeners[e]||(this.listeners[e]=new Set,this.localCache[e]=this.storage.getItem(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&(this.detachListener(),this.stopPolling())}async _set(e,t){await super._set(e,t),this.localCache[e]=JSON.stringify(t)}async _get(e){const t=await super._get(e);return this.localCache[e]=JSON.stringify(t),t}async _remove(e){await super._remove(e),delete this.localCache[e]}}Dr.type="LOCAL";const Pr=Dr;class kr extends Nr{constructor(){super((()=>window.sessionStorage),"SESSION")}_addListener(e,t){}_removeListener(e,t){}}kr.type="SESSION";const Lr=kr;class Mr{constructor(e){this.eventTarget=e,this.handlersMap={},this.boundEventHandler=this.handleEvent.bind(this)}static _getInstance(e){const t=this.receivers.find((t=>t.isListeningto(e)));if(t)return t;const n=new Mr(e);return this.receivers.push(n),n}isListeningto(e){return this.eventTarget===e}async handleEvent(e){const t=e,{eventId:n,eventType:i,data:r}=t.data,o=this.handlersMap[i];if(!(null===o||void 0===o?void 0:o.size))return;t.ports[0].postMessage({status:"ack",eventId:n,eventType:i});const s=Array.from(o).map((async e=>e(t.origin,r))),a=await function(e){return Promise.all(e.map((async e=>{try{return{fulfilled:!0,value:await e}}catch(t){return{fulfilled:!1,reason:t}}})))}(s);t.ports[0].postMessage({status:"done",eventId:n,eventType:i,response:a})}_subscribe(e,t){0===Object.keys(this.handlersMap).length&&this.eventTarget.addEventListener("message",this.boundEventHandler),this.handlersMap[e]||(this.handlersMap[e]=new Set),this.handlersMap[e].add(t)}_unsubscribe(e,t){this.handlersMap[e]&&t&&this.handlersMap[e].delete(t),t&&0!==this.handlersMap[e].size||delete this.handlersMap[e],0===Object.keys(this.handlersMap).length&&this.eventTarget.removeEventListener("message",this.boundEventHandler)}}function Ur(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n="";for(let i=0;i<t;i++)n+=Math.floor(10*Math.random());return e+n}Mr.receivers=[];class xr{constructor(e){this.target=e,this.handlers=new Set}removeMessageHandler(e){e.messageChannel&&(e.messageChannel.port1.removeEventListener("message",e.onMessage),e.messageChannel.port1.close()),this.handlers.delete(e)}async _send(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50;const i="undefined"!==typeof MessageChannel?new MessageChannel:null;if(!i)throw new Error("connection_unavailable");let r,o;return new Promise(((s,a)=>{const c=Ur("",20);i.port1.start();const l=setTimeout((()=>{a(new Error("unsupported_event"))}),n);o={messageChannel:i,onMessage(e){const t=e;if(t.data.eventId===c)switch(t.data.status){case"ack":clearTimeout(l),r=setTimeout((()=>{a(new Error("timeout"))}),3e3);break;case"done":clearTimeout(r),s(t.data.response);break;default:clearTimeout(l),clearTimeout(r),a(new Error("invalid_response"))}}},this.handlers.add(o),i.port1.addEventListener("message",o.onMessage),this.target.postMessage({eventType:e,eventId:c,data:t},[i.port2])})).finally((()=>{o&&this.removeMessageHandler(o)}))}}function Vr(){return window}function Fr(){return"undefined"!==typeof Vr().WorkerGlobalScope&&"function"===typeof Vr().importScripts}const jr="firebaseLocalStorageDb",Br="firebaseLocalStorage",Gr="fbase_key";class Wr{constructor(e){this.request=e}toPromise(){return new Promise(((e,t)=>{this.request.addEventListener("success",(()=>{e(this.request.result)})),this.request.addEventListener("error",(()=>{t(this.request.error)}))}))}}function Hr(e,t){return e.transaction([Br],t?"readwrite":"readonly").objectStore(Br)}function Kr(){const e=indexedDB.open(jr,1);return new Promise(((t,n)=>{e.addEventListener("error",(()=>{n(e.error)})),e.addEventListener("upgradeneeded",(()=>{const t=e.result;try{t.createObjectStore(Br,{keyPath:Gr})}catch(Dm){n(Dm)}})),e.addEventListener("success",(async()=>{const n=e.result;n.objectStoreNames.contains(Br)?t(n):(n.close(),await function(){const e=indexedDB.deleteDatabase(jr);return new Wr(e).toPromise()}(),t(await Kr()))}))}))}async function zr(e,t,n){const i=Hr(e,!0).put({[Gr]:t,value:n});return new Wr(i).toPromise()}function qr(e,t){const n=Hr(e,!0).delete(t);return new Wr(n).toPromise()}class Yr{constructor(){this.type="LOCAL",this._shouldAllowMigration=!0,this.listeners={},this.localCache={},this.pollTimer=null,this.pendingWrites=0,this.receiver=null,this.sender=null,this.serviceWorkerReceiverAvailable=!1,this.activeServiceWorker=null,this._workerInitializationPromise=this.initializeServiceWorkerMessaging().then((()=>{}),(()=>{}))}async _openDb(){return this.db||(this.db=await Kr()),this.db}async _withRetries(e){let t=0;for(;;)try{const t=await this._openDb();return await e(t)}catch(Dm){if(t++>3)throw Dm;this.db&&(this.db.close(),this.db=void 0)}}async initializeServiceWorkerMessaging(){return Fr()?this.initializeReceiver():this.initializeSender()}async initializeReceiver(){this.receiver=Mr._getInstance(Fr()?self:null),this.receiver._subscribe("keyChanged",(async(e,t)=>({keyProcessed:(await this._poll()).includes(t.key)}))),this.receiver._subscribe("ping",(async(e,t)=>["keyChanged"]))}async initializeSender(){var e,t;if(this.activeServiceWorker=await async function(){if(!(null===navigator||void 0===navigator?void 0:navigator.serviceWorker))return null;try{return(await navigator.serviceWorker.ready).active}catch(e){return null}}(),!this.activeServiceWorker)return;this.sender=new xr(this.activeServiceWorker);const n=await this.sender._send("ping",{},800);n&&(null===(e=n[0])||void 0===e?void 0:e.fulfilled)&&(null===(t=n[0])||void 0===t?void 0:t.value.includes("keyChanged"))&&(this.serviceWorkerReceiverAvailable=!0)}async notifyServiceWorker(e){if(this.sender&&this.activeServiceWorker&&function(){var e;return(null===(e=null===navigator||void 0===navigator?void 0:navigator.serviceWorker)||void 0===e?void 0:e.controller)||null}()===this.activeServiceWorker)try{await this.sender._send("keyChanged",{key:e},this.serviceWorkerReceiverAvailable?800:50)}catch(t){}}async _isAvailable(){try{if(!indexedDB)return!1;const e=await Kr();return await zr(e,Or,"1"),await qr(e,Or),!0}catch(e){}return!1}async _withPendingWrite(e){this.pendingWrites++;try{await e()}finally{this.pendingWrites--}}async _set(e,t){return this._withPendingWrite((async()=>(await this._withRetries((n=>zr(n,e,t))),this.localCache[e]=t,this.notifyServiceWorker(e))))}async _get(e){const t=await this._withRetries((t=>async function(e,t){const n=Hr(e,!1).get(t),i=await new Wr(n).toPromise();return void 0===i?null:i.value}(t,e)));return this.localCache[e]=t,t}async _remove(e){return this._withPendingWrite((async()=>(await this._withRetries((t=>qr(t,e))),delete this.localCache[e],this.notifyServiceWorker(e))))}async _poll(){const e=await this._withRetries((e=>{const t=Hr(e,!1).getAll();return new Wr(t).toPromise()}));if(!e)return[];if(0!==this.pendingWrites)return[];const t=[],n=new Set;if(0!==e.length)for(const{fbase_key:i,value:r}of e)n.add(i),JSON.stringify(this.localCache[i])!==JSON.stringify(r)&&(this.notifyListeners(i,r),t.push(i));for(const i of Object.keys(this.localCache))this.localCache[i]&&!n.has(i)&&(this.notifyListeners(i,null),t.push(i));return t}notifyListeners(e,t){this.localCache[e]=t;const n=this.listeners[e];if(n)for(const i of Array.from(n))i(t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval((async()=>this._poll()),800)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}_addListener(e,t){0===Object.keys(this.listeners).length&&this.startPolling(),this.listeners[e]||(this.listeners[e]=new Set,this._get(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&this.stopPolling()}}Yr.type="LOCAL";const Jr=Yr;Xi("rcb"),new Xn(3e4,6e4);const Xr="recaptcha";async function Qr(e,t,n){var i;const r=await n.verify();try{let o;if(Wn("string"===typeof r,e,"argument-error"),Wn(n.type===Xr,e,"argument-error"),o="string"===typeof t?{phoneNumber:t}:t,"session"in o){const t=o.session;if("phoneNumber"in o){Wn("enroll"===t.type,e,"internal-error");const n=await function(e,t){return ni(e,"POST","/v2/accounts/mfaEnrollment:start",ti(e,t))}(e,{idToken:t.credential,phoneEnrollmentInfo:{phoneNumber:o.phoneNumber,recaptchaToken:r}});return n.phoneSessionInfo.sessionInfo}{Wn("signin"===t.type,e,"internal-error");const n=(null===(i=o.multiFactorHint)||void 0===i?void 0:i.uid)||o.multiFactorUid;Wn(n,e,"missing-multi-factor-info");const s=await function(e,t){return ni(e,"POST","/v2/accounts/mfaSignIn:start",ti(e,t))}(e,{mfaPendingCredential:t.credential,mfaEnrollmentId:n,phoneSignInInfo:{recaptchaToken:r}});return s.phoneResponseInfo.sessionInfo}}{const{sessionInfo:t}=await async function(e,t){return ni(e,"POST","/v1/accounts:sendVerificationCode",ti(e,t))}(e,{phoneNumber:o.phoneNumber,recaptchaToken:r});return t}}finally{n._reset()}}class Zr{constructor(e){this.providerId=Zr.PROVIDER_ID,this.auth=zi(e)}verifyPhoneNumber(e,t){return Qr(this.auth,e,et(t))}static credential(e,t){return dr._fromVerification(e,t)}static credentialFromResult(e){const t=e;return Zr.credentialFromTaggedObject(t)}static credentialFromError(e){return Zr.credentialFromTaggedObject(e.customData||{})}static credentialFromTaggedObject(e){let{_tokenResponse:t}=e;if(!t)return null;const{phoneNumber:n,temporaryProof:i}=t;return n&&i?dr._fromTokenResponse(n,i):null}}function $r(e,t){return t?Ii(t):(Wn(e._popupRedirectResolver,e,"argument-error"),e._popupRedirectResolver)}Zr.PROVIDER_ID="phone",Zr.PHONE_SIGN_IN_METHOD="phone";class eo extends ir{constructor(e){super("custom","custom"),this.params=e}_getIdTokenResponse(e){return ar(e,this._buildIdpRequest())}_linkToIdToken(e,t){return ar(e,this._buildIdpRequest(t))}_getReauthenticationResolver(e){return ar(e,this._buildIdpRequest())}_buildIdpRequest(e){const t={requestUri:this.params.requestUri,sessionId:this.params.sessionId,postBody:this.params.postBody,tenantId:this.params.tenantId,pendingToken:this.params.pendingToken,returnSecureToken:!0,returnIdpCredential:!0};return e&&(t.idToken=e),t}}function to(e){return Ir(e.auth,new eo(e),e.bypassAuthState)}function no(e){const{auth:t,user:n}=e;return Wn(n,t,"internal-error"),wr(n,new eo(e),e.bypassAuthState)}async function io(e){const{auth:t,user:n}=e;return Wn(n,t,"internal-error"),Rr(n,new eo(e),e.bypassAuthState)}class ro{constructor(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.auth=e,this.resolver=n,this.user=i,this.bypassAuthState=r,this.pendingPromise=null,this.eventManager=null,this.filter=Array.isArray(t)?t:[t]}execute(){return new Promise((async(e,t)=>{this.pendingPromise={resolve:e,reject:t};try{this.eventManager=await this.resolver._initialize(this.auth),await this.onExecution(),this.eventManager.registerConsumer(this)}catch(Dm){this.reject(Dm)}}))}async onAuthEvent(e){const{urlResponse:t,sessionId:n,postBody:i,tenantId:r,error:o,type:s}=e;if(o)return void this.reject(o);const a={auth:this.auth,requestUri:t,sessionId:n,tenantId:r||void 0,postBody:i||void 0,user:this.user,bypassAuthState:this.bypassAuthState};try{this.resolve(await this.getIdpTask(s)(a))}catch(Dm){this.reject(Dm)}}onError(e){this.reject(e)}getIdpTask(e){switch(e){case"signInViaPopup":case"signInViaRedirect":return to;case"linkViaPopup":case"linkViaRedirect":return io;case"reauthViaPopup":case"reauthViaRedirect":return no;default:Vn(this.auth,"internal-error")}}resolve(e){Kn(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.resolve(e),this.unregisterAndCleanUp()}reject(e){Kn(this.pendingPromise,"Pending promise was never set"),this.pendingPromise.reject(e),this.unregisterAndCleanUp()}unregisterAndCleanUp(){this.eventManager&&this.eventManager.unregisterConsumer(this),this.pendingPromise=null,this.cleanUp()}}const oo=new Xn(2e3,1e4);class so extends ro{constructor(e,t,n,i,r){super(e,t,i,r),this.provider=n,this.authWindow=null,this.pollId=null,so.currentPopupAction&&so.currentPopupAction.cancel(),so.currentPopupAction=this}async executeNotNull(){const e=await this.execute();return Wn(e,this.auth,"internal-error"),e}async onExecution(){Kn(1===this.filter.length,"Popup operations only handle one event");const e=Ur();this.authWindow=await this.resolver._openPopup(this.auth,this.provider,this.filter[0],e),this.authWindow.associatedEvent=e,this.resolver._originValidation(this.auth).catch((e=>{this.reject(e)})),this.resolver._isIframeWebStorageSupported(this.auth,(e=>{e||this.reject(Fn(this.auth,"web-storage-unsupported"))})),this.pollUserCancellation()}get eventId(){var e;return(null===(e=this.authWindow)||void 0===e?void 0:e.associatedEvent)||null}cancel(){this.reject(Fn(this.auth,"cancelled-popup-request"))}cleanUp(){this.authWindow&&this.authWindow.close(),this.pollId&&window.clearTimeout(this.pollId),this.authWindow=null,this.pollId=null,so.currentPopupAction=null}pollUserCancellation(){const e=()=>{var t,n;(null===(n=null===(t=this.authWindow)||void 0===t?void 0:t.window)||void 0===n?void 0:n.closed)?this.pollId=window.setTimeout((()=>{this.pollId=null,this.reject(Fn(this.auth,"popup-closed-by-user"))}),8e3):this.pollId=window.setTimeout(e,oo.get())};e()}}so.currentPopupAction=null;const ao="pendingRedirect",co=new Map;class lo extends ro{constructor(e,t){super(e,["signInViaRedirect","linkViaRedirect","reauthViaRedirect","unknown"],t,void 0,arguments.length>2&&void 0!==arguments[2]&&arguments[2]),this.eventId=null}async execute(){let e=co.get(this.auth._key());if(!e){try{const t=await async function(e,t){const n=po(t),i=ho(e);if(!await i._isAvailable())return!1;const r="true"===await i._get(n);return await i._remove(n),r}(this.resolver,this.auth),n=t?await super.execute():null;e=()=>Promise.resolve(n)}catch(Dm){e=()=>Promise.reject(Dm)}co.set(this.auth._key(),e)}return this.bypassAuthState||co.set(this.auth._key(),(()=>Promise.resolve(null))),e()}async onAuthEvent(e){if("signInViaRedirect"===e.type)return super.onAuthEvent(e);if("unknown"!==e.type){if(e.eventId){const t=await this.auth._redirectUserForId(e.eventId);if(t)return this.user=t,super.onAuthEvent(e);this.resolve(null)}}else this.resolve(null)}async onExecution(){}cleanUp(){}}function uo(e,t){co.set(e._key(),t)}function ho(e){return Ii(e._redirectPersistence)}function po(e){return Oi(ao,e.config.apiKey,e.name)}async function fo(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(pn(e.app))return Promise.reject(Bn(e));const i=zi(e),r=$r(i,t),o=new lo(i,r,n),s=await o.execute();return s&&!n&&(delete s.user._redirectEventId,await i._persistUserIfCurrent(s.user),await i._setRedirectUser(null,t)),s}class mo{constructor(e){this.auth=e,this.cachedEventUids=new Set,this.consumers=new Set,this.queuedRedirectEvent=null,this.hasHandledPotentialRedirect=!1,this.lastProcessedEventTime=Date.now()}registerConsumer(e){this.consumers.add(e),this.queuedRedirectEvent&&this.isEventForConsumer(this.queuedRedirectEvent,e)&&(this.sendToConsumer(this.queuedRedirectEvent,e),this.saveEventToCache(this.queuedRedirectEvent),this.queuedRedirectEvent=null)}unregisterConsumer(e){this.consumers.delete(e)}onEvent(e){if(this.hasEventBeenHandled(e))return!1;let t=!1;return this.consumers.forEach((n=>{this.isEventForConsumer(e,n)&&(t=!0,this.sendToConsumer(e,n),this.saveEventToCache(e))})),this.hasHandledPotentialRedirect||!function(e){switch(e.type){case"signInViaRedirect":case"linkViaRedirect":case"reauthViaRedirect":return!0;case"unknown":return Eo(e);default:return!1}}(e)||(this.hasHandledPotentialRedirect=!0,t||(this.queuedRedirectEvent=e,t=!0)),t}sendToConsumer(e,t){var n;if(e.error&&!Eo(e)){const i=(null===(n=e.error.code)||void 0===n?void 0:n.split("auth/")[1])||"internal-error";t.onError(Fn(this.auth,i))}else t.onAuthEvent(e)}isEventForConsumer(e,t){const n=null===t.eventId||!!e.eventId&&e.eventId===t.eventId;return t.filter.includes(e.type)&&n}hasEventBeenHandled(e){return Date.now()-this.lastProcessedEventTime>=6e5&&this.cachedEventUids.clear(),this.cachedEventUids.has(_o(e))}saveEventToCache(e){this.cachedEventUids.add(_o(e)),this.lastProcessedEventTime=Date.now()}}function _o(e){return[e.type,e.eventId,e.sessionId,e.tenantId].filter((e=>e)).join("-")}function Eo(e){let{type:t,error:n}=e;return"unknown"===t&&(null===n||void 0===n?void 0:n.code)==="auth/".concat("no-auth-event")}const go=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,vo=/^https?/;async function To(e){if(e.config.emulator)return;const{authorizedDomains:t}=await async function(e){return ni(e,"GET","/v1/projects",arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})}(e);for(const i of t)try{if(So(i))return}catch(n){}Vn(e,"unauthorized-domain")}function So(e){const t=zn(),{protocol:n,hostname:i}=new URL(t);if(e.startsWith("chrome-extension://")){const r=new URL(e);return""===r.hostname&&""===i?"chrome-extension:"===n&&e.replace("chrome-extension://","")===t.replace("chrome-extension://",""):"chrome-extension:"===n&&r.hostname===i}if(!vo.test(n))return!1;if(go.test(e))return i===e;const r=e.replace(/\./g,"\\.");return new RegExp("^(.+\\."+r+"|"+r+")$","i").test(i)}const yo=new Xn(3e4,6e4);function Co(){const e=Vr().___jsl;if(null===e||void 0===e?void 0:e.H)for(const t of Object.keys(e.H))if(e.H[t].r=e.H[t].r||[],e.H[t].L=e.H[t].L||[],e.H[t].r=[...e.H[t].L],e.CP)for(let n=0;n<e.CP.length;n++)e.CP[n]=null}function Ro(e){return new Promise(((t,n)=>{var i,r,o;function s(){Co(),gapi.load("gapi.iframes",{callback:()=>{t(gapi.iframes.getContext())},ontimeout:()=>{Co(),n(Fn(e,"network-request-failed"))},timeout:yo.get()})}if(null===(r=null===(i=Vr().gapi)||void 0===i?void 0:i.iframes)||void 0===r?void 0:r.Iframe)t(gapi.iframes.getContext());else{if(!(null===(o=Vr().gapi)||void 0===o?void 0:o.load)){const t=Xi("iframefcb");return Vr()[t]=()=>{gapi.load?s():n(Fn(e,"network-request-failed"))},Ji("".concat(Yi.gapiScript,"?onload=").concat(t)).catch((e=>n(e)))}s()}})).catch((e=>{throw wo=null,e}))}let wo=null;const Io=new Xn(5e3,15e3),bo="__/auth/iframe",Ao="emulator/auth/iframe",Oo={style:{position:"absolute",top:"-100px",width:"1px",height:"1px"},"aria-hidden":"true",tabindex:"-1"},No=new Map([["identitytoolkit.googleapis.com","p"],["staging-identitytoolkit.sandbox.googleapis.com","s"],["test-identitytoolkit.sandbox.googleapis.com","t"]]);function Do(e){const t=e.config;Wn(t.authDomain,e,"auth-domain-config-required");const n=t.emulator?Qn(t,Ao):"https://".concat(e.config.authDomain,"/").concat(bo),i={apiKey:t.apiKey,appName:e.name,v:_n},r=No.get(e.config.apiHost);r&&(i.eid=r);const o=e._getFrameworks();return o.length&&(i.fw=o.join(",")),"".concat(n,"?").concat(Je(i).slice(1))}async function Po(e){const t=await function(e){return wo=wo||Ro(e),wo}(e),n=Vr().gapi;return Wn(n,e,"internal-error"),t.open({where:document.body,url:Do(e),messageHandlersFilter:n.iframes.CROSS_ORIGIN_IFRAMES_FILTER,attributes:Oo,dontclear:!0},(t=>new Promise((async(n,i)=>{await t.restyle({setHideOnLeave:!1});const r=Fn(e,"network-request-failed"),o=Vr().setTimeout((()=>{i(r)}),Io.get());function s(){Vr().clearTimeout(o),n(t)}t.ping(s).then(s,(()=>{i(r)}))}))))}const ko={location:"yes",resizable:"yes",statusbar:"yes",toolbar:"no"};class Lo{constructor(e){this.window=e,this.associatedEvent=null}close(){if(this.window)try{this.window.close()}catch(Dm){}}}function Mo(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:600;const o=Math.max((window.screen.availHeight-r)/2,0).toString(),s=Math.max((window.screen.availWidth-i)/2,0).toString();let a="";const c=Object.assign(Object.assign({},ko),{width:i.toString(),height:r.toString(),top:o,left:s}),l=Be().toLowerCase();n&&(a=Li(l)?"_blank":n),Pi(l)&&(t=t||"http://localhost",c.scrollbars="yes");const d=Object.entries(c).reduce(((e,t)=>{let[n,i]=t;return"".concat(e).concat(n,"=").concat(i,",")}),"");if(function(){var e;return Fi(arguments.length>0&&void 0!==arguments[0]?arguments[0]:Be())&&!!(null===(e=window.navigator)||void 0===e?void 0:e.standalone)}(l)&&"_self"!==a)return function(e,t){const n=document.createElement("a");n.href=e,n.target=t;const i=document.createEvent("MouseEvent");i.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,1,null),n.dispatchEvent(i)}(t||"",a),new Lo(null);const u=window.open(t||"",a,d);Wn(u,e,"popup-blocked");try{u.focus()}catch(Dm){}return new Lo(u)}const Uo="__/auth/handler",xo="emulator/auth/handler",Vo=encodeURIComponent("fac");async function Fo(e,t,n,i,r,o){Wn(e.config.authDomain,e,"auth-domain-config-required"),Wn(e.config.apiKey,e,"invalid-api-key");const s={apiKey:e.config.apiKey,appName:e.name,authType:n,redirectUrl:i,v:_n,eventId:r};if(t instanceof pr){t.setDefaultLanguage(e.languageCode),s.providerId=t.providerId||"",function(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}(t.getCustomParameters())||(s.customParameters=JSON.stringify(t.getCustomParameters()));for(const[e,t]of Object.entries(o||{}))s[e]=t}if(t instanceof fr){const e=t.getScopes().filter((e=>""!==e));e.length>0&&(s.scopes=e.join(","))}e.tenantId&&(s.tid=e.tenantId);const a=s;for(const d of Object.keys(a))void 0===a[d]&&delete a[d];const c=await e._getAppCheckToken(),l=c?"#".concat(Vo,"=").concat(encodeURIComponent(c)):"";return"".concat(function(e){let{config:t}=e;if(!t.emulator)return"https://".concat(t.authDomain,"/").concat(Uo);return Qn(t,xo)}(e),"?").concat(Je(a).slice(1)).concat(l)}const jo="webStorageSupport";const Bo=class{constructor(){this.eventManagers={},this.iframes={},this.originValidationPromises={},this._redirectPersistence=Lr,this._completeRedirectFn=fo,this._overrideRedirectResult=uo}async _openPopup(e,t,n,i){var r;Kn(null===(r=this.eventManagers[e._key()])||void 0===r?void 0:r.manager,"_initialize() not called before _openPopup()");return Mo(e,await Fo(e,t,n,zn(),i),Ur())}async _openRedirect(e,t,n,i){await this._originValidation(e);return function(e){Vr().location.href=e}(await Fo(e,t,n,zn(),i)),new Promise((()=>{}))}_initialize(e){const t=e._key();if(this.eventManagers[t]){const{manager:e,promise:n}=this.eventManagers[t];return e?Promise.resolve(e):(Kn(n,"If manager is not set, promise should be"),n)}const n=this.initAndGetManager(e);return this.eventManagers[t]={promise:n},n.catch((()=>{delete this.eventManagers[t]})),n}async initAndGetManager(e){const t=await Po(e),n=new mo(e);return t.register("authEvent",(t=>{Wn(null===t||void 0===t?void 0:t.authEvent,e,"invalid-auth-event");return{status:n.onEvent(t.authEvent)?"ACK":"ERROR"}}),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER),this.eventManagers[e._key()]={manager:n},this.iframes[e._key()]=t,n}_isIframeWebStorageSupported(e,t){this.iframes[e._key()].send(jo,{type:jo},(n=>{var i;const r=null===(i=null===n||void 0===n?void 0:n[0])||void 0===i?void 0:i[jo];void 0!==r&&t(!!r),Vn(e,"internal-error")}),gapi.iframes.CROSS_ORIGIN_IFRAMES_FILTER)}_originValidation(e){const t=e._key();return this.originValidationPromises[t]||(this.originValidationPromises[t]=To(e)),this.originValidationPromises[t]}get _shouldInitProactively(){return Bi()||ki()||Fi()}};var Go="@firebase/auth",Wo="1.7.4";class Ho{constructor(e){this.auth=e,this.internalListeners=new Map}getUid(){var e;return this.assertAuthConfigured(),(null===(e=this.auth.currentUser)||void 0===e?void 0:e.uid)||null}async getToken(e){if(this.assertAuthConfigured(),await this.auth._initializationPromise,!this.auth.currentUser)return null;return{accessToken:await this.auth.currentUser.getIdToken(e)}}addAuthTokenListener(e){if(this.assertAuthConfigured(),this.internalListeners.has(e))return;const t=this.auth.onIdTokenChanged((t=>{e((null===t||void 0===t?void 0:t.stsTokenManager.accessToken)||null)}));this.internalListeners.set(e,t),this.updateProactiveRefresh()}removeAuthTokenListener(e){this.assertAuthConfigured();const t=this.internalListeners.get(e);t&&(this.internalListeners.delete(e),t(),this.updateProactiveRefresh())}assertAuthConfigured(){Wn(this.auth._initializationPromise,"dependent-sdk-initialized-before-auth")}updateProactiveRefresh(){this.internalListeners.size>0?this.auth._startProactiveRefresh():this.auth._stopProactiveRefresh()}}const Ko=Ve("authIdTokenMaxAge")||300;let zo=null;var qo;Yi={loadJS:e=>new Promise(((t,n)=>{const i=document.createElement("script");i.setAttribute("src",e),i.onload=t,i.onerror=e=>{const t=Fn("internal-error");t.customData=e,n(t)},i.type="text/javascript",i.charset="UTF-8",function(){var e,t;return null!==(t=null===(e=document.getElementsByTagName("head"))||void 0===e?void 0:e[0])&&void 0!==t?t:document}().appendChild(i)})),gapiScript:"https://apis.google.com/js/api.js",recaptchaV2Script:"https://www.google.com/recaptcha/api.js",recaptchaEnterpriseScript:"https://www.google.com/recaptcha/enterprise.js?render="},qo="Browser",un(new tt("auth",((e,t)=>{let{options:n}=t;const i=e.getProvider("app").getImmediate(),r=e.getProvider("heartbeat"),o=e.getProvider("app-check-internal"),{apiKey:s,authDomain:a}=i.options;Wn(s&&!s.includes(":"),"invalid-api-key",{appName:i.name});const c={apiKey:s,authDomain:a,clientPlatform:qo,apiHost:"identitytoolkit.googleapis.com",tokenApiHost:"securetoken.googleapis.com",apiScheme:"https",sdkClientVersion:Gi(qo)},l=new Ki(i,r,o,c);return function(e,t){const n=(null===t||void 0===t?void 0:t.persistence)||[],i=(Array.isArray(n)?n:[n]).map(Ii);(null===t||void 0===t?void 0:t.errorMap)&&e._updateErrorMap(t.errorMap),e._initializeWithPersistence(i,null===t||void 0===t?void 0:t.popupRedirectResolver)}(l,n),l}),"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback(((e,t,n)=>{e.getProvider("auth-internal").initialize()}))),un(new tt("auth-internal",(e=>(e=>new Ho(e))(zi(e.getProvider("auth").getImmediate()))),"PRIVATE").setInstantiationMode("EXPLICIT")),vn(Go,Wo,function(e){switch(e){case"Node":return"node";case"ReactNative":return"rn";case"Worker":return"webworker";case"Cordova":return"cordova";case"WebExtension":return"web-extension";default:return}}(qo)),vn(Go,Wo,"esm2017");vn("firebase","10.12.2","app");const Yo="firebasestorage.googleapis.com",Jo="storageBucket";class Xo extends He{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;super($o(e),"Firebase Storage: ".concat(t," (").concat($o(e),")")),this.status_=n,this.customData={serverResponse:null},this._baseMessage=this.message,Object.setPrototypeOf(this,Xo.prototype)}get status(){return this.status_}set status(e){this.status_=e}_codeEquals(e){return $o(e)===this.code}get serverResponse(){return this.customData.serverResponse}set serverResponse(e){this.customData.serverResponse=e,this.customData.serverResponse?this.message="".concat(this._baseMessage,"\n").concat(this.customData.serverResponse):this.message=this._baseMessage}}var Qo,Zo;function $o(e){return"storage/"+e}function es(){return new Xo(Qo.UNKNOWN,"An unknown error occurred, please check the error payload for server response.")}function ts(){return new Xo(Qo.RETRY_LIMIT_EXCEEDED,"Max retry time for operation exceeded, please try again.")}function ns(){return new Xo(Qo.CANCELED,"User canceled the upload/download.")}function is(e){return new Xo(Qo.INVALID_ARGUMENT,e)}function rs(){return new Xo(Qo.APP_DELETED,"The Firebase app was deleted.")}!function(e){e.UNKNOWN="unknown",e.OBJECT_NOT_FOUND="object-not-found",e.BUCKET_NOT_FOUND="bucket-not-found",e.PROJECT_NOT_FOUND="project-not-found",e.QUOTA_EXCEEDED="quota-exceeded",e.UNAUTHENTICATED="unauthenticated",e.UNAUTHORIZED="unauthorized",e.UNAUTHORIZED_APP="unauthorized-app",e.RETRY_LIMIT_EXCEEDED="retry-limit-exceeded",e.INVALID_CHECKSUM="invalid-checksum",e.CANCELED="canceled",e.INVALID_EVENT_NAME="invalid-event-name",e.INVALID_URL="invalid-url",e.INVALID_DEFAULT_BUCKET="invalid-default-bucket",e.NO_DEFAULT_BUCKET="no-default-bucket",e.CANNOT_SLICE_BLOB="cannot-slice-blob",e.SERVER_FILE_WRONG_SIZE="server-file-wrong-size",e.NO_DOWNLOAD_URL="no-download-url",e.INVALID_ARGUMENT="invalid-argument",e.INVALID_ARGUMENT_COUNT="invalid-argument-count",e.APP_DELETED="app-deleted",e.INVALID_ROOT_OPERATION="invalid-root-operation",e.INVALID_FORMAT="invalid-format",e.INTERNAL_ERROR="internal-error",e.UNSUPPORTED_ENVIRONMENT="unsupported-environment"}(Qo||(Qo={}));class os{constructor(e,t){this.bucket=e,this.path_=t}get path(){return this.path_}get isRoot(){return 0===this.path.length}fullServerUrl(){const e=encodeURIComponent;return"/b/"+e(this.bucket)+"/o/"+e(this.path)}bucketOnlyServerUrl(){return"/b/"+encodeURIComponent(this.bucket)+"/o"}static makeFromBucketSpec(e,t){let n;try{n=os.makeFromUrl(e,t)}catch(Dm){return new os(e,"")}if(""===n.path)return n;throw i=e,new Xo(Qo.INVALID_DEFAULT_BUCKET,"Invalid default bucket '"+i+"'.");var i}static makeFromUrl(e,t){let n=null;const i="([A-Za-z0-9.\\-_]+)";const r=new RegExp("^gs://"+i+"(/(.*))?$","i");function o(e){e.path_=decodeURIComponent(e.path)}const s=t.replace(/[.]/g,"\\."),a=[{regex:r,indices:{bucket:1,path:3},postModify:function(e){"/"===e.path.charAt(e.path.length-1)&&(e.path_=e.path_.slice(0,-1))}},{regex:new RegExp("^https?://".concat(s,"/").concat("v[A-Za-z0-9_]+","/b/").concat(i,"/o").concat("(/([^?#]*).*)?$"),"i"),indices:{bucket:1,path:3},postModify:o},{regex:new RegExp("^https?://".concat(t===Yo?"(?:storage.googleapis.com|storage.cloud.google.com)":t,"/").concat(i,"/").concat("([^?#]*)"),"i"),indices:{bucket:1,path:2},postModify:o}];for(let c=0;c<a.length;c++){const t=a[c],i=t.regex.exec(e);if(i){const e=i[t.indices.bucket];let r=i[t.indices.path];r||(r=""),n=new os(e,r),t.postModify(n);break}}if(null==n)throw function(e){return new Xo(Qo.INVALID_URL,"Invalid URL '"+e+"'.")}(e);return n}}class ss{constructor(e){this.promise_=Promise.reject(e)}getPromise(){return this.promise_}cancel(){}}function as(e,t,n,i){if(i<t)throw is("Invalid value for '".concat(e,"'. Expected ").concat(t," or greater."));if(i>n)throw is("Invalid value for '".concat(e,"'. Expected ").concat(n," or less."))}function cs(e){const t=encodeURIComponent;let n="?";for(const i in e)if(e.hasOwnProperty(i)){n=n+(t(i)+"="+t(e[i]))+"&"}return n=n.slice(0,-1),n}function ls(e,t){const n=e>=500&&e<600,i=-1!==[408,429].indexOf(e),r=-1!==t.indexOf(e);return n||i||r}!function(e){e[e.NO_ERROR=0]="NO_ERROR",e[e.NETWORK_ERROR=1]="NETWORK_ERROR",e[e.ABORT=2]="ABORT"}(Zo||(Zo={}));class ds{constructor(e,t,n,i,r,o,s,a,c,l,d){let u=!(arguments.length>11&&void 0!==arguments[11])||arguments[11];this.url_=e,this.method_=t,this.headers_=n,this.body_=i,this.successCodes_=r,this.additionalRetryCodes_=o,this.callback_=s,this.errorCallback_=a,this.timeout_=c,this.progressCallback_=l,this.connectionFactory_=d,this.retry=u,this.pendingConnection_=null,this.backoffId_=null,this.canceled_=!1,this.appDelete_=!1,this.promise_=new Promise(((e,t)=>{this.resolve_=e,this.reject_=t,this.start_()}))}start_(){const e=(e,t)=>{if(t)return void e(!1,new us(!1,null,!0));const n=this.connectionFactory_();this.pendingConnection_=n;const i=e=>{const t=e.loaded,n=e.lengthComputable?e.total:-1;null!==this.progressCallback_&&this.progressCallback_(t,n)};null!==this.progressCallback_&&n.addUploadProgressListener(i),n.send(this.url_,this.method_,this.body_,this.headers_).then((()=>{null!==this.progressCallback_&&n.removeUploadProgressListener(i),this.pendingConnection_=null;const t=n.getErrorCode()===Zo.NO_ERROR,r=n.getStatus();if(!t||ls(r,this.additionalRetryCodes_)&&this.retry){const t=n.getErrorCode()===Zo.ABORT;return void e(!1,new us(!1,null,t))}const o=-1!==this.successCodes_.indexOf(r);e(!0,new us(o,n))}))},t=(e,t)=>{const n=this.resolve_,i=this.reject_,r=t.connection;if(t.wasSuccessCode)try{const e=this.callback_(r,r.getResponse());!function(e){return void 0!==e}(e)?n():n(e)}catch(Dm){i(Dm)}else if(null!==r){const e=es();e.serverResponse=r.getErrorText(),this.errorCallback_?i(this.errorCallback_(r,e)):i(e)}else if(t.canceled){i(this.appDelete_?rs():ns())}else{i(ts())}};this.canceled_?t(0,new us(!1,null,!0)):this.backoffId_=function(e,t,n){let i=1,r=null,o=null,s=!1,a=0;function c(){return 2===a}let l=!1;function d(){if(!l){l=!0;for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];t.apply(null,n)}}function u(t){r=setTimeout((()=>{r=null,e(p,c())}),t)}function h(){o&&clearTimeout(o)}function p(e){if(l)return void h();for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(e)return h(),void d.call(null,e,...n);if(c()||s)return h(),void d.call(null,e,...n);let o;i<64&&(i*=2),1===a?(a=2,o=0):o=1e3*(i+Math.random()),u(o)}let f=!1;function m(e){f||(f=!0,h(),l||(null!==r?(e||(a=2),clearTimeout(r),u(0)):e||(a=1)))}return u(0),o=setTimeout((()=>{s=!0,m(!0)}),n),m}(e,t,this.timeout_)}getPromise(){return this.promise_}cancel(e){this.canceled_=!0,this.appDelete_=e||!1,null!==this.backoffId_&&(0,this.backoffId_)(!1),null!==this.pendingConnection_&&this.pendingConnection_.abort()}}class us{constructor(e,t,n){this.wasSuccessCode=e,this.connection=t,this.canceled=!!n}}function hs(e){const t=e.lastIndexOf("/",e.length-2);return-1===t?e:e.slice(t+1)}class ps{constructor(e,t){this._service=e,this._location=t instanceof os?t:os.makeFromUrl(t,e.host)}toString(){return"gs://"+this._location.bucket+"/"+this._location.path}_newRef(e,t){return new ps(e,t)}get root(){const e=new os(this._location.bucket,"");return this._newRef(this._service,e)}get bucket(){return this._location.bucket}get fullPath(){return this._location.path}get name(){return hs(this._location.path)}get storage(){return this._service}get parent(){const e=function(e){if(0===e.length)return null;const t=e.lastIndexOf("/");return-1===t?"":e.slice(0,t)}(this._location.path);if(null===e)return null;const t=new os(this._location.bucket,e);return new ps(this._service,t)}_throwIfRoot(e){if(""===this._location.path)throw function(e){return new Xo(Qo.INVALID_ROOT_OPERATION,"The operation '"+e+"' cannot be performed on a root reference, create a non-root reference using child, such as .child('file.png').")}(e)}}function fs(e,t){const n=null===t||void 0===t?void 0:t[Jo];return null==n?null:os.makeFromBucketSpec(n,e)}class ms{constructor(e,t,n,i,r){this.app=e,this._authProvider=t,this._appCheckProvider=n,this._url=i,this._firebaseVersion=r,this._bucket=null,this._host=Yo,this._protocol="https",this._appId=null,this._deleted=!1,this._maxOperationRetryTime=12e4,this._maxUploadRetryTime=6e5,this._requests=new Set,this._bucket=null!=i?os.makeFromBucketSpec(i,this._host):fs(this._host,this.app.options)}get host(){return this._host}set host(e){this._host=e,null!=this._url?this._bucket=os.makeFromBucketSpec(this._url,e):this._bucket=fs(e,this.app.options)}get maxUploadRetryTime(){return this._maxUploadRetryTime}set maxUploadRetryTime(e){as("time",0,Number.POSITIVE_INFINITY,e),this._maxUploadRetryTime=e}get maxOperationRetryTime(){return this._maxOperationRetryTime}set maxOperationRetryTime(e){as("time",0,Number.POSITIVE_INFINITY,e),this._maxOperationRetryTime=e}async _getAuthToken(){if(this._overrideAuthToken)return this._overrideAuthToken;const e=this._authProvider.getImmediate({optional:!0});if(e){const t=await e.getToken();if(null!==t)return t.accessToken}return null}async _getAppCheckToken(){const e=this._appCheckProvider.getImmediate({optional:!0});if(e){return(await e.getToken()).token}return null}_delete(){return this._deleted||(this._deleted=!0,this._requests.forEach((e=>e.cancel())),this._requests.clear()),Promise.resolve()}_makeStorageReference(e){return new ps(this,e)}_makeRequest(e,t,n,i){let r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(this._deleted)return new ss(rs());{const o=function(e,t,n,i,r,o){let s=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];const a=cs(e.urlParams),c=e.url+a,l=Object.assign({},e.headers);return function(e,t){t&&(e["X-Firebase-GMPID"]=t)}(l,t),function(e,t){null!==t&&t.length>0&&(e.Authorization="Firebase "+t)}(l,n),function(e,t){e["X-Firebase-Storage-Version"]="webjs/"+(null!==t&&void 0!==t?t:"AppManager")}(l,o),function(e,t){null!==t&&(e["X-Firebase-AppCheck"]=t)}(l,i),new ds(c,e.method,l,e.body,e.successCodes,e.additionalRetryCodes,e.handler,e.errorHandler,e.timeout,e.progressCallback,r,s)}(e,this._appId,n,i,t,this._firebaseVersion,r);return this._requests.add(o),o.getPromise().then((()=>this._requests.delete(o)),(()=>this._requests.delete(o))),o}}async makeRequestWithTokens(e,t){const[n,i]=await Promise.all([this._getAuthToken(),this._getAppCheckToken()]);return this._makeRequest(e,t,n,i).getPromise()}}const _s="@firebase/storage",Es="0.12.5",gs="storage";function vs(e,t){let{instanceIdentifier:n}=t;const i=e.getProvider("app").getImmediate(),r=e.getProvider("auth-internal"),o=e.getProvider("app-check-internal");return new ms(i,r,o,n,_n)}un(new tt(gs,vs,"PUBLIC").setMultipleInstances(!0)),vn(_s,Es,""),vn(_s,Es,"esm2017");var Ts,Ss,ys="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{},Cs={};(function(){var e;function t(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}function n(e,t,n){n||(n=0);var i=Array(16);if("string"===typeof t)for(var r=0;16>r;++r)i[r]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(r=0;16>r;++r)i[r]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1],r=e.g[2];var o=e.g[3],s=t+(o^n&(r^o))+i[0]+3614090360&4294967295;s=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=(n=(r=(o=(t=n+(s<<7&4294967295|s>>>25))+((s=o+(r^t&(n^r))+i[1]+3905402710&4294967295)<<12&4294967295|s>>>20))+((s=r+(n^o&(t^n))+i[2]+606105819&4294967295)<<17&4294967295|s>>>15))+((s=n+(t^r&(o^t))+i[3]+3250441966&4294967295)<<22&4294967295|s>>>10))+((s=t+(o^n&(r^o))+i[4]+4118548399&4294967295)<<7&4294967295|s>>>25))+((s=o+(r^t&(n^r))+i[5]+1200080426&4294967295)<<12&4294967295|s>>>20))+((s=r+(n^o&(t^n))+i[6]+2821735955&4294967295)<<17&4294967295|s>>>15))+((s=n+(t^r&(o^t))+i[7]+4249261313&4294967295)<<22&4294967295|s>>>10))+((s=t+(o^n&(r^o))+i[8]+1770035416&4294967295)<<7&4294967295|s>>>25))+((s=o+(r^t&(n^r))+i[9]+2336552879&4294967295)<<12&4294967295|s>>>20))+((s=r+(n^o&(t^n))+i[10]+4294925233&4294967295)<<17&4294967295|s>>>15))+((s=n+(t^r&(o^t))+i[11]+2304563134&4294967295)<<22&4294967295|s>>>10))+((s=t+(o^n&(r^o))+i[12]+1804603682&4294967295)<<7&4294967295|s>>>25))+((s=o+(r^t&(n^r))+i[13]+4254626195&4294967295)<<12&4294967295|s>>>20))+((s=r+(n^o&(t^n))+i[14]+2792965006&4294967295)<<17&4294967295|s>>>15))+((s=n+(t^r&(o^t))+i[15]+1236535329&4294967295)<<22&4294967295|s>>>10))+((s=t+(r^o&(n^r))+i[1]+4129170786&4294967295)<<5&4294967295|s>>>27))+((s=o+(n^r&(t^n))+i[6]+3225465664&4294967295)<<9&4294967295|s>>>23))+((s=r+(t^n&(o^t))+i[11]+643717713&4294967295)<<14&4294967295|s>>>18))+((s=n+(o^t&(r^o))+i[0]+3921069994&4294967295)<<20&4294967295|s>>>12))+((s=t+(r^o&(n^r))+i[5]+3593408605&4294967295)<<5&4294967295|s>>>27))+((s=o+(n^r&(t^n))+i[10]+38016083&4294967295)<<9&4294967295|s>>>23))+((s=r+(t^n&(o^t))+i[15]+3634488961&4294967295)<<14&4294967295|s>>>18))+((s=n+(o^t&(r^o))+i[4]+3889429448&4294967295)<<20&4294967295|s>>>12))+((s=t+(r^o&(n^r))+i[9]+568446438&4294967295)<<5&4294967295|s>>>27))+((s=o+(n^r&(t^n))+i[14]+3275163606&4294967295)<<9&4294967295|s>>>23))+((s=r+(t^n&(o^t))+i[3]+4107603335&4294967295)<<14&4294967295|s>>>18))+((s=n+(o^t&(r^o))+i[8]+1163531501&4294967295)<<20&4294967295|s>>>12))+((s=t+(r^o&(n^r))+i[13]+2850285829&4294967295)<<5&4294967295|s>>>27))+((s=o+(n^r&(t^n))+i[2]+4243563512&4294967295)<<9&4294967295|s>>>23))+((s=r+(t^n&(o^t))+i[7]+1735328473&4294967295)<<14&4294967295|s>>>18))+((s=n+(o^t&(r^o))+i[12]+2368359562&4294967295)<<20&4294967295|s>>>12))+((s=t+(n^r^o)+i[5]+4294588738&4294967295)<<4&4294967295|s>>>28))+((s=o+(t^n^r)+i[8]+2272392833&4294967295)<<11&4294967295|s>>>21))+((s=r+(o^t^n)+i[11]+1839030562&4294967295)<<16&4294967295|s>>>16))+((s=n+(r^o^t)+i[14]+4259657740&4294967295)<<23&4294967295|s>>>9))+((s=t+(n^r^o)+i[1]+2763975236&4294967295)<<4&4294967295|s>>>28))+((s=o+(t^n^r)+i[4]+1272893353&4294967295)<<11&4294967295|s>>>21))+((s=r+(o^t^n)+i[7]+4139469664&4294967295)<<16&4294967295|s>>>16))+((s=n+(r^o^t)+i[10]+3200236656&4294967295)<<23&4294967295|s>>>9))+((s=t+(n^r^o)+i[13]+681279174&4294967295)<<4&4294967295|s>>>28))+((s=o+(t^n^r)+i[0]+3936430074&4294967295)<<11&4294967295|s>>>21))+((s=r+(o^t^n)+i[3]+3572445317&4294967295)<<16&4294967295|s>>>16))+((s=n+(r^o^t)+i[6]+76029189&4294967295)<<23&4294967295|s>>>9))+((s=t+(n^r^o)+i[9]+3654602809&4294967295)<<4&4294967295|s>>>28))+((s=o+(t^n^r)+i[12]+3873151461&4294967295)<<11&4294967295|s>>>21))+((s=r+(o^t^n)+i[15]+530742520&4294967295)<<16&4294967295|s>>>16))+((s=n+(r^o^t)+i[2]+3299628645&4294967295)<<23&4294967295|s>>>9))+((s=t+(r^(n|~o))+i[0]+4096336452&4294967295)<<6&4294967295|s>>>26))+((s=o+(n^(t|~r))+i[7]+1126891415&4294967295)<<10&4294967295|s>>>22))+((s=r+(t^(o|~n))+i[14]+2878612391&4294967295)<<15&4294967295|s>>>17))+((s=n+(o^(r|~t))+i[5]+4237533241&4294967295)<<21&4294967295|s>>>11))+((s=t+(r^(n|~o))+i[12]+1700485571&4294967295)<<6&4294967295|s>>>26))+((s=o+(n^(t|~r))+i[3]+2399980690&4294967295)<<10&4294967295|s>>>22))+((s=r+(t^(o|~n))+i[10]+4293915773&4294967295)<<15&4294967295|s>>>17))+((s=n+(o^(r|~t))+i[1]+2240044497&4294967295)<<21&4294967295|s>>>11))+((s=t+(r^(n|~o))+i[8]+1873313359&4294967295)<<6&4294967295|s>>>26))+((s=o+(n^(t|~r))+i[15]+4264355552&4294967295)<<10&4294967295|s>>>22))+((s=r+(t^(o|~n))+i[6]+2734768916&4294967295)<<15&4294967295|s>>>17))+((s=n+(o^(r|~t))+i[13]+1309151649&4294967295)<<21&4294967295|s>>>11))+((o=(t=n+((s=t+(r^(n|~o))+i[4]+4149444226&4294967295)<<6&4294967295|s>>>26))+((s=o+(n^(t|~r))+i[11]+3174756917&4294967295)<<10&4294967295|s>>>22))^((r=o+((s=r+(t^(o|~n))+i[2]+718787259&4294967295)<<15&4294967295|s>>>17))|~t))+i[9]+3951481745&4294967295,e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(r+(s<<21&4294967295|s>>>11))&4294967295,e.g[2]=e.g[2]+r&4294967295,e.g[3]=e.g[3]+o&4294967295}function i(e,t){this.h=t;for(var n=[],i=!0,r=e.length-1;0<=r;r--){var o=0|e[r];i&&o==t||(n[r]=o,i=!1)}this.g=n}!function(e,t){function n(){}n.prototype=t.prototype,e.D=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.C=function(e,n,i){for(var r=Array(arguments.length-2),o=2;o<arguments.length;o++)r[o-2]=arguments[o];return t.prototype[n].apply(e,r)}}(t,(function(){this.blockSize=-1})),t.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0},t.prototype.u=function(e,t){void 0===t&&(t=e.length);for(var i=t-this.blockSize,r=this.B,o=this.h,s=0;s<t;){if(0==o)for(;s<=i;)n(this,e,s),s+=this.blockSize;if("string"===typeof e){for(;s<t;)if(r[o++]=e.charCodeAt(s++),o==this.blockSize){n(this,r),o=0;break}}else for(;s<t;)if(r[o++]=e[s++],o==this.blockSize){n(this,r),o=0;break}}this.h=o,this.o+=t},t.prototype.v=function(){var e=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;var n=8*this.o;for(t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.u(e),e=Array(16),t=n=0;4>t;++t)for(var i=0;32>i;i+=8)e[n++]=this.g[t]>>>i&255;return e};var r={};function o(e){return-128<=e&&128>e?function(e,t){var n=r;return Object.prototype.hasOwnProperty.call(n,e)?n[e]:n[e]=t(e)}(e,(function(e){return new i([0|e],0>e?-1:0)})):new i([0|e],0>e?-1:0)}function s(e){if(isNaN(e)||!isFinite(e))return a;if(0>e)return h(s(-e));for(var t=[],n=1,r=0;e>=n;r++)t[r]=e/n|0,n*=4294967296;return new i(t,0)}var a=o(0),c=o(1),l=o(16777216);function d(e){if(0!=e.h)return!1;for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return!1;return!0}function u(e){return-1==e.h}function h(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new i(n,~e.h).add(c)}function p(e,t){return e.add(h(t))}function f(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function m(e,t){this.g=e,this.h=t}function _(e,t){if(d(t))throw Error("division by zero");if(d(e))return new m(a,a);if(u(e))return t=_(h(e),t),new m(h(t.g),h(t.h));if(u(t))return t=_(e,h(t)),new m(h(t.g),t.h);if(30<e.g.length){if(u(e)||u(t))throw Error("slowDivide_ only works with positive integers.");for(var n=c,i=t;0>=i.l(e);)n=E(n),i=E(i);var r=g(n,1),o=g(i,1);for(i=g(i,2),n=g(n,2);!d(i);){var l=o.add(i);0>=l.l(e)&&(r=r.add(n),o=l),i=g(i,1),n=g(n,1)}return t=p(e,r.j(t)),new m(r,t)}for(r=a;0<=e.l(t);){for(n=Math.max(1,Math.floor(e.m()/t.m())),i=48>=(i=Math.ceil(Math.log(n)/Math.LN2))?1:Math.pow(2,i-48),l=(o=s(n)).j(t);u(l)||0<l.l(e);)l=(o=s(n-=i)).j(t);d(o)&&(o=c),r=r.add(o),e=p(e,l)}return new m(r,e)}function E(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.i(r)<<1|e.i(r-1)>>>31;return new i(n,e.h)}function g(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,o=[],s=0;s<r;s++)o[s]=0<t?e.i(s+n)>>>t|e.i(s+n+1)<<32-t:e.i(s+n);return new i(o,e.h)}(e=i.prototype).m=function(){if(u(this))return-h(this).m();for(var e=0,t=1,n=0;n<this.g.length;n++){var i=this.i(n);e+=(0<=i?i:4294967296+i)*t,t*=4294967296}return e},e.toString=function(e){if(2>(e=e||10)||36<e)throw Error("radix out of range: "+e);if(d(this))return"0";if(u(this))return"-"+h(this).toString(e);for(var t=s(Math.pow(e,6)),n=this,i="";;){var r=_(n,t).g,o=((0<(n=p(n,r.j(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(d(n=r))return o+i;for(;6>o.length;)o="0"+o;i=o+i}},e.i=function(e){return 0>e?0:e<this.g.length?this.g[e]:this.h},e.l=function(e){return u(e=p(this,e))?-1:d(e)?0:1},e.abs=function(){return u(this)?h(this):this},e.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,o=0;o<=t;o++){var s=r+(65535&this.i(o))+(65535&e.i(o)),a=(s>>>16)+(this.i(o)>>>16)+(e.i(o)>>>16);r=a>>>16,s&=65535,a&=65535,n[o]=a<<16|s}return new i(n,-2147483648&n[n.length-1]?-1:0)},e.j=function(e){if(d(this)||d(e))return a;if(u(this))return u(e)?h(this).j(h(e)):h(h(this).j(e));if(u(e))return h(this.j(h(e)));if(0>this.l(l)&&0>e.l(l))return s(this.m()*e.m());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var o=0;o<e.g.length;o++){var c=this.i(r)>>>16,p=65535&this.i(r),m=e.i(o)>>>16,_=65535&e.i(o);n[2*r+2*o]+=p*_,f(n,2*r+2*o),n[2*r+2*o+1]+=c*_,f(n,2*r+2*o+1),n[2*r+2*o+1]+=p*m,f(n,2*r+2*o+1),n[2*r+2*o+2]+=c*m,f(n,2*r+2*o+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new i(n,0)},e.A=function(e){return _(this,e).h},e.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.i(r)&e.i(r);return new i(n,this.h&e.h)},e.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.i(r)|e.i(r);return new i(n,this.h|e.h)},e.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.i(r)^e.i(r);return new i(n,this.h^e.h)},t.prototype.digest=t.prototype.v,t.prototype.reset=t.prototype.s,t.prototype.update=t.prototype.u,Ss=Cs.Md5=t,i.prototype.add=i.prototype.add,i.prototype.multiply=i.prototype.j,i.prototype.modulo=i.prototype.A,i.prototype.compare=i.prototype.l,i.prototype.toNumber=i.prototype.m,i.prototype.toString=i.prototype.toString,i.prototype.getBits=i.prototype.i,i.fromNumber=s,i.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return h(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var i=s(Math.pow(n,8)),r=a,o=0;o<t.length;o+=8){var c=Math.min(8,t.length-o),l=parseInt(t.substring(o,o+c),n);8>c?(c=s(Math.pow(n,c)),r=r.j(c).add(s(l))):r=(r=r.j(i)).add(s(l))}return r},Ts=Cs.Integer=i}).apply("undefined"!==typeof ys?ys:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{});var Rs,ws,Is,bs,As,Os,Ns,Ds,Ps,ks="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:{},Ls={};(function(){var e,t="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,n){return e==Array.prototype||e==Object.prototype||(e[t]=n.value),e};var n=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof ks&&ks];for(var t=0;t<e.length;++t){var n=e[t];if(n&&n.Math==Math)return n}throw Error("Cannot find global object")}(this);!function(e,i){if(i)e:{var r=n;e=e.split(".");for(var o=0;o<e.length-1;o++){var s=e[o];if(!(s in r))break e;r=r[s]}(i=i(o=r[e=e[e.length-1]]))!=o&&null!=i&&t(r,e,{configurable:!0,writable:!0,value:i})}}("Array.prototype.values",(function(e){return e||function(){return function(e,t){e instanceof String&&(e+="");var n=0,i=!1,r={next:function(){if(!i&&n<e.length){var r=n++;return{value:t(r,e[r]),done:!1}}return i=!0,{done:!0,value:void 0}}};return r[Symbol.iterator]=function(){return r},r}(this,(function(e,t){return t}))}}));var i=i||{},r=this||self;function o(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function s(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}function a(e,t,n){return e.call.apply(e.bind,arguments)}function c(e,t,n){if(!e)throw Error();if(2<arguments.length){var i=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,i),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function l(e,t,n){return(l=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?a:c).apply(null,arguments)}function d(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function u(e,t){function n(){}n.prototype=t.prototype,e.aa=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.Qb=function(e,n,i){for(var r=Array(arguments.length-2),o=2;o<arguments.length;o++)r[o-2]=arguments[o];return t.prototype[n].apply(e,r)}}function h(e){const t=e.length;if(0<t){const n=Array(t);for(let i=0;i<t;i++)n[i]=e[i];return n}return[]}function p(e,t){for(let n=1;n<arguments.length;n++){const t=arguments[n];if(o(t)){const n=e.length||0,i=t.length||0;e.length=n+i;for(let r=0;r<i;r++)e[n+r]=t[r]}else e.push(t)}}function f(e){return/^[\s\xa0]*$/.test(e)}function m(){var e=r.navigator;return e&&(e=e.userAgent)?e:""}function _(e){return _[" "](e),e}_[" "]=function(){};var E=-1!=m().indexOf("Gecko")&&!(-1!=m().toLowerCase().indexOf("webkit")&&-1==m().indexOf("Edge"))&&!(-1!=m().indexOf("Trident")||-1!=m().indexOf("MSIE"))&&-1==m().indexOf("Edge");function g(e,t,n){for(const i in e)t.call(n,e[i],i,e)}function v(e){const t={};for(const n in e)t[n]=e[n];return t}const T="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function S(e,t){let n,i;for(let r=1;r<arguments.length;r++){for(n in i=arguments[r],i)e[n]=i[n];for(let t=0;t<T.length;t++)n=T[t],Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}}function y(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}function C(e){r.setTimeout((()=>{throw e}),0)}function R(){var e=O;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}var w=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}((()=>new I),(e=>e.reset()));class I{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let b,A=!1,O=new class{constructor(){this.h=this.g=null}add(e,t){const n=w.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},N=()=>{const e=r.Promise.resolve(void 0);b=()=>{e.then(D)}};var D=()=>{for(var e;e=R();){try{e.h.call(e.g)}catch(n){C(n)}var t=w;t.j(e),100>t.h&&(t.h++,e.next=t.g,t.g=e)}A=!1};function P(){this.s=this.s,this.C=this.C}function k(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}P.prototype.s=!1,P.prototype.ma=function(){this.s||(this.s=!0,this.N())},P.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()},k.prototype.h=function(){this.defaultPrevented=!0};var L=function(){if(!r.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{const e=()=>{};r.addEventListener("test",e,t),r.removeEventListener("test",e,t)}catch(n){}return e}();function M(e,t){if(k.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,i=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(E){e:{try{_(t.nodeName);var r=!0;break e}catch(o){}r=!1}r||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,i?(this.clientX=void 0!==i.clientX?i.clientX:i.pageX,this.clientY=void 0!==i.clientY?i.clientY:i.pageY,this.screenX=i.screenX||0,this.screenY=i.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"===typeof e.pointerType?e.pointerType:U[e.pointerType]||"",this.state=e.state,this.i=e,e.defaultPrevented&&M.aa.h.call(this)}}u(M,k);var U={2:"touch",3:"pen",4:"mouse"};M.prototype.h=function(){M.aa.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var x="closure_listenable_"+(1e6*Math.random()|0),V=0;function F(e,t,n,i,r){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!i,this.ha=r,this.key=++V,this.da=this.fa=!1}function j(e){e.da=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function B(e){this.src=e,this.g={},this.h=0}function G(e,t){var n=t.type;if(n in e.g){var i,r=e.g[n],o=Array.prototype.indexOf.call(r,t,void 0);(i=0<=o)&&Array.prototype.splice.call(r,o,1),i&&(j(t),0==e.g[n].length&&(delete e.g[n],e.h--))}}function W(e,t,n,i){for(var r=0;r<e.length;++r){var o=e[r];if(!o.da&&o.listener==t&&o.capture==!!n&&o.ha==i)return r}return-1}B.prototype.add=function(e,t,n,i,r){var o=e.toString();(e=this.g[o])||(e=this.g[o]=[],this.h++);var s=W(e,t,i,r);return-1<s?(t=e[s],n||(t.fa=!1)):((t=new F(t,this.src,o,!!i,r)).fa=n,e.push(t)),t};var H="closure_lm_"+(1e6*Math.random()|0),K={};function z(e,t,n,i,r){if(i&&i.once)return Y(e,t,n,i,r);if(Array.isArray(t)){for(var o=0;o<t.length;o++)z(e,t[o],n,i,r);return null}return n=te(n),e&&e[x]?e.K(t,n,s(i)?!!i.capture:!!i,r):q(e,t,n,!1,i,r)}function q(e,t,n,i,r,o){if(!t)throw Error("Invalid event type");var a=s(r)?!!r.capture:!!r,c=$(e);if(c||(e[H]=c=new B(e)),(n=c.add(t,n,i,a,o)).proxy)return n;if(i=function(){function e(n){return t.call(e.src,e.listener,n)}const t=Z;return e}(),n.proxy=i,i.src=e,i.listener=n,e.addEventListener)L||(r=a),void 0===r&&(r=!1),e.addEventListener(t.toString(),i,r);else if(e.attachEvent)e.attachEvent(Q(t.toString()),i);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(i)}return n}function Y(e,t,n,i,r){if(Array.isArray(t)){for(var o=0;o<t.length;o++)Y(e,t[o],n,i,r);return null}return n=te(n),e&&e[x]?e.L(t,n,s(i)?!!i.capture:!!i,r):q(e,t,n,!0,i,r)}function J(e,t,n,i,r){if(Array.isArray(t))for(var o=0;o<t.length;o++)J(e,t[o],n,i,r);else i=s(i)?!!i.capture:!!i,n=te(n),e&&e[x]?(e=e.i,(t=String(t).toString())in e.g&&(-1<(n=W(o=e.g[t],n,i,r))&&(j(o[n]),Array.prototype.splice.call(o,n,1),0==o.length&&(delete e.g[t],e.h--)))):e&&(e=$(e))&&(t=e.g[t.toString()],e=-1,t&&(e=W(t,n,i,r)),(n=-1<e?t[e]:null)&&X(n))}function X(e){if("number"!==typeof e&&e&&!e.da){var t=e.src;if(t&&t[x])G(t.i,e);else{var n=e.type,i=e.proxy;t.removeEventListener?t.removeEventListener(n,i,e.capture):t.detachEvent?t.detachEvent(Q(n),i):t.addListener&&t.removeListener&&t.removeListener(i),(n=$(t))?(G(n,e),0==n.h&&(n.src=null,t[H]=null)):j(e)}}}function Q(e){return e in K?K[e]:K[e]="on"+e}function Z(e,t){if(e.da)e=!0;else{t=new M(t,this);var n=e.listener,i=e.ha||e.src;e.fa&&X(e),e=n.call(i,t)}return e}function $(e){return(e=e[H])instanceof B?e:null}var ee="__closure_events_fn_"+(1e9*Math.random()>>>0);function te(e){return"function"===typeof e?e:(e[ee]||(e[ee]=function(t){return e.handleEvent(t)}),e[ee])}function ne(){P.call(this),this.i=new B(this),this.M=this,this.F=null}function ie(e,t){var n,i=e.F;if(i)for(n=[];i;i=i.F)n.push(i);if(e=e.M,i=t.type||t,"string"===typeof t)t=new k(t,e);else if(t instanceof k)t.target=t.target||e;else{var r=t;S(t=new k(i,e),r)}if(r=!0,n)for(var o=n.length-1;0<=o;o--){var s=t.g=n[o];r=re(s,i,!0,t)&&r}if(r=re(s=t.g=e,i,!0,t)&&r,r=re(s,i,!1,t)&&r,n)for(o=0;o<n.length;o++)r=re(s=t.g=n[o],i,!1,t)&&r}function re(e,t,n,i){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var r=!0,o=0;o<t.length;++o){var s=t[o];if(s&&!s.da&&s.capture==n){var a=s.listener,c=s.ha||s.src;s.fa&&G(e.i,s),r=!1!==a.call(c,i)&&r}}return r&&!i.defaultPrevented}function oe(e,t,n){if("function"===typeof e)n&&(e=l(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=l(e.handleEvent,e)}return 2147483647<Number(t)?-1:r.setTimeout(e,t||0)}function se(e){e.g=oe((()=>{e.g=null,e.i&&(e.i=!1,se(e))}),e.l);const t=e.h;e.h=null,e.m.apply(null,t)}u(ne,P),ne.prototype[x]=!0,ne.prototype.removeEventListener=function(e,t,n,i){J(this,e,t,n,i)},ne.prototype.N=function(){if(ne.aa.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],i=0;i<n.length;i++)j(n[i]);delete t.g[e],t.h--}}this.F=null},ne.prototype.K=function(e,t,n,i){return this.i.add(String(e),t,!1,n,i)},ne.prototype.L=function(e,t,n,i){return this.i.add(String(e),t,!0,n,i)};class ae extends P{constructor(e,t){super(),this.m=e,this.l=t,this.h=null,this.i=!1,this.g=null}j(e){this.h=arguments,this.g?this.i=!0:se(this)}N(){super.N(),this.g&&(r.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ce(e){P.call(this),this.h=e,this.g={}}u(ce,P);var le=[];function de(e){g(e.g,(function(e,t){this.g.hasOwnProperty(t)&&X(e)}),e),e.g={}}ce.prototype.N=function(){ce.aa.N.call(this),de(this)},ce.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var ue=r.JSON.stringify,he=r.JSON.parse,pe=class{stringify(e){return r.JSON.stringify(e,void 0)}parse(e){return r.JSON.parse(e,void 0)}};function fe(){}function me(e){return e.h||(e.h=e.i())}function _e(){}fe.prototype.h=null;var Ee={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function ge(){k.call(this,"d")}function ve(){k.call(this,"c")}u(ge,k),u(ve,k);var Te={},Se=null;function ye(){return Se=Se||new ne}function Ce(e){k.call(this,Te.La,e)}function Re(e){const t=ye();ie(t,new Ce(t))}function we(e,t){k.call(this,Te.STAT_EVENT,e),this.stat=t}function Ie(e){const t=ye();ie(t,new we(t,e))}function be(e,t){k.call(this,Te.Ma,e),this.size=t}function Ae(e,t){if("function"!==typeof e)throw Error("Fn must not be null and must be a function");return r.setTimeout((function(){e()}),t)}function Oe(){this.g=!0}function Ne(e,t,n,i){e.info((function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var i=n[e];if(!(2>i.length)){var r=i[1];if(Array.isArray(r)&&!(1>r.length)){var o=r[0];if("noop"!=o&&"stop"!=o&&"close"!=o)for(var s=1;s<r.length;s++)r[s]=""}}}return ue(n)}catch(a){return t}}(e,n)+(i?" "+i:"")}))}Te.La="serverreachability",u(Ce,k),Te.STAT_EVENT="statevent",u(we,k),Te.Ma="timingevent",u(be,k),Oe.prototype.xa=function(){this.g=!1},Oe.prototype.info=function(){};var De,Pe={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},ke={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"};function Le(){}function Me(e,t,n,i){this.j=e,this.i=t,this.l=n,this.R=i||1,this.U=new ce(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new Ue}function Ue(){this.i=null,this.g="",this.h=!1}u(Le,fe),Le.prototype.g=function(){return new XMLHttpRequest},Le.prototype.i=function(){return{}},De=new Le;var xe={},Ve={};function Fe(e,t,n){e.L=1,e.v=ut(st(t)),e.m=n,e.P=!0,je(e,null)}function je(e,t){e.F=Date.now(),We(e),e.A=st(e.v);var n=e.A,i=e.R;Array.isArray(i)||(i=[String(i)]),wt(n.i,"t",i),e.C=0,n=e.j.J,e.h=new Ue,e.g=pn(e.j,n?t:null,!e.m),0<e.O&&(e.M=new ae(l(e.Y,e,e.g),e.O)),t=e.U,n=e.g,i=e.ca;var r="readystatechange";Array.isArray(r)||(r&&(le[0]=r.toString()),r=le);for(var o=0;o<r.length;o++){var s=z(n,r[o],i||t.handleEvent,!1,t.h||t);if(!s)break;t.g[s.key]=s}t=e.H?v(e.H):{},e.m?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ea(e.A,e.u,e.m,t)):(e.u="GET",e.g.ea(e.A,e.u,null,t)),Re(),function(e,t,n,i,r,o){e.info((function(){if(e.g)if(o)for(var s="",a=o.split("&"),c=0;c<a.length;c++){var l=a[c].split("=");if(1<l.length){var d=l[0];l=l[1];var u=d.split("_");s=2<=u.length&&"type"==u[1]?s+(d+"=")+l+"&":s+(d+"=redacted&")}}else s=null;else s=o;return"XMLHTTP REQ ("+i+") [attempt "+r+"]: "+t+"\n"+n+"\n"+s}))}(e.i,e.u,e.A,e.l,e.R,e.m)}function Be(e){return!!e.g&&("GET"==e.u&&2!=e.L&&e.j.Ca)}function Ge(e,t){var n=e.C,i=t.indexOf("\n",n);return-1==i?Ve:(n=Number(t.substring(n,i)),isNaN(n)?xe:(i+=1)+n>t.length?Ve:(t=t.slice(i,i+n),e.C=i+n,t))}function We(e){e.S=Date.now()+e.I,He(e,e.I)}function He(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=Ae(l(e.ba,e),t)}function Ke(e){e.B&&(r.clearTimeout(e.B),e.B=null)}function ze(e){0==e.j.G||e.J||cn(e.j,e)}function qe(e){Ke(e);var t=e.M;t&&"function"==typeof t.ma&&t.ma(),e.M=null,de(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.ma())}function Ye(e,t){try{var n=e.j;if(0!=n.G&&(n.g==e||$e(n.h,e)))if(!e.K&&$e(n.h,e)&&3==n.G){try{var i=n.Da.g.parse(t)}catch(d){i=null}if(Array.isArray(i)&&3==i.length){var r=i;if(0==r[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;an(n),Xt(n)}rn(n),Ie(18)}}else n.za=r[1],0<n.za-n.T&&37500>r[2]&&n.F&&0==n.v&&!n.C&&(n.C=Ae(l(n.Za,n),6e3));if(1>=Ze(n.h)&&n.ca){try{n.ca()}catch(d){}n.ca=void 0}}else dn(n,11)}else if((e.K||n.g==e)&&an(n),!f(t))for(r=n.Da.g.parse(t),t=0;t<r.length;t++){let l=r[t];if(n.T=l[0],l=l[1],2==n.G)if("c"==l[0]){n.K=l[1],n.ia=l[2];const t=l[3];null!=t&&(n.la=t,n.j.info("VER="+n.la));const r=l[4];null!=r&&(n.Aa=r,n.j.info("SVER="+n.Aa));const d=l[5];null!=d&&"number"===typeof d&&0<d&&(i=1.5*d,n.L=i,n.j.info("backChannelRequestTimeoutMs_="+i)),i=n;const u=e.g;if(u){const e=u.g?u.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(e){var o=i.h;o.g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(o.j=o.l,o.g=new Set,o.h&&(et(o,o.h),o.h=null))}if(i.D){const e=u.g?u.g.getResponseHeader("X-HTTP-Session-Id"):null;e&&(i.ya=e,dt(i.I,i.D,e))}}n.G=3,n.l&&n.l.ua(),n.ba&&(n.R=Date.now()-e.F,n.j.info("Handshake RTT: "+n.R+"ms"));var s=e;if((i=n).qa=hn(i,i.J?i.ia:null,i.W),s.K){tt(i.h,s);var a=s,c=i.L;c&&(a.I=c),a.B&&(Ke(a),We(a)),i.g=s}else nn(i);0<n.i.length&&Zt(n)}else"stop"!=l[0]&&"close"!=l[0]||dn(n,7);else 3==n.G&&("stop"==l[0]||"close"==l[0]?"stop"==l[0]?dn(n,7):Jt(n):"noop"!=l[0]&&n.l&&n.l.ta(l),n.v=0)}Re()}catch(d){}}Me.prototype.ca=function(e){e=e.target;const t=this.M;t&&3==Kt(e)?t.j():this.Y(e)},Me.prototype.Y=function(e){try{if(e==this.g)e:{const h=Kt(this.g);var t=this.g.Ba();this.g.Z();if(!(3>h)&&(3!=h||this.g&&(this.h.h||this.g.oa()||zt(this.g)))){this.J||4!=h||7==t||Re(),Ke(this);var n=this.g.Z();this.X=n;t:if(Be(this)){var i=zt(this.g);e="";var o=i.length,s=4==Kt(this.g);if(!this.h.i){if("undefined"===typeof TextDecoder){qe(this),ze(this);var a="";break t}this.h.i=new r.TextDecoder}for(t=0;t<o;t++)this.h.h=!0,e+=this.h.i.decode(i[t],{stream:!(s&&t==o-1)});i.length=0,this.h.g+=e,this.C=0,a=this.h.g}else a=this.g.oa();if(this.o=200==n,function(e,t,n,i,r,o,s){e.info((function(){return"XMLHTTP RESP ("+i+") [ attempt "+r+"]: "+t+"\n"+n+"\n"+o+" "+s}))}(this.i,this.u,this.A,this.l,this.R,h,n),this.o){if(this.T&&!this.K){t:{if(this.g){var c,l=this.g;if((c=l.g?l.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!f(c)){var d=c;break t}}d=null}if(!(n=d)){this.o=!1,this.s=3,Ie(12),qe(this),ze(this);break e}Ne(this.i,this.l,n,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ye(this,n)}if(this.P){let e;for(n=!0;!this.J&&this.C<a.length;){if(e=Ge(this,a),e==Ve){4==h&&(this.s=4,Ie(14),n=!1),Ne(this.i,this.l,null,"[Incomplete Response]");break}if(e==xe){this.s=4,Ie(15),Ne(this.i,this.l,a,"[Invalid Chunk]"),n=!1;break}Ne(this.i,this.l,e,null),Ye(this,e)}if(Be(this)&&0!=this.C&&(this.h.g=this.h.g.slice(this.C),this.C=0),4!=h||0!=a.length||this.h.h||(this.s=1,Ie(16),n=!1),this.o=this.o&&n,n){if(0<a.length&&!this.W){this.W=!0;var u=this.j;u.g==this&&u.ba&&!u.M&&(u.j.info("Great, no buffering proxy detected. Bytes received: "+a.length),on(u),u.M=!0,Ie(11))}}else Ne(this.i,this.l,a,"[Invalid Chunked Response]"),qe(this),ze(this)}else Ne(this.i,this.l,a,null),Ye(this,a);4==h&&qe(this),this.o&&!this.J&&(4==h?cn(this.j,this):(this.o=!1,We(this)))}else(function(e){const t={};e=(e.g&&2<=Kt(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let i=0;i<e.length;i++){if(f(e[i]))continue;var n=y(e[i]);const r=n[0];if("string"!==typeof(n=n[1]))continue;n=n.trim();const o=t[r]||[];t[r]=o,o.push(n)}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,(function(e){return e.join(", ")}))})(this.g),400==n&&0<a.indexOf("Unknown SID")?(this.s=3,Ie(12)):(this.s=0,Ie(13)),qe(this),ze(this)}}}catch(h){}},Me.prototype.cancel=function(){this.J=!0,qe(this)},Me.prototype.ba=function(){this.B=null;const e=Date.now();0<=e-this.S?(function(e,t){e.info((function(){return"TIMEOUT: "+t}))}(this.i,this.A),2!=this.L&&(Re(),Ie(17)),qe(this),this.s=2,ze(this)):He(this,this.S-e)};var Je=class{constructor(e,t){this.g=e,this.map=t}};function Xe(e){this.l=e||10,r.PerformanceNavigationTiming?e=0<(e=r.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):e=!!(r.chrome&&r.chrome.loadTimes&&r.chrome.loadTimes()&&r.chrome.loadTimes().wasFetchedViaSpdy),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Qe(e){return!!e.h||!!e.g&&e.g.size>=e.j}function Ze(e){return e.h?1:e.g?e.g.size:0}function $e(e,t){return e.h?e.h==t:!!e.g&&e.g.has(t)}function et(e,t){e.g?e.g.add(t):e.h=t}function tt(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function nt(e){if(null!=e.h)return e.i.concat(e.h.D);if(null!=e.g&&0!==e.g.size){let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}return h(e.i)}function it(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(o(e)||"string"===typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.na&&"function"==typeof e.na)return e.na();if(!e.V||"function"!=typeof e.V){if("undefined"!==typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!==typeof Set&&e instanceof Set)){if(o(e)||"string"===typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const i in e)t[n++]=i;return t}}}(e),i=function(e){if(e.V&&"function"==typeof e.V)return e.V();if("undefined"!==typeof Map&&e instanceof Map||"undefined"!==typeof Set&&e instanceof Set)return Array.from(e.values());if("string"===typeof e)return e.split("");if(o(e)){for(var t=[],n=e.length,i=0;i<n;i++)t.push(e[i]);return t}for(i in t=[],n=0,e)t[n++]=e[i];return t}(e),r=i.length,s=0;s<r;s++)t.call(void 0,i[s],n&&n[s],e)}Xe.prototype.cancel=function(){if(this.i=nt(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var rt=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function ot(e){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,e instanceof ot){this.h=e.h,at(this,e.j),this.o=e.o,this.g=e.g,ct(this,e.s),this.l=e.l;var t=e.i,n=new St;n.i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),lt(this,n),this.m=e.m}else e&&(t=String(e).match(rt))?(this.h=!1,at(this,t[1]||"",!0),this.o=ht(t[2]||""),this.g=ht(t[3]||"",!0),ct(this,t[4]),this.l=ht(t[5]||"",!0),lt(this,t[6]||"",!0),this.m=ht(t[7]||"")):(this.h=!1,this.i=new St(null,this.h))}function st(e){return new ot(e)}function at(e,t,n){e.j=n?ht(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function ct(e,t){if(t){if(t=Number(t),isNaN(t)||0>t)throw Error("Bad port number "+t);e.s=t}else e.s=null}function lt(e,t,n){t instanceof St?(e.i=t,function(e,t){t&&!e.j&&(yt(e),e.i=null,e.g.forEach((function(e,t){var n=t.toLowerCase();t!=n&&(Ct(this,t),wt(this,n,e))}),e)),e.j=t}(e.i,e.h)):(n||(t=pt(t,vt)),e.i=new St(t,e.h))}function dt(e,t,n){e.i.set(t,n)}function ut(e){return dt(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function ht(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function pt(e,t,n){return"string"===typeof e?(e=encodeURI(e).replace(t,ft),n&&(e=e.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),e):null}function ft(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}ot.prototype.toString=function(){var e=[],t=this.j;t&&e.push(pt(t,_t,!0),":");var n=this.g;return(n||"file"==t)&&(e.push("//"),(t=this.o)&&e.push(pt(t,_t,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.s)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(pt(n,"/"==n.charAt(0)?gt:Et,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.m)&&e.push("#",pt(n,Tt)),e.join("")};var mt,_t=/[#\/\?@]/g,Et=/[#\?:]/g,gt=/[#\?]/g,vt=/[#\?@]/g,Tt=/#/g;function St(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function yt(e){e.g||(e.g=new Map,e.h=0,e.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var i=e[n].indexOf("="),r=null;if(0<=i){var o=e[n].substring(0,i);r=e[n].substring(i+1)}else o=e[n];t(o,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(e.i,(function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)})))}function Ct(e,t){yt(e),t=It(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function Rt(e,t){return yt(e),t=It(e,t),e.g.has(t)}function wt(e,t,n){Ct(e,t),0<n.length&&(e.i=null,e.g.set(It(e,t),h(n)),e.h+=n.length)}function It(e,t){return t=String(t),e.j&&(t=t.toLowerCase()),t}function bt(e,t,n,i,r){try{r&&(r.onload=null,r.onerror=null,r.onabort=null,r.ontimeout=null),i(n)}catch(o){}}function At(){this.g=new pe}function Ot(e,t,n){const i=n||"";try{it(e,(function(e,n){let r=e;s(e)&&(r=ue(e)),t.push(i+n+"="+encodeURIComponent(r))}))}catch(Dm){throw t.push(i+"type="+encodeURIComponent("_badmap")),Dm}}function Nt(e){this.l=e.Ub||null,this.j=e.eb||!1}function Dt(e,t){ne.call(this),this.D=e,this.o=t,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}function Pt(e){e.j.read().then(e.Pa.bind(e)).catch(e.ga.bind(e))}function kt(e){e.readyState=4,e.l=null,e.j=null,e.v=null,Lt(e)}function Lt(e){e.onreadystatechange&&e.onreadystatechange.call(e)}function Mt(e){let t="";return g(e,(function(e,n){t+=n,t+=":",t+=e,t+="\r\n"})),t}function Ut(e,t,n){e:{for(i in n){var i=!1;break e}i=!0}i||(n=Mt(n),"string"===typeof e?null!=n&&encodeURIComponent(String(n)):dt(e,t,n))}function xt(e){ne.call(this),this.headers=new Map,this.o=e||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}(e=St.prototype).add=function(e,t){yt(this),this.i=null,e=It(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},e.forEach=function(e,t){yt(this),this.g.forEach((function(n,i){n.forEach((function(n){e.call(t,n,i,this)}),this)}),this)},e.na=function(){yt(this);const e=Array.from(this.g.values()),t=Array.from(this.g.keys()),n=[];for(let i=0;i<t.length;i++){const r=e[i];for(let e=0;e<r.length;e++)n.push(t[i])}return n},e.V=function(e){yt(this);let t=[];if("string"===typeof e)Rt(this,e)&&(t=t.concat(this.g.get(It(this,e))));else{e=Array.from(this.g.values());for(let n=0;n<e.length;n++)t=t.concat(e[n])}return t},e.set=function(e,t){return yt(this),this.i=null,Rt(this,e=It(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},e.get=function(e,t){return e&&0<(e=this.V(e)).length?String(e[0]):t},e.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++){var i=t[n];const o=encodeURIComponent(String(i)),s=this.V(i);for(i=0;i<s.length;i++){var r=o;""!==s[i]&&(r+="="+encodeURIComponent(String(s[i]))),e.push(r)}}return this.i=e.join("&")},u(Nt,fe),Nt.prototype.g=function(){return new Dt(this.l,this.j)},Nt.prototype.i=(mt={},function(){return mt}),u(Dt,ne),(e=Dt.prototype).open=function(e,t){if(0!=this.readyState)throw this.abort(),Error("Error reopening a connection");this.B=e,this.A=t,this.readyState=1,Lt(this)},e.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.u,method:this.B,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||r).fetch(new Request(this.A,t)).then(this.Sa.bind(this),this.ga.bind(this))},e.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,kt(this)),this.readyState=0},e.Sa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,Lt(this)),this.g&&(this.readyState=3,Lt(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if("undefined"!==typeof r.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;Pt(this)}else e.text().then(this.Ra.bind(this),this.ga.bind(this))},e.Pa=function(e){if(this.g){if(this.o&&e.value)this.response.push(e.value);else if(!this.o){var t=e.value?e.value:new Uint8Array(0);(t=this.v.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)}e.done?kt(this):Lt(this),3==this.readyState&&Pt(this)}},e.Ra=function(e){this.g&&(this.response=this.responseText=e,kt(this))},e.Qa=function(e){this.g&&(this.response=e,kt(this))},e.ga=function(){this.g&&kt(this)},e.setRequestHeader=function(e,t){this.u.append(e,t)},e.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},e.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(Dt.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}}),u(xt,ne);var Vt=/^https?$/i,Ft=["POST","PUT"];function jt(e,t){e.h=!1,e.g&&(e.j=!0,e.g.abort(),e.j=!1),e.l=t,e.m=5,Bt(e),Wt(e)}function Bt(e){e.A||(e.A=!0,ie(e,"complete"),ie(e,"error"))}function Gt(e){if(e.h&&"undefined"!=typeof i&&(!e.v[1]||4!=Kt(e)||2!=e.Z()))if(e.u&&4==Kt(e))oe(e.Ea,0,e);else if(ie(e,"readystatechange"),4==Kt(e)){e.h=!1;try{const i=e.Z();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var t=!0;break e;default:t=!1}var n;if(!(n=t)){var o;if(o=0===i){var s=String(e.D).match(rt)[1]||null;!s&&r.self&&r.self.location&&(s=r.self.location.protocol.slice(0,-1)),o=!Vt.test(s?s.toLowerCase():"")}n=o}if(n)ie(e,"complete"),ie(e,"success");else{e.m=6;try{var a=2<Kt(e)?e.g.statusText:""}catch(c){a=""}e.l=a+" ["+e.Z()+"]",Bt(e)}}finally{Wt(e)}}}function Wt(e,t){if(e.g){Ht(e);const n=e.g,i=e.v[0]?()=>{}:null;e.g=null,e.v=null,t||ie(e,"ready");try{n.onreadystatechange=i}catch(Dm){}}}function Ht(e){e.I&&(r.clearTimeout(e.I),e.I=null)}function Kt(e){return e.g?e.g.readyState:0}function zt(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.H){case"":case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(xs){return null}}function qt(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Yt(e){this.Aa=0,this.i=[],this.j=new Oe,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=qt("failFast",!1,e),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=qt("baseRetryDelayMs",5e3,e),this.cb=qt("retryDelaySeedMs",1e4,e),this.Wa=qt("forwardChannelMaxRetries",2,e),this.wa=qt("forwardChannelRequestTimeoutMs",2e4,e),this.pa=e&&e.xmlHttpFactory||void 0,this.Xa=e&&e.Tb||void 0,this.Ca=e&&e.useFetchStreams||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.h=new Xe(e&&e.concurrentRequestLimit),this.Da=new At,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=e&&e.Rb||!1,e&&e.xa&&this.j.xa(),e&&e.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&e&&e.detectBufferingProxy||!1,this.ja=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.ja=e.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}function Jt(e){if(Qt(e),3==e.G){var t=e.U++,n=st(e.I);if(dt(n,"SID",e.K),dt(n,"RID",t),dt(n,"TYPE","terminate"),en(e,n),(t=new Me(e,e.j,t)).L=2,t.v=ut(st(n)),n=!1,r.navigator&&r.navigator.sendBeacon)try{n=r.navigator.sendBeacon(t.v.toString(),"")}catch(i){}!n&&r.Image&&((new Image).src=t.v,n=!0),n||(t.g=pn(t.j,null),t.g.ea(t.v)),t.F=Date.now(),We(t)}un(e)}function Xt(e){e.g&&(on(e),e.g.cancel(),e.g=null)}function Qt(e){Xt(e),e.u&&(r.clearTimeout(e.u),e.u=null),an(e),e.h.cancel(),e.s&&("number"===typeof e.s&&r.clearTimeout(e.s),e.s=null)}function Zt(e){if(!Qe(e.h)&&!e.s){e.s=!0;var t=e.Ga;b||N(),A||(b(),A=!0),O.add(t,e),e.B=0}}function $t(e,t){var n;n=t?t.l:e.U++;const i=st(e.I);dt(i,"SID",e.K),dt(i,"RID",n),dt(i,"AID",e.T),en(e,i),e.m&&e.o&&Ut(i,e.m,e.o),n=new Me(e,e.j,n,e.B+1),null===e.m&&(n.H=e.o),t&&(e.i=t.D.concat(e.i)),t=tn(e,n,1e3),n.I=Math.round(.5*e.wa)+Math.round(.5*e.wa*Math.random()),et(e.h,n),Fe(n,i,t)}function en(e,t){e.H&&g(e.H,(function(e,n){dt(t,n,e)})),e.l&&it({},(function(e,n){dt(t,n,e)}))}function tn(e,t,n){n=Math.min(e.i.length,n);var i=e.l?l(e.l.Na,e.l,e):null;e:{var r=e.i;let t=-1;for(;;){const e=["count="+n];-1==t?0<n?(t=r[0].g,e.push("ofs="+t)):t=0:e.push("ofs="+t);let s=!0;for(let a=0;a<n;a++){let n=r[a].g;const c=r[a].map;if(n-=t,0>n)t=Math.max(0,r[a].g-100),s=!1;else try{Ot(c,e,"req"+n+"_")}catch(o){i&&i(c)}}if(s){i=e.join("&");break e}}}return e=e.i.splice(0,n),t.D=e,i}function nn(e){if(!e.g&&!e.u){e.Y=1;var t=e.Fa;b||N(),A||(b(),A=!0),O.add(t,e),e.v=0}}function rn(e){return!(e.g||e.u||3<=e.v)&&(e.Y++,e.u=Ae(l(e.Fa,e),ln(e,e.v)),e.v++,!0)}function on(e){null!=e.A&&(r.clearTimeout(e.A),e.A=null)}function sn(e){e.g=new Me(e,e.j,"rpc",e.Y),null===e.m&&(e.g.H=e.o),e.g.O=0;var t=st(e.qa);dt(t,"RID","rpc"),dt(t,"SID",e.K),dt(t,"AID",e.T),dt(t,"CI",e.F?"0":"1"),!e.F&&e.ja&&dt(t,"TO",e.ja),dt(t,"TYPE","xmlhttp"),en(e,t),e.m&&e.o&&Ut(t,e.m,e.o),e.L&&(e.g.I=e.L);var n=e.g;e=e.ia,n.L=1,n.v=ut(st(t)),n.m=null,n.P=!0,je(n,e)}function an(e){null!=e.C&&(r.clearTimeout(e.C),e.C=null)}function cn(e,t){var n=null;if(e.g==t){an(e),on(e),e.g=null;var i=2}else{if(!$e(e.h,t))return;n=t.D,tt(e.h,t),i=1}if(0!=e.G)if(t.o)if(1==i){n=t.m?t.m.length:0,t=Date.now()-t.F;var r=e.B;ie(i=ye(),new be(i,n)),Zt(e)}else nn(e);else if(3==(r=t.s)||0==r&&0<t.X||!(1==i&&function(e,t){return!(Ze(e.h)>=e.h.j-(e.s?1:0))&&(e.s?(e.i=t.D.concat(e.i),!0):!(1==e.G||2==e.G||e.B>=(e.Va?0:e.Wa))&&(e.s=Ae(l(e.Ga,e,t),ln(e,e.B)),e.B++,!0))}(e,t)||2==i&&rn(e)))switch(n&&0<n.length&&(t=e.h,t.i=t.i.concat(n)),r){case 1:dn(e,5);break;case 4:dn(e,10);break;case 3:dn(e,6);break;default:dn(e,2)}}function ln(e,t){let n=e.Ta+Math.floor(Math.random()*e.cb);return e.isActive()||(n*=2),n*t}function dn(e,t){if(e.j.info("Error code "+t),2==t){var n=l(e.fb,e),i=e.Xa;const t=!i;i=new ot(i||"//www.google.com/images/cleardot.gif"),r.location&&"http"==r.location.protocol||at(i,"https"),ut(i),t?function(e,t){const n=new Oe;if(r.Image){const i=new Image;i.onload=d(bt,n,"TestLoadImage: loaded",!0,t,i),i.onerror=d(bt,n,"TestLoadImage: error",!1,t,i),i.onabort=d(bt,n,"TestLoadImage: abort",!1,t,i),i.ontimeout=d(bt,n,"TestLoadImage: timeout",!1,t,i),r.setTimeout((function(){i.ontimeout&&i.ontimeout()}),1e4),i.src=e}else t(!1)}(i.toString(),n):function(e,t){new Oe;const n=new AbortController,i=setTimeout((()=>{n.abort(),bt(0,0,!1,t)}),1e4);fetch(e,{signal:n.signal}).then((e=>{clearTimeout(i),e.ok?bt(0,0,!0,t):bt(0,0,!1,t)})).catch((()=>{clearTimeout(i),bt(0,0,!1,t)}))}(i.toString(),n)}else Ie(2);e.G=0,e.l&&e.l.sa(t),un(e),Qt(e)}function un(e){if(e.G=0,e.ka=[],e.l){const t=nt(e.h);0==t.length&&0==e.i.length||(p(e.ka,t),p(e.ka,e.i),e.h.i.length=0,h(e.i),e.i.length=0),e.l.ra()}}function hn(e,t,n){var i=n instanceof ot?st(n):new ot(n);if(""!=i.g)t&&(i.g=t+"."+i.g),ct(i,i.s);else{var o=r.location;i=o.protocol,t=t?t+"."+o.hostname:o.hostname,o=+o.port;var s=new ot(null);i&&at(s,i),t&&(s.g=t),o&&ct(s,o),n&&(s.l=n),i=s}return n=e.D,t=e.ya,n&&t&&dt(i,n,t),dt(i,"VER",e.la),en(e,i),i}function pn(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=e.Ca&&!e.pa?new xt(new Nt({eb:n})):new xt(e.pa)).Ha(e.J),t}function fn(){}function mn(){}function _n(e,t){ne.call(this),this.g=new Yt(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.o=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.va&&(e?e["X-WebChannel-Client-Profile"]=t.va:e={"X-WebChannel-Client-Profile":t.va}),this.g.S=e,(e=t&&t.Sb)&&!f(e)&&(this.g.m=e),this.v=t&&t.supportsCrossDomainXhr||!1,this.u=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!f(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&(t in(e=this.h)&&delete e[t])),this.j=new vn(this)}function En(e){ge.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function gn(){ve.call(this),this.status=1}function vn(e){this.g=e}(e=xt.prototype).Ha=function(e){this.J=e},e.ea=function(e,t,n,i){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+e);t=t?t.toUpperCase():"GET",this.D=e,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():De.g(),this.v=this.o?me(this.o):me(De),this.g.onreadystatechange=l(this.Ea,this);try{this.B=!0,this.g.open(t,String(e),!0),this.B=!1}catch(s){return void jt(this,s)}if(e=n||"",n=new Map(this.headers),i)if(Object.getPrototypeOf(i)===Object.prototype)for(var o in i)n.set(o,i[o]);else{if("function"!==typeof i.keys||"function"!==typeof i.get)throw Error("Unknown input type for opt_headers: "+String(i));for(const e of i.keys())n.set(e,i.get(e))}i=Array.from(n.keys()).find((e=>"content-type"==e.toLowerCase())),o=r.FormData&&e instanceof r.FormData,!(0<=Array.prototype.indexOf.call(Ft,t,void 0))||i||o||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[r,a]of n)this.g.setRequestHeader(r,a);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Ht(this),this.u=!0,this.g.send(e),this.u=!1}catch(s){jt(this,s)}},e.abort=function(e){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=e||7,ie(this,"complete"),ie(this,"abort"),Wt(this))},e.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Wt(this,!0)),xt.aa.N.call(this)},e.Ea=function(){this.s||(this.B||this.u||this.j?Gt(this):this.bb())},e.bb=function(){Gt(this)},e.isActive=function(){return!!this.g},e.Z=function(){try{return 2<Kt(this)?this.g.status:-1}catch(mt){return-1}},e.oa=function(){try{return this.g?this.g.responseText:""}catch(mt){return""}},e.Oa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),he(t)}},e.Ba=function(){return this.m},e.Ka=function(){return"string"===typeof this.l?this.l:String(this.l)},(e=Yt.prototype).la=8,e.G=1,e.connect=function(e,t,n,i){Ie(0),this.W=e,this.H=t||{},n&&void 0!==i&&(this.H.OSID=n,this.H.OAID=i),this.F=this.X,this.I=hn(this,null,this.W),Zt(this)},e.Ga=function(e){if(this.s)if(this.s=null,1==this.G){if(!e){this.U=Math.floor(1e5*Math.random()),e=this.U++;const r=new Me(this,this.j,e);let o=this.o;if(this.S&&(o?(o=v(o),S(o,this.S)):o=this.S),null!==this.m||this.O||(r.H=o,o=null),this.P)e:{for(var t=0,n=0;n<this.i.length;n++){var i=this.i[n];if(void 0===(i="__data__"in i.map&&"string"===typeof(i=i.map.__data__)?i.length:void 0))break;if(4096<(t+=i)){t=n;break e}if(4096===t||n===this.i.length-1){t=n+1;break e}}t=1e3}else t=1e3;t=tn(this,r,t),dt(n=st(this.I),"RID",e),dt(n,"CVER",22),this.D&&dt(n,"X-HTTP-Session-Id",this.D),en(this,n),o&&(this.O?t="headers="+encodeURIComponent(String(Mt(o)))+"&"+t:this.m&&Ut(n,this.m,o)),et(this.h,r),this.Ua&&dt(n,"TYPE","init"),this.P?(dt(n,"$req",t),dt(n,"SID","null"),r.T=!0,Fe(r,n,null)):Fe(r,n,t),this.G=2}}else 3==this.G&&(e?$t(this,e):0==this.i.length||Qe(this.h)||$t(this))},e.Fa=function(){if(this.u=null,sn(this),this.ba&&!(this.M||null==this.g||0>=this.R)){var e=2*this.R;this.j.info("BP detection timer enabled: "+e),this.A=Ae(l(this.ab,this),e)}},e.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,Ie(10),Xt(this),sn(this))},e.Za=function(){null!=this.C&&(this.C=null,Xt(this),rn(this),Ie(19))},e.fb=function(e){e?(this.j.info("Successfully pinged google.com"),Ie(2)):(this.j.info("Failed to ping google.com"),Ie(1))},e.isActive=function(){return!!this.l&&this.l.isActive(this)},(e=fn.prototype).ua=function(){},e.ta=function(){},e.sa=function(){},e.ra=function(){},e.isActive=function(){return!0},e.Na=function(){},mn.prototype.g=function(e,t){return new _n(e,t)},u(_n,ne),_n.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},_n.prototype.close=function(){Jt(this.g)},_n.prototype.o=function(e){var t=this.g;if("string"===typeof e){var n={};n.__data__=e,e=n}else this.u&&((n={}).__data__=ue(e),e=n);t.i.push(new Je(t.Ya++,e)),3==t.G&&Zt(t)},_n.prototype.N=function(){this.g.l=null,delete this.j,Jt(this.g),delete this.g,_n.aa.N.call(this)},u(En,ge),u(gn,ve),u(vn,fn),vn.prototype.ua=function(){ie(this.g,"a")},vn.prototype.ta=function(e){ie(this.g,new En(e))},vn.prototype.sa=function(e){ie(this.g,new gn)},vn.prototype.ra=function(){ie(this.g,"b")},mn.prototype.createWebChannel=mn.prototype.g,_n.prototype.send=_n.prototype.o,_n.prototype.open=_n.prototype.m,_n.prototype.close=_n.prototype.close,Ps=Ls.createWebChannelTransport=function(){return new mn},Ds=Ls.getStatEventTarget=function(){return ye()},Ns=Ls.Event=Te,Os=Ls.Stat={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Pe.NO_ERROR=0,Pe.TIMEOUT=8,Pe.HTTP_ERROR=6,As=Ls.ErrorCode=Pe,ke.COMPLETE="complete",bs=Ls.EventType=ke,_e.EventType=Ee,Ee.OPEN="a",Ee.CLOSE="b",Ee.ERROR="c",Ee.MESSAGE="d",ne.prototype.listen=ne.prototype.K,Is=Ls.WebChannel=_e,ws=Ls.FetchXmlHttpFactory=Nt,xt.prototype.listenOnce=xt.prototype.L,xt.prototype.getLastError=xt.prototype.Ka,xt.prototype.getLastErrorCode=xt.prototype.Ba,xt.prototype.getStatus=xt.prototype.Z,xt.prototype.getResponseJson=xt.prototype.Oa,xt.prototype.getResponseText=xt.prototype.oa,xt.prototype.send=xt.prototype.ea,xt.prototype.setWithCredentials=xt.prototype.Ha,Rs=Ls.XhrIo=xt}).apply("undefined"!==typeof ks?ks:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{});const Ms="@firebase/firestore";class Us{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}Us.UNAUTHENTICATED=new Us(null),Us.GOOGLE_CREDENTIALS=new Us("google-credentials-uid"),Us.FIRST_PARTY=new Us("first-party-uid"),Us.MOCK_USER=new Us("mock-user");let xs="10.12.1";const Vs=new ut("@firebase/firestore");function Fs(){return Vs.logLevel}function js(e){if(Vs.logLevel<=st.DEBUG){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];const r=n.map(Ws);Vs.debug("Firestore (".concat(xs,"): ").concat(e),...r)}}function Bs(e){if(Vs.logLevel<=st.ERROR){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];const r=n.map(Ws);Vs.error("Firestore (".concat(xs,"): ").concat(e),...r)}}function Gs(e){if(Vs.logLevel<=st.WARN){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];const r=n.map(Ws);Vs.warn("Firestore (".concat(xs,"): ").concat(e),...r)}}function Ws(e){if("string"==typeof e)return e;try{return function(e){return JSON.stringify(e)}(e)}catch(t){return e}}function Hs(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected state";const t="FIRESTORE (".concat(xs,") INTERNAL ASSERTION FAILED: ")+e;throw Bs(t),new Error(t)}function Ks(e,t){e||Hs()}function zs(e,t){return e}const qs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Ys extends He{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>"".concat(this.name,": [code=").concat(this.code,"]: ").concat(this.message)}}class Js{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class Xs{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization","Bearer ".concat(e))}}class Qs{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(Us.UNAUTHENTICATED)))}shutdown(){}}class Zs{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class $s{constructor(e){this.t=e,this.currentUser=Us.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const i=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let r=new Js;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Js,e.enqueueRetryable((()=>i(this.currentUser)))};const o=()=>{const t=r;e.enqueueRetryable((async()=>{await t.promise,await i(this.currentUser)}))},s=e=>{js("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit((e=>s(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?s(e):(js("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Js)}}),0),o()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(js("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(Ks("string"==typeof t.accessToken),new Xs(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return Ks(null===e||"string"==typeof e),new Us(e)}}class ea{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=Us.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class ta{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new ea(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable((()=>t(Us.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class na{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class ia{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){const n=e=>{null!=e.error&&js("FirebaseAppCheckTokenProvider","Error getting App Check token; using placeholder token instead. Error: ".concat(e.error.message));const n=e.token!==this.R;return this.R=e.token,js("FirebaseAppCheckTokenProvider","Received ".concat(n?"new":"existing"," token.")),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const i=e=>{js("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit((e=>i(e))),setTimeout((()=>{if(!this.appCheck){const e=this.A.getImmediate({optional:!0});e?i(e):js("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(Ks("string"==typeof e.token),this.R=e.token,new na(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function ra(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let i=0;i<e;i++)n[i]=Math.floor(256*Math.random());return n}class oa{static newId(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=62*Math.floor(256/62);let n="";for(;n.length<20;){const i=ra(40);for(let r=0;r<i.length;++r)n.length<20&&i[r]<t&&(n+=e.charAt(i[r]%62))}return n}}function sa(e,t){return e<t?-1:e>t?1:0}function aa(e,t,n){return e.length===t.length&&e.every(((e,i)=>n(e,t[i])))}class ca{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new Ys(qs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new Ys(qs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Ys(qs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new Ys(qs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return ca.fromMillis(Date.now())}static fromDate(e){return ca.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new ca(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?sa(this.nanoseconds,e.nanoseconds):sa(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class la{constructor(e){this.timestamp=e}static fromTimestamp(e){return new la(e)}static min(){return new la(new ca(0,0))}static max(){return new la(new ca(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class da{constructor(e,t,n){void 0===t?t=0:t>e.length&&Hs(),void 0===n?n=e.length-t:n>e.length-t&&Hs(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===da.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof da?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let i=0;i<n;i++){const n=e.get(i),r=t.get(i);if(n<r)return-1;if(n>r)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class ua extends da{construct(e,t,n){return new ua(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(){const e=[];for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const r of n){if(r.indexOf("//")>=0)throw new Ys(qs.INVALID_ARGUMENT,"Invalid segment (".concat(r,"). Paths must not contain // in them."));e.push(...r.split("/").filter((e=>e.length>0)))}return new ua(e)}static emptyPath(){return new ua([])}}const ha=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class pa extends da{construct(e,t,n){return new pa(e,t,n)}static isValidIdentifier(e){return ha.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),pa.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new pa(["__name__"])}static fromServerFormat(e){const t=[];let n="",i=0;const r=()=>{if(0===n.length)throw new Ys(qs.INVALID_ARGUMENT,"Invalid field path (".concat(e,"). Paths must not be empty, begin with '.', end with '.', or contain '..'"));t.push(n),n=""};let o=!1;for(;i<e.length;){const t=e[i];if("\\"===t){if(i+1===e.length)throw new Ys(qs.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[i+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Ys(qs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,i+=2}else"`"===t?(o=!o,i++):"."!==t||o?(n+=t,i++):(r(),i++)}if(r(),o)throw new Ys(qs.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new pa(t)}static emptyPath(){return new pa([])}}class fa{constructor(e){this.path=e}static fromPath(e){return new fa(ua.fromString(e))}static fromName(e){return new fa(ua.fromString(e).popFirst(5))}static empty(){return new fa(ua.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ua.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ua.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new fa(new ua(e.slice()))}}class ma{constructor(e,t,n,i){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=i}}ma.UNKNOWN_ID=-1;function _a(e,t){const n=e.toTimestamp().seconds,i=e.toTimestamp().nanoseconds+1,r=la.fromTimestamp(1e9===i?new ca(n+1,0):new ca(n,i));return new ga(r,fa.empty(),t)}function Ea(e){return new ga(e.readTime,e.key,-1)}class ga{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new ga(la.min(),fa.empty(),-1)}static max(){return new ga(la.max(),fa.empty(),-1)}}function va(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=fa.comparator(e.documentKey,t.documentKey),0!==n?n:sa(e.largestBatchId,t.largestBatchId))}const Ta="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Sa{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function ya(e){if(e.code!==qs.FAILED_PRECONDITION||e.message!==Ta)throw e;js("LocalStore","Unexpectedly lost primary lease")}class Ca{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&Hs(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new Ca(((n,i)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,i)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,i)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof Ca?t:Ca.resolve(t)}catch(e){return Ca.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):Ca.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):Ca.reject(t)}static resolve(e){return new Ca(((t,n)=>{t(e)}))}static reject(e){return new Ca(((t,n)=>{n(e)}))}static waitFor(e){return new Ca(((t,n)=>{let i=0,r=0,o=!1;e.forEach((e=>{++i,e.next((()=>{++r,o&&r===i&&t()}),(e=>n(e)))})),o=!0,r===i&&t()}))}static or(e){let t=Ca.resolve(!1);for(const n of e)t=t.next((e=>e?Ca.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,i)=>{n.push(t.call(this,e,i))})),this.waitFor(n)}static mapArray(e,t){return new Ca(((n,i)=>{const r=e.length,o=new Array(r);let s=0;for(let a=0;a<r;a++){const c=a;t(e[c]).next((e=>{o[c]=e,++s,s===r&&n(o)}),(e=>i(e)))}}))}static doWhile(e,t){return new Ca(((n,i)=>{const r=()=>{!0===e()?t().next((()=>{r()}),i):n()};r()}))}}function Ra(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}function wa(e){return"IndexedDbTransactionError"===e.name}class Ia{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.se&&this.se(e),e}}function ba(e){return null==e}function Aa(e){return 0===e&&1/e==-1/0}function Oa(e){return"number"==typeof e&&Number.isInteger(e)&&!Aa(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}Ia.oe=-1;const Na=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Da=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Pa=Da;function ka(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function La(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Ma(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Ua{constructor(e,t){this.comparator=e,this.root=t||Va.EMPTY}insert(e,t){return new Ua(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Va.BLACK,null,null))}remove(e){return new Ua(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Va.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const i=this.comparator(e,n.key);if(0===i)return t+n.left.size;i<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push("".concat(t,":").concat(n)),!1))),"{".concat(e.join(", "),"}")}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new xa(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new xa(this.root,e,this.comparator,!1)}getReverseIterator(){return new xa(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new xa(this.root,e,this.comparator,!0)}}class xa{constructor(e,t,n,i){this.isReverse=i,this.nodeStack=[];let r=1;for(;!e.isEmpty();)if(r=t?n(e.key,t):1,t&&i&&(r*=-1),r<0)e=this.isReverse?e.left:e.right;else{if(0===r){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Va{constructor(e,t,n,i,r){this.key=e,this.value=t,this.color=null!=n?n:Va.RED,this.left=null!=i?i:Va.EMPTY,this.right=null!=r?r:Va.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,i,r){return new Va(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=i?i:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let i=this;const r=n(e,i.key);return i=r<0?i.copy(null,null,null,i.left.insert(e,t,n),null):0===r?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,n)),i.fixUp()}removeMin(){if(this.left.isEmpty())return Va.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===t(e,i.key)){if(i.right.isEmpty())return Va.EMPTY;n=i.right.min(),i=i.copy(n.key,n.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,Va.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,Va.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Hs();if(this.right.isRed())throw Hs();const e=this.left.check();if(e!==this.right.check())throw Hs();return e+(this.isRed()?0:1)}}Va.EMPTY=null,Va.RED=!0,Va.BLACK=!1,Va.EMPTY=new class{constructor(){this.size=0}get key(){throw Hs()}get value(){throw Hs()}get color(){throw Hs()}get left(){throw Hs()}get right(){throw Hs()}copy(e,t,n,i,r){return this}insert(e,t,n){return new Va(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Fa{constructor(e){this.comparator=e,this.data=new Ua(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const i=n.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ja(this.data.getIterator())}getIteratorFrom(e){return new ja(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof Fa))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,i=n.getNext().key;if(0!==this.comparator(e,i))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new Fa(this.comparator);return t.data=e,t}}class ja{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}class Ba{constructor(e){this.fields=e,e.sort(pa.comparator)}static empty(){return new Ba([])}unionWith(e){let t=new Fa(pa.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new Ba(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return aa(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class Ga extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class Wa{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new Ga("Invalid base64 string: "+e):e}}(e);return new Wa(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new Wa(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return sa(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Wa.EMPTY_BYTE_STRING=new Wa("");const Ha=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ka(e){if(Ks(!!e),"string"==typeof e){let t=0;const n=Ha.exec(e);if(Ks(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const i=new Date(e);return{seconds:Math.floor(i.getTime()/1e3),nanos:t}}return{seconds:za(e.seconds),nanos:za(e.nanos)}}function za(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function qa(e){return"string"==typeof e?Wa.fromBase64String(e):Wa.fromUint8Array(e)}function Ya(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Ja(e){const t=e.mapValue.fields.__previous_value__;return Ya(t)?Ja(t):t}function Xa(e){const t=Ka(e.mapValue.fields.__local_write_time__.timestampValue);return new ca(t.seconds,t.nanos)}class Qa{constructor(e,t,n,i,r,o,s,a,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=i,this.ssl=r,this.forceLongPolling=o,this.autoDetectLongPolling=s,this.longPollingOptions=a,this.useFetchStreams=c}}class Za{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Za("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Za&&e.projectId===this.projectId&&e.database===this.database}}const $a={mapValue:{fields:{__type__:{stringValue:"__max__"}}}};function ec(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Ya(e)?4:fc(e)?9007199254740991:10:Hs()}function tc(e,t){if(e===t)return!0;const n=ec(e);if(n!==ec(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Xa(e).isEqual(Xa(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=Ka(e.timestampValue),i=Ka(t.timestampValue);return n.seconds===i.seconds&&n.nanos===i.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return qa(e.bytesValue).isEqual(qa(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return za(e.geoPointValue.latitude)===za(t.geoPointValue.latitude)&&za(e.geoPointValue.longitude)===za(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return za(e.integerValue)===za(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=za(e.doubleValue),i=za(t.doubleValue);return n===i?Aa(n)===Aa(i):isNaN(n)&&isNaN(i)}return!1}(e,t);case 9:return aa(e.arrayValue.values||[],t.arrayValue.values||[],tc);case 10:return function(e,t){const n=e.mapValue.fields||{},i=t.mapValue.fields||{};if(ka(n)!==ka(i))return!1;for(const r in n)if(n.hasOwnProperty(r)&&(void 0===i[r]||!tc(n[r],i[r])))return!1;return!0}(e,t);default:return Hs()}}function nc(e,t){return void 0!==(e.values||[]).find((e=>tc(e,t)))}function ic(e,t){if(e===t)return 0;const n=ec(e),i=ec(t);if(n!==i)return sa(n,i);switch(n){case 0:case 9007199254740991:return 0;case 1:return sa(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=za(e.integerValue||e.doubleValue),i=za(t.integerValue||t.doubleValue);return n<i?-1:n>i?1:n===i?0:isNaN(n)?isNaN(i)?0:-1:1}(e,t);case 3:return rc(e.timestampValue,t.timestampValue);case 4:return rc(Xa(e),Xa(t));case 5:return sa(e.stringValue,t.stringValue);case 6:return function(e,t){const n=qa(e),i=qa(t);return n.compareTo(i)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),i=t.split("/");for(let r=0;r<n.length&&r<i.length;r++){const e=sa(n[r],i[r]);if(0!==e)return e}return sa(n.length,i.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=sa(za(e.latitude),za(t.latitude));return 0!==n?n:sa(za(e.longitude),za(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],i=t.values||[];for(let r=0;r<n.length&&r<i.length;++r){const e=ic(n[r],i[r]);if(e)return e}return sa(n.length,i.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===$a.mapValue&&t===$a.mapValue)return 0;if(e===$a.mapValue)return 1;if(t===$a.mapValue)return-1;const n=e.fields||{},i=Object.keys(n),r=t.fields||{},o=Object.keys(r);i.sort(),o.sort();for(let s=0;s<i.length&&s<o.length;++s){const e=sa(i[s],o[s]);if(0!==e)return e;const t=ic(n[i[s]],r[o[s]]);if(0!==t)return t}return sa(i.length,o.length)}(e.mapValue,t.mapValue);default:throw Hs()}}function rc(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return sa(e,t);const n=Ka(e),i=Ka(t),r=sa(n.seconds,i.seconds);return 0!==r?r:sa(n.nanos,i.nanos)}function oc(e){return sc(e)}function sc(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=Ka(e);return"time(".concat(t.seconds,",").concat(t.nanos,")")}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return qa(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return fa.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return"geo(".concat(e.latitude,",").concat(e.longitude,")")}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const i of e.values||[])n?n=!1:t+=",",t+=sc(i);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",i=!0;for(const r of t)i?i=!1:n+=",",n+="".concat(r,":").concat(sc(e.fields[r]));return n+"}"}(e.mapValue):Hs()}function ac(e,t){return{referenceValue:"projects/".concat(e.projectId,"/databases/").concat(e.database,"/documents/").concat(t.path.canonicalString())}}function cc(e){return!!e&&"integerValue"in e}function lc(e){return!!e&&"arrayValue"in e}function dc(e){return!!e&&"nullValue"in e}function uc(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function hc(e){return!!e&&"mapValue"in e}function pc(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return La(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=pc(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=pc(e.arrayValue.values[n]);return t}return Object.assign({},e)}function fc(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}class mc{constructor(e){this.value=e}static empty(){return new mc({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!hc(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=pc(t)}setAll(e){let t=pa.emptyPath(),n={},i=[];e.forEach(((e,r)=>{if(!t.isImmediateParentOf(r)){const e=this.getFieldsMap(t);this.applyChanges(e,n,i),n={},i=[],t=r.popLast()}e?n[r.lastSegment()]=pc(e):i.push(r.lastSegment())}));const r=this.getFieldsMap(t);this.applyChanges(r,n,i)}delete(e){const t=this.field(e.popLast());hc(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return tc(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let i=t.mapValue.fields[e.get(n)];hc(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,n){La(t,((t,n)=>e[t]=n));for(const i of n)delete e[i]}clone(){return new mc(pc(this.value))}}function _c(e){const t=[];return La(e.fields,((e,n)=>{const i=new pa([e]);if(hc(n)){const e=_c(n.mapValue).fields;if(0===e.length)t.push(i);else for(const n of e)t.push(i.child(n))}else t.push(i)})),new Ba(t)}class Ec{constructor(e,t,n,i,r,o,s){this.key=e,this.documentType=t,this.version=n,this.readTime=i,this.createTime=r,this.data=o,this.documentState=s}static newInvalidDocument(e){return new Ec(e,0,la.min(),la.min(),la.min(),mc.empty(),0)}static newFoundDocument(e,t,n,i){return new Ec(e,1,t,la.min(),n,i,0)}static newNoDocument(e,t){return new Ec(e,2,t,la.min(),la.min(),mc.empty(),0)}static newUnknownDocument(e,t){return new Ec(e,3,t,la.min(),la.min(),mc.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(la.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=mc.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=mc.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=la.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Ec&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Ec(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return"Document(".concat(this.key,", ").concat(this.version,", ").concat(JSON.stringify(this.data.value),", {createTime: ").concat(this.createTime,"}), {documentType: ").concat(this.documentType,"}), {documentState: ").concat(this.documentState,"})")}}class gc{constructor(e,t){this.position=e,this.inclusive=t}}function vc(e,t,n){let i=0;for(let r=0;r<e.position.length;r++){const o=t[r],s=e.position[r];if(i=o.field.isKeyField()?fa.comparator(fa.fromName(s.referenceValue),n.key):ic(s,n.data.field(o.field)),"desc"===o.dir&&(i*=-1),0!==i)break}return i}function Tc(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!tc(e.position[n],t.position[n]))return!1;return!0}class Sc{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"asc";this.field=e,this.dir=t}}function yc(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class Cc{}class Rc extends Cc{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new Pc(e,t,n):"array-contains"===t?new Uc(e,n):"in"===t?new xc(e,n):"not-in"===t?new Vc(e,n):"array-contains-any"===t?new Fc(e,n):new Rc(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new kc(e,n):new Lc(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(ic(t,this.value)):null!==t&&ec(this.value)===ec(t)&&this.matchesComparison(ic(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return Hs()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class wc extends Cc{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new wc(e,t)}matches(e){return Ic(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function Ic(e){return"and"===e.op}function bc(e){return Ac(e)&&Ic(e)}function Ac(e){for(const t of e.filters)if(t instanceof wc)return!1;return!0}function Oc(e){if(e instanceof Rc)return e.field.canonicalString()+e.op.toString()+oc(e.value);if(bc(e))return e.filters.map((e=>Oc(e))).join(",");{const t=e.filters.map((e=>Oc(e))).join(",");return"".concat(e.op,"(").concat(t,")")}}function Nc(e,t){return e instanceof Rc?function(e,t){return t instanceof Rc&&e.op===t.op&&e.field.isEqual(t.field)&&tc(e.value,t.value)}(e,t):e instanceof wc?function(e,t){return t instanceof wc&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,i)=>e&&Nc(n,t.filters[i])),!0)}(e,t):void Hs()}function Dc(e){return e instanceof Rc?function(e){return"".concat(e.field.canonicalString()," ").concat(e.op," ").concat(oc(e.value))}(e):e instanceof wc?function(e){return e.op.toString()+" {"+e.getFilters().map(Dc).join(" ,")+"}"}(e):"Filter"}class Pc extends Rc{constructor(e,t,n){super(e,t,n),this.key=fa.fromName(n.referenceValue)}matches(e){const t=fa.comparator(e.key,this.key);return this.matchesComparison(t)}}class kc extends Rc{constructor(e,t){super(e,"in",t),this.keys=Mc("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class Lc extends Rc{constructor(e,t){super(e,"not-in",t),this.keys=Mc("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function Mc(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>fa.fromName(e.referenceValue)))}class Uc extends Rc{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return lc(t)&&nc(t.arrayValue,this.value)}}class xc extends Rc{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&nc(this.value.arrayValue,t)}}class Vc extends Rc{constructor(e,t){super(e,"not-in",t)}matches(e){if(nc(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!nc(this.value.arrayValue,t)}}class Fc extends Rc{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!lc(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>nc(this.value.arrayValue,e)))}}class jc{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=i,this.limit=r,this.startAt=o,this.endAt=s,this.ue=null}}function Bc(e){return new jc(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,arguments.length>6&&void 0!==arguments[6]?arguments[6]:null)}function Gc(e){const t=zs(e);if(null===t.ue){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>Oc(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),ba(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>oc(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>oc(e))).join(",")),t.ue=e}return t.ue}function Wc(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!yc(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!Nc(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Tc(e.startAt,t.startAt)&&Tc(e.endAt,t.endAt)}function Hc(e){return fa.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}class Kc{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"F",s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=i,this.limit=r,this.limitType=o,this.startAt=s,this.endAt=a,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function zc(e,t,n,i,r,o,s,a){return new Kc(e,t,n,i,r,o,s,a)}function qc(e){return new Kc(e)}function Yc(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Jc(e){return null!==e.collectionGroup}function Xc(e){const t=zs(e);if(null===t.ce){t.ce=[];const e=new Set;for(const r of t.explicitOrderBy)t.ce.push(r),e.add(r.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",i=function(e){let t=new Fa(pa.comparator);return e.filters.forEach((e=>{e.getFlattenedFilters().forEach((e=>{e.isInequality()&&(t=t.add(e.field))}))})),t}(t);i.forEach((i=>{e.has(i.canonicalString())||i.isKeyField()||t.ce.push(new Sc(i,n))})),e.has(pa.keyField().canonicalString())||t.ce.push(new Sc(pa.keyField(),n))}return t.ce}function Qc(e){const t=zs(e);return t.le||(t.le=Zc(t,Xc(e))),t.le}function Zc(e,t){if("F"===e.limitType)return Bc(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map((e=>{const t="desc"===e.dir?"asc":"desc";return new Sc(e.field,t)}));const n=e.endAt?new gc(e.endAt.position,e.endAt.inclusive):null,i=e.startAt?new gc(e.startAt.position,e.startAt.inclusive):null;return Bc(e.path,e.collectionGroup,t,e.filters,e.limit,n,i)}}function $c(e,t){const n=e.filters.concat([t]);return new Kc(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function el(e,t,n){return new Kc(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function tl(e,t){return Wc(Qc(e),Qc(t))&&e.limitType===t.limitType}function nl(e){return"".concat(Gc(Qc(e)),"|lt:").concat(e.limitType)}function il(e){return"Query(target=".concat(function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=", filters: [".concat(e.filters.map((e=>Dc(e))).join(", "),"]")),ba(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=", orderBy: [".concat(e.orderBy.map((e=>function(e){return"".concat(e.field.canonicalString()," (").concat(e.dir,")")}(e))).join(", "),"]")),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>oc(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>oc(e))).join(",")),"Target(".concat(t,")")}(Qc(e)),"; limitType=").concat(e.limitType,")")}function rl(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):fa.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Xc(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const i=vc(e,t,n);return e.inclusive?i<=0:i<0}(e.startAt,Xc(e),t))&&!(e.endAt&&!function(e,t,n){const i=vc(e,t,n);return e.inclusive?i>=0:i>0}(e.endAt,Xc(e),t))}(e,t)}function ol(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function sl(e){return(t,n)=>{let i=!1;for(const r of Xc(e)){const e=al(r,t,n);if(0!==e)return e;i=i||r.field.isKeyField()}return 0}}function al(e,t,n){const i=e.field.isKeyField()?fa.comparator(t.key,n.key):function(e,t,n){const i=t.data.field(e),r=n.data.field(e);return null!==i&&null!==r?ic(i,r):Hs()}(e.field,t,n);switch(e.dir){case"asc":return i;case"desc":return-1*i;default:return Hs()}}class cl{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[i,r]of n)if(this.equalsFn(i,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),i=this.inner[n];if(void 0===i)return this.inner[n]=[[e,t]],void this.innerSize++;for(let r=0;r<i.length;r++)if(this.equalsFn(i[r][0],e))return void(i[r]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let i=0;i<n.length;i++)if(this.equalsFn(n[i][0],e))return 1===n.length?delete this.inner[t]:n.splice(i,1),this.innerSize--,!0;return!1}forEach(e){La(this.inner,((t,n)=>{for(const[i,r]of n)e(i,r)}))}isEmpty(){return Ma(this.inner)}size(){return this.innerSize}}const ll=new Ua(fa.comparator);function dl(){return ll}const ul=new Ua(fa.comparator);function hl(){let e=ul;for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const r of n)e=e.insert(r.key,r);return e}function pl(e){let t=ul;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function fl(){return _l()}function ml(){return _l()}function _l(){return new cl((e=>e.toString()),((e,t)=>e.isEqual(t)))}const El=new Ua(fa.comparator),gl=new Fa(fa.comparator);function vl(){let e=gl;for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const r of n)e=e.add(r);return e}const Tl=new Fa(sa);function Sl(){return Tl}function yl(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Aa(t)?"-0":t}}function Cl(e){return{integerValue:""+e}}function Rl(e,t){return Oa(t)?Cl(t):yl(e,t)}class wl{constructor(){this._=void 0}}function Il(e,t,n){return e instanceof Ol?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&Ya(t)&&(t=Ja(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof Nl?Dl(e,t):e instanceof Pl?kl(e,t):function(e,t){const n=Al(e,t),i=Ml(n)+Ml(e.Pe);return cc(n)&&cc(e.Pe)?Cl(i):yl(e.serializer,i)}(e,t)}function bl(e,t,n){return e instanceof Nl?Dl(e,t):e instanceof Pl?kl(e,t):n}function Al(e,t){return e instanceof Ll?function(e){return cc(e)||function(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class Ol extends wl{}class Nl extends wl{constructor(e){super(),this.elements=e}}function Dl(e,t){const n=Ul(t);for(const i of e.elements)n.some((e=>tc(e,i)))||n.push(i);return{arrayValue:{values:n}}}class Pl extends wl{constructor(e){super(),this.elements=e}}function kl(e,t){let n=Ul(t);for(const i of e.elements)n=n.filter((e=>!tc(e,i)));return{arrayValue:{values:n}}}class Ll extends wl{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function Ml(e){return za(e.integerValue||e.doubleValue)}function Ul(e){return lc(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class xl{constructor(e,t){this.field=e,this.transform=t}}class Vl{constructor(e,t){this.version=e,this.transformResults=t}}class Fl{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Fl}static exists(e){return new Fl(void 0,e)}static updateTime(e){return new Fl(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function jl(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Bl{}function Gl(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Zl(e.key,Fl.none()):new ql(e.key,e.data,Fl.none());{const n=e.data,i=mc.empty();let r=new Fa(pa.comparator);for(let e of t.fields)if(!r.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?i.delete(e):i.set(e,t),r=r.add(e)}return new Yl(e.key,i,new Ba(r.toArray()),Fl.none())}}function Wl(e,t,n){e instanceof ql?function(e,t,n){const i=e.value.clone(),r=Xl(e.fieldTransforms,t,n.transformResults);i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):e instanceof Yl?function(e,t,n){if(!jl(e.precondition,t))return void t.convertToUnknownDocument(n.version);const i=Xl(e.fieldTransforms,t,n.transformResults),r=t.data;r.setAll(Jl(e)),r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Hl(e,t,n,i){return e instanceof ql?function(e,t,n,i){if(!jl(e.precondition,t))return n;const r=e.value.clone(),o=Ql(e.fieldTransforms,i,t);return r.setAll(o),t.convertToFoundDocument(t.version,r).setHasLocalMutations(),null}(e,t,n,i):e instanceof Yl?function(e,t,n,i){if(!jl(e.precondition,t))return n;const r=Ql(e.fieldTransforms,i,t),o=t.data;return o.setAll(Jl(e)),o.setAll(r),t.convertToFoundDocument(t.version,o).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,i):function(e,t,n){return jl(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function Kl(e,t){let n=null;for(const i of e.fieldTransforms){const e=t.data.field(i.field),r=Al(i.transform,e||null);null!=r&&(null===n&&(n=mc.empty()),n.set(i.field,r))}return n||null}function zl(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&aa(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof Nl&&t instanceof Nl||e instanceof Pl&&t instanceof Pl?aa(e.elements,t.elements,tc):e instanceof Ll&&t instanceof Ll?tc(e.Pe,t.Pe):e instanceof Ol&&t instanceof Ol}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class ql extends Bl{constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}}class Yl extends Bl{constructor(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=i,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function Jl(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const i=e.data.field(n);t.set(n,i)}})),t}function Xl(e,t,n){const i=new Map;Ks(e.length===n.length);for(let r=0;r<n.length;r++){const o=e[r],s=o.transform,a=t.data.field(o.field);i.set(o.field,bl(s,a,n[r]))}return i}function Ql(e,t,n){const i=new Map;for(const r of e){const e=r.transform,o=n.data.field(r.field);i.set(r.field,Il(e,o,t))}return i}class Zl extends Bl{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class $l extends Bl{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class ed{constructor(e,t,n,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=i}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let i=0;i<this.mutations.length;i++){const t=this.mutations[i];t.key.isEqual(e.key)&&Wl(t,e,n[i])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Hl(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Hl(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=ml();return this.mutations.forEach((i=>{const r=e.get(i.key),o=r.overlayedDocument;let s=this.applyToLocalView(o,r.mutatedFields);s=t.has(i.key)?null:s;const a=Gl(o,s);null!==a&&n.set(i.key,a),o.isValidDocument()||o.convertToNoDocument(la.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),vl())}isEqual(e){return this.batchId===e.batchId&&aa(this.mutations,e.mutations,((e,t)=>zl(e,t)))&&aa(this.baseMutations,e.baseMutations,((e,t)=>zl(e,t)))}}class td{constructor(e,t,n,i){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=i}static from(e,t,n){Ks(e.mutations.length===n.length);let i=El;const r=e.mutations;for(let o=0;o<r.length;o++)i=i.insert(r[o].key,n[o].version);return new td(e,t,n,i)}}class nd{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return"Overlay{\n      largestBatchId: ".concat(this.largestBatchId,",\n      mutation: ").concat(this.mutation.toString(),"\n    }")}}class id{constructor(e,t){this.count=e,this.unchangedNames=t}}var rd,od;function sd(e){switch(e){default:return Hs();case qs.CANCELLED:case qs.UNKNOWN:case qs.DEADLINE_EXCEEDED:case qs.RESOURCE_EXHAUSTED:case qs.INTERNAL:case qs.UNAVAILABLE:case qs.UNAUTHENTICATED:return!1;case qs.INVALID_ARGUMENT:case qs.NOT_FOUND:case qs.ALREADY_EXISTS:case qs.PERMISSION_DENIED:case qs.FAILED_PRECONDITION:case qs.ABORTED:case qs.OUT_OF_RANGE:case qs.UNIMPLEMENTED:case qs.DATA_LOSS:return!0}}function ad(e){if(void 0===e)return Bs("GRPC error has no .code"),qs.UNKNOWN;switch(e){case rd.OK:return qs.OK;case rd.CANCELLED:return qs.CANCELLED;case rd.UNKNOWN:return qs.UNKNOWN;case rd.DEADLINE_EXCEEDED:return qs.DEADLINE_EXCEEDED;case rd.RESOURCE_EXHAUSTED:return qs.RESOURCE_EXHAUSTED;case rd.INTERNAL:return qs.INTERNAL;case rd.UNAVAILABLE:return qs.UNAVAILABLE;case rd.UNAUTHENTICATED:return qs.UNAUTHENTICATED;case rd.INVALID_ARGUMENT:return qs.INVALID_ARGUMENT;case rd.NOT_FOUND:return qs.NOT_FOUND;case rd.ALREADY_EXISTS:return qs.ALREADY_EXISTS;case rd.PERMISSION_DENIED:return qs.PERMISSION_DENIED;case rd.FAILED_PRECONDITION:return qs.FAILED_PRECONDITION;case rd.ABORTED:return qs.ABORTED;case rd.OUT_OF_RANGE:return qs.OUT_OF_RANGE;case rd.UNIMPLEMENTED:return qs.UNIMPLEMENTED;case rd.DATA_LOSS:return qs.DATA_LOSS;default:return Hs()}}(od=rd||(rd={}))[od.OK=0]="OK",od[od.CANCELLED=1]="CANCELLED",od[od.UNKNOWN=2]="UNKNOWN",od[od.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",od[od.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",od[od.NOT_FOUND=5]="NOT_FOUND",od[od.ALREADY_EXISTS=6]="ALREADY_EXISTS",od[od.PERMISSION_DENIED=7]="PERMISSION_DENIED",od[od.UNAUTHENTICATED=16]="UNAUTHENTICATED",od[od.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",od[od.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",od[od.ABORTED=10]="ABORTED",od[od.OUT_OF_RANGE=11]="OUT_OF_RANGE",od[od.UNIMPLEMENTED=12]="UNIMPLEMENTED",od[od.INTERNAL=13]="INTERNAL",od[od.UNAVAILABLE=14]="UNAVAILABLE",od[od.DATA_LOSS=15]="DATA_LOSS";let cd=null;function ld(){return new TextEncoder}const dd=new Ts([4294967295,4294967295],0);function ud(e){const t=ld().encode(e),n=new Ss;return n.update(t),new Uint8Array(n.digest())}function hd(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),i=t.getUint32(4,!0),r=t.getUint32(8,!0),o=t.getUint32(12,!0);return[new Ts([n,i],0),new Ts([r,o],0)]}class pd{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new fd("Invalid padding: ".concat(t));if(n<0)throw new fd("Invalid hash count: ".concat(n));if(e.length>0&&0===this.hashCount)throw new fd("Invalid hash count: ".concat(n));if(0===e.length&&0!==t)throw new fd("Invalid padding when bitmap length is 0: ".concat(t));this.Ie=8*e.length-t,this.Te=Ts.fromNumber(this.Ie)}Ee(e,t,n){let i=e.add(t.multiply(Ts.fromNumber(n)));return 1===i.compare(dd)&&(i=new Ts([i.getBits(0),i.getBits(1)],0)),i.modulo(this.Te).toNumber()}de(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;const t=ud(e),[n,i]=hd(t);for(let r=0;r<this.hashCount;r++){const e=this.Ee(n,i,r);if(!this.de(e))return!1}return!0}static create(e,t,n){const i=e%8==0?0:8-e%8,r=new Uint8Array(Math.ceil(e/8)),o=new pd(r,i,t);return n.forEach((e=>o.insert(e))),o}insert(e){if(0===this.Ie)return;const t=ud(e),[n,i]=hd(t);for(let r=0;r<this.hashCount;r++){const e=this.Ee(n,i,r);this.Ae(e)}}Ae(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class fd extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class md{constructor(e,t,n,i,r){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=i,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const i=new Map;return i.set(e,_d.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new md(la.min(),i,new Ua(sa),dl(),vl())}}class _d{constructor(e,t,n,i,r){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=i,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new _d(n,t,vl(),vl(),vl())}}class Ed{constructor(e,t,n,i){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=i}}class gd{constructor(e,t){this.targetId=e,this.me=t}}class vd{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Wa.EMPTY_BYTE_STRING,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=i}}class Td{constructor(){this.fe=0,this.ge=Cd(),this.pe=Wa.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}Ce(){let e=vl(),t=vl(),n=vl();return this.ge.forEach(((i,r)=>{switch(r){case 0:e=e.add(i);break;case 2:t=t.add(i);break;case 1:n=n.add(i);break;default:Hs()}})),new _d(this.pe,this.ye,e,t,n)}ve(){this.we=!1,this.ge=Cd()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,Ks(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class Sd{constructor(e){this.Le=e,this.Be=new Map,this.ke=dl(),this.qe=yd(),this.Qe=new Ua(sa)}Ke(e){for(const t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(const t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,(t=>{const n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.ve(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:Hs()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach(((e,n)=>{this.ze(n)&&t(n)}))}He(e){const t=e.targetId,n=e.me.count,i=this.Je(t);if(i){const r=i.target;if(Hc(r))if(0===n){const e=new fa(r.path);this.Ue(t,e,Ec.newNoDocument(e,la.min()))}else Ks(1===n);else{const i=this.Ye(t);if(i!==n){const n=this.Ze(e),r=n?this.Xe(n,e,i):1;if(0!==r){this.je(t);const e=2===r?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(t,e)}null==cd||cd.et(function(e,t,n,i,r){var o,s,a,c,l,d;const u={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},h=t.unchangedNames;return h&&(u.bloomFilter={applied:0===r,hashCount:null!==(o=null==h?void 0:h.hashCount)&&void 0!==o?o:0,bitmapLength:null!==(c=null===(a=null===(s=null==h?void 0:h.bits)||void 0===s?void 0:s.bitmap)||void 0===a?void 0:a.length)&&void 0!==c?c:0,padding:null!==(d=null===(l=null==h?void 0:h.bits)||void 0===l?void 0:l.padding)&&void 0!==d?d:0,mightContain:e=>{var t;return null!==(t=null==i?void 0:i.mightContain(e))&&void 0!==t&&t}}),u}(i,e.me,this.Le.tt(),n,r))}}}}Ze(e){const t=e.me.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:i=0},hashCount:r=0}=t;let o,s;try{o=qa(n).toUint8Array()}catch(e){if(e instanceof Ga)return Gs("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{s=new pd(o,i,r)}catch(e){return Gs(e instanceof fd?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===s.Ie?null:s}Xe(e,t,n){return t.me.count===n-this.nt(e,t.targetId)?0:2}nt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let i=0;return n.forEach((n=>{const r=this.Le.tt(),o="projects/".concat(r.projectId,"/databases/").concat(r.database,"/documents/").concat(n.path.canonicalString());e.mightContain(o)||(this.Ue(t,n,null),i++)})),i}rt(e){const t=new Map;this.Be.forEach(((n,i)=>{const r=this.Je(i);if(r){if(n.current&&Hc(r.target)){const t=new fa(r.target.path);null!==this.ke.get(t)||this.it(i,t)||this.Ue(i,t,Ec.newNoDocument(t,e))}n.be&&(t.set(i,n.Ce()),n.ve())}}));let n=vl();this.qe.forEach(((e,t)=>{let i=!0;t.forEachWhile((e=>{const t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(i=!1,!1)})),i&&(n=n.add(e))})),this.ke.forEach(((t,n)=>n.setReadTime(e)));const i=new md(e,t,this.Qe,this.ke,n);return this.ke=dl(),this.qe=yd(),this.Qe=new Ua(sa),i}$e(e,t){if(!this.ze(e))return;const n=this.it(e,t.key)?2:0;this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;const i=this.Ge(e);this.it(e,t)?i.Fe(t,1):i.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){const t=this.Ge(e).Ce();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new Td,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new Fa(sa),this.qe=this.qe.insert(e,t)),t}ze(e){const t=null!==this.Je(e);return t||js("WatchChangeAggregator","Detected inactive target",e),t}Je(e){const t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new Td),this.Le.getRemoteKeysForTarget(e).forEach((t=>{this.Ue(e,t,null)}))}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function yd(){return new Ua(fa.comparator)}function Cd(){return new Ua(fa.comparator)}const Rd={asc:"ASCENDING",desc:"DESCENDING"},wd={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Id={and:"AND",or:"OR"};class bd{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Ad(e,t){return e.useProto3Json||ba(t)?t:{value:t}}function Od(e,t){return e.useProto3Json?"".concat(new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z",""),".").concat(("000000000"+t.nanoseconds).slice(-9),"Z"):{seconds:""+t.seconds,nanos:t.nanoseconds}}function Nd(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function Dd(e,t){return Od(e,t.toTimestamp())}function Pd(e){return Ks(!!e),la.fromTimestamp(function(e){const t=Ka(e);return new ca(t.seconds,t.nanos)}(e))}function kd(e,t){return Ld(e,t).canonicalString()}function Ld(e,t){const n=function(e){return new ua(["projects",e.projectId,"databases",e.database])}(e).child("documents");return void 0===t?n:n.child(t)}function Md(e){const t=ua.fromString(e);return Ks(tu(t)),t}function Ud(e,t){return kd(e.databaseId,t.path)}function xd(e,t){const n=Md(t);if(n.get(1)!==e.databaseId.projectId)throw new Ys(qs.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Ys(qs.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new fa(Bd(n))}function Vd(e,t){return kd(e.databaseId,t)}function Fd(e){const t=Md(e);return 4===t.length?ua.emptyPath():Bd(t)}function jd(e){return new ua(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Bd(e){return Ks(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function Gd(e,t,n){return{name:Ud(e,t),fields:n.value.mapValue.fields}}function Wd(e,t){let n;if(t instanceof ql)n={update:Gd(e,t.key,t.value)};else if(t instanceof Zl)n={delete:Ud(e,t.key)};else if(t instanceof Yl)n={update:Gd(e,t.key,t.data),updateMask:eu(t.fieldMask)};else{if(!(t instanceof $l))return Hs();n={verify:Ud(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof Ol)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Nl)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Pl)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Ll)return{fieldPath:t.field.canonicalString(),increment:n.Pe};throw Hs()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:Dd(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:Hs()}(e,t.precondition)),n}function Hd(e,t){return{documents:[Vd(e,t.path)]}}function Kd(e,t){const n={structuredQuery:{}},i=t.path;let r;null!==t.collectionGroup?(r=i,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(r=i.popLast(),n.structuredQuery.from=[{collectionId:i.lastSegment()}]),n.parent=Vd(e,r);const o=function(e){if(0!==e.length)return $d(wc.create(e,"and"))}(t.filters);o&&(n.structuredQuery.where=o);const s=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Qd(e.field),direction:Yd(e.dir)}}(e)))}(t.orderBy);s&&(n.structuredQuery.orderBy=s);const a=Ad(e,t.limit);return null!==a&&(n.structuredQuery.limit=a),t.startAt&&(n.structuredQuery.startAt=function(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{_t:n,parent:r}}function zd(e){let t=Fd(e.parent);const n=e.structuredQuery,i=n.from?n.from.length:0;let r=null;if(i>0){Ks(1===i);const e=n.from[0];e.allDescendants?r=e.collectionId:t=t.child(e.collectionId)}let o=[];n.where&&(o=function(e){const t=qd(e);return t instanceof wc&&bc(t)?t.getFilters():[t]}(n.where));let s=[];n.orderBy&&(s=function(e){return e.map((e=>function(e){return new Sc(Zd(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)))}(n.orderBy));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,ba(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new gc(n,t)}(n.startAt));let l=null;return n.endAt&&(l=function(e){const t=!e.before,n=e.values||[];return new gc(n,t)}(n.endAt)),zc(t,r,s,o,a,"F",c,l)}function qd(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Zd(e.unaryFilter.field);return Rc.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Zd(e.unaryFilter.field);return Rc.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const i=Zd(e.unaryFilter.field);return Rc.create(i,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=Zd(e.unaryFilter.field);return Rc.create(r,"!=",{nullValue:"NULL_VALUE"});default:return Hs()}}(e):void 0!==e.fieldFilter?function(e){return Rc.create(Zd(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Hs()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return wc.create(e.compositeFilter.filters.map((e=>qd(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return Hs()}}(e.compositeFilter.op))}(e):Hs()}function Yd(e){return Rd[e]}function Jd(e){return wd[e]}function Xd(e){return Id[e]}function Qd(e){return{fieldPath:e.canonicalString()}}function Zd(e){return pa.fromServerFormat(e.fieldPath)}function $d(e){return e instanceof Rc?function(e){if("=="===e.op){if(uc(e.value))return{unaryFilter:{field:Qd(e.field),op:"IS_NAN"}};if(dc(e.value))return{unaryFilter:{field:Qd(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(uc(e.value))return{unaryFilter:{field:Qd(e.field),op:"IS_NOT_NAN"}};if(dc(e.value))return{unaryFilter:{field:Qd(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Qd(e.field),op:Jd(e.op),value:e.value}}}(e):e instanceof wc?function(e){const t=e.getFilters().map((e=>$d(e)));return 1===t.length?t[0]:{compositeFilter:{op:Xd(e.op),filters:t}}}(e):Hs()}function eu(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function tu(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class nu{constructor(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:la.min(),o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:la.min(),s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:Wa.EMPTY_BYTE_STRING,a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=i,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=o,this.resumeToken=s,this.expectedCount=a}withSequenceNumber(e){return new nu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new nu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new nu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new nu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class iu{constructor(e){this.ct=e}}function ru(e){const t=zd({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?el(t,t.limit,"L"):t}class ou{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){if("nullValue"in e)this.Et(t,5);else if("booleanValue"in e)this.Et(t,10),t.dt(e.booleanValue?1:0);else if("integerValue"in e)this.Et(t,15),t.dt(za(e.integerValue));else if("doubleValue"in e){const n=za(e.doubleValue);isNaN(n)?this.Et(t,13):(this.Et(t,15),Aa(n)?t.dt(0):t.dt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Et(t,20),"string"==typeof n&&(n=Ka(n)),t.At("".concat(n.seconds||"")),t.dt(n.nanos||0)}else if("stringValue"in e)this.Rt(e.stringValue,t),this.Vt(t);else if("bytesValue"in e)this.Et(t,30),t.ft(qa(e.bytesValue)),this.Vt(t);else if("referenceValue"in e)this.gt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.Et(t,45),t.dt(n.latitude||0),t.dt(n.longitude||0)}else"mapValue"in e?fc(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):Hs()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){const n=e.fields||{};this.Et(t,55);for(const i of Object.keys(n))this.Rt(i,t),this.It(n[i],t)}wt(e,t){const n=e.values||[];this.Et(t,50);for(const i of n)this.It(i,t)}gt(e,t){this.Et(t,37),fa.fromName(e).path.forEach((e=>{this.Et(t,60),this.St(e,t)}))}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}}ou.bt=new ou;class su{constructor(){this._n=new au}addToCollectionParentIndex(e,t){return this._n.add(t),Ca.resolve()}getCollectionParents(e,t){return Ca.resolve(this._n.getEntries(t))}addFieldIndex(e,t){return Ca.resolve()}deleteFieldIndex(e,t){return Ca.resolve()}deleteAllFieldIndexes(e){return Ca.resolve()}createTargetIndexes(e,t){return Ca.resolve()}getDocumentsMatchingTarget(e,t){return Ca.resolve(null)}getIndexType(e,t){return Ca.resolve(0)}getFieldIndexes(e,t){return Ca.resolve([])}getNextCollectionGroupToUpdate(e){return Ca.resolve(null)}getMinOffset(e,t){return Ca.resolve(ga.min())}getMinOffsetFromCollectionGroup(e,t){return Ca.resolve(ga.min())}updateCollectionGroup(e,t,n){return Ca.resolve()}updateIndexEntries(e,t){return Ca.resolve()}}class au{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),i=this.index[t]||new Fa(ua.comparator),r=!i.has(n);return this.index[t]=i.add(n),r}has(e){const t=e.lastSegment(),n=e.popLast(),i=this.index[t];return i&&i.has(n)}getEntries(e){return(this.index[e]||new Fa(ua.comparator)).toArray()}}new Uint8Array(0);class cu{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new cu(e,cu.DEFAULT_COLLECTION_PERCENTILE,cu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}cu.DEFAULT_COLLECTION_PERCENTILE=10,cu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,cu.DEFAULT=new cu(41943040,cu.DEFAULT_COLLECTION_PERCENTILE,cu.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),cu.DISABLED=new cu(-1,0,0);class lu{constructor(e){this.On=e}next(){return this.On+=2,this.On}static Nn(){return new lu(0)}static Ln(){return new lu(-1)}}class du{constructor(){this.changes=new cl((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Ec.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?Ca.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class uu{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class hu{constructor(e,t,n,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=i}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((i=>(n=i,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&Hl(n.mutation,e,Ba.empty(),ca.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,vl()).next((()=>t))))}getLocalViewOfDocuments(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:vl();const i=fl();return this.populateOverlays(e,i,t).next((()=>this.computeViews(e,t,i,n).next((e=>{let t=hl();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=fl();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,vl())))}populateOverlays(e,t,n){const i=[];return n.forEach((e=>{t.has(e)||i.push(e)})),this.documentOverlayCache.getOverlays(e,i).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,i){let r=dl();const o=_l(),s=_l();return t.forEach(((e,t)=>{const s=n.get(t.key);i.has(t.key)&&(void 0===s||s.mutation instanceof Yl)?r=r.insert(t.key,t):void 0!==s?(o.set(t.key,s.mutation.getFieldMask()),Hl(s.mutation,t,s.mutation.getFieldMask(),ca.now())):o.set(t.key,Ba.empty())})),this.recalculateAndSaveOverlays(e,r).next((e=>(e.forEach(((e,t)=>o.set(e,t))),t.forEach(((e,t)=>{var n;return s.set(e,new uu(t,null!==(n=o.get(e))&&void 0!==n?n:null))})),s)))}recalculateAndSaveOverlays(e,t){const n=_l();let i=new Ua(((e,t)=>e-t)),r=vl();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const r of e)r.keys().forEach((e=>{const o=t.get(e);if(null===o)return;let s=n.get(e)||Ba.empty();s=r.applyToLocalView(o,s),n.set(e,s);const a=(i.get(r.batchId)||vl()).add(e);i=i.insert(r.batchId,a)}))})).next((()=>{const o=[],s=i.getReverseIterator();for(;s.hasNext();){const i=s.getNext(),a=i.key,c=i.value,l=ml();c.forEach((e=>{if(!r.has(e)){const i=Gl(t.get(e),n.get(e));null!==i&&l.set(e,i),r=r.add(e)}})),o.push(this.documentOverlayCache.saveOverlays(e,a,l))}return Ca.waitFor(o)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n,i){return function(e){return fa.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Jc(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,i):this.getDocumentsMatchingCollectionQuery(e,t,n,i)}getNextDocuments(e,t,n,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,i).next((r=>{const o=i-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,i-r.size):Ca.resolve(fl());let s=-1,a=r;return o.next((t=>Ca.forEach(t,((t,n)=>(s<n.largestBatchId&&(s=n.largestBatchId),r.get(t)?Ca.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,r))).next((()=>this.computeViews(e,a,t,vl()))).next((e=>({batchId:s,changes:pl(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new fa(t)).next((e=>{let t=hl();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n,i){const r=t.collectionGroup;let o=hl();return this.indexManager.getCollectionParents(e,r).next((s=>Ca.forEach(s,(s=>{const a=function(e,t){return new Kc(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,s.child(r));return this.getDocumentsMatchingCollectionQuery(e,a,n,i).next((e=>{e.forEach(((e,t)=>{o=o.insert(e,t)}))}))})).next((()=>o))))}getDocumentsMatchingCollectionQuery(e,t,n,i){let r;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((o=>(r=o,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,r,i)))).next((e=>{r.forEach(((t,n)=>{const i=n.getKey();null===e.get(i)&&(e=e.insert(i,Ec.newInvalidDocument(i)))}));let n=hl();return e.forEach(((e,i)=>{const o=r.get(e);void 0!==o&&Hl(o.mutation,i,Ba.empty(),ca.now()),rl(t,i)&&(n=n.insert(e,i))})),n}))}}class pu{constructor(e){this.serializer=e,this.cr=new Map,this.lr=new Map}getBundleMetadata(e,t){return Ca.resolve(this.cr.get(t))}saveBundleMetadata(e,t){return this.cr.set(t.id,function(e){return{id:e.id,version:e.version,createTime:Pd(e.createTime)}}(t)),Ca.resolve()}getNamedQuery(e,t){return Ca.resolve(this.lr.get(t))}saveNamedQuery(e,t){return this.lr.set(t.name,function(e){return{name:e.name,query:ru(e.bundledQuery),readTime:Pd(e.readTime)}}(t)),Ca.resolve()}}class fu{constructor(){this.overlays=new Ua(fa.comparator),this.hr=new Map}getOverlay(e,t){return Ca.resolve(this.overlays.get(t))}getOverlays(e,t){const n=fl();return Ca.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,i)=>{this.ht(e,t,i)})),Ca.resolve()}removeOverlaysForBatchId(e,t,n){const i=this.hr.get(n);return void 0!==i&&(i.forEach((e=>this.overlays=this.overlays.remove(e))),this.hr.delete(n)),Ca.resolve()}getOverlaysForCollection(e,t,n){const i=fl(),r=t.length+1,o=new fa(t.child("")),s=this.overlays.getIteratorFrom(o);for(;s.hasNext();){const e=s.getNext().value,o=e.getKey();if(!t.isPrefixOf(o.path))break;o.path.length===r&&e.largestBatchId>n&&i.set(e.getKey(),e)}return Ca.resolve(i)}getOverlaysForCollectionGroup(e,t,n,i){let r=new Ua(((e,t)=>e-t));const o=this.overlays.getIterator();for(;o.hasNext();){const e=o.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=r.get(e.largestBatchId);null===t&&(t=fl(),r=r.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const s=fl(),a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>s.set(e,t))),!(s.size()>=i)););return Ca.resolve(s)}ht(e,t,n){const i=this.overlays.get(n.key);if(null!==i){const e=this.hr.get(i.largestBatchId).delete(n.key);this.hr.set(i.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new nd(t,n));let r=this.hr.get(t);void 0===r&&(r=vl(),this.hr.set(t,r)),this.hr.set(t,r.add(n.key))}}class mu{constructor(){this.Pr=new Fa(_u.Ir),this.Tr=new Fa(_u.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(e,t){const n=new _u(e,t);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.Ar(new _u(e,t))}Rr(e,t){e.forEach((e=>this.removeReference(e,t)))}Vr(e){const t=new fa(new ua([])),n=new _u(t,e),i=new _u(t,e+1),r=[];return this.Tr.forEachInRange([n,i],(e=>{this.Ar(e),r.push(e.key)})),r}mr(){this.Pr.forEach((e=>this.Ar(e)))}Ar(e){this.Pr=this.Pr.delete(e),this.Tr=this.Tr.delete(e)}gr(e){const t=new fa(new ua([])),n=new _u(t,e),i=new _u(t,e+1);let r=vl();return this.Tr.forEachInRange([n,i],(e=>{r=r.add(e.key)})),r}containsKey(e){const t=new _u(e,0),n=this.Pr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class _u{constructor(e,t){this.key=e,this.pr=t}static Ir(e,t){return fa.comparator(e.key,t.key)||sa(e.pr,t.pr)}static Er(e,t){return sa(e.pr,t.pr)||fa.comparator(e.key,t.key)}}class Eu{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.yr=1,this.wr=new Fa(_u.Ir)}checkEmpty(e){return Ca.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,i){const r=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const o=new ed(r,t,n,i);this.mutationQueue.push(o);for(const s of i)this.wr=this.wr.add(new _u(s.key,r)),this.indexManager.addToCollectionParentIndex(e,s.key.path.popLast());return Ca.resolve(o)}lookupMutationBatch(e,t){return Ca.resolve(this.Sr(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,i=this.br(n),r=i<0?0:i;return Ca.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return Ca.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(e){return Ca.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new _u(t,0),i=new _u(t,Number.POSITIVE_INFINITY),r=[];return this.wr.forEachInRange([n,i],(e=>{const t=this.Sr(e.pr);r.push(t)})),Ca.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Fa(sa);return t.forEach((e=>{const t=new _u(e,0),i=new _u(e,Number.POSITIVE_INFINITY);this.wr.forEachInRange([t,i],(e=>{n=n.add(e.pr)}))})),Ca.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,i=n.length+1;let r=n;fa.isDocumentKey(r)||(r=r.child(""));const o=new _u(new fa(r),0);let s=new Fa(sa);return this.wr.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===i&&(s=s.add(e.pr)),!0)}),o),Ca.resolve(this.Dr(s))}Dr(e){const t=[];return e.forEach((e=>{const n=this.Sr(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){Ks(0===this.Cr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return Ca.forEach(t.mutations,(i=>{const r=new _u(i.key,t.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)})).next((()=>{this.wr=n}))}Mn(e){}containsKey(e,t){const n=new _u(t,0),i=this.wr.firstAfterOrEqual(n);return Ca.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return this.mutationQueue.length,Ca.resolve()}Cr(e,t){return this.br(e)}br(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Sr(e){const t=this.br(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class gu{constructor(e){this.vr=e,this.docs=new Ua(fa.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,i=this.docs.get(n),r=i?i.size:0,o=this.vr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:o}),this.size+=o-r,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return Ca.resolve(n?n.document.mutableCopy():Ec.newInvalidDocument(t))}getEntries(e,t){let n=dl();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Ec.newInvalidDocument(e))})),Ca.resolve(n)}getDocumentsMatchingQuery(e,t,n,i){let r=dl();const o=t.path,s=new fa(o.child("")),a=this.docs.getIteratorFrom(s);for(;a.hasNext();){const{key:e,value:{document:s}}=a.getNext();if(!o.isPrefixOf(e.path))break;e.path.length>o.length+1||va(Ea(s),n)<=0||(i.has(s.key)||rl(t,s))&&(r=r.insert(s.key,s.mutableCopy()))}return Ca.resolve(r)}getAllFromCollectionGroup(e,t,n,i){Hs()}Fr(e,t){return Ca.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new vu(this)}getSize(e){return Ca.resolve(this.size)}}class vu extends du{constructor(e){super(),this.ar=e}applyChanges(e){const t=[];return this.changes.forEach(((n,i)=>{i.isValidDocument()?t.push(this.ar.addEntry(e,i)):this.ar.removeEntry(n)})),Ca.waitFor(t)}getFromCache(e,t){return this.ar.getEntry(e,t)}getAllFromCache(e,t){return this.ar.getEntries(e,t)}}class Tu{constructor(e){this.persistence=e,this.Mr=new cl((e=>Gc(e)),Wc),this.lastRemoteSnapshotVersion=la.min(),this.highestTargetId=0,this.Or=0,this.Nr=new mu,this.targetCount=0,this.Lr=lu.Nn()}forEachTarget(e,t){return this.Mr.forEach(((e,n)=>t(n))),Ca.resolve()}getLastRemoteSnapshotVersion(e){return Ca.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return Ca.resolve(this.Or)}allocateTargetId(e){return this.highestTargetId=this.Lr.next(),Ca.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Or&&(this.Or=t),Ca.resolve()}qn(e){this.Mr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Lr=new lu(t),this.highestTargetId=t),e.sequenceNumber>this.Or&&(this.Or=e.sequenceNumber)}addTargetData(e,t){return this.qn(t),this.targetCount+=1,Ca.resolve()}updateTargetData(e,t){return this.qn(t),Ca.resolve()}removeTargetData(e,t){return this.Mr.delete(t.target),this.Nr.Vr(t.targetId),this.targetCount-=1,Ca.resolve()}removeTargets(e,t,n){let i=0;const r=[];return this.Mr.forEach(((o,s)=>{s.sequenceNumber<=t&&null===n.get(s.targetId)&&(this.Mr.delete(o),r.push(this.removeMatchingKeysForTargetId(e,s.targetId)),i++)})),Ca.waitFor(r).next((()=>i))}getTargetCount(e){return Ca.resolve(this.targetCount)}getTargetData(e,t){const n=this.Mr.get(t)||null;return Ca.resolve(n)}addMatchingKeys(e,t,n){return this.Nr.dr(t,n),Ca.resolve()}removeMatchingKeys(e,t,n){this.Nr.Rr(t,n);const i=this.persistence.referenceDelegate,r=[];return i&&t.forEach((t=>{r.push(i.markPotentiallyOrphaned(e,t))})),Ca.waitFor(r)}removeMatchingKeysForTargetId(e,t){return this.Nr.Vr(t),Ca.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Nr.gr(t);return Ca.resolve(n)}containsKey(e,t){return Ca.resolve(this.Nr.containsKey(t))}}class Su{constructor(e,t){this.Br={},this.overlays={},this.kr=new Ia(0),this.qr=!1,this.qr=!0,this.referenceDelegate=e(this),this.Qr=new Tu(this),this.indexManager=new su,this.remoteDocumentCache=function(e){return new gu(e)}((e=>this.referenceDelegate.Kr(e))),this.serializer=new iu(t),this.$r=new pu(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new fu,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Br[e.toKey()];return n||(n=new Eu(t,this.referenceDelegate),this.Br[e.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(e,t,n){js("MemoryPersistence","Starting transaction:",e);const i=new yu(this.kr.next());return this.referenceDelegate.Ur(),n(i).next((e=>this.referenceDelegate.Wr(i).next((()=>e)))).toPromise().then((e=>(i.raiseOnCommittedEvent(),e)))}Gr(e,t){return Ca.or(Object.values(this.Br).map((n=>()=>n.containsKey(e,t))))}}class yu extends Sa{constructor(e){super(),this.currentSequenceNumber=e}}class Cu{constructor(e){this.persistence=e,this.zr=new mu,this.jr=null}static Hr(e){return new Cu(e)}get Jr(){if(this.jr)return this.jr;throw Hs()}addReference(e,t,n){return this.zr.addReference(n,t),this.Jr.delete(n.toString()),Ca.resolve()}removeReference(e,t,n){return this.zr.removeReference(n,t),this.Jr.add(n.toString()),Ca.resolve()}markPotentiallyOrphaned(e,t){return this.Jr.add(t.toString()),Ca.resolve()}removeTarget(e,t){this.zr.Vr(t.targetId).forEach((e=>this.Jr.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Jr.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Ur(){this.jr=new Set}Wr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ca.forEach(this.Jr,(n=>{const i=fa.fromPath(n);return this.Yr(e,i).next((e=>{e||t.removeEntry(i,la.min())}))})).next((()=>(this.jr=null,t.apply(e))))}updateLimboDocument(e,t){return this.Yr(e,t).next((e=>{e?this.Jr.delete(t.toString()):this.Jr.add(t.toString())}))}Kr(e){return 0}Yr(e,t){return Ca.or([()=>Ca.resolve(this.zr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gr(e,t)])}}class Ru{constructor(e,t,n,i){this.targetId=e,this.fromCache=t,this.qi=n,this.Qi=i}static Ki(e,t){let n=vl(),i=vl();for(const r of t.docChanges)switch(r.type){case 0:n=n.add(r.doc.key);break;case 1:i=i.add(r.doc.key)}return new Ru(e,t.fromCache,n,i)}}class wu{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class Iu{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=Ge()?8:Ra(Be())>0?6:4}initialize(e,t){this.zi=e,this.indexManager=t,this.$i=!0}getDocumentsMatchingQuery(e,t,n,i){const r={result:null};return this.ji(e,t).next((e=>{r.result=e})).next((()=>{if(!r.result)return this.Hi(e,t,i,n).next((e=>{r.result=e}))})).next((()=>{if(r.result)return;const n=new wu;return this.Ji(e,t,n).next((i=>{if(r.result=i,this.Ui)return this.Yi(e,t,n,i.size)}))})).next((()=>r.result))}Yi(e,t,n,i){return n.documentReadCount<this.Wi?(Fs()<=st.DEBUG&&js("QueryEngine","SDK will not create cache indexes for query:",il(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),Ca.resolve()):(Fs()<=st.DEBUG&&js("QueryEngine","Query:",il(t),"scans",n.documentReadCount,"local documents and returns",i,"documents as results."),n.documentReadCount>this.Gi*i?(Fs()<=st.DEBUG&&js("QueryEngine","The SDK decides to create cache indexes for query:",il(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Qc(t))):Ca.resolve())}ji(e,t){if(Yc(t))return Ca.resolve(null);let n=Qc(t);return this.indexManager.getIndexType(e,n).next((i=>0===i?null:(null!==t.limit&&1===i&&(t=el(t,null,"F"),n=Qc(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((i=>{const r=vl(...i);return this.zi.getDocuments(e,r).next((i=>this.indexManager.getMinOffset(e,n).next((n=>{const o=this.Zi(t,i);return this.Xi(t,o,r,n.readTime)?this.ji(e,el(t,null,"F")):this.es(e,o,t,n)}))))})))))}Hi(e,t,n,i){return Yc(t)||i.isEqual(la.min())?Ca.resolve(null):this.zi.getDocuments(e,n).next((r=>{const o=this.Zi(t,r);return this.Xi(t,o,n,i)?Ca.resolve(null):(Fs()<=st.DEBUG&&js("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),il(t)),this.es(e,o,t,_a(i,-1)).next((e=>e)))}))}Zi(e,t){let n=new Fa(sl(e));return t.forEach(((t,i)=>{rl(e,i)&&(n=n.add(i))})),n}Xi(e,t,n,i){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const r="F"===e.limitType?t.last():t.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(i)>0)}Ji(e,t,n){return Fs()<=st.DEBUG&&js("QueryEngine","Using full collection scan to execute query:",il(t)),this.zi.getDocumentsMatchingQuery(e,t,ga.min(),n)}es(e,t,n,i){return this.zi.getDocumentsMatchingQuery(e,n,i).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class bu{constructor(e,t,n,i){this.persistence=e,this.ts=t,this.serializer=i,this.ns=new Ua(sa),this.rs=new cl((e=>Gc(e)),Wc),this.ss=new Map,this.os=e.getRemoteDocumentCache(),this.Qr=e.getTargetCache(),this.$r=e.getBundleCache(),this._s(n)}_s(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new hu(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.ns)))}}function Au(e,t,n,i){return new bu(e,t,n,i)}async function Ou(e,t){const n=zs(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let i;return n.mutationQueue.getAllMutationBatches(e).next((r=>(i=r,n._s(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const r=[],o=[];let s=vl();for(const e of i){r.push(e.batchId);for(const t of e.mutations)s=s.add(t.key)}for(const e of t){o.push(e.batchId);for(const t of e.mutations)s=s.add(t.key)}return n.localDocuments.getDocuments(e,s).next((e=>({us:e,removedBatchIds:r,addedBatchIds:o})))}))}))}function Nu(e){const t=zs(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Qr.getLastRemoteSnapshotVersion(e)))}function Du(e,t,n){let i=vl(),r=vl();return n.forEach((e=>i=i.add(e))),t.getEntries(e,i).next((e=>{let i=dl();return n.forEach(((n,o)=>{const s=e.get(n);o.isFoundDocument()!==s.isFoundDocument()&&(r=r.add(n)),o.isNoDocument()&&o.version.isEqual(la.min())?(t.removeEntry(n,o.readTime),i=i.insert(n,o)):!s.isValidDocument()||o.version.compareTo(s.version)>0||0===o.version.compareTo(s.version)&&s.hasPendingWrites?(t.addEntry(o),i=i.insert(n,o)):js("LocalStore","Ignoring outdated watch update for ",n,". Current version:",s.version," Watch version:",o.version)})),{cs:i,ls:r}}))}function Pu(e,t){const n=zs(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function ku(e,t){const n=zs(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let i;return n.Qr.getTargetData(e,t).next((r=>r?(i=r,Ca.resolve(i)):n.Qr.allocateTargetId(e).next((r=>(i=new nu(t,r,"TargetPurposeListen",e.currentSequenceNumber),n.Qr.addTargetData(e,i).next((()=>i)))))))})).then((e=>{const i=n.ns.get(e.targetId);return(null===i||e.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(n.ns=n.ns.insert(e.targetId,e),n.rs.set(t,e.targetId)),e}))}async function Lu(e,t,n){const i=zs(e),r=i.ns.get(t),o=n?"readwrite":"readwrite-primary";try{n||await i.persistence.runTransaction("Release target",o,(e=>i.persistence.referenceDelegate.removeTarget(e,r)))}catch(e){if(!wa(e))throw e;js("LocalStore","Failed to update sequence numbers for target ".concat(t,": ").concat(e))}i.ns=i.ns.remove(t),i.rs.delete(r.target)}function Mu(e,t,n){const i=zs(e);let r=la.min(),o=vl();return i.persistence.runTransaction("Execute query","readwrite",(e=>function(e,t,n){const i=zs(e),r=i.rs.get(n);return void 0!==r?Ca.resolve(i.ns.get(r)):i.Qr.getTargetData(t,n)}(i,e,Qc(t)).next((t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,i.Qr.getMatchingKeysForTargetId(e,t.targetId).next((e=>{o=e}))})).next((()=>i.ts.getDocumentsMatchingQuery(e,t,n?r:la.min(),n?o:vl()))).next((e=>(Uu(i,ol(t),e),{documents:e,hs:o})))))}function Uu(e,t,n){let i=e.ss.get(t)||la.min();n.forEach(((e,t)=>{t.readTime.compareTo(i)>0&&(i=t.readTime)})),e.ss.set(t,i)}class xu{constructor(){this.activeTargetIds=Sl()}As(e){this.activeTargetIds=this.activeTargetIds.add(e)}Rs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ds(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Vu{constructor(){this.no=new xu,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.no.As(e),this.ro[e]||"not-current"}updateQueryState(e,t,n){this.ro[e]=t}removeLocalQueryTarget(e){this.no.Rs(e)}isLocalQueryTarget(e){return this.no.activeTargetIds.has(e)}clearQueryState(e){delete this.ro[e]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(e){return this.no.activeTargetIds.has(e)}start(){return this.no=new xu,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Fu{io(e){}shutdown(){}}class ju{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(e){this.uo.push(e)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){js("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.uo)e(0)}ao(){js("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.uo)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Bu=null;function Gu(){return null===Bu?Bu=268435456+Math.round(2147483648*Math.random()):Bu++,"0x"+Bu.toString(16)}const Wu={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Hu{constructor(e){this.lo=e.lo,this.ho=e.ho}Po(e){this.Io=e}To(e){this.Eo=e}Ao(e){this.Ro=e}onMessage(e){this.Vo=e}close(){this.ho()}send(e){this.lo(e)}mo(){this.Io()}fo(){this.Eo()}po(e){this.Ro(e)}yo(e){this.Vo(e)}}const Ku="WebChannelConnection";class zu extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),i=encodeURIComponent(this.databaseId.database);this.wo=t+"://"+e.host,this.So="projects/".concat(n,"/databases/").concat(i),this.bo="(default)"===this.databaseId.database?"project_id=".concat(n):"project_id=".concat(n,"&database_id=").concat(i)}get Do(){return!1}Co(e,t,n,i,r){const o=Gu(),s=this.vo(e,t.toUriEncodedString());js("RestConnection","Sending RPC '".concat(e,"' ").concat(o,":"),s,n);const a={"google-cloud-resource-prefix":this.So,"x-goog-request-params":this.bo};return this.Fo(a,i,r),this.Mo(e,s,a,n).then((t=>(js("RestConnection","Received RPC '".concat(e,"' ").concat(o,": "),t),t)),(t=>{throw Gs("RestConnection","RPC '".concat(e,"' ").concat(o," failed with error: "),t,"url: ",s,"request:",n),t}))}xo(e,t,n,i,r,o){return this.Co(e,t,n,i,r)}Fo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+xs,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}vo(e,t){const n=Wu[e];return"".concat(this.wo,"/v1/").concat(t,":").concat(n)}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Mo(e,t,n,i){const r=Gu();return new Promise(((o,s)=>{const a=new Rs;a.setWithCredentials(!0),a.listenOnce(bs.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case As.NO_ERROR:const t=a.getResponseJson();js(Ku,"XHR for RPC '".concat(e,"' ").concat(r," received:"),JSON.stringify(t)),o(t);break;case As.TIMEOUT:js(Ku,"RPC '".concat(e,"' ").concat(r," timed out")),s(new Ys(qs.DEADLINE_EXCEEDED,"Request time out"));break;case As.HTTP_ERROR:const n=a.getStatus();if(js(Ku,"RPC '".concat(e,"' ").concat(r," failed with status:"),n,"response text:",a.getResponseText()),n>0){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(qs).indexOf(t)>=0?t:qs.UNKNOWN}(t.status);s(new Ys(e,t.message))}else s(new Ys(qs.UNKNOWN,"Server responded with status "+a.getStatus()))}else s(new Ys(qs.UNAVAILABLE,"Connection failed."));break;default:Hs()}}finally{js(Ku,"RPC '".concat(e,"' ").concat(r," completed."))}}));const c=JSON.stringify(i);js(Ku,"RPC '".concat(e,"' ").concat(r," sending request:"),i),a.send(t,"POST",c,n,15)}))}Oo(e,t,n){const i=Gu(),r=[this.wo,"/","google.firestore.v1.Firestore","/",e,"/channel"],o=Ps(),s=Ds(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/".concat(this.databaseId.projectId,"/databases/").concat(this.databaseId.database)},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(a.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(a.xmlHttpFactory=new ws({})),this.Fo(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;const l=r.join("");js(Ku,"Creating RPC '".concat(e,"' stream ").concat(i,": ").concat(l),a);const d=o.createWebChannel(l,a);let u=!1,h=!1;const p=new Hu({lo:t=>{h?js(Ku,"Not sending because RPC '".concat(e,"' stream ").concat(i," is closed:"),t):(u||(js(Ku,"Opening RPC '".concat(e,"' stream ").concat(i," transport.")),d.open(),u=!0),js(Ku,"RPC '".concat(e,"' stream ").concat(i," sending:"),t),d.send(t))},ho:()=>d.close()}),f=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return f(d,Is.EventType.OPEN,(()=>{h||(js(Ku,"RPC '".concat(e,"' stream ").concat(i," transport opened.")),p.mo())})),f(d,Is.EventType.CLOSE,(()=>{h||(h=!0,js(Ku,"RPC '".concat(e,"' stream ").concat(i," transport closed")),p.po())})),f(d,Is.EventType.ERROR,(t=>{h||(h=!0,Gs(Ku,"RPC '".concat(e,"' stream ").concat(i," transport errored:"),t),p.po(new Ys(qs.UNAVAILABLE,"The operation could not be completed")))})),f(d,Is.EventType.MESSAGE,(t=>{var n;if(!h){const r=t.data[0];Ks(!!r);const o=r,s=o.error||(null===(n=o[0])||void 0===n?void 0:n.error);if(s){js(Ku,"RPC '".concat(e,"' stream ").concat(i," received error:"),s);const t=s.status;let n=function(e){const t=rd[e];if(void 0!==t)return ad(t)}(t),r=s.message;void 0===n&&(n=qs.INTERNAL,r="Unknown error status: "+t+" with message "+s.message),h=!0,p.po(new Ys(n,r)),d.close()}else js(Ku,"RPC '".concat(e,"' stream ").concat(i," received:"),r),p.yo(r)}})),f(s,Ns.STAT_EVENT,(t=>{t.stat===Os.PROXY?js(Ku,"RPC '".concat(e,"' stream ").concat(i," detected buffering proxy")):t.stat===Os.NOPROXY&&js(Ku,"RPC '".concat(e,"' stream ").concat(i," detected no buffering proxy"))})),setTimeout((()=>{p.fo()}),0),p}}function qu(){return"undefined"!=typeof document?document:null}function Yu(e){return new bd(e,!0)}class Ju{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1.5,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:6e4;this.oi=e,this.timerId=t,this.No=n,this.Lo=i,this.Bo=r,this.ko=0,this.qo=null,this.Qo=Date.now(),this.reset()}reset(){this.ko=0}Ko(){this.ko=this.Bo}$o(e){this.cancel();const t=Math.floor(this.ko+this.Uo()),n=Math.max(0,Date.now()-this.Qo),i=Math.max(0,t-n);i>0&&js("ExponentialBackoff","Backing off for ".concat(i," ms (base delay: ").concat(this.ko," ms, delay with jitter: ").concat(t," ms, last attempt: ").concat(n," ms ago)")),this.qo=this.oi.enqueueAfterDelay(this.timerId,i,(()=>(this.Qo=Date.now(),e()))),this.ko*=this.Lo,this.ko<this.No&&(this.ko=this.No),this.ko>this.Bo&&(this.ko=this.Bo)}Wo(){null!==this.qo&&(this.qo.skipDelay(),this.qo=null)}cancel(){null!==this.qo&&(this.qo.cancel(),this.qo=null)}Uo(){return(Math.random()-.5)*this.ko}}class Xu{constructor(e,t,n,i,r,o,s,a){this.oi=e,this.Go=n,this.zo=i,this.connection=r,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=s,this.listener=a,this.state=0,this.jo=0,this.Ho=null,this.Jo=null,this.stream=null,this.Yo=new Ju(e,t)}Zo(){return 1===this.state||5===this.state||this.Xo()}Xo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.e_()}async stop(){this.Zo()&&await this.close(0)}t_(){this.state=0,this.Yo.reset()}n_(){this.Xo()&&null===this.Ho&&(this.Ho=this.oi.enqueueAfterDelay(this.Go,6e4,(()=>this.r_())))}i_(e){this.s_(),this.stream.send(e)}async r_(){if(this.Xo())return this.close(0)}s_(){this.Ho&&(this.Ho.cancel(),this.Ho=null)}o_(){this.Jo&&(this.Jo.cancel(),this.Jo=null)}async close(e,t){this.s_(),this.o_(),this.Yo.cancel(),this.jo++,4!==e?this.Yo.reset():t&&t.code===qs.RESOURCE_EXHAUSTED?(Bs(t.toString()),Bs("Using maximum backoff delay to prevent overloading the backend."),this.Yo.Ko()):t&&t.code===qs.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.__(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Ao(t)}__(){}auth(){this.state=1;const e=this.a_(this.jo),t=this.jo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((e=>{let[n,i]=e;this.jo===t&&this.u_(n,i)}),(t=>{e((()=>{const e=new Ys(qs.UNKNOWN,"Fetching auth token failed: "+t.message);return this.c_(e)}))}))}u_(e,t){const n=this.a_(this.jo);this.stream=this.l_(e,t),this.stream.Po((()=>{n((()=>this.listener.Po()))})),this.stream.To((()=>{n((()=>(this.state=2,this.Jo=this.oi.enqueueAfterDelay(this.zo,1e4,(()=>(this.Xo()&&(this.state=3),Promise.resolve()))),this.listener.To())))})),this.stream.Ao((e=>{n((()=>this.c_(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}e_(){this.state=5,this.Yo.$o((async()=>{this.state=0,this.start()}))}c_(e){return js("PersistentStream","close with error: ".concat(e)),this.stream=null,this.close(4,e)}a_(e){return t=>{this.oi.enqueueAndForget((()=>this.jo===e?t():(js("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Qu extends Xu{constructor(e,t,n,i,r,o){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,i,o),this.serializer=r}l_(e,t){return this.connection.Oo("Listen",e,t)}onMessage(e){this.Yo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const i=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:Hs()}(t.targetChange.targetChangeType||"NO_CHANGE"),r=t.targetChange.targetIds||[],o=function(e,t){return e.useProto3Json?(Ks(void 0===t||"string"==typeof t),Wa.fromBase64String(t||"")):(Ks(void 0===t||t instanceof Buffer||t instanceof Uint8Array),Wa.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),s=t.targetChange.cause,a=s&&function(e){const t=void 0===e.code?qs.UNKNOWN:ad(e.code);return new Ys(t,e.message||"")}(s);n=new vd(i,r,o,a||null)}else if("documentChange"in t){t.documentChange;const i=t.documentChange;i.document,i.document.name,i.document.updateTime;const r=xd(e,i.document.name),o=Pd(i.document.updateTime),s=i.document.createTime?Pd(i.document.createTime):la.min(),a=new mc({mapValue:{fields:i.document.fields}}),c=Ec.newFoundDocument(r,o,s,a),l=i.targetIds||[],d=i.removedTargetIds||[];n=new Ed(l,d,c.key,c)}else if("documentDelete"in t){t.documentDelete;const i=t.documentDelete;i.document;const r=xd(e,i.document),o=i.readTime?Pd(i.readTime):la.min(),s=Ec.newNoDocument(r,o),a=i.removedTargetIds||[];n=new Ed([],a,s.key,s)}else if("documentRemove"in t){t.documentRemove;const i=t.documentRemove;i.document;const r=xd(e,i.document),o=i.removedTargetIds||[];n=new Ed([],o,r,null)}else{if(!("filter"in t))return Hs();{t.filter;const e=t.filter;e.targetId;const{count:i=0,unchangedNames:r}=e,o=new id(i,r),s=e.targetId;n=new gd(s,o)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return la.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?la.min():t.readTime?Pd(t.readTime):la.min()}(e);return this.listener.h_(t,n)}P_(e){const t={};t.database=jd(this.serializer),t.addTarget=function(e,t){let n;const i=t.target;if(n=Hc(i)?{documents:Hd(e,i)}:{query:Kd(e,i)._t},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=Nd(e,t.resumeToken);const i=Ad(e,t.expectedCount);null!==i&&(n.expectedCount=i)}else if(t.snapshotVersion.compareTo(la.min())>0){n.readTime=Od(e,t.snapshotVersion.toTimestamp());const i=Ad(e,t.expectedCount);null!==i&&(n.expectedCount=i)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Hs()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.i_(t)}I_(e){const t={};t.database=jd(this.serializer),t.removeTarget=e,this.i_(t)}}class Zu extends Xu{constructor(e,t,n,i,r,o){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,i,o),this.serializer=r,this.T_=!1}get E_(){return this.T_}start(){this.T_=!1,this.lastStreamToken=void 0,super.start()}__(){this.T_&&this.d_([])}l_(e,t){return this.connection.Oo("Write",e,t)}onMessage(e){if(Ks(!!e.streamToken),this.lastStreamToken=e.streamToken,this.T_){this.Yo.reset();const t=function(e,t){return e&&e.length>0?(Ks(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?Pd(e.updateTime):Pd(t);return n.isEqual(la.min())&&(n=Pd(t)),new Vl(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=Pd(e.commitTime);return this.listener.A_(n,t)}return Ks(!e.writeResults||0===e.writeResults.length),this.T_=!0,this.listener.R_()}V_(){const e={};e.database=jd(this.serializer),this.i_(e)}d_(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Wd(this.serializer,e)))};this.i_(t)}}class $u extends class{}{constructor(e,t,n,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=i,this.m_=!1}f_(){if(this.m_)throw new Ys(qs.FAILED_PRECONDITION,"The client has already been terminated.")}Co(e,t,n,i){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((r=>{let[o,s]=r;return this.connection.Co(e,Ld(t,n),i,o,s)})).catch((e=>{throw"FirebaseError"===e.name?(e.code===qs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Ys(qs.UNKNOWN,e.toString())}))}xo(e,t,n,i,r){return this.f_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((o=>{let[s,a]=o;return this.connection.xo(e,Ld(t,n),i,s,a,r)})).catch((e=>{throw"FirebaseError"===e.name?(e.code===qs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Ys(qs.UNKNOWN,e.toString())}))}terminate(){this.m_=!0,this.connection.terminate()}}class eh{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.g_=0,this.p_=null,this.y_=!0}w_(){0===this.g_&&(this.S_("Unknown"),this.p_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.p_=null,this.b_("Backend didn't respond within 10 seconds."),this.S_("Offline"),Promise.resolve()))))}D_(e){"Online"===this.state?this.S_("Unknown"):(this.g_++,this.g_>=1&&(this.C_(),this.b_("Connection failed 1 times. Most recent error: ".concat(e.toString())),this.S_("Offline")))}set(e){this.C_(),this.g_=0,"Online"===e&&(this.y_=!1),this.S_(e)}S_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}b_(e){const t="Could not reach Cloud Firestore backend. ".concat(e,"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.");this.y_?(Bs(t),this.y_=!1):js("OnlineStateTracker",t)}C_(){null!==this.p_&&(this.p_.cancel(),this.p_=null)}}class th{constructor(e,t,n,i,r){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.v_=[],this.F_=new Map,this.M_=new Set,this.x_=[],this.O_=r,this.O_.io((e=>{n.enqueueAndForget((async()=>{dh(this)&&(js("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=zs(e);t.M_.add(4),await ih(t),t.N_.set("Unknown"),t.M_.delete(4),await nh(t)}(this))}))})),this.N_=new eh(n,i)}}async function nh(e){if(dh(e))for(const t of e.x_)await t(!0)}async function ih(e){for(const t of e.x_)await t(!1)}function rh(e,t){const n=zs(e);n.F_.has(t.targetId)||(n.F_.set(t.targetId,t),lh(n)?ch(n):Oh(n).Xo()&&sh(n,t))}function oh(e,t){const n=zs(e),i=Oh(n);n.F_.delete(t),i.Xo()&&ah(n,t),0===n.F_.size&&(i.Xo()?i.n_():dh(n)&&n.N_.set("Unknown"))}function sh(e,t){if(e.L_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(la.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}Oh(e).P_(t)}function ah(e,t){e.L_.xe(t),Oh(e).I_(t)}function ch(e){e.L_=new Sd({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>e.F_.get(t)||null,tt:()=>e.datastore.serializer.databaseId}),Oh(e).start(),e.N_.w_()}function lh(e){return dh(e)&&!Oh(e).Zo()&&e.F_.size>0}function dh(e){return 0===zs(e).M_.size}function uh(e){e.L_=void 0}async function hh(e){e.N_.set("Online")}async function ph(e){e.F_.forEach(((t,n)=>{sh(e,t)}))}async function fh(e,t){uh(e),lh(e)?(e.N_.D_(t),ch(e)):e.N_.set("Unknown")}async function mh(e,t,n){if(e.N_.set("Online"),t instanceof vd&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const i of t.targetIds)e.F_.has(i)&&(await e.remoteSyncer.rejectListen(i,n),e.F_.delete(i),e.L_.removeTarget(i))}(e,t)}catch(n){js("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await _h(e,n)}else if(t instanceof Ed?e.L_.Ke(t):t instanceof gd?e.L_.He(t):e.L_.We(t),!n.isEqual(la.min()))try{const t=await Nu(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.L_.rt(t);return n.targetChanges.forEach(((n,i)=>{if(n.resumeToken.approximateByteSize()>0){const r=e.F_.get(i);r&&e.F_.set(i,r.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const i=e.F_.get(t);if(!i)return;e.F_.set(t,i.withResumeToken(Wa.EMPTY_BYTE_STRING,i.snapshotVersion)),ah(e,t);const r=new nu(i.target,t,n,i.sequenceNumber);sh(e,r)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){js("RemoteStore","Failed to raise snapshot:",t),await _h(e,t)}}async function _h(e,t,n){if(!wa(t))throw t;e.M_.add(1),await ih(e),e.N_.set("Offline"),n||(n=()=>Nu(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{js("RemoteStore","Retrying IndexedDB access"),await n(),e.M_.delete(1),await nh(e)}))}function Eh(e,t){return t().catch((n=>_h(e,n,t)))}async function gh(e){const t=zs(e),n=Nh(t);let i=t.v_.length>0?t.v_[t.v_.length-1].batchId:-1;for(;vh(t);)try{const e=await Pu(t.localStore,i);if(null===e){0===t.v_.length&&n.n_();break}i=e.batchId,Th(t,e)}catch(e){await _h(t,e)}Sh(t)&&yh(t)}function vh(e){return dh(e)&&e.v_.length<10}function Th(e,t){e.v_.push(t);const n=Nh(e);n.Xo()&&n.E_&&n.d_(t.mutations)}function Sh(e){return dh(e)&&!Nh(e).Zo()&&e.v_.length>0}function yh(e){Nh(e).start()}async function Ch(e){Nh(e).V_()}async function Rh(e){const t=Nh(e);for(const n of e.v_)t.d_(n.mutations)}async function wh(e,t,n){const i=e.v_.shift(),r=td.from(i,t,n);await Eh(e,(()=>e.remoteSyncer.applySuccessfulWrite(r))),await gh(e)}async function Ih(e,t){t&&Nh(e).E_&&await async function(e,t){if(function(e){return sd(e)&&e!==qs.ABORTED}(t.code)){const n=e.v_.shift();Nh(e).t_(),await Eh(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await gh(e)}}(e,t),Sh(e)&&yh(e)}async function bh(e,t){const n=zs(e);n.asyncQueue.verifyOperationInProgress(),js("RemoteStore","RemoteStore received new credentials");const i=dh(n);n.M_.add(3),await ih(n),i&&n.N_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.M_.delete(3),await nh(n)}async function Ah(e,t){const n=zs(e);t?(n.M_.delete(2),await nh(n)):t||(n.M_.add(2),await ih(n),n.N_.set("Unknown"))}function Oh(e){return e.B_||(e.B_=function(e,t,n){const i=zs(e);return i.f_(),new Qu(t,i.connection,i.authCredentials,i.appCheckCredentials,i.serializer,n)}(e.datastore,e.asyncQueue,{Po:hh.bind(null,e),To:ph.bind(null,e),Ao:fh.bind(null,e),h_:mh.bind(null,e)}),e.x_.push((async t=>{t?(e.B_.t_(),lh(e)?ch(e):e.N_.set("Unknown")):(await e.B_.stop(),uh(e))}))),e.B_}function Nh(e){return e.k_||(e.k_=function(e,t,n){const i=zs(e);return i.f_(),new Zu(t,i.connection,i.authCredentials,i.appCheckCredentials,i.serializer,n)}(e.datastore,e.asyncQueue,{Po:()=>Promise.resolve(),To:Ch.bind(null,e),Ao:Ih.bind(null,e),R_:Rh.bind(null,e),A_:wh.bind(null,e)}),e.x_.push((async t=>{t?(e.k_.t_(),await gh(e)):(await e.k_.stop(),e.v_.length>0&&(js("RemoteStore","Stopping write stream with ".concat(e.v_.length," pending writes")),e.v_=[]))}))),e.k_}class Dh{constructor(e,t,n,i,r){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=i,this.removalCallback=r,this.deferred=new Js,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,i,r){const o=Date.now()+n,s=new Dh(e,t,o,i,r);return s.start(n),s}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Ys(qs.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ph(e,t){if(Bs("AsyncQueue","".concat(t,": ").concat(e)),wa(e))return new Ys(qs.UNAVAILABLE,"".concat(t,": ").concat(e));throw e}class kh{constructor(e){this.comparator=e?(t,n)=>e(t,n)||fa.comparator(t.key,n.key):(e,t)=>fa.comparator(e.key,t.key),this.keyedMap=hl(),this.sortedSet=new Ua(this.comparator)}static emptySet(e){return new kh(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof kh))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,i=n.getNext().key;if(!e.isEqual(i))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new kh;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Lh{constructor(){this.q_=new Ua(fa.comparator)}track(e){const t=e.doc.key,n=this.q_.get(t);n?0!==e.type&&3===n.type?this.q_=this.q_.insert(t,e):3===e.type&&1!==n.type?this.q_=this.q_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.q_=this.q_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.q_=this.q_.remove(t):1===e.type&&2===n.type?this.q_=this.q_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.q_=this.q_.insert(t,{type:2,doc:e.doc}):Hs():this.q_=this.q_.insert(t,e)}Q_(){const e=[];return this.q_.inorderTraversal(((t,n)=>{e.push(n)})),e}}class Mh{constructor(e,t,n,i,r,o,s,a,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=i,this.mutatedKeys=r,this.fromCache=o,this.syncStateChanged=s,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,i,r){const o=[];return t.forEach((e=>{o.push({type:0,doc:e})})),new Mh(e,t,kh.emptySet(t),o,n,i,!0,!1,r)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&tl(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let i=0;i<t.length;i++)if(t[i].type!==n[i].type||!t[i].doc.isEqual(n[i].doc))return!1;return!0}}class Uh{constructor(){this.K_=void 0,this.U_=[]}W_(){return this.U_.some((e=>e.G_()))}}class xh{constructor(){this.queries=new cl((e=>nl(e)),tl),this.onlineState="Unknown",this.z_=new Set}}async function Vh(e,t){const n=zs(e);let i=3;const r=t.query;let o=n.queries.get(r);o?!o.W_()&&t.G_()&&(i=2):(o=new Uh,i=t.G_()?0:1);try{switch(i){case 0:o.K_=await n.onListen(r,!0);break;case 1:o.K_=await n.onListen(r,!1);break;case 2:await n.onFirstRemoteStoreListen(r)}}catch(e){const n=Ph(e,"Initialization of query '".concat(il(t.query),"' failed"));return void t.onError(n)}n.queries.set(r,o),o.U_.push(t),t.j_(n.onlineState),o.K_&&t.H_(o.K_)&&Gh(n)}async function Fh(e,t){const n=zs(e),i=t.query;let r=3;const o=n.queries.get(i);if(o){const e=o.U_.indexOf(t);e>=0&&(o.U_.splice(e,1),0===o.U_.length?r=t.G_()?0:1:!o.W_()&&t.G_()&&(r=2))}switch(r){case 0:return n.queries.delete(i),n.onUnlisten(i,!0);case 1:return n.queries.delete(i),n.onUnlisten(i,!1);case 2:return n.onLastRemoteStoreUnlisten(i);default:return}}function jh(e,t){const n=zs(e);let i=!1;for(const r of t){const e=r.query,t=n.queries.get(e);if(t){for(const e of t.U_)e.H_(r)&&(i=!0);t.K_=r}}i&&Gh(n)}function Bh(e,t,n){const i=zs(e),r=i.queries.get(t);if(r)for(const o of r.U_)o.onError(n);i.queries.delete(t)}function Gh(e){e.z_.forEach((e=>{e.next()}))}var Wh,Hh;(Hh=Wh||(Wh={})).J_="default",Hh.Cache="cache";class Kh{constructor(e,t,n){this.query=e,this.Y_=t,this.Z_=!1,this.X_=null,this.onlineState="Unknown",this.options=n||{}}H_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Mh(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Z_?this.ea(e)&&(this.Y_.next(e),t=!0):this.ta(e,this.onlineState)&&(this.na(e),t=!0),this.X_=e,t}onError(e){this.Y_.error(e)}j_(e){this.onlineState=e;let t=!1;return this.X_&&!this.Z_&&this.ta(this.X_,e)&&(this.na(this.X_),t=!0),t}ta(e,t){if(!e.fromCache)return!0;if(!this.G_())return!0;const n="Offline"!==t;return(!this.options.ra||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ea(e){if(e.docChanges.length>0)return!0;const t=this.X_&&this.X_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}na(e){e=Mh.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Z_=!0,this.Y_.next(e)}G_(){return this.options.source!==Wh.Cache}}class zh{constructor(e){this.key=e}}class qh{constructor(e){this.key=e}}class Yh{constructor(e,t){this.query=e,this.la=t,this.ha=null,this.hasCachedResults=!1,this.current=!1,this.Pa=vl(),this.mutatedKeys=vl(),this.Ia=sl(e),this.Ta=new kh(this.Ia)}get Ea(){return this.la}da(e,t){const n=t?t.Aa:new Lh,i=t?t.Ta:this.Ta;let r=t?t.mutatedKeys:this.mutatedKeys,o=i,s=!1;const a="F"===this.query.limitType&&i.size===this.query.limit?i.last():null,c="L"===this.query.limitType&&i.size===this.query.limit?i.first():null;if(e.inorderTraversal(((e,t)=>{const l=i.get(e),d=rl(this.query,t)?t:null,u=!!l&&this.mutatedKeys.has(l.key),h=!!d&&(d.hasLocalMutations||this.mutatedKeys.has(d.key)&&d.hasCommittedMutations);let p=!1;l&&d?l.data.isEqual(d.data)?u!==h&&(n.track({type:3,doc:d}),p=!0):this.Ra(l,d)||(n.track({type:2,doc:d}),p=!0,(a&&this.Ia(d,a)>0||c&&this.Ia(d,c)<0)&&(s=!0)):!l&&d?(n.track({type:0,doc:d}),p=!0):l&&!d&&(n.track({type:1,doc:l}),p=!0,(a||c)&&(s=!0)),p&&(d?(o=o.add(d),r=h?r.add(e):r.delete(e)):(o=o.delete(e),r=r.delete(e)))})),null!==this.query.limit)for(;o.size>this.query.limit;){const e="F"===this.query.limitType?o.last():o.first();o=o.delete(e.key),r=r.delete(e.key),n.track({type:1,doc:e})}return{Ta:o,Aa:n,Xi:s,mutatedKeys:r}}Ra(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,i){const r=this.Ta;this.Ta=e.Ta,this.mutatedKeys=e.mutatedKeys;const o=e.Aa.Q_();o.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Hs()}};return n(e)-n(t)}(e.type,t.type)||this.Ia(e.doc,t.doc))),this.Va(n),i=null!=i&&i;const s=t&&!i?this.ma():[],a=0===this.Pa.size&&this.current&&!i?1:0,c=a!==this.ha;return this.ha=a,0!==o.length||c?{snapshot:new Mh(this.query,e.Ta,r,o,e.mutatedKeys,0===a,c,!1,!!n&&n.resumeToken.approximateByteSize()>0),fa:s}:{fa:s}}j_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ta:this.Ta,Aa:new Lh,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{fa:[]}}ga(e){return!this.la.has(e)&&!!this.Ta.has(e)&&!this.Ta.get(e).hasLocalMutations}Va(e){e&&(e.addedDocuments.forEach((e=>this.la=this.la.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.la=this.la.delete(e))),this.current=e.current)}ma(){if(!this.current)return[];const e=this.Pa;this.Pa=vl(),this.Ta.forEach((e=>{this.ga(e.key)&&(this.Pa=this.Pa.add(e.key))}));const t=[];return e.forEach((e=>{this.Pa.has(e)||t.push(new qh(e))})),this.Pa.forEach((n=>{e.has(n)||t.push(new zh(n))})),t}pa(e){this.la=e.hs,this.Pa=vl();const t=this.da(e.documents);return this.applyChanges(t,!0)}ya(){return Mh.fromInitialDocuments(this.query,this.Ta,this.mutatedKeys,0===this.ha,this.hasCachedResults)}}class Jh{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Xh{constructor(e){this.key=e,this.wa=!1}}class Qh{constructor(e,t,n,i,r,o){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=i,this.currentUser=r,this.maxConcurrentLimboResolutions=o,this.Sa={},this.ba=new cl((e=>nl(e)),tl),this.Da=new Map,this.Ca=new Set,this.va=new Ua(fa.comparator),this.Fa=new Map,this.Ma=new mu,this.xa={},this.Oa=new Map,this.Na=lu.Ln(),this.onlineState="Unknown",this.La=void 0}get isPrimaryClient(){return!0===this.La}}async function Zh(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i=vp(e);let r;const o=i.ba.get(t);return o?(i.sharedClientState.addLocalQueryTarget(o.targetId),r=o.view.ya()):r=await ep(i,t,n,!0),r}async function $h(e,t){const n=vp(e);await ep(n,t,!0,!1)}async function ep(e,t,n,i){const r=await ku(e.localStore,Qc(t)),o=r.targetId,s=n?e.sharedClientState.addLocalQueryTarget(o):"not-current";let a;return i&&(a=await tp(e,t,o,"current"===s,r.resumeToken)),e.isPrimaryClient&&n&&rh(e.remoteStore,r),a}async function tp(e,t,n,i,r){e.Ba=(t,n,i)=>async function(e,t,n,i){let r=t.view.da(n);r.Xi&&(r=await Mu(e.localStore,t.query,!1).then((e=>{let{documents:n}=e;return t.view.da(n,r)})));const o=i&&i.targetChanges.get(t.targetId),s=i&&null!=i.targetMismatches.get(t.targetId),a=t.view.applyChanges(r,e.isPrimaryClient,o,s);return pp(e,t.targetId,a.fa),a.snapshot}(e,t,n,i);const o=await Mu(e.localStore,t,!0),s=new Yh(t,o.hs),a=s.da(o.documents),c=_d.createSynthesizedTargetChangeForCurrentChange(n,i&&"Offline"!==e.onlineState,r),l=s.applyChanges(a,e.isPrimaryClient,c);pp(e,n,l.fa);const d=new Jh(t,n,s);return e.ba.set(t,d),e.Da.has(n)?e.Da.get(n).push(t):e.Da.set(n,[t]),l.snapshot}async function np(e,t,n){const i=zs(e),r=i.ba.get(t),o=i.Da.get(r.targetId);if(o.length>1)return i.Da.set(r.targetId,o.filter((e=>!tl(e,t)))),void i.ba.delete(t);i.isPrimaryClient?(i.sharedClientState.removeLocalQueryTarget(r.targetId),i.sharedClientState.isActiveQueryTarget(r.targetId)||await Lu(i.localStore,r.targetId,!1).then((()=>{i.sharedClientState.clearQueryState(r.targetId),n&&oh(i.remoteStore,r.targetId),up(i,r.targetId)})).catch(ya)):(up(i,r.targetId),await Lu(i.localStore,r.targetId,!0))}async function ip(e,t){const n=zs(e),i=n.ba.get(t),r=n.Da.get(i.targetId);n.isPrimaryClient&&1===r.length&&(n.sharedClientState.removeLocalQueryTarget(i.targetId),oh(n.remoteStore,i.targetId))}async function rp(e,t){const n=zs(e);try{const e=await function(e,t){const n=zs(e),i=t.snapshotVersion;let r=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const o=n.os.newChangeBuffer({trackRemovals:!0});r=n.ns;const s=[];t.targetChanges.forEach(((o,a)=>{const c=r.get(a);if(!c)return;s.push(n.Qr.removeMatchingKeys(e,o.removedDocuments,a).next((()=>n.Qr.addMatchingKeys(e,o.addedDocuments,a))));let l=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?l=l.withResumeToken(Wa.EMPTY_BYTE_STRING,la.min()).withLastLimboFreeSnapshotVersion(la.min()):o.resumeToken.approximateByteSize()>0&&(l=l.withResumeToken(o.resumeToken,i)),r=r.insert(a,l),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,l,o)&&s.push(n.Qr.updateTargetData(e,l))}));let a=dl(),c=vl();if(t.documentUpdates.forEach((i=>{t.resolvedLimboDocuments.has(i)&&s.push(n.persistence.referenceDelegate.updateLimboDocument(e,i))})),s.push(Du(e,o,t.documentUpdates).next((e=>{a=e.cs,c=e.ls}))),!i.isEqual(la.min())){const t=n.Qr.getLastRemoteSnapshotVersion(e).next((t=>n.Qr.setTargetsMetadata(e,e.currentSequenceNumber,i)));s.push(t)}return Ca.waitFor(s).next((()=>o.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,c))).next((()=>a))})).then((e=>(n.ns=r,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const i=n.Fa.get(t);i&&(Ks(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?i.wa=!0:e.modifiedDocuments.size>0?Ks(i.wa):e.removedDocuments.size>0&&(Ks(i.wa),i.wa=!1))})),await _p(n,e,t)}catch(e){await ya(e)}}function op(e,t,n){const i=zs(e);if(i.isPrimaryClient&&0===n||!i.isPrimaryClient&&1===n){const e=[];i.ba.forEach(((n,i)=>{const r=i.view.j_(t);r.snapshot&&e.push(r.snapshot)})),function(e,t){const n=zs(e);n.onlineState=t;let i=!1;n.queries.forEach(((e,n)=>{for(const r of n.U_)r.j_(t)&&(i=!0)})),i&&Gh(n)}(i.eventManager,t),e.length&&i.Sa.h_(e),i.onlineState=t,i.isPrimaryClient&&i.sharedClientState.setOnlineState(t)}}async function sp(e,t,n){const i=zs(e);i.sharedClientState.updateQueryState(t,"rejected",n);const r=i.Fa.get(t),o=r&&r.key;if(o){let e=new Ua(fa.comparator);e=e.insert(o,Ec.newNoDocument(o,la.min()));const n=vl().add(o),r=new md(la.min(),new Map,new Ua(sa),e,n);await rp(i,r),i.va=i.va.remove(o),i.Fa.delete(t),mp(i)}else await Lu(i.localStore,t,!1).then((()=>up(i,t,n))).catch(ya)}async function ap(e,t){const n=zs(e),i=t.batch.batchId;try{const e=await function(e,t){const n=zs(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const i=t.batch.keys(),r=n.os.newChangeBuffer({trackRemovals:!0});return function(e,t,n,i){const r=n.batch,o=r.keys();let s=Ca.resolve();return o.forEach((e=>{s=s.next((()=>i.getEntry(t,e))).next((t=>{const o=n.docVersions.get(e);Ks(null!==o),t.version.compareTo(o)<0&&(r.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),i.addEntry(t)))}))})),s.next((()=>e.mutationQueue.removeMutationBatch(t,r)))}(n,e,t,r).next((()=>r.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,i,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=vl();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,i)))}))}(n.localStore,t);dp(n,i,null),lp(n,i),n.sharedClientState.updateMutationState(i,"acknowledged"),await _p(n,e)}catch(e){await ya(e)}}async function cp(e,t,n){const i=zs(e);try{const e=await function(e,t){const n=zs(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let i;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(Ks(null!==t),i=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,i,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,i))).next((()=>n.localDocuments.getDocuments(e,i)))}))}(i.localStore,t);dp(i,t,n),lp(i,t),i.sharedClientState.updateMutationState(t,"rejected",n),await _p(i,e)}catch(n){await ya(n)}}function lp(e,t){(e.Oa.get(t)||[]).forEach((e=>{e.resolve()})),e.Oa.delete(t)}function dp(e,t,n){const i=zs(e);let r=i.xa[i.currentUser.toKey()];if(r){const e=r.get(t);e&&(n?e.reject(n):e.resolve(),r=r.remove(t)),i.xa[i.currentUser.toKey()]=r}}function up(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;e.sharedClientState.removeLocalQueryTarget(t);for(const i of e.Da.get(t))e.ba.delete(i),n&&e.Sa.ka(i,n);e.Da.delete(t),e.isPrimaryClient&&e.Ma.Vr(t).forEach((t=>{e.Ma.containsKey(t)||hp(e,t)}))}function hp(e,t){e.Ca.delete(t.path.canonicalString());const n=e.va.get(t);null!==n&&(oh(e.remoteStore,n),e.va=e.va.remove(t),e.Fa.delete(n),mp(e))}function pp(e,t,n){for(const i of n)i instanceof zh?(e.Ma.addReference(i.key,t),fp(e,i)):i instanceof qh?(js("SyncEngine","Document no longer in limbo: "+i.key),e.Ma.removeReference(i.key,t),e.Ma.containsKey(i.key)||hp(e,i.key)):Hs()}function fp(e,t){const n=t.key,i=n.path.canonicalString();e.va.get(n)||e.Ca.has(i)||(js("SyncEngine","New document in limbo: "+n),e.Ca.add(i),mp(e))}function mp(e){for(;e.Ca.size>0&&e.va.size<e.maxConcurrentLimboResolutions;){const t=e.Ca.values().next().value;e.Ca.delete(t);const n=new fa(ua.fromString(t)),i=e.Na.next();e.Fa.set(i,new Xh(n)),e.va=e.va.insert(n,i),rh(e.remoteStore,new nu(Qc(qc(n.path)),i,"TargetPurposeLimboResolution",Ia.oe))}}async function _p(e,t,n){const i=zs(e),r=[],o=[],s=[];i.ba.isEmpty()||(i.ba.forEach(((e,a)=>{s.push(i.Ba(a,t,n).then((e=>{if((e||n)&&i.isPrimaryClient){const t=e&&!e.fromCache;i.sharedClientState.updateQueryState(a.targetId,t?"current":"not-current")}if(e){r.push(e);const t=Ru.Ki(a.targetId,e);o.push(t)}})))})),await Promise.all(s),i.Sa.h_(r),await async function(e,t){const n=zs(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>Ca.forEach(t,(t=>Ca.forEach(t.qi,(i=>n.persistence.referenceDelegate.addReference(e,t.targetId,i))).next((()=>Ca.forEach(t.Qi,(i=>n.persistence.referenceDelegate.removeReference(e,t.targetId,i)))))))))}catch(e){if(!wa(e))throw e;js("LocalStore","Failed to update sequence numbers: "+e)}for(const i of t){const e=i.targetId;if(!i.fromCache){const t=n.ns.get(e),i=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(i);n.ns=n.ns.insert(e,r)}}}(i.localStore,o))}async function Ep(e,t){const n=zs(e);if(!n.currentUser.isEqual(t)){js("SyncEngine","User change. New user:",t.toKey());const e=await Ou(n.localStore,t);n.currentUser=t,function(e,t){e.Oa.forEach((e=>{e.forEach((e=>{e.reject(new Ys(qs.CANCELLED,t))}))})),e.Oa.clear()}(n,"'waitForPendingWrites' promise is rejected due to a user change."),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await _p(n,e.us)}}function gp(e,t){const n=zs(e),i=n.Fa.get(t);if(i&&i.wa)return vl().add(i.key);{let e=vl();const i=n.Da.get(t);if(!i)return e;for(const t of i){const i=n.ba.get(t);e=e.unionWith(i.view.Ea)}return e}}function vp(e){const t=zs(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=rp.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=gp.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=sp.bind(null,t),t.Sa.h_=jh.bind(null,t.eventManager),t.Sa.ka=Bh.bind(null,t.eventManager),t}function Tp(e){const t=zs(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=ap.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=cp.bind(null,t),t}class Sp{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Yu(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Au(this.persistence,new Iu,e.initialUser,this.serializer)}createPersistence(e){return new Su(Cu.Hr,this.serializer)}createSharedClientState(e){return new Vu}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class yp{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>op(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Ep.bind(null,this.syncEngine),await Ah(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new xh}createDatastore(e){const t=Yu(e.databaseInfo.databaseId),n=function(e){return new zu(e)}(e.databaseInfo);return function(e,t,n,i){return new $u(e,t,n,i)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function(e,t,n,i,r){return new th(e,t,n,i,r)}(this.localStore,this.datastore,e.asyncQueue,(e=>op(this.syncEngine,e,0)),ju.D()?new ju:new Fu)}createSyncEngine(e,t){return function(e,t,n,i,r,o,s){const a=new Qh(e,t,n,i,r,o);return s&&(a.La=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e;await async function(e){const t=zs(e);js("RemoteStore","RemoteStore shutting down."),t.M_.add(5),await ih(t),t.O_.shutdown(),t.N_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate()}}class Cp{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ka(this.observer.next,e)}error(e){this.observer.error?this.Ka(this.observer.error,e):Bs("Uncaught Error in snapshot listener:",e.toString())}$a(){this.muted=!0}Ka(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Rp{constructor(e,t,n,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=i,this.user=Us.UNAUTHENTICATED,this.clientId=oa.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{js("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(js("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Ys(qs.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new Js;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Ph(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function wp(e,t){e.asyncQueue.verifyOperationInProgress(),js("FirestoreClient","Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let i=n.initialUser;e.setCredentialChangeListener((async e=>{i.isEqual(e)||(await Ou(t.localStore,e),i=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function Ip(e,t){e.asyncQueue.verifyOperationInProgress();const n=await Ap(e);js("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener((e=>bh(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>bh(t.remoteStore,n))),e._onlineComponents=t}function bp(e){return"FirebaseError"===e.name?e.code===qs.FAILED_PRECONDITION||e.code===qs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Ap(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){js("FirestoreClient","Using user provided OfflineComponentProvider");try{await wp(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!bp(n))throw n;Gs("Error using user provided cache. Falling back to memory cache: "+n),await wp(e,new Sp)}}else js("FirestoreClient","Using default OfflineComponentProvider"),await wp(e,new Sp);return e._offlineComponents}async function Op(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(js("FirestoreClient","Using user provided OnlineComponentProvider"),await Ip(e,e._uninitializedComponentsProvider._online)):(js("FirestoreClient","Using default OnlineComponentProvider"),await Ip(e,new yp))),e._onlineComponents}function Np(e){return Op(e).then((e=>e.syncEngine))}async function Dp(e){const t=await Op(e),n=t.eventManager;return n.onListen=Zh.bind(null,t.syncEngine),n.onUnlisten=np.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=$h.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=ip.bind(null,t.syncEngine),n}function Pp(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=new Js;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,i,r){const o=new Cp({next:o=>{t.enqueueAndForget((()=>Fh(e,s)));const a=o.docs.has(n);!a&&o.fromCache?r.reject(new Ys(qs.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&o.fromCache&&i&&"server"===i.source?r.reject(new Ys(qs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(o)},error:e=>r.reject(e)}),s=new Kh(qc(n.path),o,{includeMetadataChanges:!0,ra:!0});return Vh(e,s)}(await Dp(e),e.asyncQueue,t,n,i))),i.promise}function kp(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=new Js;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,i,r){const o=new Cp({next:n=>{t.enqueueAndForget((()=>Fh(e,s))),n.fromCache&&"server"===i.source?r.reject(new Ys(qs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:e=>r.reject(e)}),s=new Kh(n,o,{includeMetadataChanges:!0,ra:!0});return Vh(e,s)}(await Dp(e),e.asyncQueue,t,n,i))),i.promise}function Lp(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const Mp=new Map;function Up(e,t,n){if(!n)throw new Ys(qs.INVALID_ARGUMENT,"Function ".concat(e,"() cannot be called with an empty ").concat(t,"."))}function xp(e){if(!fa.isDocumentKey(e))throw new Ys(qs.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but ".concat(e," has ").concat(e.length,"."))}function Vp(e){if(fa.isDocumentKey(e))throw new Ys(qs.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but ".concat(e," has ").concat(e.length,"."))}function Fp(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e="".concat(e.substring(0,20),"...")),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?"a custom ".concat(t," object"):"an object"}}return"function"==typeof e?"a function":Hs()}function jp(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new Ys(qs.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Fp(e);throw new Ys(qs.INVALID_ARGUMENT,"Expected type '".concat(t.name,"', but it was: ").concat(n))}}return e}class Bp{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new Ys(qs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Ys(qs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,i){if(!0===t&&!0===i)throw new Ys(qs.INVALID_ARGUMENT,"".concat(e," and ").concat(n," cannot be used together."))})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Lp(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new Ys(qs.INVALID_ARGUMENT,"invalid long polling timeout: ".concat(e.timeoutSeconds," (must not be NaN)"));if(e.timeoutSeconds<5)throw new Ys(qs.INVALID_ARGUMENT,"invalid long polling timeout: ".concat(e.timeoutSeconds," (minimum allowed value is 5)"));if(e.timeoutSeconds>30)throw new Ys(qs.INVALID_ARGUMENT,"invalid long polling timeout: ".concat(e.timeoutSeconds," (maximum allowed value is 30)"))}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Gp{constructor(e,t,n,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Bp({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Ys(qs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Ys(qs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Bp(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Qs;switch(e.type){case"firstParty":return new ta(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new Ys(qs.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Mp.get(e);t&&(js("ComponentProvider","Removing Datastore"),Mp.delete(e),t.terminate())}(this),Promise.resolve()}}class Wp{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Wp(this.firestore,e,this._query)}}class Hp{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Kp(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Hp(this.firestore,e,this._key)}}class Kp extends Wp{constructor(e,t,n){super(e,t,qc(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Hp(this.firestore,null,new fa(e))}withConverter(e){return new Kp(this.firestore,e,this._path)}}function zp(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];if(e=et(e),1===arguments.length&&(t=oa.newId()),Up("doc","path",t),e instanceof Gp){const n=ua.fromString(t,...i);return xp(n),new Hp(e,null,new fa(n))}{if(!(e instanceof Hp||e instanceof Kp))throw new Ys(qs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const n=e._path.child(ua.fromString(t,...i));return xp(n),new Hp(e.firestore,e instanceof Kp?e.converter:null,new fa(n))}}class qp{constructor(){this.iu=Promise.resolve(),this.su=[],this.ou=!1,this._u=[],this.au=null,this.uu=!1,this.cu=!1,this.lu=[],this.Yo=new Ju(this,"async_queue_retry"),this.hu=()=>{const e=qu();e&&js("AsyncQueue","Visibility state changed to "+e.visibilityState),this.Yo.Wo()};const e=qu();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.hu)}get isShuttingDown(){return this.ou}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Pu(),this.Iu(e)}enterRestrictedMode(e){if(!this.ou){this.ou=!0,this.cu=e||!1;const t=qu();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.hu)}}enqueue(e){if(this.Pu(),this.ou)return new Promise((()=>{}));const t=new Js;return this.Iu((()=>this.ou&&this.cu?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.su.push(e),this.Tu())))}async Tu(){if(0!==this.su.length){try{await this.su[0](),this.su.shift(),this.Yo.reset()}catch(Dm){if(!wa(Dm))throw Dm;js("AsyncQueue","Operation failed with retryable error: "+Dm)}this.su.length>0&&this.Yo.$o((()=>this.Tu()))}}Iu(e){const t=this.iu.then((()=>(this.uu=!0,e().catch((e=>{this.au=e,this.uu=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw Bs("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.uu=!1,e))))));return this.iu=t,t}enqueueAfterDelay(e,t,n){this.Pu(),this.lu.indexOf(e)>-1&&(t=0);const i=Dh.createAndSchedule(this,e,t,n,(e=>this.Eu(e)));return this._u.push(i),i}Pu(){this.au&&Hs()}verifyOperationInProgress(){}async du(){let e;do{e=this.iu,await e}while(e!==this.iu)}Au(e){for(const t of this._u)if(t.timerId===e)return!0;return!1}Ru(e){return this.du().then((()=>{this._u.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this._u)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.du()}))}Vu(e){this.lu.push(e)}Eu(e){const t=this._u.indexOf(e);this._u.splice(t,1)}}function Yp(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const i of t)if(i in n&&"function"==typeof n[i])return!0;return!1}(e,["next","error","complete"])}class Jp extends Gp{constructor(e,t,n,i){super(e,t,n,i),this.type="firestore",this._queue=new qp,this._persistenceKey=(null==i?void 0:i.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Qp(this),this._firestoreClient.terminate()}}function Xp(e){return e._firestoreClient||Qp(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Qp(e){var t,n,i;const r=e._freezeSettings(),o=function(e,t,n,i){return new Qa(e,t,n,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,Lp(i.experimentalLongPollingOptions),i.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,r);e._firestoreClient=new Rp(e._authCredentials,e._appCheckCredentials,e._queue,o),(null===(n=r.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(i=r.localCache)||void 0===i?void 0:i._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:r.localCache.kind,_offline:r.localCache._offlineComponentProvider,_online:r.localCache._onlineComponentProvider})}class Zp{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Zp(Wa.fromBase64String(e))}catch(e){throw new Ys(qs.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Zp(Wa.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class $p{constructor(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(let i=0;i<t.length;++i)if(0===t[i].length)throw new Ys(qs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new pa(t)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class ef{constructor(e){this._methodName=e}}class tf{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new Ys(qs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new Ys(qs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return sa(this._lat,e._lat)||sa(this._long,e._long)}}const nf=/^__.*__$/;class rf{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Yl(e,this.data,this.fieldMask,t,this.fieldTransforms):new ql(e,this.data,t,this.fieldTransforms)}}class of{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Yl(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function sf(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Hs()}}class af{constructor(e,t,n,i,r,o){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=i,void 0===r&&this.mu(),this.fieldTransforms=r||[],this.fieldMask=o||[]}get path(){return this.settings.path}get fu(){return this.settings.fu}gu(e){return new af(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}pu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),i=this.gu({path:n,yu:!1});return i.wu(e),i}Su(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),i=this.gu({path:n,yu:!1});return i.mu(),i}bu(e){return this.gu({path:void 0,yu:!0})}Du(e){return wf(e,this.settings.methodName,this.settings.Cu||!1,this.path,this.settings.vu)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}mu(){if(this.path)for(let e=0;e<this.path.length;e++)this.wu(this.path.get(e))}wu(e){if(0===e.length)throw this.Du("Document fields must not be empty");if(sf(this.fu)&&nf.test(e))throw this.Du('Document fields cannot begin and end with "__"')}}class cf{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Yu(e)}Fu(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new af({fu:e,methodName:t,vu:n,path:pa.emptyPath(),yu:!1,Cu:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function lf(e){const t=e._freezeSettings(),n=Yu(e._databaseId);return new cf(e._databaseId,!!t.ignoreUndefinedProperties,n)}function df(e,t,n,i,r){let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const s=e.Fu(o.merge||o.mergeFields?2:0,t,n,r);Sf("Data must be an object, but it was:",s,i);const a=vf(i,s);let c,l;if(o.merge)c=new Ba(s.fieldMask),l=s.fieldTransforms;else if(o.mergeFields){const e=[];for(const i of o.mergeFields){const r=yf(t,i,n);if(!s.contains(r))throw new Ys(qs.INVALID_ARGUMENT,"Field '".concat(r,"' is specified in your field mask but missing from your input data."));If(e,r)||e.push(r)}c=new Ba(e),l=s.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,l=s.fieldTransforms;return new rf(new mc(a),c,l)}class uf extends ef{_toFieldTransform(e){if(2!==e.fu)throw 1===e.fu?e.Du("".concat(this._methodName,"() can only appear at the top level of your update data")):e.Du("".concat(this._methodName,"() cannot be used with set() unless you pass {merge:true}"));return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof uf}}function hf(e,t,n){return new af({fu:3,vu:t.settings.vu,methodName:e._methodName,yu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class pf extends ef{_toFieldTransform(e){return new xl(e.path,new Ol)}isEqual(e){return e instanceof pf}}class ff extends ef{constructor(e,t){super(e),this.Mu=t}_toFieldTransform(e){const t=hf(this,e,!0),n=this.Mu.map((e=>gf(e,t))),i=new Nl(n);return new xl(e.path,i)}isEqual(e){return e instanceof ff&&qe(this.Mu,e.Mu)}}function mf(e,t,n,i){const r=e.Fu(1,t,n);Sf("Data must be an object, but it was:",r,i);const o=[],s=mc.empty();La(i,((e,i)=>{const a=Rf(t,e,n);i=et(i);const c=r.Su(a);if(i instanceof uf)o.push(a);else{const e=gf(i,c);null!=e&&(o.push(a),s.set(a,e))}}));const a=new Ba(o);return new of(s,a,r.fieldTransforms)}function _f(e,t,n,i,r,o){const s=e.Fu(1,t,n),a=[yf(t,i,n)],c=[r];if(o.length%2!=0)throw new Ys(qs.INVALID_ARGUMENT,"Function ".concat(t,"() needs to be called with an even number of arguments that alternate between field names and values."));for(let h=0;h<o.length;h+=2)a.push(yf(t,o[h])),c.push(o[h+1]);const l=[],d=mc.empty();for(let h=a.length-1;h>=0;--h)if(!If(l,a[h])){const e=a[h];let t=c[h];t=et(t);const n=s.Su(e);if(t instanceof uf)l.push(e);else{const i=gf(t,n);null!=i&&(l.push(e),d.set(e,i))}}const u=new Ba(l);return new of(d,u,s.fieldTransforms)}function Ef(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return gf(n,e.Fu(i?4:3,t))}function gf(e,t){if(Tf(e=et(e)))return Sf("Unsupported field value:",t,e),vf(e,t);if(e instanceof ef)return function(e,t){if(!sf(t.fu))throw t.Du("".concat(e._methodName,"() can only be used with update() and set()"));if(!t.path)throw t.Du("".concat(e._methodName,"() is not currently supported inside arrays"));const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.yu&&4!==t.fu)throw t.Du("Nested arrays are not supported");return function(e,t){const n=[];let i=0;for(const r of e){let e=gf(r,t.bu(i));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),i++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=et(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Rl(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=ca.fromDate(e);return{timestampValue:Od(t.serializer,n)}}if(e instanceof ca){const n=new ca(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:Od(t.serializer,n)}}if(e instanceof tf)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Zp)return{bytesValue:Nd(t.serializer,e._byteString)};if(e instanceof Hp){const n=t.databaseId,i=e.firestore._databaseId;if(!i.isEqual(n))throw t.Du("Document reference is for database ".concat(i.projectId,"/").concat(i.database," but should be for database ").concat(n.projectId,"/").concat(n.database));return{referenceValue:kd(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.Du("Unsupported field value: ".concat(Fp(e)))}(e,t)}function vf(e,t){const n={};return Ma(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):La(e,((e,i)=>{const r=gf(i,t.pu(e));null!=r&&(n[e]=r)})),{mapValue:{fields:n}}}function Tf(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ca||e instanceof tf||e instanceof Zp||e instanceof Hp||e instanceof ef)}function Sf(e,t,n){if(!Tf(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const i=Fp(n);throw"an object"===i?t.Du(e+" a custom object"):t.Du(e+" "+i)}}function yf(e,t,n){if((t=et(t))instanceof $p)return t._internalPath;if("string"==typeof t)return Rf(e,t);throw wf("Field path arguments must be of type string or ",e,!1,void 0,n)}const Cf=new RegExp("[~\\*/\\[\\]]");function Rf(e,t,n){if(t.search(Cf)>=0)throw wf("Invalid field path (".concat(t,"). Paths must not contain '~', '*', '/', '[', or ']'"),e,!1,void 0,n);try{return new $p(...t.split("."))._internalPath}catch(i){throw wf("Invalid field path (".concat(t,"). Paths must not be empty, begin with '.', end with '.', or contain '..'"),e,!1,void 0,n)}}function wf(e,t,n,i,r){const o=i&&!i.isEmpty(),s=void 0!==r;let a="Function ".concat(t,"() called with invalid data");n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(o||s)&&(c+=" (found",o&&(c+=" in field ".concat(i)),s&&(c+=" in document ".concat(r)),c+=")"),new Ys(qs.INVALID_ARGUMENT,a+e+c)}function If(e,t){return e.some((e=>e.isEqual(t)))}class bf{constructor(e,t,n,i,r){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=i,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new Hp(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Af(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Of("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Af extends bf{data(){return super.data()}}function Of(e,t){return"string"==typeof t?Rf(e,t):t instanceof $p?t._internalPath:t._delegate._internalPath}function Nf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new Ys(qs.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Df{}class Pf extends Df{}class kf extends Pf{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new kf(e,t,n)}_apply(e){const t=this._parse(e);return xf(e._query,t),new Wp(e.firestore,e.converter,$c(e._query,t))}_parse(e){const t=lf(e.firestore),n=function(e,t,n,i,r,o,s){let a;if(r.isKeyField()){if("array-contains"===o||"array-contains-any"===o)throw new Ys(qs.INVALID_ARGUMENT,"Invalid Query. You can't perform '".concat(o,"' queries on documentId()."));if("in"===o||"not-in"===o){Uf(s,o);const t=[];for(const n of s)t.push(Mf(i,e,n));a={arrayValue:{values:t}}}else a=Mf(i,e,s)}else"in"!==o&&"not-in"!==o&&"array-contains-any"!==o||Uf(s,o),a=Ef(n,t,s,"in"===o||"not-in"===o);return Rc.create(r,o,a)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value);return n}}class Lf extends Df{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Lf(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:wc.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const i=t.getFlattenedFilters();for(const r of i)xf(n,r),n=$c(n,r)}(e._query,t),new Wp(e.firestore,e.converter,$c(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function Mf(e,t,n){if("string"==typeof(n=et(n))){if(""===n)throw new Ys(qs.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Jc(t)&&-1!==n.indexOf("/"))throw new Ys(qs.INVALID_ARGUMENT,"Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '".concat(n,"' contains a '/' character."));const i=t.path.child(ua.fromString(n));if(!fa.isDocumentKey(i))throw new Ys(qs.INVALID_ARGUMENT,"Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '".concat(i,"' is not because it has an odd number of segments (").concat(i.length,")."));return ac(e,new fa(i))}if(n instanceof Hp)return ac(e,n._key);throw new Ys(qs.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ".concat(Fp(n),"."))}function Uf(e,t){if(!Array.isArray(e)||0===e.length)throw new Ys(qs.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '".concat(t.toString(),"' filters."))}function xf(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new Ys(qs.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '".concat(t.op.toString(),"' filter.")):new Ys(qs.INVALID_ARGUMENT,"Invalid query. You cannot use '".concat(t.op.toString(),"' filters with '").concat(n.toString(),"' filters."))}class Vf{convertValue(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"none";switch(ec(e)){case 0:return null;case 1:return e.booleanValue;case 2:return za(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(qa(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Hs()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"none";const n={};return La(e,((e,i)=>{n[e]=this.convertValue(i,t)})),n}convertGeoPoint(e){return new tf(za(e.latitude),za(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=Ja(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Xa(e));default:return null}}convertTimestamp(e){const t=Ka(e);return new ca(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=ua.fromString(e);Ks(tu(n));const i=new Za(n.get(1),n.get(3)),r=new fa(n.popFirst(5));return i.isEqual(t)||Bs("Document ".concat(r," contains a document reference within a different database (").concat(i.projectId,"/").concat(i.database,") which is not supported. It will be treated as a reference in the current database (").concat(t.projectId,"/").concat(t.database,") instead.")),r}}function Ff(e,t,n){let i;return i=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,i}class jf{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Bf extends bf{constructor(e,t,n,i,r,o){super(e,t,n,i,o),this._firestore=e,this._firestoreImpl=e,this.metadata=r}exists(){return super.exists()}data(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this._document){if(this._converter){const t=new Gf(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this._document){const n=this._document.data.field(Of("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Gf extends Bf{data(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return super.data(e)}}class Wf{constructor(e,t,n,i){this._firestore=e,this._userDataWriter=t,this._snapshot=i,this.metadata=new jf(i.hasPendingWrites,i.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Gf(this._firestore,this._userDataWriter,n.key,n,new jf(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(){const e=!!(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Ys(qs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const i=new Gf(e._firestore,e._userDataWriter,n.doc.key,n.doc,new jf(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:i,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const i=new Gf(e._firestore,e._userDataWriter,t.doc.key,t.doc,new jf(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let r=-1,o=-1;return 0!==t.type&&(r=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),o=n.indexOf(t.doc.key)),{type:Hf(t.type),doc:i,oldIndex:r,newIndex:o}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Hf(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Hs()}}class Kf extends Vf{constructor(e){super(),this.firestore=e}convertBytes(e){return new Zp(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Hp(this.firestore,null,t)}}function zf(e,t,n){e=jp(e,Hp);const i=jp(e.firestore,Jp),r=Ff(e.converter,t,n);return Jf(i,[df(lf(i),"setDoc",e._key,r,null!==e.converter,n).toMutation(e._key,Fl.none())])}function qf(e,t,n){e=jp(e,Hp);const i=jp(e.firestore,Jp),r=lf(i);let o;for(var s=arguments.length,a=new Array(s>3?s-3:0),c=3;c<s;c++)a[c-3]=arguments[c];return o="string"==typeof(t=et(t))||t instanceof $p?_f(r,"updateDoc",e._key,t,n,a):mf(r,"updateDoc",e._key,t),Jf(i,[o.toMutation(e._key,Fl.exists(!0))])}function Yf(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r,o,s;e=et(e);let a={includeMetadataChanges:!1,source:"default"},c=0;"object"!=typeof n[c]||Yp(n[c])||(a=n[c],c++);const l={includeMetadataChanges:a.includeMetadataChanges,source:a.source};if(Yp(n[c])){const e=n[c];n[c]=null===(r=e.next)||void 0===r?void 0:r.bind(e),n[c+1]=null===(o=e.error)||void 0===o?void 0:o.bind(e),n[c+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let d,u,h;if(e instanceof Hp)u=jp(e.firestore,Jp),h=qc(e._key.path),d={next:t=>{n[c]&&n[c](Xf(u,e,t))},error:n[c+1],complete:n[c+2]};else{const t=jp(e,Wp);u=jp(t.firestore,Jp),h=t._query;const i=new Kf(u);d={next:e=>{n[c]&&n[c](new Wf(u,i,t,e))},error:n[c+1],complete:n[c+2]},Nf(e._query)}return function(e,t,n,i){const r=new Cp(i),o=new Kh(t,r,n);return e.asyncQueue.enqueueAndForget((async()=>Vh(await Dp(e),o))),()=>{r.$a(),e.asyncQueue.enqueueAndForget((async()=>Fh(await Dp(e),o)))}}(Xp(u),h,l,d)}function Jf(e,t){return function(e,t){const n=new Js;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const i=Tp(e);try{const e=await function(e,t){const n=zs(e),i=ca.now(),r=t.reduce(((e,t)=>e.add(t.key)),vl());let o,s;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=dl(),c=vl();return n.os.getEntries(e,r).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((r=>{o=r;const s=[];for(const e of t){const t=Kl(e,o.get(e.key).overlayedDocument);null!=t&&s.push(new Yl(e.key,t,_c(t.value.mapValue),Fl.exists(!0)))}return n.mutationQueue.addMutationBatch(e,i,s,t)})).next((t=>{s=t;const i=t.applyToLocalDocumentSet(o,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,i)}))})).then((()=>({batchId:s.batchId,changes:pl(o)})))}(i.localStore,t);i.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let i=e.xa[e.currentUser.toKey()];i||(i=new Ua(sa)),i=i.insert(t,n),e.xa[e.currentUser.toKey()]=i}(i,e.batchId,n),await _p(i,e.changes),await gh(i.remoteStore)}catch(e){const t=Ph(e,"Failed to persist write");n.reject(t)}}(await Np(e),t,n))),n.promise}(Xp(e),t)}function Xf(e,t,n){const i=n.docs.get(t._key),r=new Kf(e);return new Bf(e,r,t._key,i,new jf(n.hasPendingWrites,n.fromCache),t.converter)}function Qf(){return new pf("serverTimestamp")}function Zf(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return new ff("arrayUnion",t)}new WeakMap;!function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];!function(e){xs=e}(_n),un(new tt("firestore",((e,n)=>{let{instanceIdentifier:i,options:r}=n;const o=e.getProvider("app").getImmediate(),s=new Jp(new $s(e.getProvider("auth-internal")),new ia(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Ys(qs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Za(e.options.projectId,t)}(o,i),o);return r=Object.assign({useFetchStreams:t},r),s._setSettings(r),s}),"PUBLIC").setMultipleInstances(!0)),vn(Ms,"4.6.3",e),vn(Ms,"4.6.3","esm2017")}();const $f=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:gn();const t=hn(e,"auth");if(t.isInitialized())return t.getImmediate();const n=function(e,t){const n=hn(e,"auth");if(n.isInitialized()){const e=n.getImmediate();if(qe(n.getOptions(),null!==t&&void 0!==t?t:{}))return e;Vn(e,"already-initialized")}return n.initialize({options:t})}(e,{popupRedirectResolver:Bo,persistence:[Jr,Pr,Lr]}),i=Ve("authTokenSyncURL");if(i&&"boolean"===typeof isSecureContext&&isSecureContext){const e=new URL(i,location.origin);if(location.origin===e.origin){const t=(r=e.toString(),async e=>{const t=e&&await e.getIdTokenResult(),n=t&&((new Date).getTime()-Date.parse(t.issuedAtTime))/1e3;if(n&&n>Ko)return;const i=null===t||void 0===t?void 0:t.token;zo!==i&&(zo=i,await fetch(r,{method:i?"POST":"DELETE",headers:i?{Authorization:"Bearer ".concat(i)}:{}}))});!function(e,t,n){et(e).beforeAuthStateChanged(t,n)}(n,t,(()=>t(n.currentUser))),function(e,t,n,i){et(e).onIdTokenChanged(t,n,i)}(n,(e=>t(e)))}}var r;const o=Me("auth");return o&&er(n,"http://".concat(o)),n}(En({apiKey:"AIzaSyBGOEsbOvCnmrFyEaQeh3JMuOo6HjrPXRA",authDomain:"chat-app-29349.firebaseapp.com",projectId:"chat-app-29349",storageBucket:"chat-app-29349.appspot.com",messagingSenderId:"4529785736",appId:"1:4529785736:web:2d260f225a3876b76f483d"})),em=(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:gn(),t=arguments.length>1?arguments[1]:void 0;e=et(e);const n=hn(e,gs).getImmediate({identifier:t}),i=Ue("storage");i&&function(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};!function(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};e.host="".concat(t,":").concat(n),e._protocol="http";const{mockUserToken:r}=i;r&&(e._overrideAuthToken="string"===typeof r?r:je(r,e.app.options.projectId))}(e,t,n,i)}(n,...i)}(),function(e,t){const n="string"==typeof e?e:t||"(default)",i=hn("object"==typeof e?e:gn(),"firestore").getImmediate({identifier:n});if(!i._initialized){const e=Ue("firestore");e&&function(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};var r;const o=(e=jp(e,Gp))._getSettings(),s="".concat(t,":").concat(n);if("firestore.googleapis.com"!==o.host&&o.host!==s&&Gs("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},o),{host:s,ssl:!1})),i.mockUserToken){let t,n;if("string"==typeof i.mockUserToken)t=i.mockUserToken,n=Us.MOCK_USER;else{t=je(i.mockUserToken,null===(r=e._app)||void 0===r?void 0:r.options.projectId);const o=i.mockUserToken.sub||i.mockUserToken.user_id;if(!o)throw new Ys(qs.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new Us(o)}e._authCredentials=new Zs(new Xs(t,n))}}(i,...e)}return i}());var tm=n(579);const nm=()=>{const[e,n]=(0,t.useState)(!1),i=Q();return(0,tm.jsx)("div",{className:"formContainer",children:(0,tm.jsxs)("div",{className:"formWrapper",children:[(0,tm.jsx)("span",{className:"logo",children:"ATT Chat"}),(0,tm.jsx)("span",{className:"title",children:"Login"}),(0,tm.jsxs)("form",{onSubmit:async t=>{t.preventDefault();const r=t.target[0].value,o=t.target[1].value;try{await function(e,t,n){return pn(e.app)?Promise.reject(Bn(e)):br(et(e),hr.credential(t,n)).catch((async t=>{throw t.code==="auth/".concat("password-does-not-meet-requirements")&&Ar(e),t}))}($f,r,o),i("/")}catch(e){n(!0)}},children:[(0,tm.jsx)("input",{type:"email",placeholder:"email"}),(0,tm.jsx)("input",{type:"password",placeholder:"password"}),(0,tm.jsx)("button",{children:"Sign in"}),e&&(0,tm.jsx)("span",{style:{color:"red"},children:"Something went wrong"})]}),(0,tm.jsxs)("p",{children:["You don't have an account? ",(0,tm.jsx)(we,{to:"/register",children:"Register"})]})]})})},im=(0,t.createContext)(),rm=e=>{let{children:n}=e;const[i,r]=(0,t.useState)({});return(0,t.useEffect)((()=>{const e=function(e,t,n,i){return et(e).onAuthStateChanged(t,n,i)}($f,(e=>{r(e)}));return()=>{e()}}),[]),(0,tm.jsx)(im.Provider,{value:{currentUser:i},children:n})},om=()=>{const{currentUser:e}=(0,t.useContext)(im);return(0,tm.jsxs)("div",{className:"navbar",children:[(0,tm.jsx)("span",{className:"logo",children:"ATT Chat"}),(0,tm.jsx)("div",{className:"user",children:(0,tm.jsx)("button",{onClick:()=>$f.signOut(),children:"Logout"})})]})};const sm=function(){const[e,n]=(0,t.useState)(""),[i,r]=(0,t.useState)(null),{currentUser:o}=(0,t.useContext)(im),s=e=>e.split("@")[0];return(0,tm.jsxs)("div",{className:"search",children:[(0,tm.jsx)("div",{className:"searchForm",children:(0,tm.jsx)("input",{type:"text",placeholder:"Find a user",onKeyDown:async t=>{if("Enter"!=t.code)return;const n=function(e,t){let n=[];for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];t instanceof Df&&n.push(t),n=n.concat(r),function(e){const t=e.filter((e=>e instanceof Lf)).length,n=e.filter((e=>e instanceof kf)).length;if(t>1||t>0&&n>0)throw new Ys(qs.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(n);for(const s of n)e=s._apply(e);return e}(function(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];if(e=et(e),Up("collection","path",t),e instanceof Gp){const n=ua.fromString(t,...i);return Vp(n),new Kp(e,null,n)}{if(!(e instanceof Hp||e instanceof Kp))throw new Ys(qs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const n=e._path.child(ua.fromString(t,...i));return Vp(n),new Kp(e.firestore,null,n)}}(em,"users"),function(e,t,n){const i=t,r=Of("where",e);return kf._create(r,i,n)}("email","==",e));try{const e=await function(e){e=jp(e,Wp);const t=jp(e.firestore,Jp),n=Xp(t),i=new Kf(t);return Nf(e._query),kp(n,e._query).then((n=>new Wf(t,i,e,n)))}(n);e.forEach((e=>{r(e.data())}))}catch(i){console.log(i)}},onChange:e=>n(e.target.value),value:e})}),i&&(0,tm.jsx)("div",{className:"userChat",onClick:async()=>{const e=o.uid>i.uid?o.uid+i.uid:i.uid+o.uid;try{(await function(e){e=jp(e,Hp);const t=jp(e.firestore,Jp);return Pp(Xp(t),e._key).then((n=>Xf(t,e,n)))}(zp(em,"chats",e))).exists()||(await zf(zp(em,"chats",e),{messages:[]}),await qf(zp(em,"userChats",o.uid),{[e+".userInfo"]:{uid:i.uid,displayName:s(i.email)},[e+".date"]:Qf()}),await qf(zp(em,"userChats",i.uid),{[e+".userInfo"]:{uid:o.uid,displayName:s(o.email)},[e+".date"]:Qf()}))}catch(t){}r(null),n("")},children:(0,tm.jsx)("div",{className:"userChatInfo",children:(0,tm.jsx)("span",{children:i.email})})})]})},am=(0,t.createContext)(),cm=e=>{let{children:n}=e;const{currentUser:i}=(0,t.useContext)(im),[r,o]=(0,t.useReducer)(((e,t)=>"CHANGE_USER"===t.type?{user:t.payload,chatId:i.uid>t.payload.uid?i.uid+t.payload.uid:t.payload.uid+i.uid}:e),{chatId:"null",user:{}});return(0,tm.jsx)(am.Provider,{value:{data:r,dispatch:o},children:n})},lm=n.p+"static/media/avt.52b49d765d404e3dd5f7.png";const dm=function(){var e;const[n,i]=(0,t.useState)([]),{currentUser:r}=(0,t.useContext)(im),{dispatch:o}=(0,t.useContext)(am);return(0,t.useEffect)((()=>{r.uid&&(()=>{const e=Yf(zp(em,"userChats",r.uid),(e=>{i(e.data())}))})()}),[r.uid]),(0,tm.jsx)("div",{className:"chats",children:null===(e=Object.entries(n))||void 0===e?void 0:e.sort(((e,t)=>t[1].date-e[1].date)).map((e=>{var t;return(0,tm.jsxs)("div",{className:"userChat",onClick:()=>{return t=e[1].userInfo,void o({type:"CHANGE_USER",payload:t});var t},children:[(0,tm.jsx)("img",{src:lm,alt:"Avatar"}),(0,tm.jsxs)("div",{className:"userChatInfo",children:[(0,tm.jsx)("span",{children:e[1].userInfo.displayName}),(0,tm.jsx)("p",{children:null===(t=e[1].lastMessage)||void 0===t?void 0:t.text})]})]},e[0])}))})},um=()=>(0,tm.jsxs)("div",{className:"sidebar",children:[(0,tm.jsx)(om,{}),(0,tm.jsx)(sm,{}),(0,tm.jsx)(dm,{})]});var hm,pm=new Uint8Array(16);function fm(){if(!hm&&!(hm="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!==typeof msCrypto&&"function"===typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return hm(pm)}const mm=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const _m=function(e){return"string"===typeof e&&mm.test(e)};for(var Em=[],gm=0;gm<256;++gm)Em.push((gm+256).toString(16).substr(1));const vm=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=(Em[e[t+0]]+Em[e[t+1]]+Em[e[t+2]]+Em[e[t+3]]+"-"+Em[e[t+4]]+Em[e[t+5]]+"-"+Em[e[t+6]]+Em[e[t+7]]+"-"+Em[e[t+8]]+Em[e[t+9]]+"-"+Em[e[t+10]]+Em[e[t+11]]+Em[e[t+12]]+Em[e[t+13]]+Em[e[t+14]]+Em[e[t+15]]).toLowerCase();if(!_m(n))throw TypeError("Stringified UUID is invalid");return n};const Tm=function(e,t,n){var i=(e=e||{}).random||(e.rng||fm)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){n=n||0;for(var r=0;r<16;++r)t[n+r]=i[r];return t}return vm(i)};const Sm=function(){const[e,n]=(0,t.useState)(""),{currentUser:i}=(0,t.useContext)(im),{data:r}=(0,t.useContext)(am);return(0,tm.jsx)("div",{className:"input",children:(0,tm.jsx)("input",{type:"text",placeholder:"Type something...",onChange:e=>n(e.target.value),value:e,onKeyDown:async t=>{"Enter"===t.code&&(await qf(zp(em,"chats",r.chatId),{messages:Zf({id:Tm(),text:e,senderId:i.uid,date:ca.now()})}),await qf(zp(em,"userChats",i.uid),{[r.chatId+".lastMessage"]:{text:e},[r.chatId+".date"]:Qf()}),await qf(zp(em,"userChats",r.user.uid),{[r.chatId+".lastMessage"]:{text:e},[r.chatId+".date"]:Qf()}),n(""))}})})},ym=e=>{let{message:n}=e;const{currentUser:i}=(0,t.useContext)(im),r=(0,t.useRef)();return(0,t.useEffect)((()=>{var e;null===(e=r.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}),[n]),(0,tm.jsx)("div",{ref:r,className:"message ".concat(n.senderId===i.uid&&"owner"),children:(0,tm.jsx)("div",{className:"messageContent",children:(0,tm.jsx)("p",{children:n.text})})})};const Cm=function(){const[e,n]=(0,t.useState)([]),{data:i}=(0,t.useContext)(am);return(0,t.useEffect)((()=>{const e=Yf(zp(em,"chats",i.chatId),(e=>{e.exists()&&n(e.data().messages)}));return()=>{e()}}),[i.chatId]),(0,tm.jsx)("div",{className:"messages",children:e.map((e=>(0,tm.jsx)(ym,{message:e},e.id)))})};var Rm=n(635),wm=n.n(Rm);const Im=function(){var e;let n={localAudioTrack:null,client:null},i="8267a1bb7b034afe8c1076dc0e68857d",r="test",o="007eJxTYHjy5HfvsaU+H/5fv7TqziVep8Bd7+4feizdcXDFmvPlfRntCgwWRmbmiYZJSeZJBsYmiWmpFsmGBuZmKckGqWYWFqbmKftKEtMaAhkZbl0oY2VkgEAQn4WhJLW4hIEBAER1Jc0=",s=123456;n.client=wm().createClient({mode:"rtc",codec:"vp8"});const{data:a}=(0,t.useContext)(am);return(0,tm.jsxs)("div",{className:"chat",children:[(0,tm.jsxs)("div",{className:"chatInfo",children:[(0,tm.jsx)("h3",{children:null===(e=a.user)||void 0===e?void 0:e.displayName}),(0,tm.jsx)("div",{className:"chatIcons",children:(0,tm.jsx)("img",{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAACXBIWXMAAA7EAAAOxAGVKw4bAAADmGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4KPHg6eG1wbWV0YSB4bWxuczp4PSdhZG9iZTpuczptZXRhLyc+CjxyZGY6UkRGIHhtbG5zOnJkZj0naHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyc+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpBdHRyaWI9J2h0dHA6Ly9ucy5hdHRyaWJ1dGlvbi5jb20vYWRzLzEuMC8nPgogIDxBdHRyaWI6QWRzPgogICA8cmRmOlNlcT4KICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0nUmVzb3VyY2UnPgogICAgIDxBdHRyaWI6Q3JlYXRlZD4yMDIyLTA4LTMwPC9BdHRyaWI6Q3JlYXRlZD4KICAgICA8QXR0cmliOkV4dElkPmRjMjBmNTM2LTJhZjUtNGM3My05ZjZjLTAzMzkwY2JlN2VjMDwvQXR0cmliOkV4dElkPgogICAgIDxBdHRyaWI6RmJJZD41MjUyNjU5MTQxNzk1ODA8L0F0dHJpYjpGYklkPgogICAgIDxBdHRyaWI6VG91Y2hUeXBlPjI8L0F0dHJpYjpUb3VjaFR5cGU+CiAgICA8L3JkZjpsaT4KICAgPC9yZGY6U2VxPgogIDwvQXR0cmliOkFkcz4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6cGRmPSdodHRwOi8vbnMuYWRvYmUuY29tL3BkZi8xLjMvJz4KICA8cGRmOkF1dGhvcj5MYW1hIERldjwvcGRmOkF1dGhvcj4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6eG1wPSdodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvJz4KICA8eG1wOkNyZWF0b3JUb29sPkNhbnZhPC94bXA6Q3JlYXRvclRvb2w+CiA8L3JkZjpEZXNjcmlwdGlvbj4KPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KPD94cGFja2V0IGVuZD0ncic/PvItxZYAAAKwSURBVFiF7Ze9bhNBFIW/M2s7JqJAUKdKpJS8AwXpkRANzxAJ0cIbREi8AAUSSqBFUNDxBrQoilLTUeQPxzuHYmYdx3Y2tpdYSPGRVusdz5355ufeuQNLLbXUUrdbGi04ODgd+isSggR4Ut0pZRvZOASQoN+HjY07swPaZn//BElIKAQszcs13G5q264GKyRPxFhf716ybY0RKz2AJboS3dTofJLARmXJEagPxh70gR2RiivtxwBDCAGIwOMYvQu0mwBm2xVbP4Et0C/JGU+2jaS7wNFUgDE6ADEEPbJ1HxyB0AAwz5YegreA90ArRp+HACEUOxA/A99zP3HYtq7jMzCS+pI87wOK1dKC2/ltSdi8Ab8En+byMYixGZwAr5H3jHK21aANyX3wjs2LBH+16gCH1cCVL5nG7CRvJbbTN6Gu/UZ7a1bZ/JF4BdpOMydxzeCnncGmKkhh6zWwmYqcw7azU0zmvHFAKcUSCYE2bZy9ugo11EWxG1/iBCTZsk3M3luF6WvtF7UHDdalT2Aa31vAElvpaFMEh6HfmgZwAUucArbtYOurpGPbIQXw/2eJI4DNO+BJ2ocuMmTtTC4IMKWTkh/Y/gY8T2mcA6i8OObGZ3QqQNsNspkq1zU5OGP7A/AsQ7byeT3Rus5JKqhSDbLWbFqCCqDIza7Y/iQpgHZTEgGTIOsAOwC2uzV1plXVz+8M0odY2OxdDCD1di2glCrb/ihpg3+TsHaAwxD0JSG4bLdXOTs7FoS9VqujTqeg1yvrAfNWqzbNjxjj00bbb0ijuyTGSKfT9fl5T1A6xsBgIq8CzMcQpINd6TYW48W5ObcsKdgMEoOyTGlgCIVjNL1eb/LARgsOD09ptUS7DScnxh69gc0qke8d9Ptn2GZ19R5ra81vi0sttdRSt0F/AbV4QUoZ1kOTAAAAAElFTkSuQmCC",alt:"",onClick:async function(){await n.client.join(i,r,o,s),n.localAudioTrack=await wm().createMicrophoneAudioTrack(),n.localVideoTrack=await wm().createCameraVideoTrack(),await n.localVideoTrack.setEnabled(!0),await n.client.publish([n.localAudioTrack,n.localVideoTrack]);const e=document.createElement("div");e.id=s,e.textContent="Local user "+s,e.style.width="640px",e.style.height="480px",document.body.append(e),n.localVideoTrack.play(e),console.log("publish success!")}})})]}),(0,tm.jsx)(Cm,{}),(0,tm.jsx)(Sm,{})]})};const bm=function(){return(0,tm.jsx)("div",{className:"home",children:(0,tm.jsxs)("div",{className:"container",children:[(0,tm.jsx)(um,{}),(0,tm.jsx)(Im,{})]})})},Am=()=>{const[e,n]=(0,t.useState)(!1),[i,r]=(0,t.useState)(!1),o=Q();return(0,tm.jsx)("div",{className:"formContainer",children:(0,tm.jsxs)("div",{className:"formWrapper",children:[(0,tm.jsx)("span",{className:"logo",children:"Lama Chat"}),(0,tm.jsx)("span",{className:"title",children:"Register"}),(0,tm.jsxs)("form",{onSubmit:async t=>{r(!0),t.preventDefault();const i=t.target[0].value,s=t.target[1].value,a=t.target[2].value;try{const e=await async function(e,t,n){if(pn(e.app))return Promise.reject(Bn(e));const i=zi(e),r=$i(i,{returnSecureToken:!0,email:t,password:n,clientType:"CLIENT_TYPE_WEB"},"signUpPassword",vr),o=await r.catch((t=>{throw t.code==="auth/".concat("password-does-not-meet-requirements")&&Ar(e),t})),s=await Tr._fromIdTokenResponse(i,"signIn",o);return await i._updateCurrentUser(s.user),s}($f,s,a);await zf(zp(em,"users",e.user.uid),{uid:e.user.uid,displayName:i,email:s}),await zf(zp(em,"userChats",e.user.uid),{}),o("/")}catch(e){n(!0),r(!1)}},children:[(0,tm.jsx)("input",{required:!0,type:"text",placeholder:"display name"}),(0,tm.jsx)("input",{required:!0,type:"email",placeholder:"email"}),(0,tm.jsx)("input",{required:!0,type:"password",placeholder:"password"}),(0,tm.jsx)("button",{disabled:i,children:"Sign up"}),e&&(0,tm.jsx)("span",{children:"Something went wrong"})]}),(0,tm.jsxs)("p",{children:["You do have an account? ",(0,tm.jsx)(we,{to:"/login",children:"Login"})]})]})})};const Om=function(){const{currentUser:e}=(0,t.useContext)(im),n=t=>{let{children:n}=t;return e?n:(0,tm.jsx)(ue,{to:"/login"})};return(0,tm.jsx)(ye,{basename:"/chat-app",children:(0,tm.jsx)(fe,{children:(0,tm.jsxs)(he,{path:"/",children:[(0,tm.jsx)(he,{index:!0,element:(0,tm.jsx)(n,{children:(0,tm.jsx)(bm,{})})}),(0,tm.jsx)(he,{path:"login",element:(0,tm.jsx)(nm,{})}),(0,tm.jsx)(he,{path:"register",element:(0,tm.jsx)(Am,{})})]})})})},Nm=e=>{e&&e instanceof Function&&n.e(453).then(n.bind(n,453)).then((t=>{let{getCLS:n,getFID:i,getFCP:r,getLCP:o,getTTFB:s}=t;n(e),i(e),r(e),o(e),s(e)}))};r.createRoot(document.getElementById("root")).render((0,tm.jsx)(rm,{children:(0,tm.jsx)(cm,{children:(0,tm.jsx)(Om,{})})})),Nm()})()})();
//# sourceMappingURL=main.50db24e7.js.map